<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Fang">
    
    <title>
        
            Spring Cloud + Vue 前后端分离4-1 |
        
        念~旭
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/favicon.ico","favicon":"/images/favicon.ico","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"你舍得放弃么？你愿意放弃么？你能......放弃么？"},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.4"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                念~旭
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                LINKS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">LINKS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Spring Cloud + Vue 前后端分离4-1</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/favicon.ico">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Fang</span>
                        
                            <span class="author-label">Lv6</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2022-03-07 09:23:36</span>
        <span class="mobile">2022-03-07 09:23</span>
    </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE/">完整项目</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>16.3k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>77 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="第11章-用户管理与登录"><a href="#第11章-用户管理与登录" class="headerlink" title="第11章 用户管理与登录"></a>第11章 用户管理与登录</h1><p>本章将演示用户管理及控台登录功能的开发，登录拦截是一个管理控台最基本的权限拦截，防止出现未登录用户直接访问控台界面或接口，同时保障系统内部用户的信息安全，介绍单点登录功能的开发，单点登录SSO（Single Sign On）在大型网站设计中非常常见，用户只需要登录一次就可以访问所有相互信任的应用系统，是提升用户体…</p>
<hr>
<h2 id="11-1-增加用户管理功能"><a href="#11-1-增加用户管理功能" class="headerlink" title="11-1 增加用户管理功能"></a>11-1 增加用户管理功能</h2><p><strong>用户表设计与基本代码生成：</strong></p>
<p>1.用户管理与登录：用户表设计与基本代码生成</p>
<ul>
<li><p>创建sql</p>
</li>
<li><pre><code class="sql">#用户
drop table if exists `user`;
create table `user`(
                  `id` char(8) not null default &#39;&#39; comment &#39;id&#39;,
                  `login_name` varchar(50)  not null comment &#39;登录名&#39;,
                  `name` varchar(50)  comment &#39;昵称&#39;,
                  `password` char(32) not null  comment &#39;密码&#39;,
                  primary key (`id`),
                  unique key `login_name_unique`(`login_name`)
)engine =innodb default charset=utf8mb4 comment=&#39;用户&#39;;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 然后修改前端后端为system，然后就开始代码生成器</span><br><span class="line"></span><br><span class="line">- 最后在admin中修改代码</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  &lt;li class=&quot;active&quot; id=&quot;system-user-sidebar&quot;&gt;</span><br><span class="line">   &lt;router-link to=&quot;/system/user&quot;&gt;</span><br><span class="line">      &lt;i class=&quot;menu-icon fa fa-caret-right&quot;&gt;&lt;/i&gt;</span><br><span class="line">      用户管理</span><br><span class="line">   &lt;/router-link&gt;</span><br><span class="line">  </span><br><span class="line">    &lt;b class=&quot;arrow&quot;&gt;&lt;/b&gt;</span><br><span class="line">  &lt;/li&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>修改router，增加路由</p>
</li>
</ul>
<p><strong>增加用户名是否已存在校验：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.用户管理与登录：增加用户名是否已存在校验</span><br><span class="line">2.增加自定义业务异常</span><br></pre></td></tr></table></figure>

<ul>
<li><p>登录名是不可编辑的，登录名一般会跟其它表有关联，一旦登录名改了，这些关联信息就没有了。</p>
</li>
<li><p>根据传入登录名到数据库中查找是否有记录，有记录就说明用户名已存在</p>
</li>
<li><p>我们在UserService中增加方法</p>
</li>
<li><pre><code class="java">/**
 * 根据登录名查询用户信息
 * @param loginName
 * @return
 */
public User selectByLoginName(String loginName) &#123;
    UserExample userExample = new UserExample();
    userExample.createCriteria().andLoginNameEqualTo(loginName);
    List&lt;User&gt; userList = userMapper.selectByExample(userExample);
    if (CollectionUtils.isEmpty(userList)) &#123;
        return null;
    &#125; else &#123;
        return userList.get(0);
    &#125;
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 然后我们在其insert方法中，增加判断，我们在业务上的逻辑校验，在校验不通过时，使用业务异常（自定义异常）</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  User userDb = this.selectByLoginName(user.getLoginName());</span><br><span class="line">  if(userDb != null)&#123;</span><br><span class="line">   throw new BusinessException(BusinessExceptionCode.USER_LOGIN_NAME_EXIST);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>我们在com.course.server.exception增加自定义异常，先写BusinessException，</p>
</li>
<li><p>继承RuntimeException的一个好处就是代码不需要捕获。如果是直接继承Exception，代码需要捕获，否则编译不通过。</p>
</li>
<li><pre><code class="java">package com.course.server.exception;

public class BusinessException extends RuntimeException&#123;

    private BusinessExceptionCode code;

    public BusinessException (BusinessExceptionCode code) &#123;
        super(code.getDesc());
        this.code = code;
    &#125;

    public BusinessExceptionCode getCode() &#123;
        return code;
    &#125;

    public void setCode(BusinessExceptionCode code) &#123;
        this.code = code;
    &#125;

    /**
     * 不写入堆栈信息，提高性能，抛出业务异常时，不打印堆栈信息，一方面是提高性能，另一方面是没有业务异常没必要看堆栈信息
     */
    @Override
    public Throwable fillInStackTrace() &#123;
        return this;
    &#125;
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 看上面的代码里面有个BusinessExceptionCode，我们也写下文件，它也是个枚举就是没有code了</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  package com.course.server.exception;</span><br><span class="line">  </span><br><span class="line">  public enum BusinessExceptionCode &#123;</span><br><span class="line">  </span><br><span class="line">     </span><br><span class="line">      USER_LOGIN_NAME_EXIST(&quot;登录名已存在&quot;),</span><br><span class="line">       ;</span><br><span class="line">  </span><br><span class="line">      private String desc;</span><br><span class="line">  </span><br><span class="line">      BusinessExceptionCode(String desc) &#123;</span><br><span class="line">          this.desc = desc;</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      public String getDesc() &#123;</span><br><span class="line">          return desc;</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      public void setDesc(String desc) &#123;</span><br><span class="line">          this.desc = desc;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>我们还要对BusinessException做个全局的捕获，我们复制business里的ControllerExceptionHandler到system的controller下面，进行修改</p>
</li>
<li><pre><code class="java">package com.course.system.controller;

import com.course.server.dto.ResponseDto;
import com.course.server.exception.BusinessException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;

@ControllerAdvice
public class ControllerExceptionHandler &#123;

    private static final Logger LOG = LoggerFactory.getLogger(ControllerExceptionHandler.class);

    @ExceptionHandler(value = BusinessException.class)
    @ResponseBody
    public ResponseDto businessExceptionHandler(BusinessException e) &#123;
        ResponseDto responseDto = new ResponseDto();
        responseDto.setSuccess(false);
        LOG.error(&quot;业务异常：&#123;&#125;&quot;, e.getCode().getDesc());
        responseDto.setMessage(e.getCode().getDesc());
        return responseDto;

    &#125;
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 下面我们修改user.vue，</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  //为了让登录名新增是可以修改，修改时不能进行修改我们增加了disabled</span><br><span class="line">  &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">    &lt;label class=&quot;col-sm-2 control-label&quot;&gt;登录名&lt;/label&gt;</span><br><span class="line">    &lt;div class=&quot;col-sm-10&quot;&gt;</span><br><span class="line">      &lt;input v-model=&quot;user.loginName&quot; v-bind:disabled=&quot;user.id&quot; class=&quot;form-control&quot;&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>以后我们会有很多业务异常使用方法在BusinessExceptionCode增加一种异常枚举；在业务代码中抛出指定枚举类型的业务异常</p>
</li>
</ul>
<p><strong>侧边栏激活样式优化</strong></p>
<p>1.用户管理与登录：侧边栏激活样式优化</p>
<ul>
<li><p>现在菜单栏的样式是这样的，我们要做的是当前菜单的父菜单的同级菜单，下面所有的子菜单，清空激活样式</p>
</li>
<li><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/20/Ux4suobOkTcCq1h.png"
                      alt="image-20220320171949483"
                ></p>
</li>
<li><p>只需要在admin的activeSidebar方法，判断是否有父菜单的时候加，然后把原来标签的active都去了</p>
</li>
<li><p>&#96;&#96;&#96;vue<br>parentLi.siblings().find(“li”).removeClass(“active”);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 改完之后![image-20220320192232985](https://s2.loli.net/2022/03/20/1MZavcFOSzeYmT3.png)</span><br><span class="line"></span><br><span class="line">- 还有一个问题问题：访问根目录时，页面显示的是admin.vue，但是右边的content部分是空的，没有路由到任何一个子路由</span><br><span class="line">- ![image-20220320192535989](https://s2.loli.net/2022/03/20/jhDmNJGQtAokE63.png)</span><br><span class="line"></span><br><span class="line">- 我们将其重定位到Login，在router中增加一个</span><br><span class="line"></span><br><span class="line">- ```js</span><br><span class="line">  ,&#123;</span><br><span class="line">      path: &quot;&quot;,</span><br><span class="line">      redirect: &quot;/login&quot;,</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>2.用户管理与登录：解决从登录页面跳到控台主页时，侧边栏失效的问题</p>
<ul>
<li><p>但是随机而来的又有一个问题：从登录页面跳转到控台主页时，菜单失效了。因为打开登录页面时，会去加载所需的js，包括ace.min.js，这里会去做很多的初始化包括侧边栏的点击事件，但是此时还没有侧边栏。</p>
</li>
<li><p>解决方法：进入控台主页时，重新加载ace.min.js，只需要在admin的mounted方法添加</p>
</li>
<li><pre><code class="vue"> $.getScript(&#39;/ace/assets/js/ace.min.js&#39;);
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 小提示：大家在用很多第三方框架或jquery插件时，如果发现有些功能不起作用，如果看不懂源码，可以尝试这种方法解决，把核心的js重新加载一遍</span><br><span class="line"></span><br><span class="line">## 11-2 密码的加密传输与加密存储</span><br><span class="line"></span><br><span class="line">**加密算法MD5与盐值**</span><br><span class="line"></span><br><span class="line">- 网站的数据库里已经把原值和密文都算好并存储超来了，如果刚好你输入的密文在数据库里有，就能解出来</span><br><span class="line">- 盐值也叫salt值，加上盐值后，密文不容易被破解（查询）</span><br><span class="line"></span><br><span class="line">**密码加密传输和加密加密**</span><br><span class="line"></span><br><span class="line">1.用户管理与登录：密码加密传输和加密存储</span><br><span class="line"></span><br><span class="line">- 所有人的密码存成明文的话，至少程序员可以直接到生产上看到</span><br><span class="line"></span><br><span class="line">- 从路由器的日志，我可以看到所有人浏览的网站的地址、用户名、密码，如果密码刚好是明文传输，那就泄露了，如果是简单的md5，也很容易被破解，所以需要加个盐值。</span><br><span class="line"></span><br><span class="line">- 盐值可以是随机的一串值，但是所有用到盐值的地方必须是同一个值。如果你是做平台系统，有多个客户用你的平台，最好是一个客户一个盐值。</span><br><span class="line"></span><br><span class="line">- 我们只需要在user.vue的save方法使用md5就能完成加密</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  _this.user.password = hex_md5(_this.user.password+KEY);</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>当然我们为了保险，我们要设置两层加密，所以我们在UserController的save方法中也使用md5</p>
</li>
<li><pre><code class="java">userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**增加修改密码功能**</span><br><span class="line"></span><br><span class="line">1.用户管理与登录：增加重置密码功能：编辑用户信息的时候不修改密码</span><br><span class="line"></span><br><span class="line">- 修改用户信息和修改密码应该分开，做成两个功能</span><br><span class="line"></span><br><span class="line">- 首先我们设置下user.vue，只有新增时密码才显示出来，修改时不显示密码修改</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  &lt;div v-show=&quot;!user.id&quot; class=&quot;form-group&quot;&gt;</span><br><span class="line">    &lt;label class=&quot;col-sm-2 control-label&quot;&gt;密码&lt;/label&gt;</span><br><span class="line">    &lt;div class=&quot;col-sm-10&quot;&gt;</span><br><span class="line">      &lt;input v-model=&quot;user.password&quot; type=&quot;password&quot; class=&quot;form-control&quot;&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>mybatis-generator生成的方法里，updateByPrimarykeySelective会对字段进行非空判断，再更新，如果值为空就不更新，原理就是利mybatis的if拼成动态sql。</p>
</li>
<li><p>我们在UserService中修改updata</p>
</li>
<li><pre><code class="java">private void update(User user)&#123;
    user.setPassword(null);
    userMapper.updateByPrimaryKeySelective(user);
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ![image-20220321092349206](https://s2.loli.net/2022/03/21/9qKkAPibF4HDwcG.png)</span><br><span class="line"></span><br><span class="line">- 接下来我们要做的就是设置一个重置密码的操作下面修改user.vue</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  //增加一个修改密码表单</span><br><span class="line">  &lt;div id=&quot;edit-password-modal&quot; class=&quot;modal fade&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;modal-content&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">          &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;</span><br><span class="line">          &lt;h4 class=&quot;modal-title&quot;&gt;修改密码&lt;/h4&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">          &lt;form class=&quot;form-horizontal&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;label class=&quot;control-label col-sm-2&quot;&gt;密码&lt;/label&gt;</span><br><span class="line">              &lt;div class=&quot;col-sm-10&quot;&gt;</span><br><span class="line">                &lt;input class=&quot;form-control&quot; type=&quot;password&quot; v-model=&quot;user.password&quot; name=&quot;password&quot;&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          &lt;/form&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;modal-footer&quot;&gt;</span><br><span class="line">          &lt;button type=&quot;button&quot; class=&quot;btn btn-white btn-default btn-round&quot; data-dismiss=&quot;modal&quot;&gt;</span><br><span class="line">            &lt;i class=&quot;ace-icon fa fa-times&quot;&gt;&lt;/i&gt;</span><br><span class="line">            取消</span><br><span class="line">          &lt;/button&gt;</span><br><span class="line">          &lt;button type=&quot;button&quot; class=&quot;btn btn-white btn-info btn-round&quot; v-on:click=&quot;savePassword()&quot;&gt;</span><br><span class="line">            &lt;i class=&quot;ace-icon fa fa-plus blue&quot;&gt;&lt;/i&gt;</span><br><span class="line">            保存密码</span><br><span class="line">          &lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;&lt;!-- /.modal-content --&gt;</span><br><span class="line">    &lt;/div&gt;&lt;!-- /.modal-dialog --&gt;</span><br><span class="line">  &lt;/div&gt;&lt;!-- /.modal --&gt;</span><br><span class="line">  //在操作中增加一个按钮</span><br><span class="line">   &lt;button v-on:click=&quot;editPassword(user)&quot; class=&quot;btn btn-xs btn-info&quot;&gt;</span><br><span class="line">       &lt;i class=&quot;ace-icon fa fa-key bigger-120&quot;&gt;&lt;/i&gt;</span><br><span class="line">  &lt;/button&gt;</span><br><span class="line">  //增加editPassword点击事件</span><br><span class="line">   /**</span><br><span class="line">      * 重置密码</span><br><span class="line">      * @param user</span><br><span class="line">  */</span><br><span class="line">  editPassword(user) &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      _this.user = $.extend(&#123;&#125;, user);</span><br><span class="line">      _this.user.password = null;</span><br><span class="line">      $(&quot;#edit-password-modal&quot;).modal(&quot;show&quot;);</span><br><span class="line">  &#125;,</span><br><span class="line">  //增加savePassword点击事件</span><br><span class="line">   /**</span><br><span class="line">       * 点击重置</span><br><span class="line">       */</span><br><span class="line">      savePassword() &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        _this.user.password = hex_md5(_this.user.password+KEY);</span><br><span class="line">        Loading.show();</span><br><span class="line">        _this.$ajax.post(process.env.VUE_APP_SERVER +&#x27;/system/admin/user/save-password&#x27;, _this.user).then((respond) =&gt; &#123;</span><br><span class="line">          Loading.hide();</span><br><span class="line">          let resp = respond.data;</span><br><span class="line">          if (resp.success) &#123;</span><br><span class="line">            $(&quot;#edit-password-modal&quot;).modal(&quot;hide&quot;);</span><br><span class="line">            _this.list(1);</span><br><span class="line">            Toast.success(&quot;保存成功&quot;);</span><br><span class="line">          &#125;else&#123;</span><br><span class="line">            Toast.warning(resp.message);</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>然后我们在服务端UserService增加保存密码的方法</p>
</li>
<li><p>&#96;&#96;&#96;<br>&#x2F;**</p>
<ul>
<li>重置密码</li>
<li>@param userDto</li>
</ul>
<p> *&#x2F;<br>public void savePassword(UserDto userDto){<br>    User user &#x3D; new User();<br>    user.setId(userDto.getId());<br>    user.setPassword(userDto.getPassword());<br>    userMapper.updateByPrimaryKeySelective(user);<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 我们还需要再UserController中写个savepassword请求</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  /**</span><br><span class="line">   * 重置密码</span><br><span class="line">   */</span><br><span class="line">  @PostMapping(&quot;/save-password&quot;)</span><br><span class="line">  public ResponseDto savePassword(@RequestBody UserDto userDto)&#123;</span><br><span class="line">      userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));</span><br><span class="line">      ResponseDto responseDto = new ResponseDto();</span><br><span class="line">      userService.savePassword(userDto);</span><br><span class="line">      responseDto.setContent(userDto);</span><br><span class="line">      return responseDto;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/21/XEF4g93IWfPop1B.png"
                      alt="image-20220321092436139"
                ></p>
<ul>
<li>思考：我现在存到数据库里面的密码是密文，那用户登录的时候，我数据库里面的密码解密不出来了，我怎么知道用户输入的密码对不对？</li>
</ul>
<h2 id="11-3-基本的登录功能开发"><a href="#11-3-基本的登录功能开发" class="headerlink" title="11-3 基本的登录功能开发"></a>11-3 基本的登录功能开发</h2><p><strong>基本的登录功能开发</strong></p>
<p>1.用户管理与登录：基本的登录功能开发，校验用户名密码</p>
<ul>
<li><p>我们先修改login.vue</p>
</li>
<li><pre><code class="vue"> &lt;label class=&quot;block clearfix&quot;&gt;
&lt;span class=&quot;block input-icon input-icon-right&quot;&gt;
 &lt;input v-model=&quot;user.loginName&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;用户名&quot;/&gt;
 &lt;i class=&quot;ace-icon fa fa-user&quot;&gt;&lt;/i&gt;
&lt;/span&gt;
          &lt;/label&gt;

          &lt;label class=&quot;block clearfix&quot;&gt;
&lt;span class=&quot;block input-icon input-icon-right&quot;&gt;
 &lt;input v-model=&quot;user.password&quot; type=&quot;password&quot; class=&quot;form-control&quot; placeholder=&quot;密码&quot;/&gt;
 &lt;i class=&quot;ace-icon fa fa-lock&quot;&gt;&lt;/i&gt;
&lt;/span&gt;
          &lt;/label&gt;
//然后设置一个data数据
data: function () &#123;
    return &#123;
      user: &#123;&#125;,
    &#125;
  &#125;,
//设置login方法
 login()&#123;
      let _this = this;
      _this.user.password = hex_md5(_this.user.password+KEY);
      Loading.show();
      _this.$ajax.post(process.env.VUE_APP_SERVER +&#39;/system/admin/user/login&#39;, _this.user).then((respond) =&gt; &#123;
        Loading.hide();
        let resp = respond.data;
        if (resp.success) &#123;
          console.log(resp.content)
          this.$router.push(&quot;/welcome&quot;)
        &#125;else &#123;
          Toast.warning(resp.message);
        &#125;
        &#125;);
    &#125;,
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 然后我们设置UserController</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  /**</span><br><span class="line">   * 登录</span><br><span class="line">   */</span><br><span class="line">  @PostMapping(&quot;/login&quot;)</span><br><span class="line">  public ResponseDto login(@RequestBody UserDto userDto)&#123;</span><br><span class="line">      userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));</span><br><span class="line">      ResponseDto responseDto = new ResponseDto();</span><br><span class="line">      LoginUserDto loginUserDto = userService.login(userDto);</span><br><span class="line">      responseDto.setContent(loginUserDto);</span><br><span class="line">      return responseDto;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>接着userService也增加login方法</p>
</li>
<li><p>登录验证思考：是否是根据用户名+密码到数据中去查找记录？</p>
</li>
<li><p>用户名+密码去数据库查找的话，程序不知道是用户名不对，还是密码不对。程序应该要能知道，比如我如果发现有大量的用户名不对的报错，说明有人正在不断的探测我系统的用户名</p>
</li>
<li><p>再次思考：如果用户名不对，提示给前端的是：用户名不存在。如果是密码不对，提示给前端的是：密码不对。是否是这样？</p>
</li>
<li><pre><code class="java">/**
 * 登录
 * @param userDto
 */
public LoginUserDto login(UserDto userDto)&#123;
    User user = selectByLoginName((userDto.getLoginName()));
    if(user == null)&#123;
        LOG.info(&quot;用户名不存在,&#123;&#125;&quot;,userDto.getLoginName());
        throw new BusinessException(BusinessExceptionCode.LOGIN_ERROR);
    &#125;else&#123;
        if (user.getPassword().equals(userDto.getPassword()))&#123;
            return CopyUtil.copy(user,LoginUserDto.class);
        &#125;else&#123;
            LOG.info(&quot;密码不对,输入密码:&#123;&#125;,数据库密码:&#123;&#125;&quot;,userDto.getPassword(),user.getPassword());
            throw new BusinessException(BusinessExceptionCode.LOGIN_ERROR);
        &#125;
    &#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 如果你直接告诉前端说用户名不存在，我做为一个黑客的话，可以拿着现成的一堆用户名，包括手机号邮箱，不断的探测哪些用户名是你系统里有了。不要给别人任何机会获取你系统的关键信息。这时我们在BusinessExceptionCode中增加一个变量</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  LOGIN_ERROR(&quot;用户名或密码错误&quot;),</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>另外我们还需要增加一个LoginUserDto，用于返回返回信息</p>
</li>
<li><pre><code class="java">package com.course.server.dto;


public class LoginUserDto &#123;

    /**
     * id
     */
    private String id;

    /**
     * 登录名
     */
    private String loginName;

    /**
     * 昵称
     */
    private String name;


    public String getId() &#123;
        return id;
    &#125;

    public void setId(String id) &#123;
        this.id = id;
    &#125;

    public String getLoginName() &#123;
        return loginName;
    &#125;

    public void setLoginName(String loginName) &#123;
        this.loginName = loginName;
    &#125;

    public String getName() &#123;
        return name;
    &#125;

    public void setName(String name) &#123;
        this.name = name;
    &#125;



    @Override
    public String toString() &#123;
        StringBuilder sb = new StringBuilder();
        sb.append(getClass().getSimpleName());
        sb.append(&quot; [&quot;);
        sb.append(&quot;Hash = &quot;).append(hashCode());
        sb.append(&quot;, id=&quot;).append(id);
        sb.append(&quot;, loginName=&quot;).append(loginName);
        sb.append(&quot;, name=&quot;).append(name);
        sb.append(&quot;]&quot;);
        return sb.toString();
    &#125;

&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**登录后保存登录信息**</span><br><span class="line"></span><br><span class="line">1.用户管理与登录：登录后前端保存登录信息并显示</span><br><span class="line"></span><br><span class="line">- 前端的信息保存有多种选择：h5的localStorage，sessionStorage；js的全局变量，vue的store等</span><br><span class="line"></span><br><span class="line">- sessionStorage在页面刷新的时候，信息不会丢；关闭页面后，信息自动清空，适合用来存储登录信息</span><br><span class="line"></span><br><span class="line">- localStorage在关闭页面后，登录信息还是在的，适合一些内网使用的系统保存登录信息</span><br><span class="line"></span><br><span class="line">- 用js全局变量或vue的store，刷新浏览器的时候，信息会丢失。</span><br><span class="line"></span><br><span class="line">- 把登录信息的保存和读取做成通用的方法</span><br><span class="line"></span><br><span class="line">- 小技巧：在获取一些对象的时候，加上||&#123; &#125;，避免获取属性值时报错</span><br><span class="line"></span><br><span class="line">- 再这我们在tool.js将登录信息的保存和读取做成通用的方法</span><br><span class="line"></span><br><span class="line">- ```js</span><br><span class="line">  /**</span><br><span class="line">   * 保存登录信息</span><br><span class="line">   * @param loginUser</span><br><span class="line">   */</span><br><span class="line">  setLoginUser:function (loginUser)&#123;</span><br><span class="line">      SessionStorage.set(SESSION_KEY_LOGIN_USER,loginUser);</span><br><span class="line">  &#125;,</span><br><span class="line">  /**</span><br><span class="line">   * 获取登录信息</span><br><span class="line">   * @param loginUser</span><br><span class="line">   * @returns &#123;any|&#123;&#125;&#125;</span><br><span class="line">   */</span><br><span class="line">  getLoginUser:function (loginUser)&#123;</span><br><span class="line">      return SessionStorage.get(SESSION_KEY_LOGIN_USER) ||&#123;&#125;;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>然后我们在session-storage中设置一个常量</p>
</li>
<li><pre><code class="js">SESSION_KEY_LOGIN_USER = &quot;SESSION_KEY_LOGIN_USER&quot;; // 登录信息
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 我们在login.vue</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  if (resp.success) &#123;</span><br><span class="line">    console.log(&quot;登录成功：&quot;,resp.content)</span><br><span class="line">    Tool.setLoginUser(resp.content)//增加这个</span><br><span class="line">    this.$router.push(&quot;/welcome&quot;)</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>我们在admin</p>
</li>
<li><pre><code>//先增加data
data: function () &#123;
  return &#123;
    loginUser: &#123;&#125;,
  &#125;
&#125;,
//在mounted:function初始化时获取 
_this.loginUser  = Tool.getLoginUser()
//最后在头像处将名字显示出来
&lt;span class=&quot;user-info&quot;&gt;
    &lt;small&gt;Welcome,&lt;/small&gt;
    &#123;&#123; loginUser.name &#125;&#125;
&lt;/span&gt;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20220321120620302](https://s2.loli.net/2022/03/21/VQjGaSv4H2wlWkK.png)</span><br><span class="line"></span><br><span class="line">## 11-4 退出登录与记住登录</span><br><span class="line"></span><br><span class="line">**增加推出登录功能**</span><br><span class="line"></span><br><span class="line">1.用户管理与登录：增加退出登录功能，清空前后增的会话缓存</span><br><span class="line"></span><br><span class="line">- 退出登录：清空当前登录的缓存信息，并跳到登录页面</span><br><span class="line"></span><br><span class="line">- 我们先修改下admin页面头像里的三个</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  //头像里的三个文字</span><br><span class="line">  &lt;ul class=&quot;user-menu dropdown-menu-right dropdown-menu dropdown-yellow dropdown-caret dropdown-close&quot;&gt;</span><br><span class="line">    &lt;li&gt;</span><br><span class="line">      &lt;a href=&quot;#&quot;&gt;</span><br><span class="line">        &lt;i class=&quot;ace-icon fa fa-cog&quot;&gt;&lt;/i&gt;</span><br><span class="line">        系统设置</span><br><span class="line">      &lt;/a&gt;</span><br><span class="line">    &lt;/li&gt;</span><br><span class="line">  </span><br><span class="line">    &lt;li&gt;</span><br><span class="line">      &lt;a href=&quot;profile.html&quot;&gt;</span><br><span class="line">        &lt;i class=&quot;ace-icon fa fa-user&quot;&gt;&lt;/i&gt;</span><br><span class="line">        个人信息</span><br><span class="line">      &lt;/a&gt;</span><br><span class="line">    &lt;/li&gt;</span><br><span class="line">  </span><br><span class="line">    &lt;li class=&quot;divider&quot;&gt;&lt;/li&gt;</span><br><span class="line">  </span><br><span class="line">    &lt;li&gt;</span><br><span class="line">      &lt;a v-on:click=&quot;logout()&quot; href=&quot;#&quot;&gt;</span><br><span class="line">        &lt;i class=&quot;ace-icon fa fa-power-off&quot;&gt;&lt;/i&gt;</span><br><span class="line">        登出登录</span><br><span class="line">      &lt;/a&gt;</span><br><span class="line">    &lt;/li&gt;</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">  //上面登录页面有一个logout</span><br><span class="line">  logout()&#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        Loading.show();</span><br><span class="line">        _this.$ajax.get(process.env.VUE_APP_SERVER +&#x27;/system/admin/user/logout&#x27;).then((response) =&gt; &#123;</span><br><span class="line">          Loading.hide();</span><br><span class="line">          let resp = response.data;</span><br><span class="line">          if (resp.success) &#123;</span><br><span class="line">            Tool.setLoginUser(null);</span><br><span class="line">            this.$router.push(&quot;/login&quot;)</span><br><span class="line">          &#125;else &#123;</span><br><span class="line">            Toast.warning(resp.message);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>我们再在server的dto在增加一个常字段Constants</p>
</li>
<li><p>&#96;&#96;&#96;java<br>package com.course.server.dto;</p>
<p>public class Constants {<br>public static final String LOGIN_USER &#x3D; “LOGIN_USER”;<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 接下来写后端，一般登录信息在前后端都会保存，后端缓存</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  /**</span><br><span class="line">   * 登录，这是后端的缓存</span><br><span class="line">   */</span><br><span class="line">  @PostMapping(&quot;/login&quot;)</span><br><span class="line">  public ResponseDto login(@RequestBody UserDto userDto, HttpServletRequest request)&#123;</span><br><span class="line">      userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));</span><br><span class="line">      ResponseDto responseDto = new ResponseDto();</span><br><span class="line">      LoginUserDto loginUserDto = userService.login(userDto);</span><br><span class="line">      request.getSession().setAttribute(Constants.LOGIN_USER,loginUserDto);</span><br><span class="line">      responseDto.setContent(loginUserDto);</span><br><span class="line">      return responseDto;</span><br><span class="line">  &#125;</span><br><span class="line">  /**</span><br><span class="line">   * 退出登录</span><br><span class="line">   */</span><br><span class="line">  @GetMapping(&quot;/logout&quot;)</span><br><span class="line">  public ResponseDto logout(HttpServletRequest request)&#123;</span><br><span class="line">      ResponseDto responseDto = new ResponseDto();</span><br><span class="line">      request.getSession().removeAttribute(Constants.LOGIN_USER);//去掉后端缓存</span><br><span class="line">      return responseDto;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>增加记住登录信息功能</strong></p>
<p>1.用户管理与登录：增加记住登录信息功能</p>
<ul>
<li><p>使用localStorage来保存输入的用户名密码</p>
</li>
<li><p>如果不清空本地缓存，重新打开页面时会再次显示记住的用户名密码</p>
</li>
<li><p>能获取到缓存的值，说明上一次有勾选“记住我</p>
</li>
<li><p>我们首先在local-storage设置一个常量</p>
</li>
<li><p>&#96;&#96;&#96;js<br>LOCAL_KEY_REMEMBER_USER &#x3D;”LOCAL_KEY_REMEMBER_USER”;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 然后我们对login进行修改</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  //给记住我增加一个model</span><br><span class="line">  &lt;div class=&quot;clearfix&quot;&gt;</span><br><span class="line">    &lt;label class=&quot;inline&quot;&gt;</span><br><span class="line">      &lt;input v-model=&quot;remember&quot; type=&quot;checkbox&quot; class=&quot;ace&quot;/&gt;</span><br><span class="line">      &lt;span class=&quot;lbl&quot;&gt; 记住我&lt;/span&gt;</span><br><span class="line">    &lt;/label&gt;</span><br><span class="line">  //data中设置remember</span><br><span class="line">      data: function () &#123;</span><br><span class="line">      return &#123;</span><br><span class="line">        user: &#123;&#125;,</span><br><span class="line">        remember:true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  //在初始化时写以下代码</span><br><span class="line">  let _this=this;</span><br><span class="line">  //从缓存中获取记住的用户名密码,如果获取不到说明上一次没有勾选上“记住我”</span><br><span class="line">  let rememberUser = LocalStorage.get(LOCAL_KEY_REMEBER_USER);</span><br><span class="line">  if(rememberUser)&#123;</span><br><span class="line">      _this.user = rememberUser;</span><br><span class="line">   &#125;</span><br><span class="line">  //登录代码</span><br><span class="line">      methods:&#123;</span><br><span class="line">      login()&#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        let passwordShow = _this.user.password;//新增，先获取明文密码</span><br><span class="line">        _this.user.password = hex_md5(_this.user.password+KEY);</span><br><span class="line">        Loading.show();</span><br><span class="line">        _this.$ajax.post(process.env.VUE_APP_SERVER +&#x27;/system/admin/user/login&#x27;, _this.user).then((response) =&gt; &#123;</span><br><span class="line">          Loading.hide();</span><br><span class="line">          let resp = response.data;</span><br><span class="line">          if (resp.success) &#123;</span><br><span class="line">            console.log(&quot;登录成功：&quot;,resp.content)</span><br><span class="line">            let loginUser = resp.content;//新增</span><br><span class="line">            Tool.setLoginUser(resp.content)</span><br><span class="line">            this.$router.push(&quot;/welcome&quot;)</span><br><span class="line">      ///////////////////////////////////////以下新增</span><br><span class="line">            //判断“记住我”</span><br><span class="line">            if(_this.remember)&#123;</span><br><span class="line">              //如果勾就记住我,则将用户名密码保存到本地缓存这里需要保存密码明文，否则登录时又会再加一层密</span><br><span class="line">              LocalStorage.set(LOCAL_KEY_REMEBER_USER,&#123;</span><br><span class="line">                loginName:loginUser.loginName,</span><br><span class="line">                password:passwordShow</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">              //没有勾选“记住我”时，要把本地缓存清空否则按照Mounted的逻验·下次打开时会自动显示用户名密码</span><br><span class="line">              LocalStorage.set(LOCAL_KEY_REMEBER_USER,null);</span><br><span class="line">            &#125;</span><br><span class="line">      ///////////////////////////////////////////////</span><br><span class="line">          &#125;else &#123;</span><br><span class="line">            Toast.warning(resp.message);</span><br><span class="line">          &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;,</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/21/SPKgOtfGJW42TE7.png"
                      alt="image-20220321173337007"
                ></p>
<p>2.用户管理与登录：增加记住登录信息功能，安全加固，本地缓存</p>
<p>修改login.vue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">login()&#123;</span><br><span class="line">  <span class="type">let</span> <span class="variable">_this</span> <span class="operator">=</span> <span class="built_in">this</span>;</span><br><span class="line">  <span class="comment">//////////////////////////////////////////////////////////////</span></span><br><span class="line">  <span class="comment">//将明文存储到缓存中</span></span><br><span class="line">  <span class="comment">// let passwordShow = _this.user.password;</span></span><br><span class="line">  <span class="comment">//如果密码是从缓存带出来的，则不需要重新加密</span></span><br><span class="line">  <span class="type">let</span> <span class="variable">md5</span> <span class="operator">=</span> hex_md5(_this.user.password);</span><br><span class="line">  <span class="type">let</span> <span class="variable">rememberUser</span> <span class="operator">=</span> LocalStorage.get(LOCAL_KEY_REMEBER_USER)||&#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (md5 !== rememberUser.md5)&#123;</span><br><span class="line">    _this.user.password = hex_md5(_this.user.password+KEY);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//////////////////////////////////////////////////////////////////</span></span><br><span class="line">  Loading.show();</span><br><span class="line">  _this.$ajax.post(process.env.VUE_APP_SERVER +<span class="string">&#x27;/system/admin/user/login&#x27;</span>, _this.user).then((response) =&gt; &#123;</span><br><span class="line">    Loading.hide();</span><br><span class="line">    <span class="type">let</span> <span class="variable">resp</span> <span class="operator">=</span> response.data;</span><br><span class="line">    <span class="keyword">if</span> (resp.success) &#123;</span><br><span class="line">      console.log(<span class="string">&quot;登录成功：&quot;</span>,resp.content)</span><br><span class="line">      <span class="type">let</span> <span class="variable">loginUser</span> <span class="operator">=</span> resp.content;</span><br><span class="line">      Tool.setLoginUser(resp.content)</span><br><span class="line">      <span class="built_in">this</span>.$router.push(<span class="string">&quot;/welcome&quot;</span>)</span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">      <span class="comment">//判断“记住我”</span></span><br><span class="line">      <span class="keyword">if</span>(_this.remember)&#123;</span><br><span class="line">        <span class="comment">//如果勾就记住我,则将用户名密码保存到本地缓存这里需要保存密码明文，否则登录时又会再加一层密</span></span><br><span class="line">        <span class="comment">//原：这里需要保存密码明文，否则登陆时又会再增加一层密</span></span><br><span class="line">        <span class="comment">//新：这里保存密码密文，并保存密文md5，用于检测密码是否被重新输入过</span></span><br><span class="line">        <span class="type">let</span> <span class="variable">md5</span> <span class="operator">=</span> hex_md5(_this.user.password)</span><br><span class="line">        LocalStorage.set(LOCAL_KEY_REMEBER_USER,&#123;</span><br><span class="line">          loginName:loginUser.loginName,</span><br><span class="line">          password:_this.user.password,</span><br><span class="line">          md5: md5</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//没有勾选“记住我”时，要把本地缓存清空否则按照Mounted的逻验·下次打开时会自动显示用户名密码</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        LocalStorage.set(LOCAL_KEY_REMEBER_USER,<span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      Toast.warning(resp.message);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>从刚才的记住我这个功能，大家可以看出来，一个是记住明文，一是记住密文，虽然实现的功能是一样的，但是安全性上不一样，所以我们写程序不只是把功能写出来，还要严谨，不要留下坑</li>
</ul>
<h2 id="11-5-增加登录图形验证码"><a href="#11-5-增加登录图形验证码" class="headerlink" title="11-5 增加登录图形验证码"></a>11-5 增加登录图形验证码</h2><p><strong>集成图形验证码kaptcha</strong></p>
<p>1.用户管理与登录：集成图形验证码kaptcha</p>
<ul>
<li>我们首先再course和server的pom.xml中添加</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 图形验证码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>然后在server的config中添加KaptchaConfig，如果项目中有多个页面会用到验证码图片，且图片的大小颜色等都不一样，就可以增加多个生成验证码图片方法</p>
</li>
<li><p>&#96;&#96;&#96;java<br>package com.course.server.config;</p>
<p>import com.google.code.kaptcha.impl.DefaultKaptcha;<br>import com.google.code.kaptcha.util.Config;<br>import org.springframework.context.annotation.Bean;<br>import org.springframework.context.annotation.Configuration;</p>
<p>import java.util.Properties;</p>
<p>@Configuration<br>public class KaptchaConfig {<br>@Bean<br>public DefaultKaptcha getDefaultKaptcha() {<br>    DefaultKaptcha defaultKaptcha &#x3D; new DefaultKaptcha();<br>    Properties properties &#x3D; new Properties();<br>    properties.setProperty(“kaptcha.border”, “no”);<br>&#x2F;&#x2F;        properties.setProperty(“kaptcha.border.color”, “105,179,90”);<br>    properties.setProperty(“kaptcha.textproducer.font.color”, “blue”);<br>    properties.setProperty(“kaptcha.image.width”, “90”);<br>    properties.setProperty(“kaptcha.image.height”, “32”);<br>    properties.setProperty(“kaptcha.textproducer.font.size”, “24”);<br>    properties.setProperty(“kaptcha.session.key”, “code”);<br>    properties.setProperty(“kaptcha.textproducer.char.length”, “4”);<br>    properties.setProperty(“kaptcha.textproducer.font.names”, “Arial”);<br>    properties.setProperty(“kaptcha.noise.color”, “255,96,0”);<br>    properties.setProperty(“kaptcha.noise.impl”, “com.google.code.kaptcha.impl.NoNoise”);<br>&#x2F;&#x2F;        properties.setProperty(“kaptcha.obscurificator.impl”, “com.google.code.kaptcha.impl.WaterRipple”);<br>    properties.setProperty(“kaptcha.obscurificator.impl”, “com.course.server.util.NoWaterRipple”);<br>    Config config &#x3D; new Config(properties);<br>    defaultKaptcha.setConfig(config);<br>    return defaultKaptcha;<br>}<br><br>@Bean<br>public DefaultKaptcha getWebKaptcha() {<br>    DefaultKaptcha defaultKaptcha &#x3D; new DefaultKaptcha();<br>    Properties properties &#x3D; new Properties();<br>    properties.setProperty(“kaptcha.border”, “no”);<br>&#x2F;&#x2F;        properties.setProperty(“kaptcha.border.color”, “105,179,90”);<br>    properties.setProperty(“kaptcha.textproducer.font.color”, “blue”);<br>    properties.setProperty(“kaptcha.image.width”, “90”);<br>    properties.setProperty(“kaptcha.image.height”, “45”);<br>    properties.setProperty(“kaptcha.textproducer.font.size”, “30”);<br>    properties.setProperty(“kaptcha.session.key”, “code”);<br>    properties.setProperty(“kaptcha.textproducer.char.length”, “4”);<br>    properties.setProperty(“kaptcha.textproducer.font.names”, “Arial”);<br>    properties.setProperty(“kaptcha.noise.impl”, “com.google.code.kaptcha.impl.NoNoise”);<br>    properties.setProperty(“kaptcha.obscurificator.impl”, “com.google.code.kaptcha.impl.WaterRipple”);<br>    Config config &#x3D; new Config(properties);<br>    defaultKaptcha.setConfig(config);<br>    return defaultKaptcha;<br>}<br>} </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 然后再system的admin添加KaptchaController</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  package com.course.system.controller.admin;</span><br><span class="line">  </span><br><span class="line">  import com.google.code.kaptcha.impl.DefaultKaptcha;</span><br><span class="line">  import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">  import org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line">  import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">  import org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line">  import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">  import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">  </span><br><span class="line">  import javax.imageio.ImageIO;</span><br><span class="line">  import javax.servlet.ServletOutputStream;</span><br><span class="line">  import javax.servlet.http.HttpServletRequest;</span><br><span class="line">  import javax.servlet.http.HttpServletResponse;</span><br><span class="line">  import java.awt.image.BufferedImage;</span><br><span class="line">  import java.io.ByteArrayOutputStream;</span><br><span class="line">  </span><br><span class="line">  @RestController</span><br><span class="line">  @RequestMapping(&quot;/admin/kaptcha&quot;)</span><br><span class="line">  public class KaptchaController &#123;</span><br><span class="line">  </span><br><span class="line">      @Qualifier(&quot;getDefaultKaptcha&quot;)</span><br><span class="line">      @Autowired</span><br><span class="line">      DefaultKaptcha defaultKaptcha;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">      @GetMapping(&quot;/image-code/&#123;imageCodeToken&#125;&quot;)</span><br><span class="line">      public void imageCode(@PathVariable(value = &quot;imageCodeToken&quot;) String imageCodeToken, HttpServletRequest request, HttpServletResponse httpServletResponse) throws Exception&#123;</span><br><span class="line">          ByteArrayOutputStream jpegOutputStream = new ByteArrayOutputStream();</span><br><span class="line">          try &#123;</span><br><span class="line">              // 生成验证码字符串</span><br><span class="line">              String createText = defaultKaptcha.createText();</span><br><span class="line">  </span><br><span class="line">              // 将生成的验证码放入会话缓存中，后续验证的时候用到</span><br><span class="line">               request.getSession().setAttribute(imageCodeToken, createText);</span><br><span class="line">  </span><br><span class="line">              // 使用验证码字符串生成验证码图片</span><br><span class="line">              BufferedImage challenge = defaultKaptcha.createImage(createText);</span><br><span class="line">              ImageIO.write(challenge, &quot;jpg&quot;, jpegOutputStream);</span><br><span class="line">          &#125; catch (IllegalArgumentException e) &#123;</span><br><span class="line">              httpServletResponse.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">              return;</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">          // 定义response输出类型为image/jpeg类型，使用response输出流输出图片的byte数组</span><br><span class="line">          byte[] captchaChallengeAsJpeg = jpegOutputStream.toByteArray();</span><br><span class="line">          httpServletResponse.setHeader(&quot;Cache-Control&quot;, &quot;no-store&quot;);</span><br><span class="line">          httpServletResponse.setHeader(&quot;Pragma&quot;, &quot;no-cache&quot;);</span><br><span class="line">          httpServletResponse.setDateHeader(&quot;Expires&quot;, 0);</span><br><span class="line">          httpServletResponse.setContentType(&quot;image/jpeg&quot;);</span><br><span class="line">          ServletOutputStream responseOutputStream = httpServletResponse.getOutputStream();</span><br><span class="line">          responseOutputStream.write(captchaChallengeAsJpeg);</span><br><span class="line">          responseOutputStream.flush();</span><br><span class="line">          responseOutputStream.close();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>页面显示验证码及刷新验证码</strong></p>
<p>1.用户管理与登录：页面显示验证码及刷新验证码</p>
<ul>
<li><p>验证码功能分为显示和验证两个步骤，用token将两个步骤关联起</p>
</li>
<li><p>我们首先给Tool.js增加一个方法，原理：以62进制为例，随机生成一个0~61的数值，比如41，那边就取chars数组中的第41个字符，这样重复做8遍，就生成了8位的62进制数，重复的概率是62的8次方。也可以生成更长的数值。</p>
</li>
<li><p>&#96;&#96;&#96;js<br>&#x2F;**</p>
<ul>
<li>随机生成[len]长度的[radix]进制数</li>
<li>@param len</li>
<li>@param radix 默认62</li>
<li>@returns {string}</li>
</ul>
<p> *&#x2F;<br>uuid: function (len, radix) {<br>    let chars &#x3D; ‘0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz’.split(‘’);<br>    let uuid &#x3D; [];<br>    radix &#x3D; radix || chars.length;</p>
<pre><code>for (let i = 0; i &lt; len; i++) &#123;
    uuid[i] = chars[0 | Math.random() * radix];
&#125;

return uuid.join(&#39;&#39;);
</code></pre>
<p>},</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 然后我们修改login.vue</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">   //增加一个验证码框，在Bootstrap中找</span><br><span class="line">  &lt;label class=&quot;block clearfix&quot;&gt;</span><br><span class="line">  &lt;span class=&quot;block input-icon input-icon-right&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;input-group&quot;&gt;</span><br><span class="line">                  &lt;input  type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;验证码&quot; &gt;</span><br><span class="line">                  &lt;span class=&quot;input-group-addon&quot; id=&quot;basic-add2on&quot;&gt;</span><br><span class="line">                    &lt;img v-on:click=&quot;loadImageCode()&quot; id=&quot;image-code&quot; alt=&quot;验证码&quot;/&gt;</span><br><span class="line">                  &lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">  &lt;/span&gt;</span><br><span class="line">  &lt;/label&gt;</span><br><span class="line">  //初始时加载一次验证码图片</span><br><span class="line">  _this.loadImageCode();</span><br><span class="line">  </span><br><span class="line">   /**</span><br><span class="line">       * 加载验证码方法</span><br><span class="line">       */</span><br><span class="line">      loadImageCode:function ()&#123;</span><br><span class="line">        let _this =this;</span><br><span class="line">        _this.imageCodeToken = Tool.uuid(8);</span><br><span class="line">        $(&#x27;#image-code&#x27;).attr(&#x27;src&#x27;,process.env.VUE_APP_SERVER+&#x27;/system/admin/kaptcha/image-code/&#x27;+_this.imageCodeToken);</span><br><span class="line">      &#125;,</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>登录增加验证码校验</strong></p>
<ul>
<li><p>在userdto中增加属性，增加属性后，记得Alt+lnsert生成get，set，toString（）方法</p>
</li>
<li><pre><code class="java">/**
 * 验证码
 */
private String imageCode;

/**
 * 图片验证码
 */
private String imageCodeToken;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 在登录里面，增加验证码校验：通过token去缓存中获取验证码字符串，并和用户输入的字符串做比较，在这我们修改UserController的login</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  /**</span><br><span class="line">   * 登录</span><br><span class="line">   */</span><br><span class="line">  @PostMapping(&quot;/login&quot;)</span><br><span class="line">  public ResponseDto login(@RequestBody UserDto userDto, HttpServletRequest request)&#123;</span><br><span class="line">      LOG.info(&quot;用户登录开始&quot;);</span><br><span class="line">      userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));</span><br><span class="line">      ResponseDto responseDto = new ResponseDto();</span><br><span class="line">      ////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">      //根据验证码token去获取缓存中的验证码，和用户输入的验证码是否一致</span><br><span class="line">      String imageCode = (String) request.getSession().getAttribute(userDto.getImageCodeToken());</span><br><span class="line">      if (StringUtils.isEmpty(imageCode))&#123;</span><br><span class="line">          responseDto.setSuccess(false);</span><br><span class="line">          responseDto.setMessage(&quot;验证码已过期&quot;);</span><br><span class="line">          LOG.info(&quot;用户登录失败&quot;);</span><br><span class="line">          return responseDto;</span><br><span class="line">      &#125;</span><br><span class="line">      if (!imageCode.toLowerCase().equals(userDto.getImageCode().toLowerCase()))&#123;</span><br><span class="line">          responseDto.setSuccess(false);</span><br><span class="line">          responseDto.setMessage(&quot;验证码不对&quot;);</span><br><span class="line">          LOG.info(&quot;用户登录失败&quot;);</span><br><span class="line">          return responseDto;</span><br><span class="line">      &#125;else&#123;</span><br><span class="line">          //验证码通过后，移除验证码</span><br><span class="line">          request.getSession().removeAttribute(userDto.getImageCodeToken());</span><br><span class="line">      &#125;</span><br><span class="line">      ///////////////////////////////////////////////////////////////////////////////</span><br><span class="line">      LoginUserDto loginUserDto = userService.login(userDto);</span><br><span class="line">      request.getSession().setAttribute(Constants.LOGIN_USER,loginUserDto);</span><br><span class="line">      responseDto.setContent(loginUserDto);</span><br><span class="line">      return responseDto;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>前后端分离会有一个问题，每次ajax请求，后端的session是不一样的。在springboo+jsp，或springboot+thymeleaf中，不会有这个问题。获取的验证码一致都是空，这个问题在页面中显示：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/22/YKgnEjV2ah8r5Tl.png"
                      alt="image-20220322110349728"
                ></p>
</li>
<li><p>下面开始解决验证码获取为空的方法，在main.js中加入</p>
</li>
<li><p>&#96;&#96;&#96;js<br>&#x2F;&#x2F;解决每次ajax请求·对应的sessionId不一致的问题<br>axios.defaults.withCredentials &#x3D;true;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 登录验证出错时，将密码清空，同时刷新验证码图片</span><br><span class="line"></span><br><span class="line">- 刷新验证码会让网站更安全，但是会辆性一点用户体验，需要折中选择</span><br><span class="line"></span><br><span class="line">- 只需要在login.vue中login方法登陆不成功时输入下面代码，就可以将密码清空，同时刷新验证码图片</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  _this.user.password = &quot;&quot;;</span><br><span class="line">  _this.loadImageCode();</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="11-6-单点登录功能开发"><a href="#11-6-单点登录功能开发" class="headerlink" title="11-6 单点登录功能开发"></a>11-6 单点登录功能开发</h2><p><strong>单点登录解决方案介绍</strong></p>
<ul>
<li>生产发布时，至少是双节点，防止单台宕机</li>
<li>request.getSession（）可以访问这片空间</li>
<li>问题一：B节点中，没有经历过之前的登录，Session没有保存登录用户信息，于是B节点会认为未登录过，会拦截掉业务请</li>
<li>解决方法一：IP_HASH，对客户端IP做HASH计算，负载均衡SLB中，会根据HASH值将该IP所有的请求固定的发往其中一台，缺点，当其中一个节点宕机，则该节点下的用户需要重新登录；另一个缺点是对SLB不能灵活的配置流量此如A这台机器性能好一点可以分配流量高一些</li>
<li>解决方法二：不管是在哪一台做的登录，登录完成后，会把登录信息保存到redis中。当业务请求进来时，再到redis中获取登录信息，能获取到就表示已登录；未获取到就表示未登录，拦截掉请求</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/22/1wHWjQd4vIpLYVz.png"
                      alt="image-20220322144243004"
                ></p>
<ul>
<li>功能：只要在其中一个产品中登录过，其他关联的产品都不需要再登录</li>
<li>token：登录标识，每个用户每次登录，都会生成不同的token</li>
<li>单点登录（Single Sign On），简称为SSO，核心功能为session共享</li>
<li>需要解决Session共享的场景：1.同个应用多节点共享登录信息；2.多个项目间共享登录信息。一般我们通常说的单点登录系统，是用来解决场景2的</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/22/LarEsBOM7Ig6UpH.png"
                      alt="image-20220322144848481"
                ></li>
</ul>
<p><strong>集成redis</strong></p>
<p>1，用户管理与登录：集成redis，图片验证码的存储从session改为redis</p>
<ul>
<li><p>首先在server集成pom.xml</p>
</li>
<li><pre><code class="xml">&lt;!-- redis --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 然后在application中增加配置</span><br><span class="line"></span><br><span class="line">- ```properties</span><br><span class="line">  # redis配置</span><br><span class="line">  spring.redis.host=r-uf6ljbcdaxobsifyctpd.redis.rds.aliyuncs.com</span><br><span class="line">  spring.redis.port=6379</span><br><span class="line">  spring.redis.password=Redis000</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>然后我们在KaptchaController中修改放验证码操作</p>
</li>
<li><p>&#96;&#96;&#96;java<br>&#x2F;&#x2F;注入<br>@Resource<br>public RedisTemplate redisTemplate;</p>
<p>&#x2F;&#x2F; 将生成的验证码放入会话缓存中，后续验证的时候用到<br>&#x2F;&#x2F; request.getSession().setAttribute(imageCodeToken, createText);<br>&#x2F;&#x2F;将生成的验证码放入redis缓存中后续验证的时候用到<br>redisTemplate.opsForValue().set(imageCodeToken,createText,300, TimeUnit.SECONDS);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 最后在UserController进行取操作</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  //注入</span><br><span class="line">  @Resource</span><br><span class="line">  public RedisTemplate redisTemplate;</span><br><span class="line">  </span><br><span class="line">  //根据验证码token去获取缓存中的验证码，和用户输入的验证码是否一致</span><br><span class="line">  //String imageCode = (String)request.getSession().getAttribute(userDto.getImageCodeToken());</span><br><span class="line">  String imageCode =(String)redisTemplate.opsForValue().get(userDto.getImageCodeToken());</span><br><span class="line">  LOG.info(&quot;从redis中获取到验证码:&#123;&#125;&quot;,imageCode);</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>生成登录token并存储到redis中</strong></p>
<p>1.用户管理与登录；生成登录token并存储到redis中：退出登录删除token</p>
<ul>
<li><p>我们在LoginUserDto增加</p>
</li>
<li><pre><code class="java">/**
 * 登录凭证
 */
private String token;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 然后修改UserController，这里也可以直接保存loginUserDto对象，但是需要序列化。如果是跨应用使用的，比如A应用存，B应用取，一般会把值转成JSON字符串</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">     //验证码通过后，移除验证码</span><br><span class="line">      //request.getSession().removeAttribute(userDto.getImageCodeToken());</span><br><span class="line">      redisTemplate.delete(userDto.getImageCodeToken());</span><br><span class="line">  &#125;</span><br><span class="line">  LoginUserDto loginUserDto = userService.login(userDto);</span><br><span class="line">  String token = UuidUtil.getShortUuid();</span><br><span class="line">  loginUserDto.setToken(token);</span><br><span class="line">  //request.getSession().setAttribute(Constants.LOGIN_USER,loginUserDto);</span><br><span class="line">  redisTemplate.opsForValue().set(token, JSON.toJSONString(loginUserDto),300, TimeUnit.SECONDS);</span><br><span class="line">  responseDto.setContent(loginUserDto);</span><br><span class="line">  return responseDto;</span><br><span class="line">  ////////////////////////////////////////////////////</span><br><span class="line">  /**</span><br><span class="line">       * 退出登录</span><br><span class="line">       */</span><br><span class="line">      @GetMapping(&quot;/logout/&#123;token&#125;&quot;)</span><br><span class="line">      public ResponseDto logout(@PathVariable String token)&#123;</span><br><span class="line">          ResponseDto responseDto = new ResponseDto();</span><br><span class="line">          //request.getSession().removeAttribute(Constants.LOGIN_USER);</span><br><span class="line">         redisTemplate.delete(token);</span><br><span class="line">         LOG.info(&quot;从redis中删除token:&#123;&#125;&quot;,token);</span><br><span class="line">          return responseDto;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>相应的admin.vue，增加token参数</p>
</li>
<li><pre><code class="vue">_this.$ajax.get(process.env.VUE_APP_SERVER +&#39;/system/admin/user/logout/&#39;+_this.loginUser.token)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 11-7 前后端登录拦截</span><br><span class="line"></span><br><span class="line">1.用户管理与登录；基于Vue路由的登录拦截</span><br><span class="line"></span><br><span class="line">- 首先在router的admin下增加meta</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  path: &quot;/&quot;,</span><br><span class="line">  name:&quot;admin&quot;,</span><br><span class="line">  component: Admin,</span><br><span class="line">  meta:&#123;</span><br><span class="line">      loginRequire:true</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>最后我们在main.js增加，就实现了拦截</p>
</li>
<li><p>&#96;&#96;&#96;java<br>&#x2F;&#x2F;路由拦截器<br>router.beforeEach((to,from,next) &#x3D;&gt;{<br>  if (to.matched.some(function (item){<br>return item.meta.loginRequire<br>  })){<br>let loginUser &#x3D; Tool.getLoginUser();<br>if(Tool.isEmpty(loginUser)){<br>  next(‘&#x2F;login’);<br>}else{<br>  next();<br>}<br>  }else{<br>next();<br>  }<br>});</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**在请求headers中统一增加token**</span><br><span class="line"></span><br><span class="line">- 问题：界面拦住了，但是所有的接口都可以直接访问，非常危险，这时我们要做的就是基于后端的登录拦截</span><br><span class="line"></span><br><span class="line">- 就是在main.js的axias拦截器中增加，可以用这种给所有请求加了统一的系统参数，比如在header里加上请求流水，请求时间等</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  let token =Tool.getLoginUser().token;</span><br><span class="line">  if (Tool.isNotEmpty(token))&#123;</span><br><span class="line">    config.headers.token = token;</span><br><span class="line">    console.log(&quot;请求headers增加token:&quot;,token);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>gateway增加登录拦截</strong></p>
<p>1.用户管理与登录：：在Gateway中增加登录拦截器</p>
<ul>
<li><p>不是所有的请求都需要做登录拦截，比如登录接口、验证码图片接口</p>
</li>
<li><p>我们首先在application中增加过滤配置</p>
</li>
<li><pre><code class="properties">spring.cloud.gateway.routes[0].filters[0].name=LoginAdmin
spring.cloud.gateway.routes[0].filters[0].args[0]=true
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 然后我们给系统加一个过滤器，在gateway下增加一个filter软件包，建立一个类LoginAdminGatewayFilterFactory</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  package com.course.gateway.filter;</span><br><span class="line">  </span><br><span class="line">  import org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line">  import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;</span><br><span class="line">  import org.springframework.stereotype.Component;</span><br><span class="line">  </span><br><span class="line">  import javax.annotation.Resource;</span><br><span class="line">  </span><br><span class="line">  @Component</span><br><span class="line">  public class LoginAdminGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;Object&gt; &#123;</span><br><span class="line">  </span><br><span class="line">      @Resource</span><br><span class="line">      LoginAdminGatewayFilter loginAdminGatewayFilter;</span><br><span class="line">  </span><br><span class="line">      @Override</span><br><span class="line">      public GatewayFilter apply(Object config) &#123;</span><br><span class="line">          return loginAdminGatewayFilter;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>最后在同包下建立实现类LoginAdminGatewayFilter</p>
</li>
<li><pre><code class="java">package com.course.gateway.filter;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.cloud.gateway.filter.GatewayFilter;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.core.Ordered;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

@Component
public class LoginAdminGatewayFilter implements GatewayFilter, Ordered &#123;

    private static final Logger LOG = LoggerFactory.getLogger(LoginAdminGatewayFilter.class);


    @Override
    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;
        //获取header的token参数
        String token = exchange.getRequest().getHeaders().getFirst(&quot;token&quot;);
        LOG.info(&quot;控台登录验证开始，token：&#123;&#125;&quot;, token);
        return chain.filter(exchange);
        &#125;

    @Override
    public int getOrder()
    &#123;
        return 1;
    &#125;
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2.用户管理与登录：gateway实现控台登录拦截功能</span><br><span class="line"></span><br><span class="line">- 我们给gateway的pom.xml增加，gateway模块并没有依赖server模块，所以有些jar包redis，json等，需要单独在pom.xml中增加依赖</span><br><span class="line"></span><br><span class="line">- ```xml</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;!-- 热部署DevTools --&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>在LoginAdminGatewayFilter做如下修改</p>
</li>
<li><pre><code class="java">//注入
@Resource
private RedisTemplate redisTemplate;
//判断拦截
 @Override
    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;
    //////////////////////////////////////////////////////////
        String path = exchange.getRequest().getURI().getPath();

        //请求地址不包含/admin/的，不是控台请求，不需要拦截
        if(!path.contains(&quot;/admin/&quot;))&#123;
            return chain.filter(exchange);
        &#125;
        if (path.contains(&quot;/system/admin/user/login&quot;)
                ||path.contains(&quot;/system/admin/user/logout&quot;)
                ||path.contains(&quot;/system/admin/kaptcha&quot;))&#123;
            LOG.info(&quot;不需要控台登录验证:&#123;&#125;&quot;,path);
            return chain.filter(exchange);
        &#125;
    ///////////////////////////////////////////////////////////////
        //获取header的token参数
        String token = exchange.getRequest().getHeaders().getFirst(&quot;token&quot;);
        LOG.info(&quot;控台登录验证开始，token：&#123;&#125;&quot;, token);
    /////////////////////////////////////////////////////////////////
        if (token == null||token.isEmpty())&#123;
            LOG.info(&quot;token为空，请求被拦截&quot;);
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        &#125;
        Object object = redisTemplate.opsForValue().get(token);
        if (object == null)&#123;
            LOG.warn(&quot;token无效，请求被拦截&quot;);
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        &#125;else&#123;
            LOG.info(&quot;已登录:&#123;&#125;&quot;,object);
            return chain.filter(exchange);
        &#125;
    ////////////////////////////////////////////////////////////////////////////
        &#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 11-8 用户登录流程图</span><br><span class="line"></span><br><span class="line">**验证码图片登录**</span><br><span class="line"></span><br><span class="line">![image-20220323120729776](https://s2.loli.net/2022/03/23/mLCw1ZGrJPQuhUo.png)</span><br><span class="line"></span><br><span class="line">![image-20220323120812348](https://s2.loli.net/2022/03/23/Yag4z8IZPEwA3DT.png)</span><br><span class="line"></span><br><span class="line">**登录的流程**</span><br><span class="line"></span><br><span class="line">![image-20220323120858378](https://s2.loli.net/2022/03/23/5He4E1ZMb23TXPs.png)</span><br><span class="line"></span><br><span class="line">![image-20220323120919748](https://s2.loli.net/2022/03/23/h5Iut2cBRlPMOHa.png)</span><br><span class="line"></span><br><span class="line">![image-20220323121028370](https://s2.loli.net/2022/03/23/b6ODknduZC3LPKE.png)</span><br><span class="line"></span><br><span class="line">![](https://s2.loli.net/2022/03/23/9PiSnANMfyRC16L.png)</span><br><span class="line"></span><br><span class="line">![image-20220323121244262](https://s2.loli.net/2022/03/23/JWmX4CScP35lig7.png)</span><br><span class="line"></span><br><span class="line">![image-20220323121306313](https://s2.loli.net/2022/03/23/H9YwsyDmTvcdX6h.png)</span><br><span class="line"></span><br><span class="line"># 第12章 通用权限设计</span><br><span class="line"></span><br><span class="line">本章演示通用权限功能开发，不依赖任何使用第三方框架，使用经典的资源、角色、用户关联，灵活且维护，可以细粒度的控制菜单、按钮、接口的权限，适用于通用后台管理系统的权限管理。</span><br><span class="line"></span><br><span class="line">***</span><br><span class="line"></span><br><span class="line">## 12-1 通用权限解决方案介绍</span><br><span class="line"></span><br><span class="line">- 目前一些知名的权限框架有Shiro和SpringSecurity。正常情况，直接用框架没什么问题。方便，快速，但是需要一定的学习成本，得学习如何使用这些框架。</span><br><span class="line">- 用框架还有一个缺点是不好定制，因为每个产品的业务都不太一样，要控制的权限都不太一样，此时如果硬是套用框架就会很别扭</span><br><span class="line">- 经典的权限管理设计：用户和角色关联，角色和资源关联</span><br><span class="line">- 两张关联表的配置，可以单独设计界面，也可以直接做到角色管理界面里。</span><br><span class="line">- 权限初始化，系统上线时，要初始化这五张表的数据。初始有一个用户能登录能管理角色，管理资源，分配权限</span><br><span class="line">- 疑问：前端已经对菜单和按钮做拦截，用户不能操作，为什么还要对接口做拦截？</span><br><span class="line">- 重要提示：所有前端的设计都是不安全的</span><br><span class="line"></span><br><span class="line">![image-20220323144829155](https://s2.loli.net/2022/03/23/sGLSViJINfwhj5d.png)</span><br><span class="line"></span><br><span class="line">## 12-2 资源配置管理</span><br><span class="line"></span><br><span class="line">**资源表的设计与基本代码生成**</span><br><span class="line"></span><br><span class="line">1.通用权限管理：资源表的设计与基本代码生成</span><br><span class="line"></span><br><span class="line">- 资源的名称一般是用页面上看得见的元素：菜单、按钮等。</span><br><span class="line"></span><br><span class="line">- 页面对vue框架来说，就是路由</span><br><span class="line"></span><br><span class="line">- 如果是一个页面的所有操作统一控制权限，request可以填相关接口的前缀</span><br><span class="line"></span><br><span class="line">- 我们首先写sql</span><br><span class="line"></span><br><span class="line">- ```sql</span><br><span class="line">  # 资源</span><br><span class="line">  drop table if exists `resource`;</span><br><span class="line">  create table `resource`(</span><br><span class="line">                         `id` char(6) not null default &#x27;&#x27; comment &#x27;id&#x27;,</span><br><span class="line">                         `name` varchar(100) not null comment &#x27;名称|菜单或按钮&#x27;,</span><br><span class="line">                         `page` varchar(50) null comment &#x27;页面|路由&#x27;,</span><br><span class="line">                         `request` varchar(200) null comment &#x27;请求|接口&#x27;,</span><br><span class="line">                         `parent` char(6)  comment &#x27;父id&#x27;,</span><br><span class="line">                         primary key (`id`)</span><br><span class="line">  )engine =innodb default charset=utf8mb4 comment=&#x27;资源&#x27;;</span><br><span class="line">  </span><br><span class="line">  insert into `resource` values (&#x27;01&#x27;,&#x27;系统管理&#x27;,null,null,null);</span><br><span class="line">  insert into `resource` values (&#x27;0101&#x27;,&#x27;用户管理&#x27;,&#x27;/system/user&#x27;,null,&#x27;01&#x27;);</span><br><span class="line">  insert into `resource` values (&#x27;010101&#x27;,&#x27;保存&#x27;,null,&#x27;[&quot;/system/admin/user/list&quot;,&quot;/system/admin/user/save&quot;]&#x27;,&#x27;0101&#x27;);</span><br><span class="line">  insert into `resource` values (&#x27;010102&#x27;,&#x27;删除&#x27;,null,&#x27;[&quot;/system/admin/user/delete&quot;]&#x27;,&#x27;0101&#x27;);</span><br><span class="line">  insert into `resource` values (&#x27;010103&#x27;,&#x27;重置密码&#x27;,null,&#x27;[&quot;/system/admin/user/save-password&quot;]&#x27;,&#x27;0101&#x27;);</span><br><span class="line">  insert into `resource` values (&#x27;0102&#x27;,&#x27;资源管理&#x27;,&#x27;/system/resource&#x27;,null,&#x27;01&#x27;);</span><br><span class="line">  insert into `resource` values (&#x27;010201&#x27;,&#x27;保存/显示&#x27;,null,&#x27;[&quot;/system/admin/resource&quot;]&#x27;,&#x27;0102&#x27;);</span><br><span class="line">  insert into `resource` values (&#x27;0103&#x27;,&#x27;角色管理&#x27;,&#x27;/system/role&#x27;,null,&#x27;01&#x27;);</span><br><span class="line">  insert into `resource` values (&#x27;010301&#x27;,&#x27;角色/权限管理&#x27;,null,&#x27;[&quot;/system/admin/role&quot;]&#x27;,&#x27;0103&#x27;);</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>接着就开始一顿操作，代码生成器，最后生成vue时，ResourceService和ResourceController会出现一个问题，原因：资源表的实体类是Resource，和@Resbutee注解同名！导致冲突<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/wW3hxoPyMv9dsLg.png"
                      alt="image-20220323192200289"
                ></p>
</li>
<li><p>解决上面的问题就是直接写全<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/UW5xh67KifNCE3n.png"
                      alt="image-20220323192341557"
                ></p>
</li>
<li><p>下面开始修改admin</p>
</li>
<li><p>&#96;&#96;&#96;vue</p>
<li class="">
  <router-link to="/system/resource">
    <i class="menu-icon fa fa-caret-right"></i>
    资源管理
  </router-link>

<p>  <b class="arrow"></b></p>
</li>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 最后改下router.js</span><br><span class="line"></span><br><span class="line">- ```js</span><br><span class="line">  ,&#123;</span><br><span class="line">      path: &quot;system/resource&quot;,</span><br><span class="line">      name:&quot;system/resource&quot;,</span><br><span class="line">      component: Resource,</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>资源树的保存</strong></p>
<p>1.通用权限管理：资源树的保存</p>
<ul>
<li><p>资源点是开发阶段就确定的，所以并不是上线后再一个一个配置的。</p>
</li>
<li><p>资源管理最简单的一种方案：上线前准备好sql，刷库</p>
</li>
<li><p>在这里将资源管理做成资源树进行管理，填入数据：带有层级结构的json字符串<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/WGr4hF6TIQeXSkY.png"
                      alt="image-20220323201202115"
                ></p>
</li>
<li><p>用法：以后开发新功能的时候，就在该文件里加入新的资源可以上线前将新的资源json通过控台保存进数据库</p>
</li>
<li><pre><code class="json">[&#123;
  &quot;id&quot;: &quot;01&quot;,&quot;name&quot;: &quot;系统管理&quot;,
  &quot;children&quot;:[&#123;
    &quot;id&quot;:&quot;0101&quot;,&quot;name&quot;:&quot;用户管理&quot;,&quot;page&quot;:&quot;/system/user&quot;,
    &quot;children&quot;:[
        &#123;&quot;id&quot;:&quot;010101&quot;,&quot;name&quot;:&quot;保存&quot;,&quot;request&quot;:[&quot;/system/admin/user/list&quot;,&quot;/system/admin/user/save&quot;]&#125;,
        &#123;&quot;id&quot;:&quot;010102&quot;,&quot;name&quot;:&quot;删除&quot;,&quot;request&quot;:[&quot;/system/admin/user/delete&quot;]&#125;,
        &#123;&quot;id&quot;:&quot;010103&quot;,&quot;name&quot;:&quot;重置密码&quot;,&quot;request&quot;:[&quot;/system/admin/user/save-password&quot;]&#125;
      ]
&#125;,
    &#123;
      &quot;id&quot;:&quot;0102&quot;,&quot;name&quot;:&quot;资源管理&quot;,&quot;page&quot;:&quot;/system/resource&quot;,
      &quot;children&quot;:[
        &#123;&quot;id&quot;:&quot;010201&quot;,&quot;name&quot;:&quot;保存/显示&quot;,&quot;request&quot;:[&quot;/system/admin/resource&quot;]&#125;
      ]
    &#125;, &#123;
        &quot;id&quot;:&quot;0103&quot;,&quot;name&quot;:&quot;角色管理&quot;,&quot;page&quot;:&quot;/system/role&quot;,
        &quot;children&quot;:[
            &#123;&quot;id&quot;:&quot;010301&quot;,&quot;name&quot;:&quot;角色/权限管理&quot;,&quot;request&quot;:[&quot;/system/admin/role&quot;]&#125;
          ]
      &#125;]
&#125;]
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 接下来修改下resource.vue，</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  //新增去了，加上保存，并且删除模态框</span><br><span class="line">  &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;col-md-6&quot;&gt;</span><br><span class="line">      &lt;textarea id=&quot;resource-textarea&quot; class=&quot;form-control&quot; v-model=&quot;resourceStr&quot; name=&quot;resource&quot; rows=&quot;10&quot;&gt;&lt;/textarea&gt;</span><br><span class="line">  </span><br><span class="line">      &lt;br&gt;</span><br><span class="line">      &lt;button id=&quot;save-btn&quot; type=&quot;button&quot; class=&quot;btn btn-primary&quot; v-on:click=&quot;save()&quot;&gt;</span><br><span class="line">        保存</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">  //然后data新增一个resourceStr绑定到多行文本框里的</span><br><span class="line">  resourceStr:&quot;&quot;,</span><br><span class="line">  //然后add和edit都删了</span><br><span class="line">  //最后修改下save</span><br><span class="line">    save() &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">  /////////////////////////////////////////////以下是修改</span><br><span class="line">        // 保存校验</span><br><span class="line">        if (Tool.isEmpty(_this.resourceStr)) &#123;</span><br><span class="line">          Toast.warning(&quot;资源不能为空！&quot;);</span><br><span class="line">          return;</span><br><span class="line">        &#125;</span><br><span class="line">        let json = JSON.parse(_this.resourceStr);</span><br><span class="line">  </span><br><span class="line">        Loading.show();</span><br><span class="line">        _this.$ajax.post(process.env.VUE_APP_SERVER +&#x27;/system/admin/resource/save&#x27;, json).then((respond) =&gt; &#123;</span><br><span class="line">  /////////////////////////////////////////////////</span><br><span class="line">          Loading.hide();</span><br><span class="line">          let resp = respond.data;</span><br><span class="line">          if (resp.success) &#123;</span><br><span class="line">            $(&quot;#form-modal&quot;).modal(&quot;hide&quot;);</span><br><span class="line">            _this.list(1);</span><br><span class="line">            Toast.success(&quot;保存成功&quot;);</span><br><span class="line">          &#125;else&#123;</span><br><span class="line">            Toast.warning(resp.message);</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>接下来修改下ResourceController的save，原本是一个个保存，现在直接保存整个字符串</p>
</li>
<li><pre><code class="java">@PostMapping(&quot;/save&quot;)
public ResponseDto save(@RequestBody String jsonStr)&#123;
    //保存校验
        ValidatorUtil.require(jsonStr, &quot;资源&quot;);

    ResponseDto responseDto = new ResponseDto();
    resourceService.saveJson(jsonStr);
    return responseDto;
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 然后我们修改ResourceDto</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  private List&lt;ResourceDto&gt; children;//嵌套实类结构</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>最后我们修改ResourceService</p>
</li>
<li><pre><code class="java">/**
 * 新增，ID是自定义好的，不是自动生成的，将setId删除
 */
private void insert(Resource resource)&#123;
    resourceMapper.insert(resource);
&#125;

 /**
     * 保存资源树
     * @param json
     */
    @Transactional
    public void saveJson(String json)&#123;
        List&lt;ResourceDto&gt; jsonList = JSON.parseArray(json, ResourceDto.class);
        List&lt;ResourceDto&gt; list = new ArrayList&lt;&gt;();//将带有嵌套结构的jsonList里所有的节点取出来，组成简单的list
        if (!CollectionUtils.isEmpty(jsonList))&#123;
            for (ResourceDto d:jsonList)&#123;
                d.setParent(&quot;&quot;);
                add(list,d);
            &#125;
        &#125;
        LOG.info(&quot;共&#123;&#125;条&quot;,list.size());
        resourceMapper.deleteByExample(null);//把数据库整张表清空
        for (int i = 0; i &lt; list.size(); i++) &#123;
            this.insert(CopyUtil.copy(list.get(i),Resource.class));
        &#125;
    &#125;

 /**
     * 递归，将树形节点全部取出来，放到list。add方法是一个递归函数，功能是将d节点下的子节点添加到list中如果子节点下还有孙子节点，则递归调用add方法
     * @param list
     * @param dto
     */
    public void add(List&lt;ResourceDto&gt; list,ResourceDto dto)&#123;
        list.add(dto);
        if(!CollectionUtils.isEmpty(dto.getChildren()))&#123;
            for (ResourceDto d:dto.getChildren())&#123;
                d.setParent(dto.getId());
                add(list,d);
            &#125;
        &#125;
    &#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**资源树的显示**</span><br><span class="line"></span><br><span class="line">![image-20220324100951445](https://s2.loli.net/2022/03/24/S43O1C9zFjX7xfI.png)</span><br><span class="line"></span><br><span class="line">- 我们首先修改resource.vue</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  //在保存按钮下新增，下面表格就可以删了</span><br><span class="line">  &lt;div class=&quot;col-md-6&quot;&gt;</span><br><span class="line">    &lt;ul id=&quot;tree&quot; class=&quot;ztree&quot;&gt;&lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  //data中增加对象</span><br><span class="line">  tree:&#123;&#125;,</span><br><span class="line">  //对list进行修改</span><br><span class="line">  list() &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        Loading.show();</span><br><span class="line">        _this.$ajax.get(process.env.VUE_APP_SERVER +&#x27;/system/admin/resource/load-tree&#x27;)</span><br><span class="line">        .then((res) =&gt; &#123;</span><br><span class="line">          Loading.hide();</span><br><span class="line">          let response = res.data;</span><br><span class="line">          _this.resources = response.content;</span><br><span class="line">          //初始树</span><br><span class="line">          _this.initTree();</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">  //增加一个初始化树</span><br><span class="line">   initTree()&#123;</span><br><span class="line">        let _this =this;</span><br><span class="line">        let setting=&#123;</span><br><span class="line">          data:&#123;</span><br><span class="line">            simpleData:&#123;</span><br><span class="line">              idKey:&quot;id&quot;,</span><br><span class="line">              pIdKey:&quot;parent&quot;,</span><br><span class="line">              rootPId:&quot;&quot;,</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        _this.zTree = $.fn.zTree.init($(&quot;#tree&quot;),setting,_this.resources);</span><br><span class="line">        _this.zTree.expandAll(true);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>在ResourceController就增加了一个方法</p>
</li>
<li><pre><code class="java">/**
 * 资源树查询
 */
@GetMapping(&quot;/load-tree&quot;)
public  ResponseDto loadTree()&#123;
    ResponseDto responseDto = new ResponseDto();
    List&lt;ResourceDto&gt; resourceDtoList = resourceService.loadTree();
    responseDto.setContent(resourceDtoList);
    return responseDto;
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 接下来修改下对应的ResourceService</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  /**</span><br><span class="line">   * 按约定将列表转成树</span><br><span class="line">   * 要求：ID要正序排列</span><br><span class="line">   */</span><br><span class="line">  public List&lt;ResourceDto&gt; loadTree() &#123;</span><br><span class="line">      ResourceExample example = new ResourceExample();</span><br><span class="line">      example.setOrderByClause(&quot;id asc&quot;);</span><br><span class="line">      List&lt;Resource&gt; resourceList = resourceMapper.selectByExample(example);</span><br><span class="line">      List&lt;ResourceDto&gt; resourceDtoList = CopyUtil.copyList(resourceList, ResourceDto.class);</span><br><span class="line">      for (int i = resourceDtoList.size() - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">          //当前要移动的记录</span><br><span class="line">          ResourceDto child = resourceDtoList.get(i);</span><br><span class="line">          //如果当前节点没有父节点，则不用往下了</span><br><span class="line">          if (StringUtils.isEmpty(child.getParent())) &#123;</span><br><span class="line">              continue;</span><br><span class="line">          &#125;</span><br><span class="line">          //查找父节点</span><br><span class="line">          for (int j = i - 1; j &gt;= 0; j--) &#123;</span><br><span class="line">              ResourceDto parent = resourceDtoList.get(j);</span><br><span class="line">              if (child.getParent().equals(parent.getId())) &#123;</span><br><span class="line">                  if (CollectionUtils.isEmpty(parent.getChildren())) &#123;</span><br><span class="line">                      parent.setChildren(new ArrayList&lt;&gt;());</span><br><span class="line">                  &#125;</span><br><span class="line">                  //添加到最前面，否则会变成倒序，因为循环是从后往前循环的</span><br><span class="line">                  parent.getChildren().add(0, child);</span><br><span class="line">                  //子节点找到父节点后删除列表中的子节点</span><br><span class="line">                  resourceDtoList.remove(child);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return resourceDtoList;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>资源的保存是将树结构转成列表，重点是children属性；资源的显示是将列表转成树结构，重点是parent属性。</p>
</li>
<li><p>小知识：一边循环list，一边删除list中的对象，可以使用倒序循环</p>
</li>
</ul>
<h2 id="12-3角色权限管理"><a href="#12-3角色权限管理" class="headerlink" title="12-3角色权限管理"></a>12-3角色权限管理</h2><p><strong>基本的角色管理功能</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：增加基本的角色管理功能</span><br><span class="line">2.资源列表补全</span><br></pre></td></tr></table></figure>

<ul>
<li><p>我们首先写sql，然后代码生成器</p>
</li>
<li><pre><code class="sql"># 角色
drop table if exists `role`;
create table `role`(
                           `id` char(8) not null default &#39;&#39; comment &#39;id&#39;,
                           `name` varchar(50) not null comment &#39;角色&#39;,
                           `desc` varchar(100) not null comment &#39;描述&#39;,
                           primary key (`id`)
)engine =innodb default charset=utf8mb4 comment=&#39;角色&#39;;

insert into `role` values (&#39;00000000&#39;,&#39;系统管理员&#39;,&#39;管理用户、角色权限&#39;);
insert into `role` values (&#39;00000001&#39;,&#39;开发&#39;,&#39;维护资源&#39;);
insert into `role` values (&#39;00000002&#39;,&#39;业务管理员&#39;,&#39;负责业务管理&#39;);
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- admin增加</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  &lt;b class=&quot;arrow&quot;&gt;&lt;/b&gt;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;li class=&quot;&quot; id=&quot;system-role-sidebar&quot;&gt;</span><br><span class="line">    &lt;router-link to=&quot;/system/role&quot;&gt;</span><br><span class="line">      &lt;i class=&quot;menu-icon fa fa-caret-right&quot;&gt;&lt;/i&gt;</span><br><span class="line">      角色管理</span><br><span class="line">    &lt;/router-link&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>最后修改router.js</p>
</li>
<li><p>&#96;&#96;&#96;js<br>,{<br>path: “system&#x2F;role”,<br>name:”system&#x2F;role”,<br>component: Role,<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 另外我们把resource.js补全</span><br><span class="line"></span><br><span class="line">- ```js</span><br><span class="line">  [&#123;</span><br><span class="line">      &quot;id&quot;: &quot;01&quot;,&quot;name&quot;: &quot;系统管理&quot;,</span><br><span class="line">      &quot;children&quot;:[&#123;</span><br><span class="line">        &quot;id&quot;:&quot;0101&quot;,&quot;name&quot;:&quot;用户管理&quot;,&quot;page&quot;:&quot;/system/user&quot;,</span><br><span class="line">        &quot;children&quot;:[</span><br><span class="line">          &#123;&quot;id&quot;:&quot;010101&quot;,&quot;name&quot;:&quot;保存&quot;,&quot;request&quot;:[&quot;/system/admin/user/list&quot;,&quot;/system/admin/user/save&quot;]&#125;,</span><br><span class="line">          &#123;&quot;id&quot;:&quot;010102&quot;,&quot;name&quot;:&quot;删除&quot;,&quot;request&quot;:[&quot;/system/admin/user/delete&quot;]&#125;,</span><br><span class="line">          &#123;&quot;id&quot;:&quot;010103&quot;,&quot;name&quot;:&quot;重置密码&quot;,&quot;request&quot;:[&quot;/system/admin/user/save-password&quot;]&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;id&quot;:&quot;0102&quot;,&quot;name&quot;:&quot;资源管理&quot;,&quot;page&quot;:&quot;/system/resource&quot;,</span><br><span class="line">        &quot;children&quot;:[</span><br><span class="line">          &#123;&quot;id&quot;:&quot;010201&quot;,&quot;name&quot;:&quot;保存/显示&quot;,&quot;request&quot;:[&quot;/system/admin/resource&quot;]&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">          &quot;id&quot;:&quot;0103&quot;,&quot;name&quot;:&quot;角色管理&quot;,&quot;page&quot;:&quot;/system/role&quot;,</span><br><span class="line">          &quot;children&quot;:[</span><br><span class="line">              &#123;&quot;id&quot;:&quot;010301&quot;,&quot;name&quot;:&quot;角色/权限管理&quot;,&quot;request&quot;:[&quot;/system/admin/role&quot;]&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;]</span><br><span class="line">  &#125;,&#123;</span><br><span class="line">    &quot;id&quot;: &quot;02&quot;,&quot;name&quot;: &quot;业务管理&quot;,</span><br><span class="line">    &quot;children&quot;:[&#123;</span><br><span class="line">      &quot;id&quot;:&quot;0201&quot;,&quot;name&quot;:&quot;分类管理&quot;,&quot;page&quot;:&quot;/business/category&quot;,</span><br><span class="line">      &quot;children&quot;:[</span><br><span class="line">        &#123;&quot;id&quot;:&quot;020101&quot;,&quot;name&quot;:&quot;增删改查&quot;,&quot;request&quot;:[&quot;/business/admin/category&quot;]&#125;</span><br><span class="line">       ]</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        &quot;id&quot;:&quot;0202&quot;,&quot;name&quot;:&quot;课程管理&quot;,&quot;page&quot;:&quot;/business/course&quot;,</span><br><span class="line">        &quot;children&quot;:[</span><br><span class="line">          &#123;&quot;id&quot;:&quot;020201&quot;,&quot;name&quot;:&quot;增删改查&quot;,&quot;request&quot;:[&quot;/business/admin/course&quot;,&quot;/business/admin/category/all&quot;]&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,&#123;</span><br><span class="line">        &quot;id&quot;:&quot;0203&quot;,&quot;name&quot;:&quot;讲师管理&quot;,&quot;page&quot;:&quot;/business/teacher&quot;,</span><br><span class="line">        &quot;children&quot;:[</span><br><span class="line">          &#123;&quot;id&quot;:&quot;020301&quot;,&quot;name&quot;:&quot;增删改查&quot;,&quot;request&quot;:[&quot;/business/admin/teacher&quot;]&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">    &quot;id&quot;: &quot;03&quot;,&quot;name&quot;: &quot;文件管理&quot;,</span><br><span class="line">    &quot;children&quot;:[&#123;</span><br><span class="line">      &quot;id&quot;:&quot;0301&quot;,&quot;name&quot;:&quot;文件管理&quot;,&quot;page&quot;:&quot;/file/file&quot;,</span><br><span class="line">      &quot;children&quot;:[</span><br><span class="line">        &#123;&quot;id&quot;:&quot;030101&quot;,&quot;name&quot;:&quot;文件管理&quot;,&quot;request&quot;:[&quot;/file/admin/file&quot;]&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;]</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>增加角色资源关联功能</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：增加角色资源关联表，生成持久层和服务端代码</span><br></pre></td></tr></table></figure>

<ul>
<li><p>首先添加sql,然后mybatis和server代码生成器，界面就用role的</p>
</li>
<li><p>&#96;&#96;&#96;sql</p>
<h1 id="角色-资源关联表"><a href="#角色-资源关联表" class="headerlink" title="角色-资源关联表"></a>角色-资源关联表</h1><p>drop table if exists <code>role_resource</code>;<br>create table <code>role_resource</code>(<br>                   <code>id</code> char(8) not null default ‘’ comment ‘id’,<br>                   <code>role_id</code> char(8) not null  comment ‘角色|id’,<br>                   <code>resource_id</code> char(6) not null  comment ‘资源|id’,<br>                   primary key (<code>id</code>)<br>)engine &#x3D;innodb default charset&#x3D;utf8mb4 comment&#x3D;’角色资源关联’;</p>
<p>insert into <code>role_resource</code> values (‘00000000’,’00000000’,’01’);<br>insert into <code>role_resource</code> values (‘00000001’,’00000000’,’0101’);<br>insert into <code>role_resource</code> values (‘00000002’,’00000000’,’010101’);<br>insert into <code>role_resource</code> values (‘00000003’,’00000000’,’010102’);<br>insert into <code>role_resource</code> values (‘00000004’,’00000000’,’010103’);<br>insert into <code>role_resource</code> values (‘00000005’,’00000000’,’0102’);<br>insert into <code>role_resource</code> values (‘00000006’,’00000000’,’010201’);<br>insert into <code>role_resource</code> values (‘00000007’,’00000000’,’0103’);<br>insert into <code>role_resource</code> values (‘00000008’,’00000000’,’010301’);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2.通用权限管理：点击【关联资源】按钮时，加载资源树</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 显示图片如下所示![image-20220324150010236](https://s2.loli.net/2022/03/24/nvjwr5k9myh7LNQ.png)</span><br><span class="line"></span><br><span class="line">- 我们只修改role就行</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  //在操作那加一个按钮</span><br><span class="line">  &lt;button v-on:click=&quot;editResource(role)&quot; class=&quot;btn btn-xs btn-info&quot;&gt;</span><br><span class="line">    &lt;i class=&quot;ace-icon fa fa-list bigger-120&quot;&gt;&lt;/i&gt;</span><br><span class="line">  &lt;/button&gt;</span><br><span class="line">  //增加一个模态框</span><br><span class="line">  &lt;!-- 角色资源关联配置 --&gt;</span><br><span class="line">      &lt;div id=&quot;resource-modal&quot; class=&quot;modal fade&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;</span><br><span class="line">          &lt;div class=&quot;modal-content&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">              &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;</span><br><span class="line">              &lt;h4 class=&quot;modal-title&quot;&gt;角色资源关联配置&lt;/h4&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">              &lt;ul id=&quot;tree&quot; class=&quot;ztree&quot;&gt;&lt;/ul&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;modal-footer&quot;&gt;</span><br><span class="line">              &lt;button type=&quot;button&quot; class=&quot;btn btn-white btn-default btn-round&quot; data-dismiss=&quot;modal&quot;&gt;</span><br><span class="line">                &lt;i class=&quot;ace-icon fa fa-times&quot;&gt;&lt;/i&gt;</span><br><span class="line">                关闭</span><br><span class="line">              &lt;/button&gt;</span><br><span class="line">              &lt;button type=&quot;button&quot; class=&quot;btn btn-white btn-info btn-round&quot; v-on:click=&quot;saveResource()&quot;&gt;</span><br><span class="line">                &lt;i class=&quot;ace-icon fa fa-plus blue&quot;&gt;&lt;/i&gt;</span><br><span class="line">                保存</span><br><span class="line">              &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;&lt;!-- /.modal-content --&gt;</span><br><span class="line">        &lt;/div&gt;&lt;!-- /.modal-dialog --&gt;</span><br><span class="line">      &lt;/div&gt;&lt;!-- /.modal --&gt;</span><br><span class="line">  //在data中加两个对象</span><br><span class="line">      resource:[],</span><br><span class="line">        zTree:&#123;&#125;,</span><br><span class="line">  //增加这几个方法</span><br><span class="line">  /**</span><br><span class="line">       * 点击【编辑】</span><br><span class="line">       */</span><br><span class="line">      editResource(role) &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        _this.role = $.extend(&#123;&#125;, role);</span><br><span class="line">        _this.loadResource();</span><br><span class="line">        $(&quot;#resource-modal&quot;).modal(&quot;show&quot;);</span><br><span class="line">      &#125;,</span><br><span class="line">  </span><br><span class="line">      /**</span><br><span class="line">       * 加载资源树</span><br><span class="line">       */</span><br><span class="line">      loadResource() &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        Loading.show();</span><br><span class="line">        _this.$ajax.get(process.env.VUE_APP_SERVER + &#x27;/system/admin/resource/load-tree&#x27;).then((res)=&gt;&#123;</span><br><span class="line">          Loading.hide();</span><br><span class="line">          let response = res.data;</span><br><span class="line">          _this.resources = response.content;</span><br><span class="line">          // 初始化树</span><br><span class="line">          _this.initTree();</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">  </span><br><span class="line">      /**</span><br><span class="line">       * 初始资源树</span><br><span class="line">       */</span><br><span class="line">      initTree() &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        let setting = &#123;</span><br><span class="line">          check: &#123;</span><br><span class="line">            enable: true</span><br><span class="line">          &#125;,</span><br><span class="line">          data: &#123;</span><br><span class="line">            simpleData: &#123;</span><br><span class="line">              idKey: &quot;id&quot;,</span><br><span class="line">              pIdKey: &quot;parent&quot;,</span><br><span class="line">              rootPId: &quot;&quot;,</span><br><span class="line">              enable: true</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">  </span><br><span class="line">        _this.zTree = $.fn.zTree.init($(&quot;#tree&quot;), setting, _this.resources);</span><br><span class="line">        _this.zTree.expandAll(true);</span><br><span class="line">      &#125;,</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3.通用权限管理：点击资源树模态框【保存】按钮时，保存角色资源关联表</span><br></pre></td></tr></table></figure>

<ul>
<li><p>增加一个保存功能<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../../../AppData/Roaming/Typora/typora-user-images/image-20220324151335505.png"
                      alt="image-20220324151335505"
                ></p>
</li>
<li><p>现在role.vue中添加保存方法</p>
</li>
<li><pre><code>/**
 * 资源模态框点击【保存】
 */
saveResource() &#123;
  let _this = this;
  let resources = _this.zTree.getCheckedNodes();
  console.log(&quot;勾选的资源：&quot;, resources);

  // 保存时，只需要保存资源id，所以使用id数组进行参数传递
  let resourceIds = [];
  for (let i = 0; i &lt; resources.length; i++) &#123;
    resourceIds.push(resources[i].id);
  &#125;

  _this.$ajax.post(process.env.VUE_APP_SERVER + &#39;/system/admin/role/save-resource&#39;, &#123;
    id: _this.role.id,
    resourceIds: resourceIds
  &#125;).then((response)=&gt;&#123;
    let resp = response.data;
    if (resp.success) &#123;
      Toast.success(&quot;保存成功!&quot;);
    &#125; else &#123;
      Toast.warning(resp.message);
    &#125;
  &#125;);
&#125;,
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 再在roledto增加字段</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  private List&lt;String&gt; resourceIds;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>接下来修改RoleController</p>
</li>
<li><p>&#96;&#96;&#96;Java<br>&#x2F;**</p>
<ul>
<li>保存资源</li>
<li>@param roleDto</li>
</ul>
<p> *&#x2F;<br>@PostMapping(“&#x2F;save-resource”)<br>public ResponseDto saveResource(@RequestBody RoleDto roleDto) {<br>    LOG.info(“保存角色资源关联开始”);<br>    ResponseDto<RoleDto> responseDto &#x3D; new ResponseDto&lt;&gt;();<br>    roleService.saveResource(roleDto);<br>    responseDto.setContent(roleDto);<br>    return responseDto;<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 最后修改RoleService</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  @Resource</span><br><span class="line">  private RoleResourceMapper roleResourceMapper;</span><br><span class="line">   /**</span><br><span class="line">       * 按角色保存资源</span><br><span class="line">       */</span><br><span class="line">      @Transactional</span><br><span class="line">      public void saveResource(RoleDto roleDto) &#123;</span><br><span class="line">          String roleId = roleDto.getId();</span><br><span class="line">          List&lt;String&gt; resourceIds = roleDto.getResourceIds();</span><br><span class="line">          // 清空库中所有的当前角色下的记录</span><br><span class="line">          RoleResourceExample example = new RoleResourceExample();</span><br><span class="line">          example.createCriteria().andRoleIdEqualTo(roleId);</span><br><span class="line">          roleResourceMapper.deleteByExample(example);</span><br><span class="line">  </span><br><span class="line">          // 保存角色资源</span><br><span class="line">          for (int i = 0; i &lt; resourceIds.size(); i++) &#123;</span><br><span class="line">              RoleResource roleResource = new RoleResource();</span><br><span class="line">              roleResource.setId(UuidUtil.getShortUuid());</span><br><span class="line">              roleResource.setRoleId(roleId);</span><br><span class="line">              roleResource.setResourceId(resourceIds.get(i));</span><br><span class="line">              roleResourceMapper.insert(roleResource);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4.通用权限管理：打开资源树模态框时，加载角色资源关联数据，并自动勾选树节点</span><br></pre></td></tr></table></figure>

<ul>
<li><p>批量操作的思路：先将原有的删除，再批量新增</p>
</li>
<li><p>首先修改role.vue</p>
</li>
<li><pre><code class="vue">//在loadResource方法初始化树后加载资源
// 初始化树
_this.initTree();
_this.listRoleResource();

/**
     * 加载角色资源关联记录
     */
    listRoleResource() &#123;
      let _this = this;
      _this.$ajax.get(process.env.VUE_APP_SERVER + &#39;/system/admin/role/list-resource/&#39; + _this.role.id).then((response)=&gt;&#123;
        let resp = response.data;
        let resources = resp.content;

        // 勾选查询到的资源：先把树的所有节点清空勾选，再勾选查询到的节点
        _this.zTree.checkAllNodes(false);
        for (let i = 0; i &lt; resources.length; i++) &#123;
          let node = _this.zTree.getNodeByParam(&quot;id&quot;, resources[i]);
          _this.zTree.checkNode(node, true);
        &#125;
      &#125;);
    &#125;,
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 接下来在RoleController</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  /**</span><br><span class="line">   * 加载已关联的资源</span><br><span class="line">   */</span><br><span class="line">  @GetMapping(&quot;/list-resource/&#123;roleId&#125;&quot;)</span><br><span class="line">  public ResponseDto listResource(@PathVariable String roleId) &#123;</span><br><span class="line">      LOG.info(&quot;加载资源开始&quot;);</span><br><span class="line">      ResponseDto responseDto = new ResponseDto&lt;&gt;();</span><br><span class="line">      List&lt;String&gt; resourceIdList = roleService.listResource(roleId);</span><br><span class="line">      responseDto.setContent(resourceIdList);</span><br><span class="line">      return responseDto;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>最后在RoleService</p>
</li>
<li><p>&#96;&#96;&#96;java<br>&#x2F;**</p>
<ul>
<li>按角色加载资源</li>
<li>@param roleId</li>
</ul>
<p> *&#x2F;<br>public List<String> listResource(String roleId) {<br>    RoleResourceExample example &#x3D; new RoleResourceExample();<br>    example.createCriteria().andRoleIdEqualTo(roleId);<br>    List<RoleResource> roleResourceList &#x3D; roleResourceMapper.selectByExample(example);<br>    List<String> resourceIdList &#x3D; new ArrayList&lt;&gt;();<br>    for (int i &#x3D; 0, l &#x3D; roleResourceList.size(); i &lt; l; i++) {<br>        resourceIdList.add(roleResourceList.get(i).getResourceId());<br>    }<br>    return resourceIdList;<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**增加角色用户关联功能**</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>1.通用权限管理：增加角色用户关联表，生成持久层和服务端代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 首先建立sql，然后代码生成器</span><br><span class="line"></span><br><span class="line">- ```sql</span><br><span class="line">  # 角色-用户关联表</span><br><span class="line">  drop table if exists `role_user`;</span><br><span class="line">  create table `role_user`(</span><br><span class="line">                                  `id` char(8) not null default &#x27;&#x27; comment &#x27;id&#x27;,</span><br><span class="line">                                  `role_id` char(8) not null  comment &#x27;角色|id&#x27;,</span><br><span class="line">                                  `user_id` char(8) not null  comment &#x27;用户|id&#x27;,</span><br><span class="line">                                  primary key (`id`)</span><br><span class="line">  )engine =innodb default charset=utf8mb4 comment=&#x27;角色用户关联&#x27;;</span><br><span class="line">  </span><br><span class="line">  insert into `role_user` values (&#x27;00000000&#x27;,&#x27;00000000&#x27;,&#x27;10000000&#x27;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2.通用权限管理：点击【关联用户】按钮时，加载所有用户</span><br></pre></td></tr></table></figure>

<ul>
<li><p>加一个按钮显示这样的界面<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/24/SXptR8sDVfA1rQ9.png"
                      alt="image-20220324171309337"
                ></p>
</li>
<li><p>只需要修改role.vue</p>
</li>
<li><p>&#96;&#96;&#96;vue<br>&#x2F;&#x2F;增加用户按钮</p>
<button v-on:click="editUser(role)" class="btn btn-xs btn-info">
  <i class="ace-icon fa fa-user bigger-120"></i>
</button>
//增加一个模态框
 <!-- 角色用户关联配置 -->
    <div id="user-modal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">角色用户关联配置</h4>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <table id="user-table" class="table table-hover">
                  <tbody>
                  <tr v-for="user in users">
                    <td></td>
                    <td class="text-right">
                      <a  href="javascript:;" class="">
                        <i class="ace-icon fa fa-arrow-circle-right blue"></i>
                      </a>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
              <div class="col-md-6">
                <table id="role-user-table" class="table table-hover">
                  <tbody>
                  <tr v-for="user in roleUsers">
                    <td></td>
                    <td class="text-right">
                      <a v-on:click="deleteUser(user)" href="javascript:;" class="">
                        <i class="ace-icon fa fa-trash blue"></i>
                      </a>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-white btn-default btn-round" data-dismiss="modal">
              <i class="ace-icon fa fa-times"></i>
              关闭
            </button>
            <button type="button" class="btn btn-white btn-info btn-round" v-on:click="saveUser()">
              <i class="ace-icon fa fa-plus blue"></i>
              保存
            </button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
//data中增加
users:[],
roleUsers:[]

<p>&#x2F;**<br> * 点击【用户】<br> <em>&#x2F;<br>editUser(role) {<br>  let _this &#x3D; this;<br>  _this.role &#x3D; $.extend({}, role);<br>  _this.listUser();<br>  $(“#user-modal”).modal(“show”);<br>},<br><br>&#x2F;</em>*<br> * 查询所有用户<br> *&#x2F;<br>listUser() {<br>  let _this &#x3D; this;<br>  _this.$ajax.post(process.env.VUE_APP_SERVER + ‘&#x2F;system&#x2F;admin&#x2F;user&#x2F;list’, {<br>    page: 1,<br>    size: 9999<br>  }).then((response)&#x3D;&gt;{<br>    let resp &#x3D; response.data;<br>    if (resp.success) {<br>      _this.users &#x3D; resp.content.list;<br>      console.log(_this.users);<br>    } else {<br>      Toast.warning(resp.message);<br>    }<br>  })<br>},</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3.通用权限管理：点击用户模态框【保存】按钮时，保存角色用户关联表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 增加一个这样的功能![image-20220324173001257](../../../AppData/Roaming/Typora/typora-user-images/image-20220324173001257.png)</span><br><span class="line"></span><br><span class="line">- 依赖vue的双向数据绑定特性，可以将复杂的页面操作变成，简单的数据操作。很多前端框架都有双向数据绑定的特性，比如angular，微信小程序</span><br><span class="line"></span><br><span class="line">- 先修改role.vue</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  //分别修改右边和左边的模态框</span><br><span class="line">  &lt;a v-on:click=&quot;addUser(user)&quot; href=&quot;javascript:;&quot; class=&quot;&quot;&gt;</span><br><span class="line">  &lt;a v-on:click=&quot;deleteUser(user)&quot; href=&quot;javascript:;&quot; class=&quot;&quot;&gt;</span><br><span class="line">  //增加对应方法，最后一个方法是保存时候的</span><br><span class="line">   /**</span><br><span class="line">       * 角色中增加用户</span><br><span class="line">       */</span><br><span class="line">      addUser(user) &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">  </span><br><span class="line">        // 如果当前要添加的用户在右边列表中已经有了，则不用再添加</span><br><span class="line">        let users = _this.roleUsers;</span><br><span class="line">        for (let i = 0; i &lt; users.length; i++) &#123;</span><br><span class="line">          if (user === users[i]) &#123;</span><br><span class="line">            return;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        _this.roleUsers.push(user);</span><br><span class="line">      &#125;,</span><br><span class="line">      /**</span><br><span class="line">       * 角色中删除用户</span><br><span class="line">       */</span><br><span class="line">      deleteUser(user) &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        Tool.removeObj(_this.roleUsers, user);</span><br><span class="line">      &#125;,</span><br><span class="line">      /**</span><br><span class="line">       * 角色用户模态框点击【保存】</span><br><span class="line">       */</span><br><span class="line">      saveUser() &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        let users = _this.roleUsers;</span><br><span class="line">  </span><br><span class="line">        // 保存时，只需要保存用户id，所以使用id数组进行参数传递</span><br><span class="line">        let userIds = [];</span><br><span class="line">        for (let i = 0; i &lt; users.length; i++) &#123;</span><br><span class="line">          userIds.push(users[i].id);</span><br><span class="line">        &#125;</span><br><span class="line">        _this.$ajax.post(process.env.VUE_APP_SERVER + &#x27;/system/admin/role/save-user&#x27;, &#123;</span><br><span class="line">          id: _this.role.id,</span><br><span class="line">          userIds: userIds</span><br><span class="line">        &#125;).then((response)=&gt;&#123;</span><br><span class="line">          console.log(&quot;保存角色用户结果：&quot;, response);</span><br><span class="line">          let resp = response.data;</span><br><span class="line">          if (resp.success) &#123;</span><br><span class="line">            Toast.success(&quot;保存成功!&quot;);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            Toast.warning(resp.message);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li><p>我们接下来要修改RoleDto</p>
</li>
<li><pre><code class="java">//增加这个
private List&lt;String&gt; userIds;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 接下来RoleController</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  /**</span><br><span class="line">   * 保存用户</span><br><span class="line">   * @param roleDto</span><br><span class="line">   */</span><br><span class="line">  @PostMapping(&quot;/save-user&quot;)</span><br><span class="line">  public ResponseDto saveUser(@RequestBody RoleDto roleDto) &#123;</span><br><span class="line">      LOG.info(&quot;保存角色用户关联开始&quot;);</span><br><span class="line">      ResponseDto&lt;RoleDto&gt; responseDto = new ResponseDto&lt;&gt;();</span><br><span class="line">      roleService.saveUser(roleDto);</span><br><span class="line">      responseDto.setContent(roleDto);</span><br><span class="line">      return responseDto;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>最后修改RoleService</p>
</li>
<li><p>&#96;&#96;&#96;java<br>@Resource<br>private RoleUserMapper roleUserMapper;<br> &#x2F;**<br> * 按角色保存用户<br> *&#x2F;<br>public void saveUser(RoleDto roleDto) {<br>    String roleId &#x3D; roleDto.getId();<br>    List<String> userIdList &#x3D; roleDto.getUserIds();<br>    &#x2F;&#x2F; 清空库中所有的当前角色下的记录<br>    RoleUserExample example &#x3D; new RoleUserExample();<br>    example.createCriteria().andRoleIdEqualTo(roleId);<br>    roleUserMapper.deleteByExample(example);<br><br>    &#x2F;&#x2F; 保存角色用户<br>    for (int i &#x3D; 0; i &lt; userIdList.size(); i++) {<br>        RoleUser roleUser &#x3D; new RoleUser();<br>        roleUser.setId(UuidUtil.getShortUuid());<br>        roleUser.setRoleId(roleId);<br>        roleUser.setUserId(userIdList.get(i));<br>        roleUserMapper.insert(roleUser);<br>    }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>4.通用权限管理：打开用户模态框时，加载角色用户关联数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 查关联表，得到的是userld，但是显示需要的是loginName。这里也可以通过写自定义mapper，把user表和role_user表关联得到loginName</span><br><span class="line"></span><br><span class="line">- 首先修改role.vue</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  //在listUser中成功时添加</span><br><span class="line">   _this.listRoleUser();</span><br><span class="line">   /**</span><br><span class="line">       * 加载角色用户</span><br><span class="line">       */</span><br><span class="line">      listRoleUser() &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        _this.roleUsers = [];</span><br><span class="line">        _this.$ajax.get(process.env.VUE_APP_SERVER + &#x27;/system/admin/role/list-user/&#x27; + _this.role.id).then((res)=&gt;&#123;</span><br><span class="line">          let response = res.data;</span><br><span class="line">          let userIds = response.content;</span><br><span class="line">  </span><br><span class="line">          // 根据加载到用户ID，到【所有用户数组：users】中查找用户对象，用于列表显示</span><br><span class="line">          for (let i = 0; i &lt; userIds.length; i++) &#123;</span><br><span class="line">            for (let j = 0; j &lt; _this.users.length; j++) &#123;</span><br><span class="line">              if (userIds[i] === _this.users[j].id) &#123;</span><br><span class="line">                _this.roleUsers.push(_this.users[j]);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li><p>然后修改RoleController</p>
</li>
<li><p>&#96;&#96;&#96;java<br>&#x2F;**</p>
<ul>
<li>加载用户</li>
<li>@param roleId</li>
</ul>
<p> *&#x2F;<br>@GetMapping(“&#x2F;list-user&#x2F;{roleId}”)<br>public ResponseDto listUser(@PathVariable String roleId) {<br>    LOG.info(“加载用户开始”);<br>    ResponseDto responseDto &#x3D; new ResponseDto&lt;&gt;();<br>    List<String> userIdList &#x3D; roleService.listUser(roleId);<br>    responseDto.setContent(userIdList);<br>    return responseDto;<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 最后修改RoleService</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  /**</span><br><span class="line">   * 按角色加载用户</span><br><span class="line">   * @param roleId</span><br><span class="line">   */</span><br><span class="line">  public List&lt;String&gt; listUser(String roleId) &#123;</span><br><span class="line">      RoleUserExample example = new RoleUserExample();</span><br><span class="line">      example.createCriteria().andRoleIdEqualTo(roleId);</span><br><span class="line">      List&lt;RoleUser&gt; roleUserList = roleUserMapper.selectByExample(example);</span><br><span class="line">      List&lt;String&gt; userIdList = new ArrayList&lt;&gt;();</span><br><span class="line">      for (int i = 0, l = roleUserList.size(); i &lt; l; i++) &#123;</span><br><span class="line">          userIdList.add(roleUserList.get(i).getUserId());</span><br><span class="line">      &#125;</span><br><span class="line">      return userIdList;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="12-4-登录时获取资源权限"><a href="#12-4-登录时获取资源权限" class="headerlink" title="12-4 登录时获取资源权限"></a>12-4 登录时获取资源权限</h2><p><strong>读取当前登录用户所属的角色的所有资源</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：登录时，读取当前登录用户所属的角色的所有资源</span><br></pre></td></tr></table></figure>

<ul>
<li><p>一个资源可以会用到多个接口，多个资源的接口就可能重复，所以这里用Set去重</p>
</li>
<li><p>在LoginUserDto中增加</p>
</li>
<li><pre><code>/**
 * 所有资源用于前端界面控制
 */
private List&lt;ResourceDto&gt; resources;
/**
 * 所有资源中的请求，用于后端接口拦截
 */
private HashSet&lt;String&gt; requests;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 关于User的权限设置比较细，每个请求接口都可以单独控制。关于Resource的权限设置比较粗，所有接口用同一个request控制</span><br><span class="line"></span><br><span class="line">- 在com.course.server.mapper.my下建立MyUserMapper.xml</span><br><span class="line"></span><br><span class="line">- ```xml</span><br><span class="line">  &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">  &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;</span><br><span class="line">  &lt;mapper namespace=&quot;com.course.server.mapper.my.MyUserMapper&quot; &gt;</span><br><span class="line">  </span><br><span class="line">      &lt;!-- 一个用户可以属于多个角色，配置的资源可能重复，所以用distinct去重 --&gt;</span><br><span class="line">      &lt;select id=&quot;findResources&quot; resultType=&quot;com.course.server.dto.ResourceDto&quot;&gt;</span><br><span class="line">          select distinct r.id, r.`name`, r.page, r.request, r.parent</span><br><span class="line">          from role_user ru, role_resource rr, resource r</span><br><span class="line">          where ru.user_id = #&#123;userId&#125;</span><br><span class="line">          and ru.role_id = rr.role_id</span><br><span class="line">          and rr.resource_id = r.id</span><br><span class="line">          order by r.id asc</span><br><span class="line">      &lt;/select&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>然后再com.course.server.mapper.my下建立MyUserMapper.java</p>
</li>
<li><p>&#96;&#96;&#96;java<br>package com.course.server.mapper.my;</p>
<p>import com.course.server.dto.ResourceDto;<br>import org.apache.ibatis.annotations.Param;</p>
<p>import java.util.List;</p>
<p>public interface MyUserMapper {</p>
<pre><code>List&lt;ResourceDto&gt; findResources(@Param(&quot;userId&quot;) String userId);
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 最后我们修改UserService</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  /**</span><br><span class="line">   * 为登录用户读取权限</span><br><span class="line">   */</span><br><span class="line">  private void setAuth(LoginUserDto loginUserDto) &#123;</span><br><span class="line">      List&lt;ResourceDto&gt; resourceDtoList = myUserMapper.findResources(loginUserDto.getId());</span><br><span class="line">      loginUserDto.setResources(resourceDtoList);</span><br><span class="line">  </span><br><span class="line">      // 整理所有有权限的请求，用于接口拦截</span><br><span class="line">      HashSet&lt;String&gt; requestSet = new HashSet&lt;&gt;();</span><br><span class="line">      if (!CollectionUtils.isEmpty(resourceDtoList)) &#123;</span><br><span class="line">          for (int i = 0, l = resourceDtoList.size(); i &lt; l; i++) &#123;</span><br><span class="line">              ResourceDto resourceDto = resourceDtoList.get(i);</span><br><span class="line">              String arrayString = resourceDto.getRequest();</span><br><span class="line">              List&lt;String&gt; requestList = JSON.parseArray(arrayString, String.class);</span><br><span class="line">              if (!CollectionUtils.isEmpty(requestList)) &#123;</span><br><span class="line">                  requestSet.addAll(requestList);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      LOG.info(&quot;有权限的请求：&#123;&#125;&quot;, requestSet);</span><br><span class="line">      loginUserDto.setRequests(requestSet);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  //最后使用这个在login方法</span><br><span class="line">      public LoginUserDto login(UserDto userDto)&#123;</span><br><span class="line">          User user = selectByLoginName((userDto.getLoginName()));</span><br><span class="line">          if(user == null)&#123;</span><br><span class="line">              LOG.info(&quot;用户名不存在,&#123;&#125;&quot;,userDto.getLoginName());</span><br><span class="line">              throw new BusinessException(BusinessExceptionCode.LOGIN_ERROR);</span><br><span class="line">          &#125;else&#123;</span><br><span class="line">              if (user.getPassword().equals(userDto.getPassword()))&#123;</span><br><span class="line">  ////////////////////////////////////////////////////////////////////</span><br><span class="line">                  //登陆成功</span><br><span class="line">                  LoginUserDto loginUserDto = CopyUtil.copy(user,LoginUserDto.class);</span><br><span class="line">                  //为登录用户获取权限</span><br><span class="line">                  setAuth(loginUserDto);</span><br><span class="line">                  return loginUserDto;</span><br><span class="line">  ///////////////////////////////////////////////////////////////////////////</span><br><span class="line">              &#125;else&#123;</span><br><span class="line">                  LOG.info(&quot;密码不对,输入密码:&#123;&#125;,数据库密码:&#123;&#125;&quot;,userDto.getPassword(),user.getPassword());</span><br><span class="line">                  throw new BusinessException(BusinessExceptionCode.LOGIN_ERROR);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>修复讲师管理显示错位的BUG</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：修复讲师管理显示错位的BUG.自定义样式要加上前缀，防止冲突，vue组件样式加scoped</span><br></pre></td></tr></table></figure>

<ul>
<li>问题：讲师管理页面，讲师的显示重叠在一起了。但是这个页面已经很久没动过了。之前介绍讲师管理时，都是确认了页面正常才提交的代码。不知道从什么时候开始出现这个BUG？</li>
<li>css样式的问题，可以优先用F12开发者工具来查看没有可疑的样式</li>
<li>前端常见问题：引入新的css文件后，导致原有页面显示错乱</li>
<li>写自定义样式的时候！不要用通用的单词，很容易和别人的样式出现冲突，可以给样式加上一些固定的，有意义的前缀</li>
<li>解决方法：为每个样式加一个“aliplayer前缀！或者加一个顶级的”.aliplayer”样式</li>
</ul>
<h2 id="12-5-权限拦截功能开发"><a href="#12-5-权限拦截功能开发" class="headerlink" title="12-5 权限拦截功能开发"></a>12-5 权限拦截功能开发</h2><p><strong>前端界面权限拦截</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：前端界面权限拦截，完成用户管理</span><br></pre></td></tr></table></figure>

<ul>
<li><p>目前只修改了用户管理的权限拦截，以用户管理为例</p>
</li>
<li><p>每次修改权限配置，需要重新登录后才生效</p>
</li>
<li><p>我们首先在tool.js增加方法</p>
</li>
<li><pre><code class="js"> /**
   * 查找是否有权限
   * @param id 资源id
   */
  hasResource: function (id) &#123;
    let _this = this;
    let resources = _this.getLoginUser().resources;
    if (_this.isEmpty(resources)) &#123;
      return false;
    &#125;
    for (let i = 0; i &lt; resources.length; i++) &#123;
      if (id === resources[i].id) &#123;
        return true;
      &#125;
    &#125;
    return false;
  &#125;
&#125;;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 接下来修改admin</span><br><span class="line"></span><br><span class="line">- ```vue</span><br><span class="line">  //在html中要使用vue方法，这个方法得在methods中定义</span><br><span class="line">  /**</span><br><span class="line">   * 查找是否有权限</span><br><span class="line">   * @param id</span><br><span class="line">   */</span><br><span class="line">  hasResource(id) &#123;</span><br><span class="line">    return Tool.hasResource(id);</span><br><span class="line">  &#125;,</span><br><span class="line">  //使用的话就在li里加v-show</span><br><span class="line">   &lt;li v-show=&quot;hasResource(&#x27;0101&#x27;)&quot; class=&quot;&quot; id=&quot;system-user-sidebar&quot;&gt;</span><br><span class="line">                 &lt;router-link to=&quot;/system/user&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;menu-icon fa fa-caret-right&quot;&gt;&lt;/i&gt;</span><br><span class="line">                    用户管理</span><br><span class="line">                 &lt;/router-link&gt;</span><br><span class="line">  </span><br><span class="line">                  &lt;b class=&quot;arrow&quot;&gt;&lt;/b&gt;</span><br><span class="line">                &lt;/li&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>user修改也一样</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2.通用权限管理：前端界面权限拦截，完成所有界面控制</span><br></pre></td></tr></table></figure>

<ul>
<li>如果一个页面的所有按钮是统一控制的那么只需要控制菜单就可以了，不需要给每个按钮加权限控制代码</li>
<li>就是给admin其他菜单加上v-show</li>
</ul>
<p><strong>路由权限判断</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：前端界面权限拦截，增加路由权限判断</span><br></pre></td></tr></table></figure>

<ul>
<li><p>因为我们前端的路由是不带&#x2F;的所以我们修改resource.json</p>
</li>
<li><p>&#96;&#96;&#96;json<br>[{<br>  “id”: “00”,”name”: “欢迎”,”page”: “welcome”<br>},<br>  {<br>“id”: “01”,”name”: “系统管理”,<br>“children”:[{<br>  “id”:”0101”,”name”:”用户管理”,”page”:”system&#x2F;user”,<br>  “children”:[<br>    {“id”:”010101”,”name”:”保存”,”request”:[“&#x2F;system&#x2F;admin&#x2F;user&#x2F;list”,”&#x2F;system&#x2F;admin&#x2F;user&#x2F;save”]},<br>    {“id”:”010102”,”name”:”删除”,”request”:[“&#x2F;system&#x2F;admin&#x2F;user&#x2F;delete”]},<br>    {“id”:”010103”,”name”:”重置密码”,”request”:[“&#x2F;system&#x2F;admin&#x2F;user&#x2F;save-password”]}<br>  ]<br>},<br>{<br>  “id”:”0102”,”name”:”资源管理”,”page”:”system&#x2F;resource”,<br>  “children”:[<br>    {“id”:”010201”,”name”:”保存&#x2F;显示”,”request”:[“&#x2F;system&#x2F;admin&#x2F;resource”]}<br>  ]<br>}, {<br>    “id”:”0103”,”name”:”角色管理”,”page”:”system&#x2F;role”,<br>    “children”:[<br>        {“id”:”010301”,”name”:”角色&#x2F;权限管理”,”request”:[“&#x2F;system&#x2F;admin&#x2F;role”]}<br>      ]<br>  }]<br>},{<br>  “id”: “02”,”name”: “业务管理”,<br>  “children”:[{<br>“id”:”0201”,”name”:”分类管理”,”page”:”business&#x2F;category”,<br>“children”:[<br>  {“id”:”020101”,”name”:”增删改查”,”request”:[“&#x2F;business&#x2F;admin&#x2F;category”]}<br> ]<br>  },{<br>  “id”:”0202”,”name”:”课程管理”,”page”:”business&#x2F;course”,<br>  “children”:[<br>    {“id”:”020201”,”name”:”增删改查”,”request”:[“&#x2F;business&#x2F;admin&#x2F;course”,”&#x2F;business&#x2F;admin&#x2F;category&#x2F;all”]}<br>  ]<br>},{<br>  “id”:”0203”,”name”:”讲师管理”,”page”:”business&#x2F;teacher”,<br>  “children”:[<br>    {“id”:”020301”,”name”:”增删改查”,”request”:[“&#x2F;business&#x2F;admin&#x2F;teacher”]}<br>  ]<br>}]<br>  },{<br>  “id”: “03”,”name”: “文件管理”,<br>  “children”:[{<br>“id”:”0301”,”name”:”文件管理”,”page”:”file&#x2F;file”,<br>“children”:[<br>  {“id”:”030101”,”name”:”文件管理”,”request”:[“&#x2F;file&#x2F;admin&#x2F;file”]}<br>]<br>  }]<br>}]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 修改admin</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  /**</span><br><span class="line">   * 查找是否有权限</span><br><span class="line">   * @param router</span><br><span class="line">   */</span><br><span class="line">  hasResourceRouter(router) &#123;</span><br><span class="line">    let _this = this;</span><br><span class="line">    let resources = Tool.getLoginUser().resources;</span><br><span class="line">    if (Tool.isEmpty(resources)) &#123;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">    for (let i = 0; i &lt; resources.length; i++) &#123;</span><br><span class="line">      if (router === resources[i].page) &#123;</span><br><span class="line">        return true;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;,</span><br><span class="line">  //在mounted使用，第一次加载amin.vue时，需要判断路由权限。比如从登录页跳到控台主页，或者刷新控台主页时，会执行mounted</span><br><span class="line">  if (!_this.hasResourceRouter(_this.$route.name)) &#123;</span><br><span class="line">        _this.$router.push(&quot;/login&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">  //进入控台主页后，发生子路由跳转时，会触发watch</span><br><span class="line">   if (!_this.hasResourceRouter(val.name)) &#123;</span><br><span class="line">            _this.$router.push(&quot;/login&quot;);</span><br><span class="line">            return;</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>后端接口权限判断</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：增加后端接口权限拦截</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在做登录功能时，我们也对接口做了登录校验，否则容易被绕开登录，直接调用后端接口。这里同样需要对接口做权限拦截</p>
</li>
<li><p>比如资源的保存：path&#x3D;system&#x2F;admin&#x2F;resource&#x2F;save，而配置的request&#x3D;system&#x2F;admin&#x2F;resource，那么path.contain(request)就是true</p>
</li>
<li><p>可以在vue的拦截器中，针对401返回码做判断，如果是401，就跳到登录页面</p>
</li>
<li><p>我们修改LoginAdminGatewayFilter</p>
</li>
<li><pre><code class="java">//在已登录这进行判断
else&#123;
    LOG.info(&quot;已登录:&#123;&#125;&quot;,object);
    // 增加权限校验，gateway里没有LoginUserDto，所以全部用JSON操作
    LOG.info(&quot;接口权限校验，请求地址：&#123;&#125;&quot;, path);
    boolean exist = false;
    JSONObject loginUserDto = JSON.parseObject(String.valueOf(object));
    redisTemplate.opsForValue().set(token, JSON.toJSONString(loginUserDto), 3600, TimeUnit.SECONDS);
    JSONArray requests = loginUserDto.getJSONArray(&quot;requests&quot;);
    // 遍历所有【权限请求】，判断当前请求的地址是否在【权限请求】里
    for (int i = 0, l = requests.size(); i &lt; l; i++) &#123;
        String request = (String) requests.get(i);
        if (path.contains(request)) &#123;
            exist = true;
            break;
        &#125;
    &#125;
    if (exist) &#123;
        LOG.info(&quot;权限校验通过&quot;);
    &#125; else &#123;
        LOG.warn(&quot;权限校验未通过&quot;);
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        return exchange.getResponse().setComplete();
    &#125;

    return chain.filter(exchange);
&#125;
</code></pre>
</li>
</ul>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post title：Spring Cloud + Vue 前后端分离4-1</li>
        <li>Post author：Fang</li>
        <li>Create time：2022-03-07 09:23:36</li>
        <li>
            Post link：https://ainianxu.github.io/2022/03/07/Spring Cloud + Vue 前后端分离 4-1/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE/">#完整项目</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2022/03/15/Spring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%204-2/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Spring Cloud + Vue 前后端分离4-2</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2022/02/25/Spring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%203-2/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Spring Cloud + Vue 前后端分离3-2</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;Comments</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'loa9BVbgmyFLwBMHhg1Cycx1-gzGzoHsz',
                    appKey: '47pIz6ewIXRi5251WyfUpQOB',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情吐槽吧~',
                    lang: 'en'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Fang';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Fang</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.4</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC11%E7%AB%A0-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E4%B8%8E%E7%99%BB%E5%BD%95"><span class="nav-number">1.</span> <span class="nav-text">第11章 用户管理与登录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-1-%E5%A2%9E%E5%8A%A0%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="nav-number">1.1.</span> <span class="nav-text">11-1 增加用户管理功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-3-%E5%9F%BA%E6%9C%AC%E7%9A%84%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="nav-number">1.2.</span> <span class="nav-text">11-3 基本的登录功能开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-5-%E5%A2%9E%E5%8A%A0%E7%99%BB%E5%BD%95%E5%9B%BE%E5%BD%A2%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="nav-number">1.3.</span> <span class="nav-text">11-5 增加登录图形验证码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-6-%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="nav-number">1.4.</span> <span class="nav-text">11-6 单点登录功能开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-3%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="nav-number">1.5.</span> <span class="nav-text">12-3角色权限管理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%92%E8%89%B2-%E8%B5%84%E6%BA%90%E5%85%B3%E8%81%94%E8%A1%A8"><span class="nav-number">2.</span> <span class="nav-text">角色-资源关联表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#user-modal"><span class="nav-number">2.0.0.1.</span> <span class="nav-text">角色用户关联配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-4-%E7%99%BB%E5%BD%95%E6%97%B6%E8%8E%B7%E5%8F%96%E8%B5%84%E6%BA%90%E6%9D%83%E9%99%90"><span class="nav-number">2.1.</span> <span class="nav-text">12-4 登录时获取资源权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-5-%E6%9D%83%E9%99%90%E6%8B%A6%E6%88%AA%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="nav-number">2.2.</span> <span class="nav-text">12-5 权限拦截功能开发</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/code-copy.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/lazyload.js"></script>


<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/toc.js"></script>
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
