<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>完整项目之Spring Cloud + Vue 前后端分离4-1 | Hexo</title><meta name="keywords" content="完整项目"><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第11章 用户管理与登录本章将演示用户管理及控台登录功能的开发，登录拦截是一个管理控台最基本的权限拦截，防止出现未登录用户直接访问控台界面或接口，同时保障系统内部用户的信息安全，介绍单点登录功能的开发，单点登录SSO（Single Sign On）在大型网站设计中非常常见，用户只需要登录一次就可以访问所有相互信任的应用系统，是提升用户体…  11-1 增加用户管理功能用户表设计与基本代码生成： 1">
<meta property="og:type" content="article">
<meta property="og:title" content="完整项目之Spring Cloud + Vue 前后端分离4-1">
<meta property="og:url" content="http://example.com/2022/03/07/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%204-1/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="第11章 用户管理与登录本章将演示用户管理及控台登录功能的开发，登录拦截是一个管理控台最基本的权限拦截，防止出现未登录用户直接访问控台界面或接口，同时保障系统内部用户的信息安全，介绍单点登录功能的开发，单点登录SSO（Single Sign On）在大型网站设计中非常常见，用户只需要登录一次就可以访问所有相互信任的应用系统，是提升用户体…  11-1 增加用户管理功能用户表设计与基本代码生成： 1">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2022-03-07T01:23:36.000Z">
<meta property="article:modified_time" content="2022-05-11T06:45:42.719Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="完整项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/03/07/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%204-1/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '完整项目之Spring Cloud + Vue 前后端分离4-1',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-11 14:45:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">307</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Hexo</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">完整项目之Spring Cloud + Vue 前后端分离4-1</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-03-07T01:23:36.000Z" title="Created 2022-03-07 09:23:36">2022-03-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-05-11T06:45:42.719Z" title="Updated 2022-05-11 14:45:42">2022-05-11</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="完整项目之Spring Cloud + Vue 前后端分离4-1"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="第11章-用户管理与登录"><a href="#第11章-用户管理与登录" class="headerlink" title="第11章 用户管理与登录"></a>第11章 用户管理与登录</h1><p>本章将演示用户管理及控台登录功能的开发，登录拦截是一个管理控台最基本的权限拦截，防止出现未登录用户直接访问控台界面或接口，同时保障系统内部用户的信息安全，介绍单点登录功能的开发，单点登录SSO（Single Sign On）在大型网站设计中非常常见，用户只需要登录一次就可以访问所有相互信任的应用系统，是提升用户体…</p>
<hr>
<h2 id="11-1-增加用户管理功能"><a href="#11-1-增加用户管理功能" class="headerlink" title="11-1 增加用户管理功能"></a>11-1 增加用户管理功能</h2><p><strong>用户表设计与基本代码生成：</strong></p>
<p>1.用户管理与登录：用户表设计与基本代码生成</p>
<ul>
<li>创建sql</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#用户</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `<span class="keyword">user</span>`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `<span class="keyword">user</span>`(</span><br><span class="line">                  `id` <span class="type">char</span>(<span class="number">8</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">                  `login_name` <span class="type">varchar</span>(<span class="number">50</span>)  <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;登录名&#x27;</span>,</span><br><span class="line">                  `name` <span class="type">varchar</span>(<span class="number">50</span>)  comment <span class="string">&#x27;昵称&#x27;</span>,</span><br><span class="line">                  `password` <span class="type">char</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="keyword">null</span>  comment <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">                  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">                  <span class="keyword">unique</span> key `login_name_unique`(`login_name`)</span><br><span class="line">)engine <span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;用户&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>然后修改前端后端为system，然后就开始代码生成器</p>
</li>
<li><p>最后在admin中修改代码</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;li class=&quot;active&quot; id=&quot;system-user-sidebar&quot;&gt;</span><br><span class="line"> &lt;router-link to=&quot;/system/user&quot;&gt;</span><br><span class="line">    &lt;i class=&quot;menu-icon fa fa-caret-right&quot;&gt;&lt;/i&gt;</span><br><span class="line">    用户管理</span><br><span class="line"> &lt;/router-link&gt;</span><br><span class="line"></span><br><span class="line">  &lt;b class=&quot;arrow&quot;&gt;&lt;/b&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改router，增加路由</li>
</ul>
<p><strong>增加用户名是否已存在校验：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.用户管理与登录：增加用户名是否已存在校验</span><br><span class="line">2.增加自定义业务异常</span><br></pre></td></tr></table></figure>

<ul>
<li><p>登录名是不可编辑的，登录名一般会跟其它表有关联，一旦登录名改了，这些关联信息就没有了。</p>
</li>
<li><p>根据传入登录名到数据库中查找是否有记录，有记录就说明用户名已存在</p>
</li>
<li><p>我们在UserService中增加方法</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据登录名查询用户信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loginName</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">selectByLoginName</span><span class="params">(String loginName)</span> &#123;</span><br><span class="line">    <span class="type">UserExample</span> <span class="variable">userExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserExample</span>();</span><br><span class="line">    userExample.createCriteria().andLoginNameEqualTo(loginName);</span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectByExample(userExample);</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(userList)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userList.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在其insert方法中，增加判断，我们在业务上的逻辑校验，在校验不通过时，使用业务异常（自定义异常）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">userDb</span> <span class="operator">=</span> <span class="built_in">this</span>.selectByLoginName(user.getLoginName());</span><br><span class="line"><span class="keyword">if</span>(userDb != <span class="literal">null</span>)&#123;</span><br><span class="line"> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionCode.USER_LOGIN_NAME_EXIST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>我们在com.course.server.exception增加自定义异常，先写BusinessException，</p>
</li>
<li><p>继承RuntimeException的一个好处就是代码不需要捕获。如果是直接继承Exception，代码需要捕获，否则编译不通过。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.server.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BusinessExceptionCode code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BusinessException</span> <span class="params">(BusinessExceptionCode code)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(code.getDesc());</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BusinessExceptionCode <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(BusinessExceptionCode code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不写入堆栈信息，提高性能，抛出业务异常时，不打印堆栈信息，一方面是提高性能，另一方面是没有业务异常没必要看堆栈信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Throwable <span class="title function_">fillInStackTrace</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>看上面的代码里面有个BusinessExceptionCode，我们也写下文件，它也是个枚举就是没有code了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.server.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">BusinessExceptionCode</span> &#123;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    USER_LOGIN_NAME_EXIST(<span class="string">&quot;登录名已存在&quot;</span>),</span><br><span class="line">     ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    BusinessExceptionCode(String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDesc</span><span class="params">(String desc)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们还要对BusinessException做个全局的捕获，我们复制business里的ControllerExceptionHandler到system的controller下面，进行修改</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.system.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.course.server.dto.ResponseDto;</span><br><span class="line"><span class="keyword">import</span> com.course.server.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ControllerExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(ControllerExceptionHandler.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = BusinessException.class)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResponseDto <span class="title function_">businessExceptionHandler</span><span class="params">(BusinessException e)</span> &#123;</span><br><span class="line">        <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">        responseDto.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        LOG.error(<span class="string">&quot;业务异常：&#123;&#125;&quot;</span>, e.getCode().getDesc());</span><br><span class="line">        responseDto.setMessage(e.getCode().getDesc());</span><br><span class="line">        <span class="keyword">return</span> responseDto;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>下面我们修改user.vue，</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//为了让登录名新增是可以修改，修改时不能进行修改我们增加了disabled</span><br><span class="line">&lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">  &lt;label class=&quot;col-sm-2 control-label&quot;&gt;登录名&lt;/label&gt;</span><br><span class="line">  &lt;div class=&quot;col-sm-10&quot;&gt;</span><br><span class="line">    &lt;input v-model=&quot;user.loginName&quot; v-bind:disabled=&quot;user.id&quot; class=&quot;form-control&quot;&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>以后我们会有很多业务异常使用方法在BusinessExceptionCode增加一种异常枚举；在业务代码中抛出指定枚举类型的业务异常</li>
</ul>
<p><strong>侧边栏激活样式优化</strong></p>
<p>1.用户管理与登录：侧边栏激活样式优化</p>
<ul>
<li><p>现在菜单栏的样式是这样的，我们要做的是当前菜单的父菜单的同级菜单，下面所有的子菜单，清空激活样式</p>
</li>
<li><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/20/Ux4suobOkTcCq1h.png"
                      alt="image-20220320171949483"
                ></p>
</li>
<li><p>只需要在admin的activeSidebar方法，判断是否有父菜单的时候加，然后把原来标签的active都去了</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parentLi.siblings().find(&quot;li&quot;).removeClass(&quot;active&quot;);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>改完之后<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/20/1MZavcFOSzeYmT3.png"
                      alt="image-20220320192232985"
                ></p>
</li>
<li><p>还有一个问题问题：访问根目录时，页面显示的是admin.vue，但是右边的content部分是空的，没有路由到任何一个子路由</p>
</li>
<li><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/20/jhDmNJGQtAokE63.png"
                      alt="image-20220320192535989"
                ></p>
</li>
<li><p>我们将其重定位到Login，在router中增加一个</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">,&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&quot;/login&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.用户管理与登录：解决从登录页面跳到控台主页时，侧边栏失效的问题</p>
<ul>
<li><p>但是随机而来的又有一个问题：从登录页面跳转到控台主页时，菜单失效了。因为打开登录页面时，会去加载所需的js，包括ace.min.js，这里会去做很多的初始化包括侧边栏的点击事件，但是此时还没有侧边栏。</p>
</li>
<li><p>解决方法：进入控台主页时，重新加载ace.min.js，只需要在admin的mounted方法添加</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$.getScript(&#x27;/ace/assets/js/ace.min.js&#x27;);</span><br></pre></td></tr></table></figure>

<ul>
<li>小提示：大家在用很多第三方框架或jquery插件时，如果发现有些功能不起作用，如果看不懂源码，可以尝试这种方法解决，把核心的js重新加载一遍</li>
</ul>
<h2 id="11-2-密码的加密传输与加密存储"><a href="#11-2-密码的加密传输与加密存储" class="headerlink" title="11-2 密码的加密传输与加密存储"></a>11-2 密码的加密传输与加密存储</h2><p><strong>加密算法MD5与盐值</strong></p>
<ul>
<li>网站的数据库里已经把原值和密文都算好并存储超来了，如果刚好你输入的密文在数据库里有，就能解出来</li>
<li>盐值也叫salt值，加上盐值后，密文不容易被破解（查询）</li>
</ul>
<p><strong>密码加密传输和加密加密</strong></p>
<p>1.用户管理与登录：密码加密传输和加密存储</p>
<ul>
<li><p>所有人的密码存成明文的话，至少程序员可以直接到生产上看到</p>
</li>
<li><p>从路由器的日志，我可以看到所有人浏览的网站的地址、用户名、密码，如果密码刚好是明文传输，那就泄露了，如果是简单的md5，也很容易被破解，所以需要加个盐值。</p>
</li>
<li><p>盐值可以是随机的一串值，但是所有用到盐值的地方必须是同一个值。如果你是做平台系统，有多个客户用你的平台，最好是一个客户一个盐值。</p>
</li>
<li><p>我们只需要在user.vue的save方法使用md5就能完成加密</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_this.user.password = hex_md5(_this.user.password+KEY);</span><br></pre></td></tr></table></figure>

<ul>
<li>当然我们为了保险，我们要设置两层加密，所以我们在UserController的save方法中也使用md5</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));</span><br></pre></td></tr></table></figure>

<p><strong>增加修改密码功能</strong></p>
<p>1.用户管理与登录：增加重置密码功能：编辑用户信息的时候不修改密码</p>
<ul>
<li><p>修改用户信息和修改密码应该分开，做成两个功能</p>
</li>
<li><p>首先我们设置下user.vue，只有新增时密码才显示出来，修改时不显示密码修改</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;div v-show=&quot;!user.id&quot; class=&quot;form-group&quot;&gt;</span><br><span class="line">  &lt;label class=&quot;col-sm-2 control-label&quot;&gt;密码&lt;/label&gt;</span><br><span class="line">  &lt;div class=&quot;col-sm-10&quot;&gt;</span><br><span class="line">    &lt;input v-model=&quot;user.password&quot; type=&quot;password&quot; class=&quot;form-control&quot;&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>mybatis-generator生成的方法里，updateByPrimarykeySelective会对字段进行非空判断，再更新，如果值为空就不更新，原理就是利mybatis的if拼成动态sql。</p>
</li>
<li><p>我们在UserService中修改updata</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(User user)</span>&#123;</span><br><span class="line">    user.setPassword(<span class="literal">null</span>);</span><br><span class="line">    userMapper.updateByPrimaryKeySelective(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/21/9qKkAPibF4HDwcG.png"
                      alt="image-20220321092349206"
                ></p>
<ul>
<li>接下来我们要做的就是设置一个重置密码的操作下面修改user.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">//增加一个修改密码表单</span><br><span class="line">&lt;div id=&quot;edit-password-modal&quot; class=&quot;modal fade&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;modal-content&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">        &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;</span><br><span class="line">        &lt;h4 class=&quot;modal-title&quot;&gt;修改密码&lt;/h4&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">        &lt;form class=&quot;form-horizontal&quot;&gt;</span><br><span class="line">          &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">            &lt;label class=&quot;control-label col-sm-2&quot;&gt;密码&lt;/label&gt;</span><br><span class="line">            &lt;div class=&quot;col-sm-10&quot;&gt;</span><br><span class="line">              &lt;input class=&quot;form-control&quot; type=&quot;password&quot; v-model=&quot;user.password&quot; name=&quot;password&quot;&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;modal-footer&quot;&gt;</span><br><span class="line">        &lt;button type=&quot;button&quot; class=&quot;btn btn-white btn-default btn-round&quot; data-dismiss=&quot;modal&quot;&gt;</span><br><span class="line">          &lt;i class=&quot;ace-icon fa fa-times&quot;&gt;&lt;/i&gt;</span><br><span class="line">          取消</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">        &lt;button type=&quot;button&quot; class=&quot;btn btn-white btn-info btn-round&quot; v-on:click=&quot;savePassword()&quot;&gt;</span><br><span class="line">          &lt;i class=&quot;ace-icon fa fa-plus blue&quot;&gt;&lt;/i&gt;</span><br><span class="line">          保存密码</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;&lt;!-- /.modal-content --&gt;</span><br><span class="line">  &lt;/div&gt;&lt;!-- /.modal-dialog --&gt;</span><br><span class="line">&lt;/div&gt;&lt;!-- /.modal --&gt;</span><br><span class="line">//在操作中增加一个按钮</span><br><span class="line"> &lt;button v-on:click=&quot;editPassword(user)&quot; class=&quot;btn btn-xs btn-info&quot;&gt;</span><br><span class="line">     &lt;i class=&quot;ace-icon fa fa-key bigger-120&quot;&gt;&lt;/i&gt;</span><br><span class="line">&lt;/button&gt;</span><br><span class="line">//增加editPassword点击事件</span><br><span class="line"> /**</span><br><span class="line">    * 重置密码</span><br><span class="line">    * @param user</span><br><span class="line">*/</span><br><span class="line">editPassword(user) &#123;</span><br><span class="line">    let _this = this;</span><br><span class="line">    _this.user = $.extend(&#123;&#125;, user);</span><br><span class="line">    _this.user.password = null;</span><br><span class="line">    $(&quot;#edit-password-modal&quot;).modal(&quot;show&quot;);</span><br><span class="line">&#125;,</span><br><span class="line">//增加savePassword点击事件</span><br><span class="line"> /**</span><br><span class="line">     * 点击重置</span><br><span class="line">     */</span><br><span class="line">    savePassword() &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      _this.user.password = hex_md5(_this.user.password+KEY);</span><br><span class="line">      Loading.show();</span><br><span class="line">      _this.$ajax.post(process.env.VUE_APP_SERVER +&#x27;/system/admin/user/save-password&#x27;, _this.user).then((respond) =&gt; &#123;</span><br><span class="line">        Loading.hide();</span><br><span class="line">        let resp = respond.data;</span><br><span class="line">        if (resp.success) &#123;</span><br><span class="line">          $(&quot;#edit-password-modal&quot;).modal(&quot;hide&quot;);</span><br><span class="line">          _this.list(1);</span><br><span class="line">          Toast.success(&quot;保存成功&quot;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">          Toast.warning(resp.message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在服务端UserService增加保存密码的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重置密码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userDto</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">savePassword</span><span class="params">(UserDto userDto)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setId(userDto.getId());</span><br><span class="line">    user.setPassword(userDto.getPassword());</span><br><span class="line">    userMapper.updateByPrimaryKeySelective(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们还需要再UserController中写个savepassword请求</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重置密码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/save-password&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">savePassword</span><span class="params">(<span class="meta">@RequestBody</span> UserDto userDto)</span>&#123;</span><br><span class="line">    userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));</span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">    userService.savePassword(userDto);</span><br><span class="line">    responseDto.setContent(userDto);</span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/21/XEF4g93IWfPop1B.png"
                      alt="image-20220321092436139"
                ></p>
<ul>
<li>思考：我现在存到数据库里面的密码是密文，那用户登录的时候，我数据库里面的密码解密不出来了，我怎么知道用户输入的密码对不对？</li>
</ul>
<h2 id="11-3-基本的登录功能开发"><a href="#11-3-基本的登录功能开发" class="headerlink" title="11-3 基本的登录功能开发"></a>11-3 基本的登录功能开发</h2><p><strong>基本的登录功能开发</strong></p>
<p>1.用户管理与登录：基本的登录功能开发，校验用户名密码</p>
<ul>
<li>我们先修改login.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> &lt;label class=&quot;block clearfix&quot;&gt;</span><br><span class="line">&lt;span class=&quot;block input-icon input-icon-right&quot;&gt;</span><br><span class="line"> &lt;input v-model=&quot;user.loginName&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;用户名&quot;/&gt;</span><br><span class="line"> &lt;i class=&quot;ace-icon fa fa-user&quot;&gt;&lt;/i&gt;</span><br><span class="line">&lt;/span&gt;</span><br><span class="line">          &lt;/label&gt;</span><br><span class="line"></span><br><span class="line">          &lt;label class=&quot;block clearfix&quot;&gt;</span><br><span class="line">&lt;span class=&quot;block input-icon input-icon-right&quot;&gt;</span><br><span class="line"> &lt;input v-model=&quot;user.password&quot; type=&quot;password&quot; class=&quot;form-control&quot; placeholder=&quot;密码&quot;/&gt;</span><br><span class="line"> &lt;i class=&quot;ace-icon fa fa-lock&quot;&gt;&lt;/i&gt;</span><br><span class="line">&lt;/span&gt;</span><br><span class="line">          &lt;/label&gt;</span><br><span class="line">//然后设置一个data数据</span><br><span class="line">data: function () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      user: &#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">//设置login方法</span><br><span class="line"> login()&#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      _this.user.password = hex_md5(_this.user.password+KEY);</span><br><span class="line">      Loading.show();</span><br><span class="line">      _this.$ajax.post(process.env.VUE_APP_SERVER +&#x27;/system/admin/user/login&#x27;, _this.user).then((respond) =&gt; &#123;</span><br><span class="line">        Loading.hide();</span><br><span class="line">        let resp = respond.data;</span><br><span class="line">        if (resp.success) &#123;</span><br><span class="line">          console.log(resp.content)</span><br><span class="line">          this.$router.push(&quot;/welcome&quot;)</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">          Toast.warning(resp.message);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们设置UserController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> UserDto userDto)</span>&#123;</span><br><span class="line">    userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));</span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">    <span class="type">LoginUserDto</span> <span class="variable">loginUserDto</span> <span class="operator">=</span> userService.login(userDto);</span><br><span class="line">    responseDto.setContent(loginUserDto);</span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>接着userService也增加login方法</p>
</li>
<li><p>登录验证思考：是否是根据用户名+密码到数据中去查找记录？</p>
</li>
<li><p>用户名+密码去数据库查找的话，程序不知道是用户名不对，还是密码不对。程序应该要能知道，比如我如果发现有大量的用户名不对的报错，说明有人正在不断的探测我系统的用户名</p>
</li>
<li><p>再次思考：如果用户名不对，提示给前端的是：用户名不存在。如果是密码不对，提示给前端的是：密码不对。是否是这样？</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userDto</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> LoginUserDto <span class="title function_">login</span><span class="params">(UserDto userDto)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> selectByLoginName((userDto.getLoginName()));</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;用户名不存在,&#123;&#125;&quot;</span>,userDto.getLoginName());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionCode.LOGIN_ERROR);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (user.getPassword().equals(userDto.getPassword()))&#123;</span><br><span class="line">            <span class="keyword">return</span> CopyUtil.copy(user,LoginUserDto.class);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;密码不对,输入密码:&#123;&#125;,数据库密码:&#123;&#125;&quot;</span>,userDto.getPassword(),user.getPassword());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionCode.LOGIN_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果你直接告诉前端说用户名不存在，我做为一个黑客的话，可以拿着现成的一堆用户名，包括手机号邮箱，不断的探测哪些用户名是你系统里有了。不要给别人任何机会获取你系统的关键信息。这时我们在BusinessExceptionCode中增加一个变量</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOGIN_ERROR(&quot;用户名或密码错误&quot;),</span><br></pre></td></tr></table></figure>

<ul>
<li>另外我们还需要增加一个LoginUserDto，用于返回返回信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.server.dto;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginUserDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String loginName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 昵称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLoginName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> loginName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginName</span><span class="params">(String loginName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loginName = loginName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        sb.append(getClass().getSimpleName());</span><br><span class="line">        sb.append(<span class="string">&quot; [&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;Hash = &quot;</span>).append(hashCode());</span><br><span class="line">        sb.append(<span class="string">&quot;, id=&quot;</span>).append(id);</span><br><span class="line">        sb.append(<span class="string">&quot;, loginName=&quot;</span>).append(loginName);</span><br><span class="line">        sb.append(<span class="string">&quot;, name=&quot;</span>).append(name);</span><br><span class="line">        sb.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>登录后保存登录信息</strong></p>
<p>1.用户管理与登录：登录后前端保存登录信息并显示</p>
<ul>
<li><p>前端的信息保存有多种选择：h5的localStorage，sessionStorage；js的全局变量，vue的store等</p>
</li>
<li><p>sessionStorage在页面刷新的时候，信息不会丢；关闭页面后，信息自动清空，适合用来存储登录信息</p>
</li>
<li><p>localStorage在关闭页面后，登录信息还是在的，适合一些内网使用的系统保存登录信息</p>
</li>
<li><p>用js全局变量或vue的store，刷新浏览器的时候，信息会丢失。</p>
</li>
<li><p>把登录信息的保存和读取做成通用的方法</p>
</li>
<li><p>小技巧：在获取一些对象的时候，加上||{ }，避免获取属性值时报错</p>
</li>
<li><p>再这我们在tool.js将登录信息的保存和读取做成通用的方法</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存登录信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">loginUser</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="attr">setLoginUser</span>:<span class="keyword">function</span> (<span class="params">loginUser</span>)&#123;</span><br><span class="line">    <span class="title class_">SessionStorage</span>.<span class="title function_">set</span>(<span class="variable constant_">SESSION_KEY_LOGIN_USER</span>,loginUser);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取登录信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">loginUser</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">any|&#123;</span>&#125;&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="attr">getLoginUser</span>:<span class="keyword">function</span> (<span class="params">loginUser</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">SessionStorage</span>.<span class="title function_">get</span>(<span class="variable constant_">SESSION_KEY_LOGIN_USER</span>) ||&#123;&#125;;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在session-storage中设置一个常量</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SESSION_KEY_LOGIN_USER</span> = <span class="string">&quot;SESSION_KEY_LOGIN_USER&quot;</span>; <span class="comment">// 登录信息</span></span><br></pre></td></tr></table></figure>

<ul>
<li>我们在login.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (resp.success) &#123;</span><br><span class="line">  console.log(&quot;登录成功：&quot;,resp.content)</span><br><span class="line">  Tool.setLoginUser(resp.content)//增加这个</span><br><span class="line">  this.$router.push(&quot;/welcome&quot;)</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在admin</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//先增加data</span><br><span class="line">data: function () &#123;</span><br><span class="line">  return &#123;</span><br><span class="line">    loginUser: &#123;&#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">//在mounted:function初始化时获取 </span><br><span class="line">_this.loginUser  = Tool.getLoginUser()</span><br><span class="line">//最后在头像处将名字显示出来</span><br><span class="line">&lt;span class=&quot;user-info&quot;&gt;</span><br><span class="line">    &lt;small&gt;Welcome,&lt;/small&gt;</span><br><span class="line">    &#123;&#123; loginUser.name &#125;&#125;</span><br><span class="line">&lt;/span&gt;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/21/VQjGaSv4H2wlWkK.png"
                      alt="image-20220321120620302"
                ></p>
<h2 id="11-4-退出登录与记住登录"><a href="#11-4-退出登录与记住登录" class="headerlink" title="11-4 退出登录与记住登录"></a>11-4 退出登录与记住登录</h2><p><strong>增加推出登录功能</strong></p>
<p>1.用户管理与登录：增加退出登录功能，清空前后增的会话缓存</p>
<ul>
<li><p>退出登录：清空当前登录的缓存信息，并跳到登录页面</p>
</li>
<li><p>我们先修改下admin页面头像里的三个</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">//头像里的三个文字</span><br><span class="line">&lt;ul class=&quot;user-menu dropdown-menu-right dropdown-menu dropdown-yellow dropdown-caret dropdown-close&quot;&gt;</span><br><span class="line">  &lt;li&gt;</span><br><span class="line">    &lt;a href=&quot;#&quot;&gt;</span><br><span class="line">      &lt;i class=&quot;ace-icon fa fa-cog&quot;&gt;&lt;/i&gt;</span><br><span class="line">      系统设置</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line"></span><br><span class="line">  &lt;li&gt;</span><br><span class="line">    &lt;a href=&quot;profile.html&quot;&gt;</span><br><span class="line">      &lt;i class=&quot;ace-icon fa fa-user&quot;&gt;&lt;/i&gt;</span><br><span class="line">      个人信息</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line"></span><br><span class="line">  &lt;li class=&quot;divider&quot;&gt;&lt;/li&gt;</span><br><span class="line"></span><br><span class="line">  &lt;li&gt;</span><br><span class="line">    &lt;a v-on:click=&quot;logout()&quot; href=&quot;#&quot;&gt;</span><br><span class="line">      &lt;i class=&quot;ace-icon fa fa-power-off&quot;&gt;&lt;/i&gt;</span><br><span class="line">      登出登录</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line">//上面登录页面有一个logout</span><br><span class="line">logout()&#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      Loading.show();</span><br><span class="line">      _this.$ajax.get(process.env.VUE_APP_SERVER +&#x27;/system/admin/user/logout&#x27;).then((response) =&gt; &#123;</span><br><span class="line">        Loading.hide();</span><br><span class="line">        let resp = response.data;</span><br><span class="line">        if (resp.success) &#123;</span><br><span class="line">          Tool.setLoginUser(null);</span><br><span class="line">          this.$router.push(&quot;/login&quot;)</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">          Toast.warning(resp.message);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>我们再在server的dto在增加一个常字段Constants</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.server.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Constants</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOGIN_USER</span> <span class="operator">=</span> <span class="string">&quot;LOGIN_USER&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来写后端，一般登录信息在前后端都会保存，后端缓存</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录，这是后端的缓存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> UserDto userDto, HttpServletRequest request)</span>&#123;</span><br><span class="line">    userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));</span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">    <span class="type">LoginUserDto</span> <span class="variable">loginUserDto</span> <span class="operator">=</span> userService.login(userDto);</span><br><span class="line">    request.getSession().setAttribute(Constants.LOGIN_USER,loginUserDto);</span><br><span class="line">    responseDto.setContent(loginUserDto);</span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 退出登录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/logout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">logout</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">    request.getSession().removeAttribute(Constants.LOGIN_USER);<span class="comment">//去掉后端缓存</span></span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>增加记住登录信息功能</strong></p>
<p>1.用户管理与登录：增加记住登录信息功能</p>
<ul>
<li><p>使用localStorage来保存输入的用户名密码</p>
</li>
<li><p>如果不清空本地缓存，重新打开页面时会再次显示记住的用户名密码</p>
</li>
<li><p>能获取到缓存的值，说明上一次有勾选“记住我</p>
</li>
<li><p>我们首先在local-storage设置一个常量</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">LOCAL_KEY_REMEMBER_USER</span> =<span class="string">&quot;LOCAL_KEY_REMEMBER_USER&quot;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们对login进行修改</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">//给记住我增加一个model</span><br><span class="line">&lt;div class=&quot;clearfix&quot;&gt;</span><br><span class="line">  &lt;label class=&quot;inline&quot;&gt;</span><br><span class="line">    &lt;input v-model=&quot;remember&quot; type=&quot;checkbox&quot; class=&quot;ace&quot;/&gt;</span><br><span class="line">    &lt;span class=&quot;lbl&quot;&gt; 记住我&lt;/span&gt;</span><br><span class="line">  &lt;/label&gt;</span><br><span class="line">//data中设置remember</span><br><span class="line">    data: function () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      user: &#123;&#125;,</span><br><span class="line">      remember:true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">//在初始化时写以下代码</span><br><span class="line">let _this=this;</span><br><span class="line">//从缓存中获取记住的用户名密码,如果获取不到说明上一次没有勾选上“记住我”</span><br><span class="line">let rememberUser = LocalStorage.get(LOCAL_KEY_REMEBER_USER);</span><br><span class="line">if(rememberUser)&#123;</span><br><span class="line">    _this.user = rememberUser;</span><br><span class="line"> &#125;</span><br><span class="line">//登录代码</span><br><span class="line">    methods:&#123;</span><br><span class="line">    login()&#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      let passwordShow = _this.user.password;//新增，先获取明文密码</span><br><span class="line">      _this.user.password = hex_md5(_this.user.password+KEY);</span><br><span class="line">      Loading.show();</span><br><span class="line">      _this.$ajax.post(process.env.VUE_APP_SERVER +&#x27;/system/admin/user/login&#x27;, _this.user).then((response) =&gt; &#123;</span><br><span class="line">        Loading.hide();</span><br><span class="line">        let resp = response.data;</span><br><span class="line">        if (resp.success) &#123;</span><br><span class="line">          console.log(&quot;登录成功：&quot;,resp.content)</span><br><span class="line">          let loginUser = resp.content;//新增</span><br><span class="line">          Tool.setLoginUser(resp.content)</span><br><span class="line">          this.$router.push(&quot;/welcome&quot;)</span><br><span class="line">    ///////////////////////////////////////以下新增</span><br><span class="line">          //判断“记住我”</span><br><span class="line">          if(_this.remember)&#123;</span><br><span class="line">            //如果勾就记住我,则将用户名密码保存到本地缓存这里需要保存密码明文，否则登录时又会再加一层密</span><br><span class="line">            LocalStorage.set(LOCAL_KEY_REMEBER_USER,&#123;</span><br><span class="line">              loginName:loginUser.loginName,</span><br><span class="line">              password:passwordShow</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;else&#123;</span><br><span class="line">            //没有勾选“记住我”时，要把本地缓存清空否则按照Mounted的逻验·下次打开时会自动显示用户名密码</span><br><span class="line">            LocalStorage.set(LOCAL_KEY_REMEBER_USER,null);</span><br><span class="line">          &#125;</span><br><span class="line">    ///////////////////////////////////////////////</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">          Toast.warning(resp.message);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/21/SPKgOtfGJW42TE7.png"
                      alt="image-20220321173337007"
                ></p>
<p>2.用户管理与登录：增加记住登录信息功能，安全加固，本地缓存</p>
<p>修改login.vue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">login()&#123;</span><br><span class="line">  <span class="type">let</span> <span class="variable">_this</span> <span class="operator">=</span> <span class="built_in">this</span>;</span><br><span class="line">  <span class="comment">//////////////////////////////////////////////////////////////</span></span><br><span class="line">  <span class="comment">//将明文存储到缓存中</span></span><br><span class="line">  <span class="comment">// let passwordShow = _this.user.password;</span></span><br><span class="line">  <span class="comment">//如果密码是从缓存带出来的，则不需要重新加密</span></span><br><span class="line">  <span class="type">let</span> <span class="variable">md5</span> <span class="operator">=</span> hex_md5(_this.user.password);</span><br><span class="line">  <span class="type">let</span> <span class="variable">rememberUser</span> <span class="operator">=</span> LocalStorage.get(LOCAL_KEY_REMEBER_USER)||&#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (md5 !== rememberUser.md5)&#123;</span><br><span class="line">    _this.user.password = hex_md5(_this.user.password+KEY);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//////////////////////////////////////////////////////////////////</span></span><br><span class="line">  Loading.show();</span><br><span class="line">  _this.$ajax.post(process.env.VUE_APP_SERVER +<span class="string">&#x27;/system/admin/user/login&#x27;</span>, _this.user).then((response) =&gt; &#123;</span><br><span class="line">    Loading.hide();</span><br><span class="line">    <span class="type">let</span> <span class="variable">resp</span> <span class="operator">=</span> response.data;</span><br><span class="line">    <span class="keyword">if</span> (resp.success) &#123;</span><br><span class="line">      console.log(<span class="string">&quot;登录成功：&quot;</span>,resp.content)</span><br><span class="line">      <span class="type">let</span> <span class="variable">loginUser</span> <span class="operator">=</span> resp.content;</span><br><span class="line">      Tool.setLoginUser(resp.content)</span><br><span class="line">      <span class="built_in">this</span>.$router.push(<span class="string">&quot;/welcome&quot;</span>)</span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">      <span class="comment">//判断“记住我”</span></span><br><span class="line">      <span class="keyword">if</span>(_this.remember)&#123;</span><br><span class="line">        <span class="comment">//如果勾就记住我,则将用户名密码保存到本地缓存这里需要保存密码明文，否则登录时又会再加一层密</span></span><br><span class="line">        <span class="comment">//原：这里需要保存密码明文，否则登陆时又会再增加一层密</span></span><br><span class="line">        <span class="comment">//新：这里保存密码密文，并保存密文md5，用于检测密码是否被重新输入过</span></span><br><span class="line">        <span class="type">let</span> <span class="variable">md5</span> <span class="operator">=</span> hex_md5(_this.user.password)</span><br><span class="line">        LocalStorage.set(LOCAL_KEY_REMEBER_USER,&#123;</span><br><span class="line">          loginName:loginUser.loginName,</span><br><span class="line">          password:_this.user.password,</span><br><span class="line">          md5: md5</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//没有勾选“记住我”时，要把本地缓存清空否则按照Mounted的逻验·下次打开时会自动显示用户名密码</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        LocalStorage.set(LOCAL_KEY_REMEBER_USER,<span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      Toast.warning(resp.message);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>从刚才的记住我这个功能，大家可以看出来，一个是记住明文，一是记住密文，虽然实现的功能是一样的，但是安全性上不一样，所以我们写程序不只是把功能写出来，还要严谨，不要留下坑</li>
</ul>
<h2 id="11-5-增加登录图形验证码"><a href="#11-5-增加登录图形验证码" class="headerlink" title="11-5 增加登录图形验证码"></a>11-5 增加登录图形验证码</h2><p><strong>集成图形验证码kaptcha</strong></p>
<p>1.用户管理与登录：集成图形验证码kaptcha</p>
<ul>
<li>我们首先再course和server的pom.xml中添加</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 图形验证码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后在server的config中添加KaptchaConfig，如果项目中有多个页面会用到验证码图片，且图片的大小颜色等都不一样，就可以增加多个生成验证码图片方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.server.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.impl.DefaultKaptcha;</span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.util.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DefaultKaptcha <span class="title function_">getDefaultKaptcha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultKaptcha</span> <span class="variable">defaultKaptcha</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultKaptcha</span>();</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.border&quot;</span>, <span class="string">&quot;no&quot;</span>);</span><br><span class="line"><span class="comment">//        properties.setProperty(&quot;kaptcha.border.color&quot;, &quot;105,179,90&quot;);</span></span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.color&quot;</span>, <span class="string">&quot;blue&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.width&quot;</span>, <span class="string">&quot;90&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.height&quot;</span>, <span class="string">&quot;32&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.size&quot;</span>, <span class="string">&quot;24&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.session.key&quot;</span>, <span class="string">&quot;code&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.length&quot;</span>, <span class="string">&quot;4&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.names&quot;</span>, <span class="string">&quot;Arial&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.noise.color&quot;</span>, <span class="string">&quot;255,96,0&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.noise.impl&quot;</span>, <span class="string">&quot;com.google.code.kaptcha.impl.NoNoise&quot;</span>);</span><br><span class="line"><span class="comment">//        properties.setProperty(&quot;kaptcha.obscurificator.impl&quot;, &quot;com.google.code.kaptcha.impl.WaterRipple&quot;);</span></span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.obscurificator.impl&quot;</span>, <span class="string">&quot;com.course.server.util.NoWaterRipple&quot;</span>);</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>(properties);</span><br><span class="line">        defaultKaptcha.setConfig(config);</span><br><span class="line">        <span class="keyword">return</span> defaultKaptcha;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DefaultKaptcha <span class="title function_">getWebKaptcha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultKaptcha</span> <span class="variable">defaultKaptcha</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultKaptcha</span>();</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.border&quot;</span>, <span class="string">&quot;no&quot;</span>);</span><br><span class="line"><span class="comment">//        properties.setProperty(&quot;kaptcha.border.color&quot;, &quot;105,179,90&quot;);</span></span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.color&quot;</span>, <span class="string">&quot;blue&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.width&quot;</span>, <span class="string">&quot;90&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.height&quot;</span>, <span class="string">&quot;45&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.size&quot;</span>, <span class="string">&quot;30&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.session.key&quot;</span>, <span class="string">&quot;code&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.length&quot;</span>, <span class="string">&quot;4&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.names&quot;</span>, <span class="string">&quot;Arial&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.noise.impl&quot;</span>, <span class="string">&quot;com.google.code.kaptcha.impl.NoNoise&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.obscurificator.impl&quot;</span>, <span class="string">&quot;com.google.code.kaptcha.impl.WaterRipple&quot;</span>);</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>(properties);</span><br><span class="line">        defaultKaptcha.setConfig(config);</span><br><span class="line">        <span class="keyword">return</span> defaultKaptcha;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<ul>
<li>然后再system的admin添加KaptchaController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.system.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.impl.DefaultKaptcha;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/kaptcha&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Qualifier(&quot;getDefaultKaptcha&quot;)</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DefaultKaptcha defaultKaptcha;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/image-code/&#123;imageCodeToken&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">imageCode</span><span class="params">(<span class="meta">@PathVariable(value = &quot;imageCodeToken&quot;)</span> String imageCodeToken, HttpServletRequest request, HttpServletResponse httpServletResponse)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">jpegOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 生成验证码字符串</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">createText</span> <span class="operator">=</span> defaultKaptcha.createText();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将生成的验证码放入会话缓存中，后续验证的时候用到</span></span><br><span class="line">             request.getSession().setAttribute(imageCodeToken, createText);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用验证码字符串生成验证码图片</span></span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">challenge</span> <span class="operator">=</span> defaultKaptcha.createImage(createText);</span><br><span class="line">            ImageIO.write(challenge, <span class="string">&quot;jpg&quot;</span>, jpegOutputStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            httpServletResponse.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义response输出类型为image/jpeg类型，使用response输出流输出图片的byte数组</span></span><br><span class="line">        <span class="type">byte</span>[] captchaChallengeAsJpeg = jpegOutputStream.toByteArray();</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-store&quot;</span>);</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">&quot;Pragma&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">        httpServletResponse.setDateHeader(<span class="string">&quot;Expires&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">responseOutputStream</span> <span class="operator">=</span> httpServletResponse.getOutputStream();</span><br><span class="line">        responseOutputStream.write(captchaChallengeAsJpeg);</span><br><span class="line">        responseOutputStream.flush();</span><br><span class="line">        responseOutputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>页面显示验证码及刷新验证码</strong></p>
<p>1.用户管理与登录：页面显示验证码及刷新验证码</p>
<ul>
<li><p>验证码功能分为显示和验证两个步骤，用token将两个步骤关联起</p>
</li>
<li><p>我们首先给Tool.js增加一个方法，原理：以62进制为例，随机生成一个0~61的数值，比如41，那边就取chars数组中的第41个字符，这样重复做8遍，就生成了8位的62进制数，重复的概率是62的8次方。也可以生成更长的数值。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 随机生成[len]长度的[radix]进制数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">len</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> radix 默认62</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">string</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="attr">uuid</span>: <span class="keyword">function</span> (<span class="params">len, radix</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> chars = <span class="string">&#x27;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&#x27;</span>.<span class="title function_">split</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> uuid = [];</span><br><span class="line">    radix = radix || chars.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        uuid[i] = chars[<span class="number">0</span> | <span class="title class_">Math</span>.<span class="title function_">random</span>() * radix];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uuid.<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们修改login.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> //增加一个验证码框，在Bootstrap中找</span><br><span class="line">&lt;label class=&quot;block clearfix&quot;&gt;</span><br><span class="line">&lt;span class=&quot;block input-icon input-icon-right&quot;&gt;</span><br><span class="line">&lt;div class=&quot;input-group&quot;&gt;</span><br><span class="line">                &lt;input  type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;验证码&quot; &gt;</span><br><span class="line">                &lt;span class=&quot;input-group-addon&quot; id=&quot;basic-add2on&quot;&gt;</span><br><span class="line">                  &lt;img v-on:click=&quot;loadImageCode()&quot; id=&quot;image-code&quot; alt=&quot;验证码&quot;/&gt;</span><br><span class="line">                &lt;/span&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">&lt;/span&gt;</span><br><span class="line">&lt;/label&gt;</span><br><span class="line">//初始时加载一次验证码图片</span><br><span class="line">_this.loadImageCode();</span><br><span class="line"></span><br><span class="line"> /**</span><br><span class="line">     * 加载验证码方法</span><br><span class="line">     */</span><br><span class="line">    loadImageCode:function ()&#123;</span><br><span class="line">      let _this =this;</span><br><span class="line">      _this.imageCodeToken = Tool.uuid(8);</span><br><span class="line">      $(&#x27;#image-code&#x27;).attr(&#x27;src&#x27;,process.env.VUE_APP_SERVER+&#x27;/system/admin/kaptcha/image-code/&#x27;+_this.imageCodeToken);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p><strong>登录增加验证码校验</strong></p>
<ul>
<li>在userdto中增加属性，增加属性后，记得Alt+lnsert生成get，set，toString（）方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String imageCode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 图片验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String imageCodeToken;</span><br></pre></td></tr></table></figure>

<ul>
<li>在登录里面，增加验证码校验：通过token去缓存中获取验证码字符串，并和用户输入的字符串做比较，在这我们修改UserController的login</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> UserDto userDto, HttpServletRequest request)</span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;用户登录开始&quot;</span>);</span><br><span class="line">    userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));</span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="comment">//根据验证码token去获取缓存中的验证码，和用户输入的验证码是否一致</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">imageCode</span> <span class="operator">=</span> (String) request.getSession().getAttribute(userDto.getImageCodeToken());</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(imageCode))&#123;</span><br><span class="line">        responseDto.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        responseDto.setMessage(<span class="string">&quot;验证码已过期&quot;</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;用户登录失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> responseDto;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!imageCode.toLowerCase().equals(userDto.getImageCode().toLowerCase()))&#123;</span><br><span class="line">        responseDto.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        responseDto.setMessage(<span class="string">&quot;验证码不对&quot;</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;用户登录失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> responseDto;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//验证码通过后，移除验证码</span></span><br><span class="line">        request.getSession().removeAttribute(userDto.getImageCodeToken());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="type">LoginUserDto</span> <span class="variable">loginUserDto</span> <span class="operator">=</span> userService.login(userDto);</span><br><span class="line">    request.getSession().setAttribute(Constants.LOGIN_USER,loginUserDto);</span><br><span class="line">    responseDto.setContent(loginUserDto);</span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>前后端分离会有一个问题，每次ajax请求，后端的session是不一样的。在springboo+jsp，或springboot+thymeleaf中，不会有这个问题。获取的验证码一致都是空，这个问题在页面中显示：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/22/YKgnEjV2ah8r5Tl.png"
                      alt="image-20220322110349728"
                ></p>
</li>
<li><p>下面开始解决验证码获取为空的方法，在main.js中加入</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解决每次ajax请求·对应的sessionId不一致的问题</span></span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">withCredentials</span> =<span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>登录验证出错时，将密码清空，同时刷新验证码图片</p>
</li>
<li><p>刷新验证码会让网站更安全，但是会辆性一点用户体验，需要折中选择</p>
</li>
<li><p>只需要在login.vue中login方法登陆不成功时输入下面代码，就可以将密码清空，同时刷新验证码图片</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_this.user.password = &quot;&quot;;</span><br><span class="line">_this.loadImageCode();</span><br></pre></td></tr></table></figure>

<h2 id="11-6-单点登录功能开发"><a href="#11-6-单点登录功能开发" class="headerlink" title="11-6 单点登录功能开发"></a>11-6 单点登录功能开发</h2><p><strong>单点登录解决方案介绍</strong></p>
<ul>
<li>生产发布时，至少是双节点，防止单台宕机</li>
<li>request.getSession（）可以访问这片空间</li>
<li>问题一：B节点中，没有经历过之前的登录，Session没有保存登录用户信息，于是B节点会认为未登录过，会拦截掉业务请</li>
<li>解决方法一：IP_HASH，对客户端IP做HASH计算，负载均衡SLB中，会根据HASH值将该IP所有的请求固定的发往其中一台，缺点，当其中一个节点宕机，则该节点下的用户需要重新登录；另一个缺点是对SLB不能灵活的配置流量此如A这台机器性能好一点可以分配流量高一些</li>
<li>解决方法二：不管是在哪一台做的登录，登录完成后，会把登录信息保存到redis中。当业务请求进来时，再到redis中获取登录信息，能获取到就表示已登录；未获取到就表示未登录，拦截掉请求</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/22/1wHWjQd4vIpLYVz.png"
                      alt="image-20220322144243004"
                ></p>
<ul>
<li><p>功能：只要在其中一个产品中登录过，其他关联的产品都不需要再登录</p>
</li>
<li><p>token：登录标识，每个用户每次登录，都会生成不同的token</p>
</li>
<li><p>单点登录（Single Sign On），简称为SSO，核心功能为session共享</p>
</li>
<li><p>需要解决Session共享的场景：1.同个应用多节点共享登录信息；2.多个项目间共享登录信息。一般我们通常说的单点登录系统，是用来解决场景2的</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/22/LarEsBOM7Ig6UpH.png"
                      alt="image-20220322144848481"
                ></p>
</li>
</ul>
<p><strong>集成redis</strong></p>
<p>1，用户管理与登录：集成redis，图片验证码的存储从session改为redis</p>
<ul>
<li>首先在server集成pom.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后在application中增加配置</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis配置</span></span><br><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">r-uf6ljbcdaxobsifyctpd.redis.rds.aliyuncs.com</span></span><br><span class="line"><span class="attr">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="attr">spring.redis.password</span>=<span class="string">Redis000</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在KaptchaController中修改放验证码操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注入</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">public</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将生成的验证码放入会话缓存中，后续验证的时候用到</span></span><br><span class="line"><span class="comment">// request.getSession().setAttribute(imageCodeToken, createText);</span></span><br><span class="line"><span class="comment">//将生成的验证码放入redis缓存中后续验证的时候用到</span></span><br><span class="line">redisTemplate.opsForValue().set(imageCodeToken,createText,<span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>最后在UserController进行取操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注入</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">public</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据验证码token去获取缓存中的验证码，和用户输入的验证码是否一致</span></span><br><span class="line"><span class="comment">//String imageCode = (String)request.getSession().getAttribute(userDto.getImageCodeToken());</span></span><br><span class="line"><span class="type">String</span> <span class="variable">imageCode</span> <span class="operator">=</span>(String)redisTemplate.opsForValue().get(userDto.getImageCodeToken());</span><br><span class="line">LOG.info(<span class="string">&quot;从redis中获取到验证码:&#123;&#125;&quot;</span>,imageCode);</span><br></pre></td></tr></table></figure>

<p><strong>生成登录token并存储到redis中</strong></p>
<p>1.用户管理与登录；生成登录token并存储到redis中：退出登录删除token</p>
<ul>
<li>我们在LoginUserDto增加</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录凭证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String token;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后修改UserController，这里也可以直接保存loginUserDto对象，但是需要序列化。如果是跨应用使用的，比如A应用存，B应用取，一般会把值转成JSON字符串</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//验证码通过后，移除验证码</span></span><br><span class="line">    <span class="comment">//request.getSession().removeAttribute(userDto.getImageCodeToken());</span></span><br><span class="line">    redisTemplate.delete(userDto.getImageCodeToken());</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">LoginUserDto</span> <span class="variable">loginUserDto</span> <span class="operator">=</span> userService.login(userDto);</span><br><span class="line"><span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UuidUtil.getShortUuid();</span><br><span class="line">loginUserDto.setToken(token);</span><br><span class="line"><span class="comment">//request.getSession().setAttribute(Constants.LOGIN_USER,loginUserDto);</span></span><br><span class="line">redisTemplate.opsForValue().set(token, JSON.toJSONString(loginUserDto),<span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">responseDto.setContent(loginUserDto);</span><br><span class="line"><span class="keyword">return</span> responseDto;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退出登录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/logout/&#123;token&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseDto <span class="title function_">logout</span><span class="params">(<span class="meta">@PathVariable</span> String token)</span>&#123;</span><br><span class="line">        <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">        <span class="comment">//request.getSession().removeAttribute(Constants.LOGIN_USER);</span></span><br><span class="line">       redisTemplate.delete(token);</span><br><span class="line">       LOG.info(<span class="string">&quot;从redis中删除token:&#123;&#125;&quot;</span>,token);</span><br><span class="line">        <span class="keyword">return</span> responseDto;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>相应的admin.vue，增加token参数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_this.$ajax.get(process.env.VUE_APP_SERVER +&#x27;/system/admin/user/logout/&#x27;+_this.loginUser.token)</span><br></pre></td></tr></table></figure>

<h2 id="11-7-前后端登录拦截"><a href="#11-7-前后端登录拦截" class="headerlink" title="11-7 前后端登录拦截"></a>11-7 前后端登录拦截</h2><p>1.用户管理与登录；基于Vue路由的登录拦截</p>
<ul>
<li>首先在router的admin下增加meta</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">path: &quot;/&quot;,</span><br><span class="line">name:&quot;admin&quot;,</span><br><span class="line">component: Admin,</span><br><span class="line">meta:&#123;</span><br><span class="line">    loginRequire:true</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>最后我们在main.js增加，就实现了拦截</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//路由拦截器</span></span><br><span class="line">router.beforeEach((to,from,next) =&gt;&#123;</span><br><span class="line">  <span class="keyword">if</span> (to.matched.some(function (item)&#123;</span><br><span class="line">    <span class="keyword">return</span> item.meta.loginRequire</span><br><span class="line">  &#125;))&#123;</span><br><span class="line">    <span class="type">let</span> <span class="variable">loginUser</span> <span class="operator">=</span> Tool.getLoginUser();</span><br><span class="line">    <span class="keyword">if</span>(Tool.isEmpty(loginUser))&#123;</span><br><span class="line">      next(<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      next();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>在请求headers中统一增加token</strong></p>
<ul>
<li><p>问题：界面拦住了，但是所有的接口都可以直接访问，非常危险，这时我们要做的就是基于后端的登录拦截</p>
</li>
<li><p>就是在main.js的axias拦截器中增加，可以用这种给所有请求加了统一的系统参数，比如在header里加上请求流水，请求时间等</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let token =Tool.getLoginUser().token;</span><br><span class="line">if (Tool.isNotEmpty(token))&#123;</span><br><span class="line">  config.headers.token = token;</span><br><span class="line">  console.log(&quot;请求headers增加token:&quot;,token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>gateway增加登录拦截</strong></p>
<p>1.用户管理与登录：：在Gateway中增加登录拦截器</p>
<ul>
<li><p>不是所有的请求都需要做登录拦截，比如登录接口、验证码图片接口</p>
</li>
<li><p>我们首先在application中增加过滤配置</p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.cloud.gateway.routes[0].filters[0].name</span>=<span class="string">LoginAdmin</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.routes[0].filters[0].args[0]</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们给系统加一个过滤器，在gateway下增加一个filter软件包，建立一个类LoginAdminGatewayFilterFactory</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.gateway.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginAdminGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractGatewayFilterFactory</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    LoginAdminGatewayFilter loginAdminGatewayFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GatewayFilter <span class="title function_">apply</span><span class="params">(Object config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> loginAdminGatewayFilter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后在同包下建立实现类LoginAdminGatewayFilter</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.gateway.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginAdminGatewayFilter</span> <span class="keyword">implements</span> <span class="title class_">GatewayFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(LoginAdminGatewayFilter.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//获取header的token参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> exchange.getRequest().getHeaders().getFirst(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;控台登录验证开始，token：&#123;&#125;&quot;</span>, token);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.用户管理与登录：gateway实现控台登录拦截功能</p>
<ul>
<li>我们给gateway的pom.xml增加，gateway模块并没有依赖server模块，所以有些jar包redis，json等，需要单独在pom.xml中增加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 热部署DevTools --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在LoginAdminGatewayFilter做如下修改</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注入</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"><span class="comment">//判断拦截</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">    <span class="comment">//////////////////////////////////////////////////////////</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> exchange.getRequest().getURI().getPath();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求地址不包含/admin/的，不是控台请求，不需要拦截</span></span><br><span class="line">        <span class="keyword">if</span>(!path.contains(<span class="string">&quot;/admin/&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (path.contains(<span class="string">&quot;/system/admin/user/login&quot;</span>)</span><br><span class="line">                ||path.contains(<span class="string">&quot;/system/admin/user/logout&quot;</span>)</span><br><span class="line">                ||path.contains(<span class="string">&quot;/system/admin/kaptcha&quot;</span>))&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;不需要控台登录验证:&#123;&#125;&quot;</span>,path);</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">///////////////////////////////////////////////////////////////</span></span><br><span class="line">        <span class="comment">//获取header的token参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> exchange.getRequest().getHeaders().getFirst(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;控台登录验证开始，token：&#123;&#125;&quot;</span>, token);</span><br><span class="line">    <span class="comment">/////////////////////////////////////////////////////////////////</span></span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span>||token.isEmpty())&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;token为空，请求被拦截&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> redisTemplate.opsForValue().get(token);</span><br><span class="line">        <span class="keyword">if</span> (object == <span class="literal">null</span>)&#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;token无效，请求被拦截&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;已登录:&#123;&#125;&quot;</span>,object);</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="11-8-用户登录流程图"><a href="#11-8-用户登录流程图" class="headerlink" title="11-8 用户登录流程图"></a>11-8 用户登录流程图</h2><p><strong>验证码图片登录</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/mLCw1ZGrJPQuhUo.png"
                      alt="image-20220323120729776"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/Yag4z8IZPEwA3DT.png"
                      alt="image-20220323120812348"
                ></p>
<p><strong>登录的流程</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/5He4E1ZMb23TXPs.png"
                      alt="image-20220323120858378"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/h5Iut2cBRlPMOHa.png"
                      alt="image-20220323120919748"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/b6ODknduZC3LPKE.png"
                      alt="image-20220323121028370"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/9PiSnANMfyRC16L.png"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/JWmX4CScP35lig7.png"
                      alt="image-20220323121244262"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/H9YwsyDmTvcdX6h.png"
                      alt="image-20220323121306313"
                ></p>
<h1 id="第12章-通用权限设计"><a href="#第12章-通用权限设计" class="headerlink" title="第12章 通用权限设计"></a>第12章 通用权限设计</h1><p>本章演示通用权限功能开发，不依赖任何使用第三方框架，使用经典的资源、角色、用户关联，灵活且维护，可以细粒度的控制菜单、按钮、接口的权限，适用于通用后台管理系统的权限管理。</p>
<hr>
<h2 id="12-1-通用权限解决方案介绍"><a href="#12-1-通用权限解决方案介绍" class="headerlink" title="12-1 通用权限解决方案介绍"></a>12-1 通用权限解决方案介绍</h2><ul>
<li>目前一些知名的权限框架有Shiro和SpringSecurity。正常情况，直接用框架没什么问题。方便，快速，但是需要一定的学习成本，得学习如何使用这些框架。</li>
<li>用框架还有一个缺点是不好定制，因为每个产品的业务都不太一样，要控制的权限都不太一样，此时如果硬是套用框架就会很别扭</li>
<li>经典的权限管理设计：用户和角色关联，角色和资源关联</li>
<li>两张关联表的配置，可以单独设计界面，也可以直接做到角色管理界面里。</li>
<li>权限初始化，系统上线时，要初始化这五张表的数据。初始有一个用户能登录能管理角色，管理资源，分配权限</li>
<li>疑问：前端已经对菜单和按钮做拦截，用户不能操作，为什么还要对接口做拦截？</li>
<li>重要提示：所有前端的设计都是不安全的</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/sGLSViJINfwhj5d.png"
                      alt="image-20220323144829155"
                ></p>
<h2 id="12-2-资源配置管理"><a href="#12-2-资源配置管理" class="headerlink" title="12-2 资源配置管理"></a>12-2 资源配置管理</h2><p><strong>资源表的设计与基本代码生成</strong></p>
<p>1.通用权限管理：资源表的设计与基本代码生成</p>
<ul>
<li><p>资源的名称一般是用页面上看得见的元素：菜单、按钮等。</p>
</li>
<li><p>页面对vue框架来说，就是路由</p>
</li>
<li><p>如果是一个页面的所有操作统一控制权限，request可以填相关接口的前缀</p>
</li>
<li><p>我们首先写sql</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 资源</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `resource`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `resource`(</span><br><span class="line">                       `id` <span class="type">char</span>(<span class="number">6</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">                       `name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;名称|菜单或按钮&#x27;</span>,</span><br><span class="line">                       `page` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">null</span> comment <span class="string">&#x27;页面|路由&#x27;</span>,</span><br><span class="line">                       `request` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">null</span> comment <span class="string">&#x27;请求|接口&#x27;</span>,</span><br><span class="line">                       `parent` <span class="type">char</span>(<span class="number">6</span>)  comment <span class="string">&#x27;父id&#x27;</span>,</span><br><span class="line">                       <span class="keyword">primary</span> key (`id`)</span><br><span class="line">)engine <span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;资源&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `resource` <span class="keyword">values</span> (<span class="string">&#x27;01&#x27;</span>,<span class="string">&#x27;系统管理&#x27;</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `resource` <span class="keyword">values</span> (<span class="string">&#x27;0101&#x27;</span>,<span class="string">&#x27;用户管理&#x27;</span>,<span class="string">&#x27;/system/user&#x27;</span>,<span class="keyword">null</span>,<span class="string">&#x27;01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `resource` <span class="keyword">values</span> (<span class="string">&#x27;010101&#x27;</span>,<span class="string">&#x27;保存&#x27;</span>,<span class="keyword">null</span>,<span class="string">&#x27;[&quot;/system/admin/user/list&quot;,&quot;/system/admin/user/save&quot;]&#x27;</span>,<span class="string">&#x27;0101&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `resource` <span class="keyword">values</span> (<span class="string">&#x27;010102&#x27;</span>,<span class="string">&#x27;删除&#x27;</span>,<span class="keyword">null</span>,<span class="string">&#x27;[&quot;/system/admin/user/delete&quot;]&#x27;</span>,<span class="string">&#x27;0101&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `resource` <span class="keyword">values</span> (<span class="string">&#x27;010103&#x27;</span>,<span class="string">&#x27;重置密码&#x27;</span>,<span class="keyword">null</span>,<span class="string">&#x27;[&quot;/system/admin/user/save-password&quot;]&#x27;</span>,<span class="string">&#x27;0101&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `resource` <span class="keyword">values</span> (<span class="string">&#x27;0102&#x27;</span>,<span class="string">&#x27;资源管理&#x27;</span>,<span class="string">&#x27;/system/resource&#x27;</span>,<span class="keyword">null</span>,<span class="string">&#x27;01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `resource` <span class="keyword">values</span> (<span class="string">&#x27;010201&#x27;</span>,<span class="string">&#x27;保存/显示&#x27;</span>,<span class="keyword">null</span>,<span class="string">&#x27;[&quot;/system/admin/resource&quot;]&#x27;</span>,<span class="string">&#x27;0102&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `resource` <span class="keyword">values</span> (<span class="string">&#x27;0103&#x27;</span>,<span class="string">&#x27;角色管理&#x27;</span>,<span class="string">&#x27;/system/role&#x27;</span>,<span class="keyword">null</span>,<span class="string">&#x27;01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `resource` <span class="keyword">values</span> (<span class="string">&#x27;010301&#x27;</span>,<span class="string">&#x27;角色/权限管理&#x27;</span>,<span class="keyword">null</span>,<span class="string">&#x27;[&quot;/system/admin/role&quot;]&#x27;</span>,<span class="string">&#x27;0103&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>接着就开始一顿操作，代码生成器，最后生成vue时，ResourceService和ResourceController会出现一个问题，原因：资源表的实体类是Resource，和@Resbutee注解同名！导致冲突<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/wW3hxoPyMv9dsLg.png"
                      alt="image-20220323192200289"
                ></p>
</li>
<li><p>解决上面的问题就是直接写全<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/UW5xh67KifNCE3n.png"
                      alt="image-20220323192341557"
                ></p>
</li>
<li><p>下面开始修改admin</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;li class=&quot;&quot;&gt;</span><br><span class="line">  &lt;router-link to=&quot;/system/resource&quot;&gt;</span><br><span class="line">    &lt;i class=&quot;menu-icon fa fa-caret-right&quot;&gt;&lt;/i&gt;</span><br><span class="line">    资源管理</span><br><span class="line">  &lt;/router-link&gt;</span><br><span class="line"></span><br><span class="line">  &lt;b class=&quot;arrow&quot;&gt;&lt;/b&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后改下router.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">,&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;system/resource&quot;</span>,</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&quot;system/resource&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Resource</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>资源树的保存</strong></p>
<p>1.通用权限管理：资源树的保存</p>
<ul>
<li><p>资源点是开发阶段就确定的，所以并不是上线后再一个一个配置的。</p>
</li>
<li><p>资源管理最简单的一种方案：上线前准备好sql，刷库</p>
</li>
<li><p>在这里将资源管理做成资源树进行管理，填入数据：带有层级结构的json字符串<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/23/WGr4hF6TIQeXSkY.png"
                      alt="image-20220323201202115"
                ></p>
</li>
<li><p>用法：以后开发新功能的时候，就在该文件里加入新的资源可以上线前将新的资源json通过控台保存进数据库</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;01&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;系统管理&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;0101&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;用户管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span><span class="string">&quot;/system/user&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;010101&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;保存&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/system/admin/user/list&quot;</span><span class="punctuation">,</span><span class="string">&quot;/system/admin/user/save&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;010102&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;删除&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/system/admin/user/delete&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;010103&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;重置密码&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/system/admin/user/save-password&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;0102&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;资源管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span><span class="string">&quot;/system/resource&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;010201&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;保存/显示&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/system/admin/resource&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;0103&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;角色管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span><span class="string">&quot;/system/role&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;010301&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;角色/权限管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/system/admin/role&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>接下来修改下resource.vue，</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">//新增去了，加上保存，并且删除模态框</span><br><span class="line">&lt;div class=&quot;row&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;col-md-6&quot;&gt;</span><br><span class="line">    &lt;textarea id=&quot;resource-textarea&quot; class=&quot;form-control&quot; v-model=&quot;resourceStr&quot; name=&quot;resource&quot; rows=&quot;10&quot;&gt;&lt;/textarea&gt;</span><br><span class="line"></span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;button id=&quot;save-btn&quot; type=&quot;button&quot; class=&quot;btn btn-primary&quot; v-on:click=&quot;save()&quot;&gt;</span><br><span class="line">      保存</span><br><span class="line">    &lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">//然后data新增一个resourceStr绑定到多行文本框里的</span><br><span class="line">resourceStr:&quot;&quot;,</span><br><span class="line">//然后add和edit都删了</span><br><span class="line">//最后修改下save</span><br><span class="line">  save() &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">/////////////////////////////////////////////以下是修改</span><br><span class="line">      // 保存校验</span><br><span class="line">      if (Tool.isEmpty(_this.resourceStr)) &#123;</span><br><span class="line">        Toast.warning(&quot;资源不能为空！&quot;);</span><br><span class="line">        return;</span><br><span class="line">      &#125;</span><br><span class="line">      let json = JSON.parse(_this.resourceStr);</span><br><span class="line"></span><br><span class="line">      Loading.show();</span><br><span class="line">      _this.$ajax.post(process.env.VUE_APP_SERVER +&#x27;/system/admin/resource/save&#x27;, json).then((respond) =&gt; &#123;</span><br><span class="line">/////////////////////////////////////////////////</span><br><span class="line">        Loading.hide();</span><br><span class="line">        let resp = respond.data;</span><br><span class="line">        if (resp.success) &#123;</span><br><span class="line">          $(&quot;#form-modal&quot;).modal(&quot;hide&quot;);</span><br><span class="line">          _this.list(1);</span><br><span class="line">          Toast.success(&quot;保存成功&quot;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">          Toast.warning(resp.message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来修改下ResourceController的save，原本是一个个保存，现在直接保存整个字符串</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> String jsonStr)</span>&#123;</span><br><span class="line">    <span class="comment">//保存校验</span></span><br><span class="line">        ValidatorUtil.require(jsonStr, <span class="string">&quot;资源&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">    resourceService.saveJson(jsonStr);</span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们修改ResourceDto</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;ResourceDto&gt; children;<span class="comment">//嵌套实类结构</span></span><br></pre></td></tr></table></figure>

<ul>
<li>最后我们修改ResourceService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 新增，ID是自定义好的，不是自动生成的，将setId删除</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Resource resource)</span>&#123;</span><br><span class="line">    resourceMapper.insert(resource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存资源树</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> json</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveJson</span><span class="params">(String json)</span>&#123;</span><br><span class="line">        List&lt;ResourceDto&gt; jsonList = JSON.parseArray(json, ResourceDto.class);</span><br><span class="line">        List&lt;ResourceDto&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();<span class="comment">//将带有嵌套结构的jsonList里所有的节点取出来，组成简单的list</span></span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(jsonList))&#123;</span><br><span class="line">            <span class="keyword">for</span> (ResourceDto d:jsonList)&#123;</span><br><span class="line">                d.setParent(<span class="string">&quot;&quot;</span>);</span><br><span class="line">                add(list,d);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;共&#123;&#125;条&quot;</span>,list.size());</span><br><span class="line">        resourceMapper.deleteByExample(<span class="literal">null</span>);<span class="comment">//把数据库整张表清空</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">            <span class="built_in">this</span>.insert(CopyUtil.copy(list.get(i),Resource.class));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 递归，将树形节点全部取出来，放到list。add方法是一个递归函数，功能是将d节点下的子节点添加到list中如果子节点下还有孙子节点，则递归调用add方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> list</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dto</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(List&lt;ResourceDto&gt; list,ResourceDto dto)</span>&#123;</span><br><span class="line">        list.add(dto);</span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(dto.getChildren()))&#123;</span><br><span class="line">            <span class="keyword">for</span> (ResourceDto d:dto.getChildren())&#123;</span><br><span class="line">                d.setParent(dto.getId());</span><br><span class="line">                add(list,d);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>资源树的显示</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/24/S43O1C9zFjX7xfI.png"
                      alt="image-20220324100951445"
                ></p>
<ul>
<li>我们首先修改resource.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">//在保存按钮下新增，下面表格就可以删了</span><br><span class="line">&lt;div class=&quot;col-md-6&quot;&gt;</span><br><span class="line">  &lt;ul id=&quot;tree&quot; class=&quot;ztree&quot;&gt;&lt;/ul&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">//data中增加对象</span><br><span class="line">tree:&#123;&#125;,</span><br><span class="line">//对list进行修改</span><br><span class="line">list() &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      Loading.show();</span><br><span class="line">      _this.$ajax.get(process.env.VUE_APP_SERVER +&#x27;/system/admin/resource/load-tree&#x27;)</span><br><span class="line">      .then((res) =&gt; &#123;</span><br><span class="line">        Loading.hide();</span><br><span class="line">        let response = res.data;</span><br><span class="line">        _this.resources = response.content;</span><br><span class="line">        //初始树</span><br><span class="line">        _this.initTree();</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">//增加一个初始化树</span><br><span class="line"> initTree()&#123;</span><br><span class="line">      let _this =this;</span><br><span class="line">      let setting=&#123;</span><br><span class="line">        data:&#123;</span><br><span class="line">          simpleData:&#123;</span><br><span class="line">            idKey:&quot;id&quot;,</span><br><span class="line">            pIdKey:&quot;parent&quot;,</span><br><span class="line">            rootPId:&quot;&quot;,</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      _this.zTree = $.fn.zTree.init($(&quot;#tree&quot;),setting,_this.resources);</span><br><span class="line">      _this.zTree.expandAll(true);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在ResourceController就增加了一个方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源树查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/load-tree&quot;)</span></span><br><span class="line"><span class="keyword">public</span>  ResponseDto <span class="title function_">loadTree</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">    List&lt;ResourceDto&gt; resourceDtoList = resourceService.loadTree();</span><br><span class="line">    responseDto.setContent(resourceDtoList);</span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来修改下对应的ResourceService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按约定将列表转成树</span></span><br><span class="line"><span class="comment"> * 要求：ID要正序排列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;ResourceDto&gt; <span class="title function_">loadTree</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ResourceExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceExample</span>();</span><br><span class="line">    example.setOrderByClause(<span class="string">&quot;id asc&quot;</span>);</span><br><span class="line">    List&lt;Resource&gt; resourceList = resourceMapper.selectByExample(example);</span><br><span class="line">    List&lt;ResourceDto&gt; resourceDtoList = CopyUtil.copyList(resourceList, ResourceDto.class);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> resourceDtoList.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">//当前要移动的记录</span></span><br><span class="line">        <span class="type">ResourceDto</span> <span class="variable">child</span> <span class="operator">=</span> resourceDtoList.get(i);</span><br><span class="line">        <span class="comment">//如果当前节点没有父节点，则不用往下了</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(child.getParent())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//查找父节点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="type">ResourceDto</span> <span class="variable">parent</span> <span class="operator">=</span> resourceDtoList.get(j);</span><br><span class="line">            <span class="keyword">if</span> (child.getParent().equals(parent.getId())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (CollectionUtils.isEmpty(parent.getChildren())) &#123;</span><br><span class="line">                    parent.setChildren(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//添加到最前面，否则会变成倒序，因为循环是从后往前循环的</span></span><br><span class="line">                parent.getChildren().add(<span class="number">0</span>, child);</span><br><span class="line">                <span class="comment">//子节点找到父节点后删除列表中的子节点</span></span><br><span class="line">                resourceDtoList.remove(child);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resourceDtoList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>资源的保存是将树结构转成列表，重点是children属性；资源的显示是将列表转成树结构，重点是parent属性。</p>
</li>
<li><p>小知识：一边循环list，一边删除list中的对象，可以使用倒序循环</p>
</li>
</ul>
<h2 id="12-3角色权限管理"><a href="#12-3角色权限管理" class="headerlink" title="12-3角色权限管理"></a>12-3角色权限管理</h2><p><strong>基本的角色管理功能</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：增加基本的角色管理功能</span><br><span class="line">2.资源列表补全</span><br></pre></td></tr></table></figure>

<ul>
<li>我们首先写sql，然后代码生成器</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 角色</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `role`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `role`(</span><br><span class="line">                           `id` <span class="type">char</span>(<span class="number">8</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">                           `name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;角色&#x27;</span>,</span><br><span class="line">                           `<span class="keyword">desc</span>` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;描述&#x27;</span>,</span><br><span class="line">                           <span class="keyword">primary</span> key (`id`)</span><br><span class="line">)engine <span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;角色&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role` <span class="keyword">values</span> (<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;系统管理员&#x27;</span>,<span class="string">&#x27;管理用户、角色权限&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role` <span class="keyword">values</span> (<span class="string">&#x27;00000001&#x27;</span>,<span class="string">&#x27;开发&#x27;</span>,<span class="string">&#x27;维护资源&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role` <span class="keyword">values</span> (<span class="string">&#x27;00000002&#x27;</span>,<span class="string">&#x27;业务管理员&#x27;</span>,<span class="string">&#x27;负责业务管理&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>admin增加</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;b class=&quot;arrow&quot;&gt;&lt;/b&gt;</span><br><span class="line">&lt;/li&gt;</span><br><span class="line"></span><br><span class="line">&lt;li class=&quot;&quot; id=&quot;system-role-sidebar&quot;&gt;</span><br><span class="line">  &lt;router-link to=&quot;/system/role&quot;&gt;</span><br><span class="line">    &lt;i class=&quot;menu-icon fa fa-caret-right&quot;&gt;&lt;/i&gt;</span><br><span class="line">    角色管理</span><br><span class="line">  &lt;/router-link&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改router.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">,&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;system/role&quot;</span>,</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&quot;system/role&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Role</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>另外我们把resource.js补全</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;01&quot;</span>,<span class="string">&quot;name&quot;</span>: <span class="string">&quot;系统管理&quot;</span>,</span><br><span class="line">    <span class="string">&quot;children&quot;</span>:[&#123;</span><br><span class="line">      <span class="string">&quot;id&quot;</span>:<span class="string">&quot;0101&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;用户管理&quot;</span>,<span class="string">&quot;page&quot;</span>:<span class="string">&quot;/system/user&quot;</span>,</span><br><span class="line">      <span class="string">&quot;children&quot;</span>:[</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;010101&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;保存&quot;</span>,<span class="string">&quot;request&quot;</span>:[<span class="string">&quot;/system/admin/user/list&quot;</span>,<span class="string">&quot;/system/admin/user/save&quot;</span>]&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;010102&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;删除&quot;</span>,<span class="string">&quot;request&quot;</span>:[<span class="string">&quot;/system/admin/user/delete&quot;</span>]&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;010103&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;重置密码&quot;</span>,<span class="string">&quot;request&quot;</span>:[<span class="string">&quot;/system/admin/user/save-password&quot;</span>]&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;id&quot;</span>:<span class="string">&quot;0102&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;资源管理&quot;</span>,<span class="string">&quot;page&quot;</span>:<span class="string">&quot;/system/resource&quot;</span>,</span><br><span class="line">      <span class="string">&quot;children&quot;</span>:[</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;010201&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;保存/显示&quot;</span>,<span class="string">&quot;request&quot;</span>:[<span class="string">&quot;/system/admin/resource&quot;</span>]&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>:<span class="string">&quot;0103&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;角色管理&quot;</span>,<span class="string">&quot;page&quot;</span>:<span class="string">&quot;/system/role&quot;</span>,</span><br><span class="line">        <span class="string">&quot;children&quot;</span>:[</span><br><span class="line">            &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;010301&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;角色/权限管理&quot;</span>,<span class="string">&quot;request&quot;</span>:[<span class="string">&quot;/system/admin/role&quot;</span>]&#125;</span><br><span class="line">          ]</span><br><span class="line">      &#125;]</span><br><span class="line">&#125;,&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;02&quot;</span>,<span class="string">&quot;name&quot;</span>: <span class="string">&quot;业务管理&quot;</span>,</span><br><span class="line">  <span class="string">&quot;children&quot;</span>:[&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>:<span class="string">&quot;0201&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;分类管理&quot;</span>,<span class="string">&quot;page&quot;</span>:<span class="string">&quot;/business/category&quot;</span>,</span><br><span class="line">    <span class="string">&quot;children&quot;</span>:[</span><br><span class="line">      &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;020101&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;增删改查&quot;</span>,<span class="string">&quot;request&quot;</span>:[<span class="string">&quot;/business/admin/category&quot;</span>]&#125;</span><br><span class="line">     ]</span><br><span class="line">  &#125;,&#123;</span><br><span class="line">      <span class="string">&quot;id&quot;</span>:<span class="string">&quot;0202&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;课程管理&quot;</span>,<span class="string">&quot;page&quot;</span>:<span class="string">&quot;/business/course&quot;</span>,</span><br><span class="line">      <span class="string">&quot;children&quot;</span>:[</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;020201&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;增删改查&quot;</span>,<span class="string">&quot;request&quot;</span>:[<span class="string">&quot;/business/admin/course&quot;</span>,<span class="string">&quot;/business/admin/category/all&quot;</span>]&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      <span class="string">&quot;id&quot;</span>:<span class="string">&quot;0203&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;讲师管理&quot;</span>,<span class="string">&quot;page&quot;</span>:<span class="string">&quot;/business/teacher&quot;</span>,</span><br><span class="line">      <span class="string">&quot;children&quot;</span>:[</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;020301&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;增删改查&quot;</span>,<span class="string">&quot;request&quot;</span>:[<span class="string">&quot;/business/admin/teacher&quot;</span>]&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;03&quot;</span>,<span class="string">&quot;name&quot;</span>: <span class="string">&quot;文件管理&quot;</span>,</span><br><span class="line">  <span class="string">&quot;children&quot;</span>:[&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>:<span class="string">&quot;0301&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;文件管理&quot;</span>,<span class="string">&quot;page&quot;</span>:<span class="string">&quot;/file/file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;children&quot;</span>:[</span><br><span class="line">      &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;030101&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;文件管理&quot;</span>,<span class="string">&quot;request&quot;</span>:[<span class="string">&quot;/file/admin/file&quot;</span>]&#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<p><strong>增加角色资源关联功能</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：增加角色资源关联表，生成持久层和服务端代码</span><br></pre></td></tr></table></figure>

<ul>
<li>首先添加sql,然后mybatis和server代码生成器，界面就用role的</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 角色<span class="operator">-</span>资源关联表</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `role_resource`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `role_resource`(</span><br><span class="line">                       `id` <span class="type">char</span>(<span class="number">8</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">                       `role_id` <span class="type">char</span>(<span class="number">8</span>) <span class="keyword">not</span> <span class="keyword">null</span>  comment <span class="string">&#x27;角色|id&#x27;</span>,</span><br><span class="line">                       `resource_id` <span class="type">char</span>(<span class="number">6</span>) <span class="keyword">not</span> <span class="keyword">null</span>  comment <span class="string">&#x27;资源|id&#x27;</span>,</span><br><span class="line">                       <span class="keyword">primary</span> key (`id`)</span><br><span class="line">)engine <span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;角色资源关联&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role_resource` <span class="keyword">values</span> (<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role_resource` <span class="keyword">values</span> (<span class="string">&#x27;00000001&#x27;</span>,<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;0101&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role_resource` <span class="keyword">values</span> (<span class="string">&#x27;00000002&#x27;</span>,<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;010101&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role_resource` <span class="keyword">values</span> (<span class="string">&#x27;00000003&#x27;</span>,<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;010102&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role_resource` <span class="keyword">values</span> (<span class="string">&#x27;00000004&#x27;</span>,<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;010103&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role_resource` <span class="keyword">values</span> (<span class="string">&#x27;00000005&#x27;</span>,<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;0102&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role_resource` <span class="keyword">values</span> (<span class="string">&#x27;00000006&#x27;</span>,<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;010201&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role_resource` <span class="keyword">values</span> (<span class="string">&#x27;00000007&#x27;</span>,<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;0103&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role_resource` <span class="keyword">values</span> (<span class="string">&#x27;00000008&#x27;</span>,<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;010301&#x27;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2.通用权限管理：点击【关联资源】按钮时，加载资源树</span><br></pre></td></tr></table></figure>

<ul>
<li><p>显示图片如下所示<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/24/nvjwr5k9myh7LNQ.png"
                      alt="image-20220324150010236"
                ></p>
</li>
<li><p>我们只修改role就行</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">//在操作那加一个按钮</span><br><span class="line">&lt;button v-on:click=&quot;editResource(role)&quot; class=&quot;btn btn-xs btn-info&quot;&gt;</span><br><span class="line">  &lt;i class=&quot;ace-icon fa fa-list bigger-120&quot;&gt;&lt;/i&gt;</span><br><span class="line">&lt;/button&gt;</span><br><span class="line">//增加一个模态框</span><br><span class="line">&lt;!-- 角色资源关联配置 --&gt;</span><br><span class="line">    &lt;div id=&quot;resource-modal&quot; class=&quot;modal fade&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;modal-content&quot;&gt;</span><br><span class="line">          &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">            &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;</span><br><span class="line">            &lt;h4 class=&quot;modal-title&quot;&gt;角色资源关联配置&lt;/h4&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">            &lt;ul id=&quot;tree&quot; class=&quot;ztree&quot;&gt;&lt;/ul&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class=&quot;modal-footer&quot;&gt;</span><br><span class="line">            &lt;button type=&quot;button&quot; class=&quot;btn btn-white btn-default btn-round&quot; data-dismiss=&quot;modal&quot;&gt;</span><br><span class="line">              &lt;i class=&quot;ace-icon fa fa-times&quot;&gt;&lt;/i&gt;</span><br><span class="line">              关闭</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">            &lt;button type=&quot;button&quot; class=&quot;btn btn-white btn-info btn-round&quot; v-on:click=&quot;saveResource()&quot;&gt;</span><br><span class="line">              &lt;i class=&quot;ace-icon fa fa-plus blue&quot;&gt;&lt;/i&gt;</span><br><span class="line">              保存</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;&lt;!-- /.modal-content --&gt;</span><br><span class="line">      &lt;/div&gt;&lt;!-- /.modal-dialog --&gt;</span><br><span class="line">    &lt;/div&gt;&lt;!-- /.modal --&gt;</span><br><span class="line">//在data中加两个对象</span><br><span class="line">    resource:[],</span><br><span class="line">      zTree:&#123;&#125;,</span><br><span class="line">//增加这几个方法</span><br><span class="line">/**</span><br><span class="line">     * 点击【编辑】</span><br><span class="line">     */</span><br><span class="line">    editResource(role) &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      _this.role = $.extend(&#123;&#125;, role);</span><br><span class="line">      _this.loadResource();</span><br><span class="line">      $(&quot;#resource-modal&quot;).modal(&quot;show&quot;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 加载资源树</span><br><span class="line">     */</span><br><span class="line">    loadResource() &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      Loading.show();</span><br><span class="line">      _this.$ajax.get(process.env.VUE_APP_SERVER + &#x27;/system/admin/resource/load-tree&#x27;).then((res)=&gt;&#123;</span><br><span class="line">        Loading.hide();</span><br><span class="line">        let response = res.data;</span><br><span class="line">        _this.resources = response.content;</span><br><span class="line">        // 初始化树</span><br><span class="line">        _this.initTree();</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 初始资源树</span><br><span class="line">     */</span><br><span class="line">    initTree() &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      let setting = &#123;</span><br><span class="line">        check: &#123;</span><br><span class="line">          enable: true</span><br><span class="line">        &#125;,</span><br><span class="line">        data: &#123;</span><br><span class="line">          simpleData: &#123;</span><br><span class="line">            idKey: &quot;id&quot;,</span><br><span class="line">            pIdKey: &quot;parent&quot;,</span><br><span class="line">            rootPId: &quot;&quot;,</span><br><span class="line">            enable: true</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      _this.zTree = $.fn.zTree.init($(&quot;#tree&quot;), setting, _this.resources);</span><br><span class="line">      _this.zTree.expandAll(true);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3.通用权限管理：点击资源树模态框【保存】按钮时，保存角色资源关联表</span><br></pre></td></tr></table></figure>

<ul>
<li><p>增加一个保存功能<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../../../AppData/Roaming/Typora/typora-user-images/image-20220324151335505.png"
                      alt="image-20220324151335505"
                ></p>
</li>
<li><p>现在role.vue中添加保存方法</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 资源模态框点击【保存】</span><br><span class="line"> */</span><br><span class="line">saveResource() &#123;</span><br><span class="line">  let _this = this;</span><br><span class="line">  let resources = _this.zTree.getCheckedNodes();</span><br><span class="line">  console.log(&quot;勾选的资源：&quot;, resources);</span><br><span class="line"></span><br><span class="line">  // 保存时，只需要保存资源id，所以使用id数组进行参数传递</span><br><span class="line">  let resourceIds = [];</span><br><span class="line">  for (let i = 0; i &lt; resources.length; i++) &#123;</span><br><span class="line">    resourceIds.push(resources[i].id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _this.$ajax.post(process.env.VUE_APP_SERVER + &#x27;/system/admin/role/save-resource&#x27;, &#123;</span><br><span class="line">    id: _this.role.id,</span><br><span class="line">    resourceIds: resourceIds</span><br><span class="line">  &#125;).then((response)=&gt;&#123;</span><br><span class="line">    let resp = response.data;</span><br><span class="line">    if (resp.success) &#123;</span><br><span class="line">      Toast.success(&quot;保存成功!&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      Toast.warning(resp.message);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>再在roledto增加字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;String&gt; resourceIds;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来修改RoleController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存资源</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roleDto</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/save-resource&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">saveResource</span><span class="params">(<span class="meta">@RequestBody</span> RoleDto roleDto)</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;保存角色资源关联开始&quot;</span>);</span><br><span class="line">    ResponseDto&lt;RoleDto&gt; responseDto = <span class="keyword">new</span> <span class="title class_">ResponseDto</span>&lt;&gt;();</span><br><span class="line">    roleService.saveResource(roleDto);</span><br><span class="line">    responseDto.setContent(roleDto);</span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改RoleService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RoleResourceMapper roleResourceMapper;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按角色保存资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveResource</span><span class="params">(RoleDto roleDto)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">roleId</span> <span class="operator">=</span> roleDto.getId();</span><br><span class="line">        List&lt;String&gt; resourceIds = roleDto.getResourceIds();</span><br><span class="line">        <span class="comment">// 清空库中所有的当前角色下的记录</span></span><br><span class="line">        <span class="type">RoleResourceExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RoleResourceExample</span>();</span><br><span class="line">        example.createCriteria().andRoleIdEqualTo(roleId);</span><br><span class="line">        roleResourceMapper.deleteByExample(example);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存角色资源</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; resourceIds.size(); i++) &#123;</span><br><span class="line">            <span class="type">RoleResource</span> <span class="variable">roleResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RoleResource</span>();</span><br><span class="line">            roleResource.setId(UuidUtil.getShortUuid());</span><br><span class="line">            roleResource.setRoleId(roleId);</span><br><span class="line">            roleResource.setResourceId(resourceIds.get(i));</span><br><span class="line">            roleResourceMapper.insert(roleResource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4.通用权限管理：打开资源树模态框时，加载角色资源关联数据，并自动勾选树节点</span><br></pre></td></tr></table></figure>

<ul>
<li><p>批量操作的思路：先将原有的删除，再批量新增</p>
</li>
<li><p>首先修改role.vue</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">//在loadResource方法初始化树后加载资源</span><br><span class="line">// 初始化树</span><br><span class="line">_this.initTree();</span><br><span class="line">_this.listRoleResource();</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">     * 加载角色资源关联记录</span><br><span class="line">     */</span><br><span class="line">    listRoleResource() &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      _this.$ajax.get(process.env.VUE_APP_SERVER + &#x27;/system/admin/role/list-resource/&#x27; + _this.role.id).then((response)=&gt;&#123;</span><br><span class="line">        let resp = response.data;</span><br><span class="line">        let resources = resp.content;</span><br><span class="line"></span><br><span class="line">        // 勾选查询到的资源：先把树的所有节点清空勾选，再勾选查询到的节点</span><br><span class="line">        _this.zTree.checkAllNodes(false);</span><br><span class="line">        for (let i = 0; i &lt; resources.length; i++) &#123;</span><br><span class="line">          let node = _this.zTree.getNodeByParam(&quot;id&quot;, resources[i]);</span><br><span class="line">          _this.zTree.checkNode(node, true);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来在RoleController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载已关联的资源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list-resource/&#123;roleId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">listResource</span><span class="params">(<span class="meta">@PathVariable</span> String roleId)</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;加载资源开始&quot;</span>);</span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; resourceIdList = roleService.listResource(roleId);</span><br><span class="line">    responseDto.setContent(resourceIdList);</span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后在RoleService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按角色加载资源</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roleId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;String&gt; <span class="title function_">listResource</span><span class="params">(String roleId)</span> &#123;</span><br><span class="line">    <span class="type">RoleResourceExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RoleResourceExample</span>();</span><br><span class="line">    example.createCriteria().andRoleIdEqualTo(roleId);</span><br><span class="line">    List&lt;RoleResource&gt; roleResourceList = roleResourceMapper.selectByExample(example);</span><br><span class="line">    List&lt;String&gt; resourceIdList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, l = roleResourceList.size(); i &lt; l; i++) &#123;</span><br><span class="line">        resourceIdList.add(roleResourceList.get(i).getResourceId());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resourceIdList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>增加角色用户关联功能</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：增加角色用户关联表，生成持久层和服务端代码</span><br></pre></td></tr></table></figure>

<ul>
<li>首先建立sql，然后代码生成器</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 角色<span class="operator">-</span>用户关联表</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `role_user`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `role_user`(</span><br><span class="line">                                `id` <span class="type">char</span>(<span class="number">8</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">                                `role_id` <span class="type">char</span>(<span class="number">8</span>) <span class="keyword">not</span> <span class="keyword">null</span>  comment <span class="string">&#x27;角色|id&#x27;</span>,</span><br><span class="line">                                `user_id` <span class="type">char</span>(<span class="number">8</span>) <span class="keyword">not</span> <span class="keyword">null</span>  comment <span class="string">&#x27;用户|id&#x27;</span>,</span><br><span class="line">                                <span class="keyword">primary</span> key (`id`)</span><br><span class="line">)engine <span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;角色用户关联&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> `role_user` <span class="keyword">values</span> (<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;00000000&#x27;</span>,<span class="string">&#x27;10000000&#x27;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2.通用权限管理：点击【关联用户】按钮时，加载所有用户</span><br></pre></td></tr></table></figure>

<ul>
<li><p>加一个按钮显示这样的界面<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/24/SXptR8sDVfA1rQ9.png"
                      alt="image-20220324171309337"
                ></p>
</li>
<li><p>只需要修改role.vue</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">//增加用户按钮</span><br><span class="line">&lt;button v-on:click=&quot;editUser(role)&quot; class=&quot;btn btn-xs btn-info&quot;&gt;</span><br><span class="line">  &lt;i class=&quot;ace-icon fa fa-user bigger-120&quot;&gt;&lt;/i&gt;</span><br><span class="line">&lt;/button&gt;</span><br><span class="line">//增加一个模态框</span><br><span class="line"> &lt;!-- 角色用户关联配置 --&gt;</span><br><span class="line">    &lt;div id=&quot;user-modal&quot; class=&quot;modal fade&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;modal-content&quot;&gt;</span><br><span class="line">          &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">            &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;</span><br><span class="line">            &lt;h4 class=&quot;modal-title&quot;&gt;角色用户关联配置&lt;/h4&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">              &lt;div class=&quot;col-md-6&quot;&gt;</span><br><span class="line">                &lt;table id=&quot;user-table&quot; class=&quot;table table-hover&quot;&gt;</span><br><span class="line">                  &lt;tbody&gt;</span><br><span class="line">                  &lt;tr v-for=&quot;user in users&quot;&gt;</span><br><span class="line">                    &lt;td&gt;&#123;&#123;user.loginName&#125;&#125;&lt;/td&gt;</span><br><span class="line">                    &lt;td class=&quot;text-right&quot;&gt;</span><br><span class="line">                      &lt;a  href=&quot;javascript:;&quot; class=&quot;&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;ace-icon fa fa-arrow-circle-right blue&quot;&gt;&lt;/i&gt;</span><br><span class="line">                      &lt;/a&gt;</span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                  &lt;/tr&gt;</span><br><span class="line">                  &lt;/tbody&gt;</span><br><span class="line">                &lt;/table&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">              &lt;div class=&quot;col-md-6&quot;&gt;</span><br><span class="line">                &lt;table id=&quot;role-user-table&quot; class=&quot;table table-hover&quot;&gt;</span><br><span class="line">                  &lt;tbody&gt;</span><br><span class="line">                  &lt;tr v-for=&quot;user in roleUsers&quot;&gt;</span><br><span class="line">                    &lt;td&gt;&#123;&#123;user.loginName&#125;&#125;&lt;/td&gt;</span><br><span class="line">                    &lt;td class=&quot;text-right&quot;&gt;</span><br><span class="line">                      &lt;a v-on:click=&quot;deleteUser(user)&quot; href=&quot;javascript:;&quot; class=&quot;&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;ace-icon fa fa-trash blue&quot;&gt;&lt;/i&gt;</span><br><span class="line">                      &lt;/a&gt;</span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                  &lt;/tr&gt;</span><br><span class="line">                  &lt;/tbody&gt;</span><br><span class="line">                &lt;/table&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class=&quot;modal-footer&quot;&gt;</span><br><span class="line">            &lt;button type=&quot;button&quot; class=&quot;btn btn-white btn-default btn-round&quot; data-dismiss=&quot;modal&quot;&gt;</span><br><span class="line">              &lt;i class=&quot;ace-icon fa fa-times&quot;&gt;&lt;/i&gt;</span><br><span class="line">              关闭</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">            &lt;button type=&quot;button&quot; class=&quot;btn btn-white btn-info btn-round&quot; v-on:click=&quot;saveUser()&quot;&gt;</span><br><span class="line">              &lt;i class=&quot;ace-icon fa fa-plus blue&quot;&gt;&lt;/i&gt;</span><br><span class="line">              保存</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;&lt;!-- /.modal-content --&gt;</span><br><span class="line">      &lt;/div&gt;&lt;!-- /.modal-dialog --&gt;</span><br><span class="line">    &lt;/div&gt;&lt;!-- /.modal --&gt;</span><br><span class="line">//data中增加</span><br><span class="line">users:[],</span><br><span class="line">roleUsers:[]</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">     * 点击【用户】</span><br><span class="line">     */</span><br><span class="line">    editUser(role) &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      _this.role = $.extend(&#123;&#125;, role);</span><br><span class="line">      _this.listUser();</span><br><span class="line">      $(&quot;#user-modal&quot;).modal(&quot;show&quot;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 查询所有用户</span><br><span class="line">     */</span><br><span class="line">    listUser() &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      _this.$ajax.post(process.env.VUE_APP_SERVER + &#x27;/system/admin/user/list&#x27;, &#123;</span><br><span class="line">        page: 1,</span><br><span class="line">        size: 9999</span><br><span class="line">      &#125;).then((response)=&gt;&#123;</span><br><span class="line">        let resp = response.data;</span><br><span class="line">        if (resp.success) &#123;</span><br><span class="line">          _this.users = resp.content.list;</span><br><span class="line">          console.log(_this.users);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          Toast.warning(resp.message);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3.通用权限管理：点击用户模态框【保存】按钮时，保存角色用户关联表</span><br></pre></td></tr></table></figure>

<ul>
<li><p>增加一个这样的功能<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../../../AppData/Roaming/Typora/typora-user-images/image-20220324173001257.png"
                      alt="image-20220324173001257"
                ></p>
</li>
<li><p>依赖vue的双向数据绑定特性，可以将复杂的页面操作变成，简单的数据操作。很多前端框架都有双向数据绑定的特性，比如angular，微信小程序</p>
</li>
<li><p>先修改role.vue</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">//分别修改右边和左边的模态框</span><br><span class="line">&lt;a v-on:click=&quot;addUser(user)&quot; href=&quot;javascript:;&quot; class=&quot;&quot;&gt;</span><br><span class="line">&lt;a v-on:click=&quot;deleteUser(user)&quot; href=&quot;javascript:;&quot; class=&quot;&quot;&gt;</span><br><span class="line">//增加对应方法，最后一个方法是保存时候的</span><br><span class="line"> /**</span><br><span class="line">     * 角色中增加用户</span><br><span class="line">     */</span><br><span class="line">    addUser(user) &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line"></span><br><span class="line">      // 如果当前要添加的用户在右边列表中已经有了，则不用再添加</span><br><span class="line">      let users = _this.roleUsers;</span><br><span class="line">      for (let i = 0; i &lt; users.length; i++) &#123;</span><br><span class="line">        if (user === users[i]) &#123;</span><br><span class="line">          return;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      _this.roleUsers.push(user);</span><br><span class="line">    &#125;,</span><br><span class="line">    /**</span><br><span class="line">     * 角色中删除用户</span><br><span class="line">     */</span><br><span class="line">    deleteUser(user) &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      Tool.removeObj(_this.roleUsers, user);</span><br><span class="line">    &#125;,</span><br><span class="line">    /**</span><br><span class="line">     * 角色用户模态框点击【保存】</span><br><span class="line">     */</span><br><span class="line">    saveUser() &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      let users = _this.roleUsers;</span><br><span class="line"></span><br><span class="line">      // 保存时，只需要保存用户id，所以使用id数组进行参数传递</span><br><span class="line">      let userIds = [];</span><br><span class="line">      for (let i = 0; i &lt; users.length; i++) &#123;</span><br><span class="line">        userIds.push(users[i].id);</span><br><span class="line">      &#125;</span><br><span class="line">      _this.$ajax.post(process.env.VUE_APP_SERVER + &#x27;/system/admin/role/save-user&#x27;, &#123;</span><br><span class="line">        id: _this.role.id,</span><br><span class="line">        userIds: userIds</span><br><span class="line">      &#125;).then((response)=&gt;&#123;</span><br><span class="line">        console.log(&quot;保存角色用户结果：&quot;, response);</span><br><span class="line">        let resp = response.data;</span><br><span class="line">        if (resp.success) &#123;</span><br><span class="line">          Toast.success(&quot;保存成功!&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          Toast.warning(resp.message);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>我们接下来要修改RoleDto</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//增加这个</span></span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; userIds;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来RoleController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roleDto</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/save-user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">saveUser</span><span class="params">(<span class="meta">@RequestBody</span> RoleDto roleDto)</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;保存角色用户关联开始&quot;</span>);</span><br><span class="line">    ResponseDto&lt;RoleDto&gt; responseDto = <span class="keyword">new</span> <span class="title class_">ResponseDto</span>&lt;&gt;();</span><br><span class="line">    roleService.saveUser(roleDto);</span><br><span class="line">    responseDto.setContent(roleDto);</span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改RoleService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RoleUserMapper roleUserMapper;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按角色保存用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(RoleDto roleDto)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">roleId</span> <span class="operator">=</span> roleDto.getId();</span><br><span class="line">        List&lt;String&gt; userIdList = roleDto.getUserIds();</span><br><span class="line">        <span class="comment">// 清空库中所有的当前角色下的记录</span></span><br><span class="line">        <span class="type">RoleUserExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RoleUserExample</span>();</span><br><span class="line">        example.createCriteria().andRoleIdEqualTo(roleId);</span><br><span class="line">        roleUserMapper.deleteByExample(example);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存角色用户</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; userIdList.size(); i++) &#123;</span><br><span class="line">            <span class="type">RoleUser</span> <span class="variable">roleUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RoleUser</span>();</span><br><span class="line">            roleUser.setId(UuidUtil.getShortUuid());</span><br><span class="line">            roleUser.setRoleId(roleId);</span><br><span class="line">            roleUser.setUserId(userIdList.get(i));</span><br><span class="line">            roleUserMapper.insert(roleUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4.通用权限管理：打开用户模态框时，加载角色用户关联数据</span><br></pre></td></tr></table></figure>

<ul>
<li><p>查关联表，得到的是userld，但是显示需要的是loginName。这里也可以通过写自定义mapper，把user表和role_user表关联得到loginName</p>
</li>
<li><p>首先修改role.vue</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">//在listUser中成功时添加</span><br><span class="line"> _this.listRoleUser();</span><br><span class="line"> /**</span><br><span class="line">     * 加载角色用户</span><br><span class="line">     */</span><br><span class="line">    listRoleUser() &#123;</span><br><span class="line">      let _this = this;</span><br><span class="line">      _this.roleUsers = [];</span><br><span class="line">      _this.$ajax.get(process.env.VUE_APP_SERVER + &#x27;/system/admin/role/list-user/&#x27; + _this.role.id).then((res)=&gt;&#123;</span><br><span class="line">        let response = res.data;</span><br><span class="line">        let userIds = response.content;</span><br><span class="line"></span><br><span class="line">        // 根据加载到用户ID，到【所有用户数组：users】中查找用户对象，用于列表显示</span><br><span class="line">        for (let i = 0; i &lt; userIds.length; i++) &#123;</span><br><span class="line">          for (let j = 0; j &lt; _this.users.length; j++) &#123;</span><br><span class="line">            if (userIds[i] === _this.users[j].id) &#123;</span><br><span class="line">              _this.roleUsers.push(_this.users[j]);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>然后修改RoleController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roleId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list-user/&#123;roleId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">listUser</span><span class="params">(<span class="meta">@PathVariable</span> String roleId)</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;加载用户开始&quot;</span>);</span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; userIdList = roleService.listUser(roleId);</span><br><span class="line">    responseDto.setContent(userIdList);</span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改RoleService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按角色加载用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roleId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;String&gt; <span class="title function_">listUser</span><span class="params">(String roleId)</span> &#123;</span><br><span class="line">    <span class="type">RoleUserExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RoleUserExample</span>();</span><br><span class="line">    example.createCriteria().andRoleIdEqualTo(roleId);</span><br><span class="line">    List&lt;RoleUser&gt; roleUserList = roleUserMapper.selectByExample(example);</span><br><span class="line">    List&lt;String&gt; userIdList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, l = roleUserList.size(); i &lt; l; i++) &#123;</span><br><span class="line">        userIdList.add(roleUserList.get(i).getUserId());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userIdList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="12-4-登录时获取资源权限"><a href="#12-4-登录时获取资源权限" class="headerlink" title="12-4 登录时获取资源权限"></a>12-4 登录时获取资源权限</h2><p><strong>读取当前登录用户所属的角色的所有资源</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：登录时，读取当前登录用户所属的角色的所有资源</span><br></pre></td></tr></table></figure>

<ul>
<li><p>一个资源可以会用到多个接口，多个资源的接口就可能重复，所以这里用Set去重</p>
</li>
<li><p>在LoginUserDto中增加</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 所有资源用于前端界面控制</span><br><span class="line"> */</span><br><span class="line">private List&lt;ResourceDto&gt; resources;</span><br><span class="line">/**</span><br><span class="line"> * 所有资源中的请求，用于后端接口拦截</span><br><span class="line"> */</span><br><span class="line">private HashSet&lt;String&gt; requests;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>关于User的权限设置比较细，每个请求接口都可以单独控制。关于Resource的权限设置比较粗，所有接口用同一个request控制</p>
</li>
<li><p>在com.course.server.mapper.my下建立MyUserMapper.xml</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.course.server.mapper.my.MyUserMapper&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 一个用户可以属于多个角色，配置的资源可能重复，所以用distinct去重 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findResources&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.course.server.dto.ResourceDto&quot;</span>&gt;</span></span><br><span class="line">        select distinct r.id, r.`name`, r.page, r.request, r.parent</span><br><span class="line">        from role_user ru, role_resource rr, resource r</span><br><span class="line">        where ru.user_id = #&#123;userId&#125;</span><br><span class="line">        and ru.role_id = rr.role_id</span><br><span class="line">        and rr.resource_id = r.id</span><br><span class="line">        order by r.id asc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后再com.course.server.mapper.my下建立MyUserMapper.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.server.mapper.my;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.course.server.dto.ResourceDto;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyUserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;ResourceDto&gt; <span class="title function_">findResources</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> String userId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后我们修改UserService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为登录用户读取权限</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setAuth</span><span class="params">(LoginUserDto loginUserDto)</span> &#123;</span><br><span class="line">    List&lt;ResourceDto&gt; resourceDtoList = myUserMapper.findResources(loginUserDto.getId());</span><br><span class="line">    loginUserDto.setResources(resourceDtoList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 整理所有有权限的请求，用于接口拦截</span></span><br><span class="line">    HashSet&lt;String&gt; requestSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(resourceDtoList)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, l = resourceDtoList.size(); i &lt; l; i++) &#123;</span><br><span class="line">            <span class="type">ResourceDto</span> <span class="variable">resourceDto</span> <span class="operator">=</span> resourceDtoList.get(i);</span><br><span class="line">            <span class="type">String</span> <span class="variable">arrayString</span> <span class="operator">=</span> resourceDto.getRequest();</span><br><span class="line">            List&lt;String&gt; requestList = JSON.parseArray(arrayString, String.class);</span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(requestList)) &#123;</span><br><span class="line">                requestSet.addAll(requestList);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;有权限的请求：&#123;&#125;&quot;</span>, requestSet);</span><br><span class="line">    loginUserDto.setRequests(requestSet);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//最后使用这个在login方法</span></span><br><span class="line">    <span class="keyword">public</span> LoginUserDto <span class="title function_">login</span><span class="params">(UserDto userDto)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> selectByLoginName((userDto.getLoginName()));</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;用户名不存在,&#123;&#125;&quot;</span>,userDto.getLoginName());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionCode.LOGIN_ERROR);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (user.getPassword().equals(userDto.getPassword()))&#123;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////</span></span><br><span class="line">                <span class="comment">//登陆成功</span></span><br><span class="line">                <span class="type">LoginUserDto</span> <span class="variable">loginUserDto</span> <span class="operator">=</span> CopyUtil.copy(user,LoginUserDto.class);</span><br><span class="line">                <span class="comment">//为登录用户获取权限</span></span><br><span class="line">                setAuth(loginUserDto);</span><br><span class="line">                <span class="keyword">return</span> loginUserDto;</span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;密码不对,输入密码:&#123;&#125;,数据库密码:&#123;&#125;&quot;</span>,userDto.getPassword(),user.getPassword());</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionCode.LOGIN_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>修复讲师管理显示错位的BUG</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：修复讲师管理显示错位的BUG.自定义样式要加上前缀，防止冲突，vue组件样式加scoped</span><br></pre></td></tr></table></figure>

<ul>
<li>问题：讲师管理页面，讲师的显示重叠在一起了。但是这个页面已经很久没动过了。之前介绍讲师管理时，都是确认了页面正常才提交的代码。不知道从什么时候开始出现这个BUG？</li>
<li>css样式的问题，可以优先用F12开发者工具来查看没有可疑的样式</li>
<li>前端常见问题：引入新的css文件后，导致原有页面显示错乱</li>
<li>写自定义样式的时候！不要用通用的单词，很容易和别人的样式出现冲突，可以给样式加上一些固定的，有意义的前缀</li>
<li>解决方法：为每个样式加一个“aliplayer前缀！或者加一个顶级的”.aliplayer”样式</li>
</ul>
<h2 id="12-5-权限拦截功能开发"><a href="#12-5-权限拦截功能开发" class="headerlink" title="12-5 权限拦截功能开发"></a>12-5 权限拦截功能开发</h2><p><strong>前端界面权限拦截</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：前端界面权限拦截，完成用户管理</span><br></pre></td></tr></table></figure>

<ul>
<li><p>目前只修改了用户管理的权限拦截，以用户管理为例</p>
</li>
<li><p>每次修改权限配置，需要重新登录后才生效</p>
</li>
<li><p>我们首先在tool.js增加方法</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查找是否有权限</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> id 资源id</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">hasResource</span>: <span class="keyword">function</span> (<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> _this = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">let</span> resources = _this.<span class="title function_">getLoginUser</span>().<span class="property">resources</span>;</span><br><span class="line">    <span class="keyword">if</span> (_this.<span class="title function_">isEmpty</span>(resources)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; resources.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (id === resources[i].<span class="property">id</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来修改admin</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//在html中要使用vue方法，这个方法得在methods中定义</span><br><span class="line">/**</span><br><span class="line"> * 查找是否有权限</span><br><span class="line"> * @param id</span><br><span class="line"> */</span><br><span class="line">hasResource(id) &#123;</span><br><span class="line">  return Tool.hasResource(id);</span><br><span class="line">&#125;,</span><br><span class="line">//使用的话就在li里加v-show</span><br><span class="line"> &lt;li v-show=&quot;hasResource(&#x27;0101&#x27;)&quot; class=&quot;&quot; id=&quot;system-user-sidebar&quot;&gt;</span><br><span class="line">               &lt;router-link to=&quot;/system/user&quot;&gt;</span><br><span class="line">                  &lt;i class=&quot;menu-icon fa fa-caret-right&quot;&gt;&lt;/i&gt;</span><br><span class="line">                  用户管理</span><br><span class="line">               &lt;/router-link&gt;</span><br><span class="line"></span><br><span class="line">                &lt;b class=&quot;arrow&quot;&gt;&lt;/b&gt;</span><br><span class="line">              &lt;/li&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>user修改也一样</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2.通用权限管理：前端界面权限拦截，完成所有界面控制</span><br></pre></td></tr></table></figure>

<ul>
<li>如果一个页面的所有按钮是统一控制的那么只需要控制菜单就可以了，不需要给每个按钮加权限控制代码</li>
<li>就是给admin其他菜单加上v-show</li>
</ul>
<p><strong>路由权限判断</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：前端界面权限拦截，增加路由权限判断</span><br></pre></td></tr></table></figure>

<ul>
<li>因为我们前端的路由是不带&#x2F;的所以我们修改resource.json</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;00&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;欢迎&quot;</span><span class="punctuation">,</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="string">&quot;welcome&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;01&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;系统管理&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;0101&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;用户管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span><span class="string">&quot;system/user&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;010101&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;保存&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/system/admin/user/list&quot;</span><span class="punctuation">,</span><span class="string">&quot;/system/admin/user/save&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;010102&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;删除&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/system/admin/user/delete&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;010103&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;重置密码&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/system/admin/user/save-password&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;0102&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;资源管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span><span class="string">&quot;system/resource&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;010201&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;保存/显示&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/system/admin/resource&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;0103&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;角色管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span><span class="string">&quot;system/role&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;010301&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;角色/权限管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/system/admin/role&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;02&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;业务管理&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;0201&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;分类管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span><span class="string">&quot;business/category&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;020101&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;增删改查&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/business/admin/category&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;0202&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;课程管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span><span class="string">&quot;business/course&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;020201&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;增删改查&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/business/admin/course&quot;</span><span class="punctuation">,</span><span class="string">&quot;/business/admin/category/all&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;0203&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;讲师管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span><span class="string">&quot;business/teacher&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;020301&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;增删改查&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/business/admin/teacher&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;03&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;文件管理&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;0301&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;文件管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span><span class="string">&quot;file/file&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;030101&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;文件管理&quot;</span><span class="punctuation">,</span><span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/file/admin/file&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改admin</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 查找是否有权限</span><br><span class="line"> * @param router</span><br><span class="line"> */</span><br><span class="line">hasResourceRouter(router) &#123;</span><br><span class="line">  let _this = this;</span><br><span class="line">  let resources = Tool.getLoginUser().resources;</span><br><span class="line">  if (Tool.isEmpty(resources)) &#123;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line">  for (let i = 0; i &lt; resources.length; i++) &#123;</span><br><span class="line">    if (router === resources[i].page) &#123;</span><br><span class="line">      return true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return false;</span><br><span class="line">&#125;,</span><br><span class="line">//在mounted使用，第一次加载amin.vue时，需要判断路由权限。比如从登录页跳到控台主页，或者刷新控台主页时，会执行mounted</span><br><span class="line">if (!_this.hasResourceRouter(_this.$route.name)) &#123;</span><br><span class="line">      _this.$router.push(&quot;/login&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">//进入控台主页后，发生子路由跳转时，会触发watch</span><br><span class="line"> if (!_this.hasResourceRouter(val.name)) &#123;</span><br><span class="line">          _this.$router.push(&quot;/login&quot;);</span><br><span class="line">          return;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><strong>后端接口权限判断</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.通用权限管理：增加后端接口权限拦截</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在做登录功能时，我们也对接口做了登录校验，否则容易被绕开登录，直接调用后端接口。这里同样需要对接口做权限拦截</p>
</li>
<li><p>比如资源的保存：path&#x3D;system&#x2F;admin&#x2F;resource&#x2F;save，而配置的request&#x3D;system&#x2F;admin&#x2F;resource，那么path.contain(request)就是true</p>
</li>
<li><p>可以在vue的拦截器中，针对401返回码做判断，如果是401，就跳到登录页面</p>
</li>
<li><p>我们修改LoginAdminGatewayFilter</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在已登录这进行判断</span></span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;已登录:&#123;&#125;&quot;</span>,object);</span><br><span class="line">    <span class="comment">// 增加权限校验，gateway里没有LoginUserDto，所以全部用JSON操作</span></span><br><span class="line">    LOG.info(<span class="string">&quot;接口权限校验，请求地址：&#123;&#125;&quot;</span>, path);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">exist</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">loginUserDto</span> <span class="operator">=</span> JSON.parseObject(String.valueOf(object));</span><br><span class="line">    redisTemplate.opsForValue().set(token, JSON.toJSONString(loginUserDto), <span class="number">3600</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="type">JSONArray</span> <span class="variable">requests</span> <span class="operator">=</span> loginUserDto.getJSONArray(<span class="string">&quot;requests&quot;</span>);</span><br><span class="line">    <span class="comment">// 遍历所有【权限请求】，判断当前请求的地址是否在【权限请求】里</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, l = requests.size(); i &lt; l; i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">request</span> <span class="operator">=</span> (String) requests.get(i);</span><br><span class="line">        <span class="keyword">if</span> (path.contains(request)) &#123;</span><br><span class="line">            exist = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (exist) &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;权限校验通过&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;权限校验未通过&quot;</span>);</span><br><span class="line">        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">John Doe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2022/03/07/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%204-1/">http://example.com/2022/03/07/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%204-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE/">完整项目</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/03/15/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%204-2/"><img class="prev-cover" src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">完整项目之Spring Cloud + Vue 前后端分离4-2</div></div></a></div><div class="next-post pull-right"><a href="/2022/02/25/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%203-2/"><img class="next-cover" src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">完整项目之Spring Cloud + Vue 前后端分离3-2</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/02/07/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%202-1/" title="完整项目之Spring Cloud + Vue 前后端分离2-1"><img class="cover" src="/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-07</div><div class="title">完整项目之Spring Cloud + Vue 前后端分离2-1</div></div></a></div><div><a href="/2022/02/15/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%202-2/" title="完整项目之Spring Cloud + Vue 前后端分离2-2"><img class="cover" src="/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-15</div><div class="title">完整项目之Spring Cloud + Vue 前后端分离2-2</div></div></a></div><div><a href="/2022/02/20/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%203-1/" title="完整项目之Spring Cloud + Vue 前后端分离3-1"><img class="cover" src="/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-20</div><div class="title">完整项目之Spring Cloud + Vue 前后端分离3-1</div></div></a></div><div><a href="/2022/02/25/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%203-2/" title="完整项目之Spring Cloud + Vue 前后端分离3-2"><img class="cover" src="/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-25</div><div class="title">完整项目之Spring Cloud + Vue 前后端分离3-2</div></div></a></div><div><a href="/2022/03/20/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%205/" title="完整项目之Spring Cloud + Vue 前后端分离5"><img class="cover" src="/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-20</div><div class="title">完整项目之Spring Cloud + Vue 前后端分离5</div></div></a></div><div><a href="/2022/03/15/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%204-2/" title="完整项目之Spring Cloud + Vue 前后端分离4-2"><img class="cover" src="/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-15</div><div class="title">完整项目之Spring Cloud + Vue 前后端分离4-2</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">John Doe</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">307</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC11%E7%AB%A0-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E4%B8%8E%E7%99%BB%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">第11章 用户管理与登录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-%E5%A2%9E%E5%8A%A0%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.</span> <span class="toc-text">11-1 增加用户管理功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2-%E5%AF%86%E7%A0%81%E7%9A%84%E5%8A%A0%E5%AF%86%E4%BC%A0%E8%BE%93%E4%B8%8E%E5%8A%A0%E5%AF%86%E5%AD%98%E5%82%A8"><span class="toc-number">1.2.</span> <span class="toc-text">11-2 密码的加密传输与加密存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-3-%E5%9F%BA%E6%9C%AC%E7%9A%84%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="toc-number">1.3.</span> <span class="toc-text">11-3 基本的登录功能开发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-4-%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95%E4%B8%8E%E8%AE%B0%E4%BD%8F%E7%99%BB%E5%BD%95"><span class="toc-number">1.4.</span> <span class="toc-text">11-4 退出登录与记住登录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-5-%E5%A2%9E%E5%8A%A0%E7%99%BB%E5%BD%95%E5%9B%BE%E5%BD%A2%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">1.5.</span> <span class="toc-text">11-5 增加登录图形验证码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-6-%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="toc-number">1.6.</span> <span class="toc-text">11-6 单点登录功能开发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-7-%E5%89%8D%E5%90%8E%E7%AB%AF%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA"><span class="toc-number">1.7.</span> <span class="toc-text">11-7 前后端登录拦截</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-8-%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.8.</span> <span class="toc-text">11-8 用户登录流程图</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC12%E7%AB%A0-%E9%80%9A%E7%94%A8%E6%9D%83%E9%99%90%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.</span> <span class="toc-text">第12章 通用权限设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#12-1-%E9%80%9A%E7%94%A8%E6%9D%83%E9%99%90%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">12-1 通用权限解决方案介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-2-%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">12-2 资源配置管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-3%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">12-3角色权限管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-4-%E7%99%BB%E5%BD%95%E6%97%B6%E8%8E%B7%E5%8F%96%E8%B5%84%E6%BA%90%E6%9D%83%E9%99%90"><span class="toc-number">2.4.</span> <span class="toc-text">12-4 登录时获取资源权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-5-%E6%9D%83%E9%99%90%E6%8B%A6%E6%88%AA%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="toc-number">2.5.</span> <span class="toc-text">12-5 权限拦截功能开发</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/07/31/Redis%E4%B9%8B%E5%B0%8F%E8%BF%9B%E9%98%B6/" title="Redis之小进阶"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis之小进阶"/></a><div class="content"><a class="title" href="/2022/07/31/Redis%E4%B9%8B%E5%B0%8F%E8%BF%9B%E9%98%B6/" title="Redis之小进阶">Redis之小进阶</a><time datetime="2022-07-31T06:56:48.000Z" title="Created 2022-07-31 14:56:48">2022-07-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/31/Redis%E4%B9%8BJava/" title="Redis之Java"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis之Java"/></a><div class="content"><a class="title" href="/2022/07/31/Redis%E4%B9%8BJava/" title="Redis之Java">Redis之Java</a><time datetime="2022-07-31T06:47:34.000Z" title="Created 2022-07-31 14:47:34">2022-07-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/31/Redis%E4%B9%8B%E4%BA%8B%E5%8A%A1/" title="Redis之事务"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis之事务"/></a><div class="content"><a class="title" href="/2022/07/31/Redis%E4%B9%8B%E4%BA%8B%E5%8A%A1/" title="Redis之事务">Redis之事务</a><time datetime="2022-07-31T06:46:19.000Z" title="Created 2022-07-31 14:46:19">2022-07-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/31/Redis%E4%B9%8B%E4%B8%89%E7%A7%8D%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" title="Redis之三种特殊数据类型"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis之三种特殊数据类型"/></a><div class="content"><a class="title" href="/2022/07/31/Redis%E4%B9%8B%E4%B8%89%E7%A7%8D%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" title="Redis之三种特殊数据类型">Redis之三种特殊数据类型</a><time datetime="2022-07-31T06:40:15.000Z" title="Created 2022-07-31 14:40:15">2022-07-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/31/Redis%E4%B9%8B%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" title="Redis之五大数据类型"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis之五大数据类型"/></a><div class="content"><a class="title" href="/2022/07/31/Redis%E4%B9%8B%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" title="Redis之五大数据类型">Redis之五大数据类型</a><time datetime="2022-07-31T06:25:38.000Z" title="Created 2022-07-31 14:25:38">2022-07-31</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By John Doe</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>