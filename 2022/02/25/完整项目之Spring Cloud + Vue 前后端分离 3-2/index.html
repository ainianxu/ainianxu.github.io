<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Fang">
    
    <title>
        
            完整项目之Spring Cloud + Vue 前后端分离3-2 |
        
        念~旭
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/favicon.ico","favicon":"/images/favicon.ico","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"进来就别走了！"},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.4"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                念~旭
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                LINKS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">LINKS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">完整项目之Spring Cloud + Vue 前后端分离3-2</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/favicon.ico">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Fang</span>
                        
                            <span class="author-label">Lv6</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2022-02-25 12:19:22</span>
        <span class="mobile">2022-02-25 12:19</span>
    </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE/">完整项目</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>11.5k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>57 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="第9章-大文件断点续与极速秒传"><a href="#第9章-大文件断点续与极速秒传" class="headerlink" title="第9章 大文件断点续与极速秒传"></a>第9章 大文件断点续与极速秒传</h1><p>本章将在上一章的基础上增加大文件断点续传功能。作为一个视频网站，一个文件从几十M到上G，上传一个大文件受网络影响很大，一次上传成功的几率很小，为此我们会在本章完善文件上传功能，支持断点续传并且上传文件时，检查文件是否上传过实现极速秒传。…</p>
<hr>
<h2 id="9-1-分片传输的试探"><a href="#9-1-分片传输的试探" class="headerlink" title="9-1 分片传输的试探"></a>9-1 分片传输的试探</h2><p>分片上传：1.大文件断原续传与极速秒传：增加big-fi1e组件，分片传输测试成功</p>
<ul>
<li><p>极速秒传听起来很高深，原理其实很简单，就是开始上传前，先检查一下文件是否上传过了，如果已上传过，直接弹出提示，极速秒传成功。</p>
</li>
<li><p>一个文件有10M，每个分片定义为1M，那这个文件就会被分为10片进行传输</p>
</li>
<li><p>首先创建一个组件big-file就是把file复制过去修改下</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改姓名和文本</span></span><br><span class="line">name: <span class="string">&#x27;big-file&#x27;</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    text: &#123;</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">&quot;上传大文件&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//在uploadFile中增加文件分片</span></span><br><span class="line">let shardSize=<span class="number">20</span> * <span class="number">1024</span> * <span class="number">1024</span>;<span class="comment">//以20MB为一个分片</span></span><br><span class="line"><span class="type">let</span> <span class="variable">shardIndex</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//分片索引</span></span><br><span class="line"><span class="type">let</span> <span class="variable">start</span> <span class="operator">=</span> shardIndex * shardSize;<span class="comment">//当前分片起始位置</span></span><br><span class="line"><span class="type">let</span> <span class="variable">end</span> <span class="operator">=</span> Math.min(file.size,start+shardSize);<span class="comment">//当前分片结束位置</span></span><br><span class="line"><span class="type">let</span> <span class="variable">fileShard</span> <span class="operator">=</span> file.slice(start,end);<span class="comment">//从文件中截取当前的分片数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// key：&quot;file&quot;必须和后端controller参数名一致</span></span><br><span class="line">formData.append(<span class="string">&#x27;file&#x27;</span>, fileShard);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>file.slice（），对文件进行截取</p>
</li>
<li><p>在section中引入big-file，并将file组件改为big-file</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import BigFile from &quot;../../components/big-file&quot;;</span><br><span class="line">export default &#123;</span><br><span class="line">  components: &#123;Pagination,BigFile&#125;,</span><br></pre></td></tr></table></figure>

<p>分片合并：1.大文件断点续传与极速秒传：分片合并测试成功</p>
<ul>
<li>在UploadController中增加方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;merge&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">merge</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">newFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(FILE_PATH + <span class="string">&quot;/course/test123.mp4&quot;</span>);</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(newFile, <span class="literal">true</span>);<span class="comment">//文件追加写入</span></span><br><span class="line">    <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//分片文件</span></span><br><span class="line">    <span class="type">byte</span>[] byt = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//读取第一个分片</span></span><br><span class="line">        fileInputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(FILE_PATH + <span class="string">&quot;/course/G8Yfj2Ij.blob&quot;</span>));</span><br><span class="line">        <span class="keyword">while</span> ((len = fileInputStream.read(byt)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            outputStream.write(byt, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//读第二个分片</span></span><br><span class="line">        fileInputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(FILE_PATH + <span class="string">&quot;/course/NUTxyaDe.blob&quot;</span>));</span><br><span class="line">        <span class="keyword">while</span> ((len = fileInputStream.read(byt)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            outputStream.write(byt, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;分片异常&quot;</span>,e);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(fileInputStream!=<span class="literal">null</span>)&#123;</span><br><span class="line">                fileInputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">            outputStream.close();</span><br><span class="line">            LOG.info(<span class="string">&quot;IO流关闭&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;IO流关闭&quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">    <span class="keyword">return</span>  responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-2-分片上传功能开发1"><a href="#9-2-分片上传功能开发1" class="headerlink" title="9-2 分片上传功能开发1"></a>9-2 分片上传功能开发1</h2><p>文件分片管理的模型设计：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.大文件断点续传与极速秒传：文件表增加分片相关字段</span><br></pre></td></tr></table></figure>

<ul>
<li>在all.sql的“文件”中增加，然后mybatis-generator</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `file` <span class="keyword">add</span> <span class="keyword">column</span> (`Shard_index` <span class="type">int</span> comment <span class="string">&#x27;已上传分片&#x27;</span>);</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `file` <span class="keyword">add</span> <span class="keyword">column</span> (`Shard_size` <span class="type">int</span> comment <span class="string">&#x27;分片大小|B&#x27;</span>);</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `file` <span class="keyword">add</span> <span class="keyword">column</span> (`Shard_total` <span class="type">int</span> comment <span class="string">&#x27;分片总数&#x27;</span>);</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `file` <span class="keyword">add</span> <span class="keyword">column</span> (`key` <span class="type">varchar</span>(<span class="number">32</span>) comment <span class="string">&#x27;文件标识&#x27;</span>);</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `file` <span class="keyword">add</span> <span class="keyword">unique</span> key key_unique(`key`);</span><br></pre></td></tr></table></figure>

<p>分片数据传输：</p>
<ul>
<li><p>经验分享：对于对于一些不涉及安全性的数据，可以交由前端来计算，这样可以减轻服务端的压力</p>
</li>
<li><p>我们将File中生成的变量复制到filedto中然后生成get和set和tostring方法</p>
</li>
<li><p>然后我们对前端big-file组件做修改：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">let</span> <span class="variable">size</span> <span class="operator">=</span> file.size;</span><br><span class="line"><span class="type">let</span> <span class="variable">shardTotal</span> <span class="operator">=</span> Math.ceil(size/shardSize);<span class="comment">//总片数</span></span><br><span class="line"><span class="comment">// key：&quot;file&quot;必须和后端controller参数名一致</span></span><br><span class="line">formData.append(<span class="string">&#x27;shard&#x27;</span>, fileShard);</span><br><span class="line">formData.append(<span class="string">&#x27;shardIndex&#x27;</span>, shardIndex);</span><br><span class="line">formData.append(<span class="string">&#x27;shardSize&#x27;</span>, shardSize);</span><br><span class="line">formData.append(<span class="string">&#x27;shardTotal&#x27;</span>, shardTotal);</span><br><span class="line"><span class="comment">//提交表单时将use也提交出去</span></span><br><span class="line">formData.append(<span class="string">&#x27;use&#x27;</span>, _this.use);</span><br><span class="line">formData.append(<span class="string">&#x27;name&#x27;</span>, file.name);</span><br><span class="line">formData.append(<span class="string">&#x27;suffix&#x27;</span>, suffix);</span><br><span class="line">formData.append(<span class="string">&#x27;size&#x27;</span>, size);</span><br></pre></td></tr></table></figure>

<ul>
<li>其次对服务端UploadController做修改：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对传入参数进行增加</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestParam</span> MultipartFile shard,</span></span><br><span class="line"><span class="params">                                            String use,</span></span><br><span class="line"><span class="params">                                            String name,</span></span><br><span class="line"><span class="params">                                            String suffix,</span></span><br><span class="line"><span class="params">                                            Integer size,</span></span><br><span class="line"><span class="params">                                            Integer shardIndex,</span></span><br><span class="line"><span class="params">                                            Integer shardSize,</span></span><br><span class="line"><span class="params">                                            Integer shardTotal)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"><span class="comment">//将file改为shard</span></span><br><span class="line">shard.transferTo(dest);</span><br><span class="line"><span class="comment">//将里面参数进行修改</span></span><br><span class="line">fileDto.setName(name);</span><br><span class="line">fileDto.setSize(size);</span><br><span class="line"><span class="comment">//再将新增参数设置进去</span></span><br><span class="line">fileDto.setShardIndex(shardIndex);</span><br><span class="line">fileDto.setSize(shardSize);</span><br><span class="line">fileDto.setShardTotal(shardTotal);</span><br><span class="line">fileDto.setKey(key);</span><br></pre></td></tr></table></figure>

<p>文件标识的设计：1.大文件断点续传与极速秒传：使用文件生成md5签名，作为文件标识</p>
<ul>
<li><p>数据库设计上传第一个分片时，插入一条记录，上传之后的分片都是更新记录，只需更新shard_index字段，当然也包括updated_at</p>
</li>
<li><p>数据库设计：shard_index和shard_total的值相等时表示所有分片都已上传完成</p>
</li>
<li><p>数据库设计：不管上传第几个分片，传输的key值是一样的，key跟文件相关，跟分片无关</p>
</li>
<li><p>MD5信息摘要算法，常用于密码加密传输与存储，会生成128位二制数，每4个二进制可以转成1个16进制数字，结果是32个16进制数字</p>
</li>
<li><p>26个大写字字母+26个小写字母+10个阿拉伯数字，共62个字符，可以表达62进制数字。</p>
</li>
<li><p>首先我们增加md5.js文件</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable constant_">KEY</span> = <span class="string">&quot;!@#QWERT&quot;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Configurable variables. You may need to tweak these to be compatible with</span></span><br><span class="line"><span class="comment"> * the server-side, but the defaults work in most cases.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> hexcase = <span class="number">0</span>;  <span class="comment">/* hex output format. 0 - lowercase; 1 - uppercase        */</span></span><br><span class="line"><span class="keyword">var</span> b64pad  = <span class="string">&quot;&quot;</span>; <span class="comment">/* base-64 pad character. &quot;=&quot; for strict RFC compliance   */</span></span><br><span class="line"><span class="keyword">var</span> chrsz   = <span class="number">8</span>;  <span class="comment">/* bits per input character. 8 - ASCII; 16 - Unicode      */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These are the functions you&#x27;ll usually want to call</span></span><br><span class="line"><span class="comment"> * They take string arguments and return either hex or base-64 encoded strings</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex_md5</span>(<span class="params">s</span>)&#123; <span class="keyword">return</span> <span class="title function_">binl2hex</span>(<span class="title function_">core_md5</span>(<span class="title function_">str2binl</span>(s), s.<span class="property">length</span> * chrsz));&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b64_md5</span>(<span class="params">s</span>)&#123; <span class="keyword">return</span> <span class="title function_">binl2b64</span>(<span class="title function_">core_md5</span>(<span class="title function_">str2binl</span>(s), s.<span class="property">length</span> * chrsz));&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">str_md5</span>(<span class="params">s</span>)&#123; <span class="keyword">return</span> <span class="title function_">binl2str</span>(<span class="title function_">core_md5</span>(<span class="title function_">str2binl</span>(s), s.<span class="property">length</span> * chrsz));&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex_hmac_md5</span>(<span class="params">key, data</span>) &#123; <span class="keyword">return</span> <span class="title function_">binl2hex</span>(<span class="title function_">core_hmac_md5</span>(key, data)); &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b64_hmac_md5</span>(<span class="params">key, data</span>) &#123; <span class="keyword">return</span> <span class="title function_">binl2b64</span>(<span class="title function_">core_hmac_md5</span>(key, data)); &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">str_hmac_md5</span>(<span class="params">key, data</span>) &#123; <span class="keyword">return</span> <span class="title function_">binl2str</span>(<span class="title function_">core_hmac_md5</span>(key, data)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Perform a simple self-test to see if the VM is working</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">md5_vm_test</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">hex_md5</span>(<span class="string">&quot;abc&quot;</span>) == <span class="string">&quot;900150983cd24fb0d6963f7d28e17f72&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Calculate the MD5 of an array of little-endian words, and a bit length</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">core_md5</span>(<span class="params">x, len</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* append padding */</span></span><br><span class="line">  x[len &gt;&gt; <span class="number">5</span>] |= <span class="number">0x80</span> &lt;&lt; ((len) % <span class="number">32</span>);</span><br><span class="line">  x[(((len + <span class="number">64</span>) &gt;&gt;&gt; <span class="number">9</span>) &lt;&lt; <span class="number">4</span>) + <span class="number">14</span>] = len;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> a =  <span class="number">1732584193</span>;</span><br><span class="line">  <span class="keyword">var</span> b = -<span class="number">271733879</span>;</span><br><span class="line">  <span class="keyword">var</span> c = -<span class="number">1732584194</span>;</span><br><span class="line">  <span class="keyword">var</span> d =  <span class="number">271733878</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; x.<span class="property">length</span>; i += <span class="number">16</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> olda = a;</span><br><span class="line">    <span class="keyword">var</span> oldb = b;</span><br><span class="line">    <span class="keyword">var</span> oldc = c;</span><br><span class="line">    <span class="keyword">var</span> oldd = d;</span><br><span class="line"></span><br><span class="line">    a = <span class="title function_">md5_ff</span>(a, b, c, d, x[i+ <span class="number">0</span>], <span class="number">7</span> , -<span class="number">680876936</span>);</span><br><span class="line">    d = <span class="title function_">md5_ff</span>(d, a, b, c, x[i+ <span class="number">1</span>], <span class="number">12</span>, -<span class="number">389564586</span>);</span><br><span class="line">    c = <span class="title function_">md5_ff</span>(c, d, a, b, x[i+ <span class="number">2</span>], <span class="number">17</span>,  <span class="number">606105819</span>);</span><br><span class="line">    b = <span class="title function_">md5_ff</span>(b, c, d, a, x[i+ <span class="number">3</span>], <span class="number">22</span>, -<span class="number">1044525330</span>);</span><br><span class="line">    a = <span class="title function_">md5_ff</span>(a, b, c, d, x[i+ <span class="number">4</span>], <span class="number">7</span> , -<span class="number">176418897</span>);</span><br><span class="line">    d = <span class="title function_">md5_ff</span>(d, a, b, c, x[i+ <span class="number">5</span>], <span class="number">12</span>,  <span class="number">1200080426</span>);</span><br><span class="line">    c = <span class="title function_">md5_ff</span>(c, d, a, b, x[i+ <span class="number">6</span>], <span class="number">17</span>, -<span class="number">1473231341</span>);</span><br><span class="line">    b = <span class="title function_">md5_ff</span>(b, c, d, a, x[i+ <span class="number">7</span>], <span class="number">22</span>, -<span class="number">45705983</span>);</span><br><span class="line">    a = <span class="title function_">md5_ff</span>(a, b, c, d, x[i+ <span class="number">8</span>], <span class="number">7</span> ,  <span class="number">1770035416</span>);</span><br><span class="line">    d = <span class="title function_">md5_ff</span>(d, a, b, c, x[i+ <span class="number">9</span>], <span class="number">12</span>, -<span class="number">1958414417</span>);</span><br><span class="line">    c = <span class="title function_">md5_ff</span>(c, d, a, b, x[i+<span class="number">10</span>], <span class="number">17</span>, -<span class="number">42063</span>);</span><br><span class="line">    b = <span class="title function_">md5_ff</span>(b, c, d, a, x[i+<span class="number">11</span>], <span class="number">22</span>, -<span class="number">1990404162</span>);</span><br><span class="line">    a = <span class="title function_">md5_ff</span>(a, b, c, d, x[i+<span class="number">12</span>], <span class="number">7</span> ,  <span class="number">1804603682</span>);</span><br><span class="line">    d = <span class="title function_">md5_ff</span>(d, a, b, c, x[i+<span class="number">13</span>], <span class="number">12</span>, -<span class="number">40341101</span>);</span><br><span class="line">    c = <span class="title function_">md5_ff</span>(c, d, a, b, x[i+<span class="number">14</span>], <span class="number">17</span>, -<span class="number">1502002290</span>);</span><br><span class="line">    b = <span class="title function_">md5_ff</span>(b, c, d, a, x[i+<span class="number">15</span>], <span class="number">22</span>,  <span class="number">1236535329</span>);</span><br><span class="line"></span><br><span class="line">    a = <span class="title function_">md5_gg</span>(a, b, c, d, x[i+ <span class="number">1</span>], <span class="number">5</span> , -<span class="number">165796510</span>);</span><br><span class="line">    d = <span class="title function_">md5_gg</span>(d, a, b, c, x[i+ <span class="number">6</span>], <span class="number">9</span> , -<span class="number">1069501632</span>);</span><br><span class="line">    c = <span class="title function_">md5_gg</span>(c, d, a, b, x[i+<span class="number">11</span>], <span class="number">14</span>,  <span class="number">643717713</span>);</span><br><span class="line">    b = <span class="title function_">md5_gg</span>(b, c, d, a, x[i+ <span class="number">0</span>], <span class="number">20</span>, -<span class="number">373897302</span>);</span><br><span class="line">    a = <span class="title function_">md5_gg</span>(a, b, c, d, x[i+ <span class="number">5</span>], <span class="number">5</span> , -<span class="number">701558691</span>);</span><br><span class="line">    d = <span class="title function_">md5_gg</span>(d, a, b, c, x[i+<span class="number">10</span>], <span class="number">9</span> ,  <span class="number">38016083</span>);</span><br><span class="line">    c = <span class="title function_">md5_gg</span>(c, d, a, b, x[i+<span class="number">15</span>], <span class="number">14</span>, -<span class="number">660478335</span>);</span><br><span class="line">    b = <span class="title function_">md5_gg</span>(b, c, d, a, x[i+ <span class="number">4</span>], <span class="number">20</span>, -<span class="number">405537848</span>);</span><br><span class="line">    a = <span class="title function_">md5_gg</span>(a, b, c, d, x[i+ <span class="number">9</span>], <span class="number">5</span> ,  <span class="number">568446438</span>);</span><br><span class="line">    d = <span class="title function_">md5_gg</span>(d, a, b, c, x[i+<span class="number">14</span>], <span class="number">9</span> , -<span class="number">1019803690</span>);</span><br><span class="line">    c = <span class="title function_">md5_gg</span>(c, d, a, b, x[i+ <span class="number">3</span>], <span class="number">14</span>, -<span class="number">187363961</span>);</span><br><span class="line">    b = <span class="title function_">md5_gg</span>(b, c, d, a, x[i+ <span class="number">8</span>], <span class="number">20</span>,  <span class="number">1163531501</span>);</span><br><span class="line">    a = <span class="title function_">md5_gg</span>(a, b, c, d, x[i+<span class="number">13</span>], <span class="number">5</span> , -<span class="number">1444681467</span>);</span><br><span class="line">    d = <span class="title function_">md5_gg</span>(d, a, b, c, x[i+ <span class="number">2</span>], <span class="number">9</span> , -<span class="number">51403784</span>);</span><br><span class="line">    c = <span class="title function_">md5_gg</span>(c, d, a, b, x[i+ <span class="number">7</span>], <span class="number">14</span>,  <span class="number">1735328473</span>);</span><br><span class="line">    b = <span class="title function_">md5_gg</span>(b, c, d, a, x[i+<span class="number">12</span>], <span class="number">20</span>, -<span class="number">1926607734</span>);</span><br><span class="line"></span><br><span class="line">    a = <span class="title function_">md5_hh</span>(a, b, c, d, x[i+ <span class="number">5</span>], <span class="number">4</span> , -<span class="number">378558</span>);</span><br><span class="line">    d = <span class="title function_">md5_hh</span>(d, a, b, c, x[i+ <span class="number">8</span>], <span class="number">11</span>, -<span class="number">2022574463</span>);</span><br><span class="line">    c = <span class="title function_">md5_hh</span>(c, d, a, b, x[i+<span class="number">11</span>], <span class="number">16</span>,  <span class="number">1839030562</span>);</span><br><span class="line">    b = <span class="title function_">md5_hh</span>(b, c, d, a, x[i+<span class="number">14</span>], <span class="number">23</span>, -<span class="number">35309556</span>);</span><br><span class="line">    a = <span class="title function_">md5_hh</span>(a, b, c, d, x[i+ <span class="number">1</span>], <span class="number">4</span> , -<span class="number">1530992060</span>);</span><br><span class="line">    d = <span class="title function_">md5_hh</span>(d, a, b, c, x[i+ <span class="number">4</span>], <span class="number">11</span>,  <span class="number">1272893353</span>);</span><br><span class="line">    c = <span class="title function_">md5_hh</span>(c, d, a, b, x[i+ <span class="number">7</span>], <span class="number">16</span>, -<span class="number">155497632</span>);</span><br><span class="line">    b = <span class="title function_">md5_hh</span>(b, c, d, a, x[i+<span class="number">10</span>], <span class="number">23</span>, -<span class="number">1094730640</span>);</span><br><span class="line">    a = <span class="title function_">md5_hh</span>(a, b, c, d, x[i+<span class="number">13</span>], <span class="number">4</span> ,  <span class="number">681279174</span>);</span><br><span class="line">    d = <span class="title function_">md5_hh</span>(d, a, b, c, x[i+ <span class="number">0</span>], <span class="number">11</span>, -<span class="number">358537222</span>);</span><br><span class="line">    c = <span class="title function_">md5_hh</span>(c, d, a, b, x[i+ <span class="number">3</span>], <span class="number">16</span>, -<span class="number">722521979</span>);</span><br><span class="line">    b = <span class="title function_">md5_hh</span>(b, c, d, a, x[i+ <span class="number">6</span>], <span class="number">23</span>,  <span class="number">76029189</span>);</span><br><span class="line">    a = <span class="title function_">md5_hh</span>(a, b, c, d, x[i+ <span class="number">9</span>], <span class="number">4</span> , -<span class="number">640364487</span>);</span><br><span class="line">    d = <span class="title function_">md5_hh</span>(d, a, b, c, x[i+<span class="number">12</span>], <span class="number">11</span>, -<span class="number">421815835</span>);</span><br><span class="line">    c = <span class="title function_">md5_hh</span>(c, d, a, b, x[i+<span class="number">15</span>], <span class="number">16</span>,  <span class="number">530742520</span>);</span><br><span class="line">    b = <span class="title function_">md5_hh</span>(b, c, d, a, x[i+ <span class="number">2</span>], <span class="number">23</span>, -<span class="number">995338651</span>);</span><br><span class="line"></span><br><span class="line">    a = <span class="title function_">md5_ii</span>(a, b, c, d, x[i+ <span class="number">0</span>], <span class="number">6</span> , -<span class="number">198630844</span>);</span><br><span class="line">    d = <span class="title function_">md5_ii</span>(d, a, b, c, x[i+ <span class="number">7</span>], <span class="number">10</span>,  <span class="number">1126891415</span>);</span><br><span class="line">    c = <span class="title function_">md5_ii</span>(c, d, a, b, x[i+<span class="number">14</span>], <span class="number">15</span>, -<span class="number">1416354905</span>);</span><br><span class="line">    b = <span class="title function_">md5_ii</span>(b, c, d, a, x[i+ <span class="number">5</span>], <span class="number">21</span>, -<span class="number">57434055</span>);</span><br><span class="line">    a = <span class="title function_">md5_ii</span>(a, b, c, d, x[i+<span class="number">12</span>], <span class="number">6</span> ,  <span class="number">1700485571</span>);</span><br><span class="line">    d = <span class="title function_">md5_ii</span>(d, a, b, c, x[i+ <span class="number">3</span>], <span class="number">10</span>, -<span class="number">1894986606</span>);</span><br><span class="line">    c = <span class="title function_">md5_ii</span>(c, d, a, b, x[i+<span class="number">10</span>], <span class="number">15</span>, -<span class="number">1051523</span>);</span><br><span class="line">    b = <span class="title function_">md5_ii</span>(b, c, d, a, x[i+ <span class="number">1</span>], <span class="number">21</span>, -<span class="number">2054922799</span>);</span><br><span class="line">    a = <span class="title function_">md5_ii</span>(a, b, c, d, x[i+ <span class="number">8</span>], <span class="number">6</span> ,  <span class="number">1873313359</span>);</span><br><span class="line">    d = <span class="title function_">md5_ii</span>(d, a, b, c, x[i+<span class="number">15</span>], <span class="number">10</span>, -<span class="number">30611744</span>);</span><br><span class="line">    c = <span class="title function_">md5_ii</span>(c, d, a, b, x[i+ <span class="number">6</span>], <span class="number">15</span>, -<span class="number">1560198380</span>);</span><br><span class="line">    b = <span class="title function_">md5_ii</span>(b, c, d, a, x[i+<span class="number">13</span>], <span class="number">21</span>,  <span class="number">1309151649</span>);</span><br><span class="line">    a = <span class="title function_">md5_ii</span>(a, b, c, d, x[i+ <span class="number">4</span>], <span class="number">6</span> , -<span class="number">145523070</span>);</span><br><span class="line">    d = <span class="title function_">md5_ii</span>(d, a, b, c, x[i+<span class="number">11</span>], <span class="number">10</span>, -<span class="number">1120210379</span>);</span><br><span class="line">    c = <span class="title function_">md5_ii</span>(c, d, a, b, x[i+ <span class="number">2</span>], <span class="number">15</span>,  <span class="number">718787259</span>);</span><br><span class="line">    b = <span class="title function_">md5_ii</span>(b, c, d, a, x[i+ <span class="number">9</span>], <span class="number">21</span>, -<span class="number">343485551</span>);</span><br><span class="line"></span><br><span class="line">    a = <span class="title function_">safe_add</span>(a, olda);</span><br><span class="line">    b = <span class="title function_">safe_add</span>(b, oldb);</span><br><span class="line">    c = <span class="title function_">safe_add</span>(c, oldc);</span><br><span class="line">    d = <span class="title function_">safe_add</span>(d, oldd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Array</span>(a, b, c, d);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These functions implement the four basic operations the algorithm uses.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">md5_cmn</span>(<span class="params">q, a, b, x, s, t</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">safe_add</span>(<span class="title function_">bit_rol</span>(<span class="title function_">safe_add</span>(<span class="title function_">safe_add</span>(a, q), <span class="title function_">safe_add</span>(x, t)), s),b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">md5_ff</span>(<span class="params">a, b, c, d, x, s, t</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">md5_cmn</span>((b &amp; c) | ((~b) &amp; d), a, b, x, s, t);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">md5_gg</span>(<span class="params">a, b, c, d, x, s, t</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">md5_cmn</span>((b &amp; d) | (c &amp; (~d)), a, b, x, s, t);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">md5_hh</span>(<span class="params">a, b, c, d, x, s, t</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">md5_cmn</span>(b ^ c ^ d, a, b, x, s, t);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">md5_ii</span>(<span class="params">a, b, c, d, x, s, t</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">md5_cmn</span>(c ^ (b | (~d)), a, b, x, s, t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Calculate the HMAC-MD5, of a key and some data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">core_hmac_md5</span>(<span class="params">key, data</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> bkey = <span class="title function_">str2binl</span>(key);</span><br><span class="line">  <span class="keyword">if</span>(bkey.<span class="property">length</span> &gt; <span class="number">16</span>) bkey = <span class="title function_">core_md5</span>(bkey, key.<span class="property">length</span> * chrsz);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> ipad = <span class="title class_">Array</span>(<span class="number">16</span>), opad = <span class="title class_">Array</span>(<span class="number">16</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    ipad[i] = bkey[i] ^ <span class="number">0x36363636</span>;</span><br><span class="line">    opad[i] = bkey[i] ^ <span class="number">0x5C5C5C5C</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> hash = <span class="title function_">core_md5</span>(ipad.<span class="title function_">concat</span>(<span class="title function_">str2binl</span>(data)), <span class="number">512</span> + data.<span class="property">length</span> * chrsz);</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">core_md5</span>(opad.<span class="title function_">concat</span>(hash), <span class="number">512</span> + <span class="number">128</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Add integers, wrapping at 2^32. This uses 16-bit operations internally</span></span><br><span class="line"><span class="comment"> * to work around bugs in some JS interpreters.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">safe_add</span>(<span class="params">x, y</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> lsw = (x &amp; <span class="number">0xFFFF</span>) + (y &amp; <span class="number">0xFFFF</span>);</span><br><span class="line">  <span class="keyword">var</span> msw = (x &gt;&gt; <span class="number">16</span>) + (y &gt;&gt; <span class="number">16</span>) + (lsw &gt;&gt; <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">return</span> (msw &lt;&lt; <span class="number">16</span>) | (lsw &amp; <span class="number">0xFFFF</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Bitwise rotate a 32-bit number to the left.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bit_rol</span>(<span class="params">num, cnt</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (num &lt;&lt; cnt) | (num &gt;&gt;&gt; (<span class="number">32</span> - cnt));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Convert a string to an array of little-endian words</span></span><br><span class="line"><span class="comment"> * If chrsz is ASCII, characters &gt;255 have their hi-byte silently ignored.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">str2binl</span>(<span class="params">str</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> bin = <span class="title class_">Array</span>();</span><br><span class="line">  <span class="keyword">var</span> mask = (<span class="number">1</span> &lt;&lt; chrsz) - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.<span class="property">length</span> * chrsz; i += chrsz)</span><br><span class="line">    bin[i&gt;&gt;<span class="number">5</span>] |= (str.<span class="title function_">charCodeAt</span>(i / chrsz) &amp; mask) &lt;&lt; (i%<span class="number">32</span>);</span><br><span class="line">  <span class="keyword">return</span> bin;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Convert an array of little-endian words to a string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">binl2str</span>(<span class="params">bin</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">var</span> mask = (<span class="number">1</span> &lt;&lt; chrsz) - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bin.<span class="property">length</span> * <span class="number">32</span>; i += chrsz)</span><br><span class="line">    str += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>((bin[i&gt;&gt;<span class="number">5</span>] &gt;&gt;&gt; (i % <span class="number">32</span>)) &amp; mask);</span><br><span class="line">  <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Convert an array of little-endian words to a hex string.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">binl2hex</span>(<span class="params">binarray</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> hex_tab = hexcase ? <span class="string">&quot;0123456789ABCDEF&quot;</span> : <span class="string">&quot;0123456789abcdef&quot;</span>;</span><br><span class="line">  <span class="keyword">var</span> str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; binarray.<span class="property">length</span> * <span class="number">4</span>; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    str += hex_tab.<span class="title function_">charAt</span>((binarray[i&gt;&gt;<span class="number">2</span>] &gt;&gt; ((i%<span class="number">4</span>)*<span class="number">8</span>+<span class="number">4</span>)) &amp; <span class="number">0xF</span>) +</span><br><span class="line">           hex_tab.<span class="title function_">charAt</span>((binarray[i&gt;&gt;<span class="number">2</span>] &gt;&gt; ((i%<span class="number">4</span>)*<span class="number">8</span>  )) &amp; <span class="number">0xF</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Convert an array of little-endian words to a base-64 string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">binl2b64</span>(<span class="params">binarray</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> tab = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>;</span><br><span class="line">  <span class="keyword">var</span> str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; binarray.<span class="property">length</span> * <span class="number">4</span>; i += <span class="number">3</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> triplet = (((binarray[i   &gt;&gt; <span class="number">2</span>] &gt;&gt; <span class="number">8</span> * ( i   %<span class="number">4</span>)) &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">16</span>)</span><br><span class="line">                | (((binarray[i+<span class="number">1</span> &gt;&gt; <span class="number">2</span>] &gt;&gt; <span class="number">8</span> * ((i+<span class="number">1</span>)%<span class="number">4</span>)) &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">8</span> )</span><br><span class="line">                |  ((binarray[i+<span class="number">2</span> &gt;&gt; <span class="number">2</span>] &gt;&gt; <span class="number">8</span> * ((i+<span class="number">2</span>)%<span class="number">4</span>)) &amp; <span class="number">0xFF</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span>(i * <span class="number">8</span> + j * <span class="number">6</span> &gt; binarray.<span class="property">length</span> * <span class="number">32</span>) str += b64pad;</span><br><span class="line">      <span class="keyword">else</span> str += tab.<span class="title function_">charAt</span>((triplet &gt;&gt; <span class="number">6</span>*(<span class="number">3</span>-j)) &amp; <span class="number">0x3F</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在index中引用</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--  md5工具类--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&lt;%= BASE_URL %&gt;static/js/md5.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后再big-file中就可以使用了，再uploadFile中增加</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//生成文件标识，标识多次上传的是不是同一文件</span><br><span class="line">let key = hex_md5(file);</span><br><span class="line">let key10 = parseInt(key,16);</span><br><span class="line">let key62 = Tool._10to62(key10);</span><br><span class="line">console.log(key,key10,key62)</span><br><span class="line">//表单增加key</span><br><span class="line">formData.append(&#x27;key&#x27;, key62);</span><br></pre></td></tr></table></figure>

<ul>
<li>对于Tool._10to62方法，我们在tool中增加</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 10进制转62进制</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">number</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">string</span>&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="attr">_10to62</span>: <span class="keyword">function</span> (<span class="params">number</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> chars = <span class="string">&#x27;0123456789abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> radix = chars.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">let</span> arr = [];</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> mod = number % radix;</span><br><span class="line">        number = (number - mod) / radix;</span><br><span class="line">        arr.<span class="title function_">unshift</span>(chars[mod]);</span><br><span class="line">    &#125; <span class="keyword">while</span> (number);</span><br><span class="line">    <span class="keyword">return</span> arr.<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>在UploadController增加String key参数，将自定义参数key删了</li>
</ul>
<p>大文件断点续传与极速秒传：根据文件标识来新增或修改文件记录，修改分片索引从1开始</p>
<ul>
<li><p>实际使用场景中，一个文件太大，当第一次上传一半，失败了。第二次再上传时，有可能隔了一天或更久</p>
</li>
<li><p>我们对FileService进行修改</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//增加方法</span></span><br><span class="line"><span class="keyword">public</span> File <span class="title function_">selectByKet</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    <span class="type">FileExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileExample</span>();</span><br><span class="line">    example.createCriteria().andKeyEqualTo(key);</span><br><span class="line">    List&lt;File&gt; fileList = fileMapper.selectByExample(example);</span><br><span class="line">    <span class="keyword">if</span>(CollectionUtils.isEmpty(fileList))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fileList.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//使用方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(FileDto fileDto)</span>&#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> CopyUtil.copy(fileDto, File.class);</span><br><span class="line">        <span class="type">File</span> <span class="variable">fileDb</span> <span class="operator">=</span> selectByKet(fileDto.getKey());</span><br><span class="line">        <span class="keyword">if</span>(fileDb == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="built_in">this</span>.insert(file);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            fileDb.setShardIndex(fileDb.getShardIndex());</span><br><span class="line">            <span class="built_in">this</span>.update(fileDb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>big-file中也进行修改，1标识第一个分片</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let shardIndex = 1;//分片索引 1标识第一个分片</span><br><span class="line">let start = (shardIndex-1) * shardSize;//当前分片起始位置</span><br></pre></td></tr></table></figure>

<h2 id="9-3-分片上传功能开发2"><a href="#9-3-分片上传功能开发2" class="headerlink" title="9-3 分片上传功能开发2"></a><strong>9-3 分片上传功能开发2</strong></h2><p>分片数据格式转换，统一系统前后端数据交互传参：1.大文件断点续传与极速秒传：分片数据改成base64进行传输，后端统一用RequestBody接收数据</p>
<ul>
<li><p>将file类型转换成String有一个方法就是base64</p>
</li>
<li><p>首先在big-file中的uploadFile方法增加</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">let fileReader = new FileReader();</span><br><span class="line">  fileReader.onload = function (e)&#123;//当读分片数据时就会触发onload事件监听</span><br><span class="line">    let base64 = e.target.result;</span><br><span class="line"></span><br><span class="line">    let param = &#123;//就可以将上面append那些注释掉了</span><br><span class="line">      &#x27;shard&#x27;:base64,</span><br><span class="line">      &#x27;shardIndex&#x27;: shardIndex,</span><br><span class="line">      &#x27;shardSize&#x27;: shardSize,</span><br><span class="line">      &#x27;shardTotal&#x27;: shardTotal,</span><br><span class="line">      &#x27;use&#x27;: _this.use,</span><br><span class="line">      &#x27;name&#x27;: file.name,</span><br><span class="line">      &#x27;suffix&#x27;: suffix,</span><br><span class="line">      &#x27;size&#x27;: size,</span><br><span class="line">      &#x27;key&#x27;: key62</span><br><span class="line">    &#125;;</span><br><span class="line">    Loading.show();</span><br><span class="line">    _this.$ajax.post(process.env.VUE_APP_SERVER + &#x27;/file/admin/upload&#x27;, param).then((response)=&gt;&#123;</span><br><span class="line">      Loading.hide();</span><br><span class="line">      let resp = response.data;</span><br><span class="line">      console.log(&quot;上传文件成功：&quot;, resp);</span><br><span class="line">      _this.afterUpload(resp);</span><br><span class="line">      $(&quot;#&quot; + _this.inputId + &quot;-input&quot;).val(&quot;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  fileReader.readAsDataURL(fileShard);//这个方法去读分片数据</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>这时我们就可以在UploadController中将参数改了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestBody</span> FileDto fileDto)</span> </span><br><span class="line"><span class="comment">//删除一些东西</span></span><br><span class="line"><span class="comment">//FileDto fileDto = new FileDto();</span></span><br><span class="line">fileDto.setPath(path);</span><br><span class="line"><span class="comment">//fileDto.setName(name);</span></span><br><span class="line"><span class="comment">//fileDto.setSize(size);</span></span><br><span class="line"><span class="comment">//fileDto.setSuffix(suffix);</span></span><br><span class="line"><span class="comment">//fileDto.setUse(use);</span></span><br><span class="line"><span class="comment">//fileDto.setShardIndex(shardIndex);</span></span><br><span class="line"><span class="comment">//fileDto.setSize(shardSize);</span></span><br><span class="line"><span class="comment">//.setShardTotal(shardTotal);</span></span><br><span class="line"><span class="comment">//fileDto.setKey(key);</span></span><br></pre></td></tr></table></figure>

<ul>
<li>记得在FileDto中增加，生成方法和tostring</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *base64</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span>  String shard;</span><br></pre></td></tr></table></figure>

<ul>
<li>这时有四个变量没有定义我们将他们定义成本地变量<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/16/C4YgUfzwObcGJpv.png"
                      alt="image-20220316095352944"
                ></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String use = fileDto.getUse();</span><br><span class="line">String key = fileDto.getKey();</span><br><span class="line">String suffix = fileDto.getSuffix();</span><br><span class="line">String shardBase64 = fileDto.getShard();</span><br></pre></td></tr></table></figure>

<ul>
<li><p>这时我还有一处报错，因为现在的shard是String类型，我们还要把string类型转成MultipartFile，所以我们将shard名改为shardBase64，不使用同一名称。<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/16/jSm7NtLEnKZDcIo.png"
                      alt="image-20220316095802234"
                ></p>
</li>
<li><p>我们在util增加Base64ToMultipartFile类</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.server.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Base64ToMultipartFile</span> <span class="keyword">implements</span> <span class="title class_">MultipartFile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">byte</span>[] imgContent;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String header;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Base64ToMultipartFile</span><span class="params">(<span class="type">byte</span>[] imgContent, String header)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.imgContent = imgContent;</span><br><span class="line">        <span class="built_in">this</span>.header = header.split(<span class="string">&quot;;&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// TODO - implementation depends on your requirements</span></span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis() + Math.random() + <span class="string">&quot;.&quot;</span> + header.split(<span class="string">&quot;/&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOriginalFilename</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// TODO - implementation depends on your requirements</span></span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis() + (<span class="type">int</span>) Math.random() * <span class="number">10000</span> + <span class="string">&quot;.&quot;</span> + header.split(<span class="string">&quot;/&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContentType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// TODO - implementation depends on your requirements</span></span><br><span class="line">        <span class="keyword">return</span> header.split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">return</span> <span class="variable">imgContent</span> <span class="operator">=</span>= <span class="literal">null</span> || imgContent.length == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> imgContent.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getBytes() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> imgContent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(imgContent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transferTo</span><span class="params">(File dest)</span> <span class="keyword">throws</span> IOException, IllegalStateException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(dest).write(imgContent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MultipartFile <span class="title function_">base64ToMultipart</span><span class="params">(String base64)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] baseStrs = base64.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">BASE64Decoder</span> <span class="variable">decoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>();</span><br><span class="line">            <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">            b = decoder.decodeBuffer(baseStrs[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; b.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (b[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    b[i] += <span class="number">256</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Base64ToMultipartFile</span>(b, baseStrs[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后我们在UploadController使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MultipartFile</span> <span class="variable">shard</span> <span class="operator">=</span> Base64ToMultipartFile.base64ToMultipart(shardBase64);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>base64格式：文件说明+“+文件内容</p>
</li>
<li><p>将文件转成base64进行传输，优势是变成了常见的字符串类型，劣势是传输的数据会变大</p>
</li>
</ul>
<p>设置分片文件名:</p>
<ul>
<li>小提示：当字符串拼接个数大多时，不要使用+，而是使用StringBuffer</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//String path = dir + File.separator + key + &quot;.&quot; + suffix+ &quot;.&quot; +fileDto.getShardIndex();</span></span><br><span class="line"><span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(dir)</span><br><span class="line">        .append(File.separator)</span><br><span class="line">        .append(key)</span><br><span class="line">        .append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">        .append(suffix)</span><br><span class="line">        .append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">        .append(fileDto.getShardIndex()).toString();</span><br></pre></td></tr></table></figure>

<p>支持连续上传多个分片:</p>
<ul>
<li>在上传结束时，做个判断，如果shardlndex&#x3D;&#x3D;shardTotal，表示所有分片都上传完成了,如果shardindex&lt;shardTotal，继续上传下一个分片。以下在big-file中进行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if (shardIndex &lt; shardTotal) &#123;</span><br><span class="line">  // 上传下一个分片</span><br><span class="line">  param.shardIndex = param.shardIndex + 1;</span><br><span class="line">  _this.upload(param);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  _this.afterUpload(resp);</span><br><span class="line">  $(&quot;#&quot; + _this.inputId + &quot;-input&quot;).val(&quot;&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>递归，不断的重复做某一件事（上传分片），直到某个条件成立（shardlndex&#x3D;&#x3D;shardTotal），退出重复做的事。</p>
</li>
<li><p>然后将代码重构</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 将分片数据转成base64进行上传</span><br><span class="line"> */</span><br><span class="line">upload (param) &#123;</span><br><span class="line">  let _this = this;</span><br><span class="line">  let shardIndex = param.shardIndex;</span><br><span class="line">  let shardTotal = param.shardTotal;</span><br><span class="line">  let shardSize = param.shardSize;</span><br><span class="line">  let fileShard = _this.getFileShard(shardIndex, shardSize);</span><br><span class="line">  // 将图片转为base64进行传输</span><br><span class="line">  let fileReader = new FileReader();</span><br><span class="line"></span><br><span class="line">  fileReader.onload = function (e) &#123;</span><br><span class="line">    let base64 = e.target.result;</span><br><span class="line">    // console.log(&quot;base64:&quot;, base64);</span><br><span class="line"></span><br><span class="line">    param.shard = base64;</span><br><span class="line">    Loading.show();</span><br><span class="line">    _this.$ajax.post(process.env.VUE_APP_SERVER + &#x27;/file/admin/upload&#x27;, param).then((response) =&gt; &#123;</span><br><span class="line">      Loading.hide();</span><br><span class="line">      let resp = response.data;</span><br><span class="line">      console.log(&quot;上传文件成功：&quot;, resp);</span><br><span class="line">      if (shardIndex &lt; shardTotal) &#123;</span><br><span class="line">        // 上传下一个分片</span><br><span class="line">        param.shardIndex = param.shardIndex + 1;</span><br><span class="line">        _this.upload(param);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        _this.afterUpload(resp);</span><br><span class="line">        $(&quot;#&quot; + _this.inputId + &quot;-input&quot;).val(&quot;&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  fileReader.readAsDataURL(fileShard);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">getFileShard (shardIndex, shardSize) &#123;</span><br><span class="line">  let _this = this;</span><br><span class="line">  let file = _this.$refs.file.files[0];</span><br><span class="line">  let start = (shardIndex - 1) * shardSize;  //当前分片起始位置</span><br><span class="line">  let end = Math.min(file.size, start + shardSize); //当前分片结束位置</span><br><span class="line">  let fileShard = file.slice(start, end); //从文件中截取当前的分片数据</span><br><span class="line">  return fileShard;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="9-4-分片合并功能开发"><a href="#9-4-分片合并功能开发" class="headerlink" title="9-4 分片合并功能开发"></a>9-4 分片合并功能开发</h2><p>按分片顺序合并成原始文件：</p>
<ul>
<li><p>保存到本地的分片名是xxx.mp4.1，但是我们返给前端和保存进数据库的path都用xxx.mp4</p>
</li>
<li><p>UploadController首先我们先修改下路径，一个文件带多余后缀的，一个不带的</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(dir)</span><br><span class="line">        .append(File.separator)</span><br><span class="line">        .append(key)</span><br><span class="line">        .append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">        .append(suffix)</span><br><span class="line">        .toString();</span><br><span class="line"><span class="type">String</span> <span class="variable">localPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(path)</span><br><span class="line">        .append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">        .append(fileDto.getShardIndex()).toString();</span><br><span class="line"><span class="type">String</span> <span class="variable">fullPath</span> <span class="operator">=</span> FILE_PATH + localPath;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们想要将分片合并，这时我们就要判断分片是不是最后一个分片，如果是就调用本地方法merge</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(fileDto.getShardIndex().equals(fileDto.getShardTotal()) )&#123;<span class="comment">//因为是一个对象所以用equals</span></span><br><span class="line">    <span class="built_in">this</span>.merge(fileDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改merge</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">merge</span><span class="params">(FileDto fileDto)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;合并分片开始&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> fileDto.getPath();<span class="comment">//这个是全路径，我们只需要绝对路径</span></span><br><span class="line"></span><br><span class="line">        path = path.replace(FILE_DOMAIN,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">ShardTotal</span> <span class="operator">=</span> fileDto.getShardTotal();</span><br><span class="line">        <span class="type">File</span> <span class="variable">newFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(FILE_PATH + path);</span><br><span class="line">        <span class="comment">//FileOutputStream outputStream = new FileOutputStream(newFile, true);//文件追加写入</span></span><br><span class="line">        <span class="comment">//FileInputStream fileInputStream = null;//分片文件</span></span><br><span class="line">       <span class="comment">// byte[] byt = new byte[10 * 1024 * 1024];</span></span><br><span class="line">       <span class="comment">// int len;</span></span><br><span class="line">       <span class="comment">// try &#123;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; shardTotal; i++) &#123;</span><br><span class="line">                <span class="comment">//读取第i个分片</span></span><br><span class="line">                fileInputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(FILE_PATH + path+<span class="string">&quot;.&quot;</span>+(i+<span class="number">1</span>)));</span><br><span class="line">                <span class="keyword">while</span> ((len = fileInputStream.read(byt)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    outputStream.write(byt, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">       <span class="comment">// &#125;catch (IOException e)&#123;</span></span><br><span class="line">            <span class="comment">//LOG.error(&quot;分片异常&quot;,e);</span></span><br><span class="line">        <span class="comment">//&#125;finally &#123;</span></span><br><span class="line">           <span class="comment">// try &#123;</span></span><br><span class="line">              <span class="comment">//  if(fileInputStream!=null)&#123;</span></span><br><span class="line">               <span class="comment">//     fileInputStream.close();</span></span><br><span class="line">              <span class="comment">//  &#125;</span></span><br><span class="line">              <span class="comment">//  outputStream.close();</span></span><br><span class="line">              <span class="comment">//  LOG.info(&quot;IO流关闭&quot;);</span></span><br><span class="line"><span class="comment">//&#125;catch (Exception e)&#123;</span></span><br><span class="line">               <span class="comment">// LOG.error(&quot;IO流关闭&quot;,e);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;合并分片结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>合并完成后删除多余分片:1.大文件断点续传与极速秒传：合并成原始文件后，删除所有分片</p>
<ul>
<li>就是在合并分片结束后加一个删除分片</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">System.gc();</span><br><span class="line"><span class="comment">//删除分片</span></span><br><span class="line">LOG.info(<span class="string">&quot;删除分片开始&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; shardTotal; i++) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> FILE_PATH+path+<span class="string">&quot;.&quot;</span>+(i+<span class="number">1</span>);</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> file.delete();</span><br><span class="line">    LOG.info(<span class="string">&quot;删除&#123;&#125;,&#123;&#125;&quot;</span>,filePath,result?<span class="string">&quot;成功&quot;</span> : <span class="string">&quot;失败&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">LOG.info(<span class="string">&quot;删除分片结束&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="9-5-分片检查与极速秒传"><a href="#9-5-分片检查与极速秒传" class="headerlink" title="9-5 分片检查与极速秒传"></a>9-5 分片检查与极速秒传</h2><p>上传分片之前先进行分片检查：1.大文件断点续传与极速秒传：上传分片之前先进行分片检查，支持断点续传</p>
<ul>
<li><p>开始上传之前，先检查资源率当前的文件是否上传过了（数据库是否有记录），如果上传过了，已经传到第几个分片了。</p>
</li>
<li><p>首先在FileService中增加方法</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据文件标识查询数据库记录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> FileDto <span class="title function_">findByKey</span><span class="params">(String key)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> CopyUtil.copy(selectByKet(key),FileDto.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再UploadController中使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/check/&#123;key&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span>  ResponseDto <span class="title function_">check</span><span class="params">(<span class="meta">@PathVariable</span> String key)</span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;减产上传分片开始：&#123;&#125;&quot;</span>,key);</span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">    <span class="type">FileDto</span> <span class="variable">fileDto</span> <span class="operator">=</span> fileService.findByKey(key);</span><br><span class="line">    responseDto.setContent(fileDto);</span><br><span class="line">    <span class="keyword">return</span>  responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改big-file将uploadFile方法中的_this.upload改为  _this.check(param);增加check方法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 检查文件状态，是否已上传过？上传到第几个分片？</span><br><span class="line"> */</span><br><span class="line">check(param)&#123;</span><br><span class="line">  let _this =this;</span><br><span class="line">  _this.$ajax.get(process.env.VUE_APP_SERVER + &#x27;/file/admin/check/&#x27;+param.key).then((response)=&gt;&#123;</span><br><span class="line">    let resp = response.data;</span><br><span class="line">    if (resp.success)&#123;</span><br><span class="line">      let obj = resp.content;</span><br><span class="line">      if (!obj)&#123;</span><br><span class="line">        param.shardIndex = 1;</span><br><span class="line">        console.log(&quot;没有找到文件记录，从分片1开始上传&quot;);</span><br><span class="line">        _this.upload(param);</span><br><span class="line">      &#125;else&#123;</span><br><span class="line">        param.shardIndex = obj.shardIndex+1;</span><br><span class="line">        console.log(&quot;找到文件记录，从分片&quot;+param.shardIndex+&quot;开始上传&quot;);</span><br><span class="line">        _this.upload(param);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">      Toast.warning(&quot;文件上传失败&quot;);</span><br><span class="line">      $(&quot;#&quot;+_this.inputId+&quot;-input&quot;).val(&quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>极速秒传：就是检查是否已经上传过了文件，如果上传过了就显示极速秒传</p>
<ul>
<li>首先再big-file中的check增加代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查文件状态，是否已上传过？上传到第几个分片？</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">check(param)&#123;</span><br><span class="line">  <span class="type">let</span> <span class="variable">_this</span> <span class="operator">=</span><span class="built_in">this</span>;</span><br><span class="line">  _this.$ajax.get(process.env.VUE_APP_SERVER + <span class="string">&#x27;/file/admin/check/&#x27;</span>+param.key).then((respond)=&gt;&#123;</span><br><span class="line">    <span class="type">let</span> <span class="variable">resp</span> <span class="operator">=</span> respond.data;</span><br><span class="line">    <span class="keyword">if</span> (resp.success)&#123;</span><br><span class="line">      <span class="type">let</span> <span class="variable">obj</span> <span class="operator">=</span> resp.content;</span><br><span class="line">      <span class="keyword">if</span> (!obj)&#123;</span><br><span class="line">        param.shardIndex = <span class="number">1</span>;</span><br><span class="line">        console.log(<span class="string">&quot;没有找到文件记录，从分片1开始上传&quot;</span>);</span><br><span class="line">        _this.upload(param);</span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(obj.shardIndex === obj.shardTotal)&#123;<span class="comment">//增加这行</span></span><br><span class="line">        Toast.success(<span class="string">&quot;文件极速秒传成功！&quot;</span>);</span><br><span class="line">        _this.afterUpload(resp);</span><br><span class="line">        $(<span class="string">&quot;#&quot;</span>+_this.inputId+<span class="string">&quot;-input&quot;</span>).val(<span class="string">&quot;&quot;</span>);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        param.shardIndex = obj.shardIndex+<span class="number">1</span>;</span><br><span class="line">        console.log(<span class="string">&quot;找到文件记录，从分片&quot;</span>+param.shardIndex+<span class="string">&quot;开始上传&quot;</span>);</span><br><span class="line">        _this.upload(param);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      Toast.warning(<span class="string">&quot;文件上传失败&quot;</span>);</span><br><span class="line">      $(<span class="string">&quot;#&quot;</span>+_this.inputId+<span class="string">&quot;-input&quot;</span>).val(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>再UploadController中增加,返回前端的应该是全路径</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public  ResponseDto check(@PathVariable String key)&#123;</span><br><span class="line">    LOG.info(&quot;减产上传分片开始：&#123;&#125;&quot;,key);</span><br><span class="line">    ResponseDto responseDto = new ResponseDto();</span><br><span class="line">    FileDto fileDto = fileService.findByKey(key);</span><br><span class="line">    if(fileDto != null)&#123;//增加这个</span><br><span class="line">        fileDto.setPath(FILE_DOMAIN+fileDto.getPath());</span><br><span class="line">    &#125;</span><br><span class="line">    responseDto.setContent(fileDto);</span><br><span class="line">    return  responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加上传进度条：</p>
<ul>
<li><p>可以做成vue组件，也可以做成is工具类，做成vue组件的话，就只能在vue框架中使用，做成js组件的话可以在isp页面、thymelea模板页面、angular等前端框架中直接使用。</p>
</li>
<li><p>progress-div显示的进度条，progress-overlay：背景遮罩，将页面所有的元素挡住，不可点击任何地方，常用于防止重复提交。</p>
</li>
<li><p>做成is全局工具类，可以直接使用，不需要import</p>
</li>
<li><p>首先再js中创建Progress.js代码</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Progress</span> = &#123;</span><br><span class="line">  <span class="attr">show</span>: <span class="keyword">function</span> (<span class="params">width</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> _this = <span class="variable language_">this</span>;</span><br><span class="line">    _this.<span class="property">width</span> = width;</span><br><span class="line">    <span class="keyword">if</span> ($(<span class="string">&quot;#progress-div&quot;</span>).<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      $(<span class="string">&quot;.progress&quot;</span>).<span class="title function_">attr</span>(<span class="string">&quot;data-percent&quot;</span>, width);</span><br><span class="line">      $(<span class="string">&quot;.progress-bar&quot;</span>).<span class="title function_">width</span>(width + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> progressDiv = <span class="string">&quot;&lt;div id=\&quot;progress-div\&quot; style=\&quot;z-index: 10011;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    position: fixed;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    padding: 10px;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    margin: 0px 0px 0px -150px;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    width: 300px;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    top: 40%;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    left: 50%;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    text-align: center;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    height: 45px;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    color: rgb(0, 0, 0);\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    border: 3px solid rgb(170, 170, 170);\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    background-color: rgb(255, 255, 255);\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;    cursor: wait;\&quot;&gt;&lt;div class=\&quot;progress pos-rel\&quot; data-percent=\&quot;&quot;</span> + width + <span class="string">&quot;%\&quot;&gt;&lt;div class=\&quot;progress-bar\&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&quot;</span>;</span><br><span class="line">      $(<span class="string">&quot;#progress-div&quot;</span>).<span class="title function_">remove</span>();</span><br><span class="line">      $(<span class="string">&quot;body&quot;</span>).<span class="title function_">append</span>(progressDiv);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 背景遮罩</span></span><br><span class="line">      $(<span class="string">&quot;body&quot;</span>).<span class="title function_">append</span>($(<span class="string">&quot;&lt;div id=\&quot;progress-overlay\&quot; style=\&quot;z-index: 10010;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  border: none;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  margin: 0px;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  padding: 0px;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  width: 100%;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  height: 100%;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  top: 0px;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  left: 0px;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  background-color: rgb(0, 0, 0);\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  opacity: 0.6;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  cursor: wait;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  position: fixed;\&quot;&gt;&lt;/div&gt;&quot;</span>));</span><br><span class="line">      $(<span class="string">&quot;.progress-bar&quot;</span>).<span class="title function_">width</span>(width + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">hide</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      $(<span class="string">&quot;#progress-div&quot;</span>).<span class="title function_">remove</span>();</span><br><span class="line">      $(<span class="string">&quot;#progress-overlay&quot;</span>).<span class="title function_">remove</span>();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再index中引入</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--  进度条  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&lt;%= BASE_URL %&gt;static/js/progress.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在big-file中使用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Progress.show(parseInt((shardIndex-1)*100/shardTotal));</span><br><span class="line">console.log(&quot;上传文件成功：&quot;, resp);</span><br><span class="line">Progress.show(parseInt((shardIndex)*100/shardTotal));</span><br><span class="line">Progress.hide(); </span><br></pre></td></tr></table></figure>

<p>大文件断点续传与极速秒传：讲师师头像和课程封面改用大文件组件：</p>
<ul>
<li><p>就是将teacher和course中file改为big-file，并且将大组件引入。</p>
</li>
<li><p>我们还将改下big-file中，hex_md5中的参数，如果直接传入file，所得的md5永远都是一个值，因为这样相当于传入一个空数组</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//生成文件标识，标识多次上传的是不是同一文件</span><br><span class="line">let key = hex_md5(file.name+file.size+file.type);</span><br><span class="line">let key10 = parseInt(key,16);</span><br><span class="line">let key62 = Tool._10to62(key10);</span><br><span class="line">console.log(key,key10,key62);</span><br><span class="line">console.log(hex_md5(Array()));</span><br></pre></td></tr></table></figure>

<h2 id="9-6-文件上传流程图"><a href="#9-6-文件上传流程图" class="headerlink" title="9-6 文件上传流程图"></a>9-6 文件上传流程图</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/18/8Bxg3WM5t1rqkzK.png"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/18/ZgeIuThVN6wrXOD.png"
                      alt="image-20220317112616569"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/18/ZgeIuThVN6wrXOD.png"
                     
                ></p>
<h1 id="第10章-基于阿里云OSS的文件上传"><a href="#第10章-基于阿里云OSS的文件上传" class="headerlink" title="第10章 基于阿里云OSS的文件上传"></a>第10章 基于阿里云OSS的文件上传</h1><p>在线视频课程的核心内容就是视频，保障视频不外泄是程序的重中之重，所以我们需要对视频做加密处理，本章我们选择阿里云视频加密，阿里云视频点播是对OSS的包装，支持防盗链和视频加密。</p>
<hr>
<h2 id="10-1-阿里云OSS简介"><a href="#10-1-阿里云OSS简介" class="headerlink" title="10-1 阿里云OSS简介"></a>10-1 阿里云OSS简介</h2><ul>
<li>前面介绍的文件上传是基于本地文件服务器的文件上传，但是自己搭文件服务器会有很多运维的问题，比如磁盘满了要扩容，高峰期要增加带宽，低谷期要减少带宽，为了安全，我们还要对文件做备份等等所以一般会选择云平台来存储文件，云平台有很多，比如阿里云、腾讯云、百度云等，云平台做得最好的是亚马逊我们这里选择国内最大的阿里云。</li>
<li>防盗链：防止别人盗用你网站资源链接，包括视频，音频，图片等</li>
<li>从浏览器通过ECS（服务器）访问OSS算内网访问，不算流量费，但是要考虑ECS的带宽问题。从浏览器直接访问OSS资源，算外网访问OSS需付流量费，但是可以不用考虑带宽</li>
</ul>
<h2 id="10-2-基于OSS接口的文件上传"><a href="#10-2-基于OSS接口的文件上传" class="headerlink" title="10-2 基于OSS接口的文件上传"></a>10-2 基于OSS接口的文件上传</h2><p>阿里云OSS控台的使用:</p>
<ul>
<li>bucket：存储空间，名称必须是全阿里云唯一</li>
<li>上传的文件默认都继承bucket，这里的设置读写权限，只针对当前的文件有效</li>
</ul>
<p>基于OSS接口实现文件上传:1.大文件断点续传与极速秒传：基于oss接口实现文件上传，增加文件追加上传oss-append和简单上传oss-simple</p>
<ul>
<li>首先开通OSS，然后就可以上传文件了，在权限管理的RAM创建用户<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/18/lSnfAvgqshPQH9T.png"
                      alt="image-20220317175917177"
                ></li>
<li>Key ID就是开发文档里的那个</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/18/xGFMlOg8qV6Dj7K.png"
                      alt="image-20220317180015443"
                ></p>
<ul>
<li><p>这个页面就有很多示例<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/18/tziOYhkyHVcBK72.png"
                      alt="image-20220317180230837"
                ></p>
</li>
<li><p>每次分片上传都是一个新的请求所以在每次请求里，只需要append一次</p>
</li>
<li><p>我们在course和file的pom.xml中都加入</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--阿里云oss--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.10.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>首先在file中创建一个新的controller（OssController），里面一个追加上传，一个简单上传</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.file.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSS;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSClientBuilder;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.model.AppendObjectRequest;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.model.AppendObjectResult;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.model.ObjectMetadata;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.model.PutObjectRequest;</span><br><span class="line"><span class="keyword">import</span> com.course.server.dto.FileDto;</span><br><span class="line"><span class="keyword">import</span> com.course.server.dto.ResponseDto;</span><br><span class="line"><span class="keyword">import</span> com.course.server.enums.FileUseEnum;</span><br><span class="line"><span class="keyword">import</span> com.course.server.service.FileService;</span><br><span class="line"><span class="keyword">import</span> com.course.server.util.Base64ToMultipartFile;</span><br><span class="line"><span class="keyword">import</span> com.course.server.util.UuidUtil;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OssController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(OssController.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_NAME</span> <span class="operator">=</span> <span class="string">&quot;文件上传&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;accessKeyId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKeyId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;accessKeySecret&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKeySecret;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;endpoint&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ossDomain&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ossDomain;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;bucket&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bucket;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> FileService fileService;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@PostMapping(&quot;/oss-append&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseDto <span class="title function_">fileUpload</span><span class="params">(<span class="meta">@RequestBody</span> FileDto fileDto)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">       LOG.info(<span class="string">&quot;上传文件开始&quot;</span>);</span><br><span class="line">       <span class="type">String</span> <span class="variable">use</span> <span class="operator">=</span> fileDto.getUse();</span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> fileDto.getKey();</span><br><span class="line">       <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> fileDto.getSuffix();</span><br><span class="line">       <span class="type">Integer</span> <span class="variable">shardIndex</span> <span class="operator">=</span> fileDto.getShardIndex();</span><br><span class="line">       <span class="type">Integer</span> <span class="variable">shardSize</span> <span class="operator">=</span> fileDto.getShardSize();</span><br><span class="line">       <span class="type">String</span> <span class="variable">shardBase64</span> <span class="operator">=</span> fileDto.getShard();</span><br><span class="line">       <span class="type">MultipartFile</span> <span class="variable">shard</span> <span class="operator">=</span> Base64ToMultipartFile.base64ToMultipart(shardBase64);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 保存文件到本地</span></span><br><span class="line">       <span class="type">FileUseEnum</span> <span class="variable">useEnum</span> <span class="operator">=</span> FileUseEnum.getByCode(use);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//如果文件夹不存在则创建</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> useEnum.name().toLowerCase();</span><br><span class="line"></span><br><span class="line">       <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(dir)</span><br><span class="line">               .append(File.separator)</span><br><span class="line">               .append(key)</span><br><span class="line">               .append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">               .append(suffix)</span><br><span class="line">               .toString();</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">       <span class="type">OSS</span> <span class="variable">ossClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OSSClientBuilder</span>().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line">       <span class="type">ObjectMetadata</span> <span class="variable">meta</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMetadata</span>();</span><br><span class="line">       meta.setContentType(<span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">       <span class="comment">// 通过AppendObjectRequest设置多个参数。</span></span><br><span class="line">       <span class="type">AppendObjectRequest</span> <span class="variable">appendObjectRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AppendObjectRequest</span>(bucket, path, <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(shard.getBytes()),meta);</span><br><span class="line">       <span class="comment">// 第一次追加。</span></span><br><span class="line">       <span class="comment">// 设置文件的追加位置。</span></span><br><span class="line">       appendObjectRequest.setPosition((<span class="type">long</span>) ((shardIndex - <span class="number">1</span>) * shardSize));</span><br><span class="line">       <span class="type">AppendObjectResult</span> <span class="variable">appendObjectResult</span> <span class="operator">=</span> ossClient.appendObject(appendObjectRequest);</span><br><span class="line">       <span class="comment">// 文件的64位CRC值。此值根据ECMA-182标准计算得出。</span></span><br><span class="line">       System.out.println(appendObjectResult.getObjectCRC());</span><br><span class="line">       System.out.println(JSONObject.toJSONString(appendObjectResult));</span><br><span class="line">       ossClient.shutdown();</span><br><span class="line"></span><br><span class="line">       LOG.info(<span class="string">&quot;保存文件记录开始&quot;</span>);</span><br><span class="line">       fileDto.setPath(path);</span><br><span class="line">       fileService.save(fileDto);</span><br><span class="line"></span><br><span class="line">       <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">       fileDto.setPath(ossDomain + path);</span><br><span class="line">       responseDto.setContent(fileDto);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> responseDto;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/oss-simple&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseDto <span class="title function_">fileUpload</span><span class="params">(<span class="meta">@RequestParam</span> MultipartFile file, String use)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;上传文件开始&quot;</span>);</span><br><span class="line">        <span class="type">FileUseEnum</span> <span class="variable">useEnum</span> <span class="operator">=</span> FileUseEnum.getByCode(use);</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> UuidUtil.getShortUuid();</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>).toLowerCase();</span><br><span class="line">        <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> useEnum.name().toLowerCase();</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> dir + <span class="string">&quot;/&quot;</span> + key + <span class="string">&quot;.&quot;</span> + suffix;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        <span class="type">OSS</span> <span class="variable">ossClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OSSClientBuilder</span>().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建PutObjectRequest对象。</span></span><br><span class="line"><span class="comment">//        String content = &quot;Hello OSS&quot;;</span></span><br><span class="line">        <span class="comment">// &lt;yourObjectName&gt;表示上传文件到OSS时需要指定包含文件后缀在内的完整路径，例如abc/efg/123.jpg。</span></span><br><span class="line">        <span class="type">PutObjectRequest</span> <span class="variable">putObjectRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PutObjectRequest</span>(bucket, path, <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(file.getBytes()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果需要上传时设置存储类型与访问权限，请参考以下示例代码。</span></span><br><span class="line">        <span class="comment">// ObjectMetadata metadata = new ObjectMetadata();</span></span><br><span class="line">        <span class="comment">// metadata.setHeader(OSSHeaders.OSS_STORAGE_CLASS, StorageClass.Standard.toString());</span></span><br><span class="line">        <span class="comment">// metadata.setObjectAcl(CannedAccessControlList.Private);</span></span><br><span class="line">        <span class="comment">// putObjectRequest.setMetadata(metadata);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 上传字符串。</span></span><br><span class="line">        ossClient.putObject(putObjectRequest);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        LOG.info(&quot;保存文件记录开始&quot;);</span></span><br><span class="line"><span class="comment">//        fileDto.setPath(path);</span></span><br><span class="line"><span class="comment">//        fileService.save(fileDto);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">        <span class="type">FileDto</span> <span class="variable">fileDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileDto</span>();</span><br><span class="line">        fileDto.setPath(ossDomain + path);</span><br><span class="line">        responseDto.setContent(fileDto);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseDto;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>里面的一些参数我们在application中写入</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#oss</span></span><br><span class="line"><span class="attr">accessKeyId</span> = <span class="string">自己申请的Id</span></span><br><span class="line"><span class="attr">accessKeySecret</span> = <span class="string">自己申请的</span></span><br><span class="line"><span class="attr">endpoint</span> = <span class="string">http://oss-cn-shanghai.aliyuncs.com</span></span><br><span class="line"><span class="attr">ossDomain</span> = <span class="string">http://course-imooc123.oss-cn-shanghai.aliyuncs.com</span></span><br><span class="line"><span class="attr">bucket</span> = <span class="string">course-imooc123</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后分别把big-file和file.vue的upload</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_this.$ajax.post(process.env.VUE_APP_SERVER + &#x27;/file/admin/oss-append&#x27;, param)</span><br><span class="line"> _this.$ajax.post(process.env.VUE_APP_SERVER + &#x27;/file/admin/oss-simple&#x27;, param)</span><br></pre></td></tr></table></figure>

<ul>
<li>使用的时候，就跟平常一样，引入组件</li>
</ul>
<h2 id="10-3-阿里云视频点播服务介绍"><a href="#10-3-阿里云视频点播服务介绍" class="headerlink" title="10-3 阿里云视频点播服务介绍"></a>10-3 阿里云视频点播服务介绍</h2><p>阿里云视频点播服务介绍：</p>
<ul>
<li>视频点播（ApsaraVideo VoD，简称VoD）是集视频采集、编辑、上传、媒体资源管理、自动化转码处理（窄带高清™）、视频审核分析、分发加速于一体的一站式音视频点播解决方案。</li>
</ul>
<p>视频点播控台的使用：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/18/rVwLAcmoHM5NdIp.png"
                      alt="image-20220318100227475"
                ></p>
<p>视频点播帮助文档概览：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2022/03/18/Out79eVMalPJjCE.png"
                      alt="image-20220318100727542"
                ></p>
<h2 id="10-4-基于OSS原生SDK上传视频到点播1"><a href="#10-4-基于OSS原生SDK上传视频到点播1" class="headerlink" title="10-4 基于OSS原生SDK上传视频到点播1"></a>10-4 基于OSS原生SDK上传视频到点播1</h2><p><strong>VOD上传并加密转码：</strong></p>
<p>1.视频加密与授权播放：基于oss原生SDK上传视频到点播服务，官方示例代码</p>
<ul>
<li>在course和server中pom都加入jar包</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--阿里云oss--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.10.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 阿里云vod --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-java-sdk-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-java-sdk-vod<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在server的util中增加VodUtil</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.server.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSClient;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.DefaultAcsClient;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.exceptions.ClientException;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.profile.DefaultProfile;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.vod.model.v20170321.CreateUploadVideoRequest;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.vod.model.v20170321.CreateUploadVideoResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VodUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DefaultAcsClient <span class="title function_">initVodClient</span><span class="params">(String accessKeyId, String accessKeySecret)</span> <span class="keyword">throws</span> ClientException &#123;</span><br><span class="line">        <span class="comment">// 根据点播接入服务所在的Region填写，例如：接入服务在上海，则填cn-shanghai；其他区域请参见存储说明。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">regionId</span> <span class="operator">=</span> <span class="string">&quot;cn-shanghai&quot;</span>;</span><br><span class="line">        <span class="type">DefaultProfile</span> <span class="variable">profile</span> <span class="operator">=</span> DefaultProfile.getProfile(regionId, accessKeyId, accessKeySecret);</span><br><span class="line">        <span class="type">DefaultAcsClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAcsClient</span>(profile);</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CreateUploadVideoResponse <span class="title function_">createUploadVideo</span><span class="params">(DefaultAcsClient vodClient)</span> <span class="keyword">throws</span> ClientException &#123;</span><br><span class="line">        <span class="type">CreateUploadVideoRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreateUploadVideoRequest</span>();</span><br><span class="line">        request.setFileName(<span class="string">&quot;vod_test.mp4&quot;</span>);</span><br><span class="line">        request.setTitle(<span class="string">&quot;this is title&quot;</span>);</span><br><span class="line">        <span class="comment">//request.setDescription(&quot;this is desc&quot;);</span></span><br><span class="line">        <span class="comment">//request.setTags(&quot;tag1,tag2&quot;);</span></span><br><span class="line">        <span class="comment">//CoverURL示例：http://example.aliyundoc.com/test_cover_****.jpg</span></span><br><span class="line">        <span class="comment">//request.setCoverURL(&quot;&lt;your CoverURL&gt;&quot;);</span></span><br><span class="line">        <span class="comment">//request.setCateId(-1L);</span></span><br><span class="line">        <span class="comment">//request.setTemplateGroupId(&quot;&quot;);</span></span><br><span class="line">        <span class="comment">//request.setWorkflowId(&quot;&quot;);</span></span><br><span class="line">        <span class="comment">//request.setStorageLocation(&quot;&quot;);</span></span><br><span class="line">        <span class="comment">//request.setAppId(&quot;app-1000000&quot;);</span></span><br><span class="line">        <span class="comment">//设置请求超时时间</span></span><br><span class="line">        request.setSysReadTimeout(<span class="number">1000</span>);</span><br><span class="line">        request.setSysConnectTimeout(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> vodClient.getAcsResponse(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> OSSClient <span class="title function_">initOssClient</span><span class="params">(JSONObject uploadAuth, JSONObject uploadAddress)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> uploadAddress.getString(<span class="string">&quot;Endpoint&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">accessKeyId</span> <span class="operator">=</span> uploadAuth.getString(<span class="string">&quot;AccessKeyId&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">accessKeySecret</span> <span class="operator">=</span> uploadAuth.getString(<span class="string">&quot;AccessKeySecret&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">securityToken</span> <span class="operator">=</span> uploadAuth.getString(<span class="string">&quot;SecurityToken&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OSSClient</span>(endpoint, accessKeyId, accessKeySecret, securityToken);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">uploadLocalFile</span><span class="params">(OSSClient ossClient, JSONObject uploadAddress, String localFile)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">bucketName</span> <span class="operator">=</span> uploadAddress.getString(<span class="string">&quot;Bucket&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> uploadAddress.getString(<span class="string">&quot;FileName&quot;</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(localFile);</span><br><span class="line">        ossClient.putObject(bucketName, objectName, file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> &#123;</span><br><span class="line">        <span class="comment">//您的AccessKeyId</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">accessKeyId</span> <span class="operator">=</span> <span class="string">&quot;您的AccessKeyId&quot;</span>;</span><br><span class="line">        <span class="comment">//您的AccessKeySecret</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">accessKeySecret</span> <span class="operator">=</span> <span class="string">&quot;您的AccessKeySecret&quot;</span>;</span><br><span class="line">        <span class="comment">//需要上传到VOD的本地视频文件的完整路径，需要包含文件扩展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">localFile</span> <span class="operator">=</span> <span class="string">&quot;C:\\Users\\1\\Desktop\\fang\\course\\admin\\public\\static\\image\\小节视频\\test.mp4&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 初始化VOD客户端并获取上传地址和凭证</span></span><br><span class="line">            <span class="type">DefaultAcsClient</span> <span class="variable">vodClient</span> <span class="operator">=</span> initVodClient(accessKeyId, accessKeySecret);</span><br><span class="line">            <span class="type">CreateUploadVideoResponse</span> <span class="variable">createUploadVideoResponse</span> <span class="operator">=</span> createUploadVideo(vodClient);</span><br><span class="line">            <span class="comment">// 执行成功会返回VideoId、UploadAddress和UploadAuth</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">videoId</span> <span class="operator">=</span> createUploadVideoResponse.getVideoId();</span><br><span class="line"></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">uploadAuth</span> <span class="operator">=</span> JSONObject.parseObject(</span><br><span class="line">                    Base64.decodeBase64(createUploadVideoResponse.getUploadAuth()),JSONObject.class);</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">uploadAddress</span> <span class="operator">=</span> JSONObject.parseObject(</span><br><span class="line">                    Base64.decodeBase64(createUploadVideoResponse.getUploadAddress()),JSONObject.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用UploadAuth和UploadAddress初始化OSS客户端</span></span><br><span class="line">            <span class="type">OSSClient</span> <span class="variable">ossClient</span> <span class="operator">=</span> initOssClient(uploadAuth, uploadAddress);</span><br><span class="line">            <span class="comment">// 上传文件，注意是同步上传会阻塞等待，耗时与文件大小和网络上行带宽有关</span></span><br><span class="line">            uploadLocalFile(ossClient, uploadAddress, localFile);</span><br><span class="line">            System.out.println(<span class="string">&quot;Put local file succeed, VideoId : &quot;</span> + videoId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Put local file fail, ErrorMessage : &quot;</span> + e.getLocalizedMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">decodeBase64</span><span class="params">(String data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(Base64.decodeBase64(data));</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-5-基于OSS原生SDK上传视频到点播2"><a href="#10-5-基于OSS原生SDK上传视频到点播2" class="headerlink" title="10-5 基于OSS原生SDK上传视频到点播2"></a>10-5 基于OSS原生SDK上传视频到点播2</h2><p>2.视频加密与授权播放：基于OSS原生SDK上传视频到点播服务，上传到指定分类并自动转码：</p>
<ul>
<li>把上面这部分注释注释掉</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.setCoverURL(<span class="string">&quot;https://s2.loli.net/2022/03/18/Out79eVMalPJjCE.png&quot;</span>);</span><br><span class="line">request.setCateId(<span class="number">1000384585L</span>);</span><br><span class="line">request.setTemplateGroupId(<span class="string">&quot;f563e13b2a67fdd2b4e44bc1b1d421c2&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>3.视频点播不支持追加上传：</p>
<ul>
<li>在上面uploadLocalFile方法中官方示例中用是简单上传putObiect，我们要改成我们需要的追加上传,很遗憾是不能实现的。</li>
</ul>
<p><strong>项目集成VOD上传：</strong></p>
<p>1.视频加密与授权播放：小节增加vod字段：</p>
<ul>
<li>我们首先在all小节处增加一列</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `section` <span class="keyword">add</span> <span class="keyword">column</span> (`vod` <span class="type">char</span>(<span class="number">32</span>) comment <span class="string">&#x27;VOD|阿里云VOD&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>然后mybatis-generator，然后我们还需要在sectionDto增加新增的变量。</p>
</li>
<li><p>先对big-file进行修改</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//设置两个默认值</span><br><span class="line">shardSize:&#123;</span><br><span class="line">  default:50*1024</span><br><span class="line">&#125;,</span><br><span class="line">url:&#123;</span><br><span class="line">  default:&quot;oss-append&quot;</span><br><span class="line">&#125;,</span><br><span class="line">//使用默认值</span><br><span class="line">let shardSize = _this.shardSize;</span><br><span class="line">_this.$ajax.post(process.env.VUE_APP_SERVER + &#x27;/file/admin/&#x27;+_this.url, param)</span><br></pre></td></tr></table></figure>

<p>2，视频加密与授权播放：增加vod组件，用于上传视频到视频点播服务：</p>
<ul>
<li><p>vod组件就是对big-file组件做了一层封装，要注意度，封装得越多，灵活度就越低。</p>
</li>
<li><p>然后我们就在组件中创建一个vod.vue</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;big-file v-bind:input-id=&quot;inputId&quot;</span><br><span class="line">            v-bind:text=&quot;text&quot;</span><br><span class="line">            v-bind:suffixs=&quot;suffixs&quot;</span><br><span class="line">            v-bind:use=&quot;use&quot;</span><br><span class="line">            v-bind:after-upload=&quot;afterUpload&quot;</span><br><span class="line">            v-bind:shard-size=&quot;shardSize&quot;</span><br><span class="line">            v-bind:url=&quot;oss-append&quot;&gt;&lt;/big-file&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import BigFile from &quot;./big-file&quot;</span><br><span class="line">export default &#123;</span><br><span class="line">  components:&#123;BigFile&#125;,</span><br><span class="line">  name: &#x27;vod&#x27;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    text: &#123;</span><br><span class="line">      default: &quot;上传VOD&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    inputId: &#123;</span><br><span class="line">      default: &quot;vod-upload&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    suffixs: &#123;</span><br><span class="line">      default: []</span><br><span class="line">    &#125;,</span><br><span class="line">    use: &#123;</span><br><span class="line">      default: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    shardSize:&#123;</span><br><span class="line">      default:50*1024</span><br><span class="line">    &#125;,</span><br><span class="line">    afterUpload: &#123;</span><br><span class="line">      type: Function,</span><br><span class="line">      default: null</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  data: function () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在js里对video赋值，vue会监听到值的变化”并渲染视频控件。如果还没渲染完，我们就去获取时长，这时就会得到NaN，所以需要加延时获取。因此我们修改section获取时长代码，增加一个延迟。另外我们在section中使用vod组件。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取时长</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">getTime()&#123;</span><br><span class="line">  let _this=<span class="built_in">this</span>;</span><br><span class="line">  setTimeout(function ()&#123;<span class="type">let</span> <span class="variable">ele</span> <span class="operator">=</span>document.getElementById(<span class="string">&quot;video&quot;</span>);</span><br><span class="line">    _this.section.time =parseInt(ele.duration,<span class="number">10</span>);</span><br><span class="line">  &#125;,<span class="number">100</span>);</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>3.视频加密与授权播放：file表增加vod字段</p>
<ul>
<li>我们给file也增加vod字段，其他忽略</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `file` <span class="keyword">add</span> <span class="keyword">column</span> (`vod` <span class="type">char</span>(<span class="number">32</span>) comment <span class="string">&#x27;Vod|阿里云Vod&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>4.视频加密与授权播放：增加视频点播文件上传功能</p>
<ul>
<li>我们首先修改下application，并将OssController对应的值也进行修改</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#oss</span></span><br><span class="line"><span class="attr">oss.accessKeyId</span> = <span class="string">自己申请的</span></span><br><span class="line"><span class="attr">oss.accessKeySecret</span> = <span class="string">自己申请的</span></span><br><span class="line"><span class="attr">oss.endpoint</span> = <span class="string">http://oss-cn-shanghai.aliyuncs.com</span></span><br><span class="line"><span class="attr">oss.domain</span> = <span class="string">http://course-imooc123.oss-cn-shanghai.aliyuncs.com</span></span><br><span class="line"><span class="attr">oss.bucket</span> = <span class="string">course-imooc123</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#vod</span></span><br><span class="line"><span class="attr">vod.accessKeyId</span> = <span class="string">自己申请的</span></span><br><span class="line"><span class="attr">vod.accessKeySecret</span> = <span class="string">自己申请的</span></span><br></pre></td></tr></table></figure>

<ul>
<li>由于视频点播不支持追加上传，所以使用vod组件进行上传的，只能有一个分片，所以我们将shardSize写死，不给暴漏出去,就默认1G</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v-bind:shard-size=&quot;1000*1024*1024&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来修改VodUtil</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//给函数增加一个参数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CreateUploadVideoResponse <span class="title function_">createUploadVideo</span><span class="params">(DefaultAcsClient vodClient,String fileName)</span> <span class="keyword">throws</span> ClientException &#123;</span><br><span class="line">    request.setFileName(fileName);</span><br><span class="line">    request.setTitle(fileName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//在main中使用该函数</span></span><br><span class="line"><span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;test.mp4&quot;</span>;</span><br><span class="line"><span class="type">CreateUploadVideoResponse</span> <span class="variable">createUploadVideoResponse</span> <span class="operator">=</span> createUploadVideo(vodClient,fileName);</span><br><span class="line">            </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增加简单上传</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ossClient</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uploadAddress</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStream</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">uploadLocalFile</span><span class="params">(OSSClient ossClient, JSONObject uploadAddress, InputStream inputStream)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">bucketName</span> <span class="operator">=</span> uploadAddress.getString(<span class="string">&quot;Bucket&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> uploadAddress.getString(<span class="string">&quot;FileName&quot;</span>);</span><br><span class="line">        <span class="comment">//单文件上传</span></span><br><span class="line">        ossClient.putObject(bucketName, objectName, inputStream);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>下面加这个方法的目的就是去获取播放地址</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取源文件信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> client</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> videoId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> ClientException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> GetMezzanineInfoResponse <span class="title function_">getMezzanineInfo</span><span class="params">(DefaultAcsClient client,String videoId)</span> <span class="keyword">throws</span> ClientException &#123;</span><br><span class="line">    <span class="type">GetMezzanineInfoRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetMezzanineInfoRequest</span>();</span><br><span class="line">    request.setVideoId(videoId);</span><br><span class="line">    <span class="comment">//源片下载地址过期时间</span></span><br><span class="line">    request.setAuthTimeout(<span class="number">3600L</span>);</span><br><span class="line">    <span class="keyword">return</span> client.getAcsResponse(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>阿里云JAR里的实体类里没有重写tostring（方法，所以每次打印日志都要用JSoN.to]sONString()，这就是为什么我要求自己的实体类要生成tostring（）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">&quot;视频上传成功, VideoId : &quot;</span> + videoId);<span class="comment">//再这之后添加代码</span></span><br><span class="line"><span class="type">GetMezzanineInfoResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetMezzanineInfoResponse</span>();</span><br><span class="line">response = getMezzanineInfo(vodClient,videoId);</span><br><span class="line">System.out.println(<span class="string">&quot;获取视频信息,response : &quot;</span>+ JSON.toJSONString(response));</span><br></pre></td></tr></table></figure>

<ul>
<li>我们新建一个VodController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.course.file.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSClient;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.DefaultAcsClient;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.vod.model.v20170321.CreateUploadVideoResponse;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.vod.model.v20170321.GetMezzanineInfoResponse;</span><br><span class="line"><span class="keyword">import</span> com.course.server.dto.FileDto;</span><br><span class="line"><span class="keyword">import</span> com.course.server.dto.ResponseDto;</span><br><span class="line"><span class="keyword">import</span> com.course.server.enums.FileUseEnum;</span><br><span class="line"><span class="keyword">import</span> com.course.server.service.FileService;</span><br><span class="line"><span class="keyword">import</span> com.course.server.util.Base64ToMultipartFile;</span><br><span class="line"><span class="keyword">import</span> com.course.server.util.VodUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VodController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(VodController.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUSINESS_NAME</span> <span class="operator">=</span> <span class="string">&quot;文件上传&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;vod.accessKeyId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKeyId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;vod.accessKeySecret&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKeySecret;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> FileService fileService;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@PostMapping(&quot;/vod&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseDto <span class="title function_">fileUpload</span><span class="params">(<span class="meta">@RequestBody</span> FileDto fileDto)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">       LOG.info(<span class="string">&quot;上传文件开始&quot;</span>);</span><br><span class="line">       <span class="type">String</span> <span class="variable">use</span> <span class="operator">=</span> fileDto.getUse();</span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> fileDto.getKey();</span><br><span class="line">       <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> fileDto.getSuffix();</span><br><span class="line">       <span class="type">Integer</span> <span class="variable">shardIndex</span> <span class="operator">=</span> fileDto.getShardIndex();</span><br><span class="line">       <span class="type">Integer</span> <span class="variable">shardSize</span> <span class="operator">=</span> fileDto.getShardSize();</span><br><span class="line">       <span class="type">String</span> <span class="variable">shardBase64</span> <span class="operator">=</span> fileDto.getShard();</span><br><span class="line">       <span class="type">MultipartFile</span> <span class="variable">shard</span> <span class="operator">=</span> Base64ToMultipartFile.base64ToMultipart(shardBase64);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 保存文件到本地</span></span><br><span class="line">       <span class="type">FileUseEnum</span> <span class="variable">useEnum</span> <span class="operator">=</span> FileUseEnum.getByCode(use);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//如果文件夹不存在则创建</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> useEnum.name().toLowerCase();</span><br><span class="line"></span><br><span class="line">       <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(dir)</span><br><span class="line">               .append(File.separator)</span><br><span class="line">               .append(key)</span><br><span class="line">               .append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">               .append(suffix)</span><br><span class="line">               .toString();</span><br><span class="line"></span><br><span class="line">       <span class="type">String</span> <span class="variable">vod</span> <span class="operator">=</span><span class="string">&quot;&quot;</span>;</span><br><span class="line">       <span class="type">String</span> <span class="variable">fileUrl</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 初始化VOD客户端并获取上传地址和凭证</span></span><br><span class="line">           <span class="type">DefaultAcsClient</span> <span class="variable">vodClient</span> <span class="operator">=</span> VodUtil.initVodClient(accessKeyId, accessKeySecret);</span><br><span class="line">           <span class="type">CreateUploadVideoResponse</span> <span class="variable">createUploadVideoResponse</span> <span class="operator">=</span> VodUtil.createUploadVideo(vodClient,path);</span><br><span class="line">           <span class="comment">// 执行成功会返回VideoId、UploadAddress和UploadAuth</span></span><br><span class="line">           vod = createUploadVideoResponse.getVideoId();</span><br><span class="line"></span><br><span class="line">           <span class="type">JSONObject</span> <span class="variable">uploadAuth</span> <span class="operator">=</span> JSONObject.parseObject(</span><br><span class="line">                   Base64.decodeBase64(createUploadVideoResponse.getUploadAuth()),JSONObject.class);</span><br><span class="line">           <span class="type">JSONObject</span> <span class="variable">uploadAddress</span> <span class="operator">=</span> JSONObject.parseObject(</span><br><span class="line">                   Base64.decodeBase64(createUploadVideoResponse.getUploadAddress()),JSONObject.class);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 使用UploadAuth和UploadAddress初始化OSS客户端</span></span><br><span class="line">           <span class="type">OSSClient</span> <span class="variable">ossClient</span> <span class="operator">=</span> VodUtil.initOssClient(uploadAuth, uploadAddress);</span><br><span class="line">           <span class="comment">// 上传文件，注意是同步上传会阻塞等待，耗时与文件大小和网络上行带宽有关</span></span><br><span class="line">           VodUtil.uploadLocalFile(ossClient, uploadAddress, shard.getInputStream());</span><br><span class="line">           System.out.println(<span class="string">&quot;视频上传成功, VideoId : &quot;</span> + vod);</span><br><span class="line">           <span class="type">GetMezzanineInfoResponse</span> <span class="variable">response</span> <span class="operator">=</span>  VodUtil.getMezzanineInfo(vodClient,vod);</span><br><span class="line">           System.out.println(<span class="string">&quot;获取视频信息,response : &quot;</span>+ JSON.toJSONString(response));</span><br><span class="line">           fileUrl = response.getMezzanine().getFileURL();</span><br><span class="line">           ossClient.shutdown();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;文件上传失败, ErrorMessage : &quot;</span> + e.getLocalizedMessage());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       LOG.info(<span class="string">&quot;保存文件记录开始&quot;</span>);</span><br><span class="line">       fileDto.setPath(path);</span><br><span class="line">       fileDto.setVod(vod);</span><br><span class="line">       fileService.save(fileDto);</span><br><span class="line"></span><br><span class="line">       <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">       fileDto.setPath(fileUrl);<span class="comment">//返回给前端的需要一个可播放的地址，为了自动获取时长</span></span><br><span class="line">       responseDto.setContent(fileDto);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> responseDto;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改section</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//获取到的可播放地址是有时效的，所以就算保存到数据库也会过期没用。以后会根据vod来播放，所以我们保存的时候将video的全路径清空，在save方法中加</span><br><span class="line">_this.section.video=&quot;&quot;;</span><br><span class="line">//上传完文件后，多返回一个vod，那么我们在afterUpload方法中将vod放到section.vod中</span><br><span class="line">let vod =resp.content.vod;</span><br><span class="line">_this.section.vod = vod;</span><br></pre></td></tr></table></figure>

<p>5.视频加密与授权播放：文件检查时，根据是否是视频点播文件来获取视频信息</p>
<ul>
<li>在UploadController中check方法增加判断vod是否有值，如过有就上传vod的地址，如果没有就上传本地地址</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;vod.accessKeyId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String accessKeyId;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;vod.accessKeySecret&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String accessKeySecret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(fileDto != <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(fileDto.getVod()))&#123;</span><br><span class="line">        fileDto.setPath(FILE_DOMAIN+fileDto.getPath());</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="type">DefaultAcsClient</span> <span class="variable">vodClient</span> <span class="operator">=</span> VodUtil.initVodClient(accessKeyId, accessKeySecret);</span><br><span class="line">        <span class="type">GetMezzanineInfoResponse</span> <span class="variable">response</span> <span class="operator">=</span>  VodUtil.getMezzanineInfo(vodClient,fileDto.getVod());</span><br><span class="line">        System.out.println(<span class="string">&quot;获取视频信息,response : &quot;</span>+ JSON.toJSONString(response));</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileUrl</span> <span class="operator">=</span> response.getMezzanine().getFileURL();</span><br><span class="line">        fileDto.setPath(fileUrl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-6-视频授权播放功能开发"><a href="#10-6-视频授权播放功能开发" class="headerlink" title="10-6 视频授权播放功能开发"></a>10-6 视频授权播放功能开发</h2><p><strong>阿里云播放器的基本使用:</strong></p>
<p>1.视频加密与授权播放：集成阿里云播放器，制作player播放器组件</p>
<ul>
<li>我们再次创建一个组件player.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div v-bind:id=&quot;playerId&quot;&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  export  default &#123;</span><br><span class="line">    name:&#x27;player&#x27;,</span><br><span class="line">    props:&#123;</span><br><span class="line">      playerId:&#123;</span><br><span class="line">        default:&quot;player-div&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    data: function ()&#123;</span><br><span class="line">      return&#123;</span><br><span class="line">        aliPlayer:&#123;&#125;,//播放器实例</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods:&#123;</span><br><span class="line">      playUrl(url)&#123;</span><br><span class="line">        let _this=this;</span><br><span class="line">        console.log(&quot;开始播放:&quot;,url);</span><br><span class="line">        //如果已经有播放器了，则将播放器的div删除</span><br><span class="line">        if (_this.aliPlayer)&#123;</span><br><span class="line">          _this.aliPlayer=null;</span><br><span class="line">          $(&quot;#J_prismPlayer&quot;).remove();</span><br><span class="line">        &#125;</span><br><span class="line">        //初始播放器</span><br><span class="line">        $(&quot;#&quot;+_this.playerId).append(&quot;&lt;div class=\&quot;prism-player\&quot; id=\&quot;J_prismPlayer\&quot;&gt;&lt;/div&gt;&quot;);</span><br><span class="line">        _this.aliPlayer = new Aliplayer(&#123;</span><br><span class="line">          id: &#x27;J_prismPlayer&#x27;,</span><br><span class="line">          width: &#x27;100%&#x27;,</span><br><span class="line">          autoplay:false,</span><br><span class="line">          source:url,</span><br><span class="line">          cover:&#x27;https://s2.loli.net/2022/03/01/6wagXDIZQGcebUt.png&#x27;,</span><br><span class="line">        &#125;,function(player)&#123;</span><br><span class="line">          console.log(&#x27;播放器创建好了&#x27;)</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在index中引入代码js和css</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--  阿里云播放器--&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;https://g.alicdn.com/de/prismplayer/2.9.19/skins/default/aliplayer-min.css&quot; /&gt; </span><br><span class="line"> &lt;!--  阿里云播放器--&gt;</span><br><span class="line">&lt;script charset=&quot;utf-8&quot; type=&quot;text/javascript&quot; src=&quot;https://g.alicdn.com/de/prismplayer/2.9.19/aliplayer-min.js&quot;&gt;&lt;/script&gt; </span><br></pre></td></tr></table></figure>

<ul>
<li>最后我们对section进行修改</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//增加了player，并且将video隐藏起来，不能注释掉，因为我们要用它获取时长</span><br><span class="line">&lt;player ref=&quot;player&quot;&gt;&lt;/player&gt;</span><br><span class="line">&lt;video v-bind:src=&quot;section.video&quot; id=&quot;video&quot; controls=&quot;controls&quot; class=&quot;hidden&quot;&gt;&lt;/video&gt;</span><br><span class="line">//引入player组件</span><br><span class="line">import Player from &quot;../../components/player&quot;;</span><br><span class="line">components: &#123;Player, Pagination,BigFile,Vod&#125;,</span><br><span class="line">//在afterUpload方法中增加，通过url播放视频</span><br><span class="line">_this.$refs.player.playUrl(video);</span><br></pre></td></tr></table></figure>

<p><strong>获取vod授权码并授权播放</strong></p>
<p>1.视频加密与授权播放：获取vod授权码并授权播放，需要在存储管理中将权限设置成公共读         </p>
<ul>
<li>首先在VodUtil中增加</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取播放凭证函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> client</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> GetVideoPlayAuthResponse <span class="title function_">getVideoPlayAuth</span><span class="params">(DefaultAcsClient client, String videoId)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">GetVideoPlayAuthRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetVideoPlayAuthRequest</span>();</span><br><span class="line">    request.setVideoId(videoId);</span><br><span class="line">    <span class="keyword">return</span> client.getAcsResponse(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在VodController中增加请求</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/get-auth/&#123;vod&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> ResponseDto <span class="title function_">getAuth</span><span class="params">(<span class="meta">@PathVariable</span> String vod)</span> <span class="keyword">throws</span> ClientException, ClientException &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;获取播放授权开始: &quot;</span>);</span><br><span class="line">    <span class="type">ResponseDto</span> <span class="variable">responseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseDto</span>();</span><br><span class="line">    <span class="type">DefaultAcsClient</span> <span class="variable">client</span> <span class="operator">=</span> VodUtil.initVodClient(accessKeyId, accessKeySecret);</span><br><span class="line">    <span class="type">GetVideoPlayAuthResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetVideoPlayAuthResponse</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response = VodUtil.getVideoPlayAuth(client, vod);</span><br><span class="line">        LOG.info(<span class="string">&quot;授权码 = &#123;&#125;&quot;</span>, response.getPlayAuth());</span><br><span class="line">        responseDto.setContent(response.getPlayAuth());</span><br><span class="line">        <span class="comment">//VideoMeta信息</span></span><br><span class="line">        LOG.info(<span class="string">&quot;VideoMeta = &#123;&#125;&quot;</span>, JSON.toJSONString(response.getVideoMeta()));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        System.out.print(<span class="string">&quot;ErrorMessage = &quot;</span> + e.getLocalizedMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;获取播放授权结束&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> responseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>一个页面可能会放多个player组件，所以需要把id做成动态变化，一个页面的元素，id值要是唯一的。修改player.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> $(&quot;#&quot;+_this.playerId+&#x27;-player&#x27;).remove();</span><br><span class="line">//初始播放器</span><br><span class="line">$(&quot;#&quot;+_this.playerId).append(&quot;&lt;div class=\&quot;prism-player\&quot; id=\&quot;&quot;+_this.playerId+&quot;-player\&quot;&gt;&lt;/div&gt;&quot;);</span><br><span class="line">_this.aliPlayer = new Aliplayer(&#123;</span><br><span class="line">  id: _this.playerId+&#x27;-player&#x27;,&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在player组件增加一个方法，设置播放凭证</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">playVod (vod) &#123;</span><br><span class="line">  let _this = this;</span><br><span class="line">  Loading.show();</span><br><span class="line">  _this.$ajax.get(process.env.VUE_APP_SERVER + &#x27;/file/admin/get-auth/&#x27; + vod).then((response)=&gt;&#123;</span><br><span class="line">    Loading.hide();</span><br><span class="line">    let resp = response.data;</span><br><span class="line">    if (resp.success) &#123;</span><br><span class="line">      //如果已经有播放器了，则将播放器div删除</span><br><span class="line">      if (_this.aliPlayer) &#123;</span><br><span class="line">        _this.aliPlayer = null;</span><br><span class="line">        $(&quot;#&quot; + _this.playerId + &#x27;-player&#x27;).remove();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 初始化播放器</span><br><span class="line">      $(&quot;#&quot; + _this.playerId).append(&quot;&lt;div class=\&quot;prism-player\&quot; id=\&quot;&quot; + _this.playerId + &quot;-player\&quot;&gt;&lt;/div&gt;&quot;);</span><br><span class="line">      _this.aliPlayer = new Aliplayer(&#123;</span><br><span class="line">        id: _this.playerId + &#x27;-player&#x27;,</span><br><span class="line">        width: &#x27;100%&#x27;,</span><br><span class="line">        autoplay: false,</span><br><span class="line">        vid: vod,</span><br><span class="line">        playauth: resp.content,</span><br><span class="line">        cover: &#x27;http://liveroom-img.oss-cn-qingdao.aliyuncs.com/logo.png&#x27;,</span><br><span class="line">        encryptType:1, //当播放私有加密流时需要设置。</span><br><span class="line">      &#125;,function(player)&#123;</span><br><span class="line">        console.log(&#x27;播放器创建好了。&#x27;)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      Toast.warning(&#x27;播放错误。&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们再创建一个带有模态框的播放器组件modal-player，里面包含了player组件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;player-modal&quot; class=&quot;modal&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;modal-content&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">          &lt;player v-bind:player-id=&quot;&#x27;modal-player-div&#x27;&quot;</span><br><span class="line">                  ref=&quot;player&quot;&gt;&lt;/player&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  import Player from &quot;./player&quot;;</span><br><span class="line">  export default &#123;</span><br><span class="line">    name: &#x27;modal-player&#x27;,</span><br><span class="line">    components: &#123;Player&#125;,</span><br><span class="line">    data: function () &#123;</span><br><span class="line">      return &#123;</span><br><span class="line">        aliPlayer: &#123;&#125;, // 播放器实例</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">      playUrl(url) &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        _this.$refs.player.playUrl(url);</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      playVod(vod) &#123;</span><br><span class="line">        let _this = this;</span><br><span class="line">        _this.$refs.player.playVod(vod);</span><br><span class="line">        $(&quot;#player-modal&quot;).modal(&quot;show&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">  #player-modal .modal-body &#123;</span><br><span class="line">    padding: 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来我们设置个section，改动如下</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//将视频改为VOD</span><br><span class="line">&lt;th&gt;VOD&lt;/th&gt;</span><br><span class="line">//操作中增加一个按钮</span><br><span class="line"> &lt;button v-on:click=&quot;play(section)&quot; class=&quot;btn btn-xs btn-info&quot;&gt;</span><br><span class="line">    &lt;i class=&quot;ace-icon fa fa-video-camera bigger-120&quot;&gt;&lt;/i&gt;</span><br><span class="line"> &lt;/button&gt;</span><br><span class="line">//给player设置一个id</span><br><span class="line">&lt;player v-bind:player-id=&quot;&#x27;form-player-div&#x27;&quot; ref=&quot;player&quot;&gt;&lt;/player&gt;</span><br><span class="line">//再最后一个div前面加</span><br><span class="line">&lt;modal-player ref=&quot;modalPlayer&quot;&gt;&lt;/modal-player&gt;</span><br><span class="line">//引入组件</span><br><span class="line">import ModalPlayer from &quot;../../components/modal-player&quot;;</span><br><span class="line">components: &#123;ModalPlayer, Player, Pagination,BigFile,Vod&#125;,</span><br><span class="line">//增加play方法</span><br><span class="line">play(section)&#123;</span><br><span class="line">  let _this=this;</span><br><span class="line">  _this.$refs.modalPlayer.playVod(section.vod);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post title：完整项目之Spring Cloud + Vue 前后端分离3-2</li>
        <li>Post author：Fang</li>
        <li>Create time：2022-02-25 12:19:22</li>
        <li>
            Post link：https://ainianxu.github.io/2022/02/25/完整项目之Spring Cloud + Vue 前后端分离 3-2/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE/">#完整项目</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2022/03/07/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%204-1/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">完整项目之Spring Cloud + Vue 前后端分离4-1</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2022/02/20/%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%B9%8BSpring%20Cloud%20+%20Vue%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%203-1/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">完整项目之Spring Cloud + Vue 前后端分离3-1</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;Comments</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'loa9BVbgmyFLwBMHhg1Cycx1-gzGzoHsz',
                    appKey: '47pIz6ewIXRi5251WyfUpQOB',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情吐槽吧~',
                    lang: 'en'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Fang';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Fang</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.4</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC9%E7%AB%A0-%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%B8%8E%E6%9E%81%E9%80%9F%E7%A7%92%E4%BC%A0"><span class="nav-number">1.</span> <span class="nav-text">第9章 大文件断点续与极速秒传</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-%E5%88%86%E7%89%87%E4%BC%A0%E8%BE%93%E7%9A%84%E8%AF%95%E6%8E%A2"><span class="nav-number">1.1.</span> <span class="nav-text">9-1 分片传输的试探</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-%E5%88%86%E7%89%87%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%911"><span class="nav-number">1.2.</span> <span class="nav-text">9-2 分片上传功能开发1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3-%E5%88%86%E7%89%87%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%912"><span class="nav-number">1.3.</span> <span class="nav-text">9-3 分片上传功能开发2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-4-%E5%88%86%E7%89%87%E5%90%88%E5%B9%B6%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="nav-number">1.4.</span> <span class="nav-text">9-4 分片合并功能开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-5-%E5%88%86%E7%89%87%E6%A3%80%E6%9F%A5%E4%B8%8E%E6%9E%81%E9%80%9F%E7%A7%92%E4%BC%A0"><span class="nav-number">1.5.</span> <span class="nav-text">9-5 分片检查与极速秒传</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-6-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.6.</span> <span class="nav-text">9-6 文件上传流程图</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC10%E7%AB%A0-%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91OSS%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="nav-number">2.</span> <span class="nav-text">第10章 基于阿里云OSS的文件上传</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-%E9%98%BF%E9%87%8C%E4%BA%91OSS%E7%AE%80%E4%BB%8B"><span class="nav-number">2.1.</span> <span class="nav-text">10-1 阿里云OSS简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-%E5%9F%BA%E4%BA%8EOSS%E6%8E%A5%E5%8F%A3%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="nav-number">2.2.</span> <span class="nav-text">10-2 基于OSS接口的文件上传</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-3-%E9%98%BF%E9%87%8C%E4%BA%91%E8%A7%86%E9%A2%91%E7%82%B9%E6%92%AD%E6%9C%8D%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.3.</span> <span class="nav-text">10-3 阿里云视频点播服务介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-4-%E5%9F%BA%E4%BA%8EOSS%E5%8E%9F%E7%94%9FSDK%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91%E5%88%B0%E7%82%B9%E6%92%AD1"><span class="nav-number">2.4.</span> <span class="nav-text">10-4 基于OSS原生SDK上传视频到点播1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-5-%E5%9F%BA%E4%BA%8EOSS%E5%8E%9F%E7%94%9FSDK%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91%E5%88%B0%E7%82%B9%E6%92%AD2"><span class="nav-number">2.5.</span> <span class="nav-text">10-5 基于OSS原生SDK上传视频到点播2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-6-%E8%A7%86%E9%A2%91%E6%8E%88%E6%9D%83%E6%92%AD%E6%94%BE%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="nav-number">2.6.</span> <span class="nav-text">10-6 视频授权播放功能开发</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/code-copy.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/lazyload.js"></script>


<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/toc.js"></script>
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
