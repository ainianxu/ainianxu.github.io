<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Fang">
    
    <title>
        
            Springboot3+微服务实战12306高性能售票系统 |
        
        念~旭
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/favicon.ico","favicon":"/images/favicon.ico","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_img":"source/images/bg.svg","description":"进来就别走了！"},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.4"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                念~旭
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                LINKS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">LINKS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Springboot3+微服务实战12306高性能售票系统</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/favicon.ico">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Fang</span>
                        
                            <span class="author-label">Lv7</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2023-07-03 11:20:30</span>
        <span class="mobile">2023-07-03 11:20</span>
    </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>98.1k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>491 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="12306这个系统架构到底有多牛？"><a href="#12306这个系统架构到底有多牛？" class="headerlink" title="12306这个系统架构到底有多牛？"></a>12306这个系统架构到底有多牛？</h1><p>本章主要对课程为什么选择12306课程作为实战项目，以及该项目具备哪些亮点及优势做全面分析介绍，从而让大家了解课程设计的初衷以及要达到的目的。</p>
<hr>
<h2 id="众多流行并发项目，为何选择12306？"><a href="#众多流行并发项目，为何选择12306？" class="headerlink" title="众多流行并发项目，为何选择12306？"></a>众多流行并发项目，为何选择12306？</h2><ol>
<li><p>高并发场景有哪些？</p>
<ul>
<li>商品秒杀，双十一（核心：下单、库存-1、不要超卖）</li>
<li>微信支付宝平台</li>
<li>微博突发热点</li>
<li>用户操作日志</li>
<li>12306购票平台</li>
</ul>
</li>
<li><p>为什么选择12306？</p>
<ul>
<li>业务复杂度高于淘宝双十一，考验个人程序设计能力（动态库存、选座功能、线上线下）</li>
<li>持续高并发业务，更需要综合的<strong>高并发</strong>设计（不停的刷票，绝不能超卖）</li>
</ul>
</li>
</ol>
<h2 id="12306-是如何成为全球最忙碌的网站之一"><a href="#12306-是如何成为全球最忙碌的网站之一" class="headerlink" title="12306 是如何成为全球最忙碌的网站之一"></a>12306 是如何成为全球最忙碌的网站之一</h2><ol>
<li><p>12306有多忙碌？</p>
<ul>
<li>一天的请求量大概1600亿，平均180万&#x2F;秒</li>
<li>平均一年售出30亿张，高峰期日售票能力达到了2000万张</li>
<li>高峰期1秒可卖出1300张票</li>
</ul>
</li>
<li><p>如何解决忙碌问题？</p>
<ul>
<li>提高处理能力：QPS和TPS<ul>
<li>堆积硬件  </li>
<li>软件：Gemfire</li>
<li>算法：模型、逻辑</li>
</ul>
</li>
<li>削峰、填谷<ul>
<li><strong>业务</strong>：验证码、分时段、排队</li>
<li><strong>技术</strong>：限流、异步</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="如何保证不超卖、不少卖，还要能承受极高的并发？"><a href="#如何保证不超卖、不少卖，还要能承受极高的并发？" class="headerlink" title="如何保证不超卖、不少卖，还要能承受极高的并发？"></a>如何保证不超卖、不少卖，还要能承受极高的并发？</h2><ol>
<li>模型设计&amp;逻辑实现<ul>
<li>余票查询：<strong>记录站站余票</strong><ul>
<li>一列火车有5个站，可拆分成4+3+2+1&#x3D;10条站站记录（A-&gt;BCDE,B-&gt;CDE,C-&gt;DE,D-&gt;E）</li>
</ul>
</li>
<li>座位购买：<strong>记录座位销售详情</strong><ul>
<li>·一列火车有5个站AE，1号座位：0111，代表只剩AB可买</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="12306系统核心功能"><a href="#12306系统核心功能" class="headerlink" title="12306系统核心功能"></a>12306系统核心功能</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307031337700.png"
                      alt="image-20230703133737365"
                ></p>
<h2 id="12306系统功能模块划分"><a href="#12306系统功能模块划分" class="headerlink" title="12306系统功能模块划分"></a>12306系统功能模块划分</h2><ul>
<li>gateway 网关模块：路由转发、登录校验</li>
<li>member 会员模块：会员、乘客、已购买的车票</li>
<li>business 业务模块：所有的车次数据、余票信息</li>
<li>batch 跑批模块：所有的定时任务，可通过界面启停</li>
<li>web 模块：会员相关界面</li>
<li>admin 模块：管理员相关界面</li>
</ul>
<h2 id="12306整体系统架构设计"><a href="#12306整体系统架构设计" class="headerlink" title="12306整体系统架构设计"></a>12306整体系统架构设计</h2><ul>
<li>简单的模块划分</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307031355249.png"
                      alt="image-20230703135510116"
                ></p>
<ul>
<li>加入common模块，放置公共代码；制作generator代码生成器模块</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307031355392.png"
                      alt="image-20230703135523259"
                ></p>
<ul>
<li>加入中间件及微服务组件</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307031355604.png"
                      alt="image-20230703135537474"
                ></p>
<h2 id="12306系统数据库表"><a href="#12306系统数据库表" class="headerlink" title="12306系统数据库表"></a>12306系统数据库表</h2><ul>
<li><p><strong>会员模块：</strong></p>
<ul>
<li>会员表：手机号</li>
<li>乘客表：会员ID，姓名，身份证，旅客类型</li>
<li>车票表：会员ID，乘客ID，乘客姓名，日期，车次信息，座位信息</li>
</ul>
</li>
<li><p><strong>业务模块：</strong></p>
<ul>
<li>车站表：站名，站名拼音</li>
<li>车次表：车次编号，车次类型，始发站，出发时间，终点站，到站时间</li>
<li>到站表：车次编号，站名，进站时间，出站时间，停站时长，里程</li>
<li>车箱表：车次编号，箱号，座位类型，座位数，排数，列数</li>
<li>座位表：车次编号，箱号，排号，列号</li>
<li>每日车次表：日期，基础车次信息</li>
<li>每日到站表：日期，基础到站信息</li>
<li>每日车箱表：日期，基础车箱信息</li>
<li>每日座位表：日期，基础座位信息，销售详情</li>
<li>每日余票表：日期，车次编号，出发站，出发时间，到达站，到站时间，各种座位的余票信息</li>
</ul>
</li>
<li><p><strong>其它：</strong></p>
<ul>
<li>quartz相关表</li>
<li>seata相关表</li>
</ul>
</li>
</ul>
<h2 id="百万人同时抢1万张票，系统如何保证其正常及稳定性？-持续秒杀高并发技术"><a href="#百万人同时抢1万张票，系统如何保证其正常及稳定性？-持续秒杀高并发技术" class="headerlink" title="百万人同时抢1万张票，系统如何保证其正常及稳定性？(持续秒杀高并发技术)"></a>百万人同时抢1万张票，系统如何保证其正常及稳定性？(持续秒杀高并发技术)</h2><ul>
<li>前端<ul>
<li>针对静态资源做CDN(<strong>内容分发网络</strong>)</li>
<li>页面静态化</li>
<li>倒计时&amp;Loading</li>
<li>使用验证码削峰（两层验证码：纯前端验证码+后端验证码，牺牲一点用户体验，解决瞬时超大流量问题）</li>
</ul>
</li>
<li>后端<ul>
<li>微服务-服务拆分(<strong>一般是按照功能模块来划分，热点接口也可以单独做成一个服务</strong>)</li>
<li>负载均衡</li>
<li>限流降级</li>
<li>缓存（<strong>穿透、击穿、雪崩</strong>）</li>
<li>令牌</li>
<li>异步处理</li>
</ul>
</li>
<li>数据库<ul>
<li>分库：业务分库、读写分离（<strong>将不同业务的表放在不同的数据库中，相互隔离</strong>）</li>
<li>分表：横向分表（<strong>一般按照地区或时间来划分</strong>）、纵向分表（<strong>就是把一张完整的表，纵向切一刀，变成两张表</strong>，比如：文章表一：标题 作者 时间，文章表二：内容（大字段））</li>
<li>冗余设计，反范式，空间换时间</li>
<li>分布式数据库</li>
</ul>
</li>
<li>其它<ul>
<li>分时段秒杀</li>
<li>弹性扩容</li>
<li>候补+排队</li>
</ul>
</li>
</ul>
<h1 id="最新版的SpringBoot3-amp-JDK9-17新特性详解"><a href="#最新版的SpringBoot3-amp-JDK9-17新特性详解" class="headerlink" title="最新版的SpringBoot3&amp;JDK9~17新特性详解"></a>最新版的SpringBoot3&amp;JDK9~17新特性详解</h1><p>目前市面上大多数Java项目都还在用JDK1.8，导致很多程序员也没用过高版本JDK，本章将带大家从JDK9到JDK17学习每个版本的一些重要的特性，以及最新发布的SpringBoot3的新特性，并在项目开发中全面应用。</p>
<hr>
<h2 id="JDK9新特性-jshell交互式工具-加片头"><a href="#JDK9新特性-jshell交互式工具-加片头" class="headerlink" title="JDK9新特性-jshell交互式工具(加片头)"></a>JDK9新特性-jshell交互式工具(加片头)</h2><ul>
<li>友情提醒：正式项目中不推荐使用JDK17，各种每三方框架可能不兼容17</li>
<li>在JDK17版本下直接在终端中打jshell，就可以直接在里面运行java语句，比较适合用于教学</li>
</ul>
<h2 id="JDK9新特性-模块化开发"><a href="#JDK9新特性-模块化开发" class="headerlink" title="JDK9新特性-模块化开发"></a>JDK9新特性-模块化开发</h2><ul>
<li>当内部工具类或数据类，不能设置成private，又不想被外部引用到，这里要求：Test1要被外部引用，Test2不能被外部使用，且不能是private，这时就需要用的JDK9模块的概念</li>
<li>Java8应用程序将包作为顶级组件，Java9应用程序将模块作为顶级组件。<ul>
<li>使用<strong>module-info.java</strong>来声明一个模块，一个模块只能有一个文件，且在顶层包同目录下</li>
<li>使用<strong>exports来声明可以被外部引用的包</strong>，可以有多个exports语句</li>
<li>使用<strong>requires来声明依赖的外部的模块</strong>，可以有多个requires语句</li>
</ul>
</li>
</ul>
<h2 id="JDK10新特性-var局部变量推导"><a href="#JDK10新特性-var局部变量推导" class="headerlink" title="JDK10新特性-var局部变量推导"></a>JDK10新特性-var局部变量推导</h2><ul>
<li>必须能推导出实际类型，包括基础数据类型</li>
<li>只能用于局部变量</li>
</ul>
<h2 id="JDK11新特性-单文件程序"><a href="#JDK11新特性-单文件程序" class="headerlink" title="JDK11新特性-单文件程序"></a>JDK11新特性-单文件程序</h2><ul>
<li>直接命令运行：<strong>java xxx.java</strong></li>
<li><strong>必须带.java</strong></li>
</ul>
<h2 id="JDK11新特性-shebang脚本"><a href="#JDK11新特性-shebang脚本" class="headerlink" title="JDK11新特性-shebang脚本"></a>JDK11新特性-shebang脚本</h2><ul>
<li>将java文件改成sh后缀，使用如下命令可运行：java –source 11 <a class="link"   target="_blank" rel="noopener" href="http://xxx.sh/" >xxx.sh<i class="fas fa-external-link-alt"></i></a></li>
<li>什么是shebang：<ul>
<li>#!符号可以叫做shebang，翻译成释伴,即”解释伴随行”的简称,同时又是shebang的音译</li>
<li>以指令#!&#x2F;bin&#x2F;bash开头的文件,在执行时会实际调用&#x2F;bin&#x2F;bash程序来执行</li>
</ul>
</li>
</ul>
<h2 id="JDK14新特性-文本块"><a href="#JDK14新特性-文本块" class="headerlink" title="JDK14新特性-文本块"></a>JDK14新特性-文本块</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统字符串写法</span></span><br><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;\tname: \&quot;TEST\&quot;\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">System.out.println(json);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文本块写法</span></span><br><span class="line"><span class="type">String</span> <span class="variable">json1</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">           name: &quot;TEST&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>;</span><br><span class="line">System.out.println(json1);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="JDK14新特性-instanceof增强"><a href="#JDK14新特性-instanceof增强" class="headerlink" title="JDK14新特性-instanceof增强"></a>JDK14新特性-instanceof增强</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//加强前</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;123&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (a <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">b</span> <span class="operator">=</span> (String) a;</span><br><span class="line">    System.out.println(b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//加强后</span></span><br><span class="line"><span class="keyword">if</span> (a <span class="keyword">instanceof</span> String b) &#123;</span><br><span class="line">    System.out.println(b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="JDK14新特性-空指针提示"><a href="#JDK14新特性-空指针提示" class="headerlink" title="JDK14新特性-空指针提示"></a>JDK14新特性-空指针提示</h2><blockquote>
<p>传统报错：</p>
<p>Exception in thread “main” java.lang.NullPointerException</p>
<p>​    at com.fzx2.Jiawa2.main(Jiawa2.java:46)</p>
</blockquote>
<blockquote>
<p> 新报错</p>
<p>Exception in thread “main” java.lang.NullPointerException: Cannot invoke “java.util.List.size()” because “a” is null</p>
<p>​    at com.fzx2.Jiawa2.main(Jiawa2.java:46)</p>
</blockquote>
<h2 id="JDK16新特性-record类"><a href="#JDK16新特性-record类" class="headerlink" title="JDK16新特性-record类"></a>JDK16新特性-record类</h2><ul>
<li>record是一个final类，初始化后就不能修改属性值</li>
<li>自动生成toString, hashCode, equals方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">TestRecord</span><span class="params">(String name,String password)</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="JDK17新特性-sealed类"><a href="#JDK17新特性-sealed类" class="headerlink" title="JDK17新特性-sealed类"></a>JDK17新特性-sealed类</h2><ul>
<li><strong>痛点</strong>：一个类被哪些子类继承了，很难查，随时有可能继续被继承</li>
<li>sealed可以对类的继承做显式的管理，一个类被哪些类继承，一眼就能看得清</li>
<li>sealed类封装类或叫密封类<ul>
<li>密封类的目的是为了限制子类的过度使用，父类的开发者必须声明哪些子类可以继承该父类，以确保不会出现未限定的子类继承父类，导致程序出现预料之外的问题</li>
<li>密封类及其允许的子类必须属于同一个模块。</li>
<li>每个允许的子类都必须直接继承密封类。</li>
<li>每个允许的子类都必须使用<strong>final、sealed或non-sealed修饰符</strong>中的一个来描述：<ul>
<li>允许的子类声明为 <strong>final</strong> 表示它无法再扩展。</li>
<li>允许的子类声明为<strong>sealed</strong>表示它可以以一种受限制的方式进一步扩展。</li>
<li>允许的子类声明为<strong>non-sealed</strong>表示它可以任意的扩展。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="JDK17新特性-switch增强"><a href="#JDK17新特性-switch增强" class="headerlink" title="JDK17新特性-switch增强"></a>JDK17新特性-switch增强</h2><ul>
<li>他是结合instanceof使用的，相当于整合一下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">旧版本</span><br><span class="line"><span class="keyword">if</span> (data.get(<span class="string">&quot;key&quot;</span>) <span class="keyword">instanceof</span> String s) &#123;</span><br><span class="line">  log.info(s);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.get(<span class="string">&quot;key&quot;</span>) <span class="keyword">instanceof</span> Double s) &#123;</span><br><span class="line">  log.info(s);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.get(<span class="string">&quot;key&quot;</span>) <span class="keyword">instanceof</span> Integer s) &#123;</span><br><span class="line">  log.info(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">新版本</span><br><span class="line"><span class="keyword">switch</span> (data.get(<span class="string">&quot;key1&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">case</span> String s  -&gt; log.info(s);</span><br><span class="line">  <span class="keyword">case</span> Double d  -&gt; log.info(d.toString());</span><br><span class="line">  <span class="keyword">case</span> Integer i -&gt; log.info(i.toString());</span><br><span class="line">  <span class="keyword">default</span>        -&gt; log.info(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SpringBoot3-AOT与JIT介绍"><a href="#SpringBoot3-AOT与JIT介绍" class="headerlink" title="SpringBoot3-AOT与JIT介绍"></a>SpringBoot3-AOT与JIT介绍</h2><ul>
<li>JIT（Just-in-Time，实时编译）一直是Java语言的灵魂特性之一，与之相对的AOT（Ahead-of-Time，预编译或提前编译）方式</li>
<li>AOT的优点<ul>
<li><strong>在程序运行前编译</strong>，可以避免在运行时的编译性能消耗和内存消耗</li>
<li><strong>可以在程序运行初期就达到最高性能，程序启动速度快</strong></li>
<li><strong>运行产物只有机器码，打包体积小</strong></li>
</ul>
</li>
<li>AOT的缺点<ul>
<li>由于是静态提前编译，不能根据硬件情况或程序运行情况择优选择机器指令序列，<strong>理论峰值性能不如JIT</strong></li>
<li><strong>没有动态能力</strong></li>
<li><strong>同一份产物不能跨平台运行</strong></li>
</ul>
</li>
</ul>
<h2 id="JIT在高并发场景中的生产问题分享"><a href="#JIT在高并发场景中的生产问题分享" class="headerlink" title="JIT在高并发场景中的生产问题分享"></a>JIT在高并发场景中的生产问题分享</h2><ul>
<li><strong>现象</strong>：热点应用重启后，出现业务超时，几分钟后恢复正常</li>
<li>解决方法：<ul>
<li><strong>预热</strong>：初始让程序自动运行热点代码几百次</li>
<li><strong>流量控制</strong>：启动时小流量，运行几分钟后再放到正常流量</li>
</ul>
</li>
</ul>
<h2 id="SpringBoot3-GraalVM代替JDK实现AOT"><a href="#SpringBoot3-GraalVM代替JDK实现AOT" class="headerlink" title="SpringBoot3-GraalVM代替JDK实现AOT"></a>SpringBoot3-GraalVM代替JDK实现AOT</h2><blockquote>
<p>GraalVM 是一个跨语言的通用虚拟机，不仅支持了 Java、Scala、Groovy、Kotlin 等基于 JVM 的语言，以及 C、C++ 等基于 LLVM 的语言，还支持其它像 JavaScript、Ruby、Rust、Python 和 R 语言等</p>
</blockquote>
<ul>
<li>GraalVM下载：<a class="link"   target="_blank" rel="noopener" href="https://github.com/graalvm/graalvm-ce-builds/releases/tag/vm-22.3.0" >https://github.com/graalvm/graalvm-ce-builds/releases/tag/vm-22.3.0<i class="fas fa-external-link-alt"></i></a></li>
<li><strong>GraalVM配置环境变量</strong>和普通JDK一样 java -version，查看GraalVM</li>
<li><strong>在线安装native-image</strong>:gu install native-image（powershell报错，cmd正常）</li>
<li><strong>手动安装native-image</strong>:<a class="link"   target="_blank" rel="noopener" href="https://github.com/graalvm/graalvm-ce-builds/releases/tag/vm-22.3.0" >https://github.com/graalvm/graalvm-ce-builds/releases/tag/vm-22.3.0<i class="fas fa-external-link-alt"></i></a></li>
<li>命令行：gu install -L 你的下载位置</li>
<li><strong>查看安装结果</strong>: gu list</li>
<li>新建SpringBoot3项目使用IDEA新建SpringBoot项目，版本号：3.0.0</li>
<li><strong>安装Visual Studio 2022</strong> :下载社区版，安装时勾选C++桌面开发</li>
<li><strong>GraalVM AOT打包</strong>:跳到项目所在目录，使用x64 Native Tools Command Prompt for VS 2022，执行：mvn -Pnative native:compile</li>
<li>参考：<a class="link"   target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/native-image.html#native-image.developing-your-first-application.native-build-tools.prerequisites.windows" >https://docs.spring.io/spring-boot/docs/current/reference/html/native-image.html#native-image.developing-your-first-application.native-build-tools.prerequisites.windows<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<h1 id="新版Spring-Cloud-Alibaba与Springbooot搭建后端架构"><a href="#新版Spring-Cloud-Alibaba与Springbooot搭建后端架构" class="headerlink" title="新版Spring Cloud Alibaba与Springbooot搭建后端架构"></a>新版Spring Cloud Alibaba与Springbooot搭建后端架构</h1><p>本章主要学习微服务项目架构的搭建，使用Maven搭建Spring Cloud Alibaba微服务架构，学习微服务核心组件：注册中心Nacos和路由Gateway，完成项目的工程配置，如：Git, Maven, 热部署、编码等。</p>
<hr>
<h2 id="手把手快速完成微服务架构的搭建-加片头"><a href="#手把手快速完成微服务架构的搭建-加片头" class="headerlink" title="手把手快速完成微服务架构的搭建(加片头)"></a>手把手快速完成微服务架构的搭建(加片头)</h2><ul>
<li>首先新建项目，将JDK选择17.0.5</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041029960.png"
                      alt="image-20230704102949534"
                ></p>
<ul>
<li>然后选择下面内容：Spring Boot DevTools，Spring Web和Cloud Bootstrap</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041032281.png"
                      alt="image-20230704103210055"
                ></p>
<ul>
<li>在pom.xml中将springBoot版本设置为3.0.0，并且SpringCloud的版本设置为2022.0.0</li>
</ul>
<h2 id="项目初始化配置"><a href="#项目初始化配置" class="headerlink" title="项目初始化配置"></a>项目初始化配置</h2><ul>
<li>修改encode，编码改成UTF-8，同样文件编码也得改成UTF-8</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041045833.png"
                      alt="image-20230704104559689"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041047294.png"
                      alt="image-20230704104740148"
                ></p>
<ul>
<li>修改自动导入部分</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041049782.png"
                      alt="image-20230704104928670"
                ></p>
<ul>
<li>修改热部署</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041050930.png"
                      alt="image-20230704105027814"
                ></p>
<ul>
<li>在快点两个Shift时在操作里面搜索注册表修改下面选项：不操作几秒时进行自动编译</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041058366.png"
                      alt="image-20230704105806184"
                ></p>
<ul>
<li>热部署还需要勾选下面这个</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041101569.png"
                      alt="image-20230704110107435"
                ></p>
<h2 id="实现代码关联Git远程仓库"><a href="#实现代码关联Git远程仓库" class="headerlink" title="实现代码关联Git远程仓库"></a>实现代码关联Git远程仓库</h2><blockquote>
<p>实际工作中，每完成一个小功能，就提交一次，写清楚注释，下班前，代码全部push到远程仓库，前提是代码不要报错</p>
</blockquote>
<ul>
<li>首先我们先点击IDEA上面得VCS操作中得git</li>
<li>然后点击左下角得Git将变更得内容添加到VCS中</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041309487.png"
                      alt="image-20230704130816466"
                ></p>
<ul>
<li>然后点击提交文件就将变更项提交到本地仓库了</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041310125.png"
                      alt="image-20230704131017995"
                ></p>
<ul>
<li>代码一定要放远程仓库，防止电脑损坏丢失。一般公司会用gitlib自己搭仓库，在这里我们使用阿里云得仓库</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041312635.png"
                      alt="image-20230704131210241"
                ></p>
<ul>
<li>在个人设置中添加SSH公钥</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041317412.png"
                      alt="image-20230704131724237"
                ></p>
<ul>
<li>新建代码库</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041322908.png"
                      alt="image-20230704132243747"
                ></p>
<ul>
<li>进去后先调成SSH</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041323564.png"
                      alt="image-20230704132326448"
                ></p>
<ul>
<li>我们主要在IDEA用下面的两行代码</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307041324175.png"
                      alt="image-20230704132442030"
                ></p>
<ul>
<li>就可以了，实在不行咱们就用GitHub仓库</li>
</ul>
<h2 id="新增member会员模块"><a href="#新增member会员模块" class="headerlink" title="新增member会员模块"></a>新增member会员模块</h2><ul>
<li>就是在原本项目的基础上，新建maven模块，父类选择train新建完成后将train的pom.xml中一部分剪切到member的pom.xml中</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在member中写一些启动项等类和配置文件，最后将最开始父类的src删掉就可以，因为不需要</li>
</ul>
<h2 id="实现日志的相关配置"><a href="#实现日志的相关配置" class="headerlink" title="实现日志的相关配置"></a>实现日志的相关配置</h2><ul>
<li>修改SpringBoot的LOGO在resources中添加banner.txt即可<a class="link"   target="_blank" rel="noopener" href="https://www.bootschool.net/ascii-art/gesture" >https://www.bootschool.net/ascii-art/gesture<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    \▔\</span><br><span class="line">    )..)</span><br><span class="line">   /../▂▂▂</span><br><span class="line">▂▂╱┈ ▕▂▂▂▏</span><br><span class="line">▉┈-┈┈ ▕▂▂▂▏</span><br><span class="line">▉┈-┈┈▕▂▂▂▏</span><br><span class="line">▔▔╲▂▕▂▂▏</span><br></pre></td></tr></table></figure>

<ul>
<li>修改MemberApplication启动类主函数里面的内容，其实都是固定的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.fzx&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberApplication</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(MemberApplication.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(MemberApplication.class);</span><br><span class="line">        <span class="type">Environment</span> <span class="variable">env</span> <span class="operator">=</span> app.run(args).getEnvironment();</span><br><span class="line">        LOG.info(<span class="string">&quot;启动成功！！&quot;</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;测试地址: \thttp://127.0.0.1:&#123;&#125;&#123;&#125;/hello&quot;</span>, env.getProperty(<span class="string">&quot;server.port&quot;</span>), env.getProperty(<span class="string">&quot;server.servlet.context-path&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>给项目启动的地址加一个前缀：为了后续做路由转发，在网关模块里，将接口带”&#x2F;member“的请求都转发到member模块。在application.properties中添加</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.servlet.context-path</span>=<span class="string">/member</span></span><br></pre></td></tr></table></figure>

<ul>
<li>将生成日志的操作logback-spring.xml添加到resources中</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 修改一下路径--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;PATH&quot;</span> <span class="attr">value</span>=<span class="string">&quot;./log/member&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;Pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %highlight(%-5level) %blue(%-50logger&#123;50&#125;:%-4line) %thread %green(%-18X&#123;LOG_ID&#125;) %msg%n&lt;/Pattern&gt;--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>%d&#123;mm:ss.SSS&#125; %highlight(%-5level) %blue(%-30logger&#123;30&#125;:%-4line) %thread %green(%-18X&#123;LOG_ID&#125;) %msg%n<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;TRACE_FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;PATH&#125;/trace.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;PATH&#125;/trace.%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level %-50logger&#123;50&#125;:%-4line %green(%-18X&#123;LOG_ID&#125;) %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;ERROR_FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;PATH&#125;/error.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;PATH&#125;/error.%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level %-50logger&#123;50&#125;:%-4line %green(%-18X&#123;LOG_ID&#125;) %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;ERROR&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;ERROR_FILE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;TRACE&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;TRACE_FILE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>我们需要把日志这个目录在git中忽略掉，那么就在.gitignore中添加</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log/</span><br></pre></td></tr></table></figure>

<h2 id="使用HTTP-Client完成测试接口"><a href="#使用HTTP-Client完成测试接口" class="headerlink" title="使用HTTP Client完成测试接口"></a>使用HTTP Client完成测试接口</h2><blockquote>
<p>IDEA自带Http Client插件，只要新建.http文件，即可发起http调用</p>
</blockquote>
<ul>
<li>就是IDEA上面工具里面的，点击在 HTTP 客户端中创建请求后就可以把生成的这个文件放到自己的目录中（我是因为自己创建他无效，所以只能出此下策）</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:8081/member/hello</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json</span><br><span class="line">###</span><br></pre></td></tr></table></figure>

<h2 id="增加AOP打印请求参数和返回结果"><a href="#增加AOP打印请求参数和返回结果" class="headerlink" title="增加AOP打印请求参数和返回结果"></a>增加AOP打印请求参数和返回结果</h2><ul>
<li>首先在父类pom中添加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.70<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>其次在member的pom中添加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>最后我们就可以在member模块下新建aspect目录</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.support.spring.PropertyPreFilters;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.Signature;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.MDC;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LogAspect</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;LogAspect&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(LogAspect.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义一个切点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(value = &quot;execution(public * com.fzx..*controller..*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">controllerPointcut</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(value = &quot;controllerPointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doBefore</span><span class="params">(JoinPoint joinPoint)</span> &#123;</span><br><span class="line">        MDC.put(<span class="string">&quot;LOG_ID&quot;</span>,System.currentTimeMillis() + RandomUtil.randomString(<span class="number">3</span>));</span><br><span class="line">        <span class="comment">// 开始打印请求日志</span></span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signature</span> <span class="operator">=</span> joinPoint.getSignature();</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> signature.getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印请求信息</span></span><br><span class="line">        LOG.info(<span class="string">&quot;------------- 开始 -------------&quot;</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;请求地址: &#123;&#125; &#123;&#125;&quot;</span>, request.getRequestURL().toString(), request.getMethod());</span><br><span class="line">        LOG.info(<span class="string">&quot;类名方法: &#123;&#125;.&#123;&#125;&quot;</span>, signature.getDeclaringTypeName(), name);</span><br><span class="line">        LOG.info(<span class="string">&quot;远程地址: &#123;&#125;&quot;</span>, request.getRemoteAddr());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印请求参数</span></span><br><span class="line">        Object[] args = joinPoint.getArgs();</span><br><span class="line">        <span class="comment">// LOG.info(&quot;请求参数: &#123;&#125;&quot;, JSONObject.toJSONString(args));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 排除特殊类型的参数，如文件类型</span></span><br><span class="line">        Object[] arguments = <span class="keyword">new</span> <span class="title class_">Object</span>[args.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (args[i] <span class="keyword">instanceof</span> ServletRequest</span><br><span class="line">                    || args[i] <span class="keyword">instanceof</span> ServletResponse</span><br><span class="line">                    || args[i] <span class="keyword">instanceof</span> MultipartFile) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            arguments[i] = args[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 排除字段，敏感字段或太长的字段不显示：身份证、手机号、邮箱、密码等</span></span><br><span class="line">        String[] excludeProperties = &#123;&#125;;</span><br><span class="line">        <span class="type">PropertyPreFilters</span> <span class="variable">filters</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PropertyPreFilters</span>();</span><br><span class="line">        PropertyPreFilters.<span class="type">MySimplePropertyPreFilter</span> <span class="variable">excludefilter</span> <span class="operator">=</span> filters.addFilter();</span><br><span class="line">        excludefilter.addExcludes(excludeProperties);</span><br><span class="line">        LOG.info(<span class="string">&quot;请求参数: &#123;&#125;&quot;</span>, JSONObject.toJSONString(arguments, excludefilter));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(value = &quot;controllerPointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">doAround</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> proceedingJoinPoint.proceed();</span><br><span class="line">        <span class="comment">// 排除字段，敏感字段或太长的字段不显示：身份证、手机号、邮箱、密码等</span></span><br><span class="line">        String[] excludeProperties = &#123;&#125;;</span><br><span class="line">        <span class="type">PropertyPreFilters</span> <span class="variable">filters</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PropertyPreFilters</span>();</span><br><span class="line">        PropertyPreFilters.<span class="type">MySimplePropertyPreFilter</span> <span class="variable">excludefilter</span> <span class="operator">=</span> filters.addFilter();</span><br><span class="line">        excludefilter.addExcludes(excludeProperties);</span><br><span class="line">        LOG.info(<span class="string">&quot;返回结果: &#123;&#125;&quot;</span>, JSONObject.toJSONString(result, excludefilter));</span><br><span class="line">        LOG.info(<span class="string">&quot;------------- 结束 耗时：&#123;&#125; ms -------------&quot;</span>, System.currentTimeMillis() - startTime);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="详解项目中增加通用模块"><a href="#详解项目中增加通用模块" class="headerlink" title="详解项目中增加通用模块"></a>详解项目中增加通用模块</h2><blockquote>
<p>增加公共模块common，用于放置公共的类，比如工具类，拦截器，AOP，常量，枚举，公共配置等</p>
</blockquote>
<ul>
<li>首先新建模块common</li>
<li>接着将member中通用的依赖放到common的依赖中</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>train<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fzx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>接着父类中定义common的模块依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fzx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在父类定义完成之后，其子类member就可以引用common的依赖了，并将之前公共的依赖删去即可</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>train<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fzx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>member<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fzx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>最后以member中的LogAspect为例，将其移到com.fzx.train.common.aspect的目录中，发现可以正常运行</li>
</ul>
<blockquote>
<p>增加了公共配置文件，需要放到resources&#x2F;config下</p>
</blockquote>
<ul>
<li>所有的公共的配置都放到common的resources&#x2F;config下，优先读取他</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>= <span class="string">8001</span></span><br></pre></td></tr></table></figure>

<h2 id="详解项目中增加网关模块"><a href="#详解项目中增加网关模块" class="headerlink" title="详解项目中增加网关模块"></a>详解项目中增加网关模块</h2><blockquote>
<p>增加网关模块gateway</p>
</blockquote>
<ul>
<li>gateway只有一个依赖，不能引入common，也不能引入starter-web</li>
<li>首先新建模块gateway，然后再gateway的pom引入gateway的依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>train<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fzx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>其次写一个启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.gateway.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.fzx&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayApplication</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(GatewayApplication.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(GatewayApplication.class);</span><br><span class="line">        <span class="type">Environment</span> <span class="variable">env</span> <span class="operator">=</span> app.run(args).getEnvironment();</span><br><span class="line">        LOG.info(<span class="string">&quot;启动成功！！&quot;</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;网关地址: \thttp://127.0.0.1:&#123;&#125;&quot;</span>, env.getProperty(<span class="string">&quot;server.port&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>导入网关的配置application.properties</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>= <span class="string">8000</span></span><br></pre></td></tr></table></figure>

<ul>
<li>再给网关加一个日志logback-spring.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 修改一下路径--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;PATH&quot;</span> <span class="attr">value</span>=<span class="string">&quot;./log/gateway&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;Pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %highlight(%-5level) %blue(%-50logger&#123;50&#125;:%-4line) %thread %green(%-18X&#123;LOG_ID&#125;) %msg%n&lt;/Pattern&gt;--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>%d&#123;mm:ss.SSS&#125; %highlight(%-5level) %blue(%-30logger&#123;30&#125;:%-4line) %thread %green(%-18X&#123;LOG_ID&#125;) %msg%n<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;TRACE_FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;PATH&#125;/trace.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;PATH&#125;/trace.%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level %-50logger&#123;50&#125;:%-4line %green(%-18X&#123;LOG_ID&#125;) %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;ERROR_FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;PATH&#125;/error.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;PATH&#125;/error.%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level %-50logger&#123;50&#125;:%-4line %green(%-18X&#123;LOG_ID&#125;) %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;ERROR&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;ERROR_FILE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;TRACE&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;TRACE_FILE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>生产发布时，只有gateway需要配置外网IP，其它模块都只开放内网访问，外网访问不了，保证应用安全</strong></li>
</ul>
<blockquote>
<p>为网关模块配置路由转发，要输出请求日志需要增加启动参数：-Dreactor.netty.http.server.accessLogEnabled&#x3D;true</p>
</blockquote>
<ul>
<li>为了能和member关联，我们在gateway的application.properties中添加路由转发</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#路由转发，将/member/...的请求转发了member模块</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.routes[0].id</span>=<span class="string">member</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.routes[0].uri</span>=<span class="string">http://127.0.0.1:8001</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.routes[0].predicates[0]</span>=<span class="string">Path=/member/**</span></span><br></pre></td></tr></table></figure>

<ul>
<li>想要在网关中打印日志可以进行一下操作</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307061013511.png"
                      alt="image-20230706101330227"
                ></p>
<ul>
<li>然后在这个位置添加以下固定代码</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307061013697.png"
                      alt="image-20230706101359564"
                ></p>
<h2 id="详解本地数据库的准备工作"><a href="#详解本地数据库的准备工作" class="headerlink" title="详解本地数据库的准备工作"></a>详解本地数据库的准备工作</h2><blockquote>
<p><code>要专库专用，忌用root</code></p>
</blockquote>
<ul>
<li>新增数据库train</li>
<li>现在root用户里面加train数据库，然后再添加新用户</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307061117789.png"
                      alt="image-20230706111712537"
                ></p>
<ul>
<li>添加完新用户然后给新用户赋予特定数据库的权限</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307061118817.png"
                      alt="image-20230706111817634"
                ></p>
<ul>
<li>SQLyog新建连接时报错了，由于mysql8.0的加密方法变了。mysql8.0默认采用caching_sha2_password的加密方式。<a class="link"   target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=sqlyog&spm=1001.2101.3001.7020" >sqlyog<i class="fas fa-external-link-alt"></i></a>不支持这种加密方式。所以进行以下操作</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307061122237.png"
                      alt="image-20230706112201104"
                ></p>
<ul>
<li>没成功就多试几次</li>
</ul>
<h2 id="详解阿里云RDS的准备工作"><a href="#详解阿里云RDS的准备工作" class="headerlink" title="详解阿里云RDS的准备工作"></a>详解阿里云RDS的准备工作</h2><ul>
<li><p><strong>云数据库的好处</strong></p>
</li>
<li><blockquote>
<p>· 免去环境搭建，版本任选</p>
<p>· 方便多台电脑协作开发</p>
<p>· 相当于雇了一帮运维</p>
<p>· <strong>总结：花钱买时间</strong></p>
</blockquote>
</li>
<li><p>购买Serverless版RDS</p>
</li>
<li><p>配置白名单</p>
</li>
<li><p>配置专库专用</p>
</li>
</ul>
<h2 id="使用IDEA配置数据库连接"><a href="#使用IDEA配置数据库连接" class="headerlink" title="使用IDEA配置数据库连接"></a>使用IDEA配置数据库连接</h2><ul>
<li>最基本的数据库连接mysql数据库这里就不多赘述了</li>
<li>我们将sql的脚本都放到train目录下的sql目录中，比如说member.sql</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `<span class="keyword">member</span>`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `<span class="keyword">member</span>` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `mobile` <span class="type">varchar</span>(<span class="number">11</span>) comment <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  <span class="keyword">unique</span> key `mobile_unique` (`mobile`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;会员&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="集成Mybatis持久层框架"><a href="#集成Mybatis持久层框架" class="headerlink" title="集成Mybatis持久层框架"></a>集成Mybatis持久层框架</h2><ul>
<li>首先在根pom.xml引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--集成mybatis连接--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--集成mysql连接--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后在公共模块common中引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--集成mybatis连接--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--集成mysql连接--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>由于每个模块所用数据库不同，所以数据库的配置也不同，这里数据库配置就不写在公共模块中了，写在各自的application.properties中，先在member中写</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#数据库连接</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/train?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=UTC%2B8&amp;nullCatalogMeansCurrent=true</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">train</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">train</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<ul>
<li>做一个简单的测试，在member中创建mapper.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MemberMapper</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">count</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这时需要在启动类加一个mapper扫描注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan(&quot;com.fzx.train.member.mapper&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>写一个mapper.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.fzx.train.member.mapper.MemberMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;count&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">        select count(1) from member</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>紧接着在其配置文件中写xml的路径，使模块可以找到我们写的mapper.xml文件</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mybatis xml路径</span></span><br><span class="line"><span class="attr">mybatis.mapper-locations</span>=<span class="string">classpath:/mapper/**/*.xml</span></span><br></pre></td></tr></table></figure>

<ul>
<li>写service</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.mapper.MemberMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberMapper memberMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">count</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memberMapper.count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>写controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.service.MemberService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/member&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberService memberService;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/count&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">count</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memberService.count();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后在http目录下写一个测试member-member.http</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:8000/member/member/count</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json</span><br><span class="line"></span><br><span class="line">###</span><br></pre></td></tr></table></figure>

<ul>
<li><p>经测试一切正常</p>
</li>
<li><p>最后在member配置文件中加一个mapper日志级别</p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging.level.com.fzx.train.member.mapper</span> =<span class="string">trace</span></span><br></pre></td></tr></table></figure>

<h2 id="集成Mybatis官方生成器"><a href="#集成Mybatis官方生成器" class="headerlink" title="集成Mybatis官方生成器"></a>集成Mybatis官方生成器</h2><ul>
<li>首先创建模块generator，然后在其pom.xml中引入插件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- mybatis generator 自动生成代码插件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configurationFile</span>&gt;</span>src/main/resources/generator-config-member.xml<span class="tag">&lt;/<span class="name">configurationFile</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                    &lt;configurationFile&gt;src/main/resources/generator-config-business.xml&lt;/configurationFile&gt;--&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--&lt;configurationFile&gt;src/main/resources/generator-config-batch.xml&lt;/configurationFile&gt;--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">overwrite</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overwrite</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">verbose</span>&gt;</span>true<span class="tag">&lt;/<span class="name">verbose</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>接着在resources中写generator-config-member.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">generatorConfiguration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">&quot;Mysql&quot;</span> <span class="attr">targetRuntime</span>=<span class="string">&quot;MyBatis3&quot;</span> <span class="attr">defaultModelType</span>=<span class="string">&quot;flat&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 自动检查关键字，为关键字增加反引号 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;autoDelimitKeywords&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;beginningDelimiter&quot;</span> <span class="attr">value</span>=<span class="string">&quot;`&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;endingDelimiter&quot;</span> <span class="attr">value</span>=<span class="string">&quot;`&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--覆盖生成XML文件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">type</span>=<span class="string">&quot;org.mybatis.generator.plugins.UnmergeableXmlMappersPlugin&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 生成的实体类添加toString()方法 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">type</span>=<span class="string">&quot;org.mybatis.generator.plugins.ToStringPlugin&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 不生成注释 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suppressAllComments&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 配置数据源，需要根据自己的项目修改 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdbcConnection</span> <span class="attr">driverClass</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">connectionURL</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/train?serverTimezone=UTC&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">userId</span>=<span class="string">&quot;train&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">password</span>=<span class="string">&quot;train&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jdbcConnection</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- domain类的位置 targetProject是相对pom.xml的路径--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetProject</span>=<span class="string">&quot;../member/src/main/java&quot;</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">targetPackage</span>=<span class="string">&quot;com.fzx.train.member.domain&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- mapper xml的位置 targetProject是相对pom.xml的路径 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetProject</span>=<span class="string">&quot;../member/src/main/resources&quot;</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">targetPackage</span>=<span class="string">&quot;mapper&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- mapper类的位置 targetProject是相对pom.xml的路径 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">targetProject</span>=<span class="string">&quot;../member/src/main/java&quot;</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">targetPackage</span>=<span class="string">&quot;com.fzx.train.member.mapper&quot;</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">type</span>=<span class="string">&quot;XMLMAPPER&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">&quot;member&quot;</span> <span class="attr">domainObjectName</span>=<span class="string">&quot;Member&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>最后也可以在Maven配置上配置生成器的运行</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307061519950.png"
                      alt="image-20230706151733615"
                ></p>
<h2 id="完成会员注册接口的开发"><a href="#完成会员注册接口的开发" class="headerlink" title="完成会员注册接口的开发"></a>完成会员注册接口的开发</h2><ul>
<li>写一个MemberService方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">register</span><span class="params">(String mobile)</span>&#123;</span><br><span class="line">    <span class="type">MemberExample</span> <span class="variable">memberExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemberExample</span>();</span><br><span class="line">    memberExample.createCriteria().andMobileEqualTo(mobile);</span><br><span class="line">    List&lt;Member&gt; list = memberMapper.selectByExample(memberExample);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CollUtil.isNotEmpty(list))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;手机号已注册&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Member</span> <span class="variable">member</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Member</span>();</span><br><span class="line">    member.setId(System.currentTimeMillis());</span><br><span class="line">    member.setMobile(mobile);</span><br><span class="line">    memberMapper.insert(member);</span><br><span class="line">    <span class="keyword">return</span> member.getId();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接着写其Controller实现类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">register</span><span class="params">(String mobile)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> memberService.register(mobile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后写测试类</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST http://localhost:8000/member/member/register</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">mobile=123</span><br><span class="line"></span><br><span class="line">###</span><br></pre></td></tr></table></figure>

<h2 id="封装请求参数和返回结果"><a href="#封装请求参数和返回结果" class="headerlink" title="封装请求参数和返回结果"></a>封装请求参数和返回结果</h2><blockquote>
<p>封装请求参数</p>
</blockquote>
<ul>
<li>首先封装一下请求参数，下面规定下所有的请求参数的封装类都是由Req结尾，将所有的封装类都放到req软件包下，例如注册的封装类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberRegisterReq</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMobile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMobile</span><span class="params">(String mobile)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mobile = mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;MemberRegisterReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;mobile=&#x27;&quot;</span>).append(mobile).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在service中使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">register</span><span class="params">(MemberRegisterReq req)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">mobile</span> <span class="operator">=</span> req.getMobile();</span><br><span class="line">    <span class="type">MemberExample</span> <span class="variable">memberExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemberExample</span>();</span><br><span class="line">    memberExample.createCriteria().andMobileEqualTo(mobile);</span><br><span class="line">    List&lt;Member&gt; list = memberMapper.selectByExample(memberExample);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CollUtil.isNotEmpty(list))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;手机号已注册&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Member</span> <span class="variable">member</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Member</span>();</span><br><span class="line">    member.setId(System.currentTimeMillis());</span><br><span class="line">    member.setMobile(mobile);</span><br><span class="line">    memberMapper.insert(member);</span><br><span class="line">    <span class="keyword">return</span> member.getId();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在controller中使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">register</span><span class="params">(MemberRegisterReq req)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> memberService.register(req);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>返回结果</p>
</blockquote>
<ul>
<li>封装请求结果我们将其封装到common里面的resp软件包下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.resp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonResp</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务上的成功或失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回泛型数据，自定义类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T content;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommonResp</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommonResp</span><span class="params">(<span class="type">boolean</span> success, String message, T content)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommonResp</span><span class="params">(T content)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">getSuccess</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSuccess</span><span class="params">(<span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getContent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContent</span><span class="params">(T content)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;CommonResp&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;success=&quot;</span>).append(success);</span><br><span class="line">        sb.append(<span class="string">&quot;, message=&#x27;&quot;</span>).append(message).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, content=&quot;</span>).append(content);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在Controller中修改其返回值形式</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/member&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberService memberService;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/count&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;Integer&gt; <span class="title function_">count</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span>  memberService.count();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(count);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;Long&gt; <span class="title function_">register</span><span class="params">(MemberRegisterReq req)</span>&#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">register</span> <span class="operator">=</span>  memberService.register(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(register);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="为项目增加统一异常处理"><a href="#为项目增加统一异常处理" class="headerlink" title="为项目增加统一异常处理"></a>为项目增加统一异常处理</h2><ul>
<li>我们在common模块里添加统一异常处理，将其放到controller软件包中就当是拦截器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统一异常处理、数据预处理等</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ControllerExceptionHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(ControllerExceptionHandler.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有异常统一处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp <span class="title function_">exceptionHandler</span><span class="params">(Exception e)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">CommonResp</span> <span class="variable">commonResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>();</span><br><span class="line">        LOG.error(<span class="string">&quot;系统异常：&quot;</span>,e);</span><br><span class="line">        commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        commonResp.setMessage(e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> commonResp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用自定义异常处理异常业务"><a href="#使用自定义异常处理异常业务" class="headerlink" title="使用自定义异常处理异常业务"></a>使用自定义异常处理异常业务</h2><blockquote>
<p>为了区分业务异常和系统异常，需要增加自定义异常类</p>
</blockquote>
<ul>
<li>我们首先在common模块的exception软件包下创建枚举类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">BusinessExceptionEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    MEMBER_MOBILE_EXIST(<span class="string">&quot;手机号已注册&quot;</span>)</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    BusinessExceptionEnum(String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDesc</span><span class="params">(String desc)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;BusinessExceptionEnum&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;desc=&#x27;&quot;</span>).append(desc).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接着在exception软件包下自定义异常</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span>&#123;</span><br><span class="line">    <span class="keyword">private</span>  BusinessExceptionEnum e;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BusinessExceptionEnum <span class="title function_">getE</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BusinessException</span><span class="params">(BusinessExceptionEnum e)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.e = e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setE</span><span class="params">(BusinessExceptionEnum e)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.e = e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;BusinessException&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;e=&quot;</span>).append(e);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="meta">@Override</span>                              </span><br><span class="line">  <span class="keyword">public</span>  Throwable <span class="title function_">fillInStackTrace</span><span class="params">()</span> &#123; </span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;                       </span><br><span class="line">  &#125;                                      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在之前的MemberService中使用自定义的异常处理类抛出异常</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.MEMBER_MOBILE_EXIST);</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来我们修改下之前的统一异常处理</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.exception.BusinessExceptionEnum;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统一异常处理、数据预处理等</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ControllerExceptionHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(ControllerExceptionHandler.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 系统异常统一处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp <span class="title function_">exceptionHandler</span><span class="params">(Exception e)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">CommonResp</span> <span class="variable">commonResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>();</span><br><span class="line">        LOG.error(<span class="string">&quot;系统异常：&quot;</span>,e);</span><br><span class="line">        commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        commonResp.setMessage(<span class="string">&quot;系统出现异常，请联系管理员&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> commonResp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务异常统一处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = BusinessException.class)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp <span class="title function_">exceptionHandler</span><span class="params">(BusinessException e)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">CommonResp</span> <span class="variable">commonResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>();</span><br><span class="line">        LOG.error(<span class="string">&quot;系统异常：&quot;</span>,e);</span><br><span class="line">        commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        commonResp.setMessage(e.getE().getDesc());</span><br><span class="line">        <span class="keyword">return</span> commonResp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>“系统出现异常，请联系管理员”，生产运行过程中，都不应该出现这句话，这句是为了一些未知异常，统一话术给用户，出现了就说明系统有BUG，需要修改代码</li>
</ul>
<h2 id="集成校验框架Validation"><a href="#集成校验框架Validation" class="headerlink" title="集成校验框架Validation"></a>集成校验框架Validation</h2><ul>
<li>首先在common模块引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们需要在我们封装的请求参数类中不能为空的字段进行注解，比如</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.req;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberRegisterReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【手机号】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>让其真正生效需要在controller中参数添加注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;Long&gt; <span class="title function_">register</span><span class="params">(<span class="meta">@Valid</span> MemberRegisterReq req)</span>&#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">register</span> <span class="operator">=</span>  memberService.register(req);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(register);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这时候如果手机号为空会抛出 <strong>系统出现异常，请联系管理员</strong>，应该是抛出 <strong>【手机号】不能为空</strong>，这时候就要新增异常拦截</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 校验异常统一处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ExceptionHandler(value = BindException.class)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> CommonResp <span class="title function_">exceptionHandler</span><span class="params">(BindException e)</span> &#123;</span><br><span class="line">    <span class="type">CommonResp</span> <span class="variable">commonResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>();</span><br><span class="line">    LOG.error(<span class="string">&quot;校验异常：&#123;&#125;&quot;</span>, e.getBindingResult().getAllErrors().get(<span class="number">0</span>).getDefaultMessage());</span><br><span class="line">    commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">    commonResp.setMessage(e.getBindingResult().getAllErrors().get(<span class="number">0</span>).getDefaultMessage());</span><br><span class="line">    <span class="keyword">return</span> commonResp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>tmd一定要看包引得对不对，真sb</strong></p>
</blockquote>
<h2 id="详解雪花算法"><a href="#详解雪花算法" class="headerlink" title="详解雪花算法"></a>详解雪花算法</h2><ul>
<li>自增ID不适合分布式数据库，分表分库场景。适合小型项目</li>
<li>UUID会影响索引效率，因为UUID是无序的，用一堆无序的ID来构建一个有序的索引目录，性能上肯定有问题的</li>
<li>雪花算法由Twitter 公司在2014年开源 scala 语言版本</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307070924376.png"
                      alt="image-20230707092431152"
                ></p>
<ul>
<li><p><strong>雪花算法问题</strong></p>
<ul>
<li><strong>数据中心，机器ID怎么设置：</strong>可在启动时，用IP或MAC到数据库中申请一个不重复的ID</li>
<li><strong>时钟回拨：</strong>一个应用一般是多节点，可停止节点，等时间过了，再启动（机器时间是3点，北京时间是2点，此时需要把机器时间调回2点，那么2点~3点的ID会重新再生成一遍）</li>
</ul>
</li>
<li><p>首先我们在公共模块common的util软件包下封装雪花算法SnowUtil</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装hutool雪花算法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnowUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">dataCenterId</span> <span class="operator">=</span> <span class="number">1</span>;<span class="comment">//数据中心</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">workerId</span> <span class="operator">=</span> <span class="number">1</span>;<span class="comment">//机器标识</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getSnowflakeNextId</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> IdUtil.getSnowflake(workerId,dataCenterId).nextId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSnowflakeNextIdStr</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> IdUtil.getSnowflake(workerId,dataCenterId).nextIdStr();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再需要生成id的地方使用雪花算法，例如MemberService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">member.setId(SnowUtil.getSnowflakeNextId());</span><br></pre></td></tr></table></figure>

<h1 id="使用Vue3-Vue-CLI-实现系统前端模块的搭建"><a href="#使用Vue3-Vue-CLI-实现系统前端模块的搭建" class="headerlink" title="使用Vue3 + Vue CLI 实现系统前端模块的搭建"></a>使用Vue3 + Vue CLI 实现系统前端模块的搭建</h1><p>本章将完成项目前端模块搭建，创建Vue CLI 项目Web，集成支持Vue3的UI组件库Ant Design Vue，完成网站页面基本布局，集成Vue-Router路由、Axios等组件。</p>
<hr>
<h2 id="本地环境准备"><a href="#本地环境准备" class="headerlink" title="本地环境准备"></a>本地环境准备</h2><ul>
<li>vue cli 安装：<a class="link"   target="_blank" rel="noopener" href="https://cli.vuejs.org/zh/guide/installation.html" >https://cli.vuejs.org/zh/guide/installation.html<i class="fas fa-external-link-alt"></i></a></li>
<li>流程：安装node得到npm，使用npm安装vue cli(脚手架)，使用vue cli创建项目</li>
<li>Vue CLI版本和Node版本有关，用Node V12只能下载到Vue CLI V4.X，必须用Node V18才能下载到Vue CLI V5.X</li>
<li>IDEA支持配置多个版本的Node，类似配置多个JDK</li>
<li>使用淘宝镜像：npm config set registry <a class="link"   target="_blank" rel="noopener" href="https://registry.npm.taobao.org/" >https://registry.npm.taobao.org<i class="fas fa-external-link-alt"></i></a></li>
<li>查看当前镜像使用的地址：npm config get registry</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307070948080.png"
                      alt="image-20230707094819877"
                ></p>
<h2 id="手把手创建基于Vue-CLI的web模块"><a href="#手把手创建基于Vue-CLI的web模块" class="headerlink" title="手把手创建基于Vue CLI的web模块"></a>手把手创建基于Vue CLI的web模块</h2><ul>
<li>为了防止电脑里有之前安装的Vue CLI残留，我们在终端执行下面代码</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> npm uninstall -g vue-cli</span><br><span class="line">npm install -g @vue/cli@<span class="number">5</span>.<span class="number">0</span>.<span class="number">8</span></span><br><span class="line">vue --version</span><br></pre></td></tr></table></figure>

<ul>
<li>看完了版本号，就可以创建web了</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue create web</span><br></pre></td></tr></table></figure>

<ul>
<li>这里选择最后一个自定义选项Manually select features</li>
<li>下一步选择这几个</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307071001983.png"
                      alt="image-20230707100142858"
                ></p>
<ul>
<li>然后版本选择3.x，选择使用历史模式，ESLint选择最简单的，选项如下所示：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307071005637.png"
                      alt="image-20230707100538524"
                ></p>
<ul>
<li><p>这时项目就建立好了</p>
</li>
<li><p><strong>通过main.js（框架配置入口），将index.html（html页面入口）的标签id为app的和App.vue（vue页面入口）关联起来</strong></p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(store).<span class="title function_">use</span>(router).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>各个路由（url地址）对应不同的内容（vue页面），会填充到&lt;router-view&#x2F; &gt;区域</p>
</li>
<li><p>下面我们来讲一下App.vue中这段代码</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;nav&gt;</span><br><span class="line">    &lt;router-link to=&quot;/&quot;&gt;Home&lt;/router-link&gt; |</span><br><span class="line">    &lt;router-link to=&quot;/about&quot;&gt;About&lt;/router-link&gt;</span><br><span class="line">  &lt;/nav&gt;</span><br><span class="line">  &lt;router-view/&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>这段代码是连接着router的index.js的代码</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">HomeView</span> <span class="keyword">from</span> <span class="string">&#x27;../views/HomeView.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;home&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">HomeView</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;about&#x27;</span>,</span><br><span class="line">    <span class="comment">// route level code-splitting</span></span><br><span class="line">    <span class="comment">// this generates a separate chunk (about.[hash].js) for this route</span></span><br><span class="line">    <span class="comment">// which is lazy-loaded when the route is visited.</span></span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="string">&#x27;../views/AboutView.vue&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(process.<span class="property">env</span>.<span class="property">BASE_URL</span>),</span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<ul>
<li>通过link to路由代码中的path，然后&lt;router-view&#x2F; &gt;就可以将component特定页面嵌入到App.vue中</li>
</ul>
<h2 id="web模块集成Ant-Design-Vue"><a href="#web模块集成Ant-Design-Vue" class="headerlink" title="web模块集成Ant Design Vue"></a>web模块集成Ant Design Vue</h2><ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://www.antdv.com/docs/vue/getting-started-cnAnt" >https://www.antdv.com/docs/vue/getting-started-cnAnt<i class="fas fa-external-link-alt"></i></a> Design Vue是阿里团队开源的基于Vue的UI组件</li>
<li>UI组件有很多可选，一种是选择基于CSS的，如：Bootstrap，适合各种前端框架。一种是选择基于Vue的UI组件，只能用于Vue框架</li>
<li>Element(由饿了吗团队开源)在Vue2时是最热门框架，Vue3出来后，没有第一时间跟着升级，后来才出了基于Vue3的Element Plus</li>
<li>我们npm下这个组件</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i --save ant-design-vue</span><br></pre></td></tr></table></figure>

<ul>
<li><p>package.json，类似maven的pom.xml，用于引入依赖</p>
</li>
<li><p>package-lock.json，用于锁定小版本号</p>
<ul>
<li>锁定当前依赖的版本</li>
<li>锁定当前依赖的第三方依赖的版本</li>
</ul>
</li>
<li><p>我们在main.js中将这个组件及样式全局注册，import后use一下就行</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Antd</span> <span class="keyword">from</span> <span class="string">&#x27;ant-design-vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;ant-design-vue/dist/antd.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(<span class="title class_">Antd</span>).<span class="title function_">use</span>(store).<span class="title function_">use</span>(router).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>我们如果要用他的图标的话，也是需要先npm一下</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save @ant-design/icons-vue</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们想使用什么图标在这里随便点一个就能复制</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307071049152.png"
                      alt="image-20230707104928864"
                ></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-button&gt;测试&lt;/a-button&gt;&lt;up-outlined /&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面操作完，发现没显示，这时候我们修改下main.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Antd</span> <span class="keyword">from</span> <span class="string">&#x27;ant-design-vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;ant-design-vue/dist/antd.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Icons</span> <span class="keyword">from</span> <span class="string">&#x27;@ant-design/icons-vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title class_">Antd</span>).<span class="title function_">use</span>(store).<span class="title function_">use</span>(router).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//全局使用变量</span></span><br><span class="line"><span class="keyword">const</span> icons = <span class="title class_">Icons</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">const</span> i <span class="keyword">in</span> icons)&#123;</span><br><span class="line">    app.<span class="title function_">component</span>(i,icons[i])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="短信验证码登录流程讲解"><a href="#短信验证码登录流程讲解" class="headerlink" title="短信验证码登录流程讲解"></a>短信验证码登录流程讲解</h2><ul>
<li>没有图片验证码得注册流程图</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307071105055.png"
                      alt="image-20230707110543843"
                ></p>
<ul>
<li>没有图片验证码得登陆流程图</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307071106173.png"
                      alt="image-20230707110611046"
                ></p>
<ul>
<li>有图形验证码得流程图</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307071106503.png"
                      alt="image-20230707110653326"
                ></p>
<h2 id="注册登录二合一界面开发"><a href="#注册登录二合一界面开发" class="headerlink" title="注册登录二合一界面开发"></a>注册登录二合一界面开发</h2><ul>
<li><p>对于router配置，大型项目，页面多，80%页面不常用，可以用懒加载的方式，减少编译后文件的大小，提高初始访问速度；小型目，页面少，可以用静态导入的方式，对编译后的文件大小影响不大</p>
</li>
<li><p>一个vue页面，由三个部分组件，都不是必须的</p>
<ul>
<li>template</li>
<li>script</li>
<li>style</li>
</ul>
</li>
<li><p>vue就两种绑定写法：</p>
<ul>
<li><strong>：绑定属性</strong></li>
<li><strong>@ 绑定事件</strong></li>
</ul>
</li>
<li><p>双向绑定：修改变量值，则元素展现的值也会变化；反过来，用户操作元素，则script里的变量也会发生变化</p>
<p>vue文件即可以是一个页面，也可以是一个组件</p>
<p>vue3两种声明响应式变量：reactive, ref</p>
<p>eslint用于规范代码，是一把双刃剑，初学者不熟悉，用起来会一步一个坑</p>
<p>响应式框架元老：bootstrap，很多UI框架都是参照它来做的，Ant Design Vue的栅格系统也是参照它来写的</p>
</li>
<li><p>我们要增加一个登陆页面首先要在路由处注册一个路由</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/login.vue&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>写一个login页面</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-row class=&quot;login&quot;&gt;</span><br><span class="line">    &lt;a-col :span=&quot;8&quot; :offset=&quot;8&quot; class=&quot;login-main&quot;&gt;</span><br><span class="line">      &lt;h1 style=&quot;text-align: center&quot;&gt;&lt;rocket-two-tone /&gt;&amp;nbsp;12306售票系统&lt;/h1&gt;</span><br><span class="line">      &lt;a-form</span><br><span class="line">          :model=&quot;loginForm&quot;</span><br><span class="line">          name=&quot;basic&quot;</span><br><span class="line">          autocomplete=&quot;off&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;a-form-item</span><br><span class="line">            label=&quot;&quot;</span><br><span class="line">            name=&quot;mobile&quot;</span><br><span class="line">            :rules=&quot;[&#123; required: true, message: &#x27;请输入手机号!&#x27; &#125;]&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;loginForm.mobile&quot; placeholder=&quot;手机号&quot;/&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-form-item</span><br><span class="line">            label=&quot;&quot;</span><br><span class="line">            name=&quot;code&quot;</span><br><span class="line">            :rules=&quot;[&#123; required: true, message: &#x27;请输入验证码!&#x27; &#125;]&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;loginForm.code&quot;&gt;</span><br><span class="line">            &lt;template #addonAfter&gt;</span><br><span class="line">              &lt;a @click=&quot;sendCode&quot;&gt;获取验证码&lt;/a&gt;</span><br><span class="line">            &lt;/template&gt;</span><br><span class="line">          &lt;/a-input&gt;</span><br><span class="line">          &lt;!--&lt;a-input v-model:value=&quot;loginForm.code&quot; placeholder=&quot;验证码&quot;/&gt;--&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">        &lt;a-form-item&gt;</span><br><span class="line">          &lt;a-button type=&quot;primary&quot; block @click=&quot;login&quot;&gt;登录&lt;/a-button&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/a-form&gt;</span><br><span class="line">    &lt;/a-col&gt;</span><br><span class="line">  &lt;/a-row&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; defineComponent, reactive &#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;login-view&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line"></span><br><span class="line">    const loginForm = reactive(&#123;</span><br><span class="line">      mobile: &#x27;13000000000&#x27;,</span><br><span class="line">      code: &#x27;&#x27;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    const sendCode = values =&gt; &#123;</span><br><span class="line">      console.log(&quot;Success&quot;,values)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const login = errorInfo =&gt; &#123;</span><br><span class="line">      console.log(&quot;Failed&quot;,errorInfo)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      loginForm,</span><br><span class="line">      sendCode,</span><br><span class="line">      login</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">.login-main h1 &#123;</span><br><span class="line">  font-size: 25px;</span><br><span class="line">  font-weight: bold;</span><br><span class="line">&#125;</span><br><span class="line">.login-main &#123;</span><br><span class="line">  margin-top: 100px;</span><br><span class="line">  padding: 30px 30px 20px;</span><br><span class="line">  border: 2px solid grey;</span><br><span class="line">  border-radius: 10px;</span><br><span class="line">  background-color: #fcfcfc;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后把App.vue中没用的都删除就可以，就留以下东西</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;router-view/&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<h2 id="发送短信验证码接口开发"><a href="#发送短信验证码接口开发" class="headerlink" title="发送短信验证码接口开发"></a>发送短信验证码接口开发</h2><ul>
<li>首先同样封装一个请求参数，在后端接口参数多加一个校验</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotBlank;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberSendCodeReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【手机号】不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;^1\\d&#123;10&#125;$&quot;,message = &quot;手机号码格式错误&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMobile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMobile</span><span class="params">(String mobile)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mobile = mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;MemberSendCodeReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;mobile=&#x27;&quot;</span>).append(mobile).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在MemberService中写对应得发送验证码方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendCode</span><span class="params">(MemberSendCodeReq req)</span>&#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">mobile</span> <span class="operator">=</span> req.getMobile();</span><br><span class="line">       <span class="type">MemberExample</span> <span class="variable">memberExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemberExample</span>();</span><br><span class="line">       memberExample.createCriteria().andMobileEqualTo(mobile);</span><br><span class="line">       List&lt;Member&gt; list = memberMapper.selectByExample(memberExample);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//如果手机号不存在，则插入一个记录</span></span><br><span class="line">       <span class="keyword">if</span> (CollUtil.isEmpty(list))&#123;</span><br><span class="line">           LOG.info(<span class="string">&quot;手机号不存在，插入一条记录&quot;</span>);</span><br><span class="line">           <span class="type">Member</span> <span class="variable">member</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Member</span>();</span><br><span class="line">           member.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">           member.setMobile(mobile);</span><br><span class="line">           memberMapper.insert(member);</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           LOG.info(<span class="string">&quot;手机号存在，不插入记录&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">      <span class="comment">//生成验证码</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomString(<span class="number">4</span>);</span><br><span class="line">       LOG.info(<span class="string">&quot;生成短信验证码：&#123;&#125;&quot;</span>,code);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//保存短信记录表：手机号，短信验证码，有效期，是否已被使用，业务类型，发送时间，使用时间</span></span><br><span class="line">       LOG.info(<span class="string">&quot;保存短信记录表&quot;</span>);</span><br><span class="line">       <span class="comment">//对接短信通道，发送短信</span></span><br><span class="line">       LOG.info(<span class="string">&quot;对接短信通道&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在MemberController中使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/send-code&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;Long&gt; <span class="title function_">sendCode</span><span class="params">(<span class="meta">@Valid</span> MemberSendCodeReq req)</span>&#123;</span><br><span class="line">    memberService.sendCode(req);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="短信验证码登录接口开发"><a href="#短信验证码登录接口开发" class="headerlink" title="短信验证码登录接口开发"></a>短信验证码登录接口开发</h2><ul>
<li>同样开发登陆接口也需要先封装下请求参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotBlank;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberLoginReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【手机号】不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;^1\\d&#123;10&#125;$&quot;,message = &quot;手机号码格式错误&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【验证码】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMobile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMobile</span><span class="params">(String mobile)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mobile = mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;MemberLoginReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;mobile=&#x27;&quot;</span>).append(mobile).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, code=&#x27;&quot;</span>).append(code).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来我们该MemberService，将公共部分提取成一个方法，然后增加一个登陆接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.ObjectUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.exception.BusinessExceptionEnum;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.util.SnowUtil;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.domain.Member;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.domain.MemberExample;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.mapper.MemberMapper;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.req.MemberLoginReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.req.MemberRegisterReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.req.MemberSendCodeReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.resp.MemberLoginResp;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(MemberService.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberMapper memberMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">count</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Math.toIntExact(memberMapper.countByExample(<span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">register</span><span class="params">(MemberRegisterReq req)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mobile</span> <span class="operator">=</span> req.getMobile();</span><br><span class="line">        <span class="type">Member</span> <span class="variable">memberDB</span> <span class="operator">=</span> selectByMobile(mobile);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtil.isNull(memberDB))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.MEMBER_MOBILE_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Member</span> <span class="variable">member</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Member</span>();</span><br><span class="line">        member.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">        member.setMobile(mobile);</span><br><span class="line">        memberMapper.insert(member);</span><br><span class="line">        <span class="keyword">return</span> member.getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendCode</span><span class="params">(MemberSendCodeReq req)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mobile</span> <span class="operator">=</span> req.getMobile();</span><br><span class="line">        <span class="type">Member</span> <span class="variable">memberDB</span> <span class="operator">=</span> selectByMobile(mobile);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果手机号不存在，则插入一个记录</span></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtil.isNull(memberDB))&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;手机号不存在，插入一条记录&quot;</span>);</span><br><span class="line">            <span class="type">Member</span> <span class="variable">member</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Member</span>();</span><br><span class="line">            member.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">            member.setMobile(mobile);</span><br><span class="line">            memberMapper.insert(member);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;手机号存在，不插入记录&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">//生成验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> <span class="string">&quot;8888&quot;</span>;</span><br><span class="line">        LOG.info(<span class="string">&quot;生成短信验证码：&#123;&#125;&quot;</span>,code);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存短信记录表：手机号，短信验证码，有效期，是否已被使用，业务类型，发送时间，使用时间</span></span><br><span class="line">        LOG.info(<span class="string">&quot;保存短信记录表&quot;</span>);</span><br><span class="line">        <span class="comment">//对接短信通道，发送短信</span></span><br><span class="line">        LOG.info(<span class="string">&quot;对接短信通道&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MemberLoginResp <span class="title function_">login</span><span class="params">(MemberLoginReq req)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mobile</span> <span class="operator">=</span> req.getMobile();</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span>req.getCode();</span><br><span class="line">        <span class="type">Member</span> <span class="variable">memberDB</span> <span class="operator">=</span> selectByMobile(mobile);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果手机号不存在，则插入一个记录</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtil.isNull(memberDB))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.MEMBER_MOBILE_NOT_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;8888&quot;</span>.equals(code))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.MEMBER_MOBILE_CODE_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">MemberLoginResp</span> <span class="variable">memberLoginResp</span> <span class="operator">=</span> BeanUtil.copyProperties(memberDB,MemberLoginResp.class);</span><br><span class="line">        <span class="keyword">return</span> memberLoginResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Member <span class="title function_">selectByMobile</span><span class="params">(String mobile)</span> &#123;</span><br><span class="line">        <span class="type">MemberExample</span> <span class="variable">memberExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemberExample</span>();</span><br><span class="line">        memberExample.createCriteria().andMobileEqualTo(mobile);</span><br><span class="line">        List&lt;Member&gt; list =  memberMapper.selectByExample(memberExample);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isEmpty(list))&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> list.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>登陆接口需要返回一些信息，因此我们在member下新建软件包resp来存返回的参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.resp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberLoginResp</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMobile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMobile</span><span class="params">(String mobile)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mobile = mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        sb.append(getClass().getSimpleName());</span><br><span class="line">        sb.append(<span class="string">&quot; [&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;Hash = &quot;</span>).append(hashCode());</span><br><span class="line">        sb.append(<span class="string">&quot;, id=&quot;</span>).append(id);</span><br><span class="line">        sb.append(<span class="string">&quot;, mobile=&quot;</span>).append(mobile);</span><br><span class="line">        sb.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在Service中，我们还引用了BusinessExceptionEnum得两个枚举</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MEMBER_MOBILE_NOT_EXIST(<span class="string">&quot;请先获取短信验证码&quot;</span>),</span><br><span class="line">MEMBER_MOBILE_CODE_ERROR(<span class="string">&quot;短信验证码错误&quot;</span>),</span><br></pre></td></tr></table></figure>

<ul>
<li>在MemberController方法中调用接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;MemberLoginResp&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@Valid</span> MemberLoginReq req)</span>&#123;</span><br><span class="line">    <span class="type">MemberLoginResp</span> <span class="variable">resp</span> <span class="operator">=</span> memberService.login(req);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(resp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="集成Axios完成登录功能"><a href="#集成Axios完成登录功能" class="headerlink" title="集成Axios完成登录功能"></a>集成Axios完成登录功能</h2><ul>
<li>前端调用后端需要一个npm一个axios</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install axios</span><br></pre></td></tr></table></figure>

<ul>
<li>接着我们以login得获取验证码为例，写他的js方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">sendCode</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      axios.<span class="title function_">post</span>(<span class="string">&quot;http://localhost:8001/member/member/send-code&quot;</span>,&#123;</span><br><span class="line">        <span class="attr">mobile</span>: loginForm.<span class="property">mobile</span></span><br><span class="line">      &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(response)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>我们发现前端报了一个跨域错误：</p>
<ul>
<li>跨域：前后端不在同一个域。IP一样，端口不一样，也算跨域</li>
</ul>
</li>
<li><p>解决跨域问题，就需要在网关模块中得配置文件增加跨域配置</p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许请求来源（老版本叫allowedOrigin）</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.globalcors.cors-configurations.[/**].allowedOriginPatterns</span>=<span class="string">*</span></span><br><span class="line"><span class="comment"># 允许携带的头信息</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.globalcors.cors-configurations.[/**].allowedHeaders</span>=<span class="string">*</span></span><br><span class="line"><span class="comment"># 允许的请求方式</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.globalcors.cors-configurations.[/**].allowedMethods</span>=<span class="string">*</span></span><br><span class="line"><span class="comment"># 是否允许携带cookie</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.globalcors.cors-configurations.[/**].allowCredentials</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 跨域检测的有效期，会发起一个OPTION请求</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.globalcors.cors-configurations.[/**].maxAge</span>=<span class="string">3600</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这样就解决了，但是呢，发送验证码显示的是手机号不能为空，这是因为我们后端Controller的请求参数没有设置成json的，现在我们给发送验证码的controller的请求参数添加@RequestBody</li>
<li>将后端接口改成body json方式传递参数，前后端联调成功</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/send-code&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;Long&gt; <span class="title function_">sendCode</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> MemberSendCodeReq req)</span>&#123;</span><br><span class="line">    memberService.sendCode(req);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当然其他的controller接收参数的方法也都添加上@RequestBody</li>
<li>然后我们要给前端加上一些消息通知等组件，及完善发送验证码等方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;notification&#125; <span class="keyword">from</span> <span class="string">&quot;ant-design-vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">const</span> <span class="title function_">sendCode</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      axios.<span class="title function_">post</span>(<span class="string">&quot;http://localhost:8000/member/member/send-code&quot;</span>,&#123;</span><br><span class="line">        <span class="attr">mobile</span>: loginForm.<span class="property">mobile</span></span><br><span class="line">      &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">        <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">          notification.<span class="title function_">success</span>(&#123;<span class="attr">description</span>:<span class="string">&#x27;发送验证码成功！&#x27;</span>&#125;);</span><br><span class="line">          loginForm.<span class="property">code</span>=<span class="string">&quot;8888&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">login</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      axios.<span class="title function_">post</span>(<span class="string">&quot;http://localhost:8000/member/member/login&quot;</span>,loginForm).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">        <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">          notification.<span class="title function_">success</span>(&#123;<span class="attr">description</span>:<span class="string">&#x27;登陆成功！&#x27;</span>&#125;);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<h2 id="增加Axios拦截器配置"><a href="#增加Axios拦截器配置" class="headerlink" title="增加Axios拦截器配置"></a>增加Axios拦截器配置</h2><ul>
<li>添加一个axios拦截器，让他打印出前端到后端的请求（包括请求日志和返回结果）</li>
<li>我们在main.js中添加axios拦截器</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * axios拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">config</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;请求参数：&#x27;</span>, config);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">&#125;, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;);</span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;返回结果：&#x27;</span>, response);</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;返回错误：&#x27;</span>, error);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">baseURL</span> = process.<span class="property">env</span>.<span class="property">VUE_APP_SERVER</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Vue-CLI多环境配置"><a href="#Vue-CLI多环境配置" class="headerlink" title="Vue CLI多环境配置"></a>Vue CLI多环境配置</h2><ul>
<li>在web根目录下增加文件 .env.xxx，xxx表是不同的环境</li>
<li>开发环境 .env.dev</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV=development</span><br><span class="line">VUE_APP_SERVER=http://localhost:8000</span><br></pre></td></tr></table></figure>

<ul>
<li>生产环境 .env.prod</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV=production</span><br><span class="line">VUE_APP_SERVER=http://train.fzx.com</span><br></pre></td></tr></table></figure>

<ul>
<li><p>NODE_ENV是内置变量</p>
</li>
<li><p>自定义变量用“VUE_APP_”开头</p>
</li>
<li><p>使用变量：process.env. xxx，我们在使用axios请求url的时候可以增加一个前缀,这样post url的时候就不用添加前面的网址了，就是动态的。先在main.js里面定义</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="property">defaults</span>.<span class="property">baseURL</span> = process.<span class="property">env</span>.<span class="property">VUE_APP_SERVER</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们就可以在axios请求时这么写了</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">sendCode</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  axios.<span class="title function_">post</span>(<span class="string">&quot;/member/member/send-code&quot;</span>,&#123;</span><br><span class="line">    <span class="attr">mobile</span>: loginForm.<span class="property">mobile</span></span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">      notification.<span class="title function_">success</span>(&#123;<span class="attr">description</span>:<span class="string">&#x27;发送验证码成功！&#x27;</span>&#125;);</span><br><span class="line">      loginForm.<span class="property">code</span>=<span class="string">&quot;8888&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在使用前还得规定下使用的是哪一个环境，在package.json中定义</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;serve-dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-cli-service serve --mode dev --port 9000&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;serve-prod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-cli-service serve --mode prod --port 9000&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-cli-service build&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-cli-service lint&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<h2 id="增加web控台主页"><a href="#增加web控台主页" class="headerlink" title="增加web控台主页"></a>增加web控台主页</h2><ul>
<li><p>首先把没用的路由删去，增加一个main控台路由，并且在<a class="link"   target="_blank" rel="noopener" href="https://www.antdv.com/index" >Ant Design Vue<i class="fas fa-external-link-alt"></i></a>布局里面选一个自己喜欢的布局</p>
</li>
<li><p>增加路由</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main.vue&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加main.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-layout&gt;</span><br><span class="line">    &lt;a-layout-header class=&quot;header&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;logo&quot; /&gt;</span><br><span class="line">      &lt;a-menu</span><br><span class="line">          v-model:selectedKeys=&quot;selectedKeys1&quot;</span><br><span class="line">          theme=&quot;dark&quot;</span><br><span class="line">          mode=&quot;horizontal&quot;</span><br><span class="line">          :style=&quot;&#123; lineHeight: &#x27;64px&#x27; &#125;&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;a-menu-item key=&quot;1&quot;&gt;nav 1&lt;/a-menu-item&gt;</span><br><span class="line">        &lt;a-menu-item key=&quot;2&quot;&gt;nav 2&lt;/a-menu-item&gt;</span><br><span class="line">        &lt;a-menu-item key=&quot;3&quot;&gt;nav 3&lt;/a-menu-item&gt;</span><br><span class="line">      &lt;/a-menu&gt;</span><br><span class="line">    &lt;/a-layout-header&gt;</span><br><span class="line">    &lt;a-layout&gt;</span><br><span class="line">      &lt;a-layout-sider width=&quot;200&quot; style=&quot;background: #fff&quot;&gt;</span><br><span class="line">        &lt;a-menu</span><br><span class="line">            v-model:selectedKeys=&quot;selectedKeys2&quot;</span><br><span class="line">            v-model:openKeys=&quot;openKeys&quot;</span><br><span class="line">            mode=&quot;inline&quot;</span><br><span class="line">            :style=&quot;&#123; height: &#x27;100%&#x27;, borderRight: 0 &#125;&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;a-sub-menu key=&quot;sub1&quot;&gt;</span><br><span class="line">            &lt;template #title&gt;</span><br><span class="line">              &lt;span&gt;</span><br><span class="line">                &lt;user-outlined /&gt;</span><br><span class="line">                subnav 1</span><br><span class="line">              &lt;/span&gt;</span><br><span class="line">            &lt;/template&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;1&quot;&gt;option1&lt;/a-menu-item&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;2&quot;&gt;option2&lt;/a-menu-item&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;3&quot;&gt;option3&lt;/a-menu-item&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;4&quot;&gt;option4&lt;/a-menu-item&gt;</span><br><span class="line">          &lt;/a-sub-menu&gt;</span><br><span class="line">          &lt;a-sub-menu key=&quot;sub2&quot;&gt;</span><br><span class="line">            &lt;template #title&gt;</span><br><span class="line">              &lt;span&gt;</span><br><span class="line">                &lt;laptop-outlined /&gt;</span><br><span class="line">                subnav 2</span><br><span class="line">              &lt;/span&gt;</span><br><span class="line">            &lt;/template&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;5&quot;&gt;option5&lt;/a-menu-item&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;6&quot;&gt;option6&lt;/a-menu-item&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;7&quot;&gt;option7&lt;/a-menu-item&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;8&quot;&gt;option8&lt;/a-menu-item&gt;</span><br><span class="line">          &lt;/a-sub-menu&gt;</span><br><span class="line">          &lt;a-sub-menu key=&quot;sub3&quot;&gt;</span><br><span class="line">            &lt;template #title&gt;</span><br><span class="line">              &lt;span&gt;</span><br><span class="line">                &lt;notification-outlined /&gt;</span><br><span class="line">                subnav 3</span><br><span class="line">              &lt;/span&gt;</span><br><span class="line">            &lt;/template&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;9&quot;&gt;option9&lt;/a-menu-item&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;10&quot;&gt;option10&lt;/a-menu-item&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;11&quot;&gt;option11&lt;/a-menu-item&gt;</span><br><span class="line">            &lt;a-menu-item key=&quot;12&quot;&gt;option12&lt;/a-menu-item&gt;</span><br><span class="line">          &lt;/a-sub-menu&gt;</span><br><span class="line">        &lt;/a-menu&gt;</span><br><span class="line">      &lt;/a-layout-sider&gt;</span><br><span class="line">      &lt;a-layout style=&quot;padding: 0 24px 24px&quot;&gt;</span><br><span class="line">        &lt;a-breadcrumb style=&quot;margin: 16px 0&quot;&gt;</span><br><span class="line">          &lt;a-breadcrumb-item&gt;Home&lt;/a-breadcrumb-item&gt;</span><br><span class="line">          &lt;a-breadcrumb-item&gt;List&lt;/a-breadcrumb-item&gt;</span><br><span class="line">          &lt;a-breadcrumb-item&gt;App&lt;/a-breadcrumb-item&gt;</span><br><span class="line">        &lt;/a-breadcrumb&gt;</span><br><span class="line">        &lt;a-layout-content</span><br><span class="line">            :style=&quot;&#123; background: &#x27;#fff&#x27;, padding: &#x27;24px&#x27;, margin: 0, minHeight: &#x27;280px&#x27; &#125;&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          Content</span><br><span class="line">        &lt;/a-layout-content&gt;</span><br><span class="line">      &lt;/a-layout&gt;</span><br><span class="line">    &lt;/a-layout&gt;</span><br><span class="line">  &lt;/a-layout&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; UserOutlined, LaptopOutlined, NotificationOutlined &#125; from &#x27;@ant-design/icons-vue&#x27;;</span><br><span class="line">import &#123; defineComponent, ref &#125; from &#x27;vue&#x27;;</span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  components: &#123;</span><br><span class="line">    UserOutlined,</span><br><span class="line">    LaptopOutlined,</span><br><span class="line">    NotificationOutlined,</span><br><span class="line">  &#125;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      selectedKeys1: ref([&#x27;2&#x27;]),</span><br><span class="line">      selectedKeys2: ref([&#x27;1&#x27;]),</span><br><span class="line">      collapsed: ref(false),</span><br><span class="line">      openKeys: ref([&#x27;sub1&#x27;]),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">#components-layout-demo-top-side-2 .logo &#123;</span><br><span class="line">  float: left;</span><br><span class="line">  width: 120px;</span><br><span class="line">  height: 31px;</span><br><span class="line">  margin: 16px 24px 16px 0;</span><br><span class="line">  background: rgba(255, 255, 255, 0.3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.ant-row-rtl #components-layout-demo-top-side-2 .logo &#123;</span><br><span class="line">  float: right;</span><br><span class="line">  margin: 16px 0 16px 24px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.site-layout-background &#123;</span><br><span class="line">  background: #fff;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>下面进行路由跳转操作，我们先改下router里那个路由</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/login.vue&#x27;</span>)</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/main&#x27;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main.vue&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在登陆页面添加以下</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useRouter &#125; <span class="keyword">from</span>  <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> router =<span class="title function_">useRouter</span>();</span><br><span class="line">    ........</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//登陆成功里面添加</span></span><br><span class="line">router.<span class="title function_">push</span>(<span class="string">&quot;/main&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="制作Vue3公共组件"><a href="#制作Vue3公共组件" class="headerlink" title="制作Vue3公共组件"></a>制作Vue3公共组件</h2><ul>
<li>我们将一些公用部分抽出来作为公共组件，比如说导航栏和侧边栏</li>
<li>增加the-header组件，我们把header部分提取出来，放到components目录里面的the-header.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-layout-header class=&quot;header&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;logo&quot; /&gt;</span><br><span class="line">    &lt;a-menu</span><br><span class="line">        v-model:selectedKeys=&quot;selectedKeys1&quot;</span><br><span class="line">        theme=&quot;dark&quot;</span><br><span class="line">        mode=&quot;horizontal&quot;</span><br><span class="line">        :style=&quot;&#123; lineHeight: &#x27;64px&#x27; &#125;&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;a-menu-item key=&quot;1&quot;&gt;nav 1&lt;/a-menu-item&gt;</span><br><span class="line">      &lt;a-menu-item key=&quot;2&quot;&gt;nav 2&lt;/a-menu-item&gt;</span><br><span class="line">      &lt;a-menu-item key=&quot;3&quot;&gt;nav 3&lt;/a-menu-item&gt;</span><br><span class="line">    &lt;/a-menu&gt;</span><br><span class="line">  &lt;/a-layout-header&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;defineComponent, ref&#125; from &#x27;vue&#x27;;</span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;the-header-view&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      selectedKeys1: ref([&#x27;2&#x27;]),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Add &quot;scoped&quot; attribute to limit CSS to this component only --&gt;</span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用的时候就在页面的需要的部分添加</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;the-header-view&gt;&lt;/the-header-view&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就会自动导入了</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">TheHeaderView</span> <span class="keyword">from</span> <span class="string">&quot;@/components/the-header&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="attr">components</span>: &#123;</span><br><span class="line">    <span class="title class_">TheHeaderView</span>,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>the-sider-view操作跟上面一样</li>
</ul>
<h1 id="实现JWT单点登录功能"><a href="#实现JWT单点登录功能" class="headerlink" title="实现JWT单点登录功能"></a>实现JWT单点登录功能</h1><p>单点登录是企业项目中必有的一个功能。本章介绍两种常见的单点登录信息，一种是redis+token的方案，一种是jwt方案，都是项目中常用的，课程中使用的是jwt方案来实际单点登录功能。</p>
<hr>
<h2 id="介绍两种单点登录方案设计"><a href="#介绍两种单点登录方案设计" class="headerlink" title="介绍两种单点登录方案设计"></a>介绍两种单点登录方案设计</h2><ul>
<li><p>token+redis</p>
<ul>
<li>登陆开始-&gt;校验用户名密码-&gt;生成随机token，每次都不一样-&gt;将生成的token作为key，用户信息作为value存入到redis中</li>
<li>校验开始-&gt;从header获取token-&gt;根据token到redis中获取数据-&gt;判断是否有数据，如果有则校验成功，否则校验失败</li>
</ul>
</li>
<li><p>JWT</p>
<ul>
<li>登陆开始-&gt;校验用户名密码-&gt;生成JWTtoken，每次都不一样-&gt;将生成的token作为key，用户信息作为value存入到redis中（可要可不要）</li>
<li>校验开始-&gt;从header获取token-&gt;使用工具包校验token-&gt;判断是否校验成功，如果是则登陆校验成功，否则登陆校验失败</li>
</ul>
</li>
</ul>
<h2 id="JWT单点登录原理与存在的问题及解决方案讲解"><a href="#JWT单点登录原理与存在的问题及解决方案讲解" class="headerlink" title="JWT单点登录原理与存在的问题及解决方案讲解"></a>JWT单点登录原理与存在的问题及解决方案讲解</h2><ul>
<li>JWT原理：<a class="link"   target="_blank" rel="noopener" href="https://hutool.cn/docs/#/jwt/%E6%A6%82%E8%BF%B0?id=%E7%94%B1%E6%9D%A5" >https://hutool.cn/docs/#/jwt/概述?id=由来<i class="fas fa-external-link-alt"></i></a></li>
<li>JWT存在的问题及解决方案讲解<ul>
<li>问题：token被解密（解决：加盐值（密钥），每个项目的盐值不能一样）</li>
<li>问题：token被拿到第三方使用，自己的产品，被别人包了一个界面，做成他们收费的产品，比较典型的，就是2023年初出现的ChatGPT，很多人把它包成收费小程序（解决：没啥好方法，使用限流）</li>
</ul>
</li>
</ul>
<h2 id="详解生成JWT单点登录token"><a href="#详解生成JWT单点登录token" class="headerlink" title="详解生成JWT单点登录token"></a>详解生成JWT单点登录token</h2><ul>
<li>要是想登陆的时候返回token，那么就在MemberLoginResp中添加token字段，并生成set，get方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String token;</span><br></pre></td></tr></table></figure>

<ul>
<li>接着因为好多地方需要用到token，所以我们将其封装成一个公共工具JwtUtil</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateField;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateTime;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.jwt.JWT;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.jwt.JWTPayload;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.jwt.JWTUtil;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(JwtUtil.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 盐值很重要，不能泄露，每个项目都应该不一样，可以放到配置文件中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;fzx12306&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mobile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createToken</span><span class="params">(Long id,String mobile)</span>&#123;</span><br><span class="line">        <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">        <span class="type">DateTime</span> <span class="variable">expTime</span> <span class="operator">=</span> now.offsetNew(DateField.HOUR, <span class="number">24</span>);</span><br><span class="line">        HashMap&lt;String, Object&gt; payload = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//签发时间</span></span><br><span class="line">        payload.put(JWTPayload.ISSUED_AT,now);</span><br><span class="line">        <span class="comment">//过期时间</span></span><br><span class="line">        payload.put(JWTPayload.EXPIRES_AT,expTime);</span><br><span class="line">        <span class="comment">//生效时间</span></span><br><span class="line">        payload.put(JWTPayload.NOT_BEFORE,now);</span><br><span class="line">        <span class="comment">//内容</span></span><br><span class="line">        payload.put(<span class="string">&quot;id&quot;</span>,id);</span><br><span class="line">        payload.put(<span class="string">&quot;mobile&quot;</span>,mobile);</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JWTUtil.createToken(payload, key.getBytes());</span><br><span class="line">        LOG.info(<span class="string">&quot;生成JWT token:&#123;&#125;&quot;</span>,token);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">validate</span><span class="params">(String token)</span>&#123;</span><br><span class="line">        <span class="type">JWT</span> <span class="variable">jwt</span> <span class="operator">=</span> JWTUtil.parseToken(token).setKey(key.getBytes());</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">validate</span> <span class="operator">=</span> jwt.validate(<span class="number">0</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;JWT token校验结果：&#123;&#125;&quot;</span>,validate);</span><br><span class="line">        <span class="keyword">return</span> validate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title function_">getJSONObject</span><span class="params">(String token)</span>&#123;</span><br><span class="line">        <span class="type">JWT</span> <span class="variable">jwt</span> <span class="operator">=</span> JWTUtil.parseToken(token).setKey(key.getBytes());</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">payloads</span> <span class="operator">=</span> jwt.getPayloads();</span><br><span class="line">        payloads.remove(JWTPayload.ISSUED_AT);</span><br><span class="line">        payloads.remove(JWTPayload.EXPIRES_AT);</span><br><span class="line">        payloads.remove(JWTPayload.NOT_BEFORE);</span><br><span class="line">        LOG.info(<span class="string">&quot;根据token获取原始内容：&#123;&#125;&quot;</span>,payloads);</span><br><span class="line">        <span class="keyword">return</span> payloads;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在MemberService的login方法中使用，我们生成token后将其设置到返回memberLoginResp中</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MemberLoginResp</span> <span class="variable">memberLoginResp</span> <span class="operator">=</span> BeanUtil.copyProperties(memberDB,MemberLoginResp.class);</span><br><span class="line"><span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JwtUtil.createToken(memberLoginResp.getId(), memberLoginResp.getMobile());</span><br><span class="line">memberLoginResp.setToken(token);</span><br><span class="line"><span class="keyword">return</span> memberLoginResp;</span><br></pre></td></tr></table></figure>

<ul>
<li>还有一个问题，就是vue老是没事报错，把没必要的错就可以关了，这里我们修改package.json中eslintConfig的rules</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;vue/no-unused-components&quot;</span><span class="punctuation">:</span> <span class="string">&quot;off&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;vue/multi-word-component-names&quot;</span><span class="punctuation">:</span> <span class="string">&quot;off&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="使用vuex保存登录信息"><a href="#使用vuex保存登录信息" class="headerlink" title="使用vuex保存登录信息"></a>使用vuex保存登录信息</h2><ul>
<li>首先在vue中的store设置一个全局变量，state这里面就相当于后端的dao层的字段，getters相当于get方法，mutations相当于set方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">member</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="title function_">setMember</span>(<span class="params">state,_member</span>)&#123;</span><br><span class="line">      state.<span class="property">member</span> = _member</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>在login跳转后就可以使用</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span></span><br><span class="line">store.<span class="title function_">commit</span>(<span class="string">&quot;setMember&quot;</span>,data.<span class="property">content</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>接着我们让保存的信息显示在主页导航栏的右上角，我们仅仅修改下the-header组件即可</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> member = store.<span class="property">state</span>.<span class="property">member</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    member,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>修改这个页面布置，就在logo下面添加这段代码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;div style=&quot;float: right; color: white&quot;&gt;</span><br><span class="line">  您好：&#123;&#123;member.mobile&#125;&#125;&amp;nbsp;&amp;nbsp;</span><br><span class="line">  &lt;router-link to=&quot;/&quot; style=&quot;color: white&quot;&gt;</span><br><span class="line">    推出登陆</span><br><span class="line">  &lt;/router-link&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<h2 id="vuex配合h5的session解决浏览器刷新问题"><a href="#vuex配合h5的session解决浏览器刷新问题" class="headerlink" title="vuex配合h5的session解决浏览器刷新问题"></a>vuex配合h5的session解决浏览器刷新问题</h2><ul>
<li>我们首先封装一下缓存的几个方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">SessionStorage</span>=&#123;</span><br><span class="line">    <span class="attr">get</span>:<span class="keyword">function</span> (<span class="params">key</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> v = sessionStorage.<span class="title function_">getItem</span>(key);</span><br><span class="line">        <span class="keyword">if</span> (v &amp;&amp; <span class="title function_">typeof</span>(v) !== <span class="string">&quot;undefined&quot;</span> &amp;&amp; v !== <span class="string">&quot;undefined&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(v);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">set</span>:<span class="keyword">function</span> (<span class="params">key,data</span>)&#123;</span><br><span class="line">        sessionStorage.<span class="title function_">setItem</span>(key,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">remove</span>: <span class="keyword">function</span> (<span class="params">key</span>)&#123;</span><br><span class="line">        sessionStorage.<span class="title function_">removeItem</span>(key);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">clearAll</span>:<span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">        sessionStorage.<span class="title function_">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们引用该js，在public的index.html中引用</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&lt;%= BASE_URL %&gt;js/session-storage.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后修改store</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 相当于key</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MEMBER</span> = <span class="string">&quot;MEMBER&quot;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="comment">//使用|| &#123;&#125;可以避免空指针异常</span></span><br><span class="line">    <span class="attr">member</span>: <span class="variable language_">window</span>.<span class="property">SessionStorage</span>.<span class="title function_">get</span>(<span class="variable constant_">MEMBER</span>) || &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="title function_">setMember</span>(<span class="params">state,_member</span>)&#123;</span><br><span class="line">      state.<span class="property">member</span> = _member;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">SessionStorage</span>.<span class="title class_">Set</span>(<span class="variable constant_">MEMBER</span>,_member);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="演示gateway拦截器的使用"><a href="#演示gateway拦截器的使用" class="headerlink" title="演示gateway拦截器的使用"></a>演示gateway拦截器的使用</h2><ul>
<li>就是在gateway模块下增加一个拦截器，继承两个方法，其中GlobalFilter是用来拦截的，Ordered是用来排序拦截器的执行顺序，从小到大依次执行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.gateway.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test1Filter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(Test1Filter.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Test1Filter&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="为gateway增加登录校验拦截器"><a href="#为gateway增加登录校验拦截器" class="headerlink" title="为gateway增加登录校验拦截器"></a>为gateway增加登录校验拦截器</h2><ul>
<li>首先我们先给gateway增加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>接着我们搞一个工具，将公共类的JWT工具复制过来</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.gateway.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateField;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateTime;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.jwt.JWT;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.jwt.JWTPayload;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.jwt.JWTUtil;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(JwtUtil.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 盐值很重要，不能泄露，每个项目都应该不一样，可以放到配置文件中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;fzx12306&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mobile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createToken</span><span class="params">(Long id,String mobile)</span>&#123;</span><br><span class="line">        <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">        <span class="type">DateTime</span> <span class="variable">expTime</span> <span class="operator">=</span> now.offsetNew(DateField.HOUR, <span class="number">24</span>);</span><br><span class="line">        HashMap&lt;String, Object&gt; payload = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//签发时间</span></span><br><span class="line">        payload.put(JWTPayload.ISSUED_AT,now);</span><br><span class="line">        <span class="comment">//过期时间</span></span><br><span class="line">        payload.put(JWTPayload.EXPIRES_AT,expTime);</span><br><span class="line">        <span class="comment">//生效时间</span></span><br><span class="line">        payload.put(JWTPayload.NOT_BEFORE,now);</span><br><span class="line">        <span class="comment">//内容</span></span><br><span class="line">        payload.put(<span class="string">&quot;id&quot;</span>,id);</span><br><span class="line">        payload.put(<span class="string">&quot;mobile&quot;</span>,mobile);</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JWTUtil.createToken(payload, key.getBytes());</span><br><span class="line">        LOG.info(<span class="string">&quot;生成JWT token:&#123;&#125;&quot;</span>,token);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">validate</span><span class="params">(String token)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">JWT</span> <span class="variable">jwt</span> <span class="operator">=</span> JWTUtil.parseToken(token).setKey(key.getBytes());</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">validate</span> <span class="operator">=</span> jwt.validate(<span class="number">0</span>);</span><br><span class="line">            LOG.info(<span class="string">&quot;JWT token校验结果：&#123;&#125;&quot;</span>,validate);</span><br><span class="line">            <span class="keyword">return</span> validate;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;JWT token校验异常：&#123;&#125;&quot;</span>,e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title function_">getJSONObject</span><span class="params">(String token)</span>&#123;</span><br><span class="line">        <span class="type">JWT</span> <span class="variable">jwt</span> <span class="operator">=</span> JWTUtil.parseToken(token).setKey(key.getBytes());</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">payloads</span> <span class="operator">=</span> jwt.getPayloads();</span><br><span class="line">        payloads.remove(JWTPayload.ISSUED_AT);</span><br><span class="line">        payloads.remove(JWTPayload.EXPIRES_AT);</span><br><span class="line">        payloads.remove(JWTPayload.NOT_BEFORE);</span><br><span class="line">        LOG.info(<span class="string">&quot;根据token获取原始内容：&#123;&#125;&quot;</span>,payloads);</span><br><span class="line">        <span class="keyword">return</span> payloads;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们修改拦截器，在gateway.config中</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.gateway.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.jwt.JWTUtil;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.gateway.util.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginMemberFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(LoginMemberFilter.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> exchange.getRequest().getURI().getPath();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//排除不需要拦截的请求</span></span><br><span class="line">        <span class="keyword">if</span> (path.contains(<span class="string">&quot;/admin&quot;</span>)</span><br><span class="line">                || path.contains(<span class="string">&quot;/hello&quot;</span>)</span><br><span class="line">                || path.contains(<span class="string">&quot;member/member/login&quot;</span>)</span><br><span class="line">                || path.contains(<span class="string">&quot;member/member/send-code&quot;</span>))&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;不需要登陆验证：&#123;&#125;&quot;</span>,path);</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;需要登陆验证：&#123;&#125;&quot;</span>,path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取header的token参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> exchange.getRequest().getHeaders().getFirst(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;会员登陆验证开始，token：&#123;&#125;&quot;</span>,token);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span> || token.isEmpty())&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;token为空，请求被拦截&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//校验token是否有效，包括token是否被改过，是否过期</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">validate</span> <span class="operator">=</span> JwtUtil.validate(token);</span><br><span class="line">        <span class="keyword">if</span> (validate)&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;token有效，放行该请求&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;token无效，请求被拦截&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="为axios请求增加统一拦截器"><a href="#为axios请求增加统一拦截器" class="headerlink" title="为axios请求增加统一拦截器"></a>为axios请求增加统一拦截器</h2><ul>
<li>我们给主控台增加内容，修改views的main.vue</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> &lt;a-layout-content</span><br><span class="line">            :style=<span class="string">&quot;&#123; background: &#x27;#fff&#x27;, padding: &#x27;24px&#x27;, margin: 0, minHeight: &#x27;280px&#x27; &#125;&quot;</span></span><br><span class="line">        &gt;</span><br><span class="line">          所有会员总数&#123;&#123;count&#125;&#125;&#125;</span><br><span class="line">&lt;/a-layout-content&gt;</span><br><span class="line">        </span><br><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>);</span><br><span class="line">  axios.<span class="title function_">get</span>(<span class="string">&quot;/member/member/count&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data =response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">      count.<span class="property">value</span> = data.<span class="property">content</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    count</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>但是到这一步，就发现所有会员总数一直为0，原因是没有token传过来，我们在这为axios请求增加统一拦截器（在main.js）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">axios.interceptors.request.use(function (config) &#123;</span><br><span class="line">    console.log(<span class="string">&#x27;请求参数：&#x27;</span>, config);</span><br><span class="line">    <span class="type">const</span> <span class="variable">_token</span> <span class="operator">=</span> store.state.member.token;</span><br><span class="line">    <span class="keyword">if</span> (_token)&#123;</span><br><span class="line">        config.headers.token = _token;</span><br><span class="line">        console.log(<span class="string">&quot;请求headers增加token：&quot;</span>, _token)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">&#125;, error =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> Promise.reject(error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>但是如果停留太久，一刷新他又成0了，是因为token过期了，但是这时候用户不知道，所以我们在相应处也要加一个拦截器</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;返回结果：&#x27;</span>, response);</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;返回错误：&#x27;</span>, error);</span><br><span class="line">    <span class="keyword">const</span> response = error.<span class="property">response</span>;</span><br><span class="line">    <span class="keyword">const</span> status = response.<span class="property">status</span>;</span><br><span class="line">    <span class="keyword">if</span> (status ===<span class="number">401</span>)&#123;</span><br><span class="line">        <span class="comment">//判断状态码是401 跳转登陆页面</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&quot;未登录或者登陆超时，跳转到登陆页面&quot;</span>);</span><br><span class="line">        store.<span class="title function_">commit</span>(<span class="string">&quot;setMember&quot;</span>,&#123;&#125;);</span><br><span class="line">        notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:<span class="string">&quot;未登录或者登陆超时&quot;</span>&#125;);</span><br><span class="line">        router.<span class="title function_">push</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="为路由页面增加登录拦截"><a href="#为路由页面增加登录拦截" class="headerlink" title="为路由页面增加登录拦截"></a>为路由页面增加登录拦截</h2><ul>
<li>就修改router就可以了，首先在需要拦截的路由处加一个开关</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/main&#x27;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main.vue&#x27;</span>),</span><br><span class="line">  <span class="attr">meta</span>:&#123;</span><br><span class="line">    <span class="attr">loginRequire</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就加一个判断</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//路由登陆拦截</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(to.<span class="property">matched</span>.<span class="title function_">some</span>(<span class="keyword">function</span> (<span class="params">item</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(item,<span class="string">&quot;是否需要登陆校验：&quot;</span>,item.<span class="property">meta</span>.<span class="property">loginRequire</span> ||<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> item.<span class="property">meta</span>.<span class="property">loginRequire</span></span><br><span class="line">  &#125;))&#123;</span><br><span class="line">  <span class="keyword">const</span> _member = store.<span class="property">state</span>.<span class="property">member</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;页面登陆校验开始：&quot;</span>,_member);</span><br><span class="line">    <span class="keyword">if</span> (!_member.<span class="property">token</span>)&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;用户未登录或登陆超时！&quot;</span>);</span><br><span class="line">      notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:<span class="string">&quot;用户未登录或登陆超时&quot;</span>&#125;)</span><br><span class="line">      <span class="title function_">next</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="12306系统会员基础功能的实现"><a href="#12306系统会员基础功能的实现" class="headerlink" title="12306系统会员基础功能的实现"></a>12306系统会员基础功能的实现</h1><p>本章将带领大家完成会员模块的相关功能，其中包括会员注册、登录，乘车人管理等，详细讲解单点登录,以及使用Gateway增加登录校验，对会员业务功能进行统一做异常处理，并对乘车人相关接口、界面进行开发，为后续购票功能做准备。…</p>
<hr>
<h2 id="详解乘车人表的设计"><a href="#详解乘车人表的设计" class="headerlink" title="详解乘车人表的设计"></a>详解乘车人表的设计</h2><ul>
<li>我们将乘车人的数据库表存入到数据库</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `passenger`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `passenger` (</span><br><span class="line">                             `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">                             `member_id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;会员id&#x27;</span>,</span><br><span class="line">                             `name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">                             `id_card` <span class="type">varchar</span>(<span class="number">18</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;身份证&#x27;</span>,</span><br><span class="line">                             `type` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;旅客类型|枚举[PassengerTypeEnum]&#x27;</span>,</span><br><span class="line">                             `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">                             `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">                             <span class="keyword">primary</span> key (`id`),</span><br><span class="line">                             index `member_id_index` (`member_id`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;乘车人&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就可以用代码生成器生成代码了</li>
<li>可以看到数据库有一个游客类型，用枚举表示，所以我们建一个枚举类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">PassengerTypeEnum</span> &#123;</span><br><span class="line">    ADULT(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;成人&quot;</span>),</span><br><span class="line">    CHILD(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;儿童&quot;</span>),</span><br><span class="line">    STUDENT(<span class="string">&quot;13&quot;</span>,<span class="string">&quot;学生&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    PassengerTypeEnum(String code, String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDesc</span><span class="params">(String desc)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="乘车人新增接口开发"><a href="#乘车人新增接口开发" class="headerlink" title="乘车人新增接口开发"></a>乘车人新增接口开发</h2><ul>
<li>首先我们设置请求类，和表结构一致就可以了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotBlank;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PassengerSaveReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【会员ID】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long memberId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【名字】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【身份证】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String idCard;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【旅客类型】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getMemberId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMemberId</span><span class="params">(Long memberId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.memberId = memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getIdCard</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> idCard;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIdCard</span><span class="params">(String idCard)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.idCard = idCard;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setType</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getCreateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreateTime</span><span class="params">(Date createTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getUpdateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdateTime</span><span class="params">(Date updateTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateTime = updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        sb.append(getClass().getSimpleName());</span><br><span class="line">        sb.append(<span class="string">&quot; [&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;Hash = &quot;</span>).append(hashCode());</span><br><span class="line">        sb.append(<span class="string">&quot;, id=&quot;</span>).append(id);</span><br><span class="line">        sb.append(<span class="string">&quot;, memberId=&quot;</span>).append(memberId);</span><br><span class="line">        sb.append(<span class="string">&quot;, name=&quot;</span>).append(name);</span><br><span class="line">        sb.append(<span class="string">&quot;, idCard=&quot;</span>).append(idCard);</span><br><span class="line">        sb.append(<span class="string">&quot;, type=&quot;</span>).append(type);</span><br><span class="line">        sb.append(<span class="string">&quot;, createTime=&quot;</span>).append(createTime);</span><br><span class="line">        sb.append(<span class="string">&quot;, updateTime=&quot;</span>).append(updateTime);</span><br><span class="line">        sb.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们实现service层</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateTime;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.util.SnowUtil;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.domain.Passenger;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.mapper.PassengerMapper;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.req.PassengerSaveReq;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PassengerService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PassengerMapper passengerMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(PassengerSaveReq req)</span>&#123;</span><br><span class="line">        <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">        <span class="type">Passenger</span> <span class="variable">passenger</span> <span class="operator">=</span> BeanUtil.copyProperties(req, Passenger.class);</span><br><span class="line">        passenger.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">        passenger.setCreateTime(now);</span><br><span class="line">        passenger.setUpdateTime(now);</span><br><span class="line">        passengerMapper.insert(passenger);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>controller层</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.req.PassengerSaveReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.service.PassengerService;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/passenger&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PassengerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PassengerService passengerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;Object&gt; <span class="title function_">save</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> PassengerSaveReq req)</span>&#123;</span><br><span class="line">        passengerService.save(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用HttpClient保存登录信息"><a href="#使用HttpClient保存登录信息" class="headerlink" title="使用HttpClient保存登录信息"></a>使用HttpClient保存登录信息</h2><ul>
<li>我们每次要是通过http测试的时候，都需要手动设置token就是很麻烦，所以我们在登陆测试的后面添加这一段</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">###</span><br><span class="line">POST http://localhost:8000/member/member/login</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;mobile&quot;: &quot;12345678910&quot;,</span><br><span class="line">  &quot;code&quot;: &quot;8888&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt; &#123;%</span><br><span class="line">client.log(JSON.stringify(response.body));</span><br><span class="line">client.log(JSON.stringify(response.body.content.token));</span><br><span class="line">client.global.set(&quot;token&quot;,response.body.content.token)</span><br><span class="line">%&#125;</span><br><span class="line">###</span><br></pre></td></tr></table></figure>

<ul>
<li>使用的话就加一个token变量</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST http://localhost:8000/member/passenger/save</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line">token:&#123;&#123;token&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;memberId&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;test&quot;,</span><br><span class="line">  &quot;idCard&quot;: &quot;1654&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###</span><br></pre></td></tr></table></figure>

<h2 id="使用线程本地变量存储会员信息"><a href="#使用线程本地变量存储会员信息" class="headerlink" title="使用线程本地变量存储会员信息"></a>使用线程本地变量存储会员信息</h2><ul>
<li>memberId这个值是不需要我们前端传入的，只需要在token中获取即可，可以在controller入口通过request获得header，进而获得token及会员信息，所以我们要有一个地方同一去拦截token（在common模块就行）</li>
<li>本节方案：在接口入口获取会员信息，并放到线程本地变量，则在controller、service都可直接从线程本地变量获取会员信息</li>
<li>我们在common模块创建context软件包，装前后端交互的上下文，并且由于MemberLoginResp是比较通用的，所以将这个也放到common的resp目录下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.MemberLoginResp;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginMemberContext</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(LoginMemberContext.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;MemberLoginResp&gt; member = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MemberLoginResp <span class="title function_">getMember</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> member.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setMember</span><span class="params">(MemberLoginResp member)</span>&#123;</span><br><span class="line">        LoginMemberContext.member.set(member);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">getId</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> member.get().getId();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;获取登陆会员信息异常&quot;</span>,e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在common的模块下新建一个interceptor软件包加一个拦截器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONUtil;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.context.LoginMemberContext;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.MemberLoginResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.util.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截器；Spring框架特有的，常用于登录校验，权限校验，请求日志打印</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(MemberInterceptor.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//获取header的token参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(token))&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;获取会员登陆token：&#123;&#125;&quot;</span>,token);</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">loginMember</span> <span class="operator">=</span> JwtUtil.getJSONObject(token);</span><br><span class="line">            LOG.info(<span class="string">&quot;当前登陆会员：&#123;&#125;&quot;</span>,loginMember);</span><br><span class="line">            <span class="type">MemberLoginResp</span> <span class="variable">member</span> <span class="operator">=</span> JSONUtil.toBean(loginMember, MemberLoginResp.class);</span><br><span class="line">            LoginMemberContext.setMember(member);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这时有了拦截器，但是还不能生效，我们需要加一个配置，拦截器的开启需要定义在需要开启特定拦截器的模块下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.interceptor.MemberInterceptor;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    MemberInterceptor memberInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(memberInterceptor)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(</span><br><span class="line">                        <span class="string">&quot;/member/hello&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/member/member/send-code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/member/member/login&quot;</span></span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>记得在模块启动类上加@ComponentScan(“com.fzx”)</li>
<li>做了这么多工作就是为了保存乘客信息的时候会员ID不需要传过来，这时我们只需要把PassengerService的save方法加上这行代码即可</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passenger.setMemberId(LoginMemberContext.getId());</span><br></pre></td></tr></table></figure>

<ul>
<li><p>PassengerSaveReq的会员ID也就不用校验了</p>
</li>
<li><p>为什么拦截器所在的日志没有日志号呢？是因为AOP的层级比较高，先走的拦截器再走的日志AOP，所以拦截器那没有日志号，那么我们就在common模块新增一个日志拦截器</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.MDC;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        MDC.put(<span class="string">&quot;LOG_ID&quot;</span>,System.currentTimeMillis() + RandomUtil.randomString(<span class="number">3</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>再需要开启的模块开启，在member模块的SpringMvcConfig开启</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.interceptor.LogInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.interceptor.MemberInterceptor;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    MemberInterceptor memberInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    LogInterceptor logInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(logInterceptor);</span><br><span class="line">        registry.addInterceptor(memberInterceptor)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(</span><br><span class="line">                        <span class="string">&quot;/member/hello&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/member/member/send-code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/member/member/login&quot;</span></span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="前端二级路由页面开发"><a href="#前端二级路由页面开发" class="headerlink" title="前端二级路由页面开发"></a>前端二级路由页面开发</h2><ul>
<li>第一步先创建需要的页面，这里我们在views下创建main&#x2F;welcom.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;欢迎来到12306售票系统&lt;/h1&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123; defineComponent &#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;welcome-view&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们修改main.vue该删删</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-layout id=&quot;components-layout-demo-top-side-2&quot;&gt;</span><br><span class="line">    &lt;the-header-view&gt;&lt;/the-header-view&gt;</span><br><span class="line">    &lt;a-layout&gt;</span><br><span class="line">      &lt;the-sider-view&gt;&lt;/the-sider-view&gt;</span><br><span class="line">      &lt;a-layout-content</span><br><span class="line">          :style=&quot;&#123; background: &#x27;#fff&#x27;, padding: &#x27;24px&#x27;, margin: 0, minHeight: &#x27;280px&#x27; &#125;&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">      &lt;/a-layout-content&gt;</span><br><span class="line">    &lt;/a-layout&gt;</span><br><span class="line">  &lt;/a-layout&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; defineComponent&#125; from &#x27;vue&#x27;;</span><br><span class="line">import TheHeaderView from &quot;@/components/the-header&quot;;</span><br><span class="line">import TheSiderView from &quot;@/components/the-sider&quot;;</span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  components: &#123;</span><br><span class="line">    TheSiderView,</span><br><span class="line">    TheHeaderView,</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  setup() &#123;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">#components-layout-demo-top-side-2 .logo &#123;</span><br><span class="line">  float: left;</span><br><span class="line">  width: 120px;</span><br><span class="line">  height: 31px;</span><br><span class="line">  margin: 16px 24px 16px 0;</span><br><span class="line">  background: rgba(255, 255, 255, 0.3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.ant-row-rtl #components-layout-demo-top-side-2 .logo &#123;</span><br><span class="line">  float: right;</span><br><span class="line">  margin: 16px 0 16px 24px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.site-layout-background &#123;</span><br><span class="line">  background: #fff;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在login.vue登陆成功处添加一个路由跳转</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">push</span>(<span class="string">&quot;/main/welcome&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>最后我们添加一个子路由</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/main/&#x27;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main.vue&#x27;</span>),</span><br><span class="line">  <span class="attr">meta</span>:&#123;</span><br><span class="line">    <span class="attr">loginRequire</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">children</span>:[&#123;</span><br><span class="line">    <span class="attr">path</span>:<span class="string">&#x27;welcome&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/welcome.vue&#x27;</span>),</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li><p>最后又适当的调整了一下路由跳转的代码</p>
</li>
<li><p>增加乘车人管理页面，设置一个子路由，添加一个页面</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">  <span class="attr">path</span>:<span class="string">&#x27;passenger&#x27;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/passenger.vue&#x27;</span>),</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;乘车管理&lt;/h1&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123; defineComponent &#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;welcome-view&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>下面我们修改下导航栏和侧边栏，把菜单都改成这个</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-menu-item key=&quot;/welcome&quot;&gt;</span><br><span class="line">  &lt;router-link to=&quot;/welcome&quot;&gt;</span><br><span class="line">    &lt;coffee-outlined/&gt;&amp;nbsp;欢迎</span><br><span class="line">  &lt;/router-link&gt;</span><br><span class="line">&lt;/a-menu-item&gt;</span><br><span class="line">&lt;a-menu-item key=&quot;/passenger&quot;&gt;</span><br><span class="line">  &lt;router-link to=&quot;/passenger&quot;&gt;</span><br><span class="line">    &lt;user-outlined/&gt;&amp;nbsp;乘车人管理</span><br><span class="line">  &lt;/router-link&gt;</span><br><span class="line">&lt;/a-menu-item&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现页面切换并同步激活，样式主要就是绑定一个这个变量</li>
<li>the-header.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-layout-header class=&quot;header&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;logo&quot; /&gt;</span><br><span class="line">    &lt;div style=&quot;float: right; color: white&quot;&gt;</span><br><span class="line">      您好：&#123;&#123;member.mobile&#125;&#125;&amp;nbsp;&amp;nbsp;</span><br><span class="line">      &lt;router-link to=&quot;/login&quot; style=&quot;color: white&quot;&gt;</span><br><span class="line">        推出登陆</span><br><span class="line">      &lt;/router-link&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;a-menu</span><br><span class="line">        v-model:selectedKeys=&quot;selectedKeys&quot;</span><br><span class="line">        theme=&quot;dark&quot;</span><br><span class="line">        mode=&quot;horizontal&quot;</span><br><span class="line">        :style=&quot;&#123; lineHeight: &#x27;64px&#x27; &#125;&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;a-menu-item key=&quot;/welcome&quot;&gt;</span><br><span class="line">        &lt;router-link to=&quot;/welcome&quot;&gt;</span><br><span class="line">          &lt;coffee-outlined/&gt;&amp;nbsp;欢迎</span><br><span class="line">        &lt;/router-link&gt;</span><br><span class="line">      &lt;/a-menu-item&gt;</span><br><span class="line">      &lt;a-menu-item key=&quot;/passenger&quot;&gt;</span><br><span class="line">        &lt;router-link to=&quot;/passenger&quot;&gt;</span><br><span class="line">          &lt;user-outlined/&gt;&amp;nbsp;乘车人管理</span><br><span class="line">        &lt;/router-link&gt;</span><br><span class="line">      &lt;/a-menu-item&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/a-menu&gt;</span><br><span class="line">  &lt;/a-layout-header&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;defineComponent, ref, watch&#125; from &#x27;vue&#x27;;</span><br><span class="line">import store from &#x27;@/store&#x27;</span><br><span class="line">import router from &#x27;@/router&#x27;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;the-header-view&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    let member = store.state.member;</span><br><span class="line">    const selectedKeys = ref([]);</span><br><span class="line"></span><br><span class="line">    watch(()=&gt;router.currentRoute.value.path,(newValue) =&gt;&#123;</span><br><span class="line">      console.log(&#x27;watch&#x27;,newValue);</span><br><span class="line">      selectedKeys.value = [];</span><br><span class="line">      selectedKeys.value.push(newValue);</span><br><span class="line">    &#125;,&#123;immediate:true&#125;);</span><br><span class="line">    return &#123;</span><br><span class="line">      member,</span><br><span class="line">      selectedKeys</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Add &quot;scoped&quot; attribute to limit CSS to this component only --&gt;</span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>the-sider.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-layout-sider width=&quot;200&quot; style=&quot;background: #fff&quot;&gt;</span><br><span class="line">    &lt;a-menu</span><br><span class="line">        v-model:selectedKeys=&quot;selectedKeys&quot;</span><br><span class="line">        mode=&quot;inline&quot;</span><br><span class="line">        :style=&quot;&#123; height: &#x27;100%&#x27;, borderRight: 0 &#125;&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;a-menu-item key=&quot;/welcome&quot;&gt;</span><br><span class="line">        &lt;router-link to=&quot;/welcome&quot;&gt;</span><br><span class="line">          &lt;coffee-outlined/&gt;&amp;nbsp;欢迎</span><br><span class="line">        &lt;/router-link&gt;</span><br><span class="line">      &lt;/a-menu-item&gt;</span><br><span class="line">      &lt;a-menu-item key=&quot;/passenger&quot;&gt;</span><br><span class="line">        &lt;router-link to=&quot;/passenger&quot;&gt;</span><br><span class="line">          &lt;user-outlined/&gt;&amp;nbsp;乘车人管理</span><br><span class="line">        &lt;/router-link&gt;</span><br><span class="line">      &lt;/a-menu-item&gt;</span><br><span class="line">    &lt;/a-menu&gt;</span><br><span class="line">  &lt;/a-layout-sider&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;defineComponent, ref, watch&#125; from &#x27;vue&#x27;;</span><br><span class="line">import router from &quot;@/router&quot;;</span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;the-sider-view&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const selectedKeys = ref([]);</span><br><span class="line"></span><br><span class="line">    watch(()=&gt;router.currentRoute.value.path,(newValue) =&gt;&#123;</span><br><span class="line">      console.log(&#x27;watch&#x27;,newValue);</span><br><span class="line">      selectedKeys.value = [];</span><br><span class="line">      selectedKeys.value.push(newValue);</span><br><span class="line">    &#125;,&#123;immediate:true&#125;);</span><br><span class="line">    return &#123;</span><br><span class="line">      selectedKeys</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Add &quot;scoped&quot; attribute to limit CSS to this component only --&gt;</span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h2 id="乘车人新增界面开发"><a href="#乘车人新增界面开发" class="headerlink" title="乘车人新增界面开发"></a>乘车人新增界面开发</h2><ul>
<li>乘车人新增页面开发，增加【新增】按钮</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-button type=&quot;primary&quot; @click=&quot;showModal&quot;&gt;新增&lt;/a-button&gt;</span><br><span class="line">  &lt;a-modal v-model:visible=&quot;visible&quot; title=&quot;乘车人&quot; @ok=&quot;handleOk&quot;&gt;</span><br><span class="line">    &lt;p&gt;...............&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;...............&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;...............&lt;/p&gt;</span><br><span class="line">  &lt;/a-modal&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123; defineComponent ,ref&#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;welcome-view&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const visible = ref(false);</span><br><span class="line">    const showModal = ()=&gt;&#123;</span><br><span class="line">      visible.value = true;</span><br><span class="line">    &#125;;</span><br><span class="line">    const handleOk = e =&gt;&#123;</span><br><span class="line">      console.log(e);</span><br><span class="line">      visible.value = false;</span><br><span class="line">    &#125;</span><br><span class="line">    return &#123;</span><br><span class="line">      visible,</span><br><span class="line">      showModal,</span><br><span class="line">      handleOk</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加乘车人表单，主要就是声明passenger对象，里面有各种属性，最后将对象返回出去</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-button type=&quot;primary&quot; @click=&quot;showModal&quot;&gt;新增&lt;/a-button&gt;</span><br><span class="line">  &lt;a-modal v-model:visible=&quot;visible&quot; title=&quot;乘车人&quot; @ok=&quot;handleOk&quot;</span><br><span class="line">           ok-text=&quot;确认&quot; cancel-text=&quot;取消&quot;&gt;</span><br><span class="line">    &lt;a-form :model=&quot;passenger&quot; :label-col=&quot;&#123;span: 4&#125;&quot; :wrapper-col=&quot;&#123; span: 20 &#125;&quot;&gt;</span><br><span class="line">      &lt;a-form-item label=&quot;姓名&quot;&gt;</span><br><span class="line">        &lt;a-input v-model:value=&quot;passenger.name&quot; /&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line">      &lt;a-form-item label=&quot;身份证&quot;&gt;</span><br><span class="line">        &lt;a-input v-model:value=&quot;passenger.idCard&quot; /&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line">      &lt;a-form-item label=&quot;旅客类型&quot;&gt;</span><br><span class="line">        &lt;a-select v-model:value=&quot;passenger.type&quot;&gt;</span><br><span class="line">          &lt;a-select-option value=&quot;1&quot;&gt;成人&lt;/a-select-option&gt;</span><br><span class="line">          &lt;a-select-option value=&quot;2&quot;&gt;儿童&lt;/a-select-option&gt;</span><br><span class="line">          &lt;a-select-option value=&quot;3&quot;&gt;学生&lt;/a-select-option&gt;</span><br><span class="line">        &lt;/a-select&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line">    &lt;/a-form&gt;</span><br><span class="line">  &lt;/a-modal&gt;&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123; defineComponent ,ref,reactive&#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;welcome-view&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const visible = ref(false);</span><br><span class="line">    const passenger = reactive(&#123;</span><br><span class="line">      id:undefined,</span><br><span class="line">      memberId:undefined,</span><br><span class="line">      name:undefined,</span><br><span class="line">      idCard:undefined,</span><br><span class="line">      type:undefined,</span><br><span class="line">      createTime:undefined,</span><br><span class="line">      updateTime:undefined</span><br><span class="line">    &#125;)</span><br><span class="line">    const showModal = ()=&gt;&#123;</span><br><span class="line">      visible.value = true;</span><br><span class="line">    &#125;;</span><br><span class="line">    const handleOk = e =&gt;&#123;</span><br><span class="line">      console.log(e);</span><br><span class="line">      visible.value = false;</span><br><span class="line">    &#125;</span><br><span class="line">    return &#123;</span><br><span class="line">      passenger,</span><br><span class="line">      visible,</span><br><span class="line">      showModal,</span><br><span class="line">      handleOk</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>给确认增加保存方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleOk</span> = e =&gt;&#123;</span><br><span class="line">  axios.<span class="title function_">post</span>(<span class="string">&quot;/member/passenger/save&quot;</span>,passenger).<span class="title function_">then</span>(<span class="function"><span class="params">response</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">      notification.<span class="title function_">success</span>(&#123;<span class="attr">description</span>:<span class="string">&quot;保存成功！&quot;</span>&#125;);</span><br><span class="line">      visible.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>: data.<span class="property">message</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="乘车人列表查询接口开发"><a href="#乘车人列表查询接口开发" class="headerlink" title="乘车人列表查询接口开发"></a>乘车人列表查询接口开发</h2><ul>
<li>我们查询列表，只需要根据memberId进行查询就行，因此把请求参数单独封装成一个类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotBlank;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PassengerQueryReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long memberId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getMemberId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMemberId</span><span class="params">(Long memberId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.memberId = memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;PassengerQueryReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;memberId=&quot;</span>).append(memberId);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们也将返回的结果重新封装成一个类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.resp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PassengerQueryResp</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long memberId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String idCard;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getMemberId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMemberId</span><span class="params">(Long memberId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.memberId = memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getIdCard</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> idCard;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIdCard</span><span class="params">(String idCard)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.idCard = idCard;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setType</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getCreateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreateTime</span><span class="params">(Date createTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getUpdateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdateTime</span><span class="params">(Date updateTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateTime = updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        sb.append(getClass().getSimpleName());</span><br><span class="line">        sb.append(<span class="string">&quot; [&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;Hash = &quot;</span>).append(hashCode());</span><br><span class="line">        sb.append(<span class="string">&quot;, id=&quot;</span>).append(id);</span><br><span class="line">        sb.append(<span class="string">&quot;, memberId=&quot;</span>).append(memberId);</span><br><span class="line">        sb.append(<span class="string">&quot;, name=&quot;</span>).append(name);</span><br><span class="line">        sb.append(<span class="string">&quot;, idCard=&quot;</span>).append(idCard);</span><br><span class="line">        sb.append(<span class="string">&quot;, type=&quot;</span>).append(type);</span><br><span class="line">        sb.append(<span class="string">&quot;, createTime=&quot;</span>).append(createTime);</span><br><span class="line">        sb.append(<span class="string">&quot;, updateTime=&quot;</span>).append(updateTime);</span><br><span class="line">        sb.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在PassengerService写一个方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;PassengerQueryResp&gt; <span class="title function_">queryList</span><span class="params">(PassengerQueryReq req)</span>&#123;</span><br><span class="line">    <span class="type">PassengerExample</span> <span class="variable">passengerExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PassengerExample</span>();</span><br><span class="line">    PassengerExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> passengerExample.createCriteria();</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtil.isNotNull(req.getMemberId()))&#123;</span><br><span class="line">        criteria.andMemberIdEqualTo(req.getMemberId());</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Passenger&gt; passengerList = passengerMapper.selectByExample(passengerExample);</span><br><span class="line">    <span class="keyword">return</span> BeanUtil.copyToList(passengerList,PassengerQueryResp.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再PassengerController写一个调用方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/query-list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;List&lt;PassengerQueryResp&gt;&gt; <span class="title function_">queryList</span><span class="params">(<span class="meta">@Valid</span> PassengerQueryReq req)</span>&#123;</span><br><span class="line">    req.setMemberId(LoginMemberContext.getId());</span><br><span class="line">    List&lt;PassengerQueryResp&gt; list = passengerService.queryList(req);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>增加乘车人列表查询接口，只能查看当前全员自己添加的乘客</p>
</blockquote>
<h2 id="集成PageHelper实现后端分页"><a href="#集成PageHelper实现后端分页" class="headerlink" title="集成PageHelper实现后端分页"></a>集成PageHelper实现后端分页</h2><ul>
<li>这里我们使用mybatis的插件，首先在根的pom.xml中引用</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在common模块中引用依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查询的时候，哪个Service涉及到了查询，就在那行代码上写上</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageHelper.startPage(<span class="number">2</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><blockquote>
<p>封装分页请求参数</p>
</blockquote>
</li>
<li><p>我们当然不能把分页参数直接写死，因为很多模块都用到了分页插件，所以我们将分页参数写道common的req中</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.Max;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotNull;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageReq</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【页码】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer page;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【每页条数】不能为空&quot;)</span></span><br><span class="line">    <span class="meta">@Max(value = 100,message = &quot;【每页条数】不能超过100&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getPage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPage</span><span class="params">(Integer page)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.page = page;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;PageReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;page=&quot;</span>).append(page);</span><br><span class="line">        sb.append(<span class="string">&quot;, size=&quot;</span>).append(size);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSize</span><span class="params">(Integer size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后让乘车人查询请求继承分页请求</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PassengerQueryReq</span> <span class="keyword">extends</span> <span class="title class_">PageReq</span> &#123;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用的话就</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageHelper.startPage(req.getPage(), req.getSize());</span><br></pre></td></tr></table></figure>

<blockquote>
<p>同样我们也要封装返回结果</p>
</blockquote>
<ul>
<li>在common模块封装返回结果</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.resp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageResp</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总条数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前页列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;PageResp&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;total=&quot;</span>).append(total);</span><br><span class="line">        sb.append(<span class="string">&quot;, list=&quot;</span>).append(list);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTotal</span><span class="params">(Long total)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.total = total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;T&gt; <span class="title function_">getList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setList</span><span class="params">(List&lt;T&gt; list)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改PassengerService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PageResp&lt;PassengerQueryResp&gt; <span class="title function_">queryList</span><span class="params">(PassengerQueryReq req)</span>&#123;</span><br><span class="line">    <span class="type">PassengerExample</span> <span class="variable">passengerExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PassengerExample</span>();</span><br><span class="line">    PassengerExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> passengerExample.createCriteria();</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtil.isNotNull(req.getMemberId()))&#123;</span><br><span class="line">        criteria.andMemberIdEqualTo(req.getMemberId());</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;查询页码：&#123;&#125;&quot;</span>,req.getPage());</span><br><span class="line">    LOG.info(<span class="string">&quot;每页条数：&#123;&#125;&quot;</span>,req.getSize());</span><br><span class="line"></span><br><span class="line">    PageHelper.startPage(req.getPage(), req.getSize());</span><br><span class="line">    List&lt;Passenger&gt; passengerList = passengerMapper.selectByExample(passengerExample);</span><br><span class="line">    PageInfo&lt;Passenger&gt; pageInfo = <span class="keyword">new</span> <span class="title class_">PageInfo</span>&lt;&gt;(passengerList);</span><br><span class="line">    LOG.info(<span class="string">&quot;总行数：&#123;&#125;&quot;</span>,pageInfo.getTotal());</span><br><span class="line">    LOG.info(<span class="string">&quot;总页数：&#123;&#125;&quot;</span>,pageInfo.getPages());</span><br><span class="line">    List&lt;PassengerQueryResp&gt; list = BeanUtil.copyToList(passengerList, PassengerQueryResp.class);</span><br><span class="line">    PageResp&lt;PassengerQueryResp&gt; pageResp = <span class="keyword">new</span> <span class="title class_">PageResp</span>&lt;&gt;();</span><br><span class="line">    pageResp.setTotal(pageInfo.getTotal());</span><br><span class="line">    pageResp.setList(list);</span><br><span class="line">    <span class="keyword">return</span> pageResp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改PassengerController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/query-list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;PageResp&lt;PassengerQueryResp&gt;&gt; <span class="title function_">queryList</span><span class="params">(<span class="meta">@Valid</span> PassengerQueryReq req)</span>&#123;</span><br><span class="line">    req.setMemberId(LoginMemberContext.getId());</span><br><span class="line">    PageResp&lt;PassengerQueryResp&gt; list = passengerService.queryList(req);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(list);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们可以看到返回的日期不大好看，我们可以定义日期的格式</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307111711651.png"
                      alt="image-20230711171139330"
                ></p>
<ul>
<li>我们把返回值提取成一个类，这时候就可以对他进行修改，我们修改PassengerQueryResp，格式化下日期字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonFormat(pattern = &quot;yyy-MM-dd HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JsonFormat(pattern = &quot;yyy-MM-dd HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Date updateTime;</span><br></pre></td></tr></table></figure>

<h2 id="乘车人列表查询界面开发"><a href="#乘车人列表查询界面开发" class="headerlink" title="乘车人列表查询界面开发"></a>乘车人列表查询界面开发</h2><blockquote>
<p>乘车人列表查询页面开发，引入表格组件（死数据）</p>
</blockquote>
<ul>
<li>首先我们先在template引入</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-table :dataSource=&quot;dataSource&quot; :columns=&quot;columns&quot; /&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们手动定义死数据</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dataSource = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">key</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;胡彦斌&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">32</span>,</span><br><span class="line">    <span class="attr">address</span>: <span class="string">&#x27;西湖区湖底公园1号&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">key</span>: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;胡彦祖&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">42</span>,</span><br><span class="line">    <span class="attr">address</span>: <span class="string">&#x27;西湖区湖底公园1号&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> columns =  [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">    <span class="attr">key</span>: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">&#x27;age&#x27;</span>,</span><br><span class="line">    <span class="attr">key</span>: <span class="string">&#x27;age&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;住址&#x27;</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">&#x27;address&#x27;</span>,</span><br><span class="line">    <span class="attr">key</span>: <span class="string">&#x27;address&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<ul>
<li>最后return回去</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  dataSource,</span><br><span class="line">  columns</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>乘车人列表查询页面开发，使用axios调用后端查询接口</p>
</blockquote>
<ul>
<li>首先修改template里的数据源</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-table :dataSource=&quot;passengers&quot; :columns=&quot;columns&quot; /&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>其次引入钩子函数（vue概念：生命周期函数，也叫钩子函数，用于在页面从打开到关闭的各个阶段，执行不同的动作。）</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; onMounted&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>因为之前是reactive声明，重新对乘客数组进行ref方式（对reactive声明的对象或数组重新赋值，会使其失去响应式特性，对对象里的属性赋值才能保持响应式特性。），并修改columns的字段</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">const</span> passengers = <span class="title function_">ref</span>([]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> columns =  [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">    <span class="attr">key</span>: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;身份证&#x27;</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">&#x27;idCard&#x27;</span>,</span><br><span class="line">    <span class="attr">key</span>: <span class="string">&#x27;idCard&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;类型&#x27;</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">&#x27;type&#x27;</span>,</span><br><span class="line">    <span class="attr">key</span>: <span class="string">&#x27;type&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<ul>
<li>最后调用axios方法，并在钩子函数中使用，页面渲染完就调用</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleQuery</span> =(<span class="params">param</span>) =&gt;&#123;</span><br><span class="line">  axios.<span class="title function_">get</span>(<span class="string">&quot;/member/passenger/query-list&quot;</span>,&#123;</span><br><span class="line">    <span class="attr">params</span>:&#123;</span><br><span class="line">      <span class="attr">page</span>:param.<span class="property">page</span>,</span><br><span class="line">      <span class="attr">size</span>:param.<span class="property">size</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data =response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">      passengers.<span class="property">value</span> = data.<span class="property">content</span>.<span class="property">list</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">handleQuery</span>(&#123;</span><br><span class="line">    <span class="attr">page</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="attr">size</span>:<span class="number">2</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>最后将passengers返回</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  passengers</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>axios的get请求的参数固定放在params对象里</p>
<p>{</p>
<p>​    params: {</p>
<p>​    }</p>
<p>}</p>
</blockquote>
<ul>
<li>js三点运算符，用于展开数组或对象</li>
</ul>
<blockquote>
<p>乘车人列表查询页面开发，显示分页页码</p>
</blockquote>
<ul>
<li>还是在table哪个标签添加一个分页</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-table :dataSource=&quot;passengers&quot; :columns=&quot;columns&quot; :pagination=&quot;pagination&quot;/&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>紧接着定义分页的三个属性，都是固定的</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//分页的三个属性名是固定的</span></span><br><span class="line"><span class="keyword">const</span> pagination = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">  <span class="attr">total</span>:<span class="number">0</span>,</span><br><span class="line">  <span class="attr">current</span>:<span class="number">1</span>,</span><br><span class="line">  <span class="attr">pageSize</span>:<span class="number">2</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在handleQuery方法中，请求成功时添加</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pagination.<span class="property">total</span> = data.<span class="property">content</span>.<span class="property">total</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后将pagination返回</li>
</ul>
<blockquote>
<p>乘车人列表查询页面开发，增加表格分页点击事件</p>
</blockquote>
<ul>
<li>首先在table加一个改变事件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-table :dataSource=&quot;passengers&quot; :columns=&quot;columns&quot; :pagination=&quot;pagination&quot; @change=&quot;handleTableChange&quot;/&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后在handleQuery方法内，调用成功添加</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置分页控件的值</span></span><br><span class="line">pagination.<span class="property">current</span> = param.<span class="property">page</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>改变事件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleTableChange</span> = (<span class="params">pagination</span>)=&gt;&#123;</span><br><span class="line">  <span class="title function_">handleQuery</span>(&#123;</span><br><span class="line">    <span class="attr">page</span>:pagination.<span class="property">current</span>,</span><br><span class="line">    <span class="attr">size</span>:pagination.<span class="property">pageSize</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>把钩子函数的size页改成</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onMounted</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">handleQuery</span>(&#123;</span><br><span class="line">    <span class="attr">page</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="attr">size</span>:pagination.<span class="property">pageSize</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>最后把handleTableChange返回</li>
</ul>
<blockquote>
<p>乘车人列表查询页面开发，增加刷新按钮，查询第一页</p>
</blockquote>
<ul>
<li>新增一个刷新按钮</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-space&gt;</span><br><span class="line">  &lt;a-button type=&quot;primary&quot; @click=&quot;handleQuery()&quot;&gt;刷新&lt;/a-button&gt;</span><br><span class="line">  &lt;a-button type=&quot;primary&quot; @click=&quot;showModal&quot;&gt;新增&lt;/a-button&gt;</span><br><span class="line">&lt;/a-space&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>handleQuery方法里加一个判断</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!param)&#123;</span><br><span class="line">  param=&#123;</span><br><span class="line">    <span class="attr">page</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="attr">size</span>:pagination.<span class="property">pageSize</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后将handleQuery返回</li>
</ul>
<blockquote>
<p>乘车人列表查询页面开发，增加lading效果</p>
<p>前端常用设计：增加loading可以防止用户不断点击提交，高并发场景必备，有些还会故意延迟取消loading，不是后端返回了就取消loading，而是返回后，再过500毫秒再取消loading，这样可以进一步防止用户太快的提交。</p>
</blockquote>
<ul>
<li>在table处添加loading事件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-table :dataSource=&quot;passengers&quot; :columns=&quot;columns&quot; :pagination=&quot;pagination&quot; @change=&quot;handleTableChange&quot; :loading=&quot;loading&quot;/&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>声明一个loading</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> loading = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>在handleQuery开始时就设置一个</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loading.<span class="property">value</span> =<span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>在handleQuery返回参数时就设置一个</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loading.<span class="property">value</span>=<span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后将loading返回</li>
</ul>
<blockquote>
<p>乘车人列表查询页面开发，保存成功后刷新列表（做一个关联）</p>
</blockquote>
<ul>
<li>首先在PassengerService的queryList方法加一个按id排序</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passengerExample.setOrderByClause(<span class="string">&quot;id desc&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在前端处handleOk方法里，成功后就调用查询</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">handleQuery</span>(&#123;</span><br><span class="line">  <span class="attr">page</span>:pagination.<span class="property">current</span>,</span><br><span class="line">  <span class="attr">size</span>:pagination.<span class="property">pageSize</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="解决Long类型精度丢失的问题"><a href="#解决Long类型精度丢失的问题" class="headerlink" title="解决Long类型精度丢失的问题"></a>解决Long类型精度丢失的问题</h2><ul>
<li>不同的语言，虽然都有int long等类型，但他们的精度不太一样，在数据传递时需要特别注意精度丢失。</li>
<li>解决方法：将long传成string</li>
<li>我可以在全局加一个转化配置类，但是这样做不大好，因为他会把其他的字段都转化为string，所以这里可以单独给需要转化的字段加注解。比如修改PassengerQueryResp</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonSerialize(using = ToStringSerializer.class)</span></span><br><span class="line"><span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JsonSerialize(using = ToStringSerializer.class)</span></span><br><span class="line"><span class="keyword">private</span> Long memberId;</span><br></pre></td></tr></table></figure>

<h2 id="乘车人编辑接口开发"><a href="#乘车人编辑接口开发" class="headerlink" title="乘车人编辑接口开发"></a>乘车人编辑接口开发</h2><ul>
<li>我们就需要修改PassengerService的save方法，这里保存和修改都用一个接口，只需要加一个id判断即可</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(PassengerSaveReq req)</span>&#123;</span><br><span class="line">    <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">    <span class="type">Passenger</span> <span class="variable">passenger</span> <span class="operator">=</span> BeanUtil.copyProperties(req, Passenger.class);</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtil.isNull(passenger.getId()))&#123;</span><br><span class="line">        passenger.setMemberId(LoginMemberContext.getId());</span><br><span class="line">        passenger.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">        passenger.setCreateTime(now);</span><br><span class="line">        passenger.setUpdateTime(now);</span><br><span class="line">        passengerMapper.insert(passenger);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        passenger.setUpdateTime(now);</span><br><span class="line">        passengerMapper.updateByPrimaryKey(passenger);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="乘车人编辑界面开发"><a href="#乘车人编辑界面开发" class="headerlink" title="乘车人编辑界面开发"></a>乘车人编辑界面开发</h2><ul>
<li>我们首先给PassengerSaveReq加一个日期格式（在列表查询功能里，前端得到的日期值，其实是字符串。后端保存接口里，必须按这个格式转回日期）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonFormat(pattern = &quot;yyy-MM-dd HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JsonFormat(pattern = &quot;yyy-MM-dd HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Date updateTime;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>乘车人编辑界面开发，reactive改为ref，reactive需要再封装一层属性才能实现双向绑定</p>
</blockquote>
<ul>
<li>我们把新增方法改成onAdd，然后我们在table里面添加一列</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-button type=&quot;primary&quot; @click=&quot;onAdd&quot;&gt;新增&lt;/a-button&gt;</span><br><span class="line"></span><br><span class="line">&lt;a-table :dataSource=&quot;passengers&quot; :columns=&quot;columns&quot; :pagination=&quot;pagination&quot; @change=&quot;handleTableChange&quot; :loading=&quot;loading&quot;&gt;</span><br><span class="line">    &lt;template #bodyCell=&quot;&#123;column,record&#125;&quot;&gt;</span><br><span class="line">      &lt;template v-if=&quot;column.dataIndex === &#x27;operation&#x27;&quot;&gt;</span><br><span class="line">        &lt;a-space&gt;</span><br><span class="line">          &lt;a @click=&quot;onEdit(record)&quot;&gt;编辑&lt;/a&gt;</span><br><span class="line">        &lt;/a-space&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">  &lt;/a-table&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们把所有的reactive改为ref（对reactive声明的对象或数组重新赋值，会使其失去响应式特性，对对象里的属性赋值才能保持响应式特性。建议全部用ref，统一响应式变量的写法），原本的passenger都变成passenger.value，pagination也一样。</li>
<li>在columns添加操作</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;操作&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;operation&#x27;</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>添加编辑方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">onEdit</span> = (<span class="params">record</span>)=&gt;&#123;</span><br><span class="line">  passenger.<span class="property">value</span> =record;</span><br><span class="line">  visible.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再把onEdit返回</li>
</ul>
<blockquote>
<p>但是此时有一个问题就是没保存也会同步修改列表</p>
</blockquote>
<ul>
<li>我们首先再public的js软件包下引入常用的tool.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Tool</span> = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 空校验 null或&quot;&quot;都返回true</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">isEmpty</span>: <span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">typeof</span> obj === <span class="string">&#x27;string&#x27;</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> !obj || obj.<span class="title function_">replace</span>(<span class="regexp">/\s+/g</span>, <span class="string">&quot;&quot;</span>) === <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (!obj || <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj) === <span class="string">&quot;&#123;&#125;&quot;</span> || obj.<span class="property">length</span> === <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 非空校验</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">isNotEmpty</span>: <span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="title class_">Tool</span>.<span class="title function_">isEmpty</span>(obj);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 对象复制</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">obj</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">copy</span>: <span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isNotEmpty</span>(obj)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 使用递归将数组转为树形结构</span></span><br><span class="line"><span class="comment">   * 父ID属性为parent</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">array2Tree</span>: <span class="function">(<span class="params">array, parentId</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isEmpty</span>(array)) &#123;</span><br><span class="line">      <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> c = array[i];</span><br><span class="line">      <span class="comment">// console.log(Number(c.parent), Number(parentId));</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Number</span>(c.<span class="property">parent</span>) === <span class="title class_">Number</span>(parentId)) &#123;</span><br><span class="line">        result.<span class="title function_">push</span>(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 递归查看当前节点对应的子节点</span></span><br><span class="line">        <span class="keyword">const</span> children = <span class="title class_">Tool</span>.<span class="title function_">array2Tree</span>(array, c.<span class="property">id</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isNotEmpty</span>(children)) &#123;</span><br><span class="line">          c.<span class="property">children</span> = children;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 随机生成[len]长度的[radix]进制数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">len</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> radix 默认62</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">string</span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">uuid</span>: <span class="function">(<span class="params">len, radix = <span class="number">62</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> chars = <span class="string">&#x27;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&#x27;</span>.<span class="title function_">split</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> uuid = [];</span><br><span class="line">    radix = radix || chars.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">      uuid[i] = chars[<span class="number">0</span> | <span class="title class_">Math</span>.<span class="title function_">random</span>() * radix];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uuid.<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>引入就是在index.html</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;&lt;%= BASE_URL %&gt;js/tool.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>解决第一个问题是新增时，编辑界面那些数据都会出现在新增的模态框里，没办法实现新增，这时我们只需要加一行代码</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">onAdd</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">  passenger.<span class="property">value</span>=&#123;&#125;,</span><br><span class="line">  visible.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>第二个是编辑模态框总是和显示界面的所关联，还没有保存就显示已经修改的内容，这时因为record是直接赋值给passenger.value的，我们只需要他们俩不是直接关联的就行，先把对象转成String，在转成JSON就没关系了</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">onEdit</span> = (<span class="params">record</span>)=&gt;&#123;</span><br><span class="line">  passenger.<span class="property">value</span> =<span class="variable language_">window</span>.<span class="property">Tool</span>.<span class="title function_">copy</span>(record);</span><br><span class="line">  visible.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="乘车人删除接口开发"><a href="#乘车人删除接口开发" class="headerlink" title="乘车人删除接口开发"></a>乘车人删除接口开发</h2><ul>
<li>写一个service</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    passengerMapper.deleteByPrimaryKey(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>写一个controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping(&quot;/delete/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;Object&gt; <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">    passengerService.delete(id);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="乘车人删除功能开发"><a href="#乘车人删除功能开发" class="headerlink" title="乘车人删除功能开发"></a>乘车人删除功能开发</h2><ul>
<li>在编辑按钮上面添加删除按钮</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-popconfirm</span><br><span class="line">    title=&quot;删除后不可恢复，确认删除？&quot;</span><br><span class="line">    @confirm=&quot;onDelete(record)&quot;</span><br><span class="line">    ok-text=&quot;确认&quot; cancel-text=&quot;取消&quot;&gt;</span><br><span class="line">  &lt;a style=&quot;color: red&quot;&gt;删除&lt;/a&gt;</span><br><span class="line">&lt;/a-popconfirm&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加删除方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">onDelete</span> = (<span class="params">record</span>) =&gt; &#123;</span><br><span class="line">  axios.<span class="title function_">delete</span>(<span class="string">&quot;/member/passenger/delete/&quot;</span> + record.<span class="property">id</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> data = response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span><br><span class="line">      notification.<span class="title function_">success</span>(&#123;<span class="attr">description</span>: <span class="string">&quot;删除成功！&quot;</span>&#125;);</span><br><span class="line">      <span class="title function_">handleQuery</span>(&#123;</span><br><span class="line">        <span class="attr">page</span>: pagination.<span class="property">value</span>.<span class="property">current</span>,</span><br><span class="line">        <span class="attr">size</span>: pagination.<span class="property">value</span>.<span class="property">pageSize</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>: data.<span class="property">message</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>把onDelete返回回去</li>
</ul>
<h2 id="前端枚举展示的解决方案介绍"><a href="#前端枚举展示的解决方案介绍" class="headerlink" title="前端枚举展示的解决方案介绍"></a>前端枚举展示的解决方案介绍</h2><blockquote>
<p> 将下拉框的值提取成常量数组</p>
</blockquote>
<ul>
<li>旅客类型处使用循环</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-select-option v-for=&quot;item in PASSENGER_TYPE_ARRAY&quot; :key=&quot;item.key&quot; :value=&quot;item.key&quot;&gt;&#123;&#123; item.value &#125;&#125;&lt;/a-select-option&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>将下拉框的值提取成常量数组</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">PASSENGER_TYPE_ARRAY</span> = [&#123;<span class="attr">key</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;成人&quot;</span>&#125;,&#123;<span class="attr">key</span>:<span class="string">&quot;2&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;儿童&quot;</span>&#125;,&#123;<span class="attr">key</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;学生&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>

<ul>
<li>将PASSENGER_TYPE_ARRAY返回</li>
</ul>
<blockquote>
<p>解决表格中枚举字段的显示</p>
</blockquote>
<ul>
<li>在&lt; a-table&gt;目录中添加这段</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;template v-else-if=&quot;column.dataIndex === &#x27;type&#x27;&quot;&gt;</span><br><span class="line">  &lt;span v-for=&quot;item in PASSENGER_TYPE_ARRAY&quot; :key=&quot;item.key&quot;&gt;</span><br><span class="line">    &lt;span v-if=&quot;item.key === record.type&quot;&gt;</span><br><span class="line">        &#123;&#123;item.value&#125;&#125;</span><br><span class="line">    &lt;/span&gt;</span><br><span class="line">  &lt;/span&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>将枚举数组放入单独的文件中</p>
</blockquote>
<ul>
<li>将上面的枚举数组提取到assets&#x2F;js&#x2F;enums.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">PASSENGER_TYPE_ARRAY</span> = [&#123;<span class="attr">key</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;成人&quot;</span>&#125;,&#123;<span class="attr">key</span>:<span class="string">&quot;2&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;儿童&quot;</span>&#125;,&#123;<span class="attr">key</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">value</span>:<span class="string">&quot;学生&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>

<ul>
<li>需要在main.js中全局引用下</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./assets/js/enums&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在vue中导入枚举数组</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">PASSENGER_TYPE_ARRAY</span>  = <span class="variable language_">window</span>.<span class="property">PASSENGER_TYPE_ARRAY</span></span><br></pre></td></tr></table></figure>

<ul>
<li>最后加一个规则排除，在package.json</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;no-undef&quot;</span><span class="punctuation">:</span> <span class="string">&quot;off&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="自制前后端代码生成器提高开发效率"><a href="#自制前后端代码生成器提高开发效率" class="headerlink" title="自制前后端代码生成器提高开发效率"></a>自制前后端代码生成器提高开发效率</h1><p>本章将演示代码生成器的制作，学习模板引擎freemarker的使用。通过代码生成器可以快速生成dto、service、controller和vue界面代码，再配合上mybatis generator，可以快速完成单表的增删改查管理功能，极大的提高开发效率。另外，本章的知识也可应用于静态页面生成、导出复杂excel等涉及文件生成的场景。…</p>
<hr>
<h2 id="剖析代码生成器的底层原理"><a href="#剖析代码生成器的底层原理" class="headerlink" title="剖析代码生成器的底层原理"></a>剖析代码生成器的底层原理</h2><blockquote>
<p>生成器原理：使用模板框架freemarker，按照设置好的模板文件，生成java，vue文件</p>
</blockquote>
<blockquote>
<p>freemarker是老牌模板引擎，以前常用于页面开发，和thymeleaf类似，有需要批量生成格式固定的一类文件的需求，都可以使用freemarker来完成。</p>
<p>冷门知识点：excel可以另存为xml。<br> 复杂excel导出：可以先设计好复制excel，转成xml，用xml来制作模板，再生成excel</p>
</blockquote>
<ul>
<li>首先在generate引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.freemarker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后在generator模块下生成util软件包，建立工具类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.generator.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> freemarker.template.Configuration;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.DefaultObjectWrapper;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.Template;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.TemplateException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FreemarkerUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ftlPath</span> <span class="operator">=</span> <span class="string">&quot;generator/src/main/java/com/fzx/train/generator/ftl/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Template temp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读模板</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initConfig</span><span class="params">(String ftlName)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">cfg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(Configuration.VERSION_2_3_31);</span><br><span class="line">        cfg.setDirectoryForTemplateLoading(<span class="keyword">new</span> <span class="title class_">File</span>(ftlPath));</span><br><span class="line">        cfg.setObjectWrapper(<span class="keyword">new</span> <span class="title class_">DefaultObjectWrapper</span>(Configuration.VERSION_2_3_31));</span><br><span class="line">        temp = cfg.getTemplate(ftlName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据模板，生成文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">generator</span><span class="params">(String fileName, Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> IOException, TemplateException &#123;</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(fileName);</span><br><span class="line">        <span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(fw);</span><br><span class="line">        temp.process(map, bw);</span><br><span class="line">        bw.flush();</span><br><span class="line">        fw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="集成DOM4j读取xml"><a href="#集成DOM4j读取xml" class="headerlink" title="集成DOM4j读取xml"></a>集成DOM4j读取xml</h2><blockquote>
<p>集成dom4j，读取pom.xml，得到当前持久层的xml文件</p>
</blockquote>
<ul>
<li>首先在generator导入两个依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dom4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dom4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jaxen<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxen<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>我们持久层的生成器是写在pom.xml的自动生成器插件里，因为我们不同的库需要使用不同的文件生成所以在这里定义了几个，每次只能生效一个，要生成哪一个模块对应的表就开启对应的xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configurationFile</span>&gt;</span>src/main/resources/generator-config-member.xml<span class="tag">&lt;/<span class="name">configurationFile</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                    &lt;configurationFile&gt;src/main/resources/generator-config-business.xml&lt;/configurationFile&gt;--&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--&lt;configurationFile&gt;src/main/resources/generator-config-batch.xml&lt;/configurationFile&gt;--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">overwrite</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overwrite</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">verbose</span>&gt;</span>true<span class="tag">&lt;/<span class="name">verbose</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们创建一个ServerGenerator类，看看能不能得到generator-config-member.xml</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.generator.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Node;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">toPath</span> <span class="operator">=</span> <span class="string">&quot;generator\\src\\main\\java\\com\\fzx\\train\\generator\\&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">pomPath</span> <span class="operator">=</span> <span class="string">&quot;generator\\pom.xml&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">File</span>(toPath).mkdir();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">SAXReader</span> <span class="variable">saxReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>();</span><br><span class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;pom&quot;</span>,<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>);</span><br><span class="line">        saxReader.getDocumentFactory().setXPathNamespaceURIs(map);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> saxReader.read(pomPath);</span><br><span class="line">        <span class="comment">//使用XPath快速定位节点或属性（/从根目录下寻找，pom是xml命名空间，configurationFile是节点名，如果要找属性，则是@xxx）</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//pom:configurationFile&quot;</span>);</span><br><span class="line">        System.out.println(node.getText());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>集成dom4j，读取当前持久层的xml文件，得到表名和实体名</p>
</blockquote>
<ul>
<li>第二次我们读取generator-config-member.xml的table这个节点</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.generator.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.DocumentException;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Node;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">toPath</span> <span class="operator">=</span> <span class="string">&quot;generator\\src\\main\\java\\com\\fzx\\train\\generator\\&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">pomPath</span> <span class="operator">=</span> <span class="string">&quot;generator\\pom.xml&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">File</span>(toPath).mkdir();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">generatorPath</span> <span class="operator">=</span> getGeneratorPath();</span><br><span class="line"></span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>().read(<span class="string">&quot;generator/&quot;</span> + generatorPath);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">table</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//table&quot;</span>);</span><br><span class="line">        System.out.println(table);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">tableName</span> <span class="operator">=</span> table.selectSingleNode(<span class="string">&quot;@tableName&quot;</span>);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">domainObjectName</span> <span class="operator">=</span> table.selectSingleNode(<span class="string">&quot;@domainObjectName&quot;</span>);</span><br><span class="line">        System.out.println(tableName.getText()+<span class="string">&quot;/&quot;</span>+domainObjectName.getText());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getGeneratorPath</span><span class="params">()</span> <span class="keyword">throws</span> DocumentException &#123;</span><br><span class="line">        <span class="type">SAXReader</span> <span class="variable">saxReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>();</span><br><span class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;pom&quot;</span>,<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>);</span><br><span class="line">        saxReader.getDocumentFactory().setXPathNamespaceURIs(map);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> saxReader.read(pomPath);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//pom:configurationFile&quot;</span>);</span><br><span class="line">        System.out.println(node.getText());</span><br><span class="line">        <span class="keyword">return</span> node.getText();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="详解Service生成器"><a href="#详解Service生成器" class="headerlink" title="详解Service生成器"></a>详解Service生成器</h2><ul>
<li>我们首先建立一个service的模板叫service.ftl放到com.fzx.train.generator.ftl，就是把PassengerService的内容全部复制过来，将他一些独有的东西替换成共同的</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">package com.fzx.train.member.service;</span><br><span class="line"></span><br><span class="line">import cn.hutool.core.bean.BeanUtil;</span><br><span class="line">import cn.hutool.core.date.DateTime;</span><br><span class="line">import cn.hutool.core.util.ObjectUtil;</span><br><span class="line">import com.fzx.train.common.context.LoginMemberContext;</span><br><span class="line">import com.fzx.train.common.resp.PageResp;</span><br><span class="line">import com.fzx.train.common.util.SnowUtil;</span><br><span class="line">import com.fzx.train.member.domain.$&#123;Domain&#125;;</span><br><span class="line">import com.fzx.train.member.domain.$&#123;Domain&#125;Example;</span><br><span class="line">import com.fzx.train.member.mapper.$&#123;Domain&#125;Mapper;</span><br><span class="line">import com.fzx.train.member.req.$&#123;Domain&#125;QueryReq;</span><br><span class="line">import com.fzx.train.member.req.$&#123;Domain&#125;SaveReq;</span><br><span class="line">import com.fzx.train.member.resp.$&#123;Domain&#125;QueryResp;</span><br><span class="line">import com.github.pagehelper.PageHelper;</span><br><span class="line">import com.github.pagehelper.PageInfo;</span><br><span class="line">import jakarta.annotation.Resource;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class $&#123;Domain&#125;Service &#123;</span><br><span class="line"></span><br><span class="line">    private static final Logger LOG = LoggerFactory.getLogger($&#123;Domain&#125;Service.class);</span><br><span class="line">    @Resource</span><br><span class="line">    private $&#123;Domain&#125;Mapper $&#123;domain&#125;Mapper;</span><br><span class="line"></span><br><span class="line">    public void save($&#123;Domain&#125;SaveReq req)&#123;</span><br><span class="line">        DateTime now = DateTime.now();</span><br><span class="line">        $&#123;Domain&#125; $&#123;domain&#125; = BeanUtil.copyProperties(req, $&#123;Domain&#125;.class);</span><br><span class="line">        if (ObjectUtil.isNull($&#123;domain&#125;.getId()))&#123;</span><br><span class="line">            $&#123;domain&#125;.setMemberId(LoginMemberContext.getId());</span><br><span class="line">            $&#123;domain&#125;.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">            $&#123;domain&#125;.setCreateTime(now);</span><br><span class="line">            $&#123;domain&#125;.setUpdateTime(now);</span><br><span class="line">            $&#123;domain&#125;Mapper.insert($&#123;domain&#125;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $&#123;domain&#125;.setUpdateTime(now);</span><br><span class="line">            $&#123;domain&#125;Mapper.updateByPrimaryKey($&#123;domain&#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public PageResp&lt;$&#123;Domain&#125;QueryResp&gt; queryList($&#123;Domain&#125;QueryReq req)&#123;</span><br><span class="line">        $&#123;Domain&#125;Example $&#123;domain&#125;Example = new $&#123;Domain&#125;Example();</span><br><span class="line">        $&#123;domain&#125;Example.setOrderByClause(&quot;id desc&quot;);</span><br><span class="line">        $&#123;Domain&#125;Example.Criteria criteria = $&#123;domain&#125;Example.createCriteria();</span><br><span class="line">        if (ObjectUtil.isNotNull(req.getMemberId()))&#123;</span><br><span class="line">            criteria.andMemberIdEqualTo(req.getMemberId());</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(&quot;查询页码：&#123;&#125;&quot;,req.getPage());</span><br><span class="line">        LOG.info(&quot;每页条数：&#123;&#125;&quot;,req.getSize());</span><br><span class="line"></span><br><span class="line">        PageHelper.startPage(req.getPage(), req.getSize());</span><br><span class="line">        List&lt;$&#123;Domain&#125;&gt; $&#123;domain&#125;List = $&#123;domain&#125;Mapper.selectByExample($&#123;domain&#125;Example);</span><br><span class="line">        PageInfo&lt;$&#123;Domain&#125;&gt; pageInfo = new PageInfo&lt;&gt;($&#123;domain&#125;List);</span><br><span class="line">        LOG.info(&quot;总行数：&#123;&#125;&quot;,pageInfo.getTotal());</span><br><span class="line">        LOG.info(&quot;总页数：&#123;&#125;&quot;,pageInfo.getPages());</span><br><span class="line">        List&lt;$&#123;Domain&#125;QueryResp&gt; list = BeanUtil.copyToList($&#123;domain&#125;List, $&#123;Domain&#125;QueryResp.class);</span><br><span class="line">        PageResp&lt;$&#123;Domain&#125;QueryResp&gt; pageResp = new PageResp&lt;&gt;();</span><br><span class="line">        pageResp.setTotal(pageInfo.getTotal());</span><br><span class="line">        pageResp.setList(list);</span><br><span class="line">        return pageResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void delete(Long id)&#123;</span><br><span class="line">        $&#123;domain&#125;Mapper.deleteByPrimaryKey(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后完善我们的Server生成器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.generator.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.generator.util.FreemarkerUtil;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.DocumentException;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Node;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">servicePath</span> <span class="operator">=</span> <span class="string">&quot;[module]/src/main/java/com/fzx/train/[module]/service/&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">pomPath</span> <span class="operator">=</span> <span class="string">&quot;generator\\pom.xml&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">File</span>(servicePath).mkdir();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//获取mybatis-generator</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">generatorPath</span> <span class="operator">=</span> getGeneratorPath();</span><br><span class="line">        <span class="comment">//比如generator-config-member.xml.得到module = member</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">module</span> <span class="operator">=</span> generatorPath.replace(<span class="string">&quot;src/main/resources/generator-config-&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;.xml&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;module:&quot;</span>+<span class="keyword">module</span>);</span><br><span class="line">        servicePath = servicePath.replace(<span class="string">&quot;[module]&quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;servicePath:&quot;</span> + servicePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取节点</span></span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>().read(<span class="string">&quot;generator/&quot;</span> + generatorPath);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">table</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//table&quot;</span>);</span><br><span class="line">        System.out.println(table);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">tableName</span> <span class="operator">=</span> table.selectSingleNode(<span class="string">&quot;@tableName&quot;</span>);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">domainObjectName</span> <span class="operator">=</span> table.selectSingleNode(<span class="string">&quot;@domainObjectName&quot;</span>);</span><br><span class="line">        System.out.println(tableName.getText()+<span class="string">&quot;/&quot;</span>+domainObjectName.getText());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//示例：表明fzx_test</span></span><br><span class="line">        <span class="comment">//Domain=FzxTest</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">Domain</span> <span class="operator">=</span> domainObjectName.getText();</span><br><span class="line">        <span class="comment">//domain=fzxTest</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">domain</span> <span class="operator">=</span> Domain.substring(<span class="number">0</span>,<span class="number">1</span>).toLowerCase() +Domain.substring(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//do_main = fzx-test</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">do_main</span> <span class="operator">=</span> tableName.getText().replaceAll(<span class="string">&quot;_&quot;</span>,<span class="string">&quot;-&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//组装参数</span></span><br><span class="line">        HashMap&lt;String, Object&gt; param = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        param.put(<span class="string">&quot;Domain&quot;</span>,Domain);</span><br><span class="line">        param.put(<span class="string">&quot;domain&quot;</span>,domain);</span><br><span class="line">        param.put(<span class="string">&quot;do_main&quot;</span>,do_main);</span><br><span class="line">        System.out.println(param);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始生成</span></span><br><span class="line">        FreemarkerUtil.initConfig(<span class="string">&quot;service.ftl&quot;</span>);</span><br><span class="line">        FreemarkerUtil.generator(servicePath+Domain+<span class="string">&quot;Service.java&quot;</span>,param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getGeneratorPath</span><span class="params">()</span> <span class="keyword">throws</span> DocumentException &#123;</span><br><span class="line">        <span class="type">SAXReader</span> <span class="variable">saxReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>();</span><br><span class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;pom&quot;</span>,<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>);</span><br><span class="line">        saxReader.getDocumentFactory().setXPathNamespaceURIs(map);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> saxReader.read(pomPath);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//pom:configurationFile&quot;</span>);</span><br><span class="line">        System.out.println(node.getText());</span><br><span class="line">        <span class="keyword">return</span> node.getText();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="详解Controller生成器"><a href="#详解Controller生成器" class="headerlink" title="详解Controller生成器"></a>详解Controller生成器</h2><ul>
<li>首先定义一个controller模板</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.fzx.train.member.controller;</span><br><span class="line"></span><br><span class="line">import com.fzx.train.common.context.LoginMemberContext;</span><br><span class="line">import com.fzx.train.common.resp.CommonResp;</span><br><span class="line">import com.fzx.train.common.resp.PageResp;</span><br><span class="line">import com.fzx.train.member.req.$&#123;Domain&#125;QueryReq;</span><br><span class="line">import com.fzx.train.member.req.$&#123;Domain&#125;SaveReq;</span><br><span class="line">import com.fzx.train.member.resp.$&#123;Domain&#125;QueryResp;</span><br><span class="line">import com.fzx.train.member.service.$&#123;Domain&#125;Service;</span><br><span class="line">import jakarta.annotation.Resource;</span><br><span class="line">import jakarta.validation.Valid;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/$&#123;do_main&#125;&quot;)</span><br><span class="line">public class $&#123;Domain&#125;Controller &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private $&#123;Domain&#125;Service $&#123;domain&#125;Service;</span><br><span class="line"></span><br><span class="line">    @PostMapping(&quot;/save&quot;)</span><br><span class="line">    public CommonResp&lt;Object&gt; save(@Valid @RequestBody $&#123;Domain&#125;SaveReq req)&#123;</span><br><span class="line">        $&#123;domain&#125;Service.save(req);</span><br><span class="line">        return new CommonResp&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/query-list&quot;)</span><br><span class="line">    public CommonResp&lt;PageResp&lt;$&#123;Domain&#125;QueryResp&gt;&gt; queryList(@Valid $&#123;Domain&#125;QueryReq req)&#123;</span><br><span class="line">        req.setMemberId(LoginMemberContext.getId());</span><br><span class="line">        PageResp&lt;$&#123;Domain&#125;QueryResp&gt; list = $&#123;domain&#125;Service.queryList(req);</span><br><span class="line">        return new CommonResp&lt;&gt;(list);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @DeleteMapping(&quot;/delete/&#123;id&#125;&quot;)</span><br><span class="line">    public CommonResp&lt;Object&gt; delete(@PathVariable Long id)&#123;</span><br><span class="line">        $&#123;domain&#125;Service.delete(id);</span><br><span class="line">        return new CommonResp&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在ServerGenerator中也生成controller，为什么不分着，因为一个地方改其他地方也都要改，我们只需要把生成部分提取成gen即可</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.generator.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.generator.util.FreemarkerUtil;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.TemplateException;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.DocumentException;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Node;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">servicePath</span> <span class="operator">=</span> <span class="string">&quot;[module]/src/main/java/com/fzx/train/[module]/&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">pomPath</span> <span class="operator">=</span> <span class="string">&quot;generator\\pom.xml&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">File</span>(servicePath).mkdir();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//获取mybatis-generator</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">generatorPath</span> <span class="operator">=</span> getGeneratorPath();</span><br><span class="line">        <span class="comment">//比如generator-config-member.xml.得到module = member</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">module</span> <span class="operator">=</span> generatorPath.replace(<span class="string">&quot;src/main/resources/generator-config-&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;.xml&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;module:&quot;</span>+<span class="keyword">module</span>);</span><br><span class="line">        servicePath = servicePath.replace(<span class="string">&quot;[module]&quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;servicePath:&quot;</span> + servicePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取节点</span></span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>().read(<span class="string">&quot;generator/&quot;</span> + generatorPath);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">table</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//table&quot;</span>);</span><br><span class="line">        System.out.println(table);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">tableName</span> <span class="operator">=</span> table.selectSingleNode(<span class="string">&quot;@tableName&quot;</span>);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">domainObjectName</span> <span class="operator">=</span> table.selectSingleNode(<span class="string">&quot;@domainObjectName&quot;</span>);</span><br><span class="line">        System.out.println(tableName.getText()+<span class="string">&quot;/&quot;</span>+domainObjectName.getText());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//示例：表明fzx_test</span></span><br><span class="line">        <span class="comment">//Domain=FzxTest</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">Domain</span> <span class="operator">=</span> domainObjectName.getText();</span><br><span class="line">        <span class="comment">//domain=fzxTest</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">domain</span> <span class="operator">=</span> Domain.substring(<span class="number">0</span>,<span class="number">1</span>).toLowerCase() +Domain.substring(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//do_main = fzx-test</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">do_main</span> <span class="operator">=</span> tableName.getText().replaceAll(<span class="string">&quot;_&quot;</span>,<span class="string">&quot;-&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//组装参数</span></span><br><span class="line">        HashMap&lt;String, Object&gt; param = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        param.put(<span class="string">&quot;Domain&quot;</span>,Domain);</span><br><span class="line">        param.put(<span class="string">&quot;domain&quot;</span>,domain);</span><br><span class="line">        param.put(<span class="string">&quot;do_main&quot;</span>,do_main);</span><br><span class="line">        System.out.println(param);</span><br><span class="line"></span><br><span class="line">        gen(Domain, param,<span class="string">&quot;service&quot;</span>);</span><br><span class="line">        gen(Domain, param,<span class="string">&quot;controller&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">gen</span><span class="params">(String Domain, HashMap&lt;String, Object&gt; param,String target)</span> <span class="keyword">throws</span> IOException, TemplateException &#123;</span><br><span class="line">        FreemarkerUtil.initConfig(target+<span class="string">&quot;.ftl&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">toPath</span> <span class="operator">=</span> servicePath+target+<span class="string">&quot;/&quot;</span>;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">File</span>(toPath).mkdirs();</span><br><span class="line">        <span class="type">String</span> <span class="variable">Target</span> <span class="operator">=</span> target.substring(<span class="number">0</span>,<span class="number">1</span>).toLowerCase() +target.substring(<span class="number">1</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> toPath + Domain +Target + <span class="string">&quot;.java&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;开始生成：&quot;</span>+ fileName);</span><br><span class="line">        FreemarkerUtil.generator(fileName,param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getGeneratorPath</span><span class="params">()</span> <span class="keyword">throws</span> DocumentException &#123;</span><br><span class="line">        <span class="type">SAXReader</span> <span class="variable">saxReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>();</span><br><span class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;pom&quot;</span>,<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>);</span><br><span class="line">        saxReader.getDocumentFactory().setXPathNamespaceURIs(map);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> saxReader.read(pomPath);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//pom:configurationFile&quot;</span>);</span><br><span class="line">        System.out.println(node.getText());</span><br><span class="line">        <span class="keyword">return</span> node.getText();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="制作DBUtil读取表字段信息"><a href="#制作DBUtil读取表字段信息" class="headerlink" title="制作DBUtil读取表字段信息"></a>制作DBUtil读取表字段信息</h2><ul>
<li>首先我们generator的pom.xml先引入两个依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>其次我们在generator的util软件包下引入两个文件，第一个就是每个字段都包括的信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.generator.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Field</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name; <span class="comment">// 字段名：course_id</span></span><br><span class="line">    <span class="keyword">private</span> String nameHump; <span class="comment">// 字段名小驼峰：courseId</span></span><br><span class="line">    <span class="keyword">private</span> String nameBigHump; <span class="comment">// 字段名大驼峰：CourseId</span></span><br><span class="line">    <span class="keyword">private</span> String nameCn; <span class="comment">// 中文名：课程</span></span><br><span class="line">    <span class="keyword">private</span> String type; <span class="comment">// 字段类型：char(8)</span></span><br><span class="line">    <span class="keyword">private</span> String javaType; <span class="comment">// java类型：String</span></span><br><span class="line">    <span class="keyword">private</span> String comment; <span class="comment">// 注释：课程|ID</span></span><br><span class="line">    <span class="keyword">private</span> Boolean nullAble; <span class="comment">// 是否可为空</span></span><br><span class="line">    <span class="keyword">private</span> Integer length; <span class="comment">// 字符串长度</span></span><br><span class="line">    <span class="keyword">private</span> Boolean enums; <span class="comment">// 是否是枚举</span></span><br><span class="line">    <span class="keyword">private</span> String enumsConst; <span class="comment">// 枚举常量 COURSE_LEVEL</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNameHump</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nameHump;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNameHump</span><span class="params">(String nameHump)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nameHump = nameHump;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNameBigHump</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nameBigHump;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNameBigHump</span><span class="params">(String nameBigHump)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nameBigHump = nameBigHump;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNameCn</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nameCn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNameCn</span><span class="params">(String nameCn)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nameCn = nameCn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setType</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getComment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> comment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setComment</span><span class="params">(String comment)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.comment = comment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getJavaType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> javaType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setJavaType</span><span class="params">(String javaType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.javaType = javaType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">getNullAble</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nullAble;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNullAble</span><span class="params">(Boolean nullAble)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nullAble = nullAble;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getLength</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLength</span><span class="params">(Integer length)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.length = length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">getEnums</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> enums;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnums</span><span class="params">(Boolean enums)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.enums = enums;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEnumsConst</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> enumsConst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnumsConst</span><span class="params">(String enumsConst)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.enumsConst = enumsConst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;Field&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;name=&#x27;&quot;</span>).append(name).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, nameHump=&#x27;&quot;</span>).append(nameHump).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, nameBigHump=&#x27;&quot;</span>).append(nameBigHump).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, nameCn=&#x27;&quot;</span>).append(nameCn).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, type=&#x27;&quot;</span>).append(type).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, javaType=&#x27;&quot;</span>).append(javaType).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, comment=&#x27;&quot;</span>).append(comment).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, nullAble=&quot;</span>).append(nullAble);</span><br><span class="line">        sb.append(<span class="string">&quot;, length=&quot;</span>).append(length);</span><br><span class="line">        sb.append(<span class="string">&quot;, enums=&quot;</span>).append(enums);</span><br><span class="line">        sb.append(<span class="string">&quot;, enumsConst=&#x27;&quot;</span>).append(enumsConst).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>其次引入获取各种字段信息的工具类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.generator.util;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DbUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> DbUtil.url;</span><br><span class="line">            <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> DbUtil.user;</span><br><span class="line">            <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> DbUtil.password;</span><br><span class="line">            conn = DriverManager.getConnection(url, user, password);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得表注释</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getTableComment</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> getConnection();</span><br><span class="line">        <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery(<span class="string">&quot;select table_comment from information_schema.tables Where table_name = &#x27;&quot;</span> + tableName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">tableNameCH</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (rs != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span>(rs.next()) &#123;</span><br><span class="line">                tableNameCH = rs.getString(<span class="string">&quot;table_comment&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        rs.close();</span><br><span class="line">        stmt.close();</span><br><span class="line">        conn.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;表名：&quot;</span> + tableNameCH);</span><br><span class="line">        <span class="keyword">return</span> tableNameCH;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得所有列信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Field&gt; <span class="title function_">getColumnByTableName</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;Field&gt; fieldList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> getConnection();</span><br><span class="line">        <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery(<span class="string">&quot;show full columns from `&quot;</span> + tableName + <span class="string">&quot;`&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (rs != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span>(rs.next()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">columnName</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;Field&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;Type&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">comment</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;Comment&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">nullAble</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;Null&quot;</span>); <span class="comment">//YES NO</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Field</span>();</span><br><span class="line">                field.setName(columnName);</span><br><span class="line">                field.setNameHump(lineToHump(columnName));</span><br><span class="line">                field.setNameBigHump(lineToBigHump(columnName));</span><br><span class="line">                field.setType(type);</span><br><span class="line">                field.setJavaType(DbUtil.sqlTypeToJavaType(rs.getString(<span class="string">&quot;Type&quot;</span>)));</span><br><span class="line">                field.setComment(comment);</span><br><span class="line">                <span class="keyword">if</span> (comment.contains(<span class="string">&quot;|&quot;</span>)) &#123;</span><br><span class="line">                    field.setNameCn(comment.substring(<span class="number">0</span>, comment.indexOf(<span class="string">&quot;|&quot;</span>)));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    field.setNameCn(comment);</span><br><span class="line">                &#125;</span><br><span class="line">                field.setNullAble(<span class="string">&quot;YES&quot;</span>.equals(nullAble));</span><br><span class="line">                <span class="keyword">if</span> (type.toUpperCase().contains(<span class="string">&quot;varchar&quot;</span>.toUpperCase())) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">lengthStr</span> <span class="operator">=</span> type.substring(type.indexOf(<span class="string">&quot;(&quot;</span>) + <span class="number">1</span>, type.length() - <span class="number">1</span>);</span><br><span class="line">                    field.setLength(Integer.valueOf(lengthStr));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    field.setLength(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (comment.contains(<span class="string">&quot;枚举&quot;</span>)) &#123;</span><br><span class="line">                    field.setEnums(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 以课程等级为例：从注释中的“枚举[CourseLevelEnum]”，得到enumsConst = COURSE_LEVEL</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> comment.indexOf(<span class="string">&quot;[&quot;</span>);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> comment.indexOf(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">enumsName</span> <span class="operator">=</span> comment.substring(start + <span class="number">1</span>, end); <span class="comment">// CourseLevelEnum</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">enumsConst</span> <span class="operator">=</span> StrUtil.toUnderlineCase(enumsName)</span><br><span class="line">                            .toUpperCase().replace(<span class="string">&quot;_ENUM&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                    field.setEnumsConst(enumsConst);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    field.setEnums(<span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                fieldList.add(field);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        rs.close();</span><br><span class="line">        stmt.close();</span><br><span class="line">        conn.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;列信息：&quot;</span> + JSONUtil.toJsonPrettyStr(fieldList));</span><br><span class="line">        <span class="keyword">return</span> fieldList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下划线转小驼峰：member_id 转成 memberId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">lineToHump</span><span class="params">(String str)</span>&#123;</span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">linePattern</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;_(\\w)&quot;</span>);</span><br><span class="line">        str = str.toLowerCase();</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> linePattern.matcher(str);</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="keyword">while</span>(matcher.find())&#123;</span><br><span class="line">            matcher.appendReplacement(sb, matcher.group(<span class="number">1</span>).toUpperCase());</span><br><span class="line">        &#125;</span><br><span class="line">        matcher.appendTail(sb);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下划线转大驼峰：member_id 转成 MemberId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">lineToBigHump</span><span class="params">(String str)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> lineToHump(str);</span><br><span class="line">        <span class="keyword">return</span> s.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + s.substring(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据库类型转为Java类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sqlTypeToJavaType</span><span class="params">(String sqlType)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sqlType.toUpperCase().contains(<span class="string">&quot;varchar&quot;</span>.toUpperCase())</span><br><span class="line">                || sqlType.toUpperCase().contains(<span class="string">&quot;char&quot;</span>.toUpperCase())</span><br><span class="line">                || sqlType.toUpperCase().contains(<span class="string">&quot;text&quot;</span>.toUpperCase())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;String&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlType.toUpperCase().contains(<span class="string">&quot;datetime&quot;</span>.toUpperCase())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Date&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlType.toUpperCase().contains(<span class="string">&quot;time&quot;</span>.toUpperCase())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Date&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlType.toUpperCase().contains(<span class="string">&quot;date&quot;</span>.toUpperCase())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Date&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlType.toUpperCase().contains(<span class="string">&quot;bigint&quot;</span>.toUpperCase())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Long&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlType.toUpperCase().contains(<span class="string">&quot;int&quot;</span>.toUpperCase())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Integer&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlType.toUpperCase().contains(<span class="string">&quot;long&quot;</span>.toUpperCase())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Long&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlType.toUpperCase().contains(<span class="string">&quot;decimal&quot;</span>.toUpperCase())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;BigDecimal&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlType.toUpperCase().contains(<span class="string">&quot;boolean&quot;</span>.toUpperCase())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Boolean&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;String&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>其次我们在ServerGenerator做修改</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为DbUTIL设置数据源</span></span><br><span class="line"><span class="type">Node</span> <span class="variable">connectionURL</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//@connectionURL&quot;</span>);</span><br><span class="line"><span class="type">Node</span> <span class="variable">userId</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//@userId&quot;</span>);</span><br><span class="line"><span class="type">Node</span> <span class="variable">password</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//@password&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;url:&quot;</span>+ connectionURL.getText());</span><br><span class="line">System.out.println(<span class="string">&quot;userId:&quot;</span>+ userId.getText());</span><br><span class="line">System.out.println(<span class="string">&quot;password:&quot;</span>+ password.getText());</span><br><span class="line">DbUtil.url = connectionURL.getText();</span><br><span class="line">DbUtil.user = userId.getText();</span><br><span class="line">DbUtil.password = password.getText();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//表中文名</span></span><br><span class="line"><span class="type">String</span> <span class="variable">tableNameCn</span> <span class="operator">=</span> DbUtil.getTableComment(tableName.getText());</span><br><span class="line">List&lt;Field&gt; fieldList = DbUtil.getColumnByTableName(tableName.getText());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="详解实体类生成器"><a href="#详解实体类生成器" class="headerlink" title="详解实体类生成器"></a>详解实体类生成器</h2><ul>
<li>首先创建一个saveReq的模板</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">package com.fzx.train.member.req;</span><br><span class="line"></span><br><span class="line">&lt;#list typeSet as type&gt;</span><br><span class="line">&lt;#if type==&#x27;Date&#x27;&gt;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line">&lt;/#if&gt;</span><br><span class="line">&lt;#if type==&#x27;BigDecimal&#x27;&gt;</span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">&lt;/#if&gt;</span><br><span class="line">&lt;/#list&gt;</span><br><span class="line"></span><br><span class="line">import jakarta.validation.constraints.NotBlank;</span><br><span class="line">import jakarta.validation.constraints.NotNull;</span><br><span class="line"></span><br><span class="line">public class $&#123;Domain&#125;SaveReq &#123;</span><br><span class="line"></span><br><span class="line">    &lt;#list fieldList as field&gt;</span><br><span class="line">    /**</span><br><span class="line">     * $&#123;field.comment&#125;</span><br><span class="line">     */</span><br><span class="line">    &lt;#if field.javaType==&#x27;Date&#x27;&gt;</span><br><span class="line">        &lt;#if field.type==&#x27;time&#x27;&gt;</span><br><span class="line">    @JsonFormat(pattern = &quot;HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span><br><span class="line">        &lt;#elseif field.type==&#x27;date&#x27;&gt;</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd&quot;,timezone = &quot;GMT+8&quot;)</span><br><span class="line">        &lt;#else&gt;</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">    &lt;#if field.name!=&quot;id&quot; &amp;&amp; field.nameHump!=&quot;createdAt&quot; &amp;&amp; field.nameHump!=&quot;updatedAt&quot;&gt;</span><br><span class="line">        &lt;#if !field.nullAble&gt;</span><br><span class="line">            &lt;#if field.javaType==&#x27;String&#x27;&gt;</span><br><span class="line">    @NotBlank(message = &quot;【$&#123;field.nameCn&#125;】不能为空&quot;)</span><br><span class="line">            &lt;#else&gt;</span><br><span class="line">    @NotNull(message = &quot;【$&#123;field.nameCn&#125;】不能为空&quot;)</span><br><span class="line">            &lt;/#if&gt;</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">    private $&#123;field.javaType&#125; $&#123;field.nameHump&#125;;</span><br><span class="line"></span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line">    &lt;#list fieldList as field&gt;</span><br><span class="line">    public $&#123;field.javaType&#125; get$&#123;field.nameBigHump&#125;() &#123;</span><br><span class="line">        return $&#123;field.nameHump&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void set$&#123;field.nameBigHump&#125;($&#123;field.javaType&#125; $&#123;field.nameHump&#125;) &#123;</span><br><span class="line">        this.$&#123;field.nameHump&#125; = $&#123;field.nameHump&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        StringBuilder sb = new StringBuilder();</span><br><span class="line">        sb.append(getClass().getSimpleName());</span><br><span class="line">        sb.append(&quot; [&quot;);</span><br><span class="line">        sb.append(&quot;Hash = &quot;).append(hashCode());</span><br><span class="line">        &lt;#list fieldList as field&gt;</span><br><span class="line">        sb.append(&quot;, $&#123;field.nameHump&#125;=&quot;).append($&#123;field.nameHump&#125;);</span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line">        sb.append(&quot;]&quot;);</span><br><span class="line">        return sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在生成器里面新增方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有的Java类型，使用Set去重</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title function_">getJavaTypes</span><span class="params">(List&lt;Field&gt; fieldList)</span> &#123;</span><br><span class="line">        Set&lt;String&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fieldList.size(); i++) &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> fieldList.get(i);</span><br><span class="line">            set.add(field.getJavaType());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们使用这个方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;String&gt; typeSet = getJavaTypes(fieldList);</span><br></pre></td></tr></table></figure>

<ul>
<li>然后把实体类需要的参数设置进去</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">param.put(<span class="string">&quot;tableNameCn&quot;</span>,tableNameCn);</span><br><span class="line">param.put(<span class="string">&quot;fieldList&quot;</span>,fieldList);</span><br><span class="line">param.put(<span class="string">&quot;typeSet&quot;</span>,typeSet);</span><br></pre></td></tr></table></figure>

<ul>
<li>因为之前包名和类名是一致的，但是实体类他不一致，所以我们做下子修改，增加一个包名参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  gen(Domain, param,<span class="string">&quot;req&quot;</span>,<span class="string">&quot;saveReq&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">gen</span><span class="params">(String Domain, HashMap&lt;String, Object&gt; param,String packageName,String target)</span> <span class="keyword">throws</span> IOException, TemplateException &#123;</span><br><span class="line">    FreemarkerUtil.initConfig(target+<span class="string">&quot;.ftl&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">toPath</span> <span class="operator">=</span> serverPath+packageName+<span class="string">&quot;/&quot;</span>;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">File</span>(toPath).mkdirs();</span><br><span class="line">    <span class="type">String</span> <span class="variable">Target</span> <span class="operator">=</span> target.substring(<span class="number">0</span>,<span class="number">1</span>).toLowerCase() +target.substring(<span class="number">1</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> toPath + Domain +Target + <span class="string">&quot;.java&quot;</span>;</span><br><span class="line">    System.out.println(<span class="string">&quot;开始生成：&quot;</span>+ fileName);</span><br><span class="line">    FreemarkerUtil.generator(fileName,param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="按模块生成后端代码"><a href="#按模块生成后端代码" class="headerlink" title="按模块生成后端代码"></a>按模块生成后端代码</h2><ul>
<li>然后我们的模块也是需要动态修改的，因此我们在生成器参数里面put一下module</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">param.put(<span class="string">&quot;module&quot;</span>,<span class="keyword">module</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>替换完后，之前那三个模板都要替换成${module}</li>
<li>因为这是通用模板不应该跟其他东西有关系，所以我们修改下service.ftl，把跟member相关的都删除</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">package com.fzx.train.$&#123;module&#125;.service;</span><br><span class="line"></span><br><span class="line">import cn.hutool.core.bean.BeanUtil;</span><br><span class="line">import cn.hutool.core.date.DateTime;</span><br><span class="line">import cn.hutool.core.util.ObjectUtil;</span><br><span class="line">import com.fzx.train.common.resp.PageResp;</span><br><span class="line">import com.fzx.train.common.util.SnowUtil;</span><br><span class="line">import com.fzx.train.$&#123;module&#125;.domain.$&#123;Domain&#125;;</span><br><span class="line">import com.fzx.train.$&#123;module&#125;.domain.$&#123;Domain&#125;Example;</span><br><span class="line">import com.fzx.train.$&#123;module&#125;.mapper.$&#123;Domain&#125;Mapper;</span><br><span class="line">import com.fzx.train.$&#123;module&#125;.req.$&#123;Domain&#125;QueryReq;</span><br><span class="line">import com.fzx.train.$&#123;module&#125;.req.$&#123;Domain&#125;SaveReq;</span><br><span class="line">import com.fzx.train.$&#123;module&#125;.resp.$&#123;Domain&#125;QueryResp;</span><br><span class="line">import com.github.pagehelper.PageHelper;</span><br><span class="line">import com.github.pagehelper.PageInfo;</span><br><span class="line">import jakarta.annotation.Resource;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class $&#123;Domain&#125;Service &#123;</span><br><span class="line"></span><br><span class="line">    private static final Logger LOG = LoggerFactory.getLogger($&#123;Domain&#125;Service.class);</span><br><span class="line">    @Resource</span><br><span class="line">    private $&#123;Domain&#125;Mapper $&#123;domain&#125;Mapper;</span><br><span class="line"></span><br><span class="line">    public void save($&#123;Domain&#125;SaveReq req)&#123;</span><br><span class="line">        DateTime now = DateTime.now();</span><br><span class="line">        $&#123;Domain&#125; $&#123;domain&#125; = BeanUtil.copyProperties(req, $&#123;Domain&#125;.class);</span><br><span class="line">        if (ObjectUtil.isNull($&#123;domain&#125;.getId()))&#123;</span><br><span class="line">            $&#123;domain&#125;.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">            $&#123;domain&#125;.setCreateTime(now);</span><br><span class="line">            $&#123;domain&#125;.setUpdateTime(now);</span><br><span class="line">            $&#123;domain&#125;Mapper.insert($&#123;domain&#125;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $&#123;domain&#125;.setUpdateTime(now);</span><br><span class="line">            $&#123;domain&#125;Mapper.updateByPrimaryKey($&#123;domain&#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public PageResp&lt;$&#123;Domain&#125;QueryResp&gt; queryList($&#123;Domain&#125;QueryReq req)&#123;</span><br><span class="line">        $&#123;Domain&#125;Example $&#123;domain&#125;Example = new $&#123;Domain&#125;Example();</span><br><span class="line">        $&#123;domain&#125;Example.setOrderByClause(&quot;id desc&quot;);</span><br><span class="line">        $&#123;Domain&#125;Example.Criteria criteria = $&#123;domain&#125;Example.createCriteria();</span><br><span class="line"></span><br><span class="line">        LOG.info(&quot;查询页码：&#123;&#125;&quot;,req.getPage());</span><br><span class="line">        LOG.info(&quot;每页条数：&#123;&#125;&quot;,req.getSize());</span><br><span class="line"></span><br><span class="line">        PageHelper.startPage(req.getPage(), req.getSize());</span><br><span class="line">        List&lt;$&#123;Domain&#125;&gt; $&#123;domain&#125;List = $&#123;domain&#125;Mapper.selectByExample($&#123;domain&#125;Example);</span><br><span class="line">        PageInfo&lt;$&#123;Domain&#125;&gt; pageInfo = new PageInfo&lt;&gt;($&#123;domain&#125;List);</span><br><span class="line">        LOG.info(&quot;总行数：&#123;&#125;&quot;,pageInfo.getTotal());</span><br><span class="line">        LOG.info(&quot;总页数：&#123;&#125;&quot;,pageInfo.getPages());</span><br><span class="line">        List&lt;$&#123;Domain&#125;QueryResp&gt; list = BeanUtil.copyToList($&#123;domain&#125;List, $&#123;Domain&#125;QueryResp.class);</span><br><span class="line">        PageResp&lt;$&#123;Domain&#125;QueryResp&gt; pageResp = new PageResp&lt;&gt;();</span><br><span class="line">        pageResp.setTotal(pageInfo.getTotal());</span><br><span class="line">        pageResp.setList(list);</span><br><span class="line">        return pageResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void delete(Long id)&#123;</span><br><span class="line">        $&#123;domain&#125;Mapper.deleteByPrimaryKey(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>请求查询的请求应该开始啥都没有，所以模板如下</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package com.fzx.train.$&#123;module&#125;.req;</span><br><span class="line"></span><br><span class="line">import com.fzx.train.common.req.PageReq;</span><br><span class="line"></span><br><span class="line">public class $&#123;Domain&#125;QueryReq extends PageReq &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;$&#123;Domain&#125;QueryReq&#123;&quot; +</span><br><span class="line">                &quot;&#125; &quot; + super.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们生成queryResp.ftl模板</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">package com.fzx.train.$&#123;module&#125;.resp;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.databind.annotation.JsonSerialize;</span><br><span class="line">import com.fasterxml.jackson.databind.ser.std.ToStringSerializer;</span><br><span class="line">&lt;#list typeSet as type&gt;</span><br><span class="line">&lt;#if type==&#x27;Date&#x27;&gt;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line">&lt;/#if&gt;</span><br><span class="line">&lt;#if type==&#x27;BigDecimal&#x27;&gt;</span><br><span class="line">import java.math.BigDecimal;</span><br><span class="line">&lt;/#if&gt;</span><br><span class="line">&lt;/#list&gt;</span><br><span class="line"></span><br><span class="line">public class $&#123;Domain&#125;QueryResp &#123;</span><br><span class="line"></span><br><span class="line">    &lt;#list fieldList as field&gt;</span><br><span class="line">    /**</span><br><span class="line">     * $&#123;field.comment&#125;</span><br><span class="line">     */</span><br><span class="line">    &lt;#if field.javaType==&#x27;Date&#x27;&gt;</span><br><span class="line">        &lt;#if field.type==&#x27;time&#x27;&gt;</span><br><span class="line">    @JsonFormat(pattern = &quot;HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span><br><span class="line">        &lt;#elseif field.type==&#x27;date&#x27;&gt;</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd&quot;,timezone = &quot;GMT+8&quot;)</span><br><span class="line">        &lt;#else&gt;</span><br><span class="line">    @JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">    &lt;#if field.name==&#x27;id&#x27; || field.name?ends_with(&#x27;_id&#x27;)&gt;</span><br><span class="line">    @JsonSerialize(using= ToStringSerializer.class)</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">    private $&#123;field.javaType&#125; $&#123;field.nameHump&#125;;</span><br><span class="line"></span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line">    &lt;#list fieldList as field&gt;</span><br><span class="line">    public $&#123;field.javaType&#125; get$&#123;field.nameBigHump&#125;() &#123;</span><br><span class="line">        return $&#123;field.nameHump&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void set$&#123;field.nameBigHump&#125;($&#123;field.javaType&#125; $&#123;field.nameHump&#125;) &#123;</span><br><span class="line">        this.$&#123;field.nameHump&#125; = $&#123;field.nameHump&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        StringBuilder sb = new StringBuilder();</span><br><span class="line">        sb.append(getClass().getSimpleName());</span><br><span class="line">        sb.append(&quot; [&quot;);</span><br><span class="line">        sb.append(&quot;Hash = &quot;).append(hashCode());</span><br><span class="line">        &lt;#list fieldList as field&gt;</span><br><span class="line">        sb.append(&quot;, $&#123;field.nameHump&#125;=&quot;).append($&#123;field.nameHump&#125;);</span><br><span class="line">        &lt;/#list&gt;</span><br><span class="line">        sb.append(&quot;]&quot;);</span><br><span class="line">        return sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="详解vue界面生成器"><a href="#详解vue界面生成器" class="headerlink" title="详解vue界面生成器"></a>详解vue界面生成器</h2><ul>
<li>制作一个vue模板</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;p&gt;</span><br><span class="line">    &lt;a-space&gt;</span><br><span class="line">      &lt;a-button type=&quot;primary&quot; @click=&quot;handleQuery()&quot;&gt;刷新&lt;/a-button&gt;</span><br><span class="line">      &lt;#if !readOnly&gt;&lt;a-button type=&quot;primary&quot; @click=&quot;onAdd&quot;&gt;新增&lt;/a-button&gt;&lt;/#if&gt;</span><br><span class="line">    &lt;/a-space&gt;</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line">  &lt;a-table :dataSource=&quot;$&#123;domain&#125;s&quot;</span><br><span class="line">           :columns=&quot;columns&quot;</span><br><span class="line">           :pagination=&quot;pagination&quot;</span><br><span class="line">           @change=&quot;handleTableChange&quot;</span><br><span class="line">           :loading=&quot;loading&quot;&gt;</span><br><span class="line">    &lt;template #bodyCell=&quot;&#123; column, record &#125;&quot;&gt;</span><br><span class="line">      &lt;template v-if=&quot;column.dataIndex === &#x27;operation&#x27;&quot;&gt;</span><br><span class="line">        &lt;#if !readOnly&gt;</span><br><span class="line">        &lt;a-space&gt;</span><br><span class="line">          &lt;a-popconfirm</span><br><span class="line">              title=&quot;删除后不可恢复，确认删除?&quot;</span><br><span class="line">              @confirm=&quot;onDelete(record)&quot;</span><br><span class="line">              ok-text=&quot;确认&quot; cancel-text=&quot;取消&quot;&gt;</span><br><span class="line">            &lt;a style=&quot;color: red&quot;&gt;删除&lt;/a&gt;</span><br><span class="line">          &lt;/a-popconfirm&gt;</span><br><span class="line">          &lt;a @click=&quot;onEdit(record)&quot;&gt;编辑&lt;/a&gt;</span><br><span class="line">        &lt;/a-space&gt;</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;#list fieldList as field&gt;</span><br><span class="line">        &lt;#if field.enums&gt;</span><br><span class="line">      &lt;template v-else-if=&quot;column.dataIndex === &#x27;$&#123;field.nameHump&#125;&#x27;&quot;&gt;</span><br><span class="line">        &lt;span v-for=&quot;item in $&#123;field.enumsConst&#125;_ARRAY&quot; :key=&quot;item.code&quot;&gt;</span><br><span class="line">          &lt;span v-if=&quot;item.code === record.$&#123;field.nameHump&#125;&quot;&gt;</span><br><span class="line">            &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">          &lt;/span&gt;</span><br><span class="line">        &lt;/span&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">      &lt;/#list&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">  &lt;/a-table&gt;</span><br><span class="line">  &lt;#if !readOnly&gt;</span><br><span class="line">  &lt;a-modal v-model:visible=&quot;visible&quot; title=&quot;$&#123;tableNameCn&#125;&quot; @ok=&quot;handleOk&quot;</span><br><span class="line">           ok-text=&quot;确认&quot; cancel-text=&quot;取消&quot;&gt;</span><br><span class="line">    &lt;a-form :model=&quot;$&#123;domain&#125;&quot; :label-col=&quot;&#123;span: 4&#125;&quot; :wrapper-col=&quot;&#123; span: 20 &#125;&quot;&gt;</span><br><span class="line">      &lt;#list fieldList as field&gt;</span><br><span class="line">        &lt;#if field.name!=&quot;id&quot; &amp;&amp; field.nameHump!=&quot;createTime&quot; &amp;&amp; field.nameHump!=&quot;updateTime&quot;&gt;</span><br><span class="line">      &lt;a-form-item label=&quot;$&#123;field.nameCn&#125;&quot;&gt;</span><br><span class="line">        &lt;#if field.enums&gt;</span><br><span class="line">        &lt;a-select v-model:value=&quot;$&#123;domain&#125;.$&#123;field.nameHump&#125;&quot;&gt;</span><br><span class="line">          &lt;a-select-option v-for=&quot;item in $&#123;field.enumsConst&#125;_ARRAY&quot; :key=&quot;item.code&quot; :value=&quot;item.code&quot;&gt;</span><br><span class="line">            &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">          &lt;/a-select-option&gt;</span><br><span class="line">        &lt;/a-select&gt;</span><br><span class="line">        &lt;#elseif field.javaType==&#x27;Date&#x27;&gt;</span><br><span class="line">          &lt;#if field.type==&#x27;time&#x27;&gt;</span><br><span class="line">        &lt;a-time-picker v-model:value=&quot;$&#123;domain&#125;.$&#123;field.nameHump&#125;&quot; valueFormat=&quot;HH:mm:ss&quot; placeholder=&quot;请选择时间&quot; /&gt;</span><br><span class="line">          &lt;#elseif field.type==&#x27;date&#x27;&gt;</span><br><span class="line">        &lt;a-date-picker v-model:value=&quot;$&#123;domain&#125;.$&#123;field.nameHump&#125;&quot; valueFormat=&quot;YYYY-MM-DD&quot; placeholder=&quot;请选择日期&quot; /&gt;</span><br><span class="line">          &lt;#else&gt;</span><br><span class="line">        &lt;a-date-picker v-model:value=&quot;$&#123;domain&#125;.$&#123;field.nameHump&#125;&quot; valueFormat=&quot;YYYY-MM-DD HH:mm:ss&quot; show-time placeholder=&quot;请选择日期&quot; /&gt;</span><br><span class="line">          &lt;/#if&gt;</span><br><span class="line">        &lt;#else&gt;</span><br><span class="line">        &lt;a-input v-model:value=&quot;$&#123;domain&#125;.$&#123;field.nameHump&#125;&quot; /&gt;</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line">        &lt;/#if&gt;</span><br><span class="line">      &lt;/#list&gt;</span><br><span class="line">    &lt;/a-form&gt;</span><br><span class="line">  &lt;/a-modal&gt;</span><br><span class="line">  &lt;/#if&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; defineComponent, ref, onMounted &#125; from &#x27;vue&#x27;;</span><br><span class="line">import &#123;notification&#125; from &quot;ant-design-vue&quot;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;$&#123;do_main&#125;-view&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    &lt;#list fieldList as field&gt;</span><br><span class="line">    &lt;#if field.enums&gt;</span><br><span class="line">    const $&#123;field.enumsConst&#125;_ARRAY = window.$&#123;field.enumsConst&#125;_ARRAY;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line">    const visible = ref(false);</span><br><span class="line">    let $&#123;domain&#125; = ref(&#123;</span><br><span class="line">      &lt;#list fieldList as field&gt;</span><br><span class="line">      $&#123;field.nameHump&#125;: undefined,</span><br><span class="line">      &lt;/#list&gt;</span><br><span class="line">    &#125;);</span><br><span class="line">    const $&#123;domain&#125;s = ref([]);</span><br><span class="line">    // 分页的三个属性名是固定的</span><br><span class="line">    const pagination = ref(&#123;</span><br><span class="line">      total: 0,</span><br><span class="line">      current: 1,</span><br><span class="line">      pageSize: 10,</span><br><span class="line">    &#125;);</span><br><span class="line">    let loading = ref(false);</span><br><span class="line">    const columns = [</span><br><span class="line">    &lt;#list fieldList as field&gt;</span><br><span class="line">      &lt;#if field.name!=&quot;id&quot; &amp;&amp; field.nameHump!=&quot;createTime&quot; &amp;&amp; field.nameHump!=&quot;updateTime&quot;&gt;</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;$&#123;field.nameCn&#125;&#x27;,</span><br><span class="line">      dataIndex: &#x27;$&#123;field.nameHump&#125;&#x27;,</span><br><span class="line">      key: &#x27;$&#123;field.nameHump&#125;&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">      &lt;/#if&gt;</span><br><span class="line">    &lt;/#list&gt;</span><br><span class="line">    &lt;#if !readOnly&gt;</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;操作&#x27;,</span><br><span class="line">      dataIndex: &#x27;operation&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    &lt;#if !readOnly&gt;</span><br><span class="line">    const onAdd = () =&gt; &#123;</span><br><span class="line">      $&#123;domain&#125;.value = &#123;&#125;;</span><br><span class="line">      visible.value = true;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const onEdit = (record) =&gt; &#123;</span><br><span class="line">      $&#123;domain&#125;.value = window.Tool.copy(record);</span><br><span class="line">      visible.value = true;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const onDelete = (record) =&gt; &#123;</span><br><span class="line">      axios.delete(&quot;/$&#123;module&#125;/admin/$&#123;do_main&#125;/delete/&quot; + record.id).then((response) =&gt; &#123;</span><br><span class="line">        const data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          notification.success(&#123;description: &quot;删除成功！&quot;&#125;);</span><br><span class="line">          handleQuery(&#123;</span><br><span class="line">            page: pagination.value.current,</span><br><span class="line">            size: pagination.value.pageSize,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleOk = () =&gt; &#123;</span><br><span class="line">      axios.post(&quot;/$&#123;module&#125;/admin/$&#123;do_main&#125;/save&quot;, $&#123;domain&#125;.value).then((response) =&gt; &#123;</span><br><span class="line">        let data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          notification.success(&#123;description: &quot;保存成功！&quot;&#125;);</span><br><span class="line">          visible.value = false;</span><br><span class="line">          handleQuery(&#123;</span><br><span class="line">            page: pagination.value.current,</span><br><span class="line">            size: pagination.value.pageSize</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line"></span><br><span class="line">    const handleQuery = (param) =&gt; &#123;</span><br><span class="line">      if (!param) &#123;</span><br><span class="line">        param = &#123;</span><br><span class="line">          page: 1,</span><br><span class="line">          size: pagination.value.pageSize</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      loading.value = true;</span><br><span class="line">      axios.get(&quot;/$&#123;module&#125;/admin/$&#123;do_main&#125;/query-list&quot;, &#123;</span><br><span class="line">        params: &#123;</span><br><span class="line">          page: param.page,</span><br><span class="line">          size: param.size</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then((response) =&gt; &#123;</span><br><span class="line">        loading.value = false;</span><br><span class="line">        let data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          $&#123;domain&#125;s.value = data.content.list;</span><br><span class="line">          // 设置分页控件的值</span><br><span class="line">          pagination.value.current = param.page;</span><br><span class="line">          pagination.value.total = data.content.total;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleTableChange = (page) =&gt; &#123;</span><br><span class="line">      // console.log(&quot;看看自带的分页参数都有啥：&quot; + JSON.stringify(page));</span><br><span class="line">      pagination.value.pageSize = page.pageSize;</span><br><span class="line">      handleQuery(&#123;</span><br><span class="line">        page: page.current,</span><br><span class="line">        size: page.pageSize</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">      handleQuery(&#123;</span><br><span class="line">        page: 1,</span><br><span class="line">        size: pagination.value.pageSize</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      &lt;#list fieldList as field&gt;</span><br><span class="line">      &lt;#if field.enums&gt;</span><br><span class="line">      $&#123;field.enumsConst&#125;_ARRAY,</span><br><span class="line">      &lt;/#if&gt;</span><br><span class="line">      &lt;/#list&gt;</span><br><span class="line">      $&#123;domain&#125;,</span><br><span class="line">      visible,</span><br><span class="line">      $&#123;domain&#125;s,</span><br><span class="line">      pagination,</span><br><span class="line">      columns,</span><br><span class="line">      handleTableChange,</span><br><span class="line">      handleQuery,</span><br><span class="line">      loading,</span><br><span class="line">      &lt;#if !readOnly&gt;</span><br><span class="line">      onAdd,</span><br><span class="line">      handleOk,</span><br><span class="line">      onEdit,</span><br><span class="line">      onDelete</span><br><span class="line">      &lt;/#if&gt;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>目前vue的路径是确定的，我们先给写死，在定义只读参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">readOnly</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="type">String</span> <span class="variable">vuePath</span> <span class="operator">=</span> <span class="string">&quot;web/src/view/main&quot;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>接着将只读参数设置进去</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">param.put(<span class="string">&quot;readOnly&quot;</span>,readOnly);</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在单独定义一个vue生成</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Vuegen</span><span class="params">(String do_main, HashMap&lt;String, Object&gt; param)</span> <span class="keyword">throws</span> IOException, TemplateException &#123;</span><br><span class="line">    FreemarkerUtil.initConfig(<span class="string">&quot;vue.ftl&quot;</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">File</span>(vuePath).mkdirs();</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> vuePath + do_main + <span class="string">&quot;.vue&quot;</span>;</span><br><span class="line">    System.out.println(<span class="string">&quot;开始生成：&quot;</span>+ fileName);</span><br><span class="line">    FreemarkerUtil.generator(fileName,param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vuegen(do_main,param);</span><br></pre></td></tr></table></figure>

<ul>
<li>完整版如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.generator.gen;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.generator.util.DbUtil;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.generator.util.Field;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.generator.util.FreemarkerUtil;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.TemplateException;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.DocumentException;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Node;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">readOnly</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">vuePath</span> <span class="operator">=</span> <span class="string">&quot;admin/src/view/main&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">serverPath</span> <span class="operator">=</span> <span class="string">&quot;[module]/src/main/java/com/fzx/train/[module]/&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">pomPath</span> <span class="operator">=</span> <span class="string">&quot;generator\\pom.xml&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">module</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">// static &#123;</span></span><br><span class="line">    <span class="comment">//     new File(serverPath).mkdirs();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取mybatis-generator</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">generatorPath</span> <span class="operator">=</span> getGeneratorPath();</span><br><span class="line">        <span class="comment">// 比如generator-config-member.xml，得到module = member</span></span><br><span class="line">        <span class="keyword">module</span> = generatorPath.replace(<span class="string">&quot;src/main/resources/generator-config-&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;.xml&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;module: &quot;</span> + <span class="keyword">module</span>);</span><br><span class="line">        serverPath = serverPath.replace(<span class="string">&quot;[module]&quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">File</span>(serverPath).mkdirs();</span><br><span class="line">        System.out.println(<span class="string">&quot;servicePath: &quot;</span> + serverPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取table节点</span></span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>().read(<span class="string">&quot;generator/&quot;</span> + generatorPath);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">table</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//table&quot;</span>);</span><br><span class="line">        System.out.println(table);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">tableName</span> <span class="operator">=</span> table.selectSingleNode(<span class="string">&quot;@tableName&quot;</span>);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">domainObjectName</span> <span class="operator">=</span> table.selectSingleNode(<span class="string">&quot;@domainObjectName&quot;</span>);</span><br><span class="line">        System.out.println(tableName.getText() + <span class="string">&quot;/&quot;</span> + domainObjectName.getText());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为DbUtil设置数据源</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">connectionURL</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//@connectionURL&quot;</span>);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">userId</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//@userId&quot;</span>);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">password</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//@password&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;url: &quot;</span> + connectionURL.getText());</span><br><span class="line">        System.out.println(<span class="string">&quot;user: &quot;</span> + userId.getText());</span><br><span class="line">        System.out.println(<span class="string">&quot;password: &quot;</span> + password.getText());</span><br><span class="line">        DbUtil.url = connectionURL.getText();</span><br><span class="line">        DbUtil.user = userId.getText();</span><br><span class="line">        DbUtil.password = password.getText();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//示例：表明fzx_test</span></span><br><span class="line">        <span class="comment">//Domain=FzxTest</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">Domain</span> <span class="operator">=</span> domainObjectName.getText();</span><br><span class="line">        <span class="comment">//domain=fzxTest</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">domain</span> <span class="operator">=</span> Domain.substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase() + Domain.substring(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//do_main = fzx-test</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">do_main</span> <span class="operator">=</span> tableName.getText().replaceAll(<span class="string">&quot;_&quot;</span>, <span class="string">&quot;-&quot;</span>);</span><br><span class="line">        <span class="comment">// 表中文名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tableNameCn</span> <span class="operator">=</span> DbUtil.getTableComment(tableName.getText());</span><br><span class="line">        List&lt;Field&gt; fieldList = DbUtil.getColumnByTableName(tableName.getText());</span><br><span class="line">        Set&lt;String&gt; typeSet = getJavaTypes(fieldList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 组装参数</span></span><br><span class="line">        Map&lt;String, Object&gt; param = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        param.put(<span class="string">&quot;module&quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">        param.put(<span class="string">&quot;Domain&quot;</span>, Domain);</span><br><span class="line">        param.put(<span class="string">&quot;domain&quot;</span>, domain);</span><br><span class="line">        param.put(<span class="string">&quot;do_main&quot;</span>, do_main);</span><br><span class="line">        param.put(<span class="string">&quot;tableNameCn&quot;</span>, tableNameCn);</span><br><span class="line">        param.put(<span class="string">&quot;fieldList&quot;</span>, fieldList);</span><br><span class="line">        param.put(<span class="string">&quot;typeSet&quot;</span>, typeSet);</span><br><span class="line">        param.put(<span class="string">&quot;readOnly&quot;</span>, readOnly);</span><br><span class="line">        System.out.println(<span class="string">&quot;组装参数：&quot;</span> + param);</span><br><span class="line"></span><br><span class="line">        gen(Domain, param, <span class="string">&quot;service&quot;</span>, <span class="string">&quot;service&quot;</span>);</span><br><span class="line">        gen(Domain, param, <span class="string">&quot;controller&quot;</span>, <span class="string">&quot;controller&quot;</span>);</span><br><span class="line">        gen(Domain, param, <span class="string">&quot;req&quot;</span>, <span class="string">&quot;saveReq&quot;</span>);</span><br><span class="line">        gen(Domain, param, <span class="string">&quot;req&quot;</span>, <span class="string">&quot;queryReq&quot;</span>);</span><br><span class="line">        gen(Domain, param, <span class="string">&quot;resp&quot;</span>, <span class="string">&quot;queryResp&quot;</span>);</span><br><span class="line"></span><br><span class="line">        genVue(do_main, param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">gen</span><span class="params">(String Domain, Map&lt;String, Object&gt; param, String packageName, String target)</span> <span class="keyword">throws</span> IOException, TemplateException &#123;</span><br><span class="line">        FreemarkerUtil.initConfig(target + <span class="string">&quot;.ftl&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">toPath</span> <span class="operator">=</span> serverPath + packageName + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">File</span>(toPath).mkdirs();</span><br><span class="line">        <span class="type">String</span> <span class="variable">Target</span> <span class="operator">=</span> target.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + target.substring(<span class="number">1</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> toPath + Domain + Target + <span class="string">&quot;.java&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;开始生成：&quot;</span> + fileName);</span><br><span class="line">        FreemarkerUtil.generator(fileName, param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">genVue</span><span class="params">(String do_main, Map&lt;String, Object&gt; param)</span> <span class="keyword">throws</span> IOException, TemplateException &#123;</span><br><span class="line">        FreemarkerUtil.initConfig(<span class="string">&quot;vue.ftl&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">File</span>(vuePath + <span class="keyword">module</span>).mkdirs();</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> vuePath + <span class="keyword">module</span> + <span class="string">&quot;/&quot;</span> + do_main + <span class="string">&quot;.vue&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;开始生成：&quot;</span> + fileName);</span><br><span class="line">        FreemarkerUtil.generator(fileName, param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getGeneratorPath</span><span class="params">()</span> <span class="keyword">throws</span> DocumentException &#123;</span><br><span class="line">        <span class="type">SAXReader</span> <span class="variable">saxReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>();</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;pom&quot;</span>, <span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>);</span><br><span class="line">        saxReader.getDocumentFactory().setXPathNamespaceURIs(map);</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> saxReader.read(pomPath);</span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> document.selectSingleNode(<span class="string">&quot;//pom:configurationFile&quot;</span>);</span><br><span class="line">        System.out.println(node.getText());</span><br><span class="line">        <span class="keyword">return</span> node.getText();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有的Java类型，使用Set去重</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title function_">getJavaTypes</span><span class="params">(List&lt;Field&gt; fieldList)</span> &#123;</span><br><span class="line">        Set&lt;String&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fieldList.size(); i++) &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> fieldList.get(i);</span><br><span class="line">            set.add(field.getJavaType());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="详解前端枚举代码生成器"><a href="#详解前端枚举代码生成器" class="headerlink" title="详解前端枚举代码生成器"></a>详解前端枚举代码生成器</h2><blockquote>
<p>修改前端枚举，将key&#x2F;value改成code&#x2F;desc</p>
</blockquote>
<ul>
<li>修改enums.js里的和后端的PassengerTypeEnum字段保持一致</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">PASSENGER_TYPE</span> = &#123;<span class="attr">ADULT</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;成人&quot;</span>&#125;,<span class="attr">CHILD</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;2&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;儿童&quot;</span>&#125;,<span class="attr">STUDENT</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;学生&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">PASSENGER_TYPE_ARRAY</span> = [&#123;<span class="attr">code</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;成人&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;2&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;儿童&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;学生&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>这里这个也不需要模板，直接一个生成器</p>
</li>
<li><p>其次呢，PassengerTypeEnum是在member模块里的，所以需要在generator的pom里增加member依赖，才能使用这个类</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fzx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>member<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>我们引入枚举生成器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.generator.gen;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="comment">//import com.fzx.train.business.enums.ConfirmOrderStatusEnum;</span></span><br><span class="line"><span class="comment">//import com.fzx.train.business.enums.SeatColEnum;</span></span><br><span class="line"><span class="comment">//import com.fzx.train.business.enums.SeatTypeEnum;</span></span><br><span class="line"><span class="comment">//import com.fzx.train.business.enums.TrainTypeEnum;</span></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.enums.PassengerTypeEnum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnumGenerator</span> &#123;</span><br><span class="line">     <span class="keyword">static</span> <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;web/src/assets/js/enums.js&quot;</span>;</span><br><span class="line"><span class="comment">//    static String path = &quot;admin/src/assets/js/enums.js&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">bufferObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">bufferArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            toJson(PassengerTypeEnum.class, bufferObject, bufferArray);</span><br><span class="line"><span class="comment">//            toJson(TrainTypeEnum.class, bufferObject, bufferArray);</span></span><br><span class="line"><span class="comment">//            toJson(SeatTypeEnum.class, bufferObject, bufferArray);</span></span><br><span class="line"><span class="comment">//            toJson(SeatColEnum.class, bufferObject, bufferArray);</span></span><br><span class="line"><span class="comment">//            toJson(ConfirmOrderStatusEnum.class, bufferObject, bufferArray);</span></span><br><span class="line"></span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> bufferObject.append(<span class="string">&quot;\r\n&quot;</span>).append(bufferArray);</span><br><span class="line">            writeJs(buffer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;执行耗时:&quot;</span> + (end - begin) + <span class="string">&quot; 毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">toJson</span><span class="params">(Class clazz, StringBuffer bufferObject, StringBuffer bufferArray)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// enumConst：将YesNoEnum变成YES_NO</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">enumConst</span> <span class="operator">=</span> StrUtil.toUnderlineCase(clazz.getSimpleName())</span><br><span class="line">                .toUpperCase().replace(<span class="string">&quot;_ENUM&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        Object[] objects = clazz.getEnumConstants();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 排除枚举属性和$VALUES，只获取code desc等</span></span><br><span class="line">        List&lt;Field&gt; targetFields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        Field[] fields = clazz.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Modifier.isPrivate(field.getModifiers()) || <span class="string">&quot;$VALUES&quot;</span>.equals(field.getName())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            targetFields.add(field);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对象</span></span><br><span class="line">        bufferObject.append(enumConst).append(<span class="string">&quot;=&#123;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; objects.length; i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> objects[i];</span><br><span class="line">            bufferObject.append(name.invoke(obj)).append(<span class="string">&quot;:&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将一个枚举值转成JSON对象字符串</span></span><br><span class="line">            formatJsonObj(bufferObject, targetFields, clazz, obj);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i &lt; objects.length - <span class="number">1</span>) &#123;</span><br><span class="line">                bufferObject.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bufferObject.append(<span class="string">&quot;&#125;;\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成数组</span></span><br><span class="line">        bufferArray.append(enumConst).append(<span class="string">&quot;_ARRAY=[&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; objects.length; i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> objects[i];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将一个枚举值转成JSON对象字符串</span></span><br><span class="line">            formatJsonObj(bufferArray, targetFields, clazz, obj);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i &lt; objects.length - <span class="number">1</span>) &#123;</span><br><span class="line">                bufferArray.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bufferArray.append(<span class="string">&quot;];\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将一个枚举值转成JSON对象字符串</span></span><br><span class="line"><span class="comment">     * 比如：SeatColEnum.YDZ_A(&quot;A&quot;, &quot;A&quot;, &quot;1&quot;)</span></span><br><span class="line"><span class="comment">     * 转成：&#123;code:&quot;A&quot;,desc:&quot;A&quot;,type:&quot;1&quot;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">formatJsonObj</span><span class="params">(StringBuffer bufferObject, List&lt;Field&gt; targetFields, Class clazz, Object obj)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException &#123;</span><br><span class="line">        bufferObject.append(<span class="string">&quot;&#123;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; targetFields.size(); j++) &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> targetFields.get(j);</span><br><span class="line">            <span class="type">String</span> <span class="variable">fieldName</span> <span class="operator">=</span> field.getName();</span><br><span class="line">            <span class="type">String</span> <span class="variable">getMethod</span> <span class="operator">=</span> <span class="string">&quot;get&quot;</span> + fieldName.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + fieldName.substring(<span class="number">1</span>);</span><br><span class="line">            bufferObject.append(fieldName).append(<span class="string">&quot;:\&quot;&quot;</span>).append(clazz.getMethod(getMethod).invoke(obj)).append(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (j &lt; targetFields.size() - <span class="number">1</span>) &#123;</span><br><span class="line">                bufferObject.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bufferObject.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 写文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> stringBuffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">writeJs</span><span class="params">(StringBuffer stringBuffer)</span> &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            out = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(path);</span><br><span class="line">            <span class="type">OutputStreamWriter</span> <span class="variable">osw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(out, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(path);</span><br><span class="line">            osw.write(stringBuffer.toString());</span><br><span class="line">            osw.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                out.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这种代码生成器都是可以通用的，写其他项目直接复制就ok的</p>
</blockquote>
<h1 id="利用代码生成器快速实现火车基础数据的维护"><a href="#利用代码生成器快速实现火车基础数据的维护" class="headerlink" title="利用代码生成器快速实现火车基础数据的维护"></a>利用代码生成器快速实现火车基础数据的维护</h1><p>本章将带大家开发车次信息管理功能，以及车次、车厢筛选的相关接口的开发，完善车站、车厢管理、座位管理等界面的功能，利用代码生成器，可快速完成多张表的增删改查功能。</p>
<hr>
<h2 id="更换远程代码仓库"><a href="#更换远程代码仓库" class="headerlink" title="更换远程代码仓库"></a>更换远程代码仓库</h2><ul>
<li>查看：git remote -v</li>
<li>删除：git remote remove origin</li>
</ul>
<blockquote>
<p>只需要删除两者之间关联即可</p>
</blockquote>
<h2 id="项目中增加admin控台模块"><a href="#项目中增加admin控台模块" class="headerlink" title="项目中增加admin控台模块"></a>项目中增加admin控台模块</h2><blockquote>
<p>创建admin模块，所有代码都是从web复制的</p>
</blockquote>
<ul>
<li><p>后台管理不会有注册，一般由初始管理员分配</p>
</li>
<li><p>我们想生成一个admin控台模块，我们可以在根目录下新建一个admin目录，接着将web的里面内容复制过去，然后ctrl+shift+F查询web，将web改成admin，差不多三个左右吧</p>
</li>
</ul>
<blockquote>
<p>admin去掉登录页面，去掉member和登录相关的拦截，去掉乘车人页面</p>
</blockquote>
<ul>
<li>这就是把没用的都删除了</li>
</ul>
<blockquote>
<p>去掉没用的HelloWorld组件，修改logo区域</p>
</blockquote>
<ul>
<li>这里把web和admin里面的HelloWorld都删除，然后修改他们的the-header，将图标处改为</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;logo&quot;&gt;</span><br><span class="line">  &lt;router-link to=&quot;/welcome&quot; style=&quot;color: white&quot;&gt;</span><br><span class="line">    12306控台</span><br><span class="line">  &lt;/router-link&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>在都加一个样式，把main里面的主样式都删除</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">logo</span>&#123;</span><br><span class="line">  <span class="attr">float</span>: left;</span><br><span class="line">  <span class="attr">height</span>: 31px;</span><br><span class="line">  <span class="attr">width</span>: 150px;</span><br><span class="line">  <span class="attr">color</span>: white;</span><br><span class="line">  font-<span class="attr">size</span>: 20px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="项目中增加business业务模块"><a href="#项目中增加business业务模块" class="headerlink" title="项目中增加business业务模块"></a>项目中增加business业务模块</h2><ul>
<li><p>增加business模块，所有关于车次的维护、卖票功能都会放在这个模块里</p>
</li>
<li><p>首先引入一些依赖，就把member的依赖导进来进行了</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fzx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后导入启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.fzx.train.business.mapper&quot;)</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.fzx&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessApplication</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(BusinessApplication.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(BusinessApplication.class);</span><br><span class="line">        <span class="type">Environment</span> <span class="variable">env</span> <span class="operator">=</span> app.run(args).getEnvironment();</span><br><span class="line">        LOG.info(<span class="string">&quot;启动成功！！&quot;</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;测试地址: \thttp://127.0.0.1:&#123;&#125;&#123;&#125;/hello&quot;</span>, env.getProperty(<span class="string">&quot;server.port&quot;</span>), env.getProperty(<span class="string">&quot;server.servlet.context-path&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后导入配置类</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>= <span class="string">8002</span></span><br><span class="line"><span class="attr">server.servlet.context-path</span>=<span class="string">/business</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#数据库连接</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/train_business?serverTimezone=UTC</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">business</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">business</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#mybatis xml路径</span></span><br><span class="line"><span class="attr">mybatis.mapper-locations</span>=<span class="string">classpath:/mapper/**/*.xml</span></span><br><span class="line"><span class="attr">logging.level.com.fzx.train.member.mapper</span> =<span class="string">trace</span></span><br></pre></td></tr></table></figure>

<ul>
<li>导入日志类</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 修改一下路径--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;PATH&quot;</span> <span class="attr">value</span>=<span class="string">&quot;./log/business&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;Pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %highlight(%-5level) %blue(%-50logger&#123;50&#125;:%-4line) %thread %green(%-18X&#123;LOG_ID&#125;) %msg%n&lt;/Pattern&gt;--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>%d&#123;mm:ss.SSS&#125; %highlight(%-5level) %blue(%-30logger&#123;30&#125;:%-4line) %thread %green(%-18X&#123;LOG_ID&#125;) %msg%n<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;TRACE_FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;PATH&#125;/trace.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;PATH&#125;/trace.%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level %-50logger&#123;50&#125;:%-4line %green(%-18X&#123;LOG_ID&#125;) %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;ERROR_FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;PATH&#125;/error.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;PATH&#125;/error.%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level %-50logger&#123;50&#125;:%-4line %green(%-18X&#123;LOG_ID&#125;) %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;ERROR&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;ERROR_FILE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;TRACE&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;TRACE_FILE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>记得把common公共的端口配置去了</li>
<li>在gateway增加路由转发</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#路由转发，将/business/...的请求转发了business模块</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.routes[1].id</span>=<span class="string">business</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.routes[1].uri</span>=<span class="string">http://127.0.0.1:8002</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.routes[1].predicates[0]</span>=<span class="string">Path=/business/**</span></span><br></pre></td></tr></table></figure>

<h2 id="为business模块配置持久层生成器"><a href="#为business模块配置持久层生成器" class="headerlink" title="为business模块配置持久层生成器"></a>为business模块配置持久层生成器</h2><ul>
<li><p>有的微服务项目，项目之间共用一个数据库，有利于开发，会员和车票表可做关联，有利于数据库运维</p>
</li>
<li><p>有的微服务项目，项目之间用不同的数据库，有利于按需分配资源，且能做好隔离，就算抢票太多，把business搞挂了，也不会影响用户登录，使用其它功能</p>
</li>
<li><p>我们首先创建一个数据库，然后为数据库单独分配一个角色，由于使用的是SQLyog所以需要再cmd里面配置一下密码解密规则，然后我们正常连接数据库，修改代码生成器，里面的数据库配置啥的，同时xml里面的配置记得也改成使用business的代码生成器，然后代码生成器生成，但是会出现找不到member错误，原因如下：</p>
</li>
<li><p>generator依赖member，member依赖common，所以先编译common，再编译member，就可以执行generator了(先install下common，再install下member。都是再maven下install)</p>
</li>
</ul>
<h2 id="快速生成车站基础数据"><a href="#快速生成车站基础数据" class="headerlink" title="快速生成车站基础数据"></a>快速生成车站基础数据</h2><ul>
<li>创建车站数据库表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `station`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `station` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;站名&#x27;</span>,</span><br><span class="line">  `name_pinyin` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;站名拼音&#x27;</span>,</span><br><span class="line">  `name_py` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;站名拼音首字母&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  <span class="keyword">unique</span> key `name_unique` (`name`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;车站&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>然后mybatis-generator生成代码，自制的generator也生成代码</p>
</li>
<li><p>创建完成之后，我们给the-sider创建一个菜单</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-menu-item key=&quot;/station&quot;&gt;</span><br><span class="line">  &lt;router-link to=&quot;/station&quot;&gt;</span><br><span class="line">    &lt;user-outlined/&gt;&amp;nbsp;车站</span><br><span class="line">  &lt;/router-link&gt;</span><br><span class="line">&lt;/a-menu-item&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>接着添加一个路由</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  &#123;</span><br><span class="line">  <span class="attr">path</span>:<span class="string">&#x27;station&#x27;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/station.vue&#x27;</span>),</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>由于我们这没有登陆页面，也就没有token，所以现在进不去该页面</li>
<li>我们看了gateway里面的拦截器，发现他排除了不需要的拦截请求（&#x2F;admin），所以我们在StationController上添加</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/admin/station&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这时候我们要改下代码生成器，将controller单独分类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gen(Domain, param, <span class="string">&quot;controller/admin&quot;</span>, <span class="string">&quot;adminController&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>然后修改controller.ftl重命名为adminController.ftl，里面做相应的修改，比如</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/admin/$&#123;do_main&#125;&quot;)</span><br><span class="line">public class $&#123;Domain&#125;AdminController &#123;</span><br></pre></td></tr></table></figure>

<ul>
<li>其实一般生成的vue.ftl也得改，因为接口增加了</li>
</ul>
<h2 id="快速生成火车基础数据管理功能"><a href="#快速生成火车基础数据管理功能" class="headerlink" title="快速生成火车基础数据管理功能"></a>快速生成火车基础数据管理功能</h2><ul>
<li>新建一张数据库表，然后就开始各种生成器</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `train`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `train` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `type` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次类型|枚举[TrainTypeEnum]&#x27;</span>,</span><br><span class="line">  `<span class="keyword">start</span>` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;始发站&#x27;</span>,</span><br><span class="line">  `start_pinyin` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;始发站拼音&#x27;</span>,</span><br><span class="line">  `start_time` <span class="type">time</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;出发时间&#x27;</span>,</span><br><span class="line">  `<span class="keyword">end</span>` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;终点站&#x27;</span>,</span><br><span class="line">  `end_pinyin` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;终点站拼音&#x27;</span>,</span><br><span class="line">  `end_time` <span class="type">time</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;到站时间&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  <span class="keyword">unique</span> key `code_unique` (`code`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;车次&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后由于它是有枚举的，所以我们生成一个枚举类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">TrainTypeEnum</span> &#123;</span><br><span class="line">    G(<span class="string">&quot;G&quot;</span>,<span class="string">&quot;高铁&quot;</span>,<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;1.2&quot;</span>)),</span><br><span class="line">    D(<span class="string">&quot;D&quot;</span>,<span class="string">&quot;动车&quot;</span>,<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;1&quot;</span>)),</span><br><span class="line">    K(<span class="string">&quot;K&quot;</span>,<span class="string">&quot;快捷&quot;</span>,<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.8&quot;</span>)),</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 票价=里程*单价，不同类型的车，单价不一样，高铁就比动车贵，同时单价不固定不变的，是阶梯单价，比如100公里内是0.4元/公里，100公里到500公里是0.3元每公里</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal priceRate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getPriceRate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> priceRate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TrainTypeEnum(String code, String desc, BigDecimal priceRate) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">        <span class="built_in">this</span>.priceRate = priceRate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPriceRate</span><span class="params">(BigDecimal priceRate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.priceRate = priceRate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TrainTypeEnum(String code, String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDesc</span><span class="params">(String desc)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再生成器生成一个枚举就ok了，记得改菜单和路由</li>
</ul>
<h2 id="快速生成火车车站基础数据管理功能"><a href="#快速生成火车车站基础数据管理功能" class="headerlink" title="快速生成火车车站基础数据管理功能"></a>快速生成火车车站基础数据管理功能</h2><ul>
<li>我们在保存数据时，应该先查是否已存在，而不能认为反正有唯一键，不用查了，直接插入。唯一键是最后一道屏障，保证数据准备性。</li>
<li>创建数据库</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `train_station`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `train_station` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `train_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `index` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;站序&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;站名&#x27;</span>,</span><br><span class="line">  `name_pinyin` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;站名拼音&#x27;</span>,</span><br><span class="line">  `in_time` <span class="type">time</span> comment <span class="string">&#x27;进站时间&#x27;</span>,</span><br><span class="line">  `out_time` <span class="type">time</span> comment <span class="string">&#x27;出站时间&#x27;</span>,</span><br><span class="line">  `stop_time` <span class="type">time</span> comment <span class="string">&#x27;停站时长&#x27;</span>,</span><br><span class="line">  `km` <span class="type">decimal</span>(<span class="number">8</span>, <span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;里程（公里）|从上一站到本站的距离&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  <span class="keyword">unique</span> key `train_code_index_unique` (`train_code`, `index`),</span><br><span class="line">  <span class="keyword">unique</span> key `train_code_name_unique` (`train_code`, `name`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;火车车站&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们这次代码生成器不成功，只要打开maven然后install一下就行了</li>
<li>剩下步骤就不重复了</li>
</ul>
<h2 id="快速生成火车车厢基础数据管理功能"><a href="#快速生成火车车厢基础数据管理功能" class="headerlink" title="快速生成火车车厢基础数据管理功能"></a>快速生成火车车厢基础数据管理功能</h2><ul>
<li>创建数据库表</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drop table <span class="keyword">if</span> exists `train_carriage`;</span><br><span class="line">create table `train_carriage` (</span><br><span class="line">  `id` bigint not <span class="literal">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `train_code` varchar(<span class="number">20</span>) not <span class="literal">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `index` <span class="type">int</span> not <span class="literal">null</span> comment <span class="string">&#x27;厢号&#x27;</span>,</span><br><span class="line">  `seat_type` <span class="type">char</span>(<span class="number">1</span>) not <span class="literal">null</span> comment <span class="string">&#x27;座位类型|枚举[SeatTypeEnum]&#x27;</span>,</span><br><span class="line">  `seat_count` <span class="type">int</span> not <span class="literal">null</span> comment <span class="string">&#x27;座位数&#x27;</span>,</span><br><span class="line">  `row_count` <span class="type">int</span> not <span class="literal">null</span> comment <span class="string">&#x27;排数&#x27;</span>,</span><br><span class="line">  `col_count` <span class="type">int</span> not <span class="literal">null</span> comment <span class="string">&#x27;列数&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  unique key `train_code_index_unique` (`train_code`, `index`),</span><br><span class="line">  primary <span class="title function_">key</span> <span class="params">(`id`)</span></span><br><span class="line">) engine=innodb <span class="keyword">default</span> charset=utf8mb4 comment=<span class="string">&#x27;火车车厢&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建座位枚举</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.EnumSet;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">SeatTypeEnum</span> &#123;</span><br><span class="line">    YDZ(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;一等座&quot;</span>, <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.4&quot;</span>)),</span><br><span class="line">    EDZ(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;二等座&quot;</span>, <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.3&quot;</span>)),</span><br><span class="line">    RW(<span class="string">&quot;3&quot;</span>, <span class="string">&quot;软卧&quot;</span>, <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.6&quot;</span>)),</span><br><span class="line">    YW(<span class="string">&quot;4&quot;</span>, <span class="string">&quot;硬卧&quot;</span>, <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.5&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基础票价 N元/公里，0.4即为0.4元/公里</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">    SeatTypeEnum(String code, String desc, BigDecimal price) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">        <span class="built_in">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPrice</span><span class="params">(BigDecimal price)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;HashMap&lt;String,String&gt;&gt; <span class="title function_">getEnumList</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;HashMap&lt;String, String&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SeatTypeEnum anEnum : EnumSet.allOf(SeatTypeEnum.class)) &#123;</span><br><span class="line">            HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">&quot;code&quot;</span>,anEnum.code);</span><br><span class="line">            map.put(<span class="string">&quot;desc&quot;</span>,anEnum.desc);</span><br><span class="line">            list.add(map);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SeatTypeEnum <span class="title function_">getEnumByCode</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (SeatTypeEnum enums : SeatTypeEnum.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (enums.getCode().equalsIgnoreCase(code)) &#123;</span><br><span class="line">                <span class="keyword">return</span> enums;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="快速生成火车座位基础数据管理功能"><a href="#快速生成火车座位基础数据管理功能" class="headerlink" title="快速生成火车座位基础数据管理功能"></a>快速生成火车座位基础数据管理功能</h2><ul>
<li><p>column是mysql关键字，用关键字作列号，在正常使用mybatis时是没问题，mybatis会自动为关键字增加反引号，但是在使用分布式事务seata时会有问题，所以微服务项目还是避免用关键字</p>
</li>
<li><p>创建数据库表</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `train_seat`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `train_seat` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `train_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `carriage_index` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;厢序&#x27;</span>,</span><br><span class="line">  `<span class="type">row</span>` <span class="type">char</span>(<span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;排号|01, 02&#x27;</span>,</span><br><span class="line">  `col` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;列号|枚举[SeatColEnum]&#x27;</span>,</span><br><span class="line">  `seat_type` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;座位类型|枚举[SeatTypeEnum]&#x27;</span>,</span><br><span class="line">  `carriage_seat_index` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;同车厢座序&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;座位&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建枚举</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.EnumSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">SeatColEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    YDZ_A(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;1&quot;</span>),</span><br><span class="line">    YDZ_C(<span class="string">&quot;C&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;1&quot;</span>),</span><br><span class="line">    YDZ_D(<span class="string">&quot;D&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;1&quot;</span>),</span><br><span class="line">    YDZ_F(<span class="string">&quot;F&quot;</span>, <span class="string">&quot;F&quot;</span>, <span class="string">&quot;1&quot;</span>),</span><br><span class="line">    EDZ_A(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;2&quot;</span>),</span><br><span class="line">    EDZ_B(<span class="string">&quot;B&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;2&quot;</span>),</span><br><span class="line">    EDZ_C(<span class="string">&quot;C&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;2&quot;</span>),</span><br><span class="line">    EDZ_D(<span class="string">&quot;D&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;2&quot;</span>),</span><br><span class="line">    EDZ_F(<span class="string">&quot;F&quot;</span>, <span class="string">&quot;F&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对应SeatTypeEnum.code</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    SeatColEnum(String code, String desc, String type) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDesc</span><span class="params">(String desc)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setType</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据车箱的座位类型，筛选出所有的列，比如车箱类型是一等座，则筛选出columnList=&#123;ACDF&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;SeatColEnum&gt; <span class="title function_">getColsByType</span><span class="params">(String seatType)</span> &#123;</span><br><span class="line">        List&lt;SeatColEnum&gt; colList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        EnumSet&lt;SeatColEnum&gt; seatColEnums = EnumSet.allOf(SeatColEnum.class);</span><br><span class="line">        <span class="keyword">for</span> (SeatColEnum anEnum : seatColEnums) &#123;</span><br><span class="line">            <span class="keyword">if</span> (seatType.equals(anEnum.getType())) &#123;</span><br><span class="line">                colList.add(anEnum);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> colList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用pinyin-pro将汉字转成拼音"><a href="#使用pinyin-pro将汉字转成拼音" class="headerlink" title="使用pinyin-pro将汉字转成拼音"></a>使用pinyin-pro将汉字转成拼音</h2><ul>
<li>首先安装依赖</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install pinyin-pro</span><br></pre></td></tr></table></figure>

<ul>
<li><p>实现功能，再新增车站时自动显示拼音且不可编辑</p>
</li>
<li><p>我们修改station.vue，在里面添加一个watch方法</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(<span class="function">()=&gt;</span>station.<span class="property">value</span>.<span class="property">name</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isNotEmpty</span>(station.<span class="property">value</span>.<span class="property">name</span>))&#123;</span><br><span class="line">     station.<span class="property">value</span>.<span class="property">namePinyin</span> = <span class="title function_">pinyin</span>(station.<span class="property">value</span>.<span class="property">name</span>,&#123;<span class="attr">toneType</span>:<span class="string">&#x27;none&#x27;</span>&#125;).<span class="title function_">replaceAll</span>(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">     station.<span class="property">value</span>.<span class="property">namePy</span> = <span class="title function_">pinyin</span>(station.<span class="property">value</span>.<span class="property">name</span>,&#123;<span class="attr">pattern</span>:<span class="string">&#x27;first&#x27;</span> , <span class="attr">toneType</span>:<span class="string">&#x27;none&#x27;</span>&#125;).<span class="title function_">replaceAll</span>(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     station.<span class="property">value</span>.<span class="property">namePinyin</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">     station.<span class="property">value</span>.<span class="property">namePy</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>然后那两个改为不可编辑</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-form-item label=&quot;站名拼音&quot;&gt;</span><br><span class="line">  &lt;a-input v-model:value=&quot;station.namePinyin&quot; disabled/&gt;</span><br><span class="line">&lt;/a-form-item&gt;</span><br><span class="line">&lt;a-form-item label=&quot;站名拼音首字母&quot;&gt;</span><br><span class="line">  &lt;a-input v-model:value=&quot;station.namePy&quot;  disabled/&gt;</span><br><span class="line">&lt;/a-form-item&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>同样的再train.vue也做同类型修改，然后那两个改为不可编辑</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(<span class="function">()=&gt;</span>train.<span class="property">value</span>.<span class="property">start</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isNotEmpty</span>(train.<span class="property">value</span>.<span class="property">start</span>))&#123;</span><br><span class="line">    train.<span class="property">value</span>.<span class="property">startPinyin</span> = <span class="title function_">pinyin</span>(train.<span class="property">value</span>.<span class="property">start</span>,&#123;<span class="attr">toneType</span>:<span class="string">&#x27;none&#x27;</span>&#125;).<span class="title function_">replaceAll</span>(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    train.<span class="property">value</span>.<span class="property">startPinyin</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title function_">watch</span>(<span class="function">()=&gt;</span>train.<span class="property">value</span>.<span class="property">end</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isNotEmpty</span>(train.<span class="property">value</span>.<span class="property">end</span>))&#123;</span><br><span class="line">    train.<span class="property">value</span>.<span class="property">endPinyin</span> = <span class="title function_">pinyin</span>(train.<span class="property">value</span>.<span class="property">end</span>,&#123;<span class="attr">toneType</span>:<span class="string">&#x27;none&#x27;</span>&#125;).<span class="title function_">replaceAll</span>(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    train.<span class="property">value</span>.<span class="property">endPinyin</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>train-station也做同类型修改，然后那两个改为不可编辑</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(<span class="function">()=&gt;</span>trainStation.<span class="property">value</span>.<span class="property">name</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isNotEmpty</span>(trainStation.<span class="property">value</span>.<span class="property">name</span>))&#123;</span><br><span class="line">    trainStation.<span class="property">value</span>.<span class="property">namePinyin</span> = <span class="title function_">pinyin</span>(trainStation.<span class="property">value</span>.<span class="property">name</span>,&#123;<span class="attr">toneType</span>:<span class="string">&#x27;none&#x27;</span>&#125;).<span class="title function_">replaceAll</span>(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    trainStation.<span class="property">value</span>.<span class="property">namePinyin</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,&#123;<span class="attr">immediate</span>:<span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="车次表单增加车站下拉选择"><a href="#车次表单增加车站下拉选择" class="headerlink" title="车次表单增加车站下拉选择"></a>车次表单增加车站下拉选择</h2><ul>
<li>首先在TrainService增加一个方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;TrainQueryResp&gt; <span class="title function_">queryAll</span><span class="params">( )</span>&#123;</span><br><span class="line">    <span class="type">TrainExample</span> <span class="variable">trainExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainExample</span>();</span><br><span class="line">    trainExample.setOrderByClause(<span class="string">&quot;code asc&quot;</span>);</span><br><span class="line">    List&lt;Train&gt; trainList = trainMapper.selectByExample(trainExample);</span><br><span class="line">    <span class="keyword">return</span> BeanUtil.copyToList(trainList, TrainQueryResp.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>写对应接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/query-all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;List&lt;TrainQueryResp&gt;&gt; <span class="title function_">queryAll</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;TrainQueryResp&gt; list = trainService.queryAll();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再train-station.vue写入查询车次方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">queryTrainCode</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">  axios.<span class="title function_">get</span>(<span class="string">&quot;/business/admin/train/query-all&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>)=&gt;</span>&#123;</span><br><span class="line">    loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">content</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>在页面渲染成功就调用</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">handleQuery</span>(&#123;</span><br><span class="line">    <span class="attr">page</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">size</span>: pagination.<span class="property">value</span>.<span class="property">pageSize</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">queryTrainCode</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>train-station.vue前端增加车次选择下拉框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-form-item label=&quot;车次编号&quot;&gt;</span><br><span class="line">  &lt;a-select v-model:value=&quot;trainStation.trainCode&quot; show-search</span><br><span class="line">            :filter-option=&quot;filterTrainCodeOption&quot;&gt;</span><br><span class="line">    &lt;a-select-option v-for=&quot;item in trains&quot; :key=&quot;item.code&quot;  :value=&quot;item.code&quot; :lable=&quot;item.code +item.start+item.end&quot;&gt;</span><br><span class="line">      &#123;&#123;item.code&#125;&#125; | &#123;&#123;item.start&#125;&#125; ~ &#123;&#123;item.end&#125;&#125;</span><br><span class="line">    &lt;/a-select-option&gt;</span><br><span class="line">  &lt;/a-select&gt;</span><br><span class="line">&lt;/a-form-item&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加下拉框里的选项</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//车次下拉框</span></span><br><span class="line"><span class="keyword">const</span> trains = <span class="title function_">ref</span>([]);</span><br></pre></td></tr></table></figure>

<ul>
<li>queryTrainCode方法成功后设置该值</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trains.<span class="property">value</span> = data.<span class="property">content</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>筛选方法，如果原本有的的包括输入的关键字，那么就保留</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">filterTrainCodeOption</span> =(<span class="params">input,option</span>)=&gt;&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(input,option);</span><br><span class="line">  <span class="keyword">return</span> option.<span class="property">label</span>.<span class="title function_">toLowerCase</span>().<span class="title function_">indexOf</span>(input.<span class="title function_">toLowerCase</span>()) &gt;=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将filterTrainCodeOption, trains返回</li>
</ul>
<h2 id="制作车次下拉框组件"><a href="#制作车次下拉框组件" class="headerlink" title="制作车次下拉框组件"></a>制作车次下拉框组件</h2><ul>
<li>当一个功能在很多页面都要被用到时，可以考虑做成组件</li>
</ul>
<blockquote>
<p>制作车次下拉框组件</p>
</blockquote>
<ul>
<li><p>将车次编号通过modelValue传递到子组件，再在子组件中，通过watch为组件内的响应式变量trainCode赋值，从而让下拉框选择G2车次</p>
</li>
<li><p>有时候，父组件只知道子组件选择了G2还不够，还要知道整条train的信息，包括始发站终点站等，此时就可以通过change事件来拿到</p>
</li>
<li><p>将train-station.vue的下拉框提取出来成一个单独的train-select组件</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-select v-model:value=&quot;trainCode&quot; show-search allow-clear</span><br><span class="line">            :filter-option=&quot;filterTrainCodeOption&quot;</span><br><span class="line">            @change =&quot;onChange&quot; placeholder=&quot;请选择车次&quot;&gt;</span><br><span class="line">    &lt;a-select-option v-for=&quot;item in trains&quot; :key=&quot;item.code&quot;  :value=&quot;item.code&quot; :lable=&quot;item.code +item.start+item.end&quot;&gt;</span><br><span class="line">      &#123;&#123;item.code&#125;&#125; | &#123;&#123;item.start&#125;&#125; ~ &#123;&#123;item.end&#125;&#125;</span><br><span class="line">    &lt;/a-select-option&gt;</span><br><span class="line">  &lt;/a-select&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123;defineComponent,onMounted, watch,ref&#125; from &quot;vue&quot;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import &#123;notification&#125; from &quot;ant-design-vue&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;train-select-view&quot;,</span><br><span class="line">  //props区域用于定义父子组件参数传递的属性</span><br><span class="line">  props:[&quot;modelValue&quot;],</span><br><span class="line">  emits:[&#x27;update:modelValue&#x27;,&#x27;change&#x27;],</span><br><span class="line">  setup(props,&#123;emit&#125;)&#123;</span><br><span class="line">    const trainCode = ref();</span><br><span class="line">    const trains = ref([]);</span><br><span class="line"></span><br><span class="line">    //利用watch，动态获取父组件的值，如果放在onMounted或其它方法里，则只有第一次有效</span><br><span class="line">    watch(()=&gt;props.modelValue,()=&gt;&#123;</span><br><span class="line">      console.log(&quot;props.modelValue&quot;,props.modelValue);</span><br><span class="line">      trainCode.value = props.modelValue;</span><br><span class="line">    &#125;,&#123;immediate:true&#125;);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 查询所有的车次，用于车次下拉框</span><br><span class="line">     */</span><br><span class="line">    const queryAllTrain = () =&gt;&#123;</span><br><span class="line">      axios.get(&quot;/business/admin/train/query-all&quot;).then((response)=&gt;&#123;</span><br><span class="line">        let data = response.data;</span><br><span class="line">        if (data.success)&#123;</span><br><span class="line">          trains.value = data.content;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">          notification.error(&#123;description:data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const filterTrainCodeOption =(input,option)=&gt;&#123;</span><br><span class="line">      console.log(input,option);</span><br><span class="line">      return option.label.toLowerCase().indexOf(input.toLowerCase()) &gt;=0;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const onChange = (value) =&gt;&#123;</span><br><span class="line">      emit(&#x27;update:modelValue&#x27;,value);</span><br><span class="line">      let train = trains.value.filter(item =&gt;item.code == value)[0];</span><br><span class="line">      if (Tool.isEmpty(train))&#123;</span><br><span class="line">        train=&#123;&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      emit(&#x27;change&#x27;,train);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    onMounted(()=&gt;&#123;</span><br><span class="line">      queryAllTrain();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    return&#123;</span><br><span class="line">      trainCode,</span><br><span class="line">      trains,</span><br><span class="line">      filterTrainCodeOption,</span><br><span class="line">      onChange,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>train-station.vue这么写就行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-form-item label=&quot;车次编号&quot;&gt;</span><br><span class="line">  &lt;train-select-view v-model=&quot;trainStation.trainCode&quot;&gt;&lt;/train-select-view&gt;</span><br><span class="line">&lt;/a-form-item&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>制作车次下拉框组件，为组件增加自定义参数width</p>
</blockquote>
<ul>
<li>现在下拉框添加样式</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:style=&quot;&#x27;width: &#x27; + localWidth&quot;&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义父子组件参数的传递属性</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">props</span>:[<span class="string">&quot;modelValue&quot;</span>,<span class="string">&quot;width&quot;</span>],</span><br></pre></td></tr></table></figure>

<ul>
<li>定义一个本地值来接收父组件传过来的值</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> localWidth = <span class="title function_">ref</span>(props.<span class="property">width</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isEmpty</span>(props.<span class="property">width</span>)) &#123;</span><br><span class="line">  localWidth.<span class="property">value</span> = <span class="string">&quot;100%&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将这个值localWidth返回</li>
<li>使用的话就在train-station.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;train-select-view v-model=&quot;trainStation.trainCode&quot; width=&quot;50%&quot;&gt;&lt;/train-select-view&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>火车车厢页面的车次改为车次选择组件</p>
</blockquote>
<ul>
<li>就是把需要组件的页面，引入下拉框组件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;train-select-view v-model=&quot;trainSeat.trainCode&quot;&gt;&lt;/train-select-view&gt;</span><br></pre></td></tr></table></figure>

<h2 id="制作车站下拉框组件（Station）"><a href="#制作车站下拉框组件（Station）" class="headerlink" title="制作车站下拉框组件（Station）"></a>制作车站下拉框组件（Station）</h2><ul>
<li>一样先改service</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;StationQueryResp&gt; <span class="title function_">queryAll</span><span class="params">( )</span>&#123;</span><br><span class="line">    <span class="type">StationExample</span> <span class="variable">stationExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StationExample</span>();</span><br><span class="line">    stationExample.setOrderByClause(<span class="string">&quot;name_pinyin asc&quot;</span>);</span><br><span class="line">    List&lt;Station&gt; stationList = stationMapper.selectByExample(stationExample);</span><br><span class="line">    <span class="keyword">return</span> BeanUtil.copyToList(stationList, StationQueryResp.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/query-all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;List&lt;StationQueryResp&gt;&gt; <span class="title function_">queryAll</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;StationQueryResp&gt; list = stationService.queryAll();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>把组件train-select复制一份成station-select，将里面相关内容改成station的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-select v-model:value=<span class="string">&quot;name&quot;</span> show-search allow-clear</span><br><span class="line">            :filter-option=<span class="string">&quot;filterNameOption&quot;</span></span><br><span class="line">            <span class="meta">@change</span> =<span class="string">&quot;onChange&quot;</span> placeholder=<span class="string">&quot;请选择车站&quot;</span></span><br><span class="line">            :style=<span class="string">&quot;&#x27;width: &#x27; + localWidth&quot;</span>&gt;</span><br><span class="line">    &lt;a-select-option v-<span class="keyword">for</span>=<span class="string">&quot;item in stations&quot;</span> :key=<span class="string">&quot;item.name&quot;</span>  :value=<span class="string">&quot;item.name&quot;</span> :lable=<span class="string">&quot;item.name +item.namePinyin+item.namePy&quot;</span>&gt;</span><br><span class="line">      &#123;&#123;item.name&#125;&#125; | &#123;&#123;item.namePinyin&#125;&#125; ~ &#123;&#123;item.namePy&#125;&#125;</span><br><span class="line">    &lt;/a-select-option&gt;</span><br><span class="line">  &lt;/a-select&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;defineComponent,onMounted, watch,ref&#125; from <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> axios from <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;notification&#125; from <span class="string">&quot;ant-design-vue&quot;</span>;</span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> <span class="title function_">defineComponent</span><span class="params">(&#123;</span></span><br><span class="line"><span class="params">  name: <span class="string">&quot;station-select-view&quot;</span>,</span></span><br><span class="line"><span class="params">  //props区域用于定义父子组件参数传递的属性</span></span><br><span class="line"><span class="params">  props:[<span class="string">&quot;modelValue&quot;</span>,<span class="string">&quot;width&quot;</span>],</span></span><br><span class="line"><span class="params">  emits:[<span class="string">&#x27;update:modelValue&#x27;</span>,<span class="string">&#x27;change&#x27;</span>],</span></span><br><span class="line"><span class="params">  setup(props,&#123;emit&#125;)</span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="variable">name</span> <span class="operator">=</span> ref();</span><br><span class="line">    <span class="type">const</span> <span class="variable">stations</span> <span class="operator">=</span> ref([]);</span><br><span class="line">    <span class="type">const</span> <span class="variable">localWidth</span> <span class="operator">=</span> ref(props.width);</span><br><span class="line">    <span class="keyword">if</span> (Tool.isEmpty(props.width)) &#123;</span><br><span class="line">      localWidth.value = <span class="string">&quot;100%&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//利用watch，动态获取父组件的值，如果放在onMounted或其它方法里，则只有第一次有效</span></span><br><span class="line">    watch(()=&gt;props.modelValue,()=&gt;&#123;</span><br><span class="line">      console.log(<span class="string">&quot;props.modelValue&quot;</span>,props.modelValue);</span><br><span class="line">      name.value = props.modelValue;</span><br><span class="line">    &#125;,&#123;immediate:<span class="literal">true</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有的车站，用于车站下拉框</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">const</span> <span class="variable">queryAllStation</span> <span class="operator">=</span> () =&gt;&#123;</span><br><span class="line">      axios.get(<span class="string">&quot;/business/admin/station/query-all&quot;</span>).then((response)=&gt;&#123;</span><br><span class="line">        <span class="type">let</span> <span class="variable">data</span> <span class="operator">=</span> response.data;</span><br><span class="line">        <span class="keyword">if</span> (data.success)&#123;</span><br><span class="line">          stations.value = data.content;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          notification.error(&#123;description:data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="variable">filterNameOption</span> <span class="operator">=</span>(input,option)=&gt;&#123;</span><br><span class="line">      console.log(input,option);</span><br><span class="line">      <span class="keyword">return</span> option.label.toLowerCase().indexOf(input.toLowerCase()) &gt;=<span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="variable">onChange</span> <span class="operator">=</span> (value) =&gt;&#123;</span><br><span class="line">      emit(<span class="string">&#x27;update:modelValue&#x27;</span>,value);</span><br><span class="line">      <span class="type">let</span> <span class="variable">station</span> <span class="operator">=</span> stations.value.filter(item =&gt;item.code == value)[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">if</span> (Tool.isEmpty(station))&#123;</span><br><span class="line">        station=&#123;&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      emit(<span class="string">&#x27;change&#x27;</span>,station);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    onMounted(()=&gt;&#123;</span><br><span class="line">      queryAllStation();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>&#123;</span><br><span class="line">      name,</span><br><span class="line">      stations,</span><br><span class="line">      filterNameOption,</span><br><span class="line">      onChange,</span><br><span class="line">      localWidth,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>哪里使用哪里就是这个子组件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;station-select-view v-model=&quot;train.start&quot;&gt;&lt;/station-select-view&gt;</span><br></pre></td></tr></table></figure>

<h2 id="为基础数据增加车次查询条件"><a href="#为基础数据增加车次查询条件" class="headerlink" title="为基础数据增加车次查询条件"></a>为基础数据增加车次查询条件</h2><ul>
<li>首先增加查询参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.req.PageReq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrainStationQueryReq</span> <span class="keyword">extends</span> <span class="title class_">PageReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String trainCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrainCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;TrainStationQueryReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;trainCode=&#x27;&quot;</span>).append(trainCode).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrainCode</span><span class="params">(String trainCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trainCode = trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>其次在TrainStationService的queryList加排序和一个判断</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">trainStationExample.setOrderByClause(<span class="string">&quot;train_code asc, `index` asc&quot;</span>);</span><br><span class="line">TrainStationExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> trainStationExample.createCriteria();</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotNull(req.getTrainCode()))&#123;</span><br><span class="line">    criteria.andTrainCodeEqualTo(req.getTrainCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改train-station.vue界面，加一个查询下拉框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;train-select-view v-model=&quot;params.trainCode&quot;&gt;&lt;/train-select-view&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加查询参数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> params =<span class="title function_">ref</span>(&#123;</span><br><span class="line">  <span class="attr">trainCode</span>: <span class="literal">null</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>点击查询的时候将将下拉框中的值赋值</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">trainCode</span>: params.<span class="property">value</span>.<span class="property">trainCode</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>最后将params返回</p>
</li>
<li><p>车厢的操作和上面一样</p>
</li>
</ul>
<blockquote>
<p>注意null和””的区别</p>
</blockquote>
<ul>
<li>但是发现一个问题：界面初始打开查不出数据，加上条件后就能查出数据，在这里我们需要把service判断处改一改方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotEmpty(req.getTrainCode()))&#123;</span><br><span class="line">    criteria.andTrainCodeEqualTo(req.getTrainCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>为火车座位页面增加车次查询条件操作也一样</li>
</ul>
<h2 id="实现按车次生成车座功能"><a href="#实现按车次生成车座功能" class="headerlink" title="实现按车次生成车座功能"></a>实现按车次生成车座功能</h2><ul>
<li>批量生成的功能一定要考虑几个问题：能不能支持重复生成<ul>
<li>存在就跳过；</li>
<li>先删除已有再插入</li>
</ul>
</li>
<li>批量插入数据需要考虑的问题：<strong>事务</strong></li>
</ul>
<blockquote>
<p>实现按车次生成车座功能，增加后端接口，测试成功</p>
</blockquote>
<ul>
<li>在TrainCarriageService写一个查询车厢的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;TrainCarriage&gt; <span class="title function_">selectByTrainCode</span><span class="params">(String trainCode)</span>&#123;</span><br><span class="line">    <span class="type">TrainCarriageExample</span> <span class="variable">trainCarriageExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainCarriageExample</span>();</span><br><span class="line">    trainCarriageExample.setOrderByClause(<span class="string">&quot;`index` asc&quot;</span>);</span><br><span class="line">    TrainCarriageExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> trainCarriageExample.createCriteria();</span><br><span class="line">    criteria.andTrainCodeEqualTo(trainCode);</span><br><span class="line">    <span class="keyword">return</span> trainCarriageMapper.selectByExample(trainCarriageExample);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在TrainSeatService生成车次</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> TrainCarriageService trainCarriageService;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">genTrainSeat</span><span class="params">(String trainCode)</span>&#123;</span><br><span class="line">        <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">        <span class="comment">//清空当前车次下的所有的座位记录</span></span><br><span class="line">        <span class="type">TrainSeatExample</span> <span class="variable">trainSeatExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainSeatExample</span>();</span><br><span class="line">        TrainSeatExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> trainSeatExample.createCriteria();</span><br><span class="line">        criteria.andTrainCodeEqualTo(trainCode);</span><br><span class="line">        trainSeatMapper.deleteByExample(trainSeatExample);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询当前车次下的所有的车厢</span></span><br><span class="line">        List&lt;TrainCarriage&gt; carriageList = trainCarriageService.selectByTrainCode(trainCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//循环生成每个车厢的座位</span></span><br><span class="line">        <span class="keyword">for</span> (TrainCarriage trainCarriage : carriageList)&#123;</span><br><span class="line">            <span class="comment">//拿到车厢数据：行数、座位类型</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">rowCount</span> <span class="operator">=</span> trainCarriage.getRowCount();</span><br><span class="line">            <span class="type">String</span> <span class="variable">seatType</span> <span class="operator">=</span> trainCarriage.getSeatType();</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">seatIndex</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//根据车箱的座位类型，筛选出所有的列，比如车箱类型是一等座，则筛选出columnList=&#123;ACDF&#125;</span></span><br><span class="line">            List&lt;SeatColEnum&gt; colEnumList = SeatColEnum.getColsByType(seatType);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//循环行数</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> <span class="number">1</span>; row &lt;= rowCount; row++) &#123;</span><br><span class="line">                <span class="comment">//循环列数</span></span><br><span class="line">                <span class="keyword">for</span> (SeatColEnum seatColEnum : colEnumList)&#123;</span><br><span class="line">                    <span class="comment">//构造座位数据并保存数据库</span></span><br><span class="line">                    <span class="type">TrainSeat</span> <span class="variable">trainSeat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainSeat</span>();</span><br><span class="line">                    trainSeat.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">                    trainSeat.setTrainCode(trainCode);</span><br><span class="line">                    trainSeat.setCarriageIndex(trainCarriage.getIndex());</span><br><span class="line">                    trainSeat.setRow(StrUtil.fillBefore(String.valueOf(row),<span class="string">&#x27;0&#x27;</span>,<span class="number">2</span>));</span><br><span class="line">                    trainSeat.setCol(seatColEnum.getCode());</span><br><span class="line">                    trainSeat.setSeatType(seatType);</span><br><span class="line">                    trainSeat.setCarriageSeatIndex(seatIndex++);</span><br><span class="line">                    trainSeat.setCreateTime(now);</span><br><span class="line">                    trainSeat.setUpdateTime(now);</span><br><span class="line">                    trainSeatMapper.insert(trainSeat);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在TrainAdminController中调用接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> TrainSeatService trainSeatService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/gen-seat/&#123;trainCode&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;Object&gt; <span class="title function_">genSeat</span><span class="params">(<span class="meta">@PathVariable</span> String trainCode)</span>&#123;</span><br><span class="line">        trainSeatService.genTrainSeat(trainCode);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>新建一个测试</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:8000/business/admin/train/gen-seat/G1</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json</span><br><span class="line">###</span><br></pre></td></tr></table></figure>

<ul>
<li>在train.vue生成前端界面，编辑后增加一个生成座位按钮</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-popconfirm</span><br><span class="line">    title=&quot;生成座位将删除已有记录，确认生成座位？&quot;</span><br><span class="line">    @confirm=&quot;genSeat(record)&quot;</span><br><span class="line">    ok-text=&quot;确认&quot; cancel-text=&quot;取消&quot;&gt;</span><br><span class="line">  &lt;a&gt;生成座位&lt;/a&gt;</span><br><span class="line">&lt;/a-popconfirm&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>相应的方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">genSeat</span> = (<span class="params">record</span>) =&gt;&#123;</span><br><span class="line">  loading.<span class="property">value</span> =<span class="literal">true</span>;</span><br><span class="line">  axios.<span class="title function_">get</span>(<span class="string">&quot;/business/admin/train/gen-seat/&quot;</span> + record.<span class="property">code</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>)=&gt;</span>&#123;</span><br><span class="line">    loading.<span class="property">value</span>=<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> data = response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">      notification.<span class="title function_">success</span>(&#123;<span class="attr">description</span>:<span class="string">&quot;生成成功！&quot;</span>&#125;);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将genSeat返回</li>
</ul>
<h2 id="完善车次-amp-车厢-amp-座位管理功能"><a href="#完善车次-amp-车厢-amp-座位管理功能" class="headerlink" title="完善车次&amp;车厢&amp;座位管理功能"></a>完善车次&amp;车厢&amp;座位管理功能</h2><ul>
<li>编程规范：内部变量（局部变量）使用_开头，所以我们前端一定不要自定义 _开头的变量</li>
<li>Vue 在组件实例上暴露的内置 API 使用 $ 作为前缀。它同时也为内部属性保留-前缀。因此，你应该避免在顶层data上使用任何以这些字符作前缀的属性。</li>
</ul>
<blockquote>
<p>火车管理，编辑时【车次编号】不允许修改，新增允许修改</p>
</blockquote>
<ul>
<li>前端如果要判断一个值是否为空，<ul>
<li>避免使用if（xxx）</li>
<li>应用使用if（！！xxx）</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-form-item label=&quot;车次编号&quot;&gt;</span><br><span class="line">  &lt;a-input v-model:value=&quot;train.code&quot;  :disabled=&quot;!!train.id&quot;/&gt;</span><br><span class="line">&lt;/a-form-item&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>重新生成火车座位页面为只读，只能生成不能修改</p>
</blockquote>
<ul>
<li>生成只读当然使用生成器啦ServerGenerator</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">readOnly</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后看看generator对应的那个表对不对，就可以生成了</li>
</ul>
<blockquote>
<p>修复火车座位页面的列号显示重复的问题</p>
</blockquote>
<ul>
<li>为什么会出现重复的问题呢？<ul>
<li>原因就是：生成枚举的时候没有生成全，进行判断遍历的时候会全部遍历，一等座的A会把二等座的A也遍历出来，解决办法就是将code和type都做一个匹配</li>
<li>接下来我们把枚举生成器改成取出枚举类所有的变量，之前这块代码就是全的，现在就不需要修改了</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.generator.gen;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="comment">//import com.fzx.train.business.enums.ConfirmOrderStatusEnum;</span></span><br><span class="line"><span class="comment">//import com.fzx.train.business.enums.SeatColEnum;</span></span><br><span class="line"><span class="comment">//import com.fzx.train.business.enums.SeatTypeEnum;</span></span><br><span class="line"><span class="comment">//import com.fzx.train.business.enums.TrainTypeEnum;</span></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.enums.SeatColEnum;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.enums.SeatTypeEnum;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.enums.TrainTypeEnum;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.enums.PassengerTypeEnum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnumGenerator</span> &#123;</span><br><span class="line"><span class="comment">//     static String path = &quot;web/src/assets/js/enums.js&quot;;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;admin/src/assets/js/enums.js&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">bufferObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">bufferArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            toJson(PassengerTypeEnum.class, bufferObject, bufferArray);</span><br><span class="line">            toJson(TrainTypeEnum.class, bufferObject, bufferArray);</span><br><span class="line">            toJson(SeatTypeEnum.class, bufferObject, bufferArray);</span><br><span class="line">            toJson(SeatColEnum.class, bufferObject, bufferArray);</span><br><span class="line"><span class="comment">//            toJson(ConfirmOrderStatusEnum.class, bufferObject, bufferArray);</span></span><br><span class="line"></span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> bufferObject.append(<span class="string">&quot;\r\n&quot;</span>).append(bufferArray);</span><br><span class="line">            writeJs(buffer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;执行耗时:&quot;</span> + (end - begin) + <span class="string">&quot; 毫秒&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">toJson</span><span class="params">(Class clazz, StringBuffer bufferObject, StringBuffer bufferArray)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// enumConst：将YesNoEnum变成YES_NO</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">enumConst</span> <span class="operator">=</span> StrUtil.toUnderlineCase(clazz.getSimpleName())</span><br><span class="line">                .toUpperCase().replace(<span class="string">&quot;_ENUM&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        Object[] objects = clazz.getEnumConstants();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 排除枚举属性和$VALUES，只获取code desc等</span></span><br><span class="line">        List&lt;Field&gt; targetFields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        Field[] fields = clazz.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Modifier.isPrivate(field.getModifiers()) || <span class="string">&quot;$VALUES&quot;</span>.equals(field.getName())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            targetFields.add(field);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对象</span></span><br><span class="line">        bufferObject.append(enumConst).append(<span class="string">&quot;=&#123;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; objects.length; i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> objects[i];</span><br><span class="line">            bufferObject.append(name.invoke(obj)).append(<span class="string">&quot;:&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将一个枚举值转成JSON对象字符串</span></span><br><span class="line">            formatJsonObj(bufferObject, targetFields, clazz, obj);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i &lt; objects.length - <span class="number">1</span>) &#123;</span><br><span class="line">                bufferObject.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bufferObject.append(<span class="string">&quot;&#125;;\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成数组</span></span><br><span class="line">        bufferArray.append(enumConst).append(<span class="string">&quot;_ARRAY=[&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; objects.length; i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> objects[i];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将一个枚举值转成JSON对象字符串</span></span><br><span class="line">            formatJsonObj(bufferArray, targetFields, clazz, obj);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i &lt; objects.length - <span class="number">1</span>) &#123;</span><br><span class="line">                bufferArray.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bufferArray.append(<span class="string">&quot;];\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将一个枚举值转成JSON对象字符串</span></span><br><span class="line"><span class="comment">     * 比如：SeatColEnum.YDZ_A(&quot;A&quot;, &quot;A&quot;, &quot;1&quot;)</span></span><br><span class="line"><span class="comment">     * 转成：&#123;code:&quot;A&quot;,desc:&quot;A&quot;,type:&quot;1&quot;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">formatJsonObj</span><span class="params">(StringBuffer bufferObject, List&lt;Field&gt; targetFields, Class clazz, Object obj)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException &#123;</span><br><span class="line">        bufferObject.append(<span class="string">&quot;&#123;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; targetFields.size(); j++) &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> targetFields.get(j);</span><br><span class="line">            <span class="type">String</span> <span class="variable">fieldName</span> <span class="operator">=</span> field.getName();</span><br><span class="line">            <span class="type">String</span> <span class="variable">getMethod</span> <span class="operator">=</span> <span class="string">&quot;get&quot;</span> + fieldName.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + fieldName.substring(<span class="number">1</span>);</span><br><span class="line">            bufferObject.append(fieldName).append(<span class="string">&quot;:\&quot;&quot;</span>).append(clazz.getMethod(getMethod).invoke(obj)).append(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (j &lt; targetFields.size() - <span class="number">1</span>) &#123;</span><br><span class="line">                bufferObject.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bufferObject.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 写文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> stringBuffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">writeJs</span><span class="params">(StringBuffer stringBuffer)</span> &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            out = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(path);</span><br><span class="line">            <span class="type">OutputStreamWriter</span> <span class="variable">osw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(out, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(path);</span><br><span class="line">            osw.write(stringBuffer.toString());</span><br><span class="line">            osw.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                out.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以后直接用就行</li>
<li>前端只需要加一个条件判断即可</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;span v-if=&quot;item.code === record.col &amp;&amp; item.type === record.seatType&quot;&gt;</span><br><span class="line">  &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">&lt;/span&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>保存车厢时自动计算出列数和总座位数</p>
</blockquote>
<ul>
<li>首先把前端的对应字段注释掉</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--      &lt;a-form-item label=&quot;座位数&quot;&gt;--&gt;</span><br><span class="line">&lt;!--        &lt;a-input v-model:value=&quot;trainCarriage.seatCount&quot; /&gt;--&gt;</span><br><span class="line">&lt;!--      &lt;/a-form-item&gt;--&gt;</span><br><span class="line">      &lt;a-form-item label=&quot;排数&quot;&gt;</span><br><span class="line">        &lt;a-input v-model:value=&quot;trainCarriage.rowCount&quot; /&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line">&lt;!--      &lt;a-form-item label=&quot;列数&quot;&gt;--&gt;</span><br><span class="line">&lt;!--        &lt;a-input v-model:value=&quot;trainCarriage.colCount&quot; /&gt;--&gt;</span><br><span class="line">&lt;!--      &lt;/a-form-item&gt;--&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来修改保存更改TrainCarriageService的save方法，他们呢通用一个哈，增加下面代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自动计算出列数和总座位数</span></span><br><span class="line">List&lt;SeatColEnum&gt; seatColEnums = SeatColEnum.getColsByType(req.getSeatType());</span><br><span class="line">req.setColCount(seatColEnums.size());</span><br><span class="line">req.setSeatCount(req.getColCount() * req.getRowCount());</span><br></pre></td></tr></table></figure>

<ul>
<li>他调用的就是枚举里面SeatColEnum的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据车箱的座位类型，筛选出所有的列，比如车箱类型是一等座，则筛选出columnList=&#123;ACDF&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;SeatColEnum&gt; <span class="title function_">getColsByType</span><span class="params">(String seatType)</span> &#123;</span><br><span class="line">    List&lt;SeatColEnum&gt; colList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    EnumSet&lt;SeatColEnum&gt; seatColEnums = EnumSet.allOf(SeatColEnum.class);</span><br><span class="line">    <span class="keyword">for</span> (SeatColEnum anEnum : seatColEnums) &#123;</span><br><span class="line">        <span class="keyword">if</span> (seatType.equals(anEnum.getType())) &#123;</span><br><span class="line">            colList.add(anEnum);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> colList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="为车次-amp-车厢-amp-车站增加存在性校验"><a href="#为车次-amp-车厢-amp-车站增加存在性校验" class="headerlink" title="为车次&amp;车厢&amp;车站增加存在性校验"></a>为车次&amp;车厢&amp;车站增加存在性校验</h2><ul>
<li>如果在车站管理新增一个一样的就会报错</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307171123974.png"
                      alt="image-20230717112352580"
                ></p>
<blockquote>
<p>保存车站之前先校验唯一键是否存在</p>
</blockquote>
<ul>
<li>首先定义报错枚举BusinessExceptionEnum</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BUSINESS_STATION_NAME_UNIQUE_ERROR(<span class="string">&quot;车站已存在&quot;</span>),</span><br></pre></td></tr></table></figure>

<ul>
<li>在StationService的save方法添加</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存之前先校验唯一键是否存在</span></span><br><span class="line"><span class="type">StationExample</span> <span class="variable">stationExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StationExample</span>();</span><br><span class="line">stationExample.createCriteria().andNameEqualTo(req.getName());</span><br><span class="line">List&lt;Station&gt; list = stationMapper.selectByExample(stationExample);</span><br><span class="line"><span class="keyword">if</span> (CollUtil.isNotEmpty(list))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.BUSINESS_STATION_NAME_UNIQUE_ERROR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>提取出按唯一键查询方法</p>
</blockquote>
<ul>
<li>一样是在StationService，提取出方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Station <span class="title function_">selectByUnique</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="type">StationExample</span> <span class="variable">stationExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StationExample</span>();</span><br><span class="line">    stationExample.createCriteria().andNameEqualTo(name);</span><br><span class="line">    List&lt;Station&gt; list = stationMapper.selectByExample(stationExample);</span><br><span class="line">    <span class="keyword">if</span> (CollUtil.isNotEmpty(list))&#123;</span><br><span class="line">        <span class="keyword">return</span> list.get(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存之前先校验唯一键是否存在</span></span><br><span class="line"><span class="type">Station</span> <span class="variable">stationDB</span> <span class="operator">=</span> selectByUnique(req.getName());</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotEmpty(stationDB))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.BUSINESS_STATION_NAME_UNIQUE_ERROR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为车次、途径车站、车厢增加唯一性校验(方法同上)</p>
</blockquote>
<ul>
<li>先解决一个遗留问题列数不能为空，我们修改TrainCarriageSaveReq，把校验去了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Integer colCount;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们先加几个异常的枚举BusinessExceptionEnum</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BUSINESS_TRAIN_CODE_UNIQUE_ERROR(<span class="string">&quot;车次编号已存在&quot;</span>),</span><br><span class="line">BUSINESS_TRAIN_STATION_INDEX_UNIQUE_ERROR(<span class="string">&quot;同车次站序已存在&quot;</span>),</span><br><span class="line">BUSINESS_TRAIN_STATION_NAME_UNIQUE_ERROR(<span class="string">&quot;同车次站名已存在&quot;</span>),</span><br><span class="line">BUSINESS_TRAIN_CARRIAGE_INDEX_UNIQUE_ERROR(<span class="string">&quot;同车次箱序已存在&quot;</span>),</span><br></pre></td></tr></table></figure>

<ul>
<li><p>唯一性校验都是看的数据库的唯一键</p>
</li>
<li><p>TrainCarriageService</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存之前先校验唯一键是否存在</span></span><br><span class="line"><span class="type">TrainCarriage</span> <span class="variable">trainCarriageDB</span> <span class="operator">=</span> selectByUnique(req.getTrainCode(),req.getIndex());</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotEmpty(trainCarriageDB))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.BUSINESS_TRAIN_CARRIAGE_INDEX_UNIQUE_ERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> TrainCarriage <span class="title function_">selectByUnique</span><span class="params">(String trainCode , Integer index)</span> &#123;</span><br><span class="line">        <span class="type">TrainCarriageExample</span> <span class="variable">trainCarriageExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainCarriageExample</span>();</span><br><span class="line">        trainCarriageExample.createCriteria().andTrainCodeEqualTo(trainCode).andIndexEqualTo(index);</span><br><span class="line">        List&lt;TrainCarriage&gt; list = trainCarriageMapper.selectByExample(trainCarriageExample);</span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(list))&#123;</span><br><span class="line">            <span class="keyword">return</span> list.get(<span class="number">0</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>TrainService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存之前先校验唯一键是否存在</span></span><br><span class="line"><span class="type">Train</span> <span class="variable">trainDB</span> <span class="operator">=</span> selectByUnique(req.getCode());</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotEmpty(trainDB))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.BUSINESS_TRAIN_CODE_UNIQUE_ERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Train <span class="title function_">selectByUnique</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="type">TrainExample</span> <span class="variable">trainExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainExample</span>();</span><br><span class="line">        trainExample.createCriteria().andCodeEqualTo(code);</span><br><span class="line">        List&lt;Train&gt; list = trainMapper.selectByExample(trainExample);</span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(list))&#123;</span><br><span class="line">            <span class="keyword">return</span> list.get(<span class="number">0</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>TrainStationService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存之前先校验唯一键是否存在</span></span><br><span class="line"><span class="type">TrainStation</span> <span class="variable">trainStationDB</span> <span class="operator">=</span> selectByUnique(req.getTrainCode(),req.getIndex());</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotEmpty(trainStationDB))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.BUSINESS_TRAIN_STATION_INDEX_UNIQUE_ERROR);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//保存之前先校验唯一键是否存在</span></span><br><span class="line">trainStationDB = selectByUnique(req.getTrainCode(),req.getName());</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotEmpty(trainStationDB))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.BUSINESS_TRAIN_STATION_NAME_UNIQUE_ERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> TrainStation <span class="title function_">selectByUnique</span><span class="params">(String trainCode , Integer index)</span> &#123;</span><br><span class="line">        <span class="type">TrainStationExample</span> <span class="variable">trainStationExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainStationExample</span>();</span><br><span class="line">        trainStationExample.createCriteria().andTrainCodeEqualTo(trainCode).andIndexEqualTo(index);</span><br><span class="line">        List&lt;TrainStation&gt; list = trainStationMapper.selectByExample(trainStationExample);</span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(list))&#123;</span><br><span class="line">            <span class="keyword">return</span> list.get(<span class="number">0</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> TrainStation <span class="title function_">selectByUnique</span><span class="params">(String trainCode , String  name)</span> &#123;</span><br><span class="line">        <span class="type">TrainStationExample</span> <span class="variable">trainStationExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainStationExample</span>();</span><br><span class="line">        trainStationExample.createCriteria().andTrainCodeEqualTo(trainCode).andNameEqualTo(name);</span><br><span class="line">        List&lt;TrainStation&gt; list = trainStationMapper.selectByExample(trainStationExample);</span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(list))&#123;</span><br><span class="line">            <span class="keyword">return</span> list.get(<span class="number">0</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为途径车站自动计算停站时长</p>
</blockquote>
<ul>
<li><p>就修改train-station.vue</p>
</li>
<li><p>首先把停站时长设置为不可编辑</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-form-item label=&quot;停站时长&quot;&gt;</span><br><span class="line">  &lt;a-time-picker v-model:value=&quot;trainStation.stopTime&quot; valueFormat=&quot;HH:mm:ss&quot; placeholder=&quot;请选择时间&quot; disabled/&gt;</span><br><span class="line">&lt;/a-form-item&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>引入dayjs，来进行监听入站时间和出战时间的变化</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dayjs <span class="keyword">from</span> <span class="string">&#x27;dayjs&#x27;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//自动计算停车时长</span></span><br><span class="line">    <span class="title function_">watch</span>(<span class="function">()=&gt;</span> trainStation.<span class="property">value</span>.<span class="property">inTime</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">let</span> diff = <span class="title function_">dayjs</span>(trainStation.<span class="property">value</span>.<span class="property">outTime</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>).<span class="title function_">diff</span>( <span class="title function_">dayjs</span>(trainStation.<span class="property">value</span>.<span class="property">inTime</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>),<span class="string">&#x27;seconds&#x27;</span>);</span><br><span class="line">      trainStation.<span class="property">value</span>.<span class="property">stopTime</span> = <span class="title function_">dayjs</span>(<span class="string">&#x27;00:00:00&#x27;</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>).<span class="title function_">second</span>(diff).<span class="title function_">format</span>(<span class="string">&#x27;HH:mm:ss&#x27;</span>);</span><br><span class="line">    &#125;,&#123;<span class="attr">immediate</span>:<span class="literal">true</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自动计算停车时长</span></span><br><span class="line">    <span class="title function_">watch</span>(<span class="function">()=&gt;</span> trainStation.<span class="property">value</span>.<span class="property">outTime</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">let</span> diff = <span class="title function_">dayjs</span>(trainStation.<span class="property">value</span>.<span class="property">outTime</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>).<span class="title function_">diff</span>( <span class="title function_">dayjs</span>(trainStation.<span class="property">value</span>.<span class="property">inTime</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>),<span class="string">&#x27;seconds&#x27;</span>);</span><br><span class="line">      trainStation.<span class="property">value</span>.<span class="property">stopTime</span> = <span class="title function_">dayjs</span>(<span class="string">&#x27;00:00:00&#x27;</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>).<span class="title function_">second</span>(diff).<span class="title function_">format</span>(<span class="string">&#x27;HH:mm:ss&#x27;</span>);</span><br><span class="line">    &#125;,&#123;<span class="attr">immediate</span>:<span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="使用调度框架quartz，为12306系统增加定时调度功能"><a href="#使用调度框架quartz，为12306系统增加定时调度功能" class="headerlink" title="使用调度框架quartz，为12306系统增加定时调度功能"></a>使用调度框架quartz，为12306系统增加定时调度功能</h1><p>定时调度模块在微服务系统中是非常常见，也是非常重要的一个模块，通常一些逻辑复杂，实时性不高的功能会放到定时调度模块中执行。本章将对调度框架quartz及其异步线程组合做详细讲解。</p>
<hr>
<ul>
<li>为什么要有定时调度<ul>
<li>定时调度在企业级系统中非常重要<ul>
<li>统计报表</li>
<li>功能补偿</li>
<li>不紧急的大批量任务</li>
</ul>
</li>
<li>每天都需要生成15天后的车次数据</li>
</ul>
</li>
</ul>
<h2 id="项目中增加batch定时调度模块"><a href="#项目中增加batch定时调度模块" class="headerlink" title="项目中增加batch定时调度模块"></a>项目中增加batch定时调度模块</h2><ul>
<li>就是那一套增加启动类、controller、配置文件、日志文件、增加依赖，增加路由转发配置</li>
</ul>
<h2 id="为batch模块配置持久层生成器"><a href="#为batch模块配置持久层生成器" class="headerlink" title="为batch模块配置持久层生成器"></a>为batch模块配置持久层生成器</h2><ul>
<li>老一套，就是创建数据库创建用户，修改配置连接IDEA数据库，然后改generator的依赖里面的配置项，并增加一个generator-cofig-batch.xml</li>
</ul>
<h2 id="演示Springboot自带的定时任务"><a href="#演示Springboot自带的定时任务" class="headerlink" title="演示Springboot自带的定时任务"></a>演示Springboot自带的定时任务</h2><ul>
<li><p>定时任务三大要素：</p>
<ul>
<li>执行的内容：功能逻辑</li>
<li>执行的策略：cron表达式</li>
<li>开关：开启定时任务</li>
</ul>
</li>
<li><p>speingboot自带的就是各种注释</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.job;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableScheduling;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 适合单体应用，不适合集群</span></span><br><span class="line"><span class="comment"> * 没法实时更改定时任务状态和策略</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootTestJob</span> &#123;</span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//增加分布式锁，解决集群问题</span></span><br><span class="line">        System.out.println(<span class="string">&quot;SpringBootTestJob Test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定时调度模块集成quartz"><a href="#定时调度模块集成quartz" class="headerlink" title="定时调度模块集成quartz"></a>定时调度模块集成quartz</h2><ul>
<li>首先引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>其次加一个要运行的调度任务</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.job;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.Job;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;TestJob TEST&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后定义调度配置来声明任务并触发任务</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.config;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">import</span> com.fzx.train.batch.job.TestJob;</span><br><span class="line"> <span class="keyword">import</span> org.quartz.*;</span><br><span class="line"> <span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"> <span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Configuration</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuartzConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 声明一个任务</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="meta">@Bean</span></span><br><span class="line">     <span class="keyword">public</span> JobDetail <span class="title function_">jobDetail</span><span class="params">()</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> JobBuilder.newJob(TestJob.class)</span><br><span class="line">                 .withIdentity(<span class="string">&quot;TestJob&quot;</span>, <span class="string">&quot;test&quot;</span>)</span><br><span class="line">                 .storeDurably()</span><br><span class="line">                 .build();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 声明一个触发器，什么时候触发这个任务</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="meta">@Bean</span></span><br><span class="line">     <span class="keyword">public</span> Trigger <span class="title function_">trigger</span><span class="params">()</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> TriggerBuilder.newTrigger()</span><br><span class="line">                 .forJob(jobDetail())</span><br><span class="line">                 .withIdentity(<span class="string">&quot;trigger&quot;</span>, <span class="string">&quot;trigger&quot;</span>)</span><br><span class="line">                 .startNow()</span><br><span class="line">                 .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">&quot;*/2 * * * * ?&quot;</span>))</span><br><span class="line">                 .build();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="关于调度任务的并发执行"><a href="#关于调度任务的并发执行" class="headerlink" title="关于调度任务的并发执行"></a>关于调度任务的并发执行</h2><ul>
<li>并发执行：上一周期还没执行完，下一周期又开始了</li>
</ul>
<blockquote>
<p>禁止任务并发执行，只需要在类上加一个注解（@DisallowConcurrentExecution）</p>
</blockquote>
<h2 id="使用数据库配置quartz调度任务"><a href="#使用数据库配置quartz调度任务" class="headerlink" title="使用数据库配置quartz调度任务"></a>使用数据库配置quartz调度任务</h2><blockquote>
<p>增加quartz相关的12张表，增加接口来操作quartz</p>
</blockquote>
<ul>
<li>首先在数据库中创建各种表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Quartz seems <span class="keyword">to</span> work best <span class="keyword">with</span> the driver mm.mysql<span class="number">-2.0</span><span class="number">.7</span><span class="operator">-</span>bin.jar</span><br><span class="line">#</span><br><span class="line"># PLEASE consider <span class="keyword">using</span> mysql <span class="keyword">with</span> innodb tables <span class="keyword">to</span> avoid locking issues</span><br><span class="line">#</span><br><span class="line"># <span class="keyword">In</span> your Quartz properties file, you<span class="string">&#x27;ll need to set</span></span><br><span class="line"><span class="string"># org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS QRTZ_FIRED_TRIGGERS;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS QRTZ_PAUSED_TRIGGER_GRPS;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS QRTZ_SCHEDULER_STATE;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS QRTZ_LOCKS;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS QRTZ_SIMPLE_TRIGGERS;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS QRTZ_SIMPROP_TRIGGERS;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS QRTZ_CRON_TRIGGERS;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS QRTZ_BLOB_TRIGGERS;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS QRTZ_TRIGGERS;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS QRTZ_JOB_DETAILS;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS QRTZ_CALENDARS;</span></span><br><span class="line"><span class="string">CREATE TABLE QRTZ_JOB_DETAILS</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">  SCHED_NAME VARCHAR(120) NOT NULL  comment &#x27;</span>定时任务名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  JOB_NAME  VARCHAR(200) NOT NULL  comment &#x27;</span>job名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  JOB_GROUP VARCHAR(200) NOT NULL  comment &#x27;</span>job组<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  DESCRIPTION VARCHAR(250) NULL  comment &#x27;</span>描述<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  JOB_CLASS_NAME   VARCHAR(250) NOT NULL  comment &#x27;</span>job类名<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  IS_DURABLE VARCHAR(1) NOT NULL  comment &#x27;</span>是否持久化<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  IS_NONCONCURRENT VARCHAR(1) NOT NULL  comment &#x27;</span>是否非同步<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  IS_UPDATE_DATA VARCHAR(1) NOT NULL  comment &#x27;</span>是否更新数据<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  REQUESTS_RECOVERY VARCHAR(1) NOT NULL  comment &#x27;</span>请求是否覆盖<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  JOB_DATA BLOB NULL  comment &#x27;</span>job数据<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">CREATE TABLE QRTZ_TRIGGERS</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">  SCHED_NAME VARCHAR(120) NOT NULL  comment &#x27;</span>定时任务名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_NAME VARCHAR(200) NOT NULL comment &#x27;</span>触发器名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_GROUP VARCHAR(200) NOT NULL  comment &#x27;</span>触发器组<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  JOB_NAME  VARCHAR(200) NOT NULL  comment &#x27;</span>job名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  JOB_GROUP VARCHAR(200) NOT NULL  comment &#x27;</span>job组<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  DESCRIPTION VARCHAR(250) NULL  comment &#x27;</span>描述<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  NEXT_FIRE_TIME BIGINT(13) NULL  comment &#x27;</span>下一次触发时间<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PREV_FIRE_TIME BIGINT(13) NULL  comment &#x27;</span>前一次触发时间<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIORITY INTEGER NULL  comment &#x27;</span>等级<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_STATE VARCHAR(16) NOT NULL  comment &#x27;</span>触发状态<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_TYPE VARCHAR(8) NOT NULL  comment &#x27;</span>触发类型<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  START_TIME BIGINT(13) NOT NULL  comment &#x27;</span>开始时间<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  END_TIME BIGINT(13) NULL  comment &#x27;</span>结束时间<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  CALENDAR_NAME VARCHAR(200) NULL  comment &#x27;</span>日程名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  MISFIRE_INSTR SMALLINT(2) NULL  comment &#x27;</span>未触发实例<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  JOB_DATA BLOB NULL  comment &#x27;</span>job数据<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</span></span><br><span class="line"><span class="string">  FOREIGN KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)</span></span><br><span class="line"><span class="string">  REFERENCES QRTZ_JOB_DETAILS(SCHED_NAME,JOB_NAME,JOB_GROUP)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">CREATE TABLE QRTZ_SIMPLE_TRIGGERS</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">  SCHED_NAME VARCHAR(120) NOT NULL  comment &#x27;</span>定时任务名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_NAME VARCHAR(200) NOT NULL  comment &#x27;</span>触发器名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_GROUP VARCHAR(200) NOT NULL  comment &#x27;</span>触发器组<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  REPEAT_COUNT BIGINT(7) NOT NULL  comment &#x27;</span>重复执行次数<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  REPEAT_INTERVAL BIGINT(12) NOT NULL  comment &#x27;</span>重复执行间隔<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TIMES_TRIGGERED BIGINT(10) NOT NULL  comment &#x27;</span>已经触发次数<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</span></span><br><span class="line"><span class="string">  FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span></span><br><span class="line"><span class="string">  REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">CREATE TABLE QRTZ_CRON_TRIGGERS</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">  SCHED_NAME VARCHAR(120) NOT NULL  comment &#x27;</span>定时任务名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_NAME VARCHAR(200) NOT NULL  comment &#x27;</span>触发器名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_GROUP VARCHAR(200) NOT NULL  comment &#x27;</span>触发器组<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  CRON_EXPRESSION VARCHAR(200) NOT NULL  comment &#x27;</span>cron表达式<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TIME_ZONE_ID VARCHAR(80)  comment &#x27;</span>时区<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</span></span><br><span class="line"><span class="string">  FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span></span><br><span class="line"><span class="string">  REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">CREATE TABLE QRTZ_SIMPROP_TRIGGERS</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">  SCHED_NAME VARCHAR(120) NOT NULL  comment &#x27;</span>定时任务名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_NAME VARCHAR(200) NOT NULL  comment &#x27;</span>触发器名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_GROUP VARCHAR(200) NOT NULL  comment &#x27;</span>触发器组<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  STR_PROP_1 VARCHAR(512) NULL  comment &#x27;</span>开始配置<span class="number">1</span><span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  STR_PROP_2 VARCHAR(512) NULL  comment &#x27;</span>开始配置<span class="number">2</span><span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  STR_PROP_3 VARCHAR(512) NULL  comment &#x27;</span>开始配置<span class="number">3</span><span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  INT_PROP_1 INT NULL  comment &#x27;</span><span class="type">int</span>配置<span class="number">1</span><span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  INT_PROP_2 INT NULL  comment &#x27;</span><span class="type">int</span>配置<span class="number">2</span><span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  LONG_PROP_1 BIGINT NULL  comment &#x27;</span>long配置<span class="number">1</span><span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  LONG_PROP_2 BIGINT NULL  comment &#x27;</span>long配置<span class="number">2</span><span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  DEC_PROP_1 NUMERIC(13,4) NULL  comment &#x27;</span>配置描述<span class="number">1</span><span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  DEC_PROP_2 NUMERIC(13,4) NULL  comment &#x27;</span>配置描述<span class="number">2</span><span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  BOOL_PROP_1 VARCHAR(1) NULL  comment &#x27;</span>bool配置<span class="number">1</span><span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  BOOL_PROP_2 VARCHAR(1) NULL  comment &#x27;</span>bool配置<span class="number">2</span><span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</span></span><br><span class="line"><span class="string">  FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span></span><br><span class="line"><span class="string">  REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">CREATE TABLE QRTZ_BLOB_TRIGGERS</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">  SCHED_NAME VARCHAR(120) NOT NULL  comment &#x27;</span>定时任务名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_NAME VARCHAR(200) NOT NULL  comment &#x27;</span>触发器名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_GROUP VARCHAR(200) NOT NULL  comment &#x27;</span>触发器组<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  BLOB_DATA BLOB NULL  comment &#x27;</span>数据<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</span></span><br><span class="line"><span class="string">  FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span></span><br><span class="line"><span class="string">  REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">CREATE TABLE QRTZ_CALENDARS</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">  SCHED_NAME VARCHAR(120) NOT NULL  comment &#x27;</span>定时任务名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  CALENDAR_NAME  VARCHAR(200) NOT NULL comment &#x27;</span>日程名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  CALENDAR BLOB NOT NULL  comment &#x27;</span>日程数据<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (SCHED_NAME,CALENDAR_NAME)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">CREATE TABLE QRTZ_PAUSED_TRIGGER_GRPS</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">  SCHED_NAME VARCHAR(120) NOT NULL  comment &#x27;</span>定时任务名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_GROUP  VARCHAR(200) NOT NULL  comment &#x27;</span>触发器组<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (SCHED_NAME,TRIGGER_GROUP)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">CREATE TABLE QRTZ_FIRED_TRIGGERS</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">  SCHED_NAME VARCHAR(120) NOT NULL  comment &#x27;</span>定时任务名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  ENTRY_ID VARCHAR(95) NOT NULL  comment &#x27;</span>entryId<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_NAME VARCHAR(200) NOT NULL  comment &#x27;</span>触发器名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  TRIGGER_GROUP VARCHAR(200) NOT NULL  comment &#x27;</span>触发器组<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  INSTANCE_NAME VARCHAR(200) NOT NULL  comment &#x27;</span>实例名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  FIRED_TIME BIGINT(13) NOT NULL  comment &#x27;</span>执行时间<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  SCHED_TIME BIGINT(13) NOT NULL  comment &#x27;</span>定时任务时间<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIORITY INTEGER NOT NULL  comment &#x27;</span>等级<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  STATE VARCHAR(16) NOT NULL  comment &#x27;</span>状态<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  JOB_NAME VARCHAR(200) NULL  comment &#x27;</span>job名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  JOB_GROUP VARCHAR(200) NULL  comment &#x27;</span>job组<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  IS_NONCONCURRENT VARCHAR(1) NULL  comment &#x27;</span>是否异步<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  REQUESTS_RECOVERY VARCHAR(1) NULL  comment &#x27;</span>是否请求覆盖<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (SCHED_NAME,ENTRY_ID)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">CREATE TABLE QRTZ_SCHEDULER_STATE</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">  SCHED_NAME VARCHAR(120) NOT NULL  comment &#x27;</span>定时任务名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  INSTANCE_NAME VARCHAR(200) NOT NULL  comment &#x27;</span>实例名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  LAST_CHECKIN_TIME BIGINT(13) NOT NULL  comment &#x27;</span>最近检入时间<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  CHECKIN_INTERVAL BIGINT(13) NOT NULL  comment &#x27;</span>检入间隔<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (SCHED_NAME,INSTANCE_NAME)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">CREATE TABLE QRTZ_LOCKS</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">  SCHED_NAME VARCHAR(120) NOT NULL  comment &#x27;</span>定时任务名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  LOCK_NAME  VARCHAR(40) NOT NULL  comment &#x27;</span>lock名称<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (SCHED_NAME,LOCK_NAME)</span></span><br><span class="line"><span class="string">);</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>我们写调度，不应该把任务写在配置类里面，应该用控台增加，以下的文件直接拿去用就ok</p>
</li>
<li><p>首先我们修改batch的config软件包，这里QuartzConfig就不用了，全部注释，添加了MyJobFactory和SchedulerConfig和SpringMvcConfig</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.quartz.spi.TriggerFiredBundle;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.AutowireCapableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.SpringBeanJobFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyJobFactory</span> <span class="keyword">extends</span> <span class="title class_">SpringBeanJobFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AutowireCapableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里覆盖了super的createJobInstance方法，对其创建出来的类再进行autowire。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">createJobInstance</span><span class="params">(TriggerFiredBundle bundle)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">jobInstance</span> <span class="operator">=</span> <span class="built_in">super</span>.createJobInstance(bundle);</span><br><span class="line">        beanFactory.autowireBean(jobInstance);</span><br><span class="line">        <span class="keyword">return</span> jobInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.SchedulerFactoryBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SchedulerConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MyJobFactory myJobFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SchedulerFactoryBean <span class="title function_">schedulerFactoryBean</span><span class="params">(<span class="meta">@Qualifier(&quot;dataSource&quot;)</span> DataSource dataSource)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SchedulerFactoryBean</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchedulerFactoryBean</span>();</span><br><span class="line">        factory.setDataSource(dataSource);</span><br><span class="line">        factory.setJobFactory(myJobFactory);</span><br><span class="line">        factory.setStartupDelay(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.interceptor.LogInterceptor;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Resource</span></span><br><span class="line">   LogInterceptor logInterceptor;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">       registry.addInterceptor(logInterceptor)</span><br><span class="line">               .addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加CronJobReq</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CronJobReq</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String group;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cronExpression;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;CronJobDto&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;cronExpression=&#x27;&quot;</span>).append(cronExpression).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, group=&#x27;&quot;</span>).append(group).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, name=&#x27;&quot;</span>).append(name).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, description=&#x27;&quot;</span>).append(description).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getGroup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> group;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setGroup</span><span class="params">(String group)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.group = group;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCronExpression</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cronExpression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCronExpression</span><span class="params">(String cronExpression)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cronExpression = cronExpression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDescription</span><span class="params">(String description)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加CronJobResp（都是内置的属性）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.resp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonInclude;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JsonInclude(JsonInclude.Include.NON_EMPTY)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CronJobResp</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String group;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cronExpression;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonFormat(pattern=&quot;yyyy-MM-dd HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date nextFireTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonFormat(pattern=&quot;yyyy-MM-dd HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date preFireTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;CronJobDto&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;cronExpression=&#x27;&quot;</span>).append(cronExpression).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, group=&#x27;&quot;</span>).append(group).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, name=&#x27;&quot;</span>).append(name).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, description=&#x27;&quot;</span>).append(description).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, state=&#x27;&quot;</span>).append(state).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, nextFireTime=&quot;</span>).append(nextFireTime);</span><br><span class="line">        sb.append(<span class="string">&quot;, preFireTime=&quot;</span>).append(preFireTime);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getGroup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> group;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setGroup</span><span class="params">(String group)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.group = group;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCronExpression</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cronExpression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCronExpression</span><span class="params">(String cronExpression)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cronExpression = cronExpression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDescription</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDescription</span><span class="params">(String description)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getNextFireTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nextFireTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextFireTime</span><span class="params">(Date nextFireTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nextFireTime = nextFireTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getPreFireTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> preFireTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPreFireTime</span><span class="params">(Date preFireTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.preFireTime = preFireTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">(String state)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后添加JobController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.job;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.batch.req.CronJobReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.batch.resp.CronJobResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.*;</span><br><span class="line"><span class="keyword">import</span> org.quartz.impl.matchers.GroupMatcher;</span><br><span class="line"><span class="keyword">import</span> org.quartz.impl.triggers.CronTriggerImpl;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.SchedulerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/admin/job&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(JobController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SchedulerFactoryBean schedulerFactoryBean;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/run&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;Object&gt; <span class="title function_">run</span><span class="params">(<span class="meta">@RequestBody</span> CronJobReq cronJobReq)</span> <span class="keyword">throws</span> SchedulerException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobClassName</span> <span class="operator">=</span> cronJobReq.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobGroupName</span> <span class="operator">=</span> cronJobReq.getGroup();</span><br><span class="line">        LOG.info(<span class="string">&quot;手动执行任务开始：&#123;&#125;, &#123;&#125;&quot;</span>, jobClassName, jobGroupName);</span><br><span class="line">        schedulerFactoryBean.getScheduler().triggerJob(JobKey.jobKey(jobClassName, jobGroupName));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> CronJobReq cronJobReq)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobClassName</span> <span class="operator">=</span> cronJobReq.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobGroupName</span> <span class="operator">=</span> cronJobReq.getGroup();</span><br><span class="line">        <span class="type">String</span> <span class="variable">cronExpression</span> <span class="operator">=</span> cronJobReq.getCronExpression();</span><br><span class="line">        <span class="type">String</span> <span class="variable">description</span> <span class="operator">=</span> cronJobReq.getDescription();</span><br><span class="line">        LOG.info(<span class="string">&quot;创建定时任务开始：&#123;&#125;，&#123;&#125;，&#123;&#125;，&#123;&#125;&quot;</span>, jobClassName, jobGroupName, cronExpression, description);</span><br><span class="line">        <span class="type">CommonResp</span> <span class="variable">commonResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 通过SchedulerFactory获取一个调度器实例</span></span><br><span class="line">            <span class="type">Scheduler</span> <span class="variable">sched</span> <span class="operator">=</span> schedulerFactoryBean.getScheduler();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 启动调度器</span></span><br><span class="line">            sched.start();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//构建job信息</span></span><br><span class="line">            <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> JobBuilder.newJob((Class&lt;? <span class="keyword">extends</span> <span class="title class_">Job</span>&gt;) Class.forName(jobClassName)).withIdentity(jobClassName, jobGroupName).build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//表达式调度构建器(即任务执行的时间)</span></span><br><span class="line">            <span class="type">CronScheduleBuilder</span> <span class="variable">scheduleBuilder</span> <span class="operator">=</span> CronScheduleBuilder.cronSchedule(cronExpression);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//按新的cronExpression表达式构建一个新的trigger</span></span><br><span class="line">            <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> TriggerBuilder.newTrigger().withIdentity(jobClassName, jobGroupName).withDescription(description).withSchedule(scheduleBuilder).build();</span><br><span class="line"></span><br><span class="line">            sched.scheduleJob(jobDetail, trigger);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;创建定时任务失败:&quot;</span> + e);</span><br><span class="line">            commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">            commonResp.setMessage(<span class="string">&quot;创建定时任务失败:调度异常&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;创建定时任务失败:&quot;</span> + e);</span><br><span class="line">            commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">            commonResp.setMessage(<span class="string">&quot;创建定时任务失败：任务类不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;创建定时任务结束：&#123;&#125;&quot;</span>, commonResp);</span><br><span class="line">        <span class="keyword">return</span> commonResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/pause&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp <span class="title function_">pause</span><span class="params">(<span class="meta">@RequestBody</span> CronJobReq cronJobReq)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobClassName</span> <span class="operator">=</span> cronJobReq.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobGroupName</span> <span class="operator">=</span> cronJobReq.getGroup();</span><br><span class="line">        LOG.info(<span class="string">&quot;暂停定时任务开始：&#123;&#125;，&#123;&#125;&quot;</span>, jobClassName, jobGroupName);</span><br><span class="line">        <span class="type">CommonResp</span> <span class="variable">commonResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Scheduler</span> <span class="variable">sched</span> <span class="operator">=</span> schedulerFactoryBean.getScheduler();</span><br><span class="line">            sched.pauseJob(JobKey.jobKey(jobClassName, jobGroupName));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;暂停定时任务失败:&quot;</span> + e);</span><br><span class="line">            commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">            commonResp.setMessage(<span class="string">&quot;暂停定时任务失败:调度异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;暂停定时任务结束：&#123;&#125;&quot;</span>, commonResp);</span><br><span class="line">        <span class="keyword">return</span> commonResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/resume&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp <span class="title function_">resume</span><span class="params">(<span class="meta">@RequestBody</span> CronJobReq cronJobReq)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobClassName</span> <span class="operator">=</span> cronJobReq.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobGroupName</span> <span class="operator">=</span> cronJobReq.getGroup();</span><br><span class="line">        LOG.info(<span class="string">&quot;重启定时任务开始：&#123;&#125;，&#123;&#125;&quot;</span>, jobClassName, jobGroupName);</span><br><span class="line">        <span class="type">CommonResp</span> <span class="variable">commonResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Scheduler</span> <span class="variable">sched</span> <span class="operator">=</span> schedulerFactoryBean.getScheduler();</span><br><span class="line">            sched.resumeJob(JobKey.jobKey(jobClassName, jobGroupName));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;重启定时任务失败:&quot;</span> + e);</span><br><span class="line">            commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">            commonResp.setMessage(<span class="string">&quot;重启定时任务失败:调度异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;重启定时任务结束：&#123;&#125;&quot;</span>, commonResp);</span><br><span class="line">        <span class="keyword">return</span> commonResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/reschedule&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp <span class="title function_">reschedule</span><span class="params">(<span class="meta">@RequestBody</span> CronJobReq cronJobReq)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobClassName</span> <span class="operator">=</span> cronJobReq.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobGroupName</span> <span class="operator">=</span> cronJobReq.getGroup();</span><br><span class="line">        <span class="type">String</span> <span class="variable">cronExpression</span> <span class="operator">=</span> cronJobReq.getCronExpression();</span><br><span class="line">        <span class="type">String</span> <span class="variable">description</span> <span class="operator">=</span> cronJobReq.getDescription();</span><br><span class="line">        LOG.info(<span class="string">&quot;更新定时任务开始：&#123;&#125;，&#123;&#125;，&#123;&#125;，&#123;&#125;&quot;</span>, jobClassName, jobGroupName, cronExpression, description);</span><br><span class="line">        <span class="type">CommonResp</span> <span class="variable">commonResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Scheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> schedulerFactoryBean.getScheduler();</span><br><span class="line">            <span class="type">TriggerKey</span> <span class="variable">triggerKey</span> <span class="operator">=</span> TriggerKey.triggerKey(jobClassName, jobGroupName);</span><br><span class="line">            <span class="comment">// 表达式调度构建器</span></span><br><span class="line">            <span class="type">CronScheduleBuilder</span> <span class="variable">scheduleBuilder</span> <span class="operator">=</span> CronScheduleBuilder.cronSchedule(cronExpression);</span><br><span class="line">            <span class="type">CronTriggerImpl</span> <span class="variable">trigger1</span> <span class="operator">=</span> (CronTriggerImpl) scheduler.getTrigger(triggerKey);</span><br><span class="line">            trigger1.setStartTime(<span class="keyword">new</span> <span class="title class_">Date</span>()); <span class="comment">// 重新设置开始时间</span></span><br><span class="line">            <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> trigger1;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 按新的cronExpression表达式重新构建trigger</span></span><br><span class="line">            trigger = trigger.getTriggerBuilder().withIdentity(triggerKey).withDescription(description).withSchedule(scheduleBuilder).build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 按新的trigger重新设置job执行</span></span><br><span class="line">            scheduler.rescheduleJob(triggerKey, trigger);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;更新定时任务失败:&quot;</span> + e);</span><br><span class="line">            commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">            commonResp.setMessage(<span class="string">&quot;更新定时任务失败:调度异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;更新定时任务结束：&#123;&#125;&quot;</span>, commonResp);</span><br><span class="line">        <span class="keyword">return</span> commonResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/delete&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> CronJobReq cronJobReq)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobClassName</span> <span class="operator">=</span> cronJobReq.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobGroupName</span> <span class="operator">=</span> cronJobReq.getGroup();</span><br><span class="line">        LOG.info(<span class="string">&quot;删除定时任务开始：&#123;&#125;，&#123;&#125;&quot;</span>, jobClassName, jobGroupName);</span><br><span class="line">        <span class="type">CommonResp</span> <span class="variable">commonResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Scheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> schedulerFactoryBean.getScheduler();</span><br><span class="line">            scheduler.pauseTrigger(TriggerKey.triggerKey(jobClassName, jobGroupName));</span><br><span class="line">            scheduler.unscheduleJob(TriggerKey.triggerKey(jobClassName, jobGroupName));</span><br><span class="line">            scheduler.deleteJob(JobKey.jobKey(jobClassName, jobGroupName));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;删除定时任务失败:&quot;</span> + e);</span><br><span class="line">            commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">            commonResp.setMessage(<span class="string">&quot;删除定时任务失败:调度异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;删除定时任务结束：&#123;&#125;&quot;</span>, commonResp);</span><br><span class="line">        <span class="keyword">return</span> commonResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/query&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp <span class="title function_">query</span><span class="params">()</span> &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;查看所有定时任务开始&quot;</span>);</span><br><span class="line">        <span class="type">CommonResp</span> <span class="variable">commonResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>();</span><br><span class="line">        List&lt;CronJobResp&gt; cronJobDtoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Scheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> schedulerFactoryBean.getScheduler();</span><br><span class="line">            <span class="keyword">for</span> (String groupName : scheduler.getJobGroupNames()) &#123;</span><br><span class="line">                <span class="keyword">for</span> (JobKey jobKey : scheduler.getJobKeys(GroupMatcher.jobGroupEquals(groupName))) &#123;</span><br><span class="line">                    <span class="type">CronJobResp</span> <span class="variable">cronJobResp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CronJobResp</span>();</span><br><span class="line">                    cronJobResp.setName(jobKey.getName());</span><br><span class="line">                    cronJobResp.setGroup(jobKey.getGroup());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//get job&#x27;s trigger</span></span><br><span class="line">                    List&lt;Trigger&gt; triggers = (List&lt;Trigger&gt;) scheduler.getTriggersOfJob(jobKey);</span><br><span class="line">                    <span class="type">CronTrigger</span> <span class="variable">cronTrigger</span> <span class="operator">=</span> (CronTrigger) triggers.get(<span class="number">0</span>);</span><br><span class="line">                    cronJobResp.setNextFireTime(cronTrigger.getNextFireTime());</span><br><span class="line">                    cronJobResp.setPreFireTime(cronTrigger.getPreviousFireTime());</span><br><span class="line">                    cronJobResp.setCronExpression(cronTrigger.getCronExpression());</span><br><span class="line">                    cronJobResp.setDescription(cronTrigger.getDescription());</span><br><span class="line">                    Trigger.<span class="type">TriggerState</span> <span class="variable">triggerState</span> <span class="operator">=</span> scheduler.getTriggerState(cronTrigger.getKey());</span><br><span class="line">                    cronJobResp.setState(triggerState.name());</span><br><span class="line"></span><br><span class="line">                    cronJobDtoList.add(cronJobResp);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;查看定时任务失败:&quot;</span> + e);</span><br><span class="line">            commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">            commonResp.setMessage(<span class="string">&quot;查看定时任务失败:调度异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        commonResp.setContent(cronJobDtoList);</span><br><span class="line">        LOG.info(<span class="string">&quot;查看定时任务结束：&#123;&#125;&quot;</span>, commonResp);</span><br><span class="line">        <span class="keyword">return</span> commonResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通过控台界面操作定时任务"><a href="#通过控台界面操作定时任务" class="headerlink" title="通过控台界面操作定时任务"></a>通过控台界面操作定时任务</h2><ul>
<li>首先新增菜单</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-menu-item key=&quot;/batch/job&quot;&gt;</span><br><span class="line">  &lt;router-link to=&quot;/batch/job&quot;&gt;</span><br><span class="line">    &lt;user-outlined/&gt;&amp;nbsp;任务管理</span><br><span class="line">  &lt;/router-link&gt;</span><br><span class="line">&lt;/a-menu-item&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后新增路由</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  &#123;</span><br><span class="line">  <span class="attr">path</span>:<span class="string">&#x27;batch/job&#x27;</span>,</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&#x27;batch/job&#x27;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/batch/job.vue&#x27;</span>),</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>最后基本就是一个增删改查界面</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;job&quot;&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">      &lt;a-button type=&quot;primary&quot; @click=&quot;handleAdd()&quot;&gt;</span><br><span class="line">        新增</span><br><span class="line">      &lt;/a-button&gt;&amp;nbsp;</span><br><span class="line">      &lt;a-button type=&quot;primary&quot; @click=&quot;handleQuery()&quot;&gt;</span><br><span class="line">        刷新</span><br><span class="line">      &lt;/a-button&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;a-table :dataSource=&quot;jobs&quot;</span><br><span class="line">             :columns=&quot;columns&quot;</span><br><span class="line">             :loading=&quot;loading&quot;&gt;</span><br><span class="line">      &lt;template #bodyCell=&quot;&#123; column, record &#125;&quot;&gt;</span><br><span class="line">        &lt;template v-if=&quot;column.dataIndex === &#x27;operation&#x27;&quot;&gt;</span><br><span class="line">          &lt;a-space&gt;</span><br><span class="line">            &lt;a-popconfirm</span><br><span class="line">                title=&quot;手动执行会立即执行一次，确定执行？&quot;</span><br><span class="line">                ok-text=&quot;是&quot;</span><br><span class="line">                cancel-text=&quot;否&quot;</span><br><span class="line">                @confirm=&quot;handleRun(record)&quot;</span><br><span class="line">            &gt;</span><br><span class="line">              &lt;a-button type=&quot;primary&quot; size=&quot;small&quot;&gt;</span><br><span class="line">                手动执行</span><br><span class="line">              &lt;/a-button&gt;</span><br><span class="line">            &lt;/a-popconfirm&gt;</span><br><span class="line">            &lt;a-popconfirm</span><br><span class="line">                title=&quot;确定重启？&quot;</span><br><span class="line">                ok-text=&quot;是&quot;</span><br><span class="line">                cancel-text=&quot;否&quot;</span><br><span class="line">                @confirm=&quot;handleResume(record)&quot;</span><br><span class="line">            &gt;</span><br><span class="line">              &lt;a-button v-show=&quot;record.state === &#x27;PAUSED&#x27; || record.state === &#x27;ERROR&#x27;&quot; type=&quot;primary&quot; size=&quot;small&quot;&gt;</span><br><span class="line">                重启</span><br><span class="line">              &lt;/a-button&gt;</span><br><span class="line">            &lt;/a-popconfirm&gt;</span><br><span class="line">            &lt;a-popconfirm</span><br><span class="line">                title=&quot;确定暂停？&quot;</span><br><span class="line">                ok-text=&quot;是&quot;</span><br><span class="line">                cancel-text=&quot;否&quot;</span><br><span class="line">                @confirm=&quot;handlePause(record)&quot;</span><br><span class="line">            &gt;</span><br><span class="line">              &lt;a-button v-show=&quot;record.state === &#x27;NORMAL&#x27; || record.state === &#x27;BLOCKED&#x27;&quot; type=&quot;primary&quot; size=&quot;small&quot;&gt;</span><br><span class="line">                暂停</span><br><span class="line">              &lt;/a-button&gt;</span><br><span class="line">            &lt;/a-popconfirm&gt;</span><br><span class="line">            &lt;a-button type=&quot;primary&quot; @click=&quot;handleEdit(record)&quot; size=&quot;small&quot;&gt;</span><br><span class="line">              编辑</span><br><span class="line">            &lt;/a-button&gt;</span><br><span class="line">            &lt;a-popconfirm</span><br><span class="line">                title=&quot;删除后不可恢复，确认删除?&quot;</span><br><span class="line">                ok-text=&quot;是&quot;</span><br><span class="line">                cancel-text=&quot;否&quot;</span><br><span class="line">                @confirm=&quot;handleDelete(record)&quot;</span><br><span class="line">            &gt;</span><br><span class="line">              &lt;a-button type=&quot;danger&quot; size=&quot;small&quot;&gt;</span><br><span class="line">                删除</span><br><span class="line">              &lt;/a-button&gt;</span><br><span class="line">            &lt;/a-popconfirm&gt;</span><br><span class="line">          &lt;/a-space&gt;</span><br><span class="line">        &lt;/template&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/a-table&gt;</span><br><span class="line"></span><br><span class="line">    &lt;a-modal</span><br><span class="line">        title=&quot;用户&quot;</span><br><span class="line">        v-model:visible=&quot;modalVisible&quot;</span><br><span class="line">        :confirm-loading=&quot;modalLoading&quot;</span><br><span class="line">        @ok=&quot;handleModalOk&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;a-form :model=&quot;job&quot; :label-col=&quot;&#123; span: 6 &#125;&quot; :wrapper-col=&quot;&#123; span: 18 &#125;&quot;&gt;</span><br><span class="line">        &lt;a-form-item label=&quot;类名&quot;&gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;job.name&quot; /&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line">        &lt;a-form-item label=&quot;描述&quot;&gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;job.description&quot; /&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line">        &lt;a-form-item label=&quot;分组&quot;&gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;job.group&quot; :disabled=&quot;!!job.state&quot;/&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line">        &lt;a-form-item label=&quot;表达式&quot;&gt;</span><br><span class="line">          &lt;a-input v-model:value=&quot;job.cronExpression&quot; /&gt;</span><br><span class="line">          &lt;div class=&quot;ant-alert ant-alert-success&quot;&gt;</span><br><span class="line">            每5秒执行一次：0/5 * * * * ?</span><br><span class="line">            &lt;br&gt;</span><br><span class="line">            每5分钟执行一次：* 0/5 * * * ?</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/a-form-item&gt;</span><br><span class="line">      &lt;/a-form&gt;</span><br><span class="line">    &lt;/a-modal&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; defineComponent, onMounted, ref &#125; from &#x27;vue&#x27;;</span><br><span class="line">import axios from &#x27;axios&#x27;;</span><br><span class="line">import &#123; notification &#125; from &#x27;ant-design-vue&#x27;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &#x27;batch-job-view&#x27;,</span><br><span class="line">  setup () &#123;</span><br><span class="line">    const jobs = ref();</span><br><span class="line">    const loading = ref();</span><br><span class="line"></span><br><span class="line">    const columns = [&#123;</span><br><span class="line">      title: &#x27;分组&#x27;,</span><br><span class="line">      dataIndex: &#x27;group&#x27;,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      title: &#x27;类名&#x27;,</span><br><span class="line">      dataIndex: &#x27;name&#x27;,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      title: &#x27;描述&#x27;,</span><br><span class="line">      dataIndex: &#x27;description&#x27;,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      title: &#x27;状态&#x27;,</span><br><span class="line">      dataIndex: &#x27;state&#x27;,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      title: &#x27;表达式&#x27;,</span><br><span class="line">      dataIndex: &#x27;cronExpression&#x27;,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      title: &#x27;上次时间&#x27;,</span><br><span class="line">      dataIndex: &#x27;preFireTime&#x27;,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      title: &#x27;下次时间&#x27;,</span><br><span class="line">      dataIndex: &#x27;nextFireTime&#x27;,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      title: &#x27;操作&#x27;,</span><br><span class="line">      dataIndex: &#x27;operation&#x27;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    const handleQuery = () =&gt; &#123;</span><br><span class="line">      loading.value = true;</span><br><span class="line">      jobs.value = [];</span><br><span class="line">      axios.get(&#x27;/batch/admin/job/query&#x27;).then((response) =&gt; &#123;</span><br><span class="line">        loading.value = false;</span><br><span class="line">        const data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          jobs.value = data.content;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // -------- 表单 ---------</span><br><span class="line">    const job = ref();</span><br><span class="line">    job.value = &#123;&#125;;</span><br><span class="line">    const modalVisible = ref(false);</span><br><span class="line">    const modalLoading = ref(false);</span><br><span class="line">    const handleModalOk = () =&gt; &#123;</span><br><span class="line">      modalLoading.value = true;</span><br><span class="line">      let url = &quot;add&quot;;</span><br><span class="line">      if (job.value.state) &#123;</span><br><span class="line">        url = &quot;reschedule&quot;;</span><br><span class="line">      &#125;</span><br><span class="line">      axios.post(&#x27;/batch/admin/job/&#x27; + url, job.value).then((response) =&gt; &#123;</span><br><span class="line">        modalLoading.value = false;</span><br><span class="line">        const data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          modalVisible.value = false;</span><br><span class="line">          notification.success(&#123;description: &quot;保存成功！&quot;&#125;);</span><br><span class="line">          handleQuery();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 新增</span><br><span class="line">     */</span><br><span class="line">    const handleAdd = () =&gt; &#123;</span><br><span class="line">      modalVisible.value = true;</span><br><span class="line">      job.value = &#123;</span><br><span class="line">        group: &#x27;DEFAULT&#x27;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 编辑</span><br><span class="line">     */</span><br><span class="line">    const handleEdit = (record) =&gt; &#123;</span><br><span class="line">      modalVisible.value = true;</span><br><span class="line">      job.value = Tool.copy(record);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 删除</span><br><span class="line">     */</span><br><span class="line">    const handleDelete = (record) =&gt; &#123;</span><br><span class="line">      axios.post(&#x27;/batch/admin/job/delete&#x27;, &#123;</span><br><span class="line">        name: record.name,</span><br><span class="line">        group: record.group</span><br><span class="line">      &#125;).then((response) =&gt; &#123;</span><br><span class="line">        const data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          notification.success(&#123;description: &quot;删除成功！&quot;&#125;);</span><br><span class="line">          handleQuery();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 暂停</span><br><span class="line">     */</span><br><span class="line">    const handlePause = (record) =&gt; &#123;</span><br><span class="line">      axios.post(&#x27;/batch/admin/job/pause&#x27;, &#123;</span><br><span class="line">        name: record.name,</span><br><span class="line">        group: record.group</span><br><span class="line">      &#125;).then((response) =&gt; &#123;</span><br><span class="line">        const data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          notification.success(&#123;description: &quot;暂停成功！&quot;&#125;);</span><br><span class="line">          handleQuery();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 重启</span><br><span class="line">     */</span><br><span class="line">    const handleResume = (record) =&gt; &#123;</span><br><span class="line">      axios.post(&#x27;/batch/admin/job/reschedule&#x27;, record).then((response) =&gt; &#123;</span><br><span class="line">        modalLoading.value = false;</span><br><span class="line">        const data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          modalVisible.value = false;</span><br><span class="line">          notification.success(&#123;description: &quot;重启成功！&quot;&#125;);</span><br><span class="line">          handleQuery();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 手动执行</span><br><span class="line">     */</span><br><span class="line">    const handleRun = (record) =&gt; &#123;</span><br><span class="line">      axios.post(&#x27;/batch/admin/job/run&#x27;, record).then((response) =&gt; &#123;</span><br><span class="line">        const data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          notification.success(&#123;description: &quot;手动执行成功！&quot;&#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const getEnumValue = (key, obj) =&gt; &#123;</span><br><span class="line">      return Tool.getEnumValue(key, obj);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">      console.log(&#x27;index mounted!&#x27;);</span><br><span class="line">      handleQuery();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      columns,</span><br><span class="line">      jobs,</span><br><span class="line">      loading,</span><br><span class="line">      handleQuery,</span><br><span class="line"></span><br><span class="line">      handleAdd,</span><br><span class="line">      handleEdit,</span><br><span class="line">      handleDelete,</span><br><span class="line">      handleResume,</span><br><span class="line">      handlePause,</span><br><span class="line">      job,</span><br><span class="line">      modalVisible,</span><br><span class="line">      modalLoading,</span><br><span class="line">      handleModalOk,</span><br><span class="line">      getEnumValue,</span><br><span class="line">      handleRun</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 对菜单做分类，改成两级菜单；路由也改为多级路由</p>
</blockquote>
<ul>
<li>改动the-sider.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-sub-menu key=&quot;batch&quot;&gt;</span><br><span class="line">  &lt;template #title&gt;</span><br><span class="line">    &lt;span&gt;</span><br><span class="line">      &lt;UnorderedListOutlined/&gt;</span><br><span class="line">      跑批管理</span><br><span class="line">    &lt;/span&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;a-menu-item key=&quot;/batch/job&quot;&gt;</span><br><span class="line">    &lt;router-link to=&quot;/batch/job&quot;&gt;</span><br><span class="line">      &lt;user-outlined/&gt;&amp;nbsp;任务管理</span><br><span class="line">    &lt;/router-link&gt;</span><br><span class="line">  &lt;/a-menu-item&gt;</span><br><span class="line">&lt;/a-sub-menu&gt;</span><br><span class="line"></span><br><span class="line">&lt;a-sub-menu key=&quot;base&quot;&gt;</span><br><span class="line">  &lt;template #title&gt;</span><br><span class="line">    &lt;span&gt;</span><br><span class="line">      &lt;UnorderedListOutlined/&gt;</span><br><span class="line">      基础数据</span><br><span class="line">    &lt;/span&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;a-menu-item key=&quot;/base/station&quot;&gt;</span><br><span class="line">    &lt;router-link to=&quot;/base/station&quot;&gt;</span><br><span class="line">      &lt;user-outlined/&gt;&amp;nbsp;车站管理</span><br><span class="line">    &lt;/router-link&gt;</span><br><span class="line">  &lt;/a-menu-item&gt;</span><br><span class="line">  &lt;a-menu-item key=&quot;/base/train&quot;&gt;</span><br><span class="line">    &lt;router-link to=&quot;/base/train&quot;&gt;</span><br><span class="line">      &lt;user-outlined/&gt;&amp;nbsp;火车管理</span><br><span class="line">    &lt;/router-link&gt;</span><br><span class="line">  &lt;/a-menu-item&gt;</span><br><span class="line">  &lt;a-menu-item key=&quot;/base/train-station&quot;&gt;</span><br><span class="line">    &lt;router-link to=&quot;/base/train-station&quot;&gt;</span><br><span class="line">      &lt;user-outlined/&gt;&amp;nbsp;火车车站</span><br><span class="line">    &lt;/router-link&gt;</span><br><span class="line">  &lt;/a-menu-item&gt;</span><br><span class="line">  &lt;a-menu-item key=&quot;/base/train-carriage&quot;&gt;</span><br><span class="line">    &lt;router-link to=&quot;/base/train-carriage&quot;&gt;</span><br><span class="line">      &lt;user-outlined/&gt;&amp;nbsp;火车车厢</span><br><span class="line">    &lt;/router-link&gt;</span><br><span class="line">  &lt;/a-menu-item&gt;</span><br><span class="line">  &lt;a-menu-item key=&quot;/base/train-seat&quot;&gt;</span><br><span class="line">    &lt;router-link to=&quot;/base/train-seat&quot;&gt;</span><br><span class="line">      &lt;user-outlined/&gt;&amp;nbsp;火车座位</span><br><span class="line">    &lt;/router-link&gt;</span><br><span class="line">  &lt;/a-menu-item&gt;</span><br><span class="line">&lt;/a-sub-menu&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>路由改动</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;main&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main.vue&#x27;</span>),</span><br><span class="line">    <span class="attr">children</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">      <span class="attr">path</span>:<span class="string">&#x27;welcome&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/welcome.vue&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">      <span class="attr">path</span>:<span class="string">&#x27;about&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/about.vue&#x27;</span>),</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;base/&#x27;</span>,</span><br><span class="line">        <span class="attr">children</span>:[</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">path</span>:<span class="string">&#x27;station&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/station.vue&#x27;</span>),</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">path</span>:<span class="string">&#x27;train&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/business/train.vue&#x27;</span>),</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">path</span>:<span class="string">&#x27;train-station&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/business/train-station.vue&#x27;</span>),</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">path</span>:<span class="string">&#x27;train-carriage&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/business/train-carriage.vue&#x27;</span>),</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">path</span>:<span class="string">&#x27;train-seat&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/business/train-seat.vue&#x27;</span>),</span><br><span class="line">          &#125;,</span><br><span class="line">        ]</span><br><span class="line">      &#125;,&#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;batch/&#x27;</span>,</span><br><span class="line">        <span class="attr">children</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">path</span>:<span class="string">&#x27;job&#x27;</span>,</span><br><span class="line">            <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/batch/job.vue&#x27;</span>),</span><br><span class="line">          &#125;,</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&#x27;/welcome&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(process.<span class="property">env</span>.<span class="property">BASE_URL</span>),</span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<ul>
<li>对了，还要在菜单的开头加上open-keys，这样菜单就是展开状态了</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-menu</span><br><span class="line">    v-model:selectedKeys=&quot;selectedKeys&quot;</span><br><span class="line">    :open-keys = &quot;[&#x27;batch&#x27;,&#x27;base&#x27;]&quot;</span><br><span class="line">    mode=&quot;inline&quot;</span><br><span class="line">    :style=&quot;&#123; height: &#x27;100%&#x27;, borderRight: 0 &#125;&quot;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改vue文件位置，保持层级关系和路由一致。<br>修改方法：只修改移动文件位置，路由index.ts自动会修改为新位置</p>
</blockquote>
<h2 id="增加任务手工补偿功能"><a href="#增加任务手工补偿功能" class="headerlink" title="增加任务手工补偿功能"></a>增加任务手工补偿功能</h2><ul>
<li>就是为了防止突发情况发生，我们自己手动调用一次（代码上面的就包括了），这玩意直接拷贝就行</li>
</ul>
<h2 id="演示多节点场景中quartz的调度情况"><a href="#演示多节点场景中quartz的调度情况" class="headerlink" title="演示多节点场景中quartz的调度情况"></a>演示多节点场景中quartz的调度情况</h2><ul>
<li>在启动应用时，通过加-Dserver.port&#x3D;18003，可以覆盖application.properties里的配置， quartz在多节点的场景中，是轮询执行定时任务（从现象看，单任务时是类似IP粘连的效果，就是谁先接手了谁就一直干）</li>
</ul>
<h1 id="通过火车基础数据生成每日火车数据"><a href="#通过火车基础数据生成每日火车数据" class="headerlink" title="通过火车基础数据生成每日火车数据"></a>通过火车基础数据生成每日火车数据</h1><p>本章介绍利用上一章知识，制作定时任务，定时生成每日车次信息，包含车次、车站、车箱、座位，同时也包括余票信息，为后续余票查询和售票功能做准备。当定时任务异常时，使用手动生成车次信息作为补偿的实现。</p>
<hr>
<h2 id="本章主要内容"><a href="#本章主要内容" class="headerlink" title="本章主要内容"></a>本章主要内容</h2><ul>
<li>增加每日车次数据维护功能：车次、车站、车厢、座位</li>
<li>增加定时任务：每天从车次基础数据生成每日车次数据</li>
</ul>
<h2 id="快速生成每日车次数据管理功能"><a href="#快速生成每日车次数据管理功能" class="headerlink" title="快速生成每日车次数据管理功能"></a>快速生成每日车次数据管理功能</h2><ul>
<li>首先在business的数据库中添加数据表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `daily_train`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `daily_train` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `<span class="type">date</span>` <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">  `code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `type` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次类型|枚举[TrainTypeEnum]&#x27;</span>,</span><br><span class="line">  `<span class="keyword">start</span>` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;始发站&#x27;</span>,</span><br><span class="line">  `start_pinyin` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;始发站拼音&#x27;</span>,</span><br><span class="line">  `start_time` <span class="type">time</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;出发时间&#x27;</span>,</span><br><span class="line">  `<span class="keyword">end</span>` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;终点站&#x27;</span>,</span><br><span class="line">  `end_pinyin` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;终点站拼音&#x27;</span>,</span><br><span class="line">  `end_time` <span class="type">time</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;到站时间&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  <span class="keyword">unique</span> key `date_code_unique` (`<span class="type">date</span>`, `code`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;每日车次&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后经过generator和前后端生成器生成一系列代码，接下来再前端增加一个菜单，如果想展开，就去前面:open-keys添加key</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-sub-menu key=&quot;business&quot;&gt;</span><br><span class="line">  &lt;template #title&gt;</span><br><span class="line">    &lt;span&gt;</span><br><span class="line">      &lt;UnorderedListOutlined/&gt;</span><br><span class="line">      业务管理</span><br><span class="line">    &lt;/span&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;a-menu-item key=&quot;/business/daily-train&quot;&gt;</span><br><span class="line">    &lt;router-link to=&quot;/business/daily-train&quot;&gt;</span><br><span class="line">      &lt;user-outlined/&gt;&amp;nbsp;每日车次</span><br><span class="line">    &lt;/router-link&gt;</span><br><span class="line">  &lt;/a-menu-item&gt;</span><br><span class="line">&lt;/a-sub-menu&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后一步就是设置路由</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">path</span>: <span class="string">&#x27;business/&#x27;</span>,</span><br><span class="line">  <span class="attr">children</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>:<span class="string">&#x27;daily-train&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>( <span class="string">&#x27;../views/main/business/daily-train.vue&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">  ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="完善每日车次管理页面功能"><a href="#完善每日车次管理页面功能" class="headerlink" title="完善每日车次管理页面功能"></a>完善每日车次管理页面功能</h2><blockquote>
<p>为每日车次表单增加车次下拉选择，并自动填充车次相关数据</p>
</blockquote>
<ul>
<li>修改daily-train.vue，修改车次标号处为</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;train-select-view v-model=&quot;dailyTrain.code&quot; @change=&quot;onChangeCode&quot;&gt;&lt;/train-select-view&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>自动填充就是靠change的事件传过来的train的信息</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">onChangeCode</span> = (<span class="params">train</span>) =&gt;&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;车次下拉组件选择：&quot;</span>,train)</span><br><span class="line">  <span class="keyword">let</span> t =<span class="title class_">Tool</span>.<span class="title function_">copy</span>(train);</span><br><span class="line">  <span class="keyword">delete</span> t.<span class="property">id</span>;</span><br><span class="line">  <span class="comment">//用assign合并</span></span><br><span class="line">  dailyTrain.<span class="property">value</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(dailyTrain.<span class="property">value</span>,t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为每日车次页面增加日期和车次查询条件。注意：GET请求的日期是拼接在URL里的，需要用spring自带的@DateTimeFormat（pattern&#x3D;”yyyy-MM-dd”），后端才能接收到参数</p>
</blockquote>
<ul>
<li>这里先修改后端，给DailyTrainQueryReq添加请求参数，他是请求日期和车次</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.req.PageReq;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DailyTrainQueryReq</span> <span class="keyword">extends</span> <span class="title class_">PageReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;DailyTrainQueryReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;date=&quot;</span>).append(date);</span><br><span class="line">        sb.append(<span class="string">&quot;, code=&#x27;&quot;</span>).append(code).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDate</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接着修改DailyTrainService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dailyTrainExample.setOrderByClause(<span class="string">&quot;date desc ,code asc&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotNull(req.getDate()))&#123;</span><br><span class="line">    criteria.andDateEqualTo(req.getDate());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotEmpty(req.getCode()))&#123;</span><br><span class="line">    criteria.andCodeEqualTo(req.getCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改daily-train.vue，增加查询框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-date-picker v-model:value=&quot;params.date&quot; valueFormat=&quot;YYYY-MM-DD&quot; placeholder=&quot;请选择日期&quot; /&gt;</span><br><span class="line">&lt;train-select-view v-model=&quot;params.code&quot;&gt;&lt;/train-select-view&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加参数定义</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> params =<span class="title function_">ref</span>(&#123;</span><br><span class="line">  <span class="attr">code</span>:<span class="literal">null</span>,</span><br><span class="line">  <span class="attr">date</span>:<span class="literal">null</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>handleQuery的请求接口后返回参数增加</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">code</span>: params.<span class="property">value</span>.<span class="property">code</span>,</span><br><span class="line"><span class="attr">date</span>: params.<span class="property">value</span>.<span class="property">date</span>,</span><br></pre></td></tr></table></figure>

<ul>
<li>最后将params返回</li>
</ul>
<h2 id="快速生成每日车站数据管理功能"><a href="#快速生成每日车站数据管理功能" class="headerlink" title="快速生成每日车站数据管理功能"></a>快速生成每日车站数据管理功能</h2><ul>
<li>增加数据表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `daily_train_station`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `daily_train_station` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `<span class="type">date</span>` <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">  `train_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `index` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;站序|第一站是0&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;站名&#x27;</span>,</span><br><span class="line">  `name_pinyin` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;站名拼音&#x27;</span>,</span><br><span class="line">  `in_time` <span class="type">time</span> comment <span class="string">&#x27;进站时间&#x27;</span>,</span><br><span class="line">  `out_time` <span class="type">time</span> comment <span class="string">&#x27;出站时间&#x27;</span>,</span><br><span class="line">  `stop_time` <span class="type">time</span> comment <span class="string">&#x27;停站时长&#x27;</span>,</span><br><span class="line">  `km` <span class="type">decimal</span>(<span class="number">8</span>, <span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;里程（公里）|从上一站到本站的距离&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  <span class="keyword">unique</span> key `date_train_code_index_unique` (`<span class="type">date</span>`, `train_code`, `index`),</span><br><span class="line">  <span class="keyword">unique</span> key `date_train_code_name_unique` (`<span class="type">date</span>`, `train_code`, `name`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;每日车站&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就可以代码生成器，增加菜单，增加路由了</li>
</ul>
<blockquote>
<p>完善每日车站页面，增加日期和车次查询条件</p>
</blockquote>
<ul>
<li>增加DailyTrainStationQueryReq的请求参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.req.PageReq;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DailyTrainStationQueryReq</span> <span class="keyword">extends</span> <span class="title class_">PageReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String trainCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDate</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrainCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrainCode</span><span class="params">(String trainCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trainCode = trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;DailyTrainStationQueryReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;date=&quot;</span>).append(date);</span><br><span class="line">        sb.append(<span class="string">&quot;, trainCode=&#x27;&quot;</span>).append(trainCode).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加判断条件DailyTrainStationService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dailyTrainStationExample.setOrderByClause(<span class="string">&quot;date desc ,train_code asc,`index` asc&quot;</span>);</span><br><span class="line">DailyTrainStationExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> dailyTrainStationExample.createCriteria();</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotNull(req.getDate()))&#123;</span><br><span class="line">    criteria.andDateEqualTo(req.getDate());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotEmpty(req.getTrainCode()))&#123;</span><br><span class="line">    criteria.andTrainCodeEqualTo(req.getTrainCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改对应daily-train-station前端，站名拼音和停站时长是不可见的</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-date-picker v-model:value=&quot;params.date&quot; valueFormat=&quot;YYYY-MM-DD&quot; placeholder=&quot;请选择日期&quot; /&gt;</span><br><span class="line">&lt;train-select-view v-model=&quot;params.trainCode&quot;&gt;&lt;/train-select-view&gt;</span><br><span class="line">&lt;a-form-item label=&quot;车次编号&quot;&gt;</span><br><span class="line">    &lt;train-select-view v-model=&quot;dailyTrainStation.trainCode&quot;&gt;&lt;/train-select-view&gt;</span><br><span class="line">&lt;/a-form-item&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义参数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> params =<span class="title function_">ref</span>(&#123;</span><br><span class="line">  <span class="attr">date</span>:<span class="literal">null</span>,</span><br><span class="line">  <span class="attr">trainCode</span>:<span class="literal">null</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>三个监听</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(<span class="function">()=&gt;</span>dailyTrainStation.<span class="property">value</span>.<span class="property">name</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isNotEmpty</span>(dailyTrainStation.<span class="property">value</span>.<span class="property">name</span>))&#123;</span><br><span class="line">    dailyTrainStation.<span class="property">value</span>.<span class="property">namePinyin</span> = <span class="title function_">pinyin</span>(dailyTrainStation.<span class="property">value</span>.<span class="property">name</span>,&#123;<span class="attr">toneType</span>:<span class="string">&#x27;none&#x27;</span>&#125;).<span class="title function_">replaceAll</span>(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    dailyTrainStation.<span class="property">value</span>.<span class="property">namePinyin</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,&#123;<span class="attr">immediate</span>:<span class="literal">true</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//自动计算停车时长</span></span><br><span class="line"><span class="title function_">watch</span>(<span class="function">()=&gt;</span> dailyTrainStation.<span class="property">value</span>.<span class="property">inTime</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> diff = <span class="title function_">dayjs</span>(dailyTrainStation.<span class="property">value</span>.<span class="property">outTime</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>).<span class="title function_">diff</span>( <span class="title function_">dayjs</span>(dailyTrainStation.<span class="property">value</span>.<span class="property">inTime</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>),<span class="string">&#x27;seconds&#x27;</span>);</span><br><span class="line">  dailyTrainStation.<span class="property">value</span>.<span class="property">stopTime</span> = <span class="title function_">dayjs</span>(<span class="string">&#x27;00:00:00&#x27;</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>).<span class="title function_">second</span>(diff).<span class="title function_">format</span>(<span class="string">&#x27;HH:mm:ss&#x27;</span>);</span><br><span class="line">&#125;,&#123;<span class="attr">immediate</span>:<span class="literal">true</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//自动计算停车时长</span></span><br><span class="line"><span class="title function_">watch</span>(<span class="function">()=&gt;</span> dailyTrainStation.<span class="property">value</span>.<span class="property">outTime</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> diff = <span class="title function_">dayjs</span>(dailyTrainStation.<span class="property">value</span>.<span class="property">outTime</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>).<span class="title function_">diff</span>( <span class="title function_">dayjs</span>(dailyTrainStation.<span class="property">value</span>.<span class="property">inTime</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>),<span class="string">&#x27;seconds&#x27;</span>);</span><br><span class="line">  dailyTrainStation.<span class="property">value</span>.<span class="property">stopTime</span> = <span class="title function_">dayjs</span>(<span class="string">&#x27;00:00:00&#x27;</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>).<span class="title function_">second</span>(diff).<span class="title function_">format</span>(<span class="string">&#x27;HH:mm:ss&#x27;</span>);</span><br><span class="line">&#125;,&#123;<span class="attr">immediate</span>:<span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>请求参数中添加查询条件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">trainCode</span>: params.<span class="property">value</span>.<span class="property">trainCode</span>,</span><br><span class="line"><span class="attr">date</span>: params.<span class="property">value</span>.<span class="property">date</span>,</span><br></pre></td></tr></table></figure>

<h2 id="快速生成每日车厢数据管理功能"><a href="#快速生成每日车厢数据管理功能" class="headerlink" title="快速生成每日车厢数据管理功能"></a>快速生成每日车厢数据管理功能</h2><blockquote>
<p>快速生成每日车厢数据管理功能</p>
</blockquote>
<ul>
<li>创建每日车厢数据表</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">drop table <span class="keyword">if</span> exists `daily_train_carriage`;</span><br><span class="line">create table `daily_train_carriage` (</span><br><span class="line">  `id` bigint not <span class="literal">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `date` date not <span class="literal">null</span> comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">  `train_code` varchar(<span class="number">20</span>) not <span class="literal">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `index` <span class="type">int</span> not <span class="literal">null</span> comment <span class="string">&#x27;箱序&#x27;</span>,</span><br><span class="line">  `seat_type` <span class="type">char</span>(<span class="number">1</span>) not <span class="literal">null</span> comment <span class="string">&#x27;座位类型|枚举[SeatTypeEnum]&#x27;</span>,</span><br><span class="line">  `seat_count` <span class="type">int</span> not <span class="literal">null</span> comment <span class="string">&#x27;座位数&#x27;</span>,</span><br><span class="line">  `row_count` <span class="type">int</span> not <span class="literal">null</span> comment <span class="string">&#x27;排数&#x27;</span>,</span><br><span class="line">  `col_count` <span class="type">int</span> not <span class="literal">null</span> comment <span class="string">&#x27;列数&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  primary <span class="title function_">key</span> <span class="params">(`id`)</span>,</span><br><span class="line">  unique key `date_train_code_index_unique` (`date`, `train_code`, `index`)</span><br><span class="line">) engine=innodb <span class="keyword">default</span> charset=utf8mb4 comment=<span class="string">&#x27;每日车厢&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就生成器，增加菜单，增加路由</li>
</ul>
<blockquote>
<p>增加了日期和车次查询条件</p>
</blockquote>
<ul>
<li>增加DailyTrainCarriageQueryReq的查询字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.req.PageReq;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DailyTrainCarriageQueryReq</span> <span class="keyword">extends</span> <span class="title class_">PageReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String trainCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDate</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrainCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrainCode</span><span class="params">(String trainCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trainCode = trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;DailyTrainCarriageQueryReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;date=&quot;</span>).append(date);</span><br><span class="line">        sb.append(<span class="string">&quot;, trainCode=&#x27;&quot;</span>).append(trainCode).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在DailyTrainCarriageService的查询方法中添加</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dailyTrainCarriageExample.setOrderByClause(<span class="string">&quot;date desc ,train_code asc,`index` asc&quot;</span>);</span><br><span class="line">DailyTrainCarriageExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> dailyTrainCarriageExample.createCriteria();</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotNull(req.getDate()))&#123;</span><br><span class="line">    criteria.andDateEqualTo(req.getDate());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotEmpty(req.getTrainCode()))&#123;</span><br><span class="line">    criteria.andTrainCodeEqualTo(req.getTrainCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>前端daily-train-carriage增加查询框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-date-picker v-model:value=&quot;params.date&quot; valueFormat=&quot;YYYY-MM-DD&quot; placeholder=&quot;请选择日期&quot; /&gt;</span><br><span class="line">&lt;train-select-view v-model=&quot;params.trainCode&quot;&gt;&lt;/train-select-view&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>车次编号也变成下拉框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;train-select-view v-model=&quot;dailyTrainCarriage.trainCode&quot;&gt;&lt;/train-select-view&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义参数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> params =<span class="title function_">ref</span>(&#123;</span><br><span class="line">  <span class="attr">date</span>:<span class="literal">null</span>,</span><br><span class="line">  <span class="attr">trainCode</span>:<span class="literal">null</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>在处理查询中添加参数，最后return下params</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">trainCode</span>: params.<span class="property">value</span>.<span class="property">trainCode</span>,</span><br><span class="line"><span class="attr">date</span>: params.<span class="property">value</span>.<span class="property">date</span>,</span><br></pre></td></tr></table></figure>

<ul>
<li>我们想让他自己计算座位数，首先把前端这俩给隐藏了</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--      &lt;a-form-item label=&quot;座位数&quot;&gt;--&gt;</span><br><span class="line">&lt;!--        &lt;a-input v-model:value=&quot;dailyTrainCarriage.seatCount&quot; /&gt;--&gt;</span><br><span class="line">&lt;!--      &lt;/a-form-item&gt;--&gt;</span><br><span class="line">      &lt;a-form-item label=&quot;排数&quot;&gt;</span><br><span class="line">        &lt;a-input v-model:value=&quot;dailyTrainCarriage.rowCount&quot; /&gt;</span><br><span class="line">      &lt;/a-form-item&gt;</span><br><span class="line">&lt;!--      &lt;a-form-item label=&quot;列数&quot;&gt;--&gt;</span><br><span class="line">&lt;!--        &lt;a-input v-model:value=&quot;dailyTrainCarriage.colCount&quot; /&gt;--&gt;</span><br><span class="line">&lt;!--      &lt;/a-form-item&gt;--&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>然后把DailyTrainCarriageSaveReq对应的注解校验给注释了</p>
</li>
<li><p>最后在DailyTrainCarriageService中的save方法中添加</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自动计算出列数和总座位数</span></span><br><span class="line"></span><br><span class="line">List&lt;SeatColEnum&gt; seatColEnums = SeatColEnum.getColsByType(req.getSeatType());</span><br><span class="line">req.setColCount(seatColEnums.size());</span><br><span class="line">req.setSeatCount(req.getColCount() * req.getRowCount());</span><br></pre></td></tr></table></figure>

<h2 id="快速生成每日座位数据管理功能"><a href="#快速生成每日座位数据管理功能" class="headerlink" title="快速生成每日座位数据管理功能"></a>快速生成每日座位数据管理功能</h2><ul>
<li>首先创建每日座位表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `daily_train_seat`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `daily_train_seat` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `<span class="type">date</span>` <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">  `train_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `carriage_index` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;箱序&#x27;</span>,</span><br><span class="line">  `<span class="type">row</span>` <span class="type">char</span>(<span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;排号|01, 02&#x27;</span>,</span><br><span class="line">  `col` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;列号|枚举[SeatColEnum]&#x27;</span>,</span><br><span class="line">  `seat_type` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;座位类型|枚举[SeatTypeEnum]&#x27;</span>,</span><br><span class="line">  `carriage_seat_index` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;同车箱座序&#x27;</span>,</span><br><span class="line">  `sell` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;售卖情况|将经过的车站用01拼接，0表示可卖，1表示已卖&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;每日座位&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就生成器（生成只读的vue），增加菜单，增加路由</li>
</ul>
<blockquote>
<p>修改每日座位页面，增加车次查询条件，修改列号的显示</p>
</blockquote>
<ul>
<li>给DailyTrainSeatQueryReq增加字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.req.PageReq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DailyTrainSeatQueryReq</span> <span class="keyword">extends</span> <span class="title class_">PageReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String trainCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrainCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;TrainSeatQueryReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;trainCode=&#x27;&quot;</span>).append(trainCode).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrainCode</span><span class="params">(String trainCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trainCode = trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在DailyTrainSeatService中查询方法增加</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dailyTrainSeatExample.setOrderByClause(<span class="string">&quot;train_code asc,carriage_index asc,carriage_seat_index asc&quot;</span>);</span><br><span class="line">DailyTrainSeatExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> dailyTrainSeatExample.createCriteria();</span><br><span class="line"><span class="keyword">if</span> (ObjectUtil.isNotEmpty(req.getTrainCode()))&#123;</span><br><span class="line">    criteria.andTrainCodeEqualTo(req.getTrainCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后这个就是前端代码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;p&gt;</span><br><span class="line">    &lt;a-space&gt;</span><br><span class="line">      &lt;train-select-view v-model=&quot;params.trainCode&quot;&gt;&lt;/train-select-view&gt;</span><br><span class="line">      &lt;a-button type=&quot;primary&quot; @click=&quot;handleQuery()&quot;&gt;查询&lt;/a-button&gt;</span><br><span class="line">    &lt;/a-space&gt;</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line">  &lt;a-table :dataSource=&quot;dailyTrainSeats&quot;</span><br><span class="line">           :columns=&quot;columns&quot;</span><br><span class="line">           :pagination=&quot;pagination&quot;</span><br><span class="line">           @change=&quot;handleTableChange&quot;</span><br><span class="line">           :loading=&quot;loading&quot;&gt;</span><br><span class="line">    &lt;template #bodyCell=&quot;&#123; column, record &#125;&quot;&gt;</span><br><span class="line">      &lt;template v-if=&quot;column.dataIndex === &#x27;operation&#x27;&quot;&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;template v-else-if=&quot;column.dataIndex === &#x27;col&#x27;&quot;&gt;</span><br><span class="line">        &lt;span v-for=&quot;item in SEAT_COL_ARRAY&quot; :key=&quot;item.code&quot;&gt;</span><br><span class="line">          &lt;span v-if=&quot;item.code === record.col &amp;&amp; item.type === record.seatType&quot;&gt;</span><br><span class="line">            &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">          &lt;/span&gt;</span><br><span class="line">        &lt;/span&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;template v-else-if=&quot;column.dataIndex === &#x27;seatType&#x27;&quot;&gt;</span><br><span class="line">        &lt;span v-for=&quot;item in SEAT_TYPE_ARRAY&quot; :key=&quot;item.code&quot;&gt;</span><br><span class="line">          &lt;span v-if=&quot;item.code === record.seatType&quot;&gt;</span><br><span class="line">            &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">          &lt;/span&gt;</span><br><span class="line">        &lt;/span&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">  &lt;/a-table&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; defineComponent, ref, onMounted &#125; from &#x27;vue&#x27;;</span><br><span class="line">import &#123;notification&#125; from &quot;ant-design-vue&quot;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import TrainSelectView from &quot;@/components/train-select&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;daily-train-seat-view&quot;,</span><br><span class="line">  components: &#123;TrainSelectView&#125;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const SEAT_COL_ARRAY = window.SEAT_COL_ARRAY;</span><br><span class="line">    const SEAT_TYPE_ARRAY = window.SEAT_TYPE_ARRAY;</span><br><span class="line">    const visible = ref(false);</span><br><span class="line">    let dailyTrainSeat = ref(&#123;</span><br><span class="line">      id: undefined,</span><br><span class="line">      date: undefined,</span><br><span class="line">      trainCode: undefined,</span><br><span class="line">      carriageIndex: undefined,</span><br><span class="line">      row: undefined,</span><br><span class="line">      col: undefined,</span><br><span class="line">      seatType: undefined,</span><br><span class="line">      carriageSeatIndex: undefined,</span><br><span class="line">      sell: undefined,</span><br><span class="line">      createTime: undefined,</span><br><span class="line">      updateTime: undefined,</span><br><span class="line">    &#125;);</span><br><span class="line">    const dailyTrainSeats = ref([]);</span><br><span class="line">    // 分页的三个属性名是固定的</span><br><span class="line">    const pagination = ref(&#123;</span><br><span class="line">      total: 0,</span><br><span class="line">      current: 1,</span><br><span class="line">      pageSize: 10,</span><br><span class="line">    &#125;);</span><br><span class="line">    let loading = ref(false);</span><br><span class="line">    let params = ref(&#123;</span><br><span class="line">      trainCode: null</span><br><span class="line">    &#125;);</span><br><span class="line">    const columns = [</span><br><span class="line">      &#123;</span><br><span class="line">        title: &#x27;日期&#x27;,</span><br><span class="line">        dataIndex: &#x27;date&#x27;,</span><br><span class="line">        key: &#x27;date&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        title: &#x27;车次编号&#x27;,</span><br><span class="line">        dataIndex: &#x27;trainCode&#x27;,</span><br><span class="line">        key: &#x27;trainCode&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        title: &#x27;箱序&#x27;,</span><br><span class="line">        dataIndex: &#x27;carriageIndex&#x27;,</span><br><span class="line">        key: &#x27;carriageIndex&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        title: &#x27;排号&#x27;,</span><br><span class="line">        dataIndex: &#x27;row&#x27;,</span><br><span class="line">        key: &#x27;row&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        title: &#x27;列号&#x27;,</span><br><span class="line">        dataIndex: &#x27;col&#x27;,</span><br><span class="line">        key: &#x27;col&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        title: &#x27;座位类型&#x27;,</span><br><span class="line">        dataIndex: &#x27;seatType&#x27;,</span><br><span class="line">        key: &#x27;seatType&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        title: &#x27;同车箱座序&#x27;,</span><br><span class="line">        dataIndex: &#x27;carriageSeatIndex&#x27;,</span><br><span class="line">        key: &#x27;carriageSeatIndex&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        title: &#x27;售卖情况&#x27;,</span><br><span class="line">        dataIndex: &#x27;sell&#x27;,</span><br><span class="line">        key: &#x27;sell&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    const handleQuery = (param) =&gt; &#123;</span><br><span class="line">      if (!param) &#123;</span><br><span class="line">        param = &#123;</span><br><span class="line">          page: 1,</span><br><span class="line">          size: pagination.value.pageSize</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      loading.value = true;</span><br><span class="line">      axios.get(&quot;/business/admin/daily-train-seat/query-list&quot;, &#123;</span><br><span class="line">        params: &#123;</span><br><span class="line">          page: param.page,</span><br><span class="line">          size: param.size,</span><br><span class="line">          trainCode: params.value.trainCode</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then((response) =&gt; &#123;</span><br><span class="line">        loading.value = false;</span><br><span class="line">        let data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          dailyTrainSeats.value = data.content.list;</span><br><span class="line">          // 设置分页控件的值</span><br><span class="line">          pagination.value.current = param.page;</span><br><span class="line">          pagination.value.total = data.content.total;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleTableChange = (page) =&gt; &#123;</span><br><span class="line">      // console.log(&quot;看看自带的分页参数都有啥：&quot; + JSON.stringify(page));</span><br><span class="line">      pagination.value.pageSize = page.pageSize;</span><br><span class="line">      handleQuery(&#123;</span><br><span class="line">        page: page.current,</span><br><span class="line">        size: page.pageSize</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">      handleQuery(&#123;</span><br><span class="line">        page: 1,</span><br><span class="line">        size: pagination.value.pageSize</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      SEAT_COL_ARRAY,</span><br><span class="line">      SEAT_TYPE_ARRAY,</span><br><span class="line">      dailyTrainSeat,</span><br><span class="line">      visible,</span><br><span class="line">      dailyTrainSeats,</span><br><span class="line">      pagination,</span><br><span class="line">      columns,</span><br><span class="line">      handleTableChange,</span><br><span class="line">      handleQuery,</span><br><span class="line">      loading,</span><br><span class="line">      params</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="增加生成每日车次定时任务"><a href="#增加生成每日车次定时任务" class="headerlink" title="增加生成每日车次定时任务"></a>增加生成每日车次定时任务</h2><ul>
<li>实现跑批功能时，要想好补偿方案，有时候补偿方案不只一个</li>
<li>补偿的场景有很多，比如发现跑批生成数据不全，或者因政策变化或数据调整，需要重新生成数据</li>
<li>quartz默认的线程池是10，也就是说同时可以跑10个任务，多了就排队</li>
<li>定时任务不会经过日志拦截器，所以不会有日志跟踪号，需要MDC.put，异步线程也会没有日志跟踪号，同样需要MDC.put</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307181422420.png"
                      alt="image-20230718142209944"
                ></p>
<blockquote>
<p>增加生成每日车次定时任务</p>
</blockquote>
<ul>
<li>在batch的job软件包下增加任务</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.job;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> org.quartz.DisallowConcurrentExecution;</span><br><span class="line"><span class="keyword">import</span> org.quartz.Job;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.MDC;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DisallowConcurrentExecution</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DailyTrainJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(DailyTrainJob.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">        MDC.put(<span class="string">&quot;LOG_ID&quot;</span>,System.currentTimeMillis() + RandomUtil.randomString(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">&quot;生成每日车次数据开始&quot;</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;生成每日车次数据结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="集成OpenFeign实现服务间调用"><a href="#集成OpenFeign实现服务间调用" class="headerlink" title="集成OpenFeign实现服务间调用"></a>集成OpenFeign实现服务间调用</h2><ul>
<li>正常项目中，跑批的核心功能，都应该在batch模块里执行，也就是说得在batch模块里，重新生成一遍train相关表的持久层，正常项目就应该这样做，让业务模块和跑批完全隔离开，不至于因为跑批性能差而影响了业务的开展。</li>
<li>本项目因为是演示项目，就不花这个时间做重复生成持久层了，直接调用business接口，刚好可以学习微服务的服务间调用组件feign（openfeign）</li>
<li>Feign是Netflix公司开发的一个声明式的 REST 调用客户端，SpringCloud的早期，就是将各种第三方组件，整合到SpringBoot项目里，形成了SpringCloud，现在慢慢的把第三方组件替换成自研的组件，比如gateway组件</li>
<li>OpenFeign是在Feign的基础上，增加SpringMVC注解，让代码写起来像在写Controller</li>
<li>使用spring.application.name可以给各应用起一个名字，方便应用之间互相认识，在注册中心、配置中心、路由、服务调用、限流等微服务组件中，都会用到。</li>
<li>例如我们的batch模块想要调用business，这样就把依赖添加到batch模块中</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--远程调用openfeign--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--openfeign默认使用loadBalance的负载均衡器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>我们在每个模块的配置里添加各自名称，方便以后使用，因为现在还没有注册中心，所以他们没有生效</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=member</span><br></pre></td></tr></table></figure>

<ul>
<li>我们把以后要调用的方法都放到batch的feign软件包下例如</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.feign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(name=&quot;business&quot;,url=&quot;http://127.0.0.1:8002/business&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BusinessFeign</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/business/test&quot;)</span></span><br><span class="line">    String <span class="title function_">hello</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>要是想让其生效，就在batch的启动类上添加</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(&quot;com.fzx.train.batch.feign&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用方法如下所示</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.batch.feign.BusinessFeign;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(TestController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    BusinessFeign businessFeign;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span>  String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">businessHello</span> <span class="operator">=</span> businessFeign.hello();</span><br><span class="line">        LOG.info(businessHello);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello Batch&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="增加生成每日车次功能"><a href="#增加生成每日车次功能" class="headerlink" title="增加生成每日车次功能"></a>增加生成每日车次功能</h2><ul>
<li>注解支持和方法写在同一行，多个注解也支持写在同一行</li>
<li>养成习惯，得到列表后，先判下空，防止空指针异常</li>
<li>首先我们将TrainService的queryAll方法，提取成两个方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;TrainQueryResp&gt; <span class="title function_">queryAll</span><span class="params">( )</span>&#123;</span><br><span class="line">    List&lt;Train&gt; trainList = selectAll();</span><br><span class="line">    <span class="keyword">return</span> BeanUtil.copyToList(trainList, TrainQueryResp.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;Train&gt; <span class="title function_">selectAll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">TrainExample</span> <span class="variable">trainExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainExample</span>();</span><br><span class="line">    trainExample.setOrderByClause(<span class="string">&quot;code asc&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> trainMapper.selectByExample(trainExample);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后在DailyTrainService中引用该类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> TrainService trainService;</span><br></pre></td></tr></table></figure>

<ul>
<li>在DailyTrainService中增加方法，为什么要在for循环里，是为了车次的高内聚低耦合</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成某日所有车次信息,包括车次、车站、车厢。座位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> date</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">genDaily</span><span class="params">(Date date)</span>&#123;</span><br><span class="line">    List&lt;Train&gt; trainList = trainService.selectAll();</span><br><span class="line">    <span class="keyword">if</span> (CollUtil.isEmpty(trainList))&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;没有车次基础数据，任务结束&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Train train : trainList)&#123;</span><br><span class="line">        genDailyTrain(date,train);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">genDailyTrain</span><span class="params">(Date date,Train train)</span>&#123;</span><br><span class="line">    <span class="comment">//删除该车次已有的数据</span></span><br><span class="line">    <span class="type">DailyTrainExample</span> <span class="variable">dailyTrainExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainExample</span>();</span><br><span class="line">    dailyTrainExample.createCriteria()</span><br><span class="line">            .andDateEqualTo(date)</span><br><span class="line">            .andCodeEqualTo(train.getCode());</span><br><span class="line">    dailyTrainMapper.deleteByExample(dailyTrainExample);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成该车次的数据</span></span><br><span class="line">    <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">    <span class="type">DailyTrain</span> <span class="variable">dailyTrain</span> <span class="operator">=</span> BeanUtil.copyProperties(train, DailyTrain.class);</span><br><span class="line">    dailyTrain.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">    dailyTrain.setCreateTime(now);</span><br><span class="line">    dailyTrain.setUpdateTime(now);</span><br><span class="line">    dailyTrain.setDate(date);</span><br><span class="line">    dailyTrainMapper.insert(dailyTrain);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接口调用DailyTrainAdminController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/gen-daily/&#123;date&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;Object&gt; <span class="title function_">genDaily</span><span class="params">(<span class="meta">@PathVariable</span> <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date date)</span>&#123;</span><br><span class="line">    dailyTrainService.genDaily(date);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在BusinessFeign中定义该接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.feign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(name=&quot;business&quot;,url=&quot;http://127.0.0.1:8002/business&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BusinessFeign</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin/daily-train/gen-daily/&#123;date&#125;&quot;)</span></span><br><span class="line">    CommonResp&lt;Object&gt; <span class="title function_">genDaily</span><span class="params">(<span class="meta">@PathVariable</span> <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date date)</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在DailyTrainJob中使用BusinessFeign，并传参</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.job;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateTime;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.batch.feign.BusinessFeign;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.quartz.DisallowConcurrentExecution;</span><br><span class="line"><span class="keyword">import</span> org.quartz.Job;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.MDC;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DisallowConcurrentExecution</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DailyTrainJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(DailyTrainJob.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    BusinessFeign businessFeign;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">        MDC.put(<span class="string">&quot;LOG_ID&quot;</span>,System.currentTimeMillis() + RandomUtil.randomString(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">&quot;生成15天后的车次数据开始&quot;</span>);</span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">DateTime</span> <span class="variable">dateTime</span> <span class="operator">=</span> DateUtil.offsetDay(date, <span class="number">15</span>);</span><br><span class="line">        <span class="type">Date</span> <span class="variable">offsetDate</span> <span class="operator">=</span> dateTime.toJdkDate();</span><br><span class="line">        CommonResp&lt;Object&gt; commonResp = businessFeign.genDaily(offsetDate);</span><br><span class="line">        LOG.info(<span class="string">&quot;生成15天后的 车次数据结束,结果：&#123;&#125;&quot;</span>,commonResp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="增加生成每日车站功能"><a href="#增加生成每日车站功能" class="headerlink" title="增加生成每日车站功能"></a>增加生成每日车站功能</h2><ul>
<li>首先在TrainStationService中定义查询所有车站的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;TrainStation&gt; <span class="title function_">selectByTrainCode</span><span class="params">(String trainCode )</span> &#123;</span><br><span class="line">    <span class="type">TrainStationExample</span> <span class="variable">trainStationExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainStationExample</span>();</span><br><span class="line">    trainStationExample.setOrderByClause(<span class="string">&quot;`index` asc&quot;</span>);</span><br><span class="line">    trainStationExample.createCriteria().andTrainCodeEqualTo(trainCode);</span><br><span class="line">    <span class="keyword">return</span> trainStationMapper.selectByExample(trainStationExample);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来在DailyTrainStationService中使用该方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> TrainStationService trainStationService;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">genDaily</span><span class="params">(Date date , String trainCode)</span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;生成日期【&#123;&#125;】车次【&#123;&#125;】的车站信息开始&quot;</span>, DateUtil.formatDate(date), trainCode);</span><br><span class="line">        <span class="comment">//删除某日某车次的车站信息</span></span><br><span class="line">        <span class="type">DailyTrainStationExample</span> <span class="variable">dailyTrainStationExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainStationExample</span>();</span><br><span class="line">        dailyTrainStationExample.createCriteria()</span><br><span class="line">                .andDateEqualTo(date)</span><br><span class="line">                .andTrainCodeEqualTo(trainCode);</span><br><span class="line">        dailyTrainStationMapper.deleteByExample(dailyTrainStationExample);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查出某车次的所有的车站信息</span></span><br><span class="line">        List&lt;TrainStation&gt; stationList= trainStationService.selectByTrainCode(trainCode);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isEmpty(stationList))&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;没有车次没有车站基础数据，生成该车次的车站信息任务结束&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (TrainStation trainStation : stationList)&#123;</span><br><span class="line">            <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">            <span class="type">DailyTrainStation</span> <span class="variable">dailyTrainStation</span> <span class="operator">=</span> BeanUtil.copyProperties(trainStation, DailyTrainStation.class);</span><br><span class="line">            dailyTrainStation.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">            dailyTrainStation.setCreateTime(now);</span><br><span class="line">            dailyTrainStation.setUpdateTime(now);</span><br><span class="line">            dailyTrainStation.setDate(date);</span><br><span class="line">            dailyTrainStationMapper.insert(dailyTrainStation);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;生成日期【&#123;&#125;】车次【&#123;&#125;】的车站信息结束&quot;</span>, DateUtil.formatDate(date), trainCode);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来在DailyTrainService中genDailyTrain的最后调用生成车站方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DailyTrainStationService dailyTrainStationService;</span><br><span class="line"></span><br><span class="line">dailyTrainStationService.genDaily(date,train.getCode());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="增加生成每日车厢功能"><a href="#增加生成每日车厢功能" class="headerlink" title="增加生成每日车厢功能"></a>增加生成每日车厢功能</h2><ul>
<li>同上在DailyTrainCarriageService中引用TrainCarriageService查询方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> TrainCarriageService trainCarriageService;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">genDaily</span><span class="params">(Date date , String trainCode)</span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;生成日期【&#123;&#125;】车次【&#123;&#125;】的车厢信息开始&quot;</span>, DateUtil.formatDate(date), trainCode);</span><br><span class="line">        <span class="comment">//删除某日某车次的车厢信息</span></span><br><span class="line">        <span class="type">DailyTrainCarriageExample</span> <span class="variable">dailyTrainCarriageExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainCarriageExample</span>();</span><br><span class="line">        dailyTrainCarriageExample.createCriteria()</span><br><span class="line">                .andDateEqualTo(date)</span><br><span class="line">                .andTrainCodeEqualTo(trainCode);</span><br><span class="line">        dailyTrainCarriageMapper.deleteByExample(dailyTrainCarriageExample);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查出某车次的所有的车厢信息</span></span><br><span class="line">        List&lt;TrainCarriage&gt; carriageList= trainCarriageService.selectByTrainCode(trainCode);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isEmpty(carriageList))&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;没有车次没有车厢基础数据，生成该车次的车厢信息任务结束&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (TrainCarriage trainCarriage : carriageList)&#123;</span><br><span class="line">            <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">            <span class="type">DailyTrainCarriage</span> <span class="variable">dailyTrainCarriage</span> <span class="operator">=</span> BeanUtil.copyProperties(trainCarriage, DailyTrainCarriage.class);</span><br><span class="line">            dailyTrainCarriage.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">            dailyTrainCarriage.setCreateTime(now);</span><br><span class="line">            dailyTrainCarriage.setUpdateTime(now);</span><br><span class="line">            dailyTrainCarriage.setDate(date);</span><br><span class="line">            dailyTrainCarriageMapper.insert(dailyTrainCarriage);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;生成日期【&#123;&#125;】车次【&#123;&#125;】的车厢信息结束&quot;</span>, DateUtil.formatDate(date), trainCode);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在DailyTrainService的genDailyTrain方法最后调用genDaily</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DailyTrainCarriageService dailyTrainCarriageService;</span><br><span class="line">  <span class="comment">//生成该车次的车车厢数据</span></span><br><span class="line">dailyTrainCarriageService.genDaily(date,train.getCode());</span><br></pre></td></tr></table></figure>

<h2 id="增加生成每日座位功能"><a href="#增加生成每日座位功能" class="headerlink" title="增加生成每日座位功能"></a>增加生成每日座位功能</h2><blockquote>
<p> sell初始信息都是0，表示都没卖过票，每个站都可买，5个站就初始化4个0</p>
</blockquote>
<ul>
<li>首先在TrainSeatService增加查询功能</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;TrainSeat&gt; <span class="title function_">selectByTrainCode</span><span class="params">(String trainCode)</span>&#123;</span><br><span class="line">    <span class="type">TrainSeatExample</span> <span class="variable">trainSeatExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrainSeatExample</span>();</span><br><span class="line">    trainSeatExample.setOrderByClause(<span class="string">&quot;`id` asc&quot;</span>);</span><br><span class="line">    TrainSeatExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> trainSeatExample.createCriteria();</span><br><span class="line">    criteria.andTrainCodeEqualTo(trainCode);</span><br><span class="line">    <span class="keyword">return</span> trainSeatMapper.selectByExample(trainSeatExample);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改DailyTrainSeatService，他比其他的多了一个售价</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> TrainSeatService trainSeatService;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> TrainStationService trainStationService;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">genDaily</span><span class="params">(Date date , String trainCode)</span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;生成日期【&#123;&#125;】车次【&#123;&#125;】的座位信息开始&quot;</span>, DateUtil.formatDate(date), trainCode);</span><br><span class="line">        <span class="comment">//删除某日某车次的座位信息</span></span><br><span class="line">        <span class="type">DailyTrainSeatExample</span> <span class="variable">dailyTrainSeatExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainSeatExample</span>();</span><br><span class="line">        dailyTrainSeatExample.createCriteria()</span><br><span class="line">                .andDateEqualTo(date)</span><br><span class="line">                .andTrainCodeEqualTo(trainCode);</span><br><span class="line">        dailyTrainSeatMapper.deleteByExample(dailyTrainSeatExample);</span><br><span class="line"></span><br><span class="line">        List&lt;TrainStation&gt; stationList = trainStationService.selectByTrainCode(trainCode);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sell</span> <span class="operator">=</span> StrUtil.fillBefore(<span class="string">&quot;&quot;</span>,<span class="string">&#x27;0&#x27;</span>,stationList.size()-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//查出某车次的所有的座位信息</span></span><br><span class="line">        List&lt;TrainSeat&gt; seatList= trainSeatService.selectByTrainCode(trainCode);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isEmpty(seatList))&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;没有车次没有座位基础数据，生成该车次的座位信息任务结束&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (TrainSeat trainSeat : seatList)&#123;</span><br><span class="line">            <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">            <span class="type">DailyTrainSeat</span> <span class="variable">dailyTrainSeat</span> <span class="operator">=</span> BeanUtil.copyProperties(trainSeat, DailyTrainSeat.class);</span><br><span class="line">            dailyTrainSeat.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">            dailyTrainSeat.setCreateTime(now);</span><br><span class="line">            dailyTrainSeat.setUpdateTime(now);</span><br><span class="line">            dailyTrainSeat.setDate(date);</span><br><span class="line">            dailyTrainSeat.setSell(sell);</span><br><span class="line">            dailyTrainSeatMapper.insert(dailyTrainSeat);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;生成日期【&#123;&#125;】车次【&#123;&#125;】的座位信息结束&quot;</span>, DateUtil.formatDate(date), trainCode);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在DailyTrainService中一块生成</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DailyTrainSeatService dailyTrainSeatService;</span><br><span class="line"></span><br><span class="line"><span class="comment">//生成该车次的座位数据</span></span><br><span class="line">dailyTrainSeatService.genDaily(date,train.getCode());       </span><br></pre></td></tr></table></figure>

<h2 id="增加手动生成某日车次数据功能"><a href="#增加手动生成某日车次数据功能" class="headerlink" title="增加手动生成某日车次数据功能"></a>增加手动生成某日车次数据功能</h2><blockquote>
<p>增加手动生成某日车次数据功能，并增加确认Lodaing效果</p>
</blockquote>
<ul>
<li><p>table的分页绑定的是pagination这个响应式变量，所以想改变表格的每页条数，就得改变pagination的pageSize(番外话)</p>
</li>
<li><p>我们首先修改下DailyTrainSeatService，让其变成先按照日期排序</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dailyTrainSeatExample.setOrderByClause(<span class="string">&quot;date desc, train_code asc,carriage_index asc,carriage_seat_index asc&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在daily-train中添加新增日期数据的按钮</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-button type=&quot;danger&quot; @click=&quot;onClickGenDaily&quot;&gt;手动生成车次信息&lt;/a-button&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后增加一个模态框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-modal v-model:visible=&quot;genDailyVisible&quot; title=&quot;生成车次&quot; @ok=&quot;handleGenDailyOk&quot;</span><br><span class="line">         :confirm-loading=&quot;genDailyLoading&quot; ok-text=&quot;确认&quot; cancel-text=&quot;取消&quot;&gt;</span><br><span class="line">  &lt;a-form :model=&quot;genDaily&quot; :label-col=&quot;&#123;span:4&#125;&quot; :wrapper-col=&quot;&#123;span:20&#125;&quot;&gt;</span><br><span class="line">    &lt;a-form-item label=&quot;日期&quot;&gt;</span><br><span class="line">      &lt;a-date-picker v-model:value=&quot;genDaily.date&quot;  placeholder=&quot;请选择日期&quot;/&gt;</span><br><span class="line">    &lt;/a-form-item&gt;</span><br><span class="line">  &lt;/a-form&gt;</span><br><span class="line">&lt;/a-modal&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义变量</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> genDaily = <span class="title function_">ref</span>(&#123;</span><br><span class="line">  <span class="attr">date</span>:<span class="literal">null</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> genDailyVisible = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="keyword">const</span> genDailyLoading = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>增加方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">onClickGenDaily</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">  genDailyVisible.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleGenDailyOk</span> =(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">  <span class="keyword">let</span> date = <span class="title function_">dayjs</span>(genDaily.<span class="property">value</span>.<span class="property">date</span>).<span class="title function_">format</span>(<span class="string">&quot;YYYY-MM-DD&quot;</span>);</span><br><span class="line">  genDailyLoading.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(date)</span><br><span class="line">  axios.<span class="title function_">get</span>(<span class="string">&quot;/business/admin/daily-train/gen-daily/&quot;</span>+ date).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span>&#123;</span><br><span class="line">    genDailyLoading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">      notification.<span class="title function_">success</span>(&#123;<span class="attr">description</span>:<span class="string">&quot;成功!&quot;</span>&#125;);</span><br><span class="line">      genDailyVisible.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">      <span class="title function_">handleQuery</span>(&#123;</span><br><span class="line">        <span class="attr">page</span>:pagination.<span class="property">value</span>.<span class="property">current</span>,</span><br><span class="line">        <span class="attr">size</span>:pagination.<span class="property">value</span>.<span class="property">pageSize</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      notification.<span class="title function_">success</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>return以下</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">genDaily,</span><br><span class="line">genDailyVisible,</span><br><span class="line">handleGenDailyOk,</span><br><span class="line">onClickGenDaily,</span><br><span class="line">genDailyLoading</span><br></pre></td></tr></table></figure>

<h1 id="基本的车票预定功能开发"><a href="#基本的车票预定功能开发" class="headerlink" title="基本的车票预定功能开发"></a>基本的车票预定功能开发</h1><p>本章完成余票查询与购票功能，先不考虑高并发，优先完成主功能逻辑，为后续高并发场景做准备，学习服务间调用组件Feign的使用。</p>
<hr>
<h2 id="增加余票信息表以提高余票查询效率"><a href="#增加余票信息表以提高余票查询效率" class="headerlink" title="增加余票信息表以提高余票查询效率"></a>增加余票信息表以提高余票查询效率</h2><ul>
<li><p>余票查询会显示还有多少张票，票数如果实时通过sell去计算，会影响性能，所以应该另外做张表，直接存储余票数</p>
</li>
<li><p>数据库设计，就是通过不同维护的表来描述一样事物</p>
</li>
<li><p>对于相对较固定的枚举类型，就可以用行转列来展示，目的就是方便查询，适合读多写少的场景</p>
</li>
<li><p>视图和存储过程在以前的项目中，经常用到，因为依靠数据库内部的算力，就可以帮我们做很多复杂的功能，但因为会占用较多的数据库资源，所以逐渐淘汰了，服务端资源不够可以加机器，数据库就不好加了，所以数据库资源很珍贵，这也是为什么会有数据缓存</p>
</li>
<li><p>首先增加一个余票信息数据库表</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `daily_train_ticket`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `daily_train_ticket` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `<span class="type">date</span>` <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">  `train_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `<span class="keyword">start</span>` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;出发站&#x27;</span>,</span><br><span class="line">  `start_pinyin` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;出发站拼音&#x27;</span>,</span><br><span class="line">  `start_time` <span class="type">time</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;出发时间&#x27;</span>,</span><br><span class="line">  `start_index` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;出发站序|本站是整个车次的第几站&#x27;</span>,</span><br><span class="line">  `<span class="keyword">end</span>` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;到达站&#x27;</span>,</span><br><span class="line">  `end_pinyin` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;到达站拼音&#x27;</span>,</span><br><span class="line">  `end_time` <span class="type">time</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;到站时间&#x27;</span>,</span><br><span class="line">  `end_index` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;到站站序|本站是整个车次的第几站&#x27;</span>,</span><br><span class="line">  `ydz` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;一等座余票&#x27;</span>,</span><br><span class="line">  `ydz_price` <span class="type">decimal</span>(<span class="number">8</span>, <span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;一等座票价&#x27;</span>,</span><br><span class="line">  `edz` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;二等座余票&#x27;</span>,</span><br><span class="line">  `edz_price` <span class="type">decimal</span>(<span class="number">8</span>, <span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;二等座票价&#x27;</span>,</span><br><span class="line">  `rw` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;软卧余票&#x27;</span>,</span><br><span class="line">  `rw_price` <span class="type">decimal</span>(<span class="number">8</span>, <span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;软卧票价&#x27;</span>,</span><br><span class="line">  `yw` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;硬卧余票&#x27;</span>,</span><br><span class="line">  `yw_price` <span class="type">decimal</span>(<span class="number">8</span>, <span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;硬卧票价&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  <span class="keyword">unique</span> key `date_train_code_start_end_unique` (`<span class="type">date</span>`, `train_code`, `<span class="keyword">start</span>`, `<span class="keyword">end</span>`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;余票信息&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就是生成器了</li>
</ul>
<h2 id="生成车次时初始化余票信息"><a href="#生成车次时初始化余票信息" class="headerlink" title="生成车次时初始化余票信息"></a>生成车次时初始化余票信息</h2><ul>
<li><p>要初始化上面的表就两个问题：什么时候初始化这张表？这张表的数据从哪来？</p>
</li>
<li><p>要实现车站信息其实就是一个单向嵌套循环，批量操作都应该考虑是否要加事务，如果跑一半失败了，是全部回滚？还是跑多少算多少？</p>
</li>
<li><p>面试经常问到：事务的传播机制，其实就是事务有嵌套时，要让事务怎么做，是外层决定内层，还是内层不管外层</p>
</li>
</ul>
<blockquote>
<p>生成车次时，同步生成余票信息中出入站信息</p>
</blockquote>
<ul>
<li>我们在DailyTrainTicketService增加初始化方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> TrainStationService trainStationService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">genDaily</span><span class="params">(Date date , String trainCode)</span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;生成日期【&#123;&#125;】车次【&#123;&#125;】的余票信息开始&quot;</span>, DateUtil.formatDate(date), trainCode);</span><br><span class="line">        <span class="comment">//删除某日某车次的车站信息</span></span><br><span class="line">        <span class="type">DailyTrainTicketExample</span> <span class="variable">dailyTrainTicketExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainTicketExample</span>();</span><br><span class="line">        dailyTrainTicketExample.createCriteria()</span><br><span class="line">                .andDateEqualTo(date)</span><br><span class="line">                .andTrainCodeEqualTo(trainCode);</span><br><span class="line">        dailyTrainTicketMapper.deleteByExample(dailyTrainTicketExample);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查出途径的所有的车站信息</span></span><br><span class="line">        List&lt;TrainStation&gt; stationList= trainStationService.selectByTrainCode(trainCode);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isEmpty(stationList))&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;没有车次没有车站基础数据，生成该车次的车站信息任务结束&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span>;i&lt;stationList.size();i++)&#123;</span><br><span class="line">            <span class="comment">//得到出发站</span></span><br><span class="line">            <span class="type">TrainStation</span> <span class="variable">trainStationStart</span> <span class="operator">=</span> stationList.get(i);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> (i+<span class="number">1</span>); j &lt; stationList.size(); j++) &#123;</span><br><span class="line">                <span class="type">TrainStation</span> <span class="variable">trainStationEnd</span> <span class="operator">=</span> stationList.get(j);</span><br><span class="line">                <span class="type">DailyTrainTicket</span> <span class="variable">dailyTrainTicket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainTicket</span>();</span><br><span class="line"></span><br><span class="line">                dailyTrainTicket.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">                dailyTrainTicket.setDate(date);</span><br><span class="line">                dailyTrainTicket.setTrainCode(trainCode);</span><br><span class="line">                dailyTrainTicket.setStart(trainStationStart.getName());</span><br><span class="line">                dailyTrainTicket.setStartPinyin(trainStationStart.getNamePinyin());</span><br><span class="line">                dailyTrainTicket.setStartTime(trainStationStart.getOutTime());</span><br><span class="line">                dailyTrainTicket.setStartIndex(trainStationStart.getIndex());</span><br><span class="line">                dailyTrainTicket.setEnd(trainStationEnd.getName());</span><br><span class="line">                dailyTrainTicket.setEndPinyin(trainStationEnd.getNamePinyin());</span><br><span class="line">                dailyTrainTicket.setEndTime(trainStationEnd.getInTime());</span><br><span class="line">                dailyTrainTicket.setEndIndex(trainStationEnd.getIndex());</span><br><span class="line">                dailyTrainTicket.setYdz(<span class="number">0</span>);</span><br><span class="line">                dailyTrainTicket.setYdzPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>));</span><br><span class="line">                dailyTrainTicket.setEdz(<span class="number">0</span>);</span><br><span class="line">                dailyTrainTicket.setEdzPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>));</span><br><span class="line">                dailyTrainTicket.setRw(<span class="number">0</span>);</span><br><span class="line">                dailyTrainTicket.setRwPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>));</span><br><span class="line">                dailyTrainTicket.setYw(<span class="number">0</span>);</span><br><span class="line">                dailyTrainTicket.setYwPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>));</span><br><span class="line">                dailyTrainTicket.setCreateTime(now);</span><br><span class="line">                dailyTrainTicket.setUpdateTime(now);</span><br><span class="line">                dailyTrainTicketMapper.insert(dailyTrainTicket);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;生成日期【&#123;&#125;】车次【&#123;&#125;】的余票信息结束&quot;</span>, DateUtil.formatDate(date), trainCode);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后在DailyTrainService的genDailyTrain一块生成，记得在该方法上加一个事务@Transactional</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DailyTrainTicketService dailyTrainTicketService;</span><br><span class="line"></span><br><span class="line"><span class="comment">//生成该车次的余票数据</span></span><br><span class="line">dailyTrainTicketService.genDaily(date,train.getCode());</span><br></pre></td></tr></table></figure>

<blockquote>
<p>生成车次时，同步生成余票信息中数量和票价</p>
</blockquote>
<ul>
<li>在DailyTrainSeatService增加统计座位数方法，查不到就是-1，和没票时做一个区分</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countSeat</span><span class="params">(Date date,String trainCode,String seatType)</span>&#123;</span><br><span class="line">    <span class="type">DailyTrainSeatExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainSeatExample</span>();</span><br><span class="line">    example.createCriteria()</span><br><span class="line">            .andDateEqualTo(date)</span><br><span class="line">            .andTrainCodeEqualTo(trainCode)</span><br><span class="line">            .andSeatTypeEqualTo(seatType);</span><br><span class="line">    <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span>  dailyTrainSeatMapper.countByExample(example);</span><br><span class="line">    <span class="keyword">if</span> (l ==<span class="number">0L</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>) l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们修改下genDaily的参数，将车辆信息传递进去，方便使用，先修改下DailyTrainService中的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dailyTrainTicketService.genDaily(dailyTrain,date,train.getCode());</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来修改DailyTrainTicketService，新增如下，就是车票的一些信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DailyTrainSeatService dailyTrainSeatService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">genDaily</span><span class="params">(DailyTrain dailyTrain,Date date , String trainCode)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span>;i&lt;stationList.size();i++)&#123;</span><br><span class="line">            <span class="comment">//得到出发站</span></span><br><span class="line">            <span class="type">TrainStation</span> <span class="variable">trainStationStart</span> <span class="operator">=</span> stationList.get(i);</span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">sumKM</span> <span class="operator">=</span> BigDecimal.ZERO;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> (i+<span class="number">1</span>); j &lt; stationList.size(); j++) &#123;</span><br><span class="line">                <span class="type">TrainStation</span> <span class="variable">trainStationEnd</span> <span class="operator">=</span> stationList.get(j);</span><br><span class="line">                sumKM = sumKM.add(trainStationEnd.getKm());</span><br><span class="line">                <span class="type">DailyTrainTicket</span> <span class="variable">dailyTrainTicket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainTicket</span>();</span><br><span class="line">                <span class="type">int</span> <span class="variable">ydz</span> <span class="operator">=</span>dailyTrainSeatService.countSeat(date,trainCode, SeatTypeEnum.YDZ.getCode());</span><br><span class="line">                <span class="type">int</span> <span class="variable">edz</span> <span class="operator">=</span> dailyTrainSeatService.countSeat(date,trainCode, SeatTypeEnum.EDZ.getCode());</span><br><span class="line">                <span class="type">int</span> <span class="variable">rw</span> <span class="operator">=</span> dailyTrainSeatService.countSeat(date,trainCode, SeatTypeEnum.RW.getCode());</span><br><span class="line">                <span class="type">int</span> <span class="variable">yw</span> <span class="operator">=</span> dailyTrainSeatService.countSeat(date,trainCode, SeatTypeEnum.YW.getCode());</span><br><span class="line">                <span class="comment">//票价=里程之和 * 座位单价 * 车次类型系数</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">trainType</span> <span class="operator">=</span> dailyTrain.getType();</span><br><span class="line">                <span class="comment">//计算票价系数：TrainTypeEnum.priceRate</span></span><br><span class="line">                <span class="type">BigDecimal</span> <span class="variable">priceRate</span> <span class="operator">=</span> EnumUtil.getFieldBy(TrainTypeEnum::getPriceRate, TrainTypeEnum::getCode, trainType);</span><br><span class="line">                <span class="type">BigDecimal</span> <span class="variable">ydzPrice</span> <span class="operator">=</span> sumKM.multiply(SeatTypeEnum.YDZ.getPrice()).multiply(priceRate).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">                <span class="type">BigDecimal</span> <span class="variable">edzPrice</span> <span class="operator">=</span> sumKM.multiply(SeatTypeEnum.EDZ.getPrice()).multiply(priceRate).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">                <span class="type">BigDecimal</span> <span class="variable">rwPrice</span> <span class="operator">=</span> sumKM.multiply(SeatTypeEnum.RW.getPrice()).multiply(priceRate).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">                <span class="type">BigDecimal</span> <span class="variable">ywPrice</span> <span class="operator">=</span> sumKM.multiply(SeatTypeEnum.YW.getPrice()).multiply(priceRate).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">                dailyTrainTicket.setYdz(ydz);</span><br><span class="line">                dailyTrainTicket.setYdzPrice(ydzPrice);</span><br><span class="line">                dailyTrainTicket.setEdz(edz);</span><br><span class="line">                dailyTrainTicket.setEdzPrice(edzPrice);</span><br><span class="line">                dailyTrainTicket.setRw(rw);</span><br><span class="line">                dailyTrainTicket.setRwPrice(rwPrice);</span><br><span class="line">                dailyTrainTicket.setYw(yw);</span><br><span class="line">                dailyTrainTicket.setYwPrice(ywPrice);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;生成日期【&#123;&#125;】车次【&#123;&#125;】的余票信息结束&quot;</span>, DateUtil.formatDate(date), trainCode);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>阶梯价格是比较常见的设计，比如：<br> 0<del>100公里：0.4元&#x2F;公里<br> 100</del>200公里：0.3元&#x2F;公里<br> 坐了一趟车，开了150公里，那么票价&#x3D;100*0.4+(150-100)*0.3</p>
</blockquote>
<h2 id="为余票信息页面增加查询条件"><a href="#为余票信息页面增加查询条件" class="headerlink" title="为余票信息页面增加查询条件"></a>为余票信息页面增加查询条件</h2><blockquote>
<p>为余票页面增加查询条件</p>
</blockquote>
<ul>
<li>设置查询余票的参数DailyTrainTicketQueryReq</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.req.PageReq;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DailyTrainTicketQueryReq</span> <span class="keyword">extends</span> <span class="title class_">PageReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 车次编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String trainCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出发站</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 到达站</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDate</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrainCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrainCode</span><span class="params">(String trainCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trainCode = trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStart</span><span class="params">(String start)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnd</span><span class="params">(String end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;DailyTrainTicketQueryReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;date=&quot;</span>).append(date);</span><br><span class="line">        sb.append(<span class="string">&quot;, trainCode=&#x27;&quot;</span>).append(trainCode).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, start=&#x27;&quot;</span>).append(start).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, end=&#x27;&quot;</span>).append(end).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在DailyTrainTicketService的queryList增加判断条件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjUtil.isNotNull(req.getDate()))&#123;</span><br><span class="line">    criteria.andDateEqualTo(req.getDate());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ObjUtil.isNotEmpty(req.getTrainCode()))&#123;</span><br><span class="line">    criteria.andTrainCodeEqualTo(req.getTrainCode());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ObjUtil.isNotEmpty(req.getStart()))&#123;</span><br><span class="line">    criteria.andStartEqualTo(req.getStart());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ObjUtil.isNotEmpty(req.getEnd()))&#123;</span><br><span class="line">    criteria.andEndEqualTo(req.getEnd());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后就修改前端：daily-train-ticket，增加查询框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;train-select-view v-model=&quot;params.trainCode&quot; width=&quot;200px&quot;&gt;&lt;/train-select-view&gt;</span><br><span class="line">&lt;a-date-picker v-model:value=&quot;params.date&quot; valueFormat=&quot;YYYY-MM-DD&quot; placeholder=&quot;请选择日期&quot;&gt;&lt;/a-date-picker&gt;</span><br><span class="line">&lt;station-select-view v-model=&quot;params.start&quot; width=&quot;200px&quot;&gt;&lt;/station-select-view&gt;</span><br><span class="line">&lt;station-select-view v-model=&quot;params.end&quot; width=&quot;200px&quot;&gt;&lt;/station-select-view&gt;</span><br><span class="line">&lt;a-button type=&quot;primary&quot; @click=&quot;handleQuery()&quot;&gt;查找&lt;/a-button&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义参数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> params = <span class="title function_">ref</span>(&#123;&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>handleQuery方法增加请求参数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">trainCode</span>:params.<span class="property">value</span>.<span class="property">trainCode</span>,</span><br><span class="line"><span class="attr">date</span>:params.<span class="property">value</span>.<span class="property">date</span>,</span><br><span class="line"><span class="attr">start</span>:params.<span class="property">value</span>.<span class="property">start</span>,</span><br><span class="line"><span class="attr">end</span>:params.<span class="property">value</span>.<span class="property">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>返回params</li>
</ul>
<blockquote>
<p>优化余票查询界面</p>
</blockquote>
<ul>
<li>就改一下daily-train-ticket即可</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;template #bodyCell=&quot;&#123; column, record &#125;&quot;&gt;</span><br><span class="line">  &lt;template v-if=&quot;column.dataIndex === &#x27;operation&#x27;&quot;&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template v-else-if=&quot;column.dataIndex === &#x27;station&#x27;&quot;&gt;</span><br><span class="line">    &#123;&#123;record.start&#125;&#125;&lt;br/&gt;</span><br><span class="line">    &#123;&#123;record.end&#125;&#125;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template v-else-if=&quot;column.dataIndex === &#x27;time&#x27;&quot;&gt;</span><br><span class="line">    &#123;&#123;record.startTime&#125;&#125;&lt;br/&gt;</span><br><span class="line">    &#123;&#123;record.endTime&#125;&#125;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template v-else-if=&quot;column.dataIndex === &#x27;duration&#x27;&quot;&gt;</span><br><span class="line">    &#123;&#123;calDuration(record.startTime,record.endTime)&#125;&#125;&lt;br/&gt;</span><br><span class="line">    &lt;div v-if=&quot;record.startTime.replaceAll(&#x27;:&#x27;,&#x27;&#x27;)&gt;=record.endTime.replaceAll(&#x27;:&#x27;,&#x27;&#x27;)&quot;&gt;</span><br><span class="line">      次日到达</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div v-else&gt;</span><br><span class="line">      当日到达</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template v-else-if=&quot;column.dataIndex === &#x27;ydz&#x27;&quot;&gt;</span><br><span class="line">    &lt;div v-if=&quot;record.ydz &gt;=0&quot;&gt;</span><br><span class="line">      &#123;&#123;record.ydz&#125;&#125;&lt;br/&gt;</span><br><span class="line">      &#123;&#123;record.ydzPrice&#125;&#125;￥</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div v-else&gt;</span><br><span class="line">      --</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template v-else-if=&quot;column.dataIndex === &#x27;edz&#x27;&quot;&gt;</span><br><span class="line">    &lt;div v-if=&quot;record.edz &gt;=0&quot;&gt;</span><br><span class="line">      &#123;&#123;record.edz&#125;&#125;&lt;br/&gt;</span><br><span class="line">      &#123;&#123;record.edzPrice&#125;&#125;￥</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div v-else&gt;</span><br><span class="line">      --</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template v-else-if=&quot;column.dataIndex === &#x27;rw&#x27;&quot;&gt;</span><br><span class="line">    &lt;div v-if=&quot;record.rw &gt;=0&quot;&gt;</span><br><span class="line">      &#123;&#123;record.rw&#125;&#125;&lt;br/&gt;</span><br><span class="line">      &#123;&#123;record.rwPrice&#125;&#125;￥</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div v-else&gt;</span><br><span class="line">      --</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;template v-else-if=&quot;column.dataIndex === &#x27;yw&#x27;&quot;&gt;</span><br><span class="line">    &lt;div v-if=&quot;record.yw &gt;=0&quot;&gt;</span><br><span class="line">      &#123;&#123;record.yw&#125;&#125;&lt;br/&gt;</span><br><span class="line">      &#123;&#123;record.ywPrice&#125;&#125;￥</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div v-else&gt;</span><br><span class="line">      --</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改columns的字段</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> columns = [</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;date&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;date&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;trainCode&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;trainCode&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;车站&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;station&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;station&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;时间&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;time&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;time&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;历时&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;duration&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;duration&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;一等座&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;ydz&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;ydz&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;二等座&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;edz&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;edz&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;软卧&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;rw&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;rw&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;硬卧&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;yw&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;yw&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<ul>
<li>增加历时方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">calDuration</span> = (<span class="params">startTime,endTime</span>)=&gt;&#123;</span><br><span class="line">  <span class="keyword">let</span> diff=<span class="title function_">dayjs</span>(endTime,<span class="string">&#x27;HH:mm:ss&#x27;</span>).<span class="title function_">diff</span>( <span class="title function_">dayjs</span>(startTime,<span class="string">&#x27;HH:mm:ss&#x27;</span>),<span class="string">&#x27;seconds&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">dayjs</span>(<span class="string">&#x27;00:00:00&#x27;</span>,<span class="string">&#x27;HH:mm:ss&#x27;</span>).<span class="title function_">second</span>(diff).<span class="title function_">format</span>(<span class="string">&#x27;HH:mm:ss&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>返回calDuration</li>
</ul>
<h2 id="为会员端增余票查询功能"><a href="#为会员端增余票查询功能" class="headerlink" title="为会员端增余票查询功能"></a>为会员端增余票查询功能</h2><blockquote>
<p>修改乘客管理页面，正常显示页面</p>
</blockquote>
<ul>
<li>将web&#x2F;src&#x2F;views&#x2F;main&#x2F;passenger.vue的item对应的key和value，统一换成code和desc</li>
<li>然后将修改了下package.json</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307240919535.png"
                      alt="image-20230724091951325"
                ></p>
<blockquote>
<p>会员端增加余票查询页面，功能和控台端完全一致</p>
</blockquote>
<ul>
<li><p>从这个名字就可以看出来只需要把admin里面的相关的东西复制修改下就可以了</p>
</li>
<li><p>首先将个别的代码复制到com&#x2F;fzx&#x2F;train&#x2F;business&#x2F;controller下，三个如下</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.DailyTrainTicketQueryReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.DailyTrainTicketSaveReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.resp.DailyTrainTicketQueryResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.service.DailyTrainTicketService;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.PageResp;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/daily-train-ticket&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DailyTrainTicketController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DailyTrainTicketService dailyTrainTicketService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/query-list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;PageResp&lt;DailyTrainTicketQueryResp&gt;&gt; <span class="title function_">queryList</span><span class="params">(<span class="meta">@Valid</span> DailyTrainTicketQueryReq req)</span>&#123;</span><br><span class="line">        PageResp&lt;DailyTrainTicketQueryResp&gt; list = dailyTrainTicketService.queryList(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(list);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.StationQueryReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.StationSaveReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.resp.StationQueryResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.service.StationService;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.PageResp;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/station&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StationController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StationService stationService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/query-all&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;List&lt;StationQueryResp&gt;&gt; <span class="title function_">queryAll</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;StationQueryResp&gt; list = stationService.queryAll();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.TrainQueryReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.TrainSaveReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.resp.TrainQueryResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.service.TrainSeatService;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.service.TrainService;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.PageResp;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/train&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrainController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TrainService trainService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/query-all&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;List&lt;TrainQueryResp&gt;&gt; <span class="title function_">queryAll</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;TrainQueryResp&gt; list = trainService.queryAll();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就是复制到web&#x2F;src&#x2F;components下那几个小组件分别：station-select和train-select</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-select v-model:value=&quot;name&quot; show-search allow-clear</span><br><span class="line">            :filter-option=&quot;filterNameOption&quot;</span><br><span class="line">            @change =&quot;onChange&quot; placeholder=&quot;请选择车站&quot;</span><br><span class="line">            :style=&quot;&#x27;width: &#x27; + localWidth&quot;&gt;</span><br><span class="line">    &lt;a-select-option v-for=&quot;item in stations&quot; :key=&quot;item.name&quot;  :value=&quot;item.name&quot; :lable=&quot;item.name +item.namePinyin+item.namePy&quot;&gt;</span><br><span class="line">      &#123;&#123;item.name&#125;&#125; | &#123;&#123;item.namePinyin&#125;&#125; ~ &#123;&#123;item.namePy&#125;&#125;</span><br><span class="line">    &lt;/a-select-option&gt;</span><br><span class="line">  &lt;/a-select&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123;defineComponent,onMounted, watch,ref&#125; from &quot;vue&quot;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import &#123;notification&#125; from &quot;ant-design-vue&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;station-select-view&quot;,</span><br><span class="line">  //props区域用于定义父子组件参数传递的属性</span><br><span class="line">  props:[&quot;modelValue&quot;,&quot;width&quot;],</span><br><span class="line">  emits:[&#x27;update:modelValue&#x27;,&#x27;change&#x27;],</span><br><span class="line">  setup(props,&#123;emit&#125;)&#123;</span><br><span class="line">    const name = ref();</span><br><span class="line">    const stations = ref([]);</span><br><span class="line">    const localWidth = ref(props.width);</span><br><span class="line">    if (Tool.isEmpty(props.width)) &#123;</span><br><span class="line">      localWidth.value = &quot;100%&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    //利用watch，动态获取父组件的值，如果放在onMounted或其它方法里，则只有第一次有效</span><br><span class="line">    watch(()=&gt;props.modelValue,()=&gt;&#123;</span><br><span class="line">      console.log(&quot;props.modelValue&quot;,props.modelValue);</span><br><span class="line">      name.value = props.modelValue;</span><br><span class="line">    &#125;,&#123;immediate:true&#125;);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 查询所有的车站，用于车站下拉框</span><br><span class="line">     */</span><br><span class="line">    const queryAllStation = () =&gt;&#123;</span><br><span class="line">      axios.get(&quot;/business/station/query-all&quot;).then((response)=&gt;&#123;</span><br><span class="line">        let data = response.data;</span><br><span class="line">        if (data.success)&#123;</span><br><span class="line">          stations.value = data.content;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">          notification.error(&#123;description:data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const filterNameOption =(input,option)=&gt;&#123;</span><br><span class="line">      console.log(input,option);</span><br><span class="line">      return option.label.toLowerCase().indexOf(input.toLowerCase()) &gt;=0;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const onChange = (value) =&gt;&#123;</span><br><span class="line">      emit(&#x27;update:modelValue&#x27;,value);</span><br><span class="line">      let station = stations.value.filter(item =&gt;item.code == value)[0];</span><br><span class="line">      if (Tool.isEmpty(station))&#123;</span><br><span class="line">        station=&#123;&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      emit(&#x27;change&#x27;,station);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    onMounted(()=&gt;&#123;</span><br><span class="line">      queryAllStation();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    return&#123;</span><br><span class="line">      name,</span><br><span class="line">      stations,</span><br><span class="line">      filterNameOption,</span><br><span class="line">      onChange,</span><br><span class="line">      localWidth,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;a-select v-model:value=&quot;trainCode&quot; show-search allow-clear</span><br><span class="line">            :filter-option=&quot;filterTrainCodeOption&quot;</span><br><span class="line">            @change =&quot;onChange&quot; placeholder=&quot;请选择车次&quot;</span><br><span class="line">            :style=&quot;&#x27;width: &#x27; + localWidth&quot;&gt;</span><br><span class="line">    &lt;a-select-option v-for=&quot;item in trains&quot; :key=&quot;item.code&quot;  :value=&quot;item.code&quot; :lable=&quot;item.code +item.start+item.end&quot;&gt;</span><br><span class="line">      &#123;&#123;item.code&#125;&#125; | &#123;&#123;item.start&#125;&#125; ~ &#123;&#123;item.end&#125;&#125;</span><br><span class="line">    &lt;/a-select-option&gt;</span><br><span class="line">  &lt;/a-select&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123;defineComponent,onMounted, watch,ref&#125; from &quot;vue&quot;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import &#123;notification&#125; from &quot;ant-design-vue&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;train-select-view&quot;,</span><br><span class="line">  //props区域用于定义父子组件参数传递的属性</span><br><span class="line">  props:[&quot;modelValue&quot;,&quot;width&quot;],</span><br><span class="line">  emits:[&#x27;update:modelValue&#x27;,&#x27;change&#x27;],</span><br><span class="line">  setup(props,&#123;emit&#125;)&#123;</span><br><span class="line">    const trainCode = ref();</span><br><span class="line">    const trains = ref([]);</span><br><span class="line">    const localWidth = ref(props.width);</span><br><span class="line">    if (Tool.isEmpty(props.width)) &#123;</span><br><span class="line">      localWidth.value = &quot;100%&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    //利用watch，动态获取父组件的值，如果放在onMounted或其它方法里，则只有第一次有效</span><br><span class="line">    watch(()=&gt;props.modelValue,()=&gt;&#123;</span><br><span class="line">      console.log(&quot;props.modelValue&quot;,props.modelValue);</span><br><span class="line">      trainCode.value = props.modelValue;</span><br><span class="line">    &#125;,&#123;immediate:true&#125;);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 查询所有的车次，用于车次下拉框</span><br><span class="line">     */</span><br><span class="line">    const queryAllTrain = () =&gt;&#123;</span><br><span class="line">      axios.get(&quot;/business/train/query-all&quot;).then((response)=&gt;&#123;</span><br><span class="line">        let data = response.data;</span><br><span class="line">        if (data.success)&#123;</span><br><span class="line">          trains.value = data.content;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">          notification.error(&#123;description:data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const filterTrainCodeOption =(input,option)=&gt;&#123;</span><br><span class="line">      console.log(input,option);</span><br><span class="line">      return option.label.toLowerCase().indexOf(input.toLowerCase()) &gt;=0;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const onChange = (value) =&gt;&#123;</span><br><span class="line">      emit(&#x27;update:modelValue&#x27;,value);</span><br><span class="line">      let train = trains.value.filter(item =&gt;item.code == value)[0];</span><br><span class="line">      if (Tool.isEmpty(train))&#123;</span><br><span class="line">        train=&#123;&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      emit(&#x27;change&#x27;,train);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    onMounted(()=&gt;&#123;</span><br><span class="line">      queryAllTrain();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    return&#123;</span><br><span class="line">      trainCode,</span><br><span class="line">      trains,</span><br><span class="line">      filterTrainCodeOption,</span><br><span class="line">      onChange,</span><br><span class="line">      localWidth,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就是把主要的前端查询页面复制过来ticket.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;p&gt;</span><br><span class="line">    &lt;a-space&gt;</span><br><span class="line">      &lt;train-select-view v-model=&quot;params.trainCode&quot; width=&quot;200px&quot;&gt;&lt;/train-select-view&gt;</span><br><span class="line">      &lt;a-date-picker v-model:value=&quot;params.date&quot; valueFormat=&quot;YYYY-MM-DD&quot; placeholder=&quot;请选择日期&quot;&gt;&lt;/a-date-picker&gt;</span><br><span class="line">      &lt;station-select-view v-model=&quot;params.start&quot; width=&quot;200px&quot;&gt;&lt;/station-select-view&gt;</span><br><span class="line">      &lt;station-select-view v-model=&quot;params.end&quot; width=&quot;200px&quot;&gt;&lt;/station-select-view&gt;</span><br><span class="line">      &lt;a-button type=&quot;primary&quot; @click=&quot;handleQuery()&quot;&gt;查找&lt;/a-button&gt;</span><br><span class="line">    &lt;/a-space&gt;</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line">  &lt;a-table :dataSource=&quot;dailyTrainTickets&quot;</span><br><span class="line">           :columns=&quot;columns&quot;</span><br><span class="line">           :pagination=&quot;pagination&quot;</span><br><span class="line">           @change=&quot;handleTableChange&quot;</span><br><span class="line">           :loading=&quot;loading&quot;&gt;</span><br><span class="line">    &lt;template #bodyCell=&quot;&#123; column, record &#125;&quot;&gt;</span><br><span class="line">      &lt;template v-if=&quot;column.dataIndex === &#x27;operation&#x27;&quot;&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;template v-else-if=&quot;column.dataIndex === &#x27;station&#x27;&quot;&gt;</span><br><span class="line">        &#123;&#123;record.start&#125;&#125;&lt;br/&gt;</span><br><span class="line">        &#123;&#123;record.end&#125;&#125;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;template v-else-if=&quot;column.dataIndex === &#x27;time&#x27;&quot;&gt;</span><br><span class="line">        &#123;&#123;record.startTime&#125;&#125;&lt;br/&gt;</span><br><span class="line">        &#123;&#123;record.endTime&#125;&#125;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;template v-else-if=&quot;column.dataIndex === &#x27;duration&#x27;&quot;&gt;</span><br><span class="line">        &#123;&#123;calDuration(record.startTime,record.endTime)&#125;&#125;&lt;br/&gt;</span><br><span class="line">        &lt;div v-if=&quot;record.startTime.replaceAll(&#x27;:&#x27;,&#x27;&#x27;)&gt;=record.endTime.replaceAll(&#x27;:&#x27;,&#x27;&#x27;)&quot;&gt;</span><br><span class="line">          次日到达</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div v-else&gt;</span><br><span class="line">          当日到达</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;template v-else-if=&quot;column.dataIndex === &#x27;ydz&#x27;&quot;&gt;</span><br><span class="line">        &lt;div v-if=&quot;record.ydz &gt;=0&quot;&gt;</span><br><span class="line">          &#123;&#123;record.ydz&#125;&#125;&lt;br/&gt;</span><br><span class="line">          &#123;&#123;record.ydzPrice&#125;&#125;￥</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div v-else&gt;</span><br><span class="line">          --</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;template v-else-if=&quot;column.dataIndex === &#x27;edz&#x27;&quot;&gt;</span><br><span class="line">        &lt;div v-if=&quot;record.edz &gt;=0&quot;&gt;</span><br><span class="line">          &#123;&#123;record.edz&#125;&#125;&lt;br/&gt;</span><br><span class="line">          &#123;&#123;record.edzPrice&#125;&#125;￥</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div v-else&gt;</span><br><span class="line">          --</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;template v-else-if=&quot;column.dataIndex === &#x27;rw&#x27;&quot;&gt;</span><br><span class="line">        &lt;div v-if=&quot;record.rw &gt;=0&quot;&gt;</span><br><span class="line">          &#123;&#123;record.rw&#125;&#125;&lt;br/&gt;</span><br><span class="line">          &#123;&#123;record.rwPrice&#125;&#125;￥</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div v-else&gt;</span><br><span class="line">          --</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;template v-else-if=&quot;column.dataIndex === &#x27;yw&#x27;&quot;&gt;</span><br><span class="line">        &lt;div v-if=&quot;record.yw &gt;=0&quot;&gt;</span><br><span class="line">          &#123;&#123;record.yw&#125;&#125;&lt;br/&gt;</span><br><span class="line">          &#123;&#123;record.ywPrice&#125;&#125;￥</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div v-else&gt;</span><br><span class="line">          --</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">  &lt;/a-table&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; defineComponent, ref, onMounted &#125; from &#x27;vue&#x27;;</span><br><span class="line">import &#123;notification&#125; from &quot;ant-design-vue&quot;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import TrainSelectView from &quot;@/components/train-select&quot;;</span><br><span class="line">import StationSelectView from &quot;@/components/station-select&quot;;</span><br><span class="line">import dayjs  from &quot;dayjs&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;ticket-view&quot;,</span><br><span class="line">  components: &#123;StationSelectView, TrainSelectView&#125;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const visible = ref(false);</span><br><span class="line">    let dailyTrainTicket = ref(&#123;</span><br><span class="line">      id: undefined,</span><br><span class="line">      date: undefined,</span><br><span class="line">      trainCode: undefined,</span><br><span class="line">      start: undefined,</span><br><span class="line">      startPinyin: undefined,</span><br><span class="line">      startTime: undefined,</span><br><span class="line">      startIndex: undefined,</span><br><span class="line">      end: undefined,</span><br><span class="line">      endPinyin: undefined,</span><br><span class="line">      endTime: undefined,</span><br><span class="line">      endIndex: undefined,</span><br><span class="line">      ydz: undefined,</span><br><span class="line">      ydzPrice: undefined,</span><br><span class="line">      edz: undefined,</span><br><span class="line">      edzPrice: undefined,</span><br><span class="line">      rw: undefined,</span><br><span class="line">      rwPrice: undefined,</span><br><span class="line">      yw: undefined,</span><br><span class="line">      ywPrice: undefined,</span><br><span class="line">      createTime: undefined,</span><br><span class="line">      updateTime: undefined,</span><br><span class="line">    &#125;);</span><br><span class="line">    const dailyTrainTickets = ref([]);</span><br><span class="line">    // 分页的三个属性名是固定的</span><br><span class="line">    const pagination = ref(&#123;</span><br><span class="line">      total: 0,</span><br><span class="line">      current: 1,</span><br><span class="line">      pageSize: 10,</span><br><span class="line">    &#125;);</span><br><span class="line">    let loading = ref(false);</span><br><span class="line">    const params = ref(&#123;&#125;);</span><br><span class="line">    const columns = [</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;日期&#x27;,</span><br><span class="line">      dataIndex: &#x27;date&#x27;,</span><br><span class="line">      key: &#x27;date&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;车次编号&#x27;,</span><br><span class="line">      dataIndex: &#x27;trainCode&#x27;,</span><br><span class="line">      key: &#x27;trainCode&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;车站&#x27;,</span><br><span class="line">      dataIndex: &#x27;station&#x27;,</span><br><span class="line">      key: &#x27;station&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;时间&#x27;,</span><br><span class="line">      dataIndex: &#x27;time&#x27;,</span><br><span class="line">      key: &#x27;time&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;历时&#x27;,</span><br><span class="line">      dataIndex: &#x27;duration&#x27;,</span><br><span class="line">      key: &#x27;duration&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;一等座&#x27;,</span><br><span class="line">      dataIndex: &#x27;ydz&#x27;,</span><br><span class="line">      key: &#x27;ydz&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;二等座&#x27;,</span><br><span class="line">      dataIndex: &#x27;edz&#x27;,</span><br><span class="line">      key: &#x27;edz&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;软卧&#x27;,</span><br><span class="line">      dataIndex: &#x27;rw&#x27;,</span><br><span class="line">      key: &#x27;rw&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;硬卧&#x27;,</span><br><span class="line">      dataIndex: &#x27;yw&#x27;,</span><br><span class="line">      key: &#x27;yw&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    const handleQuery = (param) =&gt; &#123;</span><br><span class="line">      if (!param) &#123;</span><br><span class="line">        param = &#123;</span><br><span class="line">          page: 1,</span><br><span class="line">          size: pagination.value.pageSize</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      loading.value = true;</span><br><span class="line">      axios.get(&quot;/business/daily-train-ticket/query-list&quot;, &#123;</span><br><span class="line">        params: &#123;</span><br><span class="line">          page: param.page,</span><br><span class="line">          size: param.size,</span><br><span class="line">          trainCode:params.value.trainCode,</span><br><span class="line">          date:params.value.date,</span><br><span class="line">          start:params.value.start,</span><br><span class="line">          end:params.value.end</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then((response) =&gt; &#123;</span><br><span class="line">        loading.value = false;</span><br><span class="line">        let data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          dailyTrainTickets.value = data.content.list;</span><br><span class="line">          // 设置分页控件的值</span><br><span class="line">          pagination.value.current = param.page;</span><br><span class="line">          pagination.value.total = data.content.total;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const handleTableChange = (page) =&gt; &#123;</span><br><span class="line">      // console.log(&quot;看看自带的分页参数都有啥：&quot; + JSON.stringify(page));</span><br><span class="line">      pagination.value.pageSize = page.pageSize;</span><br><span class="line">      handleQuery(&#123;</span><br><span class="line">        page: page.current,</span><br><span class="line">        size: page.pageSize</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    const calDuration = (startTime,endTime)=&gt;&#123;</span><br><span class="line">      let diff=dayjs(endTime,&#x27;HH:mm:ss&#x27;).diff( dayjs(startTime,&#x27;HH:mm:ss&#x27;),&#x27;seconds&#x27;);</span><br><span class="line">      return dayjs(&#x27;00:00:00&#x27;,&#x27;HH:mm:ss&#x27;).second(diff).format(&#x27;HH:mm:ss&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">      handleQuery(&#123;</span><br><span class="line">        page: 1,</span><br><span class="line">        size: pagination.value.pageSize</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      dailyTrainTicket,</span><br><span class="line">      visible,</span><br><span class="line">      dailyTrainTickets,</span><br><span class="line">      pagination,</span><br><span class="line">      columns,</span><br><span class="line">      handleTableChange,</span><br><span class="line">      handleQuery,</span><br><span class="line">      loading,</span><br><span class="line">      params,</span><br><span class="line">      calDuration</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后就是菜单和路由的修改了</li>
</ul>
<blockquote>
<p>会员端修改余票查询页面，查询的三个参数必输入，去掉车次查询条件</p>
</blockquote>
<ul>
<li>就是修改web的ticket，首先将下面的去掉</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;train-select-view v-model=&quot;params.trainCode&quot; width=&quot;200px&quot;&gt;&lt;/train-select-view&gt;</span><br><span class="line">···</span><br><span class="line"> &#123;</span><br><span class="line">      title: &#x27;日期&#x27;,</span><br><span class="line">      dataIndex: &#x27;date&#x27;,</span><br><span class="line">      key: &#x27;date&#x27;,</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>最后在handleQuery里添加查询校验</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isEmpty</span>(params.<span class="property">value</span>.<span class="property">date</span>))&#123;</span><br><span class="line">  notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:<span class="string">&quot;请输入日期&quot;</span>&#125;);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isEmpty</span>(params.<span class="property">value</span>.<span class="property">start</span>))&#123;</span><br><span class="line">  notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:<span class="string">&quot;请输入出发地&quot;</span>&#125;);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isEmpty</span>(params.<span class="property">value</span>.<span class="property">end</span>))&#123;</span><br><span class="line">  notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:<span class="string">&quot;请输入目的地&quot;</span>&#125;);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="增加订票页面并实现车次信息传递"><a href="#增加订票页面并实现车次信息传递" class="headerlink" title="增加订票页面并实现车次信息传递"></a>增加订票页面并实现车次信息传递</h2><blockquote>
<p>增加预订按钮，点击预订时，跳转到下单页面，并使用sessionStorage传递参数</p>
</blockquote>
<ul>
<li>首先增加order.vue页面在web下的views\main，并且增加路由</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123;dailyTrainTicket&#125;&#125;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123;defineComponent&#125; from &quot;vue&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;order-view&quot;,</span><br><span class="line">  setup()&#123;</span><br><span class="line">    const dailyTrainTicket = SessionStorage.get(&quot;dailyTrainTicket&quot;) || &#123;&#125;;</span><br><span class="line">    console.log(&quot;下单的车次信息&quot;,dailyTrainTicket);</span><br><span class="line">    return&#123;</span><br><span class="line">      dailyTrainTicket</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来修改ticket.vue页面，增加按钮及方法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template v-if=&quot;column.dataIndex === &#x27;operation&#x27;&quot;&gt;</span><br><span class="line">  &lt;a-button type=&quot;primary&quot; @click=&quot;toOrder(record)&quot;&gt;预定&lt;/a-button&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>在columns增加操作列</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;操作&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;operation&#x27;</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>对应方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">toOrder</span> = (<span class="params">record</span>) =&gt;&#123;</span><br><span class="line">  dailyTrainTicket.<span class="property">value</span> = <span class="title class_">Tool</span>.<span class="title function_">copy</span>(record);</span><br><span class="line">  <span class="title class_">SessionStorage</span>.<span class="title function_">set</span>(<span class="string">&quot;dailyTrainTicket&quot;</span>,dailyTrainTicket.<span class="property">value</span>);</span><br><span class="line">  router.<span class="title function_">push</span>(<span class="string">&quot;/order&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>记得返回方法</li>
</ul>
<blockquote>
<p>为余票查询页面缓存查询参数，方便用户使用；将session key写成常量，方便统一维护，可以避免多个功能使用同一个key</p>
</blockquote>
<ul>
<li>我们将缓存的key在web&#x2F;public&#x2F;js&#x2F;session-storage.js设置为常量</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//所有的session key都在这里统一定义，可以避免多个功能使用同一个key</span></span><br><span class="line"><span class="variable constant_">SESSION_ORDER</span> = <span class="string">&quot;SESSION_ORDER&quot;</span>;</span><br><span class="line"><span class="variable constant_">SESSION_TICKET_PARAMS</span> =<span class="string">&quot;SESSION_TICKET_PARAMS&quot;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>order.vue中就是将缓存的key换成全局的变量</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dailyTrainTicket = <span class="title class_">SessionStorage</span>.<span class="title function_">get</span>(<span class="variable constant_">SESSION_ORDER</span>) || &#123;&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>ticket.vue中修改如下：在handleQuery中增加一个保存查询参数的代码</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存查询参数</span></span><br><span class="line"><span class="title class_">SessionStorage</span>.<span class="title function_">set</span>(<span class="variable constant_">SESSION_TICKET_PARAMS</span>,params.<span class="property">value</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>同样的将设置缓存的key也变成全局变量</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">SessionStorage</span>.<span class="title function_">set</span>(<span class="variable constant_">SESSION_ORDER</span>,dailyTrainTicket.<span class="property">value</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>增加onMounted的方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"> <span class="comment">// “|| &#123;&#125;&quot;事常用技巧，可以避免空指针异常</span></span><br><span class="line">  params.<span class="property">value</span> = <span class="title class_">SessionStorage</span>.<span class="title function_">get</span>(<span class="variable constant_">SESSION_TICKET_PARAMS</span>) || &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isNotEmpty</span>(params.<span class="property">value</span>))&#123;</span><br><span class="line">    <span class="title function_">handleQuery</span>(&#123;</span><br><span class="line">      <span class="attr">page</span>:<span class="number">1</span>,</span><br><span class="line">      <span class="attr">size</span>:pagination.<span class="property">value</span>.<span class="property">pageSize</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>美化车次信息的显示</p>
</blockquote>
<ul>
<li>就修改了一个order.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;order-train&quot;&gt;</span><br><span class="line">  &lt;span class=&quot;order-train-main&quot;&gt;&#123;&#123;dailyTrainTicket.date&#125;&#125;&lt;/span&gt;&amp;nbsp;</span><br><span class="line">  &lt;span class=&quot;order-train-main&quot;&gt;&#123;&#123;dailyTrainTicket.trainCode&#125;&#125;&lt;/span&gt;次&amp;nbsp;</span><br><span class="line">  &lt;span class=&quot;order-train-main&quot;&gt;&#123;&#123;dailyTrainTicket.start&#125;&#125;&lt;/span&gt;站&amp;nbsp;</span><br><span class="line">  &lt;span class=&quot;order-train-main&quot;&gt;&#123;&#123;dailyTrainTicket.startTime&#125;&#125;&lt;/span&gt;&amp;nbsp;</span><br><span class="line">  &lt;span class=&quot;order-train-main&quot;&gt;--&lt;/span&gt;&amp;nbsp;</span><br><span class="line">  &lt;span class=&quot;order-train-main&quot;&gt;&#123;&#123;dailyTrainTicket.end&#125;&#125;&lt;/span&gt;站&amp;nbsp;</span><br><span class="line">  &lt;span class=&quot;order-train-main&quot;&gt;&#123;&#123;dailyTrainTicket.endTime&#125;&#125;&lt;/span&gt;&amp;nbsp;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>样式</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line">.<span class="property">order</span>-train .<span class="property">order</span>-train-main&#123;</span><br><span class="line">  font-<span class="attr">size</span>: 18px;</span><br><span class="line">  font-<span class="attr">weight</span>: bold;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>订单页面显示座位信息</p>
</blockquote>
<ul>
<li>首先修改EnumGenerator的路径，生成枚举</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;web/src/assets/js/enums.js&quot;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>所生成的枚举</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">PASSENGER_TYPE</span>=&#123;<span class="attr">ADULT</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;成人&quot;</span>&#125;,<span class="attr">CHILD</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;2&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;儿童&quot;</span>&#125;,<span class="attr">STUDENT</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;学生&quot;</span>&#125;&#125;;</span><br><span class="line"><span class="variable constant_">TRAIN_TYPE</span>=&#123;<span class="attr">G</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;G&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;高铁&quot;</span>,<span class="attr">priceRate</span>:<span class="string">&quot;1.2&quot;</span>&#125;,<span class="attr">D</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;D&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;动车&quot;</span>,<span class="attr">priceRate</span>:<span class="string">&quot;1&quot;</span>&#125;,<span class="attr">K</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;K&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;快速&quot;</span>,<span class="attr">priceRate</span>:<span class="string">&quot;0.8&quot;</span>&#125;&#125;;</span><br><span class="line"><span class="variable constant_">SEAT_TYPE</span>=&#123;<span class="attr">YDZ</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;一等座&quot;</span>,<span class="attr">price</span>:<span class="string">&quot;0.4&quot;</span>&#125;,<span class="attr">EDZ</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;2&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;二等座&quot;</span>,<span class="attr">price</span>:<span class="string">&quot;0.3&quot;</span>&#125;,<span class="attr">RW</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;软卧&quot;</span>,<span class="attr">price</span>:<span class="string">&quot;0.6&quot;</span>&#125;,<span class="attr">YW</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;4&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;硬卧&quot;</span>,<span class="attr">price</span>:<span class="string">&quot;0.5&quot;</span>&#125;&#125;;</span><br><span class="line"><span class="variable constant_">SEAT_COL</span>=&#123;<span class="attr">YDZ_A</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;A&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;A&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;1&quot;</span>&#125;,<span class="attr">YDZ_C</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;C&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;C&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;1&quot;</span>&#125;,<span class="attr">YDZ_D</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;D&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;D&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;1&quot;</span>&#125;,<span class="attr">YDZ_F</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;F&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;F&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;1&quot;</span>&#125;,<span class="attr">EDZ_A</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;A&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;A&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;2&quot;</span>&#125;,<span class="attr">EDZ_B</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;B&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;B&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;2&quot;</span>&#125;,<span class="attr">EDZ_C</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;C&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;C&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;2&quot;</span>&#125;,<span class="attr">EDZ_D</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;D&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;D&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;2&quot;</span>&#125;,<span class="attr">EDZ_F</span>:&#123;<span class="attr">code</span>:<span class="string">&quot;F&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;F&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;2&quot;</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">PASSENGER_TYPE_ARRAY</span>=[&#123;<span class="attr">code</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;成人&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;2&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;儿童&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;学生&quot;</span>&#125;];</span><br><span class="line"><span class="variable constant_">TRAIN_TYPE_ARRAY</span>=[&#123;<span class="attr">code</span>:<span class="string">&quot;G&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;高铁&quot;</span>,<span class="attr">priceRate</span>:<span class="string">&quot;1.2&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;D&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;动车&quot;</span>,<span class="attr">priceRate</span>:<span class="string">&quot;1&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;K&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;快速&quot;</span>,<span class="attr">priceRate</span>:<span class="string">&quot;0.8&quot;</span>&#125;];</span><br><span class="line"><span class="variable constant_">SEAT_TYPE_ARRAY</span>=[&#123;<span class="attr">code</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;一等座&quot;</span>,<span class="attr">price</span>:<span class="string">&quot;0.4&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;2&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;二等座&quot;</span>,<span class="attr">price</span>:<span class="string">&quot;0.3&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;软卧&quot;</span>,<span class="attr">price</span>:<span class="string">&quot;0.6&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;4&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;硬卧&quot;</span>,<span class="attr">price</span>:<span class="string">&quot;0.5&quot;</span>&#125;];</span><br><span class="line"><span class="variable constant_">SEAT_COL_ARRAY</span>=[&#123;<span class="attr">code</span>:<span class="string">&quot;A&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;A&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;1&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;C&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;C&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;1&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;D&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;D&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;1&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;F&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;F&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;1&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;A&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;A&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;2&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;B&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;B&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;2&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;C&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;C&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;2&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;D&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;D&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;2&quot;</span>&#125;,&#123;<span class="attr">code</span>:<span class="string">&quot;F&quot;</span>,<span class="attr">desc</span>:<span class="string">&quot;F&quot;</span>,<span class="attr">type</span>:<span class="string">&quot;2&quot;</span>&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>修改order.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;order-train-ticket&quot;&gt;</span><br><span class="line">  &lt;span v-for=&quot;item in seatTypes&quot; :key=&quot;item.type&quot;&gt;</span><br><span class="line">    &lt;span&gt;&#123;&#123;item.desc&#125;&#125;&lt;/span&gt;:</span><br><span class="line">    &lt;span class=&quot;order-train-ticket-main&quot;&gt;&#123;&#123;item.price&#125;&#125;￥&lt;/span&gt;&amp;nbsp;</span><br><span class="line">    &lt;span class=&quot;order-train-ticket-main&quot;&gt;&#123;&#123;item.count&#125;&#125;&lt;/span&gt;&amp;nbsp;张票&amp;nbsp;&amp;nbsp;</span><br><span class="line">  &lt;/span&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">SEAT_TYPE</span> =<span class="variable language_">window</span>.<span class="property">SEAT_TYPE</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">SEAT_TYPE</span>)</span><br><span class="line"><span class="comment">// 本车次提供的座位类型seatTypes，含票价，余票等信息，例：</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   type: &quot;YDZ&quot;,</span></span><br><span class="line"><span class="comment">//   code: &quot;1&quot;,</span></span><br><span class="line"><span class="comment">//   desc: &quot;一等座&quot;,</span></span><br><span class="line"><span class="comment">//   count: &quot;100&quot;,</span></span><br><span class="line"><span class="comment">//   price: &quot;50&quot;,</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// 关于SEAT_TYPE[KEY]：当知道某个具体的属性xxx时，可以用obj.xxx，当属性名是个变量时，可以使用obj[xxx]</span></span><br><span class="line"><span class="keyword">const</span> seatTypes = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> <span class="variable constant_">KEY</span> <span class="keyword">in</span> <span class="variable constant_">SEAT_TYPE</span>)&#123;</span><br><span class="line">  <span class="keyword">let</span> key = <span class="variable constant_">KEY</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">  <span class="keyword">if</span> (dailyTrainTicket[key]&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">    seatTypes.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>:<span class="variable constant_">KEY</span>,</span><br><span class="line">      <span class="attr">code</span>:<span class="variable constant_">SEAT_TYPE</span>[<span class="variable constant_">KEY</span>][<span class="string">&quot;code&quot;</span>],</span><br><span class="line">      <span class="attr">desc</span>:<span class="variable constant_">SEAT_TYPE</span>[<span class="variable constant_">KEY</span>][<span class="string">&quot;desc&quot;</span>],</span><br><span class="line">      <span class="attr">count</span>:dailyTrainTicket[key],</span><br><span class="line">      <span class="attr">price</span>:dailyTrainTicket[key + <span class="string">&#x27;Price&#x27;</span>],</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;本车次提供的座位:&quot;</span>,seatTypes)</span><br></pre></td></tr></table></figure>

<ul>
<li>增加样式</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">order</span>-train .<span class="property">order</span>-train-ticket &#123;</span><br><span class="line">  margin-<span class="attr">top</span>: 15px;</span><br><span class="line">&#125;</span><br><span class="line">.<span class="property">order</span>-train .<span class="property">order</span>-train-ticket .<span class="property">order</span>-train-ticket-main &#123;</span><br><span class="line">  <span class="attr">color</span>: red;</span><br><span class="line">  font-<span class="attr">size</span>: 18px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="订票页面勾选乘客并显示购票列表"><a href="#订票页面勾选乘客并显示购票列表" class="headerlink" title="订票页面勾选乘客并显示购票列表"></a>订票页面勾选乘客并显示购票列表</h2><blockquote>
<p>订票页面，查询我的所有的乘客（可以在新增乘客的时候，增加一个校验：超过50个乘客，就不能再新增了）</p>
</blockquote>
<ul>
<li>首先在com&#x2F;fzx&#x2F;train&#x2F;member&#x2F;下的PassengerService增加查询方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询我的所有乘客</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;PassengerQueryResp&gt; <span class="title function_">queryMine</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">PassengerExample</span> <span class="variable">passengerExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PassengerExample</span>();</span><br><span class="line">    passengerExample.setOrderByClause(<span class="string">&quot;name asc&quot;</span>);</span><br><span class="line">    PassengerExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> passengerExample.createCriteria();</span><br><span class="line">    criteria.andMemberIdEqualTo(LoginMemberContext.getId());</span><br><span class="line">    List&lt;Passenger&gt; list = passengerMapper.selectByExample(passengerExample);</span><br><span class="line">    <span class="keyword">return</span> BeanUtil.copyToList(list,PassengerQueryResp.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>PassengerController调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/query-mine&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;List&lt;PassengerQueryResp&gt;&gt; <span class="title function_">queryMine</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;PassengerQueryResp&gt; list = passengerService.queryMine();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(list);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改order.vue，增加一个显示的数据</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-divider&gt;&lt;/a-divider&gt;</span><br><span class="line">&#123;&#123;passengers&#125;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义一个变量</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> passengers = <span class="title function_">ref</span>([]);</span><br></pre></td></tr></table></figure>

<ul>
<li>定义查询请求方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleQueryPassenger</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">  axios.<span class="title function_">get</span>(<span class="string">&quot;/member/passenger/query-mine&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">      passengers.<span class="property">value</span> = data.<span class="property">content</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">handleQueryPassenger</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>订票页面，显示我的乘客复选框</p>
</blockquote>
<ul>
<li>order的显示界面</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-divider&gt;&lt;/a-divider&gt;</span><br><span class="line">&lt;b&gt;勾选要购票的乘客：&lt;/b&gt;&amp;nbsp;</span><br><span class="line">&lt;a-checkbox-group v-model:value=&quot;passengerChecks&quot; :options=&quot;passengerOption&quot;/&gt;</span><br><span class="line">&lt;br/&gt;</span><br><span class="line">选中的乘客：&#123;&#123;passengerChecks&#125;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义变量</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> passengerOption = <span class="title function_">ref</span>([]);</span><br><span class="line"><span class="keyword">const</span> passengerChecks = <span class="title function_">ref</span>([]);</span><br></pre></td></tr></table></figure>

<ul>
<li>在handleQueryPassenger成功后添加</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">passengers.<span class="property">value</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>)=&gt;</span>passengerOption.<span class="property">value</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">  <span class="attr">label</span>:item.<span class="property">name</span>,</span><br><span class="line">  <span class="attr">value</span>:item.<span class="property">id</span></span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>订票页面，为勾选的乘客构造购票数据</p>
</blockquote>
<ul>
<li>order增加购票列表显示</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;br/&gt;</span><br><span class="line">购票列表：&#123;&#123;tickets&#125;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加一个监听</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 购票列表，用于界面展示，并传递到后端接口，用来描述：哪个乘客购买什么座位的票</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   passengerId: 123,</span></span><br><span class="line"><span class="comment">//   passengerType: &quot;1&quot;,</span></span><br><span class="line"><span class="comment">//   passengerName: &quot;张三&quot;,</span></span><br><span class="line"><span class="comment">//   passengerIdCard: &quot;12323132132&quot;,</span></span><br><span class="line"><span class="comment">//   seatTypeCode: &quot;1&quot;,</span></span><br><span class="line"><span class="comment">//   seat: &quot;C1&quot;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">const</span> tickets = <span class="title function_">ref</span>([]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//勾选或去掉某个乘客时，在购票列表中加上或去掉一个表</span></span><br><span class="line"><span class="title function_">watch</span>(<span class="function">()=&gt;</span>passengerChecks.<span class="property">value</span>, <span class="function">(<span class="params">newVal,oldVal</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;勾选乘客发生变化&quot;</span>,newVal,oldVal);</span><br><span class="line">  <span class="comment">//每次有变化时，把购票列表清空，重新构造列表</span></span><br><span class="line">  tickets.<span class="property">value</span> = [];</span><br><span class="line">  passengerChecks.<span class="property">value</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span>tickets.<span class="property">value</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">    passengerId :item.<span class="property">id</span>,</span><br><span class="line">    passengerType :item.<span class="property">type</span>,</span><br><span class="line">    seatTypeCode :seatTypes[<span class="number">0</span>].<span class="property">code</span>,</span><br><span class="line">    passengerName :item.<span class="property">name</span>,</span><br><span class="line">    passengerIdCard :item.<span class="property">idCard</span>,</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;,&#123;<span class="attr">immediate</span>:<span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>由于单独传给乘客id是不够用的，所以这还是改为item</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307241521271.png"
                      alt="image-20230724152129614"
                ></p>
<ul>
<li>最后将tickets返回</li>
</ul>
<blockquote>
<p>订票页面，优化购票列表的展示</p>
</blockquote>
<ul>
<li>在order增加</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;order-tickets&quot;&gt;</span><br><span class="line">  &lt;a-row class=&quot;order-tickets-header&quot; v-if=&quot;tickets.length &gt; 0&quot;&gt;</span><br><span class="line">    &lt;a-col :span=&quot;2&quot;&gt;乘客&lt;/a-col&gt;</span><br><span class="line">    &lt;a-col :span=&quot;6&quot;&gt;身份证&lt;/a-col&gt;</span><br><span class="line">    &lt;a-col :span=&quot;4&quot;&gt;票种&lt;/a-col&gt;</span><br><span class="line">    &lt;a-col :span=&quot;4&quot;&gt;座位类型&lt;/a-col&gt;</span><br><span class="line">  &lt;/a-row&gt;</span><br><span class="line">  &lt;a-row class=&quot;order-tickets-row&quot; v-for=&quot;ticket in tickets&quot; :key=&quot;ticket.passengerId&quot;&gt;</span><br><span class="line">    &lt;a-col :span=&quot;2&quot;&gt;&#123;&#123;ticket.passengerName&#125;&#125;&lt;/a-col&gt;</span><br><span class="line">    &lt;a-col :span=&quot;6&quot;&gt;&#123;&#123;ticket.passengerIdCard&#125;&#125;&lt;/a-col&gt;</span><br><span class="line">    &lt;a-col :span=&quot;4&quot;&gt;</span><br><span class="line">      &lt;a-select v-model:value=&quot;ticket.passengerType&quot; style=&quot;width: 100%&quot;&gt;</span><br><span class="line">        &lt;a-select-option v-for=&quot;item in PASSENGER_TYPE_ARRAY&quot; :key=&quot;item.code&quot; :value=&quot;item.code&quot;&gt;</span><br><span class="line">          &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">        &lt;/a-select-option&gt;</span><br><span class="line">      &lt;/a-select&gt;</span><br><span class="line">    &lt;/a-col&gt;</span><br><span class="line">    &lt;a-col :span=&quot;4&quot;&gt;</span><br><span class="line">      &lt;a-select v-model:value=&quot;ticket.seatTypeCode&quot; style=&quot;width: 100%&quot;&gt;</span><br><span class="line">        &lt;a-select-option v-for=&quot;item in seatTypes&quot; :key=&quot;item.code&quot; :value=&quot;item.code&quot;&gt;</span><br><span class="line">          &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">        &lt;/a-select-option&gt;</span><br><span class="line">      &lt;/a-select&gt;</span><br><span class="line">    &lt;/a-col&gt;</span><br><span class="line">  &lt;/a-row&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义变量</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">PASSENGER_TYPE_ARRAY</span> = <span class="variable language_">window</span>.<span class="property">PASSENGER_TYPE_ARRAY</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>返回PASSENGER_TYPE_ARRAY</li>
</ul>
<blockquote>
<p>订票页面，勾选乘客后提交，显示购票列表确认框</p>
</blockquote>
<ul>
<li>增加一个提交订单模态框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;div v-if=&quot;tickets.length &gt; 0&quot;&gt;</span><br><span class="line">  &lt;a-button type=&quot;primary&quot; size=&quot;large&quot; @click=&quot;finishCheckPassenger&quot;&gt;提交订单&lt;/a-button&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;a-modal v-model:visible=&quot;visible&quot; title=&quot;请核对以下信息&quot;</span><br><span class="line">         style=&quot;top: 50px; width: 800px&quot;</span><br><span class="line">         ok-text=&quot;确认&quot; cancel-text=&quot;取消&quot;</span><br><span class="line">         @ok=&quot;showFirstImageCodeModal&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;order-tickets&quot;&gt;</span><br><span class="line">    &lt;a-row class=&quot;order-tickets-header&quot; v-if=&quot;tickets.length &gt; 0&quot;&gt;</span><br><span class="line">      &lt;a-col :span=&quot;3&quot;&gt;乘客&lt;/a-col&gt;</span><br><span class="line">      &lt;a-col :span=&quot;15&quot;&gt;身份证&lt;/a-col&gt;</span><br><span class="line">      &lt;a-col :span=&quot;3&quot;&gt;票种&lt;/a-col&gt;</span><br><span class="line">      &lt;a-col :span=&quot;3&quot;&gt;座位类型&lt;/a-col&gt;</span><br><span class="line">    &lt;/a-row&gt;</span><br><span class="line">    &lt;a-row class=&quot;order-tickets-row&quot; v-for=&quot;ticket in tickets&quot; :key=&quot;ticket.passengerId&quot;&gt;</span><br><span class="line">      &lt;a-col :span=&quot;3&quot;&gt;&#123;&#123;ticket.passengerName&#125;&#125;&lt;/a-col&gt;</span><br><span class="line">      &lt;a-col :span=&quot;15&quot;&gt;&#123;&#123;ticket.passengerIdCard&#125;&#125;&lt;/a-col&gt;</span><br><span class="line">      &lt;a-col :span=&quot;3&quot;&gt;</span><br><span class="line">        &lt;span v-for=&quot;item in PASSENGER_TYPE_ARRAY&quot; :key=&quot;item.code&quot;&gt;</span><br><span class="line">          &lt;span v-if=&quot;item.code === ticket.passengerType&quot;&gt;</span><br><span class="line">            &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">          &lt;/span&gt;</span><br><span class="line">        &lt;/span&gt;</span><br><span class="line">      &lt;/a-col&gt;</span><br><span class="line">      &lt;a-col :span=&quot;3&quot;&gt;</span><br><span class="line">        &lt;span v-for=&quot;item in seatTypes&quot; :key=&quot;item.code&quot;&gt;</span><br><span class="line">          &lt;span v-if=&quot;item.code === ticket.seatTypeCode&quot;&gt;</span><br><span class="line">            &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">          &lt;/span&gt;</span><br><span class="line">        &lt;/span&gt;</span><br><span class="line">      &lt;/a-col&gt;</span><br><span class="line">    &lt;/a-row&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/a-modal&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义变量</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visible = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>定义方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">finishCheckPassenger</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;购票列表：&quot;</span>,tickets.<span class="property">value</span>);</span><br><span class="line">  <span class="keyword">if</span> (tickets.<span class="property">value</span>.<span class="property">length</span>&gt;<span class="number">5</span>)&#123;</span><br><span class="line">    notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:<span class="string">&#x27;最多只能购买5张车票&#x27;</span>&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//弹出确认界面</span></span><br><span class="line">  visible.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将visible,finishCheckPassenger返回</li>
</ul>
<blockquote>
<p>如果遇到【查找我的所有的XXX】这样的功能，需要考虑数据量的问题<br> <code>一种是限制我的XXX的数量，在新增的时候，做校验，如果超过100，就不能再新增</code><br><code> 一种是限制查询的数量，最多返回前100条数据</code></p>
</blockquote>
<h2 id="分解选座购票功能的前后端逻辑"><a href="#分解选座购票功能的前后端逻辑" class="headerlink" title="分解选座购票功能的前后端逻辑"></a>分解选座购票功能的前后端逻辑</h2><ul>
<li><p>12306规则：</p>
<ul>
<li>只有全部是一等座或全部是二等座才支持选座</li>
<li>余票小于一定数量时，不允许选座（本项目以20为例）</li>
</ul>
</li>
<li><p>选座效果：</p>
</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307241630704.png"
                      alt="image-20230724163006279"
                ></p>
<ul>
<li>座位类型枚举：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307241630471.png"
                      alt="image-20230724163044132"
                ></p>
<ul>
<li>构造两个重要的响应式变量：&#x2F;&#x2F; 0：不支持选座；1：选一等座；2：选二等座</li>
</ul>
<blockquote>
<p>const chooseSeatType &#x3D; ref(0);</p>
</blockquote>
<ul>
<li>选择的座位</li>
</ul>
<blockquote>
<p>A1: false, C1: true，D1: false, F1: false，</p>
<p>A2: false, C2: false，D2: true, F2: false</p>
<p>const chooseSeatObj &#x3D; ref({});</p>
</blockquote>
<ul>
<li>最终购票tickets：</li>
</ul>
<blockquote>
<p>&#x2F;&#x2F; seat可选，当无选座时，seat为空</p>
<p>[{</p>
<p> passengerId: 123,</p>
<p> passengerType: “1”,</p>
<p> seatTypeCode: “1”,</p>
<p> passengerName: “张三”,</p>
<p> passengerIdCard: “12323132132”,</p>
<p> seat: “C1”</p>
<p>}, {</p>
<p> passengerId: 123,</p>
<p> passengerType: “1”,</p>
<p> seatTypeCode: “1”,</p>
<p> passengerName: “李四”,</p>
<p> passengerIdCard: “12323132132”,</p>
<p> seat: “D2”</p>
<p>}]</p>
</blockquote>
<ul>
<li>座位售卖详情，比如有ABCDE五个站，sell&#x3D;0110，则AB未被购买，AC已被购买</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307241632824.png"
                      alt="image-20230724163257463"
                ></p>
<ul>
<li>后端购票逻辑，分成选座和不选座<ul>
<li>不选座，以购买一等座为例：遍历一等座车厢，每个车厢从1号座位开始找，未被购买的，就选中它</li>
<li>选座，以购买两张一等座AB为例：遍历一等座车厢，每个车厢从1号座位开始找A列座位，未被购买的，就预选中它；再挑它旁边的B，如果也未被购买，则最终选中这两个座位，如果B已被购买，则回到第一步，继续找未被购买的A座。</li>
<li><strong>从第二个座位开始，需要计算和第一个座位的偏移值，可以减少循环，提高选座效率</strong></li>
</ul>
</li>
</ul>
<h2 id="订票页面增加选座效果"><a href="#订票页面增加选座效果" class="headerlink" title="订票页面增加选座效果"></a>订票页面增加选座效果</h2><blockquote>
<p>勾选乘客后，提交时，校验余票是否足够（前端校验不一定准，但前端校验可以减轻后端（很多压力）</p>
</blockquote>
<ul>
<li><p>前后端都得加校验，前端校验可以减轻后端压力，后端校验是真实的校验。后端不要相信前端，比如一些非空校验，不能前端有校验了，后端就省了</p>
</li>
<li><p>在finishCheckPassenger中增加校验</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 校验余票是否充足，购票列表中的每个座位类型，都去车次座位余票信息中，看余票是否充足</span></span><br><span class="line"><span class="comment">// 前端校验不一定准，但前端校验可以减轻后端很多压力</span></span><br><span class="line"><span class="comment">// 注意：这段只是校验，必须copy出seatTypesTemp变量来扣减，用原始的seatTypes去扣减，会影响真实的库存</span></span><br><span class="line"><span class="keyword">let</span> seatTypesTemp = <span class="title class_">Tool</span>.<span class="title function_">copy</span>(seatTypes);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;tickets.<span class="property">value</span>.<span class="property">length</span>;i++)&#123;</span><br><span class="line">  <span class="keyword">let</span> ticket = tickets.<span class="property">value</span>[i];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; seatTypesTemp.<span class="property">length</span>; j++) &#123;</span><br><span class="line">    <span class="keyword">let</span> seatType = seatTypesTemp[j];</span><br><span class="line">    <span class="comment">//同类型座位余票-1，这里扣减的是临时copy出来的库存，不是真的库存，知识为了校验</span></span><br><span class="line">    <span class="keyword">if</span> (ticket.<span class="property">seatTypeCode</span> === seatType.<span class="property">code</span>)&#123;</span><br><span class="line">      seatType.<span class="property">count</span>--;</span><br><span class="line">      <span class="keyword">if</span> (seatType.<span class="property">count</span> &lt;<span class="number">0</span>)&#123;</span><br><span class="line">        notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:seatType.<span class="property">desc</span>+<span class="string">&#x27;余票不足&#x27;</span>&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;前端余票查询通过&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>根据购票列表，计算出是否支持选座</p>
</blockquote>
<ul>
<li><p>computed和watch类似，都可以用来响应式的计算一个值，compute可以像第二个提交这样写，直接声明出一个响应式变量</p>
</li>
<li><p>首先order页面显示，在订单里</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;br/&gt;</span><br><span class="line">选座类型chooseSeatType:&#123;&#123;chooseSeatType&#125;&#125;</span><br><span class="line">&lt;br/&gt;</span><br><span class="line">选座对象chooseSeatObj:&#123;&#123;chooseSeatObj&#125;&#125;</span><br><span class="line">&lt;br/&gt;</span><br><span class="line">选座类型SEAT_COL_ARRAY:&#123;&#123;SEAT_COL_ARRAY&#125;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加一个选座的逻辑</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0：不支持选座；1：选一等座；2：选2等座</span></span><br><span class="line"><span class="keyword">const</span> chooseSeatType = <span class="title function_">ref</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//根据选择的座位类型，计算出对应的列，比如要选的是一等座，就筛选出ACDF，要选的是二等座，就筛选出ABCDF</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SEAT_COL_ARRAY</span> =<span class="title function_">computed</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="property">SEAT_COL_ARRAY</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">item</span> =&gt;</span>item.<span class="property">type</span> === chooseSeatType.<span class="property">value</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 选择的座位</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   A1: false, C1: true，D1: false, F1: false，</span></span><br><span class="line"><span class="comment">//   A2: false, C2: false，D2: true, F2: false</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">const</span> chooseSeatObj = <span class="title function_">ref</span>(&#123;&#125;);</span><br><span class="line"><span class="title function_">watch</span>(<span class="function">()=&gt;</span><span class="variable constant_">SEAT_COL_ARRAY</span>.<span class="property">value</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;=<span class="number">2</span>; i++) &#123;</span><br><span class="line">    <span class="variable constant_">SEAT_COL_ARRAY</span>.<span class="property">value</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>)=&gt;</span>&#123;</span><br><span class="line">      chooseSeatObj.<span class="property">value</span>[item.<span class="property">code</span>+i] = <span class="literal">false</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;初始化两排座位，都是未选中：&quot;</span>,chooseSeatObj.<span class="property">value</span>);</span><br><span class="line">&#125;,&#123;<span class="attr">immediate</span>:<span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>在finishCheckPassenger方法中增加如下判断</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断是否支持选座，只有纯一等座和纯二等座支持选座</span></span><br><span class="line"><span class="comment">//先筛选出购票列表中的所有座位类型，比如四张表：【1，1，2，2】</span></span><br><span class="line"><span class="keyword">let</span> ticketSeatTypeCodes = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tickets.<span class="property">value</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">let</span> ticket = tickets.<span class="property">value</span>[i];</span><br><span class="line">  ticketSeatTypeCodes.<span class="title function_">push</span>(ticket.<span class="property">seatTypeCode</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//为购票列表中所有的座位类型去重：【1，2】</span></span><br><span class="line"><span class="keyword">const</span> ticketSeatTypeCodesSet = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Set</span>(ticketSeatTypeCodes));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;选好的座位类型：&quot;</span>,ticketSeatTypeCodesSet);</span><br><span class="line"><span class="keyword">if</span> (ticketSeatTypeCodesSet.<span class="property">length</span> !==<span class="number">1</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;选了多种座位，不支持选座&quot;</span>);</span><br><span class="line">  chooseSeatType.<span class="property">value</span> = <span class="number">0</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (ticketSeatTypeCodesSet[<span class="number">0</span>] === <span class="variable constant_">SEAT_TYPE</span>.<span class="property">YDZ</span>.<span class="property">code</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;一等座选座&quot;</span>);</span><br><span class="line">    chooseSeatType.<span class="property">value</span> = <span class="variable constant_">SEAT_TYPE</span>.<span class="property">YDZ</span>.<span class="property">code</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span> (ticketSeatTypeCodesSet[<span class="number">0</span>] === <span class="variable constant_">SEAT_TYPE</span>.<span class="property">EDZ</span>.<span class="property">code</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;二等座选座&quot;</span>);</span><br><span class="line">    chooseSeatType.<span class="property">value</span> = <span class="variable constant_">SEAT_TYPE</span>.<span class="property">EDZ</span>.<span class="property">code</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不是一等座或二等座，不支持选座&quot;</span>);</span><br><span class="line">    chooseSeatType.<span class="property">value</span> = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后将参数返回</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chooseSeatType,</span><br><span class="line">chooseSeatObj,</span><br><span class="line"><span class="variable constant_">SEAT_COL_ARRAY</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>根据购票列表，展示选座按钮</p>
</blockquote>
<ul>
<li><p>常见的代码设计：如果一个操作可以反复多次，则可以清空上一次的操作，再重新赋值，避免上一次的数据对本次的操作造成影响</p>
</li>
<li><p>这里就是增加一个前端</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> &lt;br/&gt;</span><br><span class="line">  选座对象chooseSeatObj:&#123;&#123;chooseSeatObj&#125;&#125;</span><br><span class="line">  &lt;br/&gt;</span><br><span class="line">  &lt;div v-if=&quot;chooseSeatType === 0&quot; style=&quot;color: red;&quot;&gt;</span><br><span class="line">    您购买的车票不支持选座</span><br><span class="line">    &lt;div&gt;12306规则：只有全部是一等座或全部是二等座才支持选座&lt;/div&gt;</span><br><span class="line">    &lt;div&gt;12306规则：余票小于一定数量时，不允许选座&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div v-else style=&quot;text-align: center&quot;&gt;</span><br><span class="line">    &lt;a-switch class=&quot;choose-seat-item&quot; v-for=&quot;item in SEAT_COL_ARRAY&quot; :key=&quot;item.code&quot;</span><br><span class="line">              v-model:checked=&quot;chooseSeatObj[item.code + &#x27;1&#x27;]&quot; :checked-children=&quot;item.desc&quot; :un-checked-children=&quot;item.desc&quot; /&gt;</span><br><span class="line">    &lt;div v-if=&quot;tickets.length &gt; 1&quot;&gt;</span><br><span class="line">      &lt;a-switch class=&quot;choose-seat-item&quot; v-for=&quot;item in SEAT_COL_ARRAY&quot; :key=&quot;item.code&quot;</span><br><span class="line">                v-model:checked=&quot;chooseSeatObj[item.code + &#x27;2&#x27;]&quot; :checked-children=&quot;item.desc&quot; :un-checked-children=&quot;item.desc&quot; /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div style=&quot;color: #999999&quot;&gt;提示：您可以选择&#123;&#123;tickets.length&#125;&#125;个座位&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>余票小于10张时，不允许选座</p>
</blockquote>
<ul>
<li>在handleQueryPassenger中判断是一等座或二等座的里面增加一个逻辑</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//余票小于10张，不允许选座，否则选座成功率不高，影响出票</span></span><br><span class="line"><span class="keyword">if</span> (chooseSeatType.<span class="property">value</span> !== <span class="number">0</span>)&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; seatTypes.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> seatType = seatTypes[i];</span><br><span class="line">    <span class="comment">//找到同类型座位</span></span><br><span class="line">    <span class="keyword">if</span> (ticketSeatTypeCodesSet[<span class="number">0</span>] === seatType.<span class="property">code</span>)&#123;</span><br><span class="line">      <span class="comment">//判断余票，小于20张就不支持选票</span></span><br><span class="line">      <span class="keyword">if</span> (seatType.<span class="property">count</span> &lt;<span class="number">10</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;余票小于10张就不支持选座&quot;</span>)</span><br><span class="line">        chooseSeatType.<span class="property">value</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>确认提交时，计算出最终每个乘客所选的座位</p>
</blockquote>
<ul>
<li><p>在提交订单的模态框上增加一个ok事件 @ok&#x3D;”handleOk”</p>
</li>
<li><p>并增加一个页面显示</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;br/&gt;</span><br><span class="line">最终购票：&#123;&#123;tickets&#125;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加hanleOk事件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleOk</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;选好的座位：&quot;</span>,chooseSeatObj.<span class="property">value</span>);</span><br><span class="line">  <span class="comment">//设置每张票的座位</span></span><br><span class="line">  <span class="comment">//先清空购票列表的座位，有可能之前选了并设置了座位，但是选座位数不对被拦截了，又重新选一遍</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tickets.<span class="property">value</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    tickets.<span class="property">value</span>[i].<span class="property">seat</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> i = -<span class="number">1</span>;</span><br><span class="line">  <span class="comment">//要么不选座位，要么所选择座位应该等于购票数，即i ===(tickets.value.length -1)</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> key <span class="keyword">in</span> chooseSeatObj.<span class="property">value</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (chooseSeatObj.<span class="property">value</span>[key])&#123;</span><br><span class="line">      i++;</span><br><span class="line">      <span class="keyword">if</span> (i&gt;tickets.<span class="property">value</span>.<span class="property">length</span>-<span class="number">1</span>)&#123;</span><br><span class="line">        notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:<span class="string">&#x27;所选座位数大于购票数&#x27;</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      tickets.<span class="property">value</span>[i].<span class="property">seat</span> = key;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (i&gt; -<span class="number">1</span> &amp;&amp; i&lt;(tickets.<span class="property">value</span>.<span class="property">length</span>-<span class="number">1</span>))&#123;</span><br><span class="line">    notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:<span class="string">&#x27;所选座位数小于购票数&#x27;</span>&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;最终购票：&quot;</span>,tickets.<span class="property">value</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>但是有一个问题就是在二等座上一次的选择包含了B1，现在去了一等座，虽然页面看不到按钮，但chooseSeatObj.B1&#x3D;true，所以导致程序认为你选择了三张票</li>
</ul>
<blockquote>
<p>chooseSeatobj先清空，再初始化，保证两排座位是有序的</p>
</blockquote>
<ul>
<li>这个就是加了一行代码在watch监听SEAT_COL_ARRAY的时候</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chooseSeatObj.<span class="property">value</span> =&#123;&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="增加确认订单表并生成前后端代码"><a href="#增加确认订单表并生成前后端代码" class="headerlink" title="增加确认订单表并生成前后端代码"></a>增加确认订单表并生成前后端代码</h2><ul>
<li>首先增加一个确认订单表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `confirm_order`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `confirm_order` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `member_id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;会员id&#x27;</span>,</span><br><span class="line">  `<span class="type">date</span>` <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">  `train_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `<span class="keyword">start</span>` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;出发站&#x27;</span>,</span><br><span class="line">  `<span class="keyword">end</span>` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;到达站&#x27;</span>,</span><br><span class="line">  `daily_train_ticket_id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;余票ID&#x27;</span>,</span><br><span class="line">  `tickets` json <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车票&#x27;</span>,</span><br><span class="line">  `status` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;订单状态|枚举[ConfirmOrderStatusEnum]&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  index `date_train_code_index` (`<span class="type">date</span>`, `train_code`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;确认订单&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>生成订单状态的枚举值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ConfirmOrderStatusEnum</span> &#123;</span><br><span class="line">    INIT(<span class="string">&quot;I&quot;</span>,<span class="string">&quot;初始&quot;</span>),</span><br><span class="line">    PENDING(<span class="string">&quot;P&quot;</span>,<span class="string">&quot;处理时&quot;</span>),</span><br><span class="line">    SUCCESS(<span class="string">&quot;S&quot;</span>,<span class="string">&quot;成功&quot;</span>),</span><br><span class="line">    FAILURE(<span class="string">&quot;F&quot;</span>,<span class="string">&quot;失败&quot;</span>),</span><br><span class="line">    EMPTY(<span class="string">&quot;E&quot;</span>,<span class="string">&quot;无票&quot;</span>),</span><br><span class="line">    CANCEL(<span class="string">&quot;C&quot;</span>,<span class="string">&quot;取消&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="keyword">private</span>  String desc;</span><br><span class="line"></span><br><span class="line">    ConfirmOrderStatusEnum(String code, String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDesc</span><span class="params">(String desc)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;ConfirmOrderStatusEnum&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;code=&#x27;&quot;</span>).append(code).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, desc=&#x27;&quot;</span>).append(desc).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>最后就一套生成器</li>
</ul>
<h2 id="后端增加确认下单购票接口"><a href="#后端增加确认下单购票接口" class="headerlink" title="后端增加确认下单购票接口"></a>后端增加确认下单购票接口</h2><ul>
<li>首先创建一个类来描述购买票的信息，跟前端那个票信息一致</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotBlank;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotNull;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmOrderTicketReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 乘客ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【乘客ID】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long passengerId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 乘客票种</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【乘客票种】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String passengerType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 乘客名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【乘客名称】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String passengerName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 乘客身份证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【乘客身份证】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String passengerIdCard;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 座位类型code</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【座位类型code】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String seatTypeCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 选座，可空，值示例：A1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String seat;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getPassengerId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> passengerId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassengerId</span><span class="params">(Long passengerId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.passengerId = passengerId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassengerType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> passengerType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassengerType</span><span class="params">(String passengerType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.passengerType = passengerType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassengerName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> passengerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassengerName</span><span class="params">(String passengerName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.passengerName = passengerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassengerIdCard</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> passengerIdCard;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassengerIdCard</span><span class="params">(String passengerIdCard)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.passengerIdCard = passengerIdCard;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSeatTypeCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seatTypeCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeatTypeCode</span><span class="params">(String seatTypeCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seatTypeCode = seatTypeCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSeat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeat</span><span class="params">(String seat)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seat = seat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;ConfirmOrderTicketReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;passengerId=&quot;</span>).append(passengerId);</span><br><span class="line">        sb.append(<span class="string">&quot;, passengerType=&#x27;&quot;</span>).append(passengerType).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, passengerName=&#x27;&quot;</span>).append(passengerName).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, passengerIdCard=&#x27;&quot;</span>).append(passengerIdCard).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, seatTypeCode=&#x27;&quot;</span>).append(seatTypeCode).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, seat=&#x27;&quot;</span>).append(seat).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>常见的安全性校验：后端需要做好参数合法性校验，防止黑客绕过界面，直接访问接口</p>
</li>
<li><p>然后我们将confirmOrderSaveReq重命名为confirmOrderDoReq，并修改里面的字段(springboot在接收参数时，可以将json数组映射成List)</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotBlank;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotNull;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">confirmOrderDoReq</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 会员id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long memberId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd&quot;,timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【日期】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 车次编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【车次编号】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String trainCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出发站</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【出发站】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 到达站</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【到达站】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String end;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 余票ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【余票ID】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long dailyTrainTicketId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 车票</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;【车票】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ConfirmOrderTicketReq&gt; tickets;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getMemberId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMemberId</span><span class="params">(Long memberId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.memberId = memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDate</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrainCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrainCode</span><span class="params">(String trainCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trainCode = trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStart</span><span class="params">(String start)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnd</span><span class="params">(String end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getDailyTrainTicketId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dailyTrainTicketId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDailyTrainTicketId</span><span class="params">(Long dailyTrainTicketId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dailyTrainTicketId = dailyTrainTicketId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;ConfirmOrderTicketReq&gt; <span class="title function_">getTickets</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tickets;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTickets</span><span class="params">(List&lt;ConfirmOrderTicketReq&gt; tickets)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tickets = tickets;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;confirmOrderDoReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;memberId=&quot;</span>).append(memberId);</span><br><span class="line">        sb.append(<span class="string">&quot;, date=&quot;</span>).append(date);</span><br><span class="line">        sb.append(<span class="string">&quot;, trainCode=&#x27;&quot;</span>).append(trainCode).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, start=&#x27;&quot;</span>).append(start).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, end=&#x27;&quot;</span>).append(end).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, dailyTrainTicketId=&quot;</span>).append(dailyTrainTicketId);</span><br><span class="line">        sb.append(<span class="string">&quot;, tickets=&quot;</span>).append(tickets);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来我们定义一个接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.confirmOrderDoReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.confirmOrderQueryReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.resp.confirmOrderQueryResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.service.confirmOrderService;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.PageResp;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/confirm-order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">confirmOrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> confirmOrderService confirmOrderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/do&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;Object&gt; <span class="title function_">doConfirm</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> confirmOrderDoReq req)</span>&#123;</span><br><span class="line">        confirmOrderService.doConfirm(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在confirmOrderService增加一个处理订单逻辑方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doConfirm</span><span class="params">(confirmOrderDoReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//省略业务数据校验，如：车次是否存在，余票是否存在，车次是否在有效期内，tickets条数&gt;0，同乘客同车次是否已买过</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存确认订单表，状态初始</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//查出余票记录，需要得到真实的库存</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//扣减余票数量，并判断余票是否足够</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//选座</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//一个车厢一个车厢的获取座位数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//挑选符合条件的座位，如果这个车厢不满足，则进入下一个车厢（多个选座应该在同一车厢）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//选中作为后事务处理</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//座位表修改售卖情况sell</span></span><br><span class="line">        <span class="comment">//余票详细表修改余票</span></span><br><span class="line">        <span class="comment">//为会员增加购票记录</span></span><br><span class="line">        <span class="comment">//更新确认订单为成功</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们在order.vue的最终购票后面增加一个前后端交互</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;最终购票：&quot;</span>,tickets.<span class="property">value</span>);</span><br><span class="line"></span><br><span class="line">axios.<span class="title function_">post</span>(<span class="string">&quot;/business/confirm-order/do&quot;</span>,&#123;</span><br><span class="line">  <span class="attr">dailyTrainTicketId</span>: dailyTrainTicket.<span class="property">id</span>,</span><br><span class="line">  <span class="attr">date</span>: dailyTrainTicket.<span class="property">date</span>,</span><br><span class="line">  <span class="attr">trainCode</span>:dailyTrainTicket.<span class="property">trainCode</span>,</span><br><span class="line">  <span class="attr">start</span>:dailyTrainTicket.<span class="property">start</span>,</span><br><span class="line">  <span class="attr">end</span>:dailyTrainTicket.<span class="property">end</span>,</span><br><span class="line">  <span class="attr">tickets</span>:tickets.<span class="property">value</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">  <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">    notification.<span class="title function_">success</span>(&#123;<span class="attr">description</span>:<span class="string">&quot;下单成功！&quot;</span>&#125;);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>后端校验分为两种：<ul>
<li>数据合法性校验：必输、长度、格式</li>
<li>业务合法性校验：表数据是否存在？日期范围是否合理？</li>
</ul>
</li>
</ul>
<h2 id="确认下单接口数据初始化"><a href="#确认下单接口数据初始化" class="headerlink" title="确认下单接口数据初始化"></a>确认下单接口数据初始化</h2><ul>
<li>现在处理ConfirmOrderService的doConfirm方法逻辑</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存确认订单表，状态初始</span></span><br><span class="line"><span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line"><span class="type">ConfirmOrder</span> <span class="variable">confirmOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmOrder</span>();</span><br><span class="line">confirmOrder.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">confirmOrder.setCreateTime(now);</span><br><span class="line">confirmOrder.setUpdateTime(now);</span><br><span class="line">confirmOrder.setMemberId(LoginMemberContext.getId());</span><br><span class="line">confirmOrder.setDate(req.getDate());</span><br><span class="line">confirmOrder.setTrainCode(req.getTrainCode());</span><br><span class="line">confirmOrder.setStart(req.getStart());</span><br><span class="line">confirmOrder.setEnd(req.getEnd());</span><br><span class="line">confirmOrder.setDailyTrainTicketId(req.getDailyTrainTicketId());</span><br><span class="line">confirmOrder.setStatus(ConfirmOrderStatusEnum.INIT.getCode());</span><br><span class="line">confirmOrder.setTickets(JSON.toJSONString(req.getTickets()));</span><br><span class="line">confirmOrderMapper.insert(confirmOrder);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查出余票记录，需要得到真实的库存；business增加会员拦截器，将会员信息放入线程本地变量</p>
</blockquote>
<ul>
<li>在DailyTrainTicketService中增加查询唯一键方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DailyTrainTicket <span class="title function_">selectByUnique</span><span class="params">(Date date,String trainCode,String start,String end)</span> &#123;</span><br><span class="line">    <span class="type">DailyTrainTicketExample</span> <span class="variable">dailyTrainTicketExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainTicketExample</span>();</span><br><span class="line">    dailyTrainTicketExample.createCriteria()</span><br><span class="line">            .andDateEqualTo(date)</span><br><span class="line">            .andTrainCodeEqualTo(trainCode)</span><br><span class="line">            .andStartEqualTo(start)</span><br><span class="line">            .andEndEqualTo(end);</span><br><span class="line">    List&lt;DailyTrainTicket&gt; list = dailyTrainTicketMapper.selectByExample(dailyTrainTicketExample);</span><br><span class="line">    <span class="keyword">if</span> (CollUtil.isNotEmpty(list))&#123;</span><br><span class="line">        <span class="keyword">return</span> list.get(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在ConfirmOrderService中使用，这里把保存确认订单表，状态初始步骤中一些常用的提取成一个变量</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DailyTrainTicketService dailyTrainTicketService;</span><br><span class="line"></span><br><span class="line"><span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span>req.getDate();</span><br><span class="line"><span class="type">String</span> <span class="variable">trainCode</span> <span class="operator">=</span> req.getTrainCode();</span><br><span class="line"><span class="type">String</span> <span class="variable">start</span> <span class="operator">=</span> req.getStart();</span><br><span class="line"><span class="type">String</span> <span class="variable">end</span> <span class="operator">=</span> req.getEnd();</span><br><span class="line">List&lt;ConfirmOrderTicketReq&gt; tickets = req.getTickets();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//查出余票记录，需要得到真实的库存</span></span><br><span class="line"><span class="type">DailyTrainTicket</span> <span class="variable">dailyTrainTicket</span> <span class="operator">=</span> dailyTrainTicketService.selectByUnique(date, trainCode, start, end);</span><br></pre></td></tr></table></figure>

<ul>
<li>这里有个错误LoginMemberContext获取不到，是因为business的config的SpringMvcConfig没有配置拦截器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line">MemberInterceptor memberInterceptor;</span><br><span class="line"></span><br><span class="line">registry.addInterceptor(memberInterceptor)</span><br><span class="line">    .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">    .excludePathPatterns(</span><br><span class="line">    <span class="string">&quot;/business/hello&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>MemberIntercepter：会员拦截器，用于将当前登录的会员放到线程本地变量。要想使用这个功能，需要在SpringMvcConfig里配置下，打开这个功能</p>
</blockquote>
<h2 id="预扣减库存并判断余票是否足够"><a href="#预扣减库存并判断余票是否足够" class="headerlink" title="预扣减库存并判断余票是否足够"></a>预扣减库存并判断余票是否足够</h2><ul>
<li>在BusinessExceptionEnum增加一个枚举</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIRM_ORDER_TICKET_COUNT_ERROR(<span class="string">&quot;余票不足&quot;</span>),</span><br></pre></td></tr></table></figure>

<ul>
<li>在ConfirmOrderService的doConfirm方法逻辑中（扣减余票数量，并判断余票是否足够）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//扣减余票数量，并判断余票是否足够</span></span><br><span class="line"> reduceTickets(req, dailyTrainTicket);</span><br><span class="line">        </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reduceTickets</span><span class="params">(ConfirmOrderDoReq req, DailyTrainTicket dailyTrainTicket)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (ConfirmOrderTicketReq ticketReq : req.getTickets())&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">seatTypeCode</span> <span class="operator">=</span> ticketReq.getSeatTypeCode();</span><br><span class="line">        <span class="type">SeatTypeEnum</span> <span class="variable">seatTypeEnum</span> <span class="operator">=</span> EnumUtil.getBy(SeatTypeEnum::getCode, seatTypeCode);</span><br><span class="line">        <span class="keyword">switch</span> (seatTypeEnum)&#123;</span><br><span class="line">            <span class="keyword">case</span> YDZ -&gt;&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">countLeft</span> <span class="operator">=</span> dailyTrainTicket.getYdz()-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (countLeft &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_TICKET_COUNT_ERROR);</span><br><span class="line">                &#125;</span><br><span class="line">                dailyTrainTicket.setYdz(countLeft);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> EDZ -&gt;&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">countLeft</span> <span class="operator">=</span> dailyTrainTicket.getEdz()-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (countLeft &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_TICKET_COUNT_ERROR);</span><br><span class="line">                &#125;</span><br><span class="line">                dailyTrainTicket.setEdz(countLeft);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> RW -&gt;&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">countLeft</span> <span class="operator">=</span> dailyTrainTicket.getRw()-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (countLeft &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_TICKET_COUNT_ERROR);</span><br><span class="line">                &#125;</span><br><span class="line">                dailyTrainTicket.setRw(countLeft);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> YW -&gt;&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">countLeft</span> <span class="operator">=</span> dailyTrainTicket.getYw()-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (countLeft &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_TICKET_COUNT_ERROR);</span><br><span class="line">                &#125;</span><br><span class="line">                dailyTrainTicket.setYw(countLeft);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>扣减余票数功能使用的是switch case，去获取一个对象的不固定的属性，就会用到反射，反射性能不如直接写分支判断</p>
</blockquote>
<h2 id="计算多个选座之间的偏移值"><a href="#计算多个选座之间的偏移值" class="headerlink" title="计算多个选座之间的偏移值"></a>计算多个选座之间的偏移值</h2><blockquote>
<p>计算出offsetList，偏移值，如果只有一个座位，就是{0}，如果选择多个座位，例如三个：{0, 1, 2}<br> 所以，通过第一个座位的列号column和offsetList，就可以知道本次的选座</p>
</blockquote>
<ul>
<li>在ConfirmOrderService的doConfirm中增加逻辑</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算相对于第一个座位的偏移值</span></span><br><span class="line"><span class="comment">//比如选择的是C1,D2，则偏移值为[0,5]</span></span><br><span class="line"><span class="comment">//比如选择的是A1,B1,C1，则偏移值为[0,1,2]</span></span><br><span class="line"><span class="type">ConfirmOrderTicketReq</span> <span class="variable">ticketReq0</span> <span class="operator">=</span> tickets.get(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (StrUtil.isNotBlank(ticketReq0.getSeat()))&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;本次购票有选座&quot;</span>);</span><br><span class="line">    List&lt;SeatColEnum&gt; colEnumList = SeatColEnum.getColsByType(ticketReq0.getSeatTypeCode());</span><br><span class="line">    LOG.info(<span class="string">&quot;本次选座的座位类型包括的列：&#123;&#125;&quot;</span>,colEnumList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//组成和前端两排选座一样的列表，用于作参照的座位列表</span></span><br><span class="line">    ArrayList&lt;String&gt; referSeatList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SeatColEnum seatColEnum : colEnumList)&#123;</span><br><span class="line">            referSeatList.add(seatColEnum.getCode()+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;用于做参照的两排座位：&#123;&#125;&quot;</span>,referSeatList);</span><br><span class="line"></span><br><span class="line">    List&lt;Integer&gt; offsetList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//绝对偏移值：即参照座位列表中的位置</span></span><br><span class="line">    List&lt;Integer&gt; aboluteOffsetList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (ConfirmOrderTicketReq ticketReq : tickets)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> referSeatList.indexOf(ticketReq.getSeat());</span><br><span class="line">        aboluteOffsetList.add(index);</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;计算得到所有座位的绝对偏移值：&#123;&#125;&quot;</span>,aboluteOffsetList);</span><br><span class="line">    <span class="keyword">for</span> (Integer index : aboluteOffsetList)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> index - aboluteOffsetList.get(<span class="number">0</span>);</span><br><span class="line">        offsetList.add(offset);</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;计算得到所有的座位的相对第一个座位的偏移值：&#123;&#125;&quot;</span>,offsetList);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;本次购票没有选座&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="循环获取每个车厢的每个座位"><a href="#循环获取每个车厢的每个座位" class="headerlink" title="循环获取每个车厢的每个座位"></a>循环获取每个车厢的每个座位</h2><ul>
<li>首先在DailyTrainCarriageService中增加selectBySeatType查询车厢方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;DailyTrainCarriage&gt; <span class="title function_">selectBySeatType</span><span class="params">(Date date,String trainCode,String seatType)</span>&#123;</span><br><span class="line">    <span class="type">DailyTrainCarriageExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainCarriageExample</span>();</span><br><span class="line">    example.createCriteria()</span><br><span class="line">            .andDateEqualTo(date)</span><br><span class="line">            .andTrainCodeEqualTo(trainCode)</span><br><span class="line">            .andSeatTypeEqualTo(seatType);</span><br><span class="line">    <span class="keyword">return</span> dailyTrainCarriageMapper.selectByExample(example);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>其次在DailyTrainSeatService中增加selectByCarriage查询座位方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;DailyTrainSeat&gt; <span class="title function_">selectByCarriage</span><span class="params">(Date date,String trainCode,Integer carriageIndex)</span>&#123;</span><br><span class="line">    <span class="type">DailyTrainSeatExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainSeatExample</span>();</span><br><span class="line">  example.setOrderByClause(<span class="string">&quot;carriage_seat_index asc&quot;</span>);</span><br><span class="line">    example.createCriteria()</span><br><span class="line">            .andDateEqualTo(date)</span><br><span class="line">            .andTrainCodeEqualTo(trainCode)</span><br><span class="line">            .andCarriageIndexEqualTo(carriageIndex);</span><br><span class="line">    <span class="keyword">return</span> dailyTrainSeatMapper.selectByExample(example);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在ConfirmOrderService中注入</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DailyTrainCarriageService dailyTrainCarriageService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DailyTrainSeatService dailyTrainSeatService;</span><br></pre></td></tr></table></figure>

<ul>
<li>并在ConfirmOrderService中生成一个车厢一个车厢的获取座位数据的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getSeat</span><span class="params">(Date date,String trainCode,String seatType,String column,List&lt;Integer&gt; offsetList)</span>&#123;</span><br><span class="line">    List&lt;DailyTrainCarriage&gt; carriageList = dailyTrainCarriageService.selectBySeatType(date, trainCode, seatType);</span><br><span class="line">    LOG.info(<span class="string">&quot;共查出&#123;&#125;个符合条件的车厢&quot;</span>,carriageList.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//一个车厢一个车厢的获取座位数据</span></span><br><span class="line">    <span class="keyword">for</span> (DailyTrainCarriage dailyTrainCarriage : carriageList)&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;开始从车厢&#123;&#125;选座&quot;</span>,dailyTrainCarriage.getIndex());</span><br><span class="line">        List&lt;DailyTrainSeat&gt; seatList = dailyTrainSeatService.selectByCarriage(date, trainCode, dailyTrainCarriage.getIndex());</span><br><span class="line">        LOG.info(<span class="string">&quot;车厢&#123;&#125;的座位数：&#123;&#125;&quot;</span>,dailyTrainCarriage.getIndex(), seatList.size());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再选座位和不选座位处调用getSeat方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (StrUtil.isNotBlank(ticketReq0.getSeat()))&#123;</span><br><span class="line">    getSeat(date,</span><br><span class="line">            trainCode,</span><br><span class="line">            ticketReq0.getSeatTypeCode(),</span><br><span class="line">            ticketReq0.getSeat().split(<span class="string">&quot;&quot;</span>)[<span class="number">0</span>],</span><br><span class="line">            offsetList</span><br><span class="line">    );</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;本次购票没有选座&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (ConfirmOrderTicketReq ticketReq : tickets)&#123;</span><br><span class="line">        getSeat(date,</span><br><span class="line">                trainCode,</span><br><span class="line">                ticketReq.getSeatTypeCode(),</span><br><span class="line">                <span class="literal">null</span>,</span><br><span class="line">                <span class="literal">null</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="根据座位销售详情判断本次是否可选"><a href="#根据座位销售详情判断本次是否可选" class="headerlink" title="根据座位销售详情判断本次是否可选"></a>根据座位销售详情判断本次是否可选</h2><ul>
<li>在ConfirmOrderService的getSeat方法中的一个车厢一个车厢的获取座位数据循环里面再增加一个循环，其参数也要对应增加</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getSeat</span><span class="params">(Date date,String trainCode,String seatType,String column,List&lt;Integer&gt; offsetList,Integer startIndex,Integer endIndex)</span>&#123;</span><br><span class="line"><span class="keyword">for</span> (DailyTrainSeat dailyTrainSeat : seatList)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断column，有值的话要比对列号</span></span><br><span class="line">    </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isChoose</span> <span class="operator">=</span> calSell(dailyTrainSeat, startIndex, endIndex);</span><br><span class="line">        <span class="keyword">if</span> (isChoose)&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;选中座位&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据offset选剩下的座位</span></span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>其中计算某座位再区间是否可卖方法如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算某座位再区间是否可卖</span></span><br><span class="line"><span class="comment"> * 例：sell=10001，本次购买区间站1~4，则区间已售000</span></span><br><span class="line"><span class="comment"> * 全部是0，表示这个区间可买；只要有1，就表示区间内已售过票</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 选中后，要计算购票后的sel2，比如原来是10001，本次购买区间站1~4</span></span><br><span class="line"><span class="comment"> * 方案：构造本次购票造成的售卖信息01110，和原sell 10001按位或，最终得到11111</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dailyTrainSeat</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">calSell</span><span class="params">(DailyTrainSeat dailyTrainSeat,Integer startIndex,Integer endIndex)</span>&#123;</span><br><span class="line">    <span class="comment">//00001, 00000</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sell</span> <span class="operator">=</span> dailyTrainSeat.getSell();</span><br><span class="line">    <span class="comment">//000, 000</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sellPart</span> <span class="operator">=</span> sell.substring(startIndex,endIndex);</span><br><span class="line">    <span class="keyword">if</span> (Integer.parseInt(sellPart)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;座位&#123;&#125;在本次车站区间&#123;&#125;~&#123;&#125;已售过票，不可选中该座位&quot;</span>,dailyTrainSeat.getCarriageSeatIndex(),startIndex,endIndex);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;座位&#123;&#125;在本次车站区间&#123;&#125;~&#123;&#125;未售过票，可选中该座位&quot;</span>,dailyTrainSeat.getCarriageSeatIndex(),startIndex,endIndex);</span><br><span class="line">        <span class="comment">//111, 111</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">curSell</span> <span class="operator">=</span> sellPart.replace(<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">        <span class="comment">//0111, 0111</span></span><br><span class="line">        curSell = StrUtil.fillBefore(curSell,<span class="string">&#x27;0&#x27;</span>,endIndex);</span><br><span class="line">        <span class="comment">//01110, 01110</span></span><br><span class="line">        curSell = StrUtil.fillAfter(curSell,<span class="string">&#x27;0&#x27;</span>,sell.length());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//当前区间售票信息curSell 01110与库里的已售信息sell 00001按位或，即可得到该座位卖出此票后的售票详情</span></span><br><span class="line">        <span class="comment">//15（01111），14（01110 = 01110|00000）</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">newSellInt</span> <span class="operator">=</span> NumberUtil.binaryToInt(curSell) | NumberUtil.binaryToInt(sell);</span><br><span class="line">        <span class="comment">//1111, 1110</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">newSell</span> <span class="operator">=</span> NumberUtil.getBinaryStr(newSellInt);</span><br><span class="line">        <span class="comment">//01111, 01110</span></span><br><span class="line">        newSell = StrUtil.fillBefore(newSell,<span class="string">&#x27;0&#x27;</span>,sell.length());</span><br><span class="line">        LOG.info(<span class="string">&quot;座位&#123;&#125;被选中，原售票信息：&#123;&#125;，车站区间：&#123;&#125;~&#123;&#125;，即：&#123;&#125;，最终售票信息：&#123;&#125;&quot;</span>,</span><br><span class="line">                dailyTrainSeat.getCarriageSeatIndex(),sell,startIndex,</span><br><span class="line">                endIndex,curSell,newSell);</span><br><span class="line">        dailyTrainSeat.setSell(newSell);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>其doConfirm调用getSeat方法的参数设置为</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">getSeat(date,</span><br><span class="line">        trainCode,</span><br><span class="line">        ticketReq0.getSeatTypeCode(),</span><br><span class="line">        ticketReq0.getSeat().split(<span class="string">&quot;&quot;</span>)[<span class="number">0</span>],</span><br><span class="line">        offsetList,</span><br><span class="line">        dailyTrainTicket.getStartIndex(),</span><br><span class="line">        dailyTrainTicket.getEndIndex()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="完成有选座的挑座位逻辑"><a href="#完成有选座的挑座位逻辑" class="headerlink" title="完成有选座的挑座位逻辑"></a>完成有选座的挑座位逻辑</h2><ul>
<li>在ConfirmOrderService的getSeat方法中的一个车厢一个车厢的获取座位数据循环里面完善上面的两个注释</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; seatList.size(); i++) &#123;</span><br><span class="line">    <span class="type">DailyTrainSeat</span> <span class="variable">dailyTrainSeat</span> <span class="operator">=</span> seatList.get(i);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">seatIndex</span> <span class="operator">=</span> dailyTrainSeat.getCarriageSeatIndex();</span><br><span class="line">    <span class="type">String</span> <span class="variable">col</span> <span class="operator">=</span> dailyTrainSeat.getCol();</span><br><span class="line">    <span class="comment">//判断column，有值的话要比对列号</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(column))&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;无选座&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!column.equals(col))&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;座位&#123;&#125;列值不对，继续判断下一个座位，当前列值：&#123;&#125;，目标列值：&#123;&#125;&quot;</span>,seatIndex,col,column);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    <span class="type">boolean</span> <span class="variable">isGetAllOffsetSeat</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//根据offset选剩下的座位</span></span><br><span class="line">    <span class="keyword">if</span>(CollUtil.isNotEmpty(offsetList))&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;有偏移值：&#123;&#125;，检验偏移的座位是否可选&quot;</span>,offsetList);</span><br><span class="line">        <span class="comment">//从索引1开始，索引0就是当前已选中的票</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; offsetList.size(); j++) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">offset</span> <span class="operator">=</span> offsetList.get(j);</span><br><span class="line">            <span class="comment">// 座位在库的索引是从1开始</span></span><br><span class="line">            <span class="comment">// int nextIndex = seatIndex + offset - 1;</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextIndex</span> <span class="operator">=</span> i + offset;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//有选座时，一定是在同一个车厢</span></span><br><span class="line">            <span class="keyword">if</span> (nextIndex &gt;= seatList.size())&#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;座位&#123;&#125;不可选，偏移后的索引超出了这个车厢的座位数&quot;</span>,nextIndex);</span><br><span class="line">                isGetAllOffsetSeat = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">DailyTrainSeat</span> <span class="variable">nextDailyTrainSeat</span> <span class="operator">=</span> seatList.get(nextIndex);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isChooseNext</span> <span class="operator">=</span> calSell(nextDailyTrainSeat,startIndex,endIndex);</span><br><span class="line">            <span class="keyword">if</span> (isChooseNext)&#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;座位&#123;&#125;被选中&quot;</span>,nextDailyTrainSeat.getCarriageSeatIndex());</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;座位&#123;&#125;不可选&quot;</span>,nextDailyTrainSeat.getCarriageSeatIndex());</span><br><span class="line">                isGetAllOffsetSeat = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isGetAllOffsetSeat)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存选好的座位</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="保存最终的选座结果"><a href="#保存最终的选座结果" class="headerlink" title="保存最终的选座结果"></a>保存最终的选座结果</h2><ul>
<li>我们首先在ConfirmOrderService的doConfirm方法中定义一个最终选座结果的数组</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//最终的选座结果</span></span><br><span class="line">List&lt;DailyTrainSeat&gt; finalSeatList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们对getSeat方法，增加保存最终的选座结果的操作，全代码如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 挑座位，如果有选座，则一次性挑完，如果无选座，则一个一个挑</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> date</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> trainCode</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> seatType</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> column</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> offsetList</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getSeat</span><span class="params">(List&lt;DailyTrainSeat&gt; finalSeatList, Date date, String trainCode, String seatType, String column, List&lt;Integer&gt; offsetList, Integer startIndex, Integer endIndex)</span> &#123;</span><br><span class="line">    List&lt;DailyTrainSeat&gt; getSeatList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;DailyTrainCarriage&gt; carriageList = dailyTrainCarriageService.selectBySeatType(date, trainCode, seatType);</span><br><span class="line">    LOG.info(<span class="string">&quot;共查出&#123;&#125;个符合条件的车厢&quot;</span>, carriageList.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个车箱一个车箱的获取座位数据</span></span><br><span class="line">    <span class="keyword">for</span> (DailyTrainCarriage dailyTrainCarriage : carriageList) &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;开始从车厢&#123;&#125;选座&quot;</span>, dailyTrainCarriage.getIndex());</span><br><span class="line">        getSeatList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;DailyTrainSeat&gt; seatList = dailyTrainSeatService.selectByCarriage(date, trainCode, dailyTrainCarriage.getIndex());</span><br><span class="line">        LOG.info(<span class="string">&quot;车厢&#123;&#125;的座位数：&#123;&#125;&quot;</span>, dailyTrainCarriage.getIndex(), seatList.size());</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; seatList.size(); i++) &#123;</span><br><span class="line">            <span class="type">DailyTrainSeat</span> <span class="variable">dailyTrainSeat</span> <span class="operator">=</span> seatList.get(i);</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">seatIndex</span> <span class="operator">=</span> dailyTrainSeat.getCarriageSeatIndex();</span><br><span class="line">            <span class="type">String</span> <span class="variable">col</span> <span class="operator">=</span> dailyTrainSeat.getCol();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断当前座位不能被选中过</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">alreadyChooseFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (DailyTrainSeat finalSeat : finalSeatList)&#123;</span><br><span class="line">                <span class="keyword">if</span> (finalSeat.getId().equals(dailyTrainSeat.getId())) &#123;</span><br><span class="line">                    alreadyChooseFlag = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (alreadyChooseFlag) &#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;座位&#123;&#125;被选中过，不能重复选中，继续判断下一个座位&quot;</span>, seatIndex);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断column，有值的话要比对列号</span></span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isBlank(column)) &#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;无选座&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!column.equals(col)) &#123;</span><br><span class="line">                    LOG.info(<span class="string">&quot;座位&#123;&#125;列值不对，继续判断下一个座位，当前列值：&#123;&#125;，目标列值：&#123;&#125;&quot;</span>, seatIndex, col, column);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isChoose</span> <span class="operator">=</span> calSell(dailyTrainSeat, startIndex, endIndex);</span><br><span class="line">            <span class="keyword">if</span> (isChoose) &#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;选中座位&quot;</span>);</span><br><span class="line">                getSeatList.add(dailyTrainSeat);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据offset选剩下的座位</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isGetAllOffsetSeat</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (CollUtil.isNotEmpty(offsetList)) &#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;有偏移值：&#123;&#125;，校验偏移的座位是否可选&quot;</span>, offsetList);</span><br><span class="line">                <span class="comment">// 从索引1开始，索引0就是当前已选中的票</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; offsetList.size(); j++) &#123;</span><br><span class="line">                    <span class="type">Integer</span> <span class="variable">offset</span> <span class="operator">=</span> offsetList.get(j);</span><br><span class="line">                    <span class="comment">// 座位在库的索引是从1开始</span></span><br><span class="line">                    <span class="comment">// int nextIndex = seatIndex + offset - 1;</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">nextIndex</span> <span class="operator">=</span> i + offset;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 有选座时，一定是在同一个车箱</span></span><br><span class="line">                    <span class="keyword">if</span> (nextIndex &gt;= seatList.size()) &#123;</span><br><span class="line">                        LOG.info(<span class="string">&quot;座位&#123;&#125;不可选，偏移后的索引超出了这个车箱的座位数&quot;</span>, nextIndex);</span><br><span class="line">                        isGetAllOffsetSeat = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">DailyTrainSeat</span> <span class="variable">nextDailyTrainSeat</span> <span class="operator">=</span> seatList.get(nextIndex);</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isChooseNext</span> <span class="operator">=</span> calSell(nextDailyTrainSeat, startIndex, endIndex);</span><br><span class="line">                    <span class="keyword">if</span> (isChooseNext) &#123;</span><br><span class="line">                        LOG.info(<span class="string">&quot;座位&#123;&#125;被选中&quot;</span>, nextDailyTrainSeat.getCarriageSeatIndex());</span><br><span class="line">                        getSeatList.add(nextDailyTrainSeat);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        LOG.info(<span class="string">&quot;座位&#123;&#125;不可选&quot;</span>, nextDailyTrainSeat.getCarriageSeatIndex());</span><br><span class="line">                        isGetAllOffsetSeat = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!isGetAllOffsetSeat) &#123;</span><br><span class="line">                getSeatList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 保存选好的座位</span></span><br><span class="line">            finalSeatList.addAll(getSeatList);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>记得在doConfirm方法调用getSeat方法增加参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">getSeat(finalSeatList,</span><br><span class="line">        date,</span><br><span class="line">        trainCode,</span><br><span class="line">        ticketReq0.getSeatTypeCode(),</span><br><span class="line">        ticketReq0.getSeat().split(<span class="string">&quot;&quot;</span>)[<span class="number">0</span>],</span><br><span class="line">        offsetList,</span><br><span class="line">        dailyTrainTicket.getStartIndex(),</span><br><span class="line">        dailyTrainTicket.getEndIndex()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="选座成功后更新各座位的销售详情"><a href="#选座成功后更新各座位的销售详情" class="headerlink" title="选座成功后更新各座位的销售详情"></a>选座成功后更新各座位的销售详情</h2><blockquote>
<p>尽量做短事务，不要做常事务，否则会大量占用数据库资源</p>
<p>本类方法间的调用，事务不生效</p>
<p>在遇到数组、列表、日期计算的时候，要注意边界值</p>
<p>对于复杂的SQL，可以写自定义mapper，具体参照本节的DailyTrainTicketMapperCust</p>
</blockquote>
<ul>
<li>首先我们创建AfterConfirmOrderService做数据库事务操作，座位表修改售卖情况sell</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.domain.DailyTrainSeat;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.mapper.DailyTrainSeatMapper;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AfterConfirmOrderService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(AfterConfirmOrderService.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DailyTrainSeatMapper dailyTrainSeatMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *选中作为后事务处理</span></span><br><span class="line"><span class="comment">     *座位表修改售卖情况sell</span></span><br><span class="line"><span class="comment">     *余票详细表修改余票</span></span><br><span class="line"><span class="comment">     *为会员增加购票记录</span></span><br><span class="line"><span class="comment">     *更新确认订单为成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterDoConfirm</span><span class="params">(List&lt;DailyTrainSeat&gt; finalSeatList)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (DailyTrainSeat dailyTrainSeat : finalSeatList)&#123;</span><br><span class="line">            <span class="type">DailyTrainSeat</span> <span class="variable">seatForUpdate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainSeat</span>();</span><br><span class="line">            seatForUpdate.setId(dailyTrainSeat.getId());</span><br><span class="line">            seatForUpdate.setSell(dailyTrainSeat.getSell());</span><br><span class="line">            seatForUpdate.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            dailyTrainSeatMapper.updateByPrimaryKeySelective(seatForUpdate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再ConfirmOrderService的doConfirm中使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> AfterConfirmOrderService afterConfirmOrderService;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//选中作为后事务处理</span></span><br><span class="line">            <span class="comment">//座位表修改售卖情况sell</span></span><br><span class="line">            <span class="comment">//余票详细表修改余票</span></span><br><span class="line">            <span class="comment">//为会员增加购票记录</span></span><br><span class="line">            <span class="comment">//更新确认订单为成功</span></span><br><span class="line">        afterConfirmOrderService.afterDoConfirm(finalSeatList);</span><br></pre></td></tr></table></figure>

<h2 id="选座成功后批量扣减影响到的多个库存"><a href="#选座成功后批量扣减影响到的多个库存" class="headerlink" title="选座成功后批量扣减影响到的多个库存"></a>选座成功后批量扣减影响到的多个库存</h2><ul>
<li>接下来再AfterConfirmOrderService完成余票详细表修改余票操作，记得添加新的参数DailyTrainTicket dailyTrainTicket</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterDoConfirm</span><span class="params">(DailyTrainTicket dailyTrainTicket,List&lt;DailyTrainSeat&gt; finalSeatList)</span>&#123;</span><br><span class="line">            <span class="comment">// 计算这个站卖出去后，影响了哪些站的余票库存</span></span><br><span class="line">            <span class="comment">// 参照2-3节 如何保证不超卖、不少卖，还要能承受极高的并发 10:30左右</span></span><br><span class="line">            <span class="comment">// 影响的库存：本次选座之前没卖过票的，和本次购买的区间有交集的区间</span></span><br><span class="line">            <span class="comment">// 假设10个站，本次买4~7站</span></span><br><span class="line">            <span class="comment">// 原售：001000001</span></span><br><span class="line">            <span class="comment">// 购买：000011100</span></span><br><span class="line">            <span class="comment">// 新售：001011101</span></span><br><span class="line">            <span class="comment">// 影响：XXX11111X</span></span><br><span class="line">            <span class="comment">// Integer startIndex = 4;</span></span><br><span class="line">            <span class="comment">// Integer endIndex = 7;</span></span><br><span class="line">            <span class="comment">// Integer minStartIndex = startIndex - 往前碰到的最后一个0;</span></span><br><span class="line">            <span class="comment">// Integer maxStartIndex = endIndex - 1;</span></span><br><span class="line">            <span class="comment">// Integer minEndIndex = startIndex + 1;</span></span><br><span class="line">            <span class="comment">// Integer maxEndIndex = endIndex + 往后碰到的最后一个0;</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">startIndex</span> <span class="operator">=</span> dailyTrainTicket.getStartIndex();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">endIndex</span> <span class="operator">=</span> dailyTrainTicket.getEndIndex();</span><br><span class="line">            <span class="type">char</span>[] chars = seatForUpdate.getSell().toCharArray();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">maxStartIndex</span> <span class="operator">=</span> endIndex - <span class="number">1</span>;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">minEndIndex</span> <span class="operator">=</span> startIndex + <span class="number">1</span>;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">minStartIndex</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> startIndex - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="type">char</span> <span class="variable">aChar</span> <span class="operator">=</span> chars[i];</span><br><span class="line">                <span class="keyword">if</span> (aChar == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">                    minStartIndex = i + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            LOG.info(<span class="string">&quot;影响出发站区间：&quot;</span> + minStartIndex + <span class="string">&quot;-&quot;</span> + maxStartIndex);</span><br><span class="line"></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">maxEndIndex</span> <span class="operator">=</span> seatForUpdate.getSell().length();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> endIndex; i &lt; seatForUpdate.getSell().length(); i++) &#123;</span><br><span class="line">                <span class="type">char</span> <span class="variable">aChar</span> <span class="operator">=</span> chars[i];</span><br><span class="line">                <span class="keyword">if</span> (aChar == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">                    maxEndIndex = i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            LOG.info(<span class="string">&quot;影响到达站区间：&quot;</span> + minEndIndex + <span class="string">&quot;-&quot;</span> + maxEndIndex);</span><br><span class="line"></span><br><span class="line">            dailyTrainTicketMapperCust.updateCountBySell(</span><br><span class="line">                    dailyTrainSeat.getDate(),</span><br><span class="line">                    dailyTrainSeat.getTrainCode(),</span><br><span class="line">                    dailyTrainSeat.getSeatType(),</span><br><span class="line">                    minStartIndex,</span><br><span class="line">                    maxStartIndex,</span><br><span class="line">                    minEndIndex,</span><br><span class="line">                    maxEndIndex);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建对应的数据库操作方法DailyTrainTicketMapperCust</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.mapper.cust;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DailyTrainTicketMapperCust</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateCountBySell</span><span class="params">(Date date</span></span><br><span class="line"><span class="params">            , String trainCode</span></span><br><span class="line"><span class="params">            , String seatTypeCode</span></span><br><span class="line"><span class="params">            , Integer minStartIndex</span></span><br><span class="line"><span class="params">            , Integer maxStartIndex</span></span><br><span class="line"><span class="params">            , Integer minEndIndex</span></span><br><span class="line"><span class="params">            , Integer maxEndIndex)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对应的xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.fzx.train.business.mapper.cust.DailyTrainTicketMapperCust&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateCountBySell&quot;</span>&gt;</span></span><br><span class="line">    update daily_train_ticket set</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;seatTypeCode == &#x27;1&#x27;.toString()&quot;</span>&gt;</span></span><br><span class="line">      ydz = ydz - 1</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;seatTypeCode == &#x27;2&#x27;.toString()&quot;</span>&gt;</span></span><br><span class="line">      edz = edz - 1</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;seatTypeCode == &#x27;3&#x27;.toString()&quot;</span>&gt;</span></span><br><span class="line">      rw = rw - 1</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;seatTypeCode == &#x27;4&#x27;.toString()&quot;</span>&gt;</span></span><br><span class="line">      yw = yw - 1</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    where `date` = #&#123;date&#125;</span><br><span class="line">    and train_code = #&#123;trainCode&#125;</span><br><span class="line">    and start_index <span class="symbol">&amp;gt;</span>= #&#123;minStartIndex&#125;</span><br><span class="line">    and start_index <span class="symbol">&amp;lt;</span>= #&#123;maxStartIndex&#125;</span><br><span class="line">    and end_index <span class="symbol">&amp;gt;</span>= #&#123;minEndIndex&#125;</span><br><span class="line">    and end_index <span class="symbol">&amp;lt;</span>= #&#123;maxEndIndex&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>最终再在ConfirmOrderService的doConfirm方法中使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afterConfirmOrderService.afterDoConfirm(dailyTrainTicket,finalSeatList);</span><br></pre></td></tr></table></figure>

<h2 id="选座成功后会会员增加车票记录"><a href="#选座成功后会会员增加车票记录" class="headerlink" title="选座成功后会会员增加车票记录"></a>选座成功后会会员增加车票记录</h2><ul>
<li>首先创建数据库，进行一系列常规操作</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `ticket`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `ticket` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `member_id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;会员id&#x27;</span>,</span><br><span class="line">  `passenger_id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;乘客id&#x27;</span>,</span><br><span class="line">  `passenger_name` <span class="type">varchar</span>(<span class="number">20</span>) comment <span class="string">&#x27;乘客姓名&#x27;</span>,</span><br><span class="line">  `train_date` <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">  `train_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `carriage_index` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;箱序&#x27;</span>,</span><br><span class="line">  `seat_row` <span class="type">char</span>(<span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;排号|01, 02&#x27;</span>,</span><br><span class="line">  `seat_col` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;列号|枚举[SeatColEnum]&#x27;</span>,</span><br><span class="line">  `start_station` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;出发站&#x27;</span>,</span><br><span class="line">  `start_time` <span class="type">time</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;出发时间&#x27;</span>,</span><br><span class="line">  `end_station` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;到达站&#x27;</span>,</span><br><span class="line">  `end_time` <span class="type">time</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;到站时间&#x27;</span>,</span><br><span class="line">  `seat_type` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;座位类型|枚举[SeatTypeEnum]&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  index `member_id_index` (`member_id`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;车票&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>增加一个feign接口，保存车票信息</p>
</blockquote>
<ul>
<li>由于business要调用member模块，所以需要使用feign接口，又因为business和member都需要一样的请求参数，所以这里就将请求参数定义的common中</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.common.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotBlank;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotNull;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberTicketReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 乘客id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【会员id】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long memberId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 乘客id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【乘客id】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long passengerId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 乘客id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【乘客名字】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String passengerName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd&quot;,timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【日期】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date trainDate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 车次编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【车次编号】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String trainCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 箱序</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【箱序】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer carriageIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排号|01, 02</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【排号】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String seatRow;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列号|枚举[SeatColumnEnum]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【列号】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String seatCol;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出发站</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【出发站】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String startStation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出发时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【出发时间】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date startTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 到达站</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【到达站】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String endStation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 到站时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;HH:mm:ss&quot;,timezone = &quot;GMT+8&quot;)</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【到站时间】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 座位类型|枚举[SeatTypeEnum]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【座位类型】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String seatType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getMemberId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMemberId</span><span class="params">(Long memberId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.memberId = memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getPassengerId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> passengerId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassengerId</span><span class="params">(Long passengerId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.passengerId = passengerId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassengerName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> passengerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassengerName</span><span class="params">(String passengerName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.passengerName = passengerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getTrainDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trainDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrainDate</span><span class="params">(Date trainDate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trainDate = trainDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrainCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrainCode</span><span class="params">(String trainCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trainCode = trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getCarriageIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> carriageIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCarriageIndex</span><span class="params">(Integer carriageIndex)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.carriageIndex = carriageIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSeatRow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seatRow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeatRow</span><span class="params">(String seatRow)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seatRow = seatRow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSeatCol</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seatCol;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeatCol</span><span class="params">(String seatCol)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seatCol = seatCol;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStartStation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startStation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStartStation</span><span class="params">(String startStation)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.startStation = startStation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEndStation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> endStation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEndStation</span><span class="params">(String endStation)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.endStation = endStation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getStartTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStartTime</span><span class="params">(Date startTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.startTime = startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getEndTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> endTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEndTime</span><span class="params">(Date endTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.endTime = endTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSeatType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seatType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeatType</span><span class="params">(String seatType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seatType = seatType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;MemberTicketReq&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;memberId=&quot;</span> + memberId +</span><br><span class="line">                <span class="string">&quot;, passengerId=&quot;</span> + passengerId +</span><br><span class="line">                <span class="string">&quot;, passengerName=&quot;</span> + passengerName +</span><br><span class="line">                <span class="string">&quot;, date=&quot;</span> + trainDate +</span><br><span class="line">                <span class="string">&quot;, trainCode=&#x27;&quot;</span> + trainCode + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, carriageIndex=&quot;</span> + carriageIndex +</span><br><span class="line">                <span class="string">&quot;, row=&#x27;&quot;</span> + seatRow + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, col=&#x27;&quot;</span> + seatCol + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, start=&#x27;&quot;</span> + startStation + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, startTime=&quot;</span> + startTime +</span><br><span class="line">                <span class="string">&quot;, end=&#x27;&quot;</span> + endStation + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, endTime=&quot;</span> + endTime +</span><br><span class="line">                <span class="string">&quot;, seatType=&#x27;&quot;</span> + seatType + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们再member中定义feifn的controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.controller.feign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.req.MemberTicketReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.service.TicketService;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/feign/ticket&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignTicketController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TicketService ticketService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;Object&gt; <span class="title function_">save</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> MemberTicketReq req)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ticketService.save(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改下TicketService的save方法，因为是只读就不进行修改了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(MemberTicketReq req)</span>&#123;</span><br><span class="line">    <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">    <span class="type">Ticket</span> <span class="variable">ticket</span> <span class="operator">=</span> BeanUtil.copyProperties(req, Ticket.class);</span><br><span class="line">        ticket.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">        ticket.setCreateTime(now);</span><br><span class="line">        ticket.setUpdateTime(now);</span><br><span class="line">        ticketMapper.insert(ticket);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>购票成功后，通过feign调用member的保存车票接口</p>
</blockquote>
<ul>
<li>首先business要使用feign调用member模块，就先引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--远程调用openfeign--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--openfeign默认使用loadBalance的负载均衡器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们定义使用方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.feign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.req.MemberTicketReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @FeignClient(&quot;member&quot;)</span></span><br><span class="line"><span class="meta">@FeignClient(name = &quot;member&quot;, url = &quot;http://127.0.0.1:8001&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MemberFeign</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/member/feign/ticket/save&quot;)</span></span><br><span class="line">    CommonResp&lt;Object&gt; <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> MemberTicketReq req)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>记得再BusinessApplication上添加开关</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(&quot;com.fzx.train.business.feign&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后再AfterConfirmOrderService完成保存逻辑</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> MemberFeign memberFeign;</span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterDoConfirm</span><span class="params">(DailyTrainTicket dailyTrainTicket,List&lt;DailyTrainSeat&gt; finalSeatList,List&lt;ConfirmOrderTicketReq&gt; tickets)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span> ; j&lt;finalSeatList.size();j++)&#123;</span><br><span class="line">            <span class="type">DailyTrainSeat</span> <span class="variable">dailyTrainSeat</span> <span class="operator">=</span> finalSeatList.get(j);</span><br><span class="line">            <span class="comment">// 调用会员服务接口，为会员增加一张车票</span></span><br><span class="line">            <span class="type">MemberTicketReq</span> <span class="variable">memberTicketReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemberTicketReq</span>();</span><br><span class="line">            memberTicketReq.setMemberId(LoginMemberContext.getId());</span><br><span class="line">            memberTicketReq.setPassengerId(tickets.get(j).getPassengerId());</span><br><span class="line">            memberTicketReq.setPassengerName(tickets.get(j).getPassengerName());</span><br><span class="line">            memberTicketReq.setTrainDate(dailyTrainTicket.getDate());</span><br><span class="line">            memberTicketReq.setTrainCode(dailyTrainTicket.getTrainCode());</span><br><span class="line">            memberTicketReq.setCarriageIndex(dailyTrainSeat.getCarriageIndex());</span><br><span class="line">            memberTicketReq.setSeatRow(dailyTrainSeat.getRow());</span><br><span class="line">            memberTicketReq.setSeatCol(dailyTrainSeat.getCol());</span><br><span class="line">            memberTicketReq.setStartStation(dailyTrainTicket.getStart());</span><br><span class="line">            memberTicketReq.setStartTime(dailyTrainTicket.getStartTime());</span><br><span class="line">            memberTicketReq.setEndStation(dailyTrainTicket.getEnd());</span><br><span class="line">            memberTicketReq.setEndTime(dailyTrainTicket.getEndTime());</span><br><span class="line">            memberTicketReq.setSeatType(dailyTrainSeat.getSeatType());</span><br><span class="line">            CommonResp&lt;Object&gt; commonResp = memberFeign.save(memberTicketReq);</span><br><span class="line">            LOG.info(<span class="string">&quot;调用member接口，返回：&#123;&#125;&quot;</span>, commonResp);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改会员车票页面的显示</p>
</blockquote>
<ul>
<li>到这一步他页面的列号又是显示两个DD啥的，这时就需要加一个条件&amp;&amp;后面的（修改ticket界面）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;span v-for=&quot;item in SEAT_COL_ARRAY&quot; :key=&quot;item.code&quot;&gt;</span><br><span class="line">  &lt;span v-if=&quot;item.code === record.seatCol &amp;&amp; item.type === record.seatType&quot;&gt;</span><br><span class="line">    &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">  &lt;/span&gt;</span><br><span class="line">&lt;/span&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后去掉这两个不在页面显示的</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;会员id&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;memberId&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;memberId&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;乘客id&#x27;</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">&#x27;passengerId&#x27;</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&#x27;passengerId&#x27;</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<blockquote>
<p>会员端增加【我的车票】页面</p>
</blockquote>
<ul>
<li>会员端增加一个车票页面只需要把admin的ticket复制一份到web上，然后就添加菜单和路由</li>
<li>另外再member中添加TicketController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.context.LoginMemberContext;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.PageResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.req.TicketQueryReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.resp.TicketQueryResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.member.service.TicketService;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ticket&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TicketController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TicketService ticketService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/query-list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;PageResp&lt;TicketQueryResp&gt;&gt; <span class="title function_">query</span><span class="params">(<span class="meta">@Valid</span> TicketQueryReq req)</span> &#123;</span><br><span class="line">        CommonResp&lt;PageResp&lt;TicketQueryResp&gt;&gt; commonResp = <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">        req.setMemberId(LoginMemberContext.getId());</span><br><span class="line">        PageResp&lt;TicketQueryResp&gt; pageResp = ticketService.queryList(req);</span><br><span class="line">        commonResp.setContent(pageResp);</span><br><span class="line">        <span class="keyword">return</span> commonResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后设置请求参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.req.PageReq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TicketQueryReq</span> <span class="keyword">extends</span> <span class="title class_">PageReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long memberId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getMemberId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMemberId</span><span class="params">(Long memberId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.memberId = memberId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;TicketQueryReq&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;memberId=&quot;</span> + memberId +</span><br><span class="line">                <span class="string">&quot;&#125; &quot;</span> + <span class="built_in">super</span>.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>并且再TicketService的queryList查询方法加一个判断</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjUtil.isNotEmpty(req.getMemberId()))&#123;</span><br><span class="line">    criteria.andMemberIdEqualTo(req.getMemberId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="选座成功后更新确认订单状态为成功"><a href="#选座成功后更新确认订单状态为成功" class="headerlink" title="选座成功后更新确认订单状态为成功"></a>选座成功后更新确认订单状态为成功</h2><ul>
<li>这里就修改两个地方AfterConfirmOrderService这里afterDoConfirm在参数增加一个ConfirmOrder confirmOrder，再添加一个逻辑</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新订单状态为成功</span></span><br><span class="line"><span class="type">ConfirmOrder</span> <span class="variable">confirmOrderForUpdate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmOrder</span>();</span><br><span class="line">confirmOrderForUpdate.setId(confirmOrder.getId());</span><br><span class="line">confirmOrderForUpdate.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">confirmOrderForUpdate.setStatus(ConfirmOrderStatusEnum.SUCCESS.getCode());</span><br><span class="line">confirmOrderMapper.updateByPrimaryKeySelective(confirmOrderForUpdate);</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们再ConfirmOrderService中使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afterConfirmOrderService.afterDoConfirm(dailyTrainTicket,finalSeatList,tickets,confirmOrder);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h2><ul>
<li>这一直有一个问题就是购买票后，数据库不减，这是因为dailyTrainTicketMapperCust往这里面传的日期是这种样子，跟数据库的不一致</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307271757804.png"
                      alt="image-20230727175754363"
                ></p>
<ul>
<li>解决办法我将Date类型转为了String类型。修改AfterConfirmOrderService部分，将请求参数的那个Date类型转化了下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SimpleDateFormat</span> <span class="variable">time</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">dailyTrainTicketMapperCust.updateCountBySell(</span><br><span class="line">        time.format(dailyTrainSeat.getDate()),</span><br><span class="line">        dailyTrainSeat.getTrainCode(),</span><br><span class="line">        dailyTrainSeat.getSeatType(),</span><br><span class="line">        minStartIndex,</span><br><span class="line">        maxStartIndex,</span><br><span class="line">        minEndIndex,</span><br><span class="line">        maxEndIndex);</span><br></pre></td></tr></table></figure>

<h1 id="集成注册中心与配置中心组件Nacos（动态修改线上的配置）"><a href="#集成注册中心与配置中心组件Nacos（动态修改线上的配置）" class="headerlink" title="集成注册中心与配置中心组件Nacos（动态修改线上的配置）"></a>集成注册中心与配置中心组件Nacos（动态修改线上的配置）</h1><p>本章介绍Spring Cloud Alibaba的核心组件之一：Nacos，用作注册中心和配置中心。通过注册中心，可以查看所有的应用列表，机器数、健康数等信息；通过配置中心，可以动态的修改应用配置，无需重启应用，实时生效。</p>
<hr>
<h2 id="本章介绍"><a href="#本章介绍" class="headerlink" title="本章介绍"></a>本章介绍</h2><ul>
<li>注册中心：通讯录，让应用之间互相认识<ul>
<li>健康检查</li>
<li>路由转发</li>
<li>远程调用</li>
</ul>
</li>
<li>配置中心：动态修改线上的配置<ul>
<li>开关</li>
<li>域值</li>
<li>枚举项</li>
</ul>
</li>
</ul>
<h2 id="Nacos快速开始"><a href="#Nacos快速开始" class="headerlink" title="Nacos快速开始"></a>Nacos快速开始</h2><ul>
<li>首先下载一个Nacos</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307270921435.png"
                      alt="image-20230727092132014"
                ></p>
<ul>
<li>接下来修改下Nacos的配置文件，主要修改这，用Base64转码</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307270928170.png"
                      alt="image-20230727092811893"
                ></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### worked when nacos.core.auth.system.type=nacos</span></span><br><span class="line"><span class="comment">### The token expiration in seconds:</span></span><br><span class="line"><span class="attr">nacos.core.auth.plugin.nacos.token.cache.enable</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">nacos.core.auth.plugin.nacos.token.expire.seconds</span>=<span class="string">18000</span></span><br><span class="line"><span class="comment">### The default token (Base64 String):12456781257896585451236547895212</span></span><br><span class="line"><span class="attr">nacos.core.auth.plugin.nacos.token.secret.key</span>=<span class="string">MTI0NTY3ODEyNTc4OTY1ODU0NTEyMzY1NDc4OTUyMTI=</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后就是启动Nacos了，在bin目录下输入cmd，或者直接进去点启动文件就行</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startup.<span class="built_in">cmd</span> -m standalone</span><br></pre></td></tr></table></figure>

<h2 id="Nacos配置中心演示"><a href="#Nacos配置中心演示" class="headerlink" title="Nacos配置中心演示"></a>Nacos配置中心演示</h2><blockquote>
<p>读取配置文件的配置</p>
</blockquote>
<ul>
<li>下面的操作在member中进行，首先修改application.properties，增加下面</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">test.nacos</span>=<span class="string">Member</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在TestController中引用配置文件中的key和value</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.nacos&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String testNacos;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Hello %s!&quot;</span>,testNacos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>集成Nacos配置中心，实现动态刷新的功能</p>
</blockquote>
<ul>
<li>要想集成Nacos首先在根pom下增加依赖，版本一定要用对</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2022.0.0.0-RC1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们的spring cloud的配置文件都放在bootstrap.properties中</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注册中心的名字</span></span><br><span class="line"><span class="attr">spring.application.name</span>=<span class="string">member</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#启动环境，nacos会根据环境读不同的配置dataId：member-dev.properties</span></span><br><span class="line"><span class="attr">spring.profiles.active</span>=<span class="string">dev</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#nacos server地址</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.server-addr</span>=<span class="string">10.5.82.41:8848</span></span><br><span class="line"><span class="comment">#配置中心文件后缀，默认properties</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.file-extension</span>=<span class="string">properties</span></span><br></pre></td></tr></table></figure>

<ul>
<li>读取bootstrap.properties还需要引入一个依赖，在common的模块中引用即可</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringBoot 2.4版本之后，需要引入该依赖，才能读取bootstrap文件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>我们在Nacos创建配置时，他的Data ID是由注册中心名字.启动环境.配置中心文件后缀组成</p>
</li>
<li><p>要是想实现动态修改配置的动态刷新功能，就以TestController为例只需要在类上面添加@RefreshScope即可。</p>
</li>
</ul>
<h2 id="Nacos多环境配置演示"><a href="#Nacos多环境配置演示" class="headerlink" title="Nacos多环境配置演示"></a>Nacos多环境配置演示</h2><ul>
<li>以member为例，按照以往的做法就是将application.properties复制一份重命名为application-prod.properties，并修改对应的端口号</li>
<li>然后在服务中复制一份启动类，然后修改配置</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307271107088.png"
                      alt="image-20230727110721532"
                ></p>
<ul>
<li>但是这样做会把数据库密码都暴漏出去，所以使用Nacos可以克隆之前的配置，里面的配置写下面的即可</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">28001</span></span><br><span class="line"><span class="attr">test.nacos</span>=<span class="string">Nacos3143</span></span><br></pre></td></tr></table></figure>

<h2 id="Nacos利用命名空间做项目隔离"><a href="#Nacos利用命名空间做项目隔离" class="headerlink" title="Nacos利用命名空间做项目隔离"></a>Nacos利用命名空间做项目隔离</h2><ul>
<li>首先我们在Nacos中新建一个命名空间，一般一个项目一个</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307271122257.png"
                      alt="image-20230727112256890"
                ></p>
<ul>
<li>然后我们让我们的项目在bootstrap.properties关联上命名空间</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nacos命名空间</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.namespace</span>=<span class="string">train</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们就可以把我们的配置导入到专门的命名空间里</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307271131262.png"
                      alt="image-20230727113105891"
                ></p>
<h2 id="Nacos注册中心演示"><a href="#Nacos注册中心演示" class="headerlink" title="Nacos注册中心演示"></a>Nacos注册中心演示</h2><ul>
<li>首先把member的配置中心和注册中心的依赖都放到common中</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置中心--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--注册中心--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后将注册中心的地址和命名空间写入到member的bootstrap.properties中</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nacos server注册中心地址</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.discovery.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.discovery.namespace</span>=<span class="string">train</span></span><br></pre></td></tr></table></figure>

<h2 id="配置Gateway-Nacos支持应用名路由转发"><a href="#配置Gateway-Nacos支持应用名路由转发" class="headerlink" title="配置Gateway+Nacos支持应用名路由转发"></a>配置Gateway+Nacos支持应用名路由转发</h2><blockquote>
<p>配置Gateway+Nacos，实现按应用名来做路由转发</p>
</blockquote>
<ul>
<li>我们首先在gateway中添加依赖，不需要添加配置依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--注册中心--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--SpringBoot 2.4版本之后，需要引入该依赖，才能读取bootstrap文件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--客户端负载均衡loadbalancer--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>同样的gateway也添加nacos的配置bootstrap.properties</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注册中心的名字</span></span><br><span class="line"><span class="attr">spring.application.name</span>=<span class="string">gateway</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#nacos server注册中心地址</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.discovery.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.discovery.namespace</span>=<span class="string">train</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们把配置类的路由转发的uri全部修改为负载均衡形式</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#spring.cloud.gateway.routes[0].uri=http://127.0.0.1:8001</span></span><br><span class="line"><span class="attr">spring.cloud.gateway.routes[0].uri</span>=<span class="string">lb://member</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们把TestController改成这样的形式，就能很清楚的感受到负载均衡的运行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.member.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.nacos&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String testNacos;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">port</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;local.server.port&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Hello %s! 端口:%s&quot;</span>,testNacos,port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为business和batch都配置nacos</p>
</blockquote>
<ul>
<li>就是添加nacos的配置，就是修改注册中心名字就行</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注册中心的名字</span></span><br><span class="line"><span class="attr">spring.application.name</span>=<span class="string">batch</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#启动环境，nacos会根据环境读不同的配置dataId：batch-dev.properties</span></span><br><span class="line"><span class="attr">spring.profiles.active</span>=<span class="string">dev</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#nacos server地址</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br><span class="line"><span class="comment">#配置中心文件后缀，默认properties</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.file-extension</span>=<span class="string">properties</span></span><br><span class="line"><span class="comment"># nacos命名空间</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.namespace</span>=<span class="string">train</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#nacos server注册中心地址</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.discovery.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.discovery.namespace</span>=<span class="string">train</span></span><br></pre></td></tr></table></figure>

<h2 id="配置Feign-Nacos支持应用名远程调用"><a href="#配置Feign-Nacos支持应用名远程调用" class="headerlink" title="配置Feign+Nacos支持应用名远程调用"></a>配置Feign+Nacos支持应用名远程调用</h2><ul>
<li>以batch模块调用business为例，首先修改其BusinessFeign，将上面的注解改成在nacos注册的名字即可，但是这个名字仅仅代表的是ip，不是全部的这个<a class="link"   target="_blank" rel="noopener" href="http://127.0.0.1:8002/business%EF%BC%8C%E5%9B%A0%E6%AD%A4%E9%9C%80%E8%A6%81%E5%9C%A8GetMapping%E4%B8%AD%E6%A0%BC%E5%A4%96%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA/business%E5%89%8D%E7%BC%80" >http://127.0.0.1:8002/business，因此需要在GetMapping中格外添加一个/business前缀<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;business&quot;)</span></span><br><span class="line"><span class="comment">//@FeignClient(name=&quot;business&quot;,url=&quot;http://127.0.0.1:8002/business&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BusinessFeign</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/business/business/test&quot;)</span></span><br><span class="line">    String <span class="title function_">hello</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nacos挂了怎么办"><a href="#Nacos挂了怎么办" class="headerlink" title="Nacos挂了怎么办"></a>Nacos挂了怎么办</h2><ul>
<li>当一个应用注册进来，nacos就会把他注入到通讯录里面，并且将每一个注册进来的应用推给其他应用，就相当于每个应用都有一个列表，这样的好处就是不用依赖nacos。挂了也没事</li>
</ul>
<h1 id="高性能余票查询的实现（前端缓存-amp-本地缓存-amp-分布式缓存）"><a href="#高性能余票查询的实现（前端缓存-amp-本地缓存-amp-分布式缓存）" class="headerlink" title="高性能余票查询的实现（前端缓存&amp;本地缓存&amp;分布式缓存）"></a>高性能余票查询的实现（前端缓存&amp;本地缓存&amp;分布式缓存）</h1><p>本章主要介绍在高并发场景中，如何实现高性能的余票查询，学习缓存技术，并对缓存常见问题进行讲解，如击穿、穿透、雪崩等，解决如何增加更新余票的定时任务及余票缓存初始化等问题。同时讲解前端缓存、本地缓存、持久层一级&#x2F;二级缓存、分布式缓存等。…</p>
<hr>
<h2 id="本章介绍-1"><a href="#本章介绍-1" class="headerlink" title="本章介绍"></a>本章介绍</h2><ul>
<li>常见的缓存<ul>
<li>Mybatis一级缓存</li>
<li>Mybatis二级缓存</li>
<li>本地缓存</li>
<li>分布式缓存（Redis）</li>
<li>前端h5 sessionStorage</li>
<li>前端h5 localStorag</li>
</ul>
</li>
</ul>
<h2 id="详解Mybatis的一级缓存"><a href="#详解Mybatis的一级缓存" class="headerlink" title="详解Mybatis的一级缓存"></a>详解Mybatis的一级缓存</h2><ul>
<li>一级缓存可以帮助我们有效地减少重复的数据库查询。</li>
<li>当我们操作多个表的时候很自然而然的就想到了事务，当我们把<strong>一个方法上加入事务注解</strong>，同时在该方法中调用多个<strong>参数一样</strong>的查询，这时第二个及以后的查询就不用查询数据库，只需要读取第一次查询的结果即可，因为第一次查询后都会缓存起来。</li>
<li>但是有些情况是危险的，<strong>当第一次你查了数据库，然后你对数据做了写修改，第二次再查的时候还是直接读的第一次数据查询的缓存，就不对了</strong></li>
<li>那么怎么修改一级缓存呢，以business为例，再其配置文件里添加</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis.configuration.local-cache-scope</span>=<span class="string">statement</span></span><br></pre></td></tr></table></figure>

<h2 id="详解Mybatis的二级缓存"><a href="#详解Mybatis的二级缓存" class="headerlink" title="详解Mybatis的二级缓存"></a>详解Mybatis的二级缓存</h2><ul>
<li>二级缓存就很广的，不止局限在事务，只要调用多次同样的接口，二级缓存生效，其他调用都是 调用 第一次调用的结果缓存</li>
<li>查询所有车次接口和查询所有车站接口是典型的读多写少的接口，很适合用来做缓存</li>
<li>如果想要让一个mapper的sql开启二级缓存，只需要再&lt; mapper &gt;的下一个节点增加下面的节点</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span>&gt;</span><span class="tag">&lt;/<span class="name">cache</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>还要注意的是开启二级缓存，需要把对应的实体类做一个序列化</strong></li>
<li><strong>当一个类需要保存起来，下次再还原成类时就需要序列化，或者需要远程传输，比如放到redis里，也需要序列化</strong></li>
</ul>
<blockquote>
<p>序列化一般用于类做传输的场景</p>
</blockquote>
<ul>
<li>那么什么时候二级缓存会失效呢？就是对同个namespace做增删改操作时，二级缓存就会失效</li>
<li>即使增删改的SQL没有改变数据，Mybatis都会将同个命名空间下的二级缓存清空</li>
</ul>
<h2 id="详解SpringBoot内置缓存"><a href="#详解SpringBoot内置缓存" class="headerlink" title="详解SpringBoot内置缓存"></a>详解SpringBoot内置缓存</h2><ul>
<li>spring boot的内置缓存直接在Service方法上添加缓存，连方法里面的一些判断都不需要做了，效率更高</li>
<li>首先再common的pom里添加一个依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring内置缓存--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后再在想要使用这个缓存的模块启动类添加注解支持开启</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后对应的Service的方法上添加一个开启注解。后面的value就是类名加方法名，代表使用哪个方法时开启缓存（<strong>开辟一块空间，根据不同的请求参数，空间内会缓存多个结果（比如G1和G2的东西不同）。会根据请求参数生成一个key，需要对请求参数生成hashCode和equals方法，用于生成key</strong>）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(value=&quot;DailyTrainTicketService.queryList&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>需要对请求参数生成hashCode和equals方法，用于生成key</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">DailyTrainTicketQueryReq</span> <span class="variable">that</span> <span class="operator">=</span> (DailyTrainTicketQueryReq) o;</span><br><span class="line">    <span class="keyword">return</span> Objects.equals(date, that.date) &amp;&amp; Objects.equals(trainCode, that.trainCode) &amp;&amp; Objects.equals(start, that.start) &amp;&amp; Objects.equals(end, that.end);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Objects.hash(date, trainCode, start, end);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>但是经过测试，将参数的page从1变成2，返回的还是第一次的查询结果（<strong>IDEA生成的equals和hashCode只有本类的属性，没有包含父类的，导致page参数发生变化时，生成的key跟之前的一样，所以读的缓存</strong>），就需要手动添加父类了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">DailyTrainTicketQueryReq</span> <span class="variable">that</span> <span class="operator">=</span> (DailyTrainTicketQueryReq) o;</span><br><span class="line">    <span class="keyword">return</span> Objects.equals(date, that.date) &amp;&amp; Objects.equals(trainCode, that.trainCode) &amp;&amp; Objects.equals(start, that.start) &amp;&amp; Objects.equals(end, that.end)&amp;&amp; Objects.equals(((DailyTrainTicketQueryReq) o).getPage(), that.getPage())&amp;&amp; Objects.equals(((DailyTrainTicketQueryReq) o).getSize(), that.getSize());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Objects.hash(date, trainCode, start, end,getPage(),getSize());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>本地缓存可以解决mybatis二级缓存需要修改mapper的问题，但同样存在多个节点缓存不一样的问题</li>
<li>有一个强制刷新缓存的注解,使用该注解就会把原来的缓存清除掉</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CachePut(value=&quot;DailyTrainTicketService.queryList&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="SpringBoot整合redis缓存"><a href="#SpringBoot整合redis缓存" class="headerlink" title="SpringBoot整合redis缓存"></a>SpringBoot整合redis缓存</h2><ul>
<li>为了解决缓存一致的问题，就需要引入共享缓存redis</li>
<li>首先在需要使用的模块引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们给对应模块增加redis配置</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.data.redis.host</span>=<span class="string">localhost</span></span><br><span class="line"><span class="attr">spring.data.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="attr">spring.data.redis.password</span>=<span class="string"></span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用的话就是往类里面添加差不多下面的东西</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">redisTemplate.opsForValue().set();</span><br><span class="line">redisTemplate.opsForValue().get();</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们把缓存存到redis中，添加如下配置</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.cache.type</span>=<span class="string">redis</span></span><br><span class="line"><span class="attr">spring.cache.redis.use-key-prefix</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.cache.redis.key-prefix</span>=<span class="string">train_cache_</span></span><br><span class="line"><span class="attr">spring.cache.redis.cache-null-values</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">spring.cache.redis.time-to-live</span>=<span class="string">60s</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用redis解决了两个问题：<br>1.提高访问速度，mysql单机QPS约为2000，redis约10万<br>2.解决多节点共享缓存，机器重启也不会丢缓存数据</p>
</li>
<li><p>redis常用于放用户的登录信息，早期没有redis时，登录信息都放在session中，应用一重启，登录就没有了，多节点session又是另一个头大的问题</p>
</li>
</ul>
<h2 id="详解缓存击穿与解决方案"><a href="#详解缓存击穿与解决方案" class="headerlink" title="详解缓存击穿与解决方案"></a>详解缓存击穿与解决方案</h2><ul>
<li>缓存击穿：一个热点的KEY失效后，导致大量请求直接访问数据库（就比如说余票查询）</li>
<li>有两个解决办法，解决方法一就是当60s的缓存还没到就提前更新下缓存（增加定时任务：每隔30秒，主动刷新缓存，此时，缓存时间会变回60秒，可以从redis客户端工具查看超时时间）</li>
<li>解决方法二，针对数据库查询，增加分布式锁，100个请求，只有一个拿到锁，去查数据库，其它99个请求都快速失败，告诉用户稍候重试</li>
</ul>
<h2 id="详解缓存穿透与解决方案"><a href="#详解缓存穿透与解决方案" class="headerlink" title="详解缓存穿透与解决方案"></a>详解缓存穿透与解决方案</h2><ul>
<li>一些项目会这样写</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//去缓存里取数据</span></span><br><span class="line"><span class="keyword">if</span>(有数据)&#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    去数据库里取数据</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>假设余票查询本身数据库就是空的，查出来也是空的，最后无论哪个情况都需要往数据库里面进行操作，就相当于缓存穿透</strong></li>
<li>解决方法也是针对数据库查询，增加分布式锁，100个请求，只有一个拿到锁，去查数据库，其它99个请求都快速失败，告诉用户稍候重试</li>
<li>还有一种方法就是判断取得数据是null还是[ ]，如果是null的话就往redis存一个空列表，如果是[ ]就不用查了</li>
<li>如果要使用spring默认的缓存+redis就要配置这个为true</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.cache.redis.cache-<span class="literal">null</span>-values=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="详解缓存雪崩与解决方案"><a href="#详解缓存雪崩与解决方案" class="headerlink" title="详解缓存雪崩与解决方案"></a>详解缓存雪崩与解决方案</h2><ul>
<li><strong>缓存雪崩：由于短时间内，大量的KEY失效，导致数据库压力剧增</strong></li>
<li>这种情况添加一个数据库分布式锁就不好使了，因为他都是针对于一个key，而雪崩有n个key，所以需要使用限流</li>
</ul>
<h2 id="缓存在高并发场景中的生产问题分享"><a href="#缓存在高并发场景中的生产问题分享" class="headerlink" title="缓存在高并发场景中的生产问题分享"></a>缓存在高并发场景中的生产问题分享</h2><ul>
<li>场景：每天的会员数很多，百万级别，但每个会员一天只会有几次请求，一个会员信息在同一次请求中，会被用到多次，且会员信息较大（将查询会员相关的表做成了一个方法，一次请求里面会调用多次这个方法，就会多次查询数据库）</li>
<li>问题：多次调用查询会员方法，组装信息多，多次访问数据库</li>
<li>解决：使用本地缓存，1分钟有效 （还有其它接口也需要会员信息，会员完成一次业务，会调多个接口，前后大概就是1分钟）</li>
<li>问题：fullgc（stop the world）频繁，导致短时间内大量请求失败</li>
<li>解决：去掉本地缓存，使用线程本地变量</li>
</ul>
<h2 id="前端缓存的使用"><a href="#前端缓存的使用" class="headerlink" title="前端缓存的使用"></a>前端缓存的使用</h2><ul>
<li>就以前端查询车次为例</li>
<li>首先在admin模块的session-storage.js添加常量</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SESSION_ALL_TRAIN</span> = <span class="string">&quot;SESSION_ALL_TRAIN&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改train-select.vue的查询车次方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询所有的车次，用于车次下拉框</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">queryAllTrain</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">  <span class="keyword">let</span> list = <span class="title class_">SessionStorage</span>.<span class="title function_">get</span>(<span class="variable constant_">SESSION_ALL_TRAIN</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isNotEmpty</span>(list))&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;queryAllTrain 读取缓存&quot;</span>);</span><br><span class="line">    trains.<span class="property">value</span> = list;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    axios.<span class="title function_">get</span>(<span class="string">&quot;/business/admin/train/query-all&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">      <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">        trains.<span class="property">value</span> = data.<span class="property">content</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;queryAllTrain 保存缓存&quot;</span>);</span><br><span class="line">        <span class="title class_">SessionStorage</span>.<span class="title function_">set</span>(<span class="variable constant_">SESSION_ALL_TRAIN</span>,trains.<span class="property">value</span>);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="集成分布式事务组件Seata（解决分布式系统中的数据一致性问题）"><a href="#集成分布式事务组件Seata（解决分布式系统中的数据一致性问题）" class="headerlink" title="集成分布式事务组件Seata（解决分布式系统中的数据一致性问题）"></a>集成分布式事务组件Seata（解决分布式系统中的数据一致性问题）</h1><p>在微服务架构中，一个功能会同时操作多个应用，传统的事务无法保证多个库之间的数据一致性，从而需要做很多额外的补偿动作和分支判断，有了Seata之后，可以很方便的开启分布式事务，保证数据最终一致性。</p>
<hr>
<h2 id="初识Seata"><a href="#初识Seata" class="headerlink" title="初识Seata"></a>初识Seata</h2><ul>
<li>TC (Transaction Coordinator) - 事务协调者（<strong>就是我们下载的server</strong>）：维护全局和分支事务的状态，驱动全局事务提交或回滚。</li>
<li>TM (Transaction Manager) - 事务管理器（<strong>哪个模块用就是哪个模块</strong>）：定义全局事务的范围：开始全局事务、提交或回滚全局事务。</li>
<li>RM (Resource Manager) - 资源管理器（<strong>就相当于数据库</strong>）：管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li>
</ul>
<h2 id="讲解Seata分布式事务的原理"><a href="#讲解Seata分布式事务的原理" class="headerlink" title="讲解Seata分布式事务的原理"></a>讲解Seata分布式事务的原理</h2><ul>
<li>就是我们写正常的流程，而补偿流程完全交给seata来做</li>
<li>比如说我们扣减一个库存，当失败的时候应该加库存。就分析这个sql，原本减就是update-1，而seata就会生成update+1来进行补偿，反向操作。同样的insert 对应的就是delete</li>
<li>什么时候进行补偿也是由seate来调度的。</li>
</ul>
<h2 id="讲解Seata分布式事务的四种模式"><a href="#讲解Seata分布式事务的四种模式" class="headerlink" title="讲解Seata分布式事务的四种模式"></a>讲解Seata分布式事务的四种模式</h2><ul>
<li><strong>AT模式，默认，简单，需要增加undo_log表，生成反向SQL，性能高，回滚后，原来没数据的，现在还是没数据</strong></li>
<li>TCC模式，try confirm&#x2F;cancel，三个阶段的代码都得自己实现，Seata只负责调度，对业务代码侵入性较强，必要时可能还要修改数据库</li>
<li>SAGA模式，长事务解决方案，需要程序员自己编写两阶段代码（AT模式不需要写第二阶段），基于状态机来实现的，需要一个JSON文件，可异步执行</li>
<li>XA模式，XA 协议是由 X&#x2F;Open 组织提出的分布式事务处理规范，基于数据库的XA协议来实现2PC又称为XA方案，适用于强一致性的场景，比如金融、银行等，需要数据库本身支持XA协议，可以跨数据库</li>
</ul>
<h2 id="Seata分布式事务初体验"><a href="#Seata分布式事务初体验" class="headerlink" title="Seata分布式事务初体验"></a>Seata分布式事务初体验</h2><ul>
<li>我们以AfterConfirmOrderService的afterDoConfirm为例，他就是涉及到两个数据库两个应用，回滚的话数据库可以回滚，但是那个应用的操作就补偿不来了，这里就使用Seata分布式事务来解决</li>
<li>seata的AT模式会自动生成反向sql，且没有反引号&#96;，所以要求数据库表里不能有关键字</li>
</ul>
<blockquote>
<p>集成seata，分布式事务测试成功；seata-server 1.6.1 直接解压运行，不需要修改里面的配置</p>
</blockquote>
<ul>
<li>在每一个数据库都添加这个表，用于AT模式生成反向sql</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `undo_log` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `branch_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rollback_info` longblob <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_created` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ext` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后把客户端依赖再common加进去</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后再business和member的bootstrap.properties配置（提示：也可以不做配置，这三个配置项都有默认值，默认客户端的tx-service-group&#x3D;default_tx_group），一个项目的多个模块配置成同一个事务组</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#事务组名称</span></span><br><span class="line"><span class="attr">seata.tx-service-group</span>=<span class="string">train-group</span></span><br><span class="line"><span class="comment">#事务组和seata集群做关联</span></span><br><span class="line"><span class="attr">seata.service.vgroup-mapping.train-group</span>=<span class="string">default</span></span><br><span class="line"><span class="comment">#seata集群对应的机器</span></span><br><span class="line"><span class="attr">seata.service.grouplist..default</span>=<span class="string">127.0.0.1:8091</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们修改下AfterConfirmOrderService的afterDoConfirm上面的注释，并添加一个日志</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line">*******************************</span><br><span class="line">LOG.info(<span class="string">&quot;seata全局事务ID save：&#123;&#125;&quot;</span>, RootContext.getXID());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们再ConfirmOrderService中调用上面afterDoConfirm处加一个try catch</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    afterConfirmOrderService.afterDoConfirm(dailyTrainTicket,finalSeatList,tickets,confirmOrder);</span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;保存购票信息失败&quot;</span>,e);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_EXCEPTION);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>那这里就需要再加一个异常枚举了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIRM_ORDER_EXCEPTION(<span class="string">&quot;服务器繁忙，请稍后再试&quot;</span>),</span><br></pre></td></tr></table></figure>

<ul>
<li>为了展示效果好，我们再TicketService的save中也添加一个日志</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOG.info(<span class="string">&quot;seata全局事务ID save：&#123;&#125;&quot;</span>, RootContext.getXID());</span><br></pre></td></tr></table></figure>

<ul>
<li>最后我们再ControllerExceptionHandler的所有异常统一处理，添加如下代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOG.info(<span class="string">&quot;seata全局事务ID save：&#123;&#125;&quot;</span>, RootContext.getXID());</span><br><span class="line"><span class="comment">//如果是在一次全局事务里出异常了，就不要包装返回值，将异常抛给调用方，让调用方回滚事务</span></span><br><span class="line"><span class="comment">//如果不加这段，member出异常时，虽然commonResp.success=false，但是接口返回码是200，business会认为调用是成功的</span></span><br><span class="line"><span class="keyword">if</span> (StrUtil.isNotBlank(RootContext.getXID()))&#123;</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Seata-Server配置Nacos"><a href="#Seata-Server配置Nacos" class="headerlink" title="Seata Server配置Nacos"></a>Seata Server配置Nacos</h2><ul>
<li>Seata的配置中心与Spring cloud的配置中心区别是?在广义上来说,并无区别,只不过Spring cloud的配置中心仅是作用于它们自身的组件,而Seata的配置中心也是一样是作用于Seata自身.(注:Spring cloud的配置中心与Seata无关)</li>
<li>修改配置中心，就是在seate的application.yml的seata.config：下添加如下</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config:</span></span><br><span class="line">    <span class="comment"># support: nacos, consul, apollo, zk, etcd3</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">namespace:</span>  <span class="string">train</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">context-path:</span></span><br><span class="line">      <span class="attr">data-id:</span> <span class="string">seataServer.properties</span></span><br></pre></td></tr></table></figure>

<ul>
<li>而修改配置中心如下所示：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">registry:</span></span><br><span class="line">   <span class="comment"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span></span><br><span class="line">   <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">   <span class="attr">nacos:</span></span><br><span class="line">     <span class="attr">application:</span> <span class="string">seata-server</span></span><br><span class="line">     <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">     <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">     <span class="attr">namespace:</span> <span class="string">train</span></span><br><span class="line">     <span class="attr">cluster:</span> <span class="string">default</span></span><br><span class="line">     <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">     <span class="attr">password:</span> <span class="string">nacos</span></span><br></pre></td></tr></table></figure>

<ul>
<li>AT模式会有个全局锁，用于防止脏读，线程1的事务修改了库存，但还没提交事务，线程2读库存时，读的还是原来的库存</li>
<li>然后呢这时候Seata就会在配置中心了，你就可以修改他对应的配置，比如seata.store.mode &#x3D; file&#x2F;db&#x2F;redis，然后就可以修改对应的配置了，比如db中的。application.example.yml都有例子</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db:</span></span><br><span class="line">      <span class="attr">datasource:</span> <span class="string">druid</span></span><br><span class="line">      <span class="attr">db-type:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/seata?rewriteBatchedStatements=true</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">min-conn:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">max-conn:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">global-table:</span> <span class="string">global_table</span></span><br><span class="line">      <span class="attr">branch-table:</span> <span class="string">branch_table</span></span><br><span class="line">      <span class="attr">lock-table:</span> <span class="string">lock_table</span></span><br><span class="line">      <span class="attr">distributed-lock-table:</span> <span class="string">distributed_lock</span></span><br><span class="line">      <span class="attr">query-limit:</span> <span class="number">1000</span></span><br><span class="line">      <span class="attr">max-wait:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>

<h2 id="Seata-Client配置Nacos"><a href="#Seata-Client配置Nacos" class="headerlink" title="Seata Client配置Nacos"></a>Seata Client配置Nacos</h2><ul>
<li>在需要使用的模块的bootstrap.properties中添加如下部分</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#seata注册中心，要和seata server的application.yml配置保持一致</span></span><br><span class="line"><span class="attr">seata.registry.type</span>=<span class="string">nacos</span></span><br><span class="line"><span class="attr">seata.registry.nacos.application</span>=<span class="string">seata-server</span></span><br><span class="line"><span class="attr">seata.registry.nacos.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br><span class="line"><span class="attr">seata.registry.nacos.group</span>=<span class="string">SEATA_GROUP</span></span><br><span class="line"><span class="attr">seata.registry.nacos.namespace</span>=<span class="string">train</span></span><br><span class="line"><span class="attr">seata.registry.nacos.username</span>=<span class="string">nacos</span></span><br><span class="line"><span class="attr">seata.registry.nacos.password</span>=<span class="string">nacos</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#seata配置中心，要和seata server的application.yml配置保持一致</span></span><br><span class="line"><span class="attr">seata.config.type</span>=<span class="string">nacos</span></span><br><span class="line"><span class="attr">seata.config.nacos.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br><span class="line"><span class="attr">seata.config.nacos.group</span>=<span class="string">SEATA_GROUP</span></span><br><span class="line"><span class="attr">seata.config.nacos.namespace</span>=<span class="string">train</span></span><br><span class="line"><span class="attr">seata.config.nacos.dataId</span>=<span class="string">seataServer.properties</span></span><br><span class="line"><span class="attr">seata.config.nacos.username</span>=<span class="string">nacos</span></span><br><span class="line"><span class="attr">seata.config.nacos.password</span>=<span class="string">nacos</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#事务组名称,必须在nacos中有配置过：service.vgroupMapping.train-group=default</span></span><br><span class="line"><span class="attr">seata.tx-service-group</span>=<span class="string">train-group</span></span><br><span class="line"><span class="comment">#事务组和seata集群做关联</span></span><br><span class="line"><span class="comment">#seata.service.vgroup-mapping.train-group=default</span></span><br><span class="line"><span class="comment">#seata集群对应的机器</span></span><br><span class="line"><span class="comment">#seata.service.grouplist..default=127.0.0.1:8091</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">################################################</span></span><br><span class="line"><span class="comment"># 以下是nacos中的seataServer.properties的相关配置</span></span><br><span class="line"><span class="comment">################################################</span></span><br><span class="line"><span class="comment"># # 和微服务模块的seata.tx-service-group保持一致</span></span><br><span class="line"><span class="comment"># service.vgroupMapping.train-group=default</span></span><br><span class="line"><span class="comment"># service.default.grouplist=127.0.0.1:8091</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># # 和微服务模块的seata.tx-service-group保持一致</span></span><br><span class="line"><span class="comment"># service.vgroupMapping.test-group=default1</span></span><br><span class="line"><span class="comment"># service.default1.grouplist=127.0.0.1:18091</span></span><br><span class="line"><span class="comment">################################################</span></span><br></pre></td></tr></table></figure>

<h2 id="Seata和Mysql存储演示"><a href="#Seata和Mysql存储演示" class="headerlink" title="Seata和Mysql存储演示"></a>Seata和Mysql存储演示</h2><ul>
<li>还有一件事，如果存储方式使用的是数据库，那么我们需要生成四张表，他的位置在seata\script\server\db，内容如下</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------------------------------- The script used when storeMode is &#x27;db&#x27; --------------------------------</span></span><br><span class="line"><span class="comment">-- the table to store GlobalSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `global_table`</span><br><span class="line">(</span><br><span class="line">    `xid`                       <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `transaction_id`            <span class="type">BIGINT</span>,</span><br><span class="line">    `status`                    TINYINT      <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `application_id`            <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `transaction_service_group` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `transaction_name`          <span class="type">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">    `timeout`                   <span class="type">INT</span>,</span><br><span class="line">    `begin_time`                <span class="type">BIGINT</span>,</span><br><span class="line">    `application_data`          <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    `gmt_create`                DATETIME,</span><br><span class="line">    `gmt_modified`              DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`xid`),</span><br><span class="line">    KEY `idx_status_gmt_modified` (`status` , `gmt_modified`),</span><br><span class="line">    KEY `idx_transaction_id` (`transaction_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store BranchSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `branch_table`</span><br><span class="line">(</span><br><span class="line">    `branch_id`         <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `xid`               <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `transaction_id`    <span class="type">BIGINT</span>,</span><br><span class="line">    `resource_group_id` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `resource_id`       <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    `branch_type`       <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">    `status`            TINYINT,</span><br><span class="line">    `client_id`         <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    `application_data`  <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    `gmt_create`        DATETIME(<span class="number">6</span>),</span><br><span class="line">    `gmt_modified`      DATETIME(<span class="number">6</span>),</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`branch_id`),</span><br><span class="line">    KEY `idx_xid` (`xid`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store lock data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `lock_table`</span><br><span class="line">(</span><br><span class="line">    `row_key`        <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `xid`            <span class="type">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">    `transaction_id` <span class="type">BIGINT</span>,</span><br><span class="line">    `branch_id`      <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `resource_id`    <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    `table_name`     <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `pk`             <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    `status`         TINYINT      <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;0:locked ,1:rollbacking&#x27;</span>,</span><br><span class="line">    `gmt_create`     DATETIME,</span><br><span class="line">    `gmt_modified`   DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`row_key`),</span><br><span class="line">    KEY `idx_status` (`status`),</span><br><span class="line">    KEY `idx_branch_id` (`branch_id`),</span><br><span class="line">    KEY `idx_xid` (`xid`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `distributed_lock`</span><br><span class="line">(</span><br><span class="line">    `lock_key`       <span class="type">CHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `lock_value`     <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `expire`         <span class="type">BIGINT</span>,</span><br><span class="line">    <span class="keyword">primary</span> key (`lock_key`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;AsyncCommitting&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;RetryCommitting&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;RetryRollbacking&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;TxTimeoutCheck&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>其中global_table和branch_table这两个表，当回滚后，也会自动将其表的内容清空</li>
</ul>
<h1 id="高并发抢票时，利用各种锁解决车票超卖问题（JDK锁-amp-分布式锁-amp-看门狗设计-amp-红锁）"><a href="#高并发抢票时，利用各种锁解决车票超卖问题（JDK锁-amp-分布式锁-amp-看门狗设计-amp-红锁）" class="headerlink" title="高并发抢票时，利用各种锁解决车票超卖问题（JDK锁&amp;分布式锁&amp;看门狗设计&amp;红锁）"></a>高并发抢票时，利用各种锁解决车票超卖问题（JDK锁&amp;分布式锁&amp;看门狗设计&amp;红锁）</h1><p>超卖问题在高并发场景中非常常见的，本章将讲解如何利用各种锁防止超卖，重点学习Redis分布式锁,解决如何实现分布式锁加过期时间与原子性加锁等问题。</p>
<hr>
<h2 id="本章介绍-2"><a href="#本章介绍-2" class="headerlink" title="本章介绍"></a>本章介绍</h2><ul>
<li>Jmeter的使用</li>
<li>synchronized和分布式锁的区别</li>
<li>分布式锁的问题及推进</li>
</ul>
<h2 id="JMeter初体验"><a href="#JMeter初体验" class="headerlink" title="JMeter初体验"></a>JMeter初体验</h2><ul>
<li>我们下载完后可以在Jmeter.properties下修改配置文件</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language</span>=<span class="string">zh_CN</span></span><br></pre></td></tr></table></figure>

<ul>
<li>jmeter的文件其实是个xml，首先将这个保存到我们项目的根目录下</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307311003581.png"
                      alt="image-20230731100318990"
                ></p>
<ul>
<li>然后我们给添加一个线程组，再线程组上在添加HTTP请求会员登陆，然后再Http请求上在添加HTTP信息头管理器。添加对应的key和value</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307311010484.png"
                      alt="image-20230731101000197"
                ></p>
<ul>
<li>这时就可以在会员登录上添加消息体数据了</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307311012077.png"
                      alt="image-20230731101257750"
                ></p>
<ul>
<li>因为http测试完老的去IDEA看结果比较麻烦，就可以在会员登录那增加一个监听器（查看结果树）即可</li>
</ul>
<h2 id="超卖演示-amp-使用JMeter对购票功能进行压测"><a href="#超卖演示-amp-使用JMeter对购票功能进行压测" class="headerlink" title="超卖演示&amp;使用JMeter对购票功能进行压测"></a>超卖演示&amp;使用JMeter对购票功能进行压测</h2><ul>
<li>这里就对购票的接口进行测试，但是出现一个问题就是中文传输的问题，解决方案：<ul>
<li>对于发送时，我们可以在HTTP请求处添加那个内容编码：utf-8</li>
<li>对于接收中文，我们在HTTP信息头管理器的Content-Type添加application&#x2F;json;charset&#x3D;utf-8</li>
<li>当然可以直接在Jmeter.properties下修改</li>
</ul>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sampleresult.default.encoding</span>=<span class="string">UTF-8</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后修改下线程数，就可以在两秒内完成500个购票操作</li>
</ul>
<h2 id="使用synchronized是否能解决库存超卖？"><a href="#使用synchronized是否能解决库存超卖？" class="headerlink" title="使用synchronized是否能解决库存超卖？"></a>使用synchronized是否能解决库存超卖？</h2><ul>
<li>超卖的原因是在ConfirmOrderService的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查出余票记录，需要得到真实的库存</span></span><br><span class="line"><span class="type">DailyTrainTicket</span> <span class="variable">dailyTrainTicket</span> <span class="operator">=</span> dailyTrainTicketService.selectByUnique(date, trainCode, start, end);</span><br><span class="line"><span class="comment">//扣减余票数量，并判断余票是否足够</span></span><br><span class="line">reduceTickets(req, dailyTrainTicket);</span><br></pre></td></tr></table></figure>

<ul>
<li>超卖原因：假设库存为1，多个线程同时读到余票记录，都认为库存为1，就都往后去选座购票，最终导致超卖</li>
<li>我们先在有这段代码的方法上加上synchronized，代表一次只能由一个线程进去</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">doConfirm</span><span class="params">(ConfirmOrderDoReq req)</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>加锁会导致吞吐量&#x2F;TPS变低，即：售卖效率不高，但是确实解决了单节点的超卖情况</li>
<li>但是如果是多个节点呢？好几百个节点同时卖票，这时候还是会出现超卖现象</li>
<li><strong>大多数程序员，一遇到性能问题，首先想到的是增加节点</strong></li>
</ul>
<blockquote>
<p>synchronized会有两个问题：1.会导致售卖效率不高（可以容忍）；2.在多节的情况下，还是会出现超卖（不能容忍）</p>
</blockquote>
<h2 id="使用Redis分布式锁是否能解决库存超卖？"><a href="#使用Redis分布式锁是否能解决库存超卖？" class="headerlink" title="使用Redis分布式锁是否能解决库存超卖？"></a>使用Redis分布式锁是否能解决库存超卖？</h2><ul>
<li>解决超卖：所有节点使用同一个锁（也可以通过数据库加锁，只要所有节点都可以读到这张表，但是mysql性能不高）</li>
<li>多个人抢同一个车次，可能发生超卖；多个人抢不同车次，就互不影响了。</li>
</ul>
<blockquote>
<p>使用redis分布式锁解决超卖的问题</p>
</blockquote>
<ul>
<li>首先修改ConfirmOrderService，引入redis，并在doConfirm方法中操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> DateUtil.formatDate(req.getDate()) + <span class="string">&quot;-&quot;</span> + req.getTrainCode();</span><br><span class="line"><span class="type">Boolean</span> <span class="variable">setIfAbsent</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(lockKey, lockKey, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="keyword">if</span> (setIfAbsent)&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;恭喜抢到锁了&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//只是没抢到锁，并不知道票抢完了没，所以提示稍后再试</span></span><br><span class="line">    LOG.info(<span class="string">&quot;很遗憾，没抢到票&quot;</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_LOCK_FAIL);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们增加一个异常枚举</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIRM_ORDER_LOCK_FAIL(<span class="string">&quot;当前抢票人数多，请稍后重试&quot;</span>),</span><br></pre></td></tr></table></figure>

<ul>
<li>上面设置的超时时间是5s，5s过后下一个人才能购票，这可不行，应该不管程序购票成功还是失败，只要完成了就应该把锁删除，在文本最后添加</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">//之前的代码记得一定不要包括上面有锁的代码</span></span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;购票流程结束，释放锁&quot;</span>);</span><br><span class="line">    <span class="comment">//删除分布式锁</span></span><br><span class="line">    redisTemplate.delete(lockKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分布式锁常见的问题：没拿到锁的线程把别人的锁给删了</p>
</li>
<li><p>本小节把释放锁移出finally不是最优解：</p>
<ul>
<li>解法有21加锁的动作不要放在try里</li>
<li>加锁时，将当前线程ID放到锁对应的value中，删除时，先去获取value，比对value值和当前线程ID一致才能删除</li>
</ul>
</li>
<li><p>而且这里我们引入的注释还需要换一下，@Autowired是根据StringRedisTemplate来寻找Bean，而@Resource是通过redisTemplate来寻找，这样就不会报错了</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br></pre></td></tr></table></figure>

<h2 id="使用Redisson看门狗解决锁超时的问题"><a href="#使用Redisson看门狗解决锁超时的问题" class="headerlink" title="使用Redisson看门狗解决锁超时的问题"></a>使用Redisson看门狗解决锁超时的问题</h2><ul>
<li><strong>redis的分布式锁是setnx</strong>，然而实际项目中不使用上面的代码（问题：线程执行时间超过锁时间，会导致锁失效，从而出现超卖）</li>
<li>这里使用守护线程，使用守护线程的好处是会随主线程的结束而结束，所以不会出现一直重置成60秒，永不过期的问题.使用的过程如下：</li>
<li>首先在根目录导入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.21.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后再使用的模块也导入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这里我们再ConfirmOrderService中使用,这里加了try-catch-finally不管程序购票成功还是失败，只要完成了就应该把锁删除</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> DateUtil.formatDate(req.getDate()) + <span class="string">&quot;-&quot;</span> + req.getTrainCode();</span><br><span class="line"><span class="comment">//        Boolean setIfAbsent = redisTemplate.opsForValue().setIfAbsent(lockKey, lockKey, 5, TimeUnit.SECONDS);</span></span><br><span class="line"><span class="comment">//        if (setIfAbsent)&#123;</span></span><br><span class="line"><span class="comment">//            LOG.info(&quot;恭喜抢到锁了&quot;);</span></span><br><span class="line"><span class="comment">//        &#125;else&#123;</span></span><br><span class="line"><span class="comment">//            //只是没抢到锁，并不知道票抢完了没，所以提示稍后再试</span></span><br><span class="line"><span class="comment">//            LOG.info(&quot;很遗憾，没抢到票&quot;);</span></span><br><span class="line"><span class="comment">//            throw new BusinessException(BusinessExceptionEnum.CONFIRM_ORDER_LOCK_FAIL);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//使用redisson，自带看门狗</span></span><br><span class="line">    lock = redissonClient.getLock(lockKey);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * waitTime 等待获取锁时间（最大尝试获得锁的时间，超时返回false）</span></span><br><span class="line"><span class="comment">             * leaseTime 锁时长，即n秒后自动释放锁</span></span><br><span class="line"><span class="comment">             * time unit 时间单位</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">    <span class="comment">//boolean tryLock = lock.tryLock(30,10, TimeUnit.SECONDS);//不带看门狗</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">tryLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">0</span>, TimeUnit.SECONDS);<span class="comment">//带看门狗</span></span><br><span class="line">    <span class="keyword">if</span> (tryLock) &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;恭喜，找到锁了！&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;很遗憾，没有抢到锁&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_LOCK_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">            *中间那那些代码</span></span><br><span class="line"><span class="comment">            **/</span></span><br><span class="line">&#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;购票异常&quot;</span>,e);</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;购票流程结束，释放锁！&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != lock &amp;&amp; lock.isHeldByCurrentThread())&#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    <span class="comment">//LOG.info(&quot;购票流程结束，释放锁&quot;);</span></span><br><span class="line">    <span class="comment">//删除分布式锁</span></span><br><span class="line">    <span class="comment">//redisTemplate.delete(lockKey);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="介绍Redis红锁"><a href="#介绍Redis红锁" class="headerlink" title="介绍Redis红锁"></a>介绍Redis红锁</h2><blockquote>
<p>Redis 红锁的名称来源于 Redis 的logo，Redis 的logo是一个红色热气球，而红色的热气球上有一把锁的图案，因此这种分布式锁解决方案也被称为”Redlock”，中文翻译为”红锁”</p>
</blockquote>
<ul>
<li>红锁处理redis宕机的情况，就是假如有五个redis（ABCDE，一般要求是奇数个），每个线程必须按顺序拿，最终谁拿到了半数以上就算拿到锁了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//使用redisson，自带看门狗</span></span><br><span class="line">    lock = redissonClient.getLock(lockKey);</span><br><span class="line">    lock1 = redissonClient.getLock(lockKey);</span><br><span class="line">    <span class="type">RedissonRedLock</span> <span class="variable">redissonRedLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedissonRedLock</span>(lock, lock1);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">tryLock1</span> <span class="operator">=</span> redissonRedLock.tryLock(<span class="number">0</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<ul>
<li>其实这里还有一个问题，就是一共五个redis当第一个线程拿到了三个redis（ABC），这时突然C宕机了，C立即重启，于此同时第二个线程也进来了，他就拿到了CDE，他也认为拿到了锁，就去执行任务，这肯定不行。所以这就规定，<strong>宕机了不能立即重启。</strong>应该等待锁的时间结束后重启</li>
</ul>
<h2 id="本章代码优化"><a href="#本章代码优化" class="headerlink" title="本章代码优化"></a>本章代码优化</h2><blockquote>
<p>Spring拦截器配置的路径，不要包含context-path</p>
</blockquote>
<ul>
<li>我们修改member和business的拦截器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//路径不要包含context-path</span></span><br><span class="line">registry.addInterceptor(memberInterceptor)</span><br><span class="line">    .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">    .excludePathPatterns(</span><br><span class="line">    <span class="string">&quot;/hello&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">registry.addInterceptor(memberInterceptor)</span><br><span class="line">    .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">    .excludePathPatterns(</span><br><span class="line">    <span class="string">&quot;/hello&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/member/send-code&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/member/login&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>要不然我们所有的代码都会走common模块的MemberInterceptor</li>
</ul>
<h2 id="JMeter线程组之间传递token变量"><a href="#JMeter线程组之间传递token变量" class="headerlink" title="JMeter线程组之间传递token变量"></a>JMeter线程组之间传递token变量</h2><ul>
<li>本节就是将JMeter的会员登录请求里的token变成全局变量，然后传到其他HTTP请求</li>
<li>首先添加一个token提取器</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307311430048.png"
                      alt="image-20230731143032637"
                ></p>
<ul>
<li>到这一步了，我们并不知道token提取出来了吗，这时候需要再添加一个调试后置处理程序，默认即可</li>
<li>因为这时候他只是当前组的变量，需要把他设置成全局变量，在会员登录处添加BeanShell 后置处理程序，再函数助手添加对应参数就能生成函数</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307311440437.png"
                      alt="image-20230731144003121"
                ></p>
<ul>
<li>然后我们在另一个线程组使用全局的token</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307311446792.png"
                      alt="image-20230731144624435"
                ></p>
<ul>
<li>还有一件事，记得把这个勾上</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202307311447064.png"
                      alt="image-20230731144659653"
                ></p>
<h1 id="高并发抢票时，使用Sentinal组件进行请求限流降级（过滤90-的无效请求）"><a href="#高并发抢票时，使用Sentinal组件进行请求限流降级（过滤90-的无效请求）" class="headerlink" title="高并发抢票时，使用Sentinal组件进行请求限流降级（过滤90%的无效请求）"></a>高并发抢票时，使用Sentinal组件进行请求限流降级（过滤90%的无效请求）</h1><p>本章学习常见的限流手段，重点学习Sentinal的使用，在高并发中，短时间内会有大量请求进来，但并不是所有的请求都能买到票，所以我们需要对请求做限流，以减轻服务器无谓的请求。</p>
<hr>
<h2 id="本章介绍-3"><a href="#本章介绍-3" class="headerlink" title="本章介绍"></a>本章介绍</h2><ul>
<li>sentinal限流降级</li>
<li>sentinal熔断降级</li>
<li>sentinal+nacos组合</li>
</ul>
<h2 id="常见的限流算法"><a href="#常见的限流算法" class="headerlink" title="常见的限流算法"></a>常见的限流算法</h2><ul>
<li>静态窗口限流（按照每秒来控制请求速度）</li>
<li>动态窗口限流（每次都往前取一秒）</li>
</ul>
<blockquote>
<p>例如：当前是第2.5秒<br>静态：统计第2秒到现在的请求数<br>动态：统计第1.5秒到现在的请求数</p>
</blockquote>
<ul>
<li>漏桶限流（进来的时候大容量请求接收，出去的时候匀速出去）</li>
<li>令牌桶限流（有一个产生令牌的程序，按照每秒多少个令牌的速度去存令牌，谁来谁取）</li>
<li>令牌大闸（在初始的时候就给一堆令牌）</li>
</ul>
<h2 id="初识Sentinel"><a href="#初识Sentinel" class="headerlink" title="初识Sentinel"></a>初识Sentinel</h2><ul>
<li>流量的控制在被调用方</li>
<li>熔断是在调用方的</li>
</ul>
<blockquote>
<p><a class="link"   target="_blank" rel="noopener" href="https://sentinelguard.io/en-us/docs/quick-start.html" >https://sentinelguard.io/en-us/docs/quick-start.html<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<ul>
<li>首先在business的模块增加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--限流熔断--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第二步，增加一个资源把他注解在一个方法上</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(&quot;doConfirm&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">doConfirm</span><span class="params">(ConfirmOrderDoReq req)</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>第三步，定义规则在business的启动类，并在main函数中使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initFlowRules</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;FlowRule&gt; rules = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;FlowRule&gt;();</span><br><span class="line">    <span class="type">FlowRule</span> <span class="variable">rule</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlowRule</span>();</span><br><span class="line">    rule.setResource(<span class="string">&quot;doConfirm&quot;</span>);</span><br><span class="line">    <span class="comment">// set limit qps to 20</span></span><br><span class="line">    rule.setCount(<span class="number">20</span>);</span><br><span class="line">    rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">    rules.add(rule);</span><br><span class="line">    FlowRuleManager.loadRules(rules);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>但是这样报错都是系统错误，所以我们要修改下他报错信息，首先在BusinessExceptionEnum增加枚举</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIRM_ORDER_FLOW_EXCEPTION(<span class="string">&quot;当前抢票人数多，请稍后重试&quot;</span>),</span><br></pre></td></tr></table></figure>

<ul>
<li>并且修改ConfirmOrderService，注解修改</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(value = &quot;doConfirm&quot;,blockHandler = &quot;doConfirmBlock&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在类最后增加注解中的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 降级方法。需包括限流方法的所有参数和BlockException参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doConfirmBlock</span><span class="params">(ConfirmOrderDoReq req, BlockException e)</span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;购票请求被限流：&#123;&#125;&quot;</span>,req);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_FLOW_EXCEPTION);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用Sentinel控台监控流量"><a href="#使用Sentinel控台监控流量" class="headerlink" title="使用Sentinel控台监控流量"></a>使用Sentinel控台监控流量</h2><ul>
<li>首先我们下载sentinel-dashboard-1.8.6.jar</li>
<li>然后我们命令行启动</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=<span class="number">18080</span> -Dcsp.sentinel.dashboard.server=localhost:<span class="number">18080</span> -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-<span class="number">1</span>.<span class="number">8</span>.<span class="number">6</span>.jar</span><br></pre></td></tr></table></figure>

<ul>
<li>在business模块增加配置</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sentinel控台</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.transport.port</span>=<span class="string">8791</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.transport.dashboard</span>=<span class="string">localhost:18080</span></span><br></pre></td></tr></table></figure>

<h2 id="使用Sentinel配置限流"><a href="#使用Sentinel配置限流" class="headerlink" title="使用Sentinel配置限流"></a>使用Sentinel配置限流</h2><ul>
<li><p>控台不保存规则，一旦应用重启，之前设置的规则就全没了</p>
</li>
<li><p>通过控台对接口的限流可以不用提前为每个接口加资源</p>
</li>
<li><p>我们为ConfirmOrderController接口进行限流</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.annotation.SentinelResource;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.ConfirmOrderDoReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.service.ConfirmOrderService;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.exception.BusinessExceptionEnum;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/confirm-order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmOrderController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(ConfirmOrderController.class);</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ConfirmOrderService confirmOrderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接口的资源名称不要和接口路径一致，会导致限流后走不到降级方法中</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;confirmOrderDo&quot;,blockHandler = &quot;doConfirmBlock&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/do&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;Object&gt; <span class="title function_">doConfirm</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ConfirmOrderDoReq req)</span>&#123;</span><br><span class="line">        confirmOrderService.doConfirm(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 降级方法。需包括限流方法的所有参数和BlockException参数,且返回值也要保持一致</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;Object&gt; <span class="title function_">doConfirmBlock</span><span class="params">(ConfirmOrderDoReq req, BlockException e)</span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;ConfirmOrderController购票请求被限流：&#123;&#125;&quot;</span>,req);</span><br><span class="line">        CommonResp&lt;Object&gt; commonResp = <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;();</span><br><span class="line">        commonResp.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        commonResp.setMessage(BusinessExceptionEnum.CONFIRM_ORDER_FLOW_EXCEPTION.getDesc());</span><br><span class="line">        <span class="keyword">return</span> commonResp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后先通过JMeter进行接口测试下，这时候Sentinel就会出现相应的接口了，在簇点链路想要限流的接口进行流控</li>
</ul>
<h2 id="Sentinel-Nacos实现限流规则持久化"><a href="#Sentinel-Nacos实现限流规则持久化" class="headerlink" title="Sentinel+Nacos实现限流规则持久化"></a>Sentinel+Nacos实现限流规则持久化</h2><ul>
<li>我们首先在business模块下引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--sentinel + nacos--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>因为他是属于springCloud，所以我们把所有的关于springCloud的配置都放到bootstrap.properties中</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sentinel控台</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.transport.port</span>=<span class="string">8791</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.transport.dashboard</span>=<span class="string">localhost:18080</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#sentinel + nacos</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.datasource.flow.nacos.server-addr</span>=<span class="string">localhost:8848</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.datasource.flow.nacos.namespace</span>=<span class="string">train</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.datasource.flow.nacos.groupId</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.datasource.flow.nacos.dataId</span>=<span class="string">sentinel-business-flow</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.datasource.flow.nacos.ruleType</span>=<span class="string">flow</span></span><br></pre></td></tr></table></figure>

<ul>
<li>接下来去nacos中配置列表中的train分组下克隆一个sentinel，在里面的配置内容都是对应sentinel编辑流控规则里面的</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="string">&quot;doConfirm&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;limitApp&quot;</span><span class="punctuation">:</span><span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span><span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;controlBehavior&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;clusterMode&quot;</span><span class="punctuation">:</span><span class="keyword">false</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="string">&quot;confirmOrderDo&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;limitApp&quot;</span><span class="punctuation">:</span><span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span><span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;controlBehavior&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;clusterMode&quot;</span><span class="punctuation">:</span><span class="keyword">false</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h2 id="Sentinel限流不同的流控效果讲解-Warm-Up-amp-排队等待"><a href="#Sentinel限流不同的流控效果讲解-Warm-Up-amp-排队等待" class="headerlink" title="Sentinel限流不同的流控效果讲解 - Warm Up&amp;排队等待"></a>Sentinel限流不同的流控效果讲解 - Warm Up&amp;排队等待</h2><ul>
<li>在Sentinel的新增流控规则那，有一个预热时长，假如为10，单机阈值为100。<strong>（coldFactor为3，即请求QPS从（阈值&#x2F;</strong><br><strong>3）开始，经多少预热时长才逐渐升至设定的QPS阈值，比如阈值是100，时长是10秒，则从33开始经过10秒上升到100</strong>）</li>
<li>预热会防止项目启动时出现大量的错误，这里配置还是在nacos配置中配置，</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="string">&quot;doConfirm&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;limitApp&quot;</span><span class="punctuation">:</span><span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span><span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;controlBehavior&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;warmUpPeriodSec&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;clusterMode&quot;</span><span class="punctuation">:</span><span class="keyword">false</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>排队等待会有一个超时时间，如果超过超时时间的请求还没连接上，就失效了</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="string">&quot;doConfirm&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;limitApp&quot;</span><span class="punctuation">:</span><span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span><span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;controlBehavior&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;maxQueueingTimeMs&quot;</span><span class="punctuation">:</span><span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;clusterMode&quot;</span><span class="punctuation">:</span><span class="keyword">false</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h2 id="Sentinel限流不同的流控模式讲解-关联-amp-链路"><a href="#Sentinel限流不同的流控模式讲解-关联-amp-链路" class="headerlink" title="Sentinel限流不同的流控模式讲解 - 关联&amp;链路"></a>Sentinel限流不同的流控模式讲解 - 关联&amp;链路</h2><blockquote>
<p>流控模式</p>
</blockquote>
<ul>
<li>对目标的限流是有条件的，需要关联的资源限流时，目标才会限流。就是有一个资源名是支付，另一个关联资源是下单，如果下单被限流，那么支付也自然而然就限流了。必须下单被限流，支付才会被限流。(两个接口的限流是实时的)</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="string">&quot;hello1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;limitApp&quot;</span><span class="punctuation">:</span><span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span><span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;refResource&quot;</span><span class="punctuation">:</span><span class="string">&quot;hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;controlBehavior&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;clusterMode&quot;</span><span class="punctuation">:</span><span class="keyword">false</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>链路模式：两个不同入口的接口去访问共有的资源，只针对某一个接口进行限流</p>
</blockquote>
<ul>
<li>默认情况下我们的设置的资源都在sentinel_default_context链路下，这时候怎么配置链路都是不生效的，我们修改business的springcloud配置让其各自都成链路</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#流控模式是链路时，必须关闭这个配置，默认时true，为true时可以在控台-簇点链路界面看到所有请求都在一个链路下面</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.web-context-unify</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>我们设置了两个接口都会去调用TestService.hello2（）的方法，我们要做到从hello进来调用hello2的不限流，从hello1调用的就限流，就可以手动配置也可以从nacos中配置</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[&#123;</span></span><br><span class="line">  <span class="attr">&quot;resource&quot;</span>:<span class="string">&quot;hello2&quot;,</span></span><br><span class="line">  <span class="attr">&quot;limitApp&quot;</span>:<span class="string">&quot;default&quot;,</span></span><br><span class="line">  <span class="attr">&quot;grade&quot;</span>:<span class="string">0,</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span>:<span class="string">2,</span></span><br><span class="line">  <span class="attr">&quot;strategy&quot;</span>:<span class="string">2,</span></span><br><span class="line">  <span class="attr">&quot;refResource&quot;</span>:<span class="string">&quot;/hello1&quot;,</span></span><br><span class="line">  <span class="attr">&quot;controlBehavior&quot;</span>:<span class="string">0,</span></span><br><span class="line">  <span class="attr">&quot;clusterMode&quot;</span>:<span class="string">false</span></span><br><span class="line"><span class="attr">&#125;]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>提示：如果配置没问题，但测不效果，可以重启应用，并重启Sentinel控台</li>
</ul>
<h2 id="Sentinel-Feign熔段初体验"><a href="#Sentinel-Feign熔段初体验" class="headerlink" title="Sentinel+Feign熔段初体验"></a>Sentinel+Feign熔段初体验</h2><blockquote>
<p>慢调用比例</p>
</blockquote>
<ul>
<li><p>熔断一般发生在A调用B两个应用之间的调用，当B突然挂了，A这时调用B肯定出错，所以就要把B应用断开，并且根据之前协调好的调用一个备用的值来充当B应用</p>
</li>
<li><p>我们以batch调用business为例，首先在batch的springcloud的配置文件中增加配置</p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sentinel控台</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.transport.port</span>=<span class="string">8791</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.transport.dashboard</span>=<span class="string">localhost:18080</span></span><br><span class="line"><span class="comment">#流控模式是链路时，必须关闭这个配置，默认时true，为true时可以在控台-簇点链路界面看到所有请求都在一个链路下面</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.web-context-unify</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">#sentinel + nacos</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.datasource.degrade.nacos.server-addr</span>=<span class="string">localhost:8848</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.datasource.degrade.nacos.namespace</span>=<span class="string">train</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.datasource.degrade.nacos.groupId</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.datasource.degrade.nacos.dataId</span>=<span class="string">sentinel-batch-degrade</span></span><br><span class="line"><span class="attr">spring.cloud.sentinel.datasource.degrade.nacos.ruleType</span>=<span class="string">degrade</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#sentinel默认不监控feign，需要改成true，在簇点链路界面会显示资源 GET:http://business/business/hello</span></span><br><span class="line"><span class="attr">feign.sentinel.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#上面改成true后，启动会报注入失败，需要更改为懒加载</span></span><br><span class="line"><span class="attr">spring.cloud.openfeign.lazy-attributes-resolution</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们打开Sentinel中的熔断规则就可以配置相应的规则了，当然这里还是在nacos中配置，同样克隆一个sentinel-batch-degrade</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="string">&quot;GET:http://business/business/hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span><span class="number">201</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timeWindow&quot;</span><span class="punctuation">:</span><span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;minRequestAmount&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;startIntervalMs&quot;</span><span class="punctuation">:</span><span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;slowRatioThreshold&quot;</span><span class="punctuation">:</span><span class="number">0.3</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h2 id="Sentinel-Feign熔断后的降级处理"><a href="#Sentinel-Feign熔断后的降级处理" class="headerlink" title="Sentinel+Feign熔断后的降级处理"></a>Sentinel+Feign熔断后的降级处理</h2><ul>
<li>我们首先在batch的feign软件包下创建一个熔断后调用的类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.feign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessFeignFallback</span> <span class="keyword">implements</span> <span class="title class_">BusinessFeign</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Fallback&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;Object&gt; <span class="title function_">genDaily</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再BusinessFeign中增加注释，当business熔断后调用BusinessFeignFallback类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.batch.feign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;business&quot;,fallback = BusinessFeignFallback.class)</span></span><br><span class="line"><span class="comment">//@FeignClient(name=&quot;business&quot;,url=&quot;http://127.0.0.1:8002/business&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BusinessFeign</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/business/business/test&quot;)</span></span><br><span class="line">    String <span class="title function_">hello</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/business/admin/daily-train/gen-daily/&#123;date&#125;&quot;)</span></span><br><span class="line">    CommonResp&lt;Object&gt; <span class="title function_">genDaily</span><span class="params">(<span class="meta">@PathVariable</span> <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date date)</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Sentinel熔断规则配置演示"><a href="#Sentinel熔断规则配置演示" class="headerlink" title="Sentinel熔断规则配置演示"></a>Sentinel熔断规则配置演示</h2><blockquote>
<p>异常比例</p>
</blockquote>
<ul>
<li>他的比例阈值代表的意思是，加入设置为0.3，如过有10个任务，有三个是出异常的这时候就要熔断了</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="string">&quot;GET:http://business/business/hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span><span class="number">0.3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timeWindow&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;minRequestAmount&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;startIntervalMs&quot;</span><span class="punctuation">:</span><span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>因为我们有一个全局处理异常，所以如果想要batch捕获到异常，我们需要针对那个想要抛出去的异常，添加一个异常处理</li>
</ul>
<blockquote>
<p>异常数</p>
</blockquote>
<ul>
<li>毫无疑问，异常数为3，则有三个异常就开始熔断</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="string">&quot;GET:http://business/business/hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timeWindow&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;minRequestAmount&quot;</span><span class="punctuation">:</span><span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;startIntervalMs&quot;</span><span class="punctuation">:</span><span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h1 id="高并发抢票时，防止机器人刷票的令牌大闸，可减轻服务器的压力（防刷-限流）"><a href="#高并发抢票时，防止机器人刷票的令牌大闸，可减轻服务器的压力（防刷-限流）" class="headerlink" title="高并发抢票时，防止机器人刷票的令牌大闸，可减轻服务器的压力（防刷+限流）"></a>高并发抢票时，防止机器人刷票的令牌大闸，可减轻服务器的压力（防刷+限流）</h1><p>本章主要讲解令牌大闸的使用，进一步减轻服务器压力，对令牌桶与令牌大闸及如何增加通用秒杀令牌大闸做详细介绍，实现如何为令牌接口增加防机器人刷票的功能，以及如何为令牌接口设置限流等。</p>
<hr>
<h2 id="本章介绍-4"><a href="#本章介绍-4" class="headerlink" title="本章介绍"></a>本章介绍</h2><ul>
<li>为什么要引入令牌大闸<ul>
<li>分布式锁和限流都不能解决机器人刷票的问题，1000个请求抢票，900个限流快速失败，另外100个有可能是同一个人在刷库</li>
<li>没有余票时，需要查库存才能知道没票，会影响性能，不如查令牌余量来得快</li>
</ul>
</li>
</ul>
<h2 id="增加秒杀令牌表用以维护令牌信息"><a href="#增加秒杀令牌表用以维护令牌信息" class="headerlink" title="增加秒杀令牌表用以维护令牌信息"></a>增加秒杀令牌表用以维护令牌信息</h2><ul>
<li>首先在business模块增加数据库表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `sk_token`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `sk_token` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `<span class="type">date</span>` <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">  `train_code` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;车次编号&#x27;</span>,</span><br><span class="line">  `count` <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;令牌余量&#x27;</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;新增时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">3</span>) comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">primary</span> key (`id`),</span><br><span class="line">  <span class="keyword">unique</span> key `date_train_code_unique` (`<span class="type">date</span>`, `train_code`)</span><br><span class="line">) engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;秒杀令牌&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就是各种生成</li>
</ul>
<h2 id="初始化车次信息时初始化秒杀令牌信息"><a href="#初始化车次信息时初始化秒杀令牌信息" class="headerlink" title="初始化车次信息时初始化秒杀令牌信息"></a>初始化车次信息时初始化秒杀令牌信息</h2><blockquote>
<p>初始化车次信息时初始化秒杀令牌信息</p>
</blockquote>
<ul>
<li>首先在SkTokenService中增加生成令牌的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DailyTrainSeatService dailyTrainSeatService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DailyTrainStationService dailyTrainStationService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> date</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> trainCode</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">genDaily</span><span class="params">(Date date, String trainCode)</span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;删除日期【&#123;&#125;】车次【&#123;&#125;】的令牌记录&quot;</span>, DateUtil.formatDate(date),trainCode);</span><br><span class="line">    <span class="type">SkTokenExample</span> <span class="variable">skTokenExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkTokenExample</span>();</span><br><span class="line">    skTokenExample.createCriteria().andDateEqualTo(date).andTrainCodeEqualTo(trainCode);</span><br><span class="line">    skTokenMapper.deleteByExample(skTokenExample);</span><br><span class="line"></span><br><span class="line">    <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line">    <span class="type">SkToken</span> <span class="variable">skToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkToken</span>();</span><br><span class="line">    skToken.setDate(date);</span><br><span class="line">    skToken.setTrainCode(trainCode);</span><br><span class="line">    skToken.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">    skToken.setCreateTime(now);</span><br><span class="line">    skToken.setUpdateTime(now);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">seatCount</span> <span class="operator">=</span> dailyTrainSeatService.countSeat(date,trainCode);</span><br><span class="line">    LOG.info(<span class="string">&quot;车次【&#123;&#125;】座位数：&#123;&#125;&quot;</span>,trainCode,seatCount);</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">stationCount</span> <span class="operator">=</span> dailyTrainStationService.countByTrainCode(date,trainCode);</span><br><span class="line">    LOG.info(<span class="string">&quot;车次【&#123;&#125;】到站数：&#123;&#125;&quot;</span>,trainCode,stationCount);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3/4根据实际买票比例来顶，一趟火车最多可卖（seatCount * stationCount）张</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> (<span class="type">int</span>) (seatCount * stationCount* <span class="number">3</span>/<span class="number">4</span>);</span><br><span class="line">    LOG.info(<span class="string">&quot;车次【&#123;&#125;】初始生成令牌数：&#123;&#125;&quot;</span>,trainCode,count);</span><br><span class="line">    skToken.setCount(count);</span><br><span class="line"></span><br><span class="line">    skTokenMapper.insert(skToken);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改DailyTrainSeatService中计算座位的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countSeat</span><span class="params">(Date date,String trainCode)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> countSeat(date,trainCode,<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countSeat</span><span class="params">(Date date,String trainCode,String seatType)</span>&#123;</span><br><span class="line">    <span class="type">DailyTrainSeatExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainSeatExample</span>();</span><br><span class="line">    DailyTrainSeatExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> example.createCriteria();</span><br><span class="line">    criteria.andDateEqualTo(date)</span><br><span class="line">            .andTrainCodeEqualTo(trainCode);</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(seatType))&#123;</span><br><span class="line">        criteria .andSeatTypeEqualTo(seatType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span>  dailyTrainSeatMapper.countByExample(example);</span><br><span class="line">    <span class="keyword">if</span> (l ==<span class="number">0L</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>) l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在DailyTrainStationService增加查询全部车站</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按车次查询全部车站</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">countByTrainCode</span><span class="params">(Date date,String trainCode)</span>&#123;</span><br><span class="line">    <span class="type">DailyTrainStationExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainStationExample</span>();</span><br><span class="line">    example.createCriteria().andDateEqualTo(date).andTrainCodeEqualTo(trainCode);</span><br><span class="line">    <span class="type">long</span> <span class="variable">stationCount</span> <span class="operator">=</span> dailyTrainStationMapper.countByExample(example);</span><br><span class="line">    <span class="keyword">return</span> stationCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后在DailyTrainService中统一生成</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成令牌余量数据</span></span><br><span class="line">skTokenService.genDaily(date,train.getCode());</span><br></pre></td></tr></table></figure>

<blockquote>
<p>令牌页面只能查询和修改余量</p>
</blockquote>
<ul>
<li>就是把新增和删除那注销了，留下了修改的按钮，并且把模态框的日期和车次编号都编辑为不可修改</li>
</ul>
<h2 id="增加校验秒杀令牌功能"><a href="#增加校验秒杀令牌功能" class="headerlink" title="增加校验秒杀令牌功能"></a>增加校验秒杀令牌功能</h2><ul>
<li>正面对令牌增加修改的逻辑，通用的方法：先查数据，再-1，判断余量&gt;&#x3D;0，再更新数据库</li>
<li>首先在ConfirmOrderService中的doConfirm开头增加校验方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> SkTokenService skTokenService;</span><br><span class="line"></span><br><span class="line"><span class="comment">//校验令牌余量</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">validSkToken</span> <span class="operator">=</span> skTokenService.validSkToken(req.getDate(),req.getTrainCode(),LoginMemberContext.getId());</span><br><span class="line"><span class="keyword">if</span> (validSkToken)&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;令牌校验通过&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;令牌校验不通过&quot;</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_SK_TOKEN_FAIL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在SkTokenService增加获取令牌方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取令牌</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">validSkToken</span><span class="params">(Date date,String trainCode,Long memberId)</span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;会员【&#123;&#125;】获取日期【&#123;&#125;】车次【&#123;&#125;】的令牌开始&quot;</span>,memberId,DateUtil.formatDate(date));</span><br><span class="line">    <span class="comment">//令牌约等于库存，令牌没有了，就不再卖票，不需要再进入购票主流程去判断库存，判断令牌肯定比判断库存效率高</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">updateCount</span> <span class="operator">=</span> skTokenMapperCust.decrease(date,trainCode);</span><br><span class="line">    <span class="keyword">if</span> (updateCount &gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加skTokenMapperCust的mapper</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.fzx.train.business.mapper.cust.SkTokenMapperCust&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;decrease&quot;</span>&gt;</span></span><br><span class="line">    update sk_token</span><br><span class="line">    set `count` = if (`count` <span class="symbol">&amp;lt;</span> 1, 0, `count` - 1)</span><br><span class="line">    where `date` = #&#123;date&#125;</span><br><span class="line">    and train_code = #&#123;trainCode&#125;</span><br><span class="line">    and `count` &gt; 0</span><br><span class="line">  <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>对应的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.mapper.cust;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SkTokenMapperCust</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">decrease</span><span class="params">(Date date, String trainCode)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在BusinessExceptionEnum中添加一个枚举</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIRM_ORDER_SK_TOKEN_FAIL(<span class="string">&quot;票已卖光&quot;</span>),</span><br></pre></td></tr></table></figure>

<h2 id="使用令牌锁防止机器人抢票"><a href="#使用令牌锁防止机器人抢票" class="headerlink" title="使用令牌锁防止机器人抢票"></a>使用令牌锁防止机器人抢票</h2><ul>
<li>只需要在SkTokenService的validSkToken添加一个分布式锁即可</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">//先获取令牌锁，再校验令牌余量，防止机器人抢票，LockKey就是令牌，用来表示【谁能做什么】的一个凭证</span></span><br><span class="line"><span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> DateUtil.formatDate(date)+<span class="string">&quot;-&quot;</span>+trainCode+<span class="string">&quot;-&quot;</span>+memberId;</span><br><span class="line"><span class="type">Boolean</span> <span class="variable">setIfAbsent</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(lockKey, lockKey, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="keyword">if</span> (Boolean.TRUE.equals(setIfAbsent))&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;恭喜，抢到令牌锁了！lockKey：&#123;&#125;&quot;</span>,lockKey);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;很遗憾，没抢到令牌锁！lockKey：&#123;&#125;&quot;</span>,lockKey);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用缓存加速令牌锁功能"><a href="#使用缓存加速令牌锁功能" class="headerlink" title="使用缓存加速令牌锁功能"></a>使用缓存加速令牌锁功能</h2><ul>
<li>当程序一开的时候，肯定会有很多人来购票，这时候很多人拿到了令牌会对数据库做修改，给了数据库很大的压力，因此会引入缓存不实时的更新数据库</li>
</ul>
<blockquote>
<p>对放入redis的LockKey加一个前缀，避免不同的业务共用一个key</p>
</blockquote>
<ul>
<li>随着业务量的增加，为了防止key混乱，这里给key加一个前缀，首先定义一个枚举</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">RedisKeyPreEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    CONFIRM_ORDER(<span class="string">&quot;LOCK_CONFIRM_ORDER&quot;</span>, <span class="string">&quot;购票锁&quot;</span>),</span><br><span class="line">    SK_TOKEN(<span class="string">&quot;LOCK_SK_TOKEN&quot;</span>, <span class="string">&quot;令牌锁&quot;</span>),</span><br><span class="line">    SK_TOKEN_COUNT(<span class="string">&quot;SK_TOKEN_COUNT&quot;</span>, <span class="string">&quot;令牌数&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;</span><br><span class="line"></span><br><span class="line">    RedisKeyPreEnum(String code, String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>比如在ConfirmOrderService类中doConfirm方法添加key</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisKeyPreEnum.CONFIRM_ORDER + <span class="string">&quot;-&quot;</span> +DateUtil.formatDate(req.getDate()) + <span class="string">&quot;-&quot;</span> + req.getTrainCode();</span><br></pre></td></tr></table></figure>

<ul>
<li>在SkTokenService的validSkToken方法中添加key</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisKeyPreEnum.SK_TOKEN + <span class="string">&quot;-&quot;</span> + DateUtil.formatDate(date)+<span class="string">&quot;-&quot;</span>+trainCode+<span class="string">&quot;-&quot;</span>+memberId;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用缓存加速令牌锁功能</p>
</blockquote>
<ul>
<li>首先在SkTokenMapperCust增加一个参数，如果传5，就表示每取5次令牌，才更新一次数据库，减少对数据库的访问</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">decrease</span><span class="params">(Date date, String trainCode,<span class="type">int</span> decreaseCount)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>对应的mapper修改</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.fzx.train.business.mapper.cust.SkTokenMapperCust&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;decrease&quot;</span>&gt;</span></span><br><span class="line">    update sk_token</span><br><span class="line">    set `count` = if (`count` <span class="symbol">&amp;lt;</span> #&#123;decreaseCount&#125;, 0, `count` -  #&#123;decreaseCount&#125;)</span><br><span class="line">    where `date` = #&#123;date&#125;</span><br><span class="line">    and train_code = #&#123;trainCode&#125;</span><br><span class="line">    and `count` &gt; 0</span><br><span class="line">  <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改ConfirmOrderService的validSkToken方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取令牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">validSkToken</span><span class="params">(Date date,String trainCode,Long memberId)</span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;会员【&#123;&#125;】获取日期【&#123;&#125;】车次【&#123;&#125;】的令牌开始&quot;</span>,memberId,DateUtil.formatDate(date));</span><br><span class="line">        <span class="comment">//先获取令牌锁，再校验令牌余量，防止机器人抢票，LockKey就是令牌，用来表示【谁能做什么】的一个凭证</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisKeyPreEnum.SK_TOKEN + <span class="string">&quot;-&quot;</span> + DateUtil.formatDate(date)+<span class="string">&quot;-&quot;</span>+trainCode+<span class="string">&quot;-&quot;</span>+memberId;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">setIfAbsent</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(lockKey, lockKey, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (Boolean.TRUE.equals(setIfAbsent))&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;恭喜，抢到令牌锁了！lockKey：&#123;&#125;&quot;</span>,lockKey);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;很遗憾，没抢到令牌锁！lockKey：&#123;&#125;&quot;</span>,lockKey);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">skTokenCountKey</span> <span class="operator">=</span> RedisKeyPreEnum.SK_TOKEN + <span class="string">&quot;-&quot;</span> + DateUtil.formatDate(date)+<span class="string">&quot;-&quot;</span>+trainCode+<span class="string">&quot;-&quot;</span>+memberId;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">skTokenCount</span> <span class="operator">=</span> redisTemplate.opsForValue().get(skTokenCountKey);</span><br><span class="line">        <span class="keyword">if</span> (skTokenCount != <span class="literal">null</span>)&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;缓存中有该车次令牌大闸的key：&#123;&#125;&quot;</span>,skTokenCountKey);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> redisTemplate.opsForValue().decrement(skTokenCountKey, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (count &lt;<span class="number">0L</span>)&#123;</span><br><span class="line">                LOG.error(<span class="string">&quot;获取令牌失效：&#123;&#125;&quot;</span>,skTokenCountKey);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;获取令牌后，令牌余数：&#123;&#125;&quot;</span>,count);</span><br><span class="line">                redisTemplate.expire(skTokenCountKey,<span class="number">60</span>,TimeUnit.SECONDS);</span><br><span class="line">                <span class="comment">//每获取5个令牌更新一次数据库</span></span><br><span class="line">                <span class="keyword">if</span> (count % <span class="number">5</span> == <span class="number">0</span>)&#123;</span><br><span class="line">                    skTokenMapperCust.decrease(date,trainCode,<span class="number">5</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;缓存中没有该车次令牌大闸的key：&#123;&#125;&quot;</span>,skTokenCountKey);</span><br><span class="line">            <span class="comment">//检查是否还有令牌</span></span><br><span class="line">            <span class="type">SkTokenExample</span> <span class="variable">skTokenExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkTokenExample</span>();</span><br><span class="line">            skTokenExample.createCriteria().andDateEqualTo(date).andTrainCodeEqualTo(trainCode);</span><br><span class="line">            List&lt;SkToken&gt; tokenCountList = skTokenMapper.selectByExample(skTokenExample);</span><br><span class="line">            <span class="keyword">if</span> (CollUtil.isEmpty(tokenCountList))&#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;找不到日期【&#123;&#125;】车次【&#123;&#125;】的令牌记录&quot;</span>,DateUtil.formatDate(date),trainCode);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">SkToken</span> <span class="variable">skToken</span> <span class="operator">=</span> tokenCountList.get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (skToken.getCount() &lt;= <span class="number">0</span> )&#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;=日期【&#123;&#125;】车次【&#123;&#125;】的令牌余量为0&quot;</span>,DateUtil.formatDate(date),trainCode);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//令牌还有余量</span></span><br><span class="line">            <span class="comment">//令牌余量-1</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> skToken.getCount() - <span class="number">1</span>;</span><br><span class="line">            skToken.setCount(count);</span><br><span class="line">            LOG.info(<span class="string">&quot;将该车次令牌大闸放入缓存中，key:&#123;&#125;，count:&#123;&#125;&quot;</span>,skTokenCountKey,count);</span><br><span class="line">            redisTemplate.opsForValue().set(skTokenCountKey,String.valueOf(count),<span class="number">60</span>,TimeUnit.SECONDS);</span><br><span class="line">            skTokenMapper.updateByPrimaryKey(skToken);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//令牌约等于库存，令牌没有了，就不再卖票，不需要再进入购票主流程去判断库存，判断令牌肯定比判断库存效率高</span></span><br><span class="line"><span class="comment">//        int updateCount = skTokenMapperCust.decrease(date,trainCode,1);</span></span><br><span class="line"><span class="comment">//        if (updateCount &gt;0)&#123;</span></span><br><span class="line"><span class="comment">//            return true;</span></span><br><span class="line"><span class="comment">//        &#125;else&#123;</span></span><br><span class="line"><span class="comment">//            return false;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>常用缓存加数据库的方法来提高性能</li>
</ul>
<h2 id="增加验证码削弱瞬时高峰并防机器人刷票"><a href="#增加验证码削弱瞬时高峰并防机器人刷票" class="headerlink" title="增加验证码削弱瞬时高峰并防机器人刷票"></a>增加验证码削弱瞬时高峰并防机器人刷票</h2><blockquote>
<p>business增加图验证码接口</p>
</blockquote>
<ul>
<li>以下东西都是可以直接用的</li>
<li>首先根目录添加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--图形验证码，升级到JDK17后，排除掉javax.servlet-api包--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后给business模块添加</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在business的config添加三个文件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.impl.DefaultKaptcha;</span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.util.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DefaultKaptcha <span class="title function_">getDefaultKaptcha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultKaptcha</span> <span class="variable">defaultKaptcha</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultKaptcha</span>();</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.border&quot;</span>, <span class="string">&quot;no&quot;</span>);</span><br><span class="line"><span class="comment">//        properties.setProperty(&quot;kaptcha.border.color&quot;, &quot;105,179,90&quot;);</span></span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.color&quot;</span>, <span class="string">&quot;blue&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.width&quot;</span>, <span class="string">&quot;90&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.height&quot;</span>, <span class="string">&quot;28&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.size&quot;</span>, <span class="string">&quot;20&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.session.key&quot;</span>, <span class="string">&quot;code&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.length&quot;</span>, <span class="string">&quot;4&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.names&quot;</span>, <span class="string">&quot;Arial&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.noise.color&quot;</span>, <span class="string">&quot;255,96,0&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.noise.impl&quot;</span>, <span class="string">&quot;com.google.code.kaptcha.impl.NoNoise&quot;</span>);</span><br><span class="line"><span class="comment">//        properties.setProperty(&quot;kaptcha.obscurificator.impl&quot;, &quot;com.google.code.kaptcha.impl.WaterRipple&quot;);</span></span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.obscurificator.impl&quot;</span>, KaptchaWaterRipple.class.getName());</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.background.impl&quot;</span>, KaptchaNoBackhround.class.getName());</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>(properties);</span><br><span class="line">        defaultKaptcha.setConfig(config);</span><br><span class="line">        <span class="keyword">return</span> defaultKaptcha;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DefaultKaptcha <span class="title function_">getWebKaptcha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultKaptcha</span> <span class="variable">defaultKaptcha</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultKaptcha</span>();</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.border&quot;</span>, <span class="string">&quot;no&quot;</span>);</span><br><span class="line"><span class="comment">//        properties.setProperty(&quot;kaptcha.border.color&quot;, &quot;105,179,90&quot;);</span></span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.color&quot;</span>, <span class="string">&quot;blue&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.width&quot;</span>, <span class="string">&quot;90&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.height&quot;</span>, <span class="string">&quot;45&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.size&quot;</span>, <span class="string">&quot;30&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.session.key&quot;</span>, <span class="string">&quot;code&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.length&quot;</span>, <span class="string">&quot;4&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.names&quot;</span>, <span class="string">&quot;Arial&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.noise.impl&quot;</span>, <span class="string">&quot;com.google.code.kaptcha.impl.NoNoise&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.obscurificator.impl&quot;</span>, KaptchaWaterRipple.class.getName());</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>(properties);</span><br><span class="line">        defaultKaptcha.setConfig(config);</span><br><span class="line">        <span class="keyword">return</span> defaultKaptcha;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.BackgroundProducer;</span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.util.Configurable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.geom.Rectangle2D;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaNoBackhround</span> <span class="keyword">extends</span> <span class="title class_">Configurable</span> <span class="keyword">implements</span> <span class="title class_">BackgroundProducer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaNoBackhround</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BufferedImage <span class="title function_">addBackground</span><span class="params">(BufferedImage baseImage)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> baseImage.getWidth();</span><br><span class="line">        <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> baseImage.getHeight();</span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">imageWithBackground</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(width, height, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Graphics2D</span> <span class="variable">graph</span> <span class="operator">=</span> (Graphics2D)imageWithBackground.getGraphics();</span><br><span class="line">        graph.fill(<span class="keyword">new</span> <span class="title class_">Rectangle2D</span>.Double(<span class="number">0.0D</span>, <span class="number">0.0D</span>, (<span class="type">double</span>)width, (<span class="type">double</span>)height));</span><br><span class="line">        graph.drawImage(baseImage, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> imageWithBackground;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.GimpyEngine;</span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.NoiseProducer;</span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.util.Configurable;</span><br><span class="line"><span class="keyword">import</span> com.jhlabs.image.RippleFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.ImageObserver;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaWaterRipple</span> <span class="keyword">extends</span> <span class="title class_">Configurable</span> <span class="keyword">implements</span> <span class="title class_">GimpyEngine</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">KaptchaWaterRipple</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> BufferedImage <span class="title function_">getDistortedImage</span><span class="params">(BufferedImage baseImage)</span> &#123;</span><br><span class="line">      <span class="type">NoiseProducer</span> <span class="variable">noiseProducer</span> <span class="operator">=</span> <span class="built_in">this</span>.getConfig().getNoiseImpl();</span><br><span class="line">      <span class="type">BufferedImage</span> <span class="variable">distortedImage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(baseImage.getWidth(), baseImage.getHeight(), <span class="number">2</span>);</span><br><span class="line">      <span class="type">Graphics2D</span> <span class="variable">graph</span> <span class="operator">=</span> (Graphics2D)distortedImage.getGraphics();</span><br><span class="line">      <span class="type">Random</span> <span class="variable">rand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">      <span class="type">RippleFilter</span> <span class="variable">rippleFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RippleFilter</span>();</span><br><span class="line">      rippleFilter.setXAmplitude(<span class="number">7.6F</span>);</span><br><span class="line">      rippleFilter.setYAmplitude(rand.nextFloat() + <span class="number">1.0F</span>);</span><br><span class="line">      rippleFilter.setEdgeAction(<span class="number">1</span>);</span><br><span class="line">      <span class="type">BufferedImage</span> <span class="variable">effectImage</span> <span class="operator">=</span> rippleFilter.filter(baseImage, (BufferedImage)<span class="literal">null</span>);</span><br><span class="line">      graph.drawImage(effectImage, <span class="number">0</span>, <span class="number">0</span>, (Color)<span class="literal">null</span>, (ImageObserver)<span class="literal">null</span>);</span><br><span class="line">      graph.dispose();</span><br><span class="line">      noiseProducer.makeNoise(distortedImage, <span class="number">0.1F</span>, <span class="number">0.1F</span>, <span class="number">0.25F</span>, <span class="number">0.25F</span>);</span><br><span class="line">      noiseProducer.makeNoise(distortedImage, <span class="number">0.1F</span>, <span class="number">0.25F</span>, <span class="number">0.5F</span>, <span class="number">0.9F</span>);</span><br><span class="line">      <span class="keyword">return</span> distortedImage;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>同时在controller添加，里面方法的参数是前端生成唯一的token，每次都不能一样，用于贯穿验证码的生成和校验流程</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.impl.DefaultKaptcha;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/kaptcha&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Qualifier(&quot;getDefaultKaptcha&quot;)</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DefaultKaptcha defaultKaptcha;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">public</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/image-code/&#123;imageCodeToken&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">imageCode</span><span class="params">(<span class="meta">@PathVariable(value = &quot;imageCodeToken&quot;)</span> String imageCodeToken, HttpServletResponse httpServletResponse)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">jpegOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 生成验证码字符串</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">createText</span> <span class="operator">=</span> defaultKaptcha.createText();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将生成的验证码放入redis缓存中，后续验证的时候用到</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(imageCodeToken, createText, <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用验证码字符串生成验证码图片</span></span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">challenge</span> <span class="operator">=</span> defaultKaptcha.createImage(createText);</span><br><span class="line">            ImageIO.write(challenge, <span class="string">&quot;jpg&quot;</span>, jpegOutputStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            httpServletResponse.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义response输出类型为image/jpeg类型，使用response输出流输出图片的byte数组</span></span><br><span class="line">        <span class="type">byte</span>[] captchaChallengeAsJpeg = jpegOutputStream.toByteArray();</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-store&quot;</span>);</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">&quot;Pragma&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">        httpServletResponse.setDateHeader(<span class="string">&quot;Expires&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">responseOutputStream</span> <span class="operator">=</span> httpServletResponse.getOutputStream();</span><br><span class="line">        responseOutputStream.write(captchaChallengeAsJpeg);</span><br><span class="line">        responseOutputStream.flush();</span><br><span class="line">        responseOutputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在把gateway的LoginMemberFilter中添加 <strong>排除不需要拦截的请求</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|| path.contains(<span class="string">&quot;/business/kaptcha&quot;</span>))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>购票页面，调用购票接口之前，显示验证码</p>
</blockquote>
<ul>
<li><p>全部修改order.vue</p>
</li>
<li><p>首先在请核对以下信息下ok方法修改为</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-modal v-model:visible=&quot;visible&quot; title=&quot;请核对以下信息&quot;</span><br><span class="line">         style=&quot;top: 50px; width: 800px&quot;</span><br><span class="line">         ok-text=&quot;确认&quot; cancel-text=&quot;取消&quot;</span><br><span class="line">         @ok=&quot;showImageCodeModal&quot;&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们增加一个验证码模态框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 第二层验证码 后端 --&gt;</span><br><span class="line">&lt;a-modal v-model:visible=&quot;imageCodeModalVisible&quot; :title=&quot;null&quot; :footer=&quot;null&quot; :closable=&quot;false&quot;</span><br><span class="line">         style=&quot;top: 50px; width: 400px&quot;&gt;</span><br><span class="line">  &lt;p style=&quot;text-align: center; font-weight: bold; font-size: 18px&quot;&gt;</span><br><span class="line">    使用服务端验证码削弱瞬时高峰&lt;br/&gt;</span><br><span class="line">    防止机器人刷票</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line">  &lt;p&gt;</span><br><span class="line">    &lt;a-input v-model:value=&quot;imageCode&quot; placeholder=&quot;图片验证码&quot;&gt;</span><br><span class="line">      &lt;template #suffix&gt;</span><br><span class="line">        &lt;img v-show=&quot;!!imageCodeSrc&quot; :src=&quot;imageCodeSrc&quot; alt=&quot;验证码&quot; v-on:click=&quot;loadImageCode()&quot;/&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/a-input&gt;</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line">  &lt;a-button type=&quot;danger&quot; block @click=&quot;handleOk&quot;&gt;输入验证码后开始购票&lt;/a-button&gt;</span><br><span class="line">&lt;/a-modal&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>在handleOk添加一个简单校验</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title class_">Tool</span>.<span class="title function_">isEmpty</span>(imageCode.<span class="property">value</span>)) &#123;</span><br><span class="line">  notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>: <span class="string">&#x27;验证码不能为空&#x27;</span>&#125;);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加验证码的一些方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ------------------- 第二层验证码 --------------------- */</span></span><br><span class="line"><span class="keyword">const</span> imageCodeModalVisible = <span class="title function_">ref</span>();</span><br><span class="line"><span class="keyword">const</span> imageCodeToken = <span class="title function_">ref</span>();</span><br><span class="line"><span class="keyword">const</span> imageCodeSrc = <span class="title function_">ref</span>();</span><br><span class="line"><span class="keyword">const</span> imageCode = <span class="title function_">ref</span>();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载图形验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadImageCode</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  imageCodeToken.<span class="property">value</span> = <span class="title class_">Tool</span>.<span class="title function_">uuid</span>(<span class="number">8</span>);</span><br><span class="line">  imageCodeSrc.<span class="property">value</span> = process.<span class="property">env</span>.<span class="property">VUE_APP_SERVER</span> + <span class="string">&#x27;/business/kaptcha/image-code/&#x27;</span> + imageCodeToken.<span class="property">value</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">showImageCodeModal</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">loadImageCode</span>();</span><br><span class="line">  imageCodeModalVisible.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>将下面的值return回去</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">imageCodeToken,</span><br><span class="line">imageCodeSrc,</span><br><span class="line">imageCode,</span><br><span class="line">showImageCodeModal,</span><br><span class="line">imageCodeModalVisible,</span><br><span class="line">loadImageCode</span><br></pre></td></tr></table></figure>

<blockquote>
<p>购票接口，增加验证码校验</p>
</blockquote>
<ul>
<li>首先修改order.vue，在handleOk的post请求中添加验证码参数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imageCodeToken</span>:imageCodeToken.<span class="property">value</span>,</span><br><span class="line"><span class="attr">imageCode</span>:imageCode.<span class="property">value</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们给ConfirmOrderDoReq同样得添加验证码参数得字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NotBlank(message = &quot;【图片验证码】不能为空&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String imageCode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *图片验证码token</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NotBlank(message = &quot;【图片验证码】参数非法&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String imageCodeToken;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后在ConfirmOrderController得doConfirm方法中增加验证码校验</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Resource</span></span><br><span class="line"> <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">//图形验证码校验</span></span><br><span class="line"><span class="type">String</span> <span class="variable">imageCodeToken</span> <span class="operator">=</span> req.getImageCodeToken();</span><br><span class="line"><span class="type">String</span> <span class="variable">imageCode</span> <span class="operator">=</span> req.getImageCode();</span><br><span class="line"><span class="type">String</span> <span class="variable">imageCodeRedis</span> <span class="operator">=</span> redisTemplate.opsForValue().get(imageCodeToken);</span><br><span class="line">LOG.info(<span class="string">&quot;从redis中获取的验证码：&#123;&#125;&quot;</span>,imageCodeRedis);</span><br><span class="line"><span class="keyword">if</span> (ObjectUtils.isEmpty(imageCodeRedis))&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(<span class="literal">false</span>,<span class="string">&quot;验证码已过期&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//验证码校验，大小写忽略，提升体验，比如0o Vv Ww容易混</span></span><br><span class="line"><span class="keyword">if</span> (!imageCodeRedis.equalsIgnoreCase(imageCode))&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(<span class="literal">false</span>,<span class="string">&quot;验证码不正确&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    redisTemplate.delete(imageCodeToken);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="增加第一层验证码削弱瞬时高峰"><a href="#增加第一层验证码削弱瞬时高峰" class="headerlink" title="增加第一层验证码削弱瞬时高峰"></a>增加第一层验证码削弱瞬时高峰</h2><blockquote>
<p>因为当1000人购票点击提交时会出现验证码，就要访问1000次验证码接口，因此增加第一层验证码削弱瞬时高峰，减小第二层验证码接口的压力（就是在增加一层验证码）</p>
</blockquote>
<ul>
<li>纯前端就修改order.vue</li>
<li>首先修改请核对以下信息得确定按钮触发得方法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-modal v-model:visible=&quot;visible&quot; title=&quot;请核对以下信息&quot;</span><br><span class="line">         style=&quot;top: 50px; width: 800px&quot;</span><br><span class="line">         ok-text=&quot;确认&quot; cancel-text=&quot;取消&quot;</span><br><span class="line">         @ok=&quot;showFirstImageCodeModal&quot;&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后增加第一层验证码得模态框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 第一层验证码 纯前端 --&gt;</span><br><span class="line">&lt;a-modal v-model:visible=&quot;firstImageCodeModalVisible&quot; :title=&quot;null&quot; :footer=&quot;null&quot; :closable=&quot;false&quot;</span><br><span class="line">         style=&quot;top: 50px; width: 400px&quot;&gt;</span><br><span class="line">  &lt;p style=&quot;text-align: center; font-weight: bold; font-size: 18px&quot;&gt;</span><br><span class="line">    使用纯前端验证码削弱瞬时高峰&lt;br/&gt;</span><br><span class="line">    减小后端验证码接口的压力</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line">  &lt;p&gt;</span><br><span class="line">    &lt;a-input v-model:value=&quot;firstImageCodeTarget&quot; placeholder=&quot;验证码&quot;&gt;</span><br><span class="line">      &lt;template #suffix&gt;</span><br><span class="line">        &#123;&#123;firstImageCodeSourceA&#125;&#125; + &#123;&#123;firstImageCodeSourceB&#125;&#125;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/a-input&gt;</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line">  &lt;a-button type=&quot;danger&quot; block @click=&quot;validFirstImageCode&quot;&gt;提交验证码&lt;/a-button&gt;</span><br><span class="line">&lt;/a-modal&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后增加第一次验证码的加载显示校验方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ------------------- 第一层验证码 --------------------- */</span></span><br><span class="line"><span class="keyword">const</span> firstImageCodeSourceA = <span class="title function_">ref</span>();</span><br><span class="line"><span class="keyword">const</span> firstImageCodeSourceB = <span class="title function_">ref</span>();</span><br><span class="line"><span class="keyword">const</span> firstImageCodeTarget = <span class="title function_">ref</span>();</span><br><span class="line"><span class="keyword">const</span> firstImageCodeModalVisible = <span class="title function_">ref</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载第一层验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadFirstImageCode</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 获取1~10的数：Math.floor(Math.random()*10 + 1)</span></span><br><span class="line">  firstImageCodeSourceA.<span class="property">value</span> = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">10</span> + <span class="number">1</span>) + <span class="number">10</span>;</span><br><span class="line">  firstImageCodeSourceB.<span class="property">value</span> = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">10</span> + <span class="number">1</span>) + <span class="number">20</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 显示第一层验证码弹出框</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">showFirstImageCodeModal</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">loadFirstImageCode</span>();</span><br><span class="line">  firstImageCodeModalVisible.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 校验第一层验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">validFirstImageCode</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">parseInt</span>(firstImageCodeTarget.<span class="property">value</span>) === <span class="built_in">parseInt</span>(firstImageCodeSourceA.<span class="property">value</span> + firstImageCodeSourceB.<span class="property">value</span>)) &#123;</span><br><span class="line">    <span class="comment">// 第一层验证通过</span></span><br><span class="line">    firstImageCodeModalVisible.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="title function_">showImageCodeModal</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>: <span class="string">&#x27;验证码错误&#x27;</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后return返回这些方法和定义值</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">firstImageCodeSourceA,</span><br><span class="line">firstImageCodeSourceB,</span><br><span class="line">firstImageCodeTarget,</span><br><span class="line">firstImageCodeModalVisible,</span><br><span class="line">showFirstImageCodeModal,</span><br><span class="line">validFirstImageCode,</span><br></pre></td></tr></table></figure>

<h1 id="利用流行的MQ组件对请求做削峰处理，解决吞吐量问题（实现最短时间内给用户反馈）"><a href="#利用流行的MQ组件对请求做削峰处理，解决吞吐量问题（实现最短时间内给用户反馈）" class="headerlink" title="利用流行的MQ组件对请求做削峰处理，解决吞吐量问题（实现最短时间内给用户反馈）"></a>利用流行的MQ组件对请求做削峰处理，解决吞吐量问题（实现最短时间内给用户反馈）</h1><p>在高并发中，除了解决超卖问题，还要解决吞吐量问题，本章主要利用MQ对请求做削峰处理，并引入引入排队机制，在最短的时间内，给用户以反馈。</p>
<hr>
<ul>
<li>RocketMQ基本介绍</li>
<li>使用MQ，将购票流程一分为二</li>
<li>增加排队购票功能</li>
</ul>
<h2 id="购票时序图演进"><a href="#购票时序图演进" class="headerlink" title="购票时序图演进"></a>购票时序图演进</h2><ul>
<li>最开始的购票流程</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202308020920162.png"
                      alt="image-20230802092020889"
                ></p>
<ul>
<li>纠正下，这里要分成两步，拿令牌锁要放在同步里，拿车次锁要放在异步里</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202308020922718.png"
                      alt="image-20230802092243623" style="zoom:50%;" 
                >

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202308020923470.png"
                      alt="image-20230802092316922"
                ></p>
<ul>
<li>使用MQ的流程</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202308020924257.png"
                      alt="image-20230802092358281" style="zoom:50%;" 
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202308020924777.png"
                      alt="image-20230802092435505" style="zoom:50%;" 
                >

<h2 id="初始RocketMQ"><a href="#初始RocketMQ" class="headerlink" title="初始RocketMQ"></a>初始RocketMQ</h2><ul>
<li>介绍文档：<a class="link"   target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/4.x/" >Why choose RocketMQ | RocketMQ (apache.org)<i class="fas fa-external-link-alt"></i></a>  <a class="link"   target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-dashboard/blob/master/docs/1_0_0/UserGuide_CN.md" >rocketmq-dashboard&#x2F;docs&#x2F;1_0_0&#x2F;UserGuide_CN.md at master · apache&#x2F;rocketmq-dashboard · GitHub<i class="fas fa-external-link-alt"></i></a></li>
<li>然后再下载一个控台：<a class="link"   target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-dashboard/tree/master" >GitHub - apache&#x2F;rocketmq-dashboard: The state-of-the-art Dashboard of Apache RoccketMQ provides excellent monitoring capability. Various graphs and statistics of events, performance and system information of clients and application is evidently made available to the user.<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<h2 id="RocketMQ初体验"><a href="#RocketMQ初体验" class="headerlink" title="RocketMQ初体验"></a>RocketMQ初体验</h2><ul>
<li>下载完RocketMQ压缩包，这里先修改下他bin下面的runbroker.cmd里面的配置，内存用256m就够了</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> &quot;JAVA_OPT=<span class="variable">%JAVA_OPT%</span> -server -Xms256m -Xmx256m&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>但是现在启动会报错，我们还需要再cmd中设置一个参数，就可以启动NameServer了</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202308020954224.png"
                      alt="image-20230802095422810"
                ></p>
<ul>
<li>接下来启动Broker</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\mqbroker -n <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">9876</span></span><br></pre></td></tr></table></figure>

<h2 id="RocketMQ控制台的使用"><a href="#RocketMQ控制台的使用" class="headerlink" title="RocketMQ控制台的使用"></a>RocketMQ控制台的使用</h2><ul>
<li>他这个控台就相当于是一个maven项目，用IDEA打开，然后修改服务的端口为18080，接着就在APP那里启动，但是启动前需要加一个JVM参数，就可以启动了</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Drocketmq.namesrv.addr=<span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">9876</span></span><br></pre></td></tr></table></figure>

<h2 id="使用RocketMQ将购票流程一分为二"><a href="#使用RocketMQ将购票流程一分为二" class="headerlink" title="使用RocketMQ将购票流程一分为二"></a>使用RocketMQ将购票流程一分为二</h2><blockquote>
<p>下单购票接口，只处理验证码、令牌、车次锁，不执行选座购票逻辑</p>
</blockquote>
<ul>
<li>我们看ConfirmOrderService里的doConfirm方法，不仅包括校验令牌还包括分布式锁，还包括购票，当我们拿到分布式锁的时候就代表乘客具有购票功能了。再这里我们把购票之前所作的事情单独提出来成一个类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.annotation.SentinelResource;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.enums.RedisKeyPreEnum;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.ConfirmOrderDoReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.context.LoginMemberContext;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.exception.BusinessExceptionEnum;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeforeConfirmOrderService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(BeforeConfirmOrderService.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SkTokenService skTokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;beforeDoConfirm&quot;,blockHandler = &quot;beforeDoConfirmBlock&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeDoConfirm</span><span class="params">(ConfirmOrderDoReq req)</span>&#123;</span><br><span class="line">        <span class="comment">//校验令牌余量</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">validSkToken</span> <span class="operator">=</span> skTokenService.validSkToken(req.getDate(),req.getTrainCode(), LoginMemberContext.getId());</span><br><span class="line">        <span class="keyword">if</span> (validSkToken)&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;令牌校验通过&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;令牌校验不通过&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_SK_TOKEN_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisKeyPreEnum.CONFIRM_ORDER + <span class="string">&quot;-&quot;</span> + DateUtil.formatDate(req.getDate()) + <span class="string">&quot;-&quot;</span> + req.getTrainCode();</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">setIfAbsent</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(lockKey, lockKey, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (setIfAbsent)&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;恭喜抢到锁了&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//只是没抢到锁，并不知道票抢完了没，所以提示稍后再试</span></span><br><span class="line">            LOG.info(<span class="string">&quot;很遗憾，没抢到票&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_LOCK_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送MQ排队购票</span></span><br><span class="line">        LOG.info(<span class="string">&quot;排队购票，发送mq开始&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 降级方法。需包括限流方法的所有参数和BlockException参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeDoConfirmBlock</span><span class="params">(ConfirmOrderDoReq req, BlockException e)</span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;购票请求被限流：&#123;&#125;&quot;</span>,req);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_FLOW_EXCEPTION);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们的ConfirmOrderController的doConfirm直接调用该类的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beforeConfirmOrderService.beforeDoConfirm(req);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>实现RocketMQ发送，spring.factories功能在Spring Boot3.0被移除，替代方案为META-INFO&#x2F;spring&#x2F;org.springframework.boot.autoconfigure.AutoConfiguration.imports</p>
</blockquote>
<ul>
<li>首先在根目录引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后再需要使用MQ的模块也添加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>接下来在application.properties中配置MQ</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#rocketmq</span></span><br><span class="line"><span class="attr">rocketmq.name-server</span>=<span class="string">http://localhost:9876</span></span><br><span class="line"><span class="attr">rocketmq.producer.group</span>=<span class="string">default</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们定义一个主题枚举</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">RocketMQTopicEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    CONFIRM_ORDER(<span class="string">&quot;CONFIRM_ORDER&quot;</span>, <span class="string">&quot;确认订单排队&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    RocketMQTopicEnum(String code, String desc) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;RocketMQTopicEnum&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;code=&#x27;&quot;</span> + code + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, desc=&#x27;&quot;</span> + desc + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;&#125; &quot;</span> + <span class="built_in">super</span>.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDesc</span><span class="params">(String desc)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来就在BeforeConfirmOrderService的beforeDoConfirm方法中使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送MQ排队购票</span></span><br><span class="line"><span class="type">String</span> <span class="variable">reqJson</span> <span class="operator">=</span> JSON.toJSONString(req);</span><br><span class="line">LOG.info(<span class="string">&quot;排队购票，发送mq开始,消息：&#123;&#125;&quot;</span>,reqJson);</span><br><span class="line">rocketMQTemplate.convertAndSend(RocketMQTopicEnum.CONFIRM_ORDER.getCode(),reqJson);</span><br><span class="line">LOG.info(<span class="string">&quot;排队购票，发送mq结束&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>但是这里有一个问题就是SpringBoot3注入RocketMQTemplaget失败，这时候就需要创建business的src&#x2F;main&#x2F;resources&#x2F;META-INF&#x2F;spring&#x2F;org.springframework.boot.autoconfigure.AutoConfiguration.imports，内容是</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.apache.rocketmq.spring.autoconfigure.RocketMQAutoConfiguration</span></span><br></pre></td></tr></table></figure>

<ul>
<li>记得上面重写文件类型是spring factories</li>
</ul>
<blockquote>
<p>实现RocketMQ接收</p>
</blockquote>
<ul>
<li>就是创建一个类，也不用被调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.core.RocketMQListener;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener(consumerGroup = &quot;default&quot;,topic =&quot;CONFIRM_ORDER&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmOrderConsumer</span> <span class="keyword">implements</span> <span class="title class_">RocketMQListener</span>&lt;MessageExt&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(ConfirmOrderConsumer.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(MessageExt messageExt)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] body = messageExt.getBody();</span><br><span class="line">        LOG.info(<span class="string">&quot;ROCKETMQ接收消息：&#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="完成MQ消费里的购票功能"><a href="#完成MQ消费里的购票功能" class="headerlink" title="完成MQ消费里的购票功能"></a>完成MQ消费里的购票功能</h2><ul>
<li>上面只是完成了MQ消息的接收，并没有实际购票，因此需要在ConfirmOrderConsumer中引入购票方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ConfirmOrderDoReq</span> <span class="variable">req</span> <span class="operator">=</span> JSON.parseObject(<span class="keyword">new</span> <span class="title class_">String</span>(body), ConfirmOrderDoReq.class);</span><br><span class="line">confirmOrderService.doConfirm(req);</span><br></pre></td></tr></table></figure>

<ul>
<li>车次锁应该跟购票放一起，所以需要把BeforeConfirmOrderService的车次锁重新放到ConfirmOrderService中</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取分布式锁</span></span><br><span class="line"><span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisKeyPreEnum.CONFIRM_ORDER + <span class="string">&quot;-&quot;</span> +DateUtil.formatDate(req.getDate()) + <span class="string">&quot;-&quot;</span> + req.getTrainCode();</span><br><span class="line"><span class="type">Boolean</span> <span class="variable">setIfAbsent</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(lockKey, lockKey, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="keyword">if</span> (setIfAbsent)&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;恭喜抢到锁了&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//只是没抢到锁，并不知道票抢完了没，所以提示稍后再试</span></span><br><span class="line">    LOG.info(<span class="string">&quot;很遗憾，没抢到票&quot;</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_LOCK_FAIL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>因为请求进来后，先保存订单信息，再发MQ等待出票，所以将ConfirmOrderService的确认订单表部分放到BeforeConfirmOrderService中</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> req.getDate();</span><br><span class="line">LOG.info(<span class="string">&quot;date&#123;&#125;&quot;</span>, date);</span><br><span class="line"><span class="type">String</span> <span class="variable">trainCode</span> <span class="operator">=</span> req.getTrainCode();</span><br><span class="line"><span class="type">String</span> <span class="variable">start</span> <span class="operator">=</span> req.getStart();</span><br><span class="line"><span class="type">String</span> <span class="variable">end</span> <span class="operator">=</span> req.getEnd();</span><br><span class="line">List&lt;ConfirmOrderTicketReq&gt; tickets = req.getTickets();</span><br><span class="line"></span><br><span class="line"><span class="comment">//保存确认订单表，状态初始</span></span><br><span class="line"><span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now();</span><br><span class="line"><span class="type">ConfirmOrder</span> <span class="variable">confirmOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmOrder</span>();</span><br><span class="line">confirmOrder.setId(SnowUtil.getSnowflakeNextId());</span><br><span class="line">confirmOrder.setCreateTime(now);</span><br><span class="line">confirmOrder.setUpdateTime(now);</span><br><span class="line">confirmOrder.setMemberId(req.getMemberId());</span><br><span class="line">confirmOrder.setDate(date);</span><br><span class="line">confirmOrder.setTrainCode(trainCode);</span><br><span class="line">confirmOrder.setStart(start);</span><br><span class="line">confirmOrder.setEnd(end);</span><br><span class="line">confirmOrder.setDailyTrainTicketId(req.getDailyTrainTicketId());</span><br><span class="line">confirmOrder.setStatus(ConfirmOrderStatusEnum.INIT.getCode());</span><br><span class="line">confirmOrder.setTickets(JSON.toJSONString(tickets));</span><br><span class="line">confirmOrderMapper.insert(confirmOrder);</span><br></pre></td></tr></table></figure>

<ul>
<li>因为LoginMemberContext必须通过访问接口才会被MemberInterceptor拦截到，而MQ消费并没有访问接口，所以这里需要在BeforeConfirmOrderService中的beforeDoConfirm方法先将LoginMemberContext的id设置进去</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req.setMemberId(LoginMemberContext.getId());</span><br></pre></td></tr></table></figure>

<ul>
<li>AfterConfirmOrderService中也需要修改下，不能直接通过LoginMemberContext.getId()获取</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memberTicketReq.setMemberId(confirmOrder.getMemberId());</span><br></pre></td></tr></table></figure>

<ul>
<li>因为我们把ConfirmOrderService的确认订单表部分放到BeforeConfirmOrderService中了，导致，需要传给afterConfirmOrderService.afterDoConfirm(dailyTrainTicket, finalSeatList, tickets, confirmOrder);的confirmOrder没有了，就需要重新在数据库查，因此添加一个数据库查询</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从数据库里查出订单</span></span><br><span class="line"><span class="type">ConfirmOrderExample</span> <span class="variable">confirmOrderExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmOrderExample</span>();</span><br><span class="line">confirmOrderExample.setOrderByClause(<span class="string">&quot;id asc&quot;</span>);</span><br><span class="line">ConfirmOrderExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> confirmOrderExample.createCriteria();</span><br><span class="line">criteria.andDateEqualTo(req.getDate())</span><br><span class="line">        .andTrainCodeEqualTo(req.getTrainCode())</span><br><span class="line">        .andMemberIdEqualTo(req.getMemberId())</span><br><span class="line">        .andStatusEqualTo(ConfirmOrderStatusEnum.INIT.getCode());</span><br><span class="line">List&lt;ConfirmOrder&gt; list = confirmOrderMapper.selectByExampleWithBLOBs(confirmOrderExample);</span><br><span class="line">ConfirmOrder confirmOrder;</span><br><span class="line"><span class="keyword">if</span> (CollUtil.isEmpty(list))&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;找不到原始订单，结束&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;本次处理&#123;&#125;条确认订单&quot;</span>,list.size());</span><br><span class="line">     confirmOrder = list.get(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="为同转异增加logId，方便日志跟踪"><a href="#为同转异增加logId，方便日志跟踪" class="headerlink" title="为同转异增加logId，方便日志跟踪"></a>为同转异增加logId，方便日志跟踪</h2><ul>
<li>现在有个小问题就是MQ日志是没有日志跟踪号的，因为日志跟踪号是在拦截器里</li>
<li>首先在ConfirmOrderDoReq中添加一个字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 日志跟踪号</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String logId;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再BeforeConfirmOrderService的发送MQ排队购票处将logId设置进去</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req.setLogId(MDC.get(<span class="string">&quot;LOG_ID&quot;</span>));</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就可以再ConfirmOrderConsumer中将日志号设置进去了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MDC.put(<span class="string">&quot;LOG_ID&quot;</span>,req.getLogId());</span><br><span class="line">LOG.info(<span class="string">&quot;ROCKETMQ接收消息：&#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br></pre></td></tr></table></figure>

<h2 id="增加排队功能思路讲解"><a href="#增加排队功能思路讲解" class="headerlink" title="增加排队功能思路讲解"></a>增加排队功能思路讲解</h2><ul>
<li>经过上面的改进我们目前的程序图如图所示：</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202308021430859.png"
                      alt="image-20230802143045792" style="zoom:50%;" 
                >

<ul>
<li>也有一种可能就是我拿到了令牌但是买票失败了，就把我令牌取消了。这里应该是我拿到了令牌就有购票资格了，就算多等会也没事，因此这里增加排队功能</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202308021434691.png"
                      alt="image-20230802143355042" style="zoom:50%;" 
                >

<ul>
<li>一个消费者拿到了某个车次锁，则该车次下所有的票都由他来出，一张一张出，直到所有的订单都出完。这里把上图的循环出票缩小到选座购票处</li>
</ul>
<h2 id="完成排队出票功能"><a href="#完成排队出票功能" class="headerlink" title="完成排队出票功能"></a>完成排队出票功能</h2><blockquote>
<p>修改MQ消息内容，只需要通知出哪个车次的票（即：组成锁的内容），不需要具体到哪个人</p>
</blockquote>
<ul>
<li>首先定义一个消息体</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmOrderMQDto</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 日志流程号，用于同转异时，用同一个流水号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String logId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 车次编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String trainCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLogId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> logId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogId</span><span class="params">(String logId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.logId = logId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDate</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrainCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrainCode</span><span class="params">(String trainCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trainCode = trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;ConfirmOrderMQDto&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;logId=&quot;</span>).append(logId);</span><br><span class="line">        sb.append(<span class="string">&quot;, date=&quot;</span>).append(date);</span><br><span class="line">        sb.append(<span class="string">&quot;, trainCode=&#x27;&quot;</span>).append(trainCode).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第二步就是修改beforeDoConfirm传消息的部分，使用我们设置的简化的消息体</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//发送MQ排队购票</span></span><br><span class="line"><span class="type">ConfirmOrderMQDto</span> <span class="variable">confirmOrderMQDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmOrderMQDto</span>();</span><br><span class="line">confirmOrderMQDto.setDate(req.getDate());</span><br><span class="line">confirmOrderMQDto.setTrainCode(req.getTrainCode());</span><br><span class="line">confirmOrderMQDto.setLogId(MDC.get(<span class="string">&quot;LOG_ID&quot;</span>));</span><br><span class="line"><span class="type">String</span> <span class="variable">reqJson</span> <span class="operator">=</span> JSON.toJSONString(confirmOrderMQDto);</span><br><span class="line">LOG.info(<span class="string">&quot;排队购票，发送mq开始,消息：&#123;&#125;&quot;</span>,reqJson);</span><br><span class="line">rocketMQTemplate.convertAndSend(RocketMQTopicEnum.CONFIRM_ORDER.getCode(),reqJson);</span><br><span class="line">LOG.info(<span class="string">&quot;排队购票，发送mq结束&quot;</span>);</span><br><span class="line">confirmOrderService.doConfirm(confirmOrderMQDto);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>出票功能改为循环排队出票，按车次（锁）来循环出票</p>
</blockquote>
<ul>
<li>由于上面是请求体传过来的，因此消费也需要消费请求体</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ConfirmOrderMQDto</span> <span class="variable">dto</span> <span class="operator">=</span> JSON.parseObject(<span class="keyword">new</span> <span class="title class_">String</span>(body), ConfirmOrderMQDto.class);</span><br><span class="line">MDC.put(<span class="string">&quot;LOG_ID&quot;</span>,dto.getLogId());</span><br><span class="line">LOG.info(<span class="string">&quot;ROCKETMQ接收消息：&#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">confirmOrderService.doConfirm(dto);</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们把ConfirmOrderService中购票部分提取成一个方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 售票</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> confirmOrder</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sell</span><span class="params">(ConfirmOrder confirmOrder)</span> &#123;</span><br><span class="line">    <span class="comment">// 构造ConfirmOrderDoReq</span></span><br><span class="line">    <span class="type">ConfirmOrderDoReq</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmOrderDoReq</span>();</span><br><span class="line">    req.setMemberId(confirmOrder.getMemberId());</span><br><span class="line">    req.setDate(confirmOrder.getDate());</span><br><span class="line">    req.setTrainCode(confirmOrder.getTrainCode());</span><br><span class="line">    req.setStart(confirmOrder.getStart());</span><br><span class="line">    req.setEnd(confirmOrder.getEnd());</span><br><span class="line">    req.setDailyTrainTicketId(confirmOrder.getDailyTrainTicketId());</span><br><span class="line">    req.setTickets(JSON.parseArray(confirmOrder.getTickets(), ConfirmOrderTicketReq.class));</span><br><span class="line">    req.setImageCode(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    req.setImageCodeToken(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    req.setLogId(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略业务数据校验，如：车次是否存在，余票是否存在，车次是否在有效期内，tickets条数&gt;0，同乘客同车次是否已买过</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> req.getDate();</span><br><span class="line">    <span class="type">String</span> <span class="variable">trainCode</span> <span class="operator">=</span> req.getTrainCode();</span><br><span class="line">    <span class="type">String</span> <span class="variable">start</span> <span class="operator">=</span> req.getStart();</span><br><span class="line">    <span class="type">String</span> <span class="variable">end</span> <span class="operator">=</span> req.getEnd();</span><br><span class="line">    List&lt;ConfirmOrderTicketReq&gt; tickets = req.getTickets();</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// // 保存确认订单表，状态初始</span></span><br><span class="line">    <span class="comment">// DateTime now = DateTime.now();</span></span><br><span class="line">    <span class="comment">// ConfirmOrder confirmOrder = new ConfirmOrder();</span></span><br><span class="line">    <span class="comment">// confirmOrder.setId(SnowUtil.getSnowflakeNextId());</span></span><br><span class="line">    <span class="comment">// confirmOrder.setCreateTime(now);</span></span><br><span class="line">    <span class="comment">// confirmOrder.setUpdateTime(now);</span></span><br><span class="line">    <span class="comment">// confirmOrder.setMemberId(req.getMemberId());</span></span><br><span class="line">    <span class="comment">// confirmOrder.setDate(date);</span></span><br><span class="line">    <span class="comment">// confirmOrder.setTrainCode(trainCode);</span></span><br><span class="line">    <span class="comment">// confirmOrder.setStart(start);</span></span><br><span class="line">    <span class="comment">// confirmOrder.setEnd(end);</span></span><br><span class="line">    <span class="comment">// confirmOrder.setDailyTrainTicketId(req.getDailyTrainTicketId());</span></span><br><span class="line">    <span class="comment">// confirmOrder.setStatus(ConfirmOrderStatusEnum.INIT.getCode());</span></span><br><span class="line">    <span class="comment">// confirmOrder.setTickets(JSON.toJSONString(tickets));</span></span><br><span class="line">    <span class="comment">// confirmOrderMapper.insert(confirmOrder);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// // 从数据库里查出订单</span></span><br><span class="line">    <span class="comment">// ConfirmOrderExample confirmOrderExample = new ConfirmOrderExample();</span></span><br><span class="line">    <span class="comment">// confirmOrderExample.setOrderByClause(&quot;id asc&quot;);</span></span><br><span class="line">    <span class="comment">// ConfirmOrderExample.Criteria criteria = confirmOrderExample.createCriteria();</span></span><br><span class="line">    <span class="comment">// criteria.andDateEqualTo(req.getDate())</span></span><br><span class="line">    <span class="comment">//         .andTrainCodeEqualTo(req.getTrainCode())</span></span><br><span class="line">    <span class="comment">//         .andStatusEqualTo(ConfirmOrderStatusEnum.INIT.getCode());</span></span><br><span class="line">    <span class="comment">// List&lt;ConfirmOrder&gt; list = confirmOrderMapper.selectByExampleWithBLOBs(confirmOrderExample);</span></span><br><span class="line">    <span class="comment">// ConfirmOrder confirmOrder;</span></span><br><span class="line">    <span class="comment">// if (CollUtil.isEmpty(list)) &#123;</span></span><br><span class="line">    <span class="comment">//     LOG.info(&quot;找不到原始订单，结束&quot;);</span></span><br><span class="line">    <span class="comment">//     return;</span></span><br><span class="line">    <span class="comment">// &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//     LOG.info(&quot;本次处理&#123;&#125;条确认订单&quot;, list.size());</span></span><br><span class="line">    <span class="comment">//     confirmOrder = list.get(0);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查出余票记录，需要得到真实的库存</span></span><br><span class="line">    <span class="type">DailyTrainTicket</span> <span class="variable">dailyTrainTicket</span> <span class="operator">=</span> dailyTrainTicketService.selectByUnique(date, trainCode, start, end);</span><br><span class="line">    LOG.info(<span class="string">&quot;查出余票记录：&#123;&#125;&quot;</span>, dailyTrainTicket);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 预扣减余票数量，并判断余票是否足够</span></span><br><span class="line">    reduceTickets(req, dailyTrainTicket);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最终的选座结果</span></span><br><span class="line">    List&lt;DailyTrainSeat&gt; finalSeatList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 计算相对第一个座位的偏移值</span></span><br><span class="line">    <span class="comment">// 比如选择的是C1,D2，则偏移值是：[0,5]</span></span><br><span class="line">    <span class="comment">// 比如选择的是A1,B1,C1，则偏移值是：[0,1,2]</span></span><br><span class="line">    <span class="type">ConfirmOrderTicketReq</span> <span class="variable">ticketReq0</span> <span class="operator">=</span> tickets.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(ticketReq0.getSeat())) &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;本次购票有选座&quot;</span>);</span><br><span class="line">        <span class="comment">// 查出本次选座的座位类型都有哪些列，用于计算所选座位与第一个座位的偏离值</span></span><br><span class="line">        List&lt;SeatColEnum&gt; colEnumList = SeatColEnum.getColsByType(ticketReq0.getSeatTypeCode());</span><br><span class="line">        LOG.info(<span class="string">&quot;本次选座的座位类型包含的列：&#123;&#125;&quot;</span>, colEnumList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 组成和前端两排选座一样的列表，用于作参照的座位列表，例：referSeatList = &#123;A1, C1, D1, F1, A2, C2, D2, F2&#125;</span></span><br><span class="line">        List&lt;String&gt; referSeatList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (SeatColEnum seatColEnum : colEnumList) &#123;</span><br><span class="line">                referSeatList.add(seatColEnum.getCode() + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;用于作参照的两排座位：&#123;&#125;&quot;</span>, referSeatList);</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; offsetList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 绝对偏移值，即：在参照座位列表中的位置</span></span><br><span class="line">        List&lt;Integer&gt; aboluteOffsetList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ConfirmOrderTicketReq ticketReq : tickets) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> referSeatList.indexOf(ticketReq.getSeat());</span><br><span class="line">            aboluteOffsetList.add(index);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;计算得到所有座位的绝对偏移值：&#123;&#125;&quot;</span>, aboluteOffsetList);</span><br><span class="line">        <span class="keyword">for</span> (Integer index : aboluteOffsetList) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> index - aboluteOffsetList.get(<span class="number">0</span>);</span><br><span class="line">            offsetList.add(offset);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;计算得到所有座位的相对第一个座位的偏移值：&#123;&#125;&quot;</span>, offsetList);</span><br><span class="line"></span><br><span class="line">        getSeat(finalSeatList,</span><br><span class="line">                date,</span><br><span class="line">                trainCode,</span><br><span class="line">                ticketReq0.getSeatTypeCode(),</span><br><span class="line">                ticketReq0.getSeat().split(<span class="string">&quot;&quot;</span>)[<span class="number">0</span>], <span class="comment">// 从A1得到A</span></span><br><span class="line">                offsetList,</span><br><span class="line">                dailyTrainTicket.getStartIndex(),</span><br><span class="line">                dailyTrainTicket.getEndIndex()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;本次购票没有选座&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (ConfirmOrderTicketReq ticketReq : tickets) &#123;</span><br><span class="line">            getSeat(finalSeatList,</span><br><span class="line">                    date,</span><br><span class="line">                    trainCode,</span><br><span class="line">                    ticketReq.getSeatTypeCode(),</span><br><span class="line">                    <span class="literal">null</span>,</span><br><span class="line">                    <span class="literal">null</span>,</span><br><span class="line">                    dailyTrainTicket.getStartIndex(),</span><br><span class="line">                    dailyTrainTicket.getEndIndex()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">&quot;最终选座：&#123;&#125;&quot;</span>, finalSeatList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 选中座位后事务处理：</span></span><br><span class="line">    <span class="comment">// 座位表修改售卖情况sell；</span></span><br><span class="line">    <span class="comment">// 余票详情表修改余票；</span></span><br><span class="line">    <span class="comment">// 为会员增加购票记录</span></span><br><span class="line">    <span class="comment">// 更新确认订单为成功</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        afterConfirmOrderService.afterDoConfirm(dailyTrainTicket, finalSeatList, tickets, confirmOrder);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;保存购票信息失败&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(BusinessExceptionEnum.CONFIRM_ORDER_EXCEPTION);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们修改下ConfirmOrderService的接收参数和获取分布式锁的参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">doConfirm</span><span class="params">(ConfirmOrderMQDto dto)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisKeyPreEnum.CONFIRM_ORDER + <span class="string">&quot;-&quot;</span> + DateUtil.formatDate(dto.getDate()) + <span class="string">&quot;-&quot;</span> + dto.getTrainCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取完分布式锁就可以进行循环了，后端处理大批量数据的常用做法，使用分页处理，而不是一次性查到内存里。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 取确认订单表的记录，同日期车次，状态是I，分页处理，每次取N条</span></span><br><span class="line">        <span class="type">ConfirmOrderExample</span> <span class="variable">confirmOrderExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmOrderExample</span>();</span><br><span class="line">        confirmOrderExample.setOrderByClause(<span class="string">&quot;id asc&quot;</span>);</span><br><span class="line">        ConfirmOrderExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> confirmOrderExample.createCriteria();</span><br><span class="line">        criteria.andDateEqualTo(dto.getDate())</span><br><span class="line">                .andTrainCodeEqualTo(dto.getTrainCode())</span><br><span class="line">                .andStatusEqualTo(ConfirmOrderStatusEnum.INIT.getCode());</span><br><span class="line">        PageHelper.startPage(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">        List&lt;ConfirmOrder&gt; list = confirmOrderMapper.selectByExampleWithBLOBs(confirmOrderExample);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isEmpty(list)) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;没有需要处理的订单，结束循环&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;本次处理&#123;&#125;条订单&quot;</span>, list.size());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//一条一条卖</span></span><br><span class="line">        list.forEach(<span class="built_in">this</span>::sell);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">    redisTemplate.delete(lockKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>要对某一订单开始出票时，先把它更新成处理中，避免重复处理</p>
</blockquote>
<ul>
<li>这里我们先把更新订单状态提取成一个方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> confirmOrder</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateStatus</span><span class="params">(ConfirmOrder confirmOrder)</span> &#123;</span><br><span class="line">    <span class="type">ConfirmOrder</span> <span class="variable">confirmOrderForUpdate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmOrder</span>();</span><br><span class="line">    confirmOrderForUpdate.setId(confirmOrder.getId());</span><br><span class="line">    confirmOrderForUpdate.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    confirmOrderForUpdate.setStatus(confirmOrder.getStatus());</span><br><span class="line">    confirmOrderMapper.updateByPrimaryKeySelective(confirmOrderForUpdate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再售票sell方法中使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将订单设置成处理中，避免重复处理</span></span><br><span class="line">LOG.info(<span class="string">&quot;将确认订单更新成处理中，避免重复处理，confirm_order.id: &#123;&#125;&quot;</span>, confirmOrder.getId());</span><br><span class="line">confirmOrder.setStatus(ConfirmOrderStatusEnum.PENDING.getCode());</span><br><span class="line">updateStatus(confirmOrder);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>某一订单余票不足时，继续售卖下一订单</p>
</blockquote>
<ul>
<li>我们在那个循环一条一条卖做修改</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一条一条卖</span></span><br><span class="line">list.forEach(confirmOrder -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        sell(confirmOrder);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (BusinessException e)&#123;</span><br><span class="line">        <span class="keyword">if</span> (e.getE().equals(BusinessExceptionEnum.CONFIRM_ORDER_TICKET_COUNT_ERROR))&#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;本订单余票不足，继续售卖下一个订单&quot;</span>);</span><br><span class="line">            confirmOrder.setStatus(ConfirmOrderStatusEnum.EMPTY.getCode());</span><br><span class="line">            updateStatus(confirmOrder);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>MQ消费里，没抢到锁的，表示有其它消费线程正在出票，不做任何处理</p>
</blockquote>
<ul>
<li>修改获取分布式锁不成功的操作，就不抛异常了，抛了也没人看</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//只是没抢到锁，并不知道票抢完了没，所以提示稍后再试</span></span><br><span class="line">    LOG.info(<span class="string">&quot;没抢到锁，有其他消费线程正在出票，不做任何处理&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>针对开发环境做修改，dev环境不校验图片验证码，不校验令牌锁，方便压测</p>
</blockquote>
<ul>
<li>修改ConfirmOrderController，如果处于开发环境图形验证码就不验证了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;spring.profiles.active&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String env;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!env.equals(<span class="string">&quot;dev&quot;</span>))&#123;</span><br><span class="line">    <span class="comment">//图形验证码校验</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">imageCodeToken</span> <span class="operator">=</span> req.getImageCodeToken();</span><br><span class="line">    <span class="type">String</span> <span class="variable">imageCode</span> <span class="operator">=</span> req.getImageCode();</span><br><span class="line">    <span class="type">String</span> <span class="variable">imageCodeRedis</span> <span class="operator">=</span> redisTemplate.opsForValue().get(imageCodeToken);</span><br><span class="line">    LOG.info(<span class="string">&quot;从redis中获取的验证码：&#123;&#125;&quot;</span>,imageCodeRedis);</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtils.isEmpty(imageCodeRedis))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(<span class="literal">false</span>,<span class="string">&quot;验证码已过期&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//验证码校验，大小写忽略，提升体验，比如0o Vv Ww容易混</span></span><br><span class="line">    <span class="keyword">if</span> (!imageCodeRedis.equalsIgnoreCase(imageCode))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(<span class="literal">false</span>,<span class="string">&quot;验证码不正确&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        redisTemplate.delete(imageCodeToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>而SkTokenService一样</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;spring.profiles.active&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String env;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!env.equals(<span class="string">&quot;dev&quot;</span>))&#123;</span><br><span class="line">    <span class="comment">//先获取令牌锁，再校验令牌余量，防止机器人抢票，LockKey就是令牌，用来表示【谁能做什么】的一个凭证</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> RedisKeyPreEnum.SK_TOKEN + <span class="string">&quot;-&quot;</span> + DateUtil.formatDate(date)+<span class="string">&quot;-&quot;</span>+trainCode+<span class="string">&quot;-&quot;</span>+memberId;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">setIfAbsent</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(lockKey, lockKey, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">if</span> (Boolean.TRUE.equals(setIfAbsent))&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;恭喜，抢到令牌锁了！lockKey：&#123;&#125;&quot;</span>,lockKey);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;很遗憾，没抢到令牌锁！lockKey：&#123;&#125;&quot;</span>,lockKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="增加轮询购票结果功能"><a href="#增加轮询购票结果功能" class="headerlink" title="增加轮询购票结果功能"></a>增加轮询购票结果功能</h2><blockquote>
<p>订单轮询结果：<br>1.有终态：成功、失败、没票等<br>2.非终态：告知排队数量</p>
</blockquote>
<blockquote>
<p>确认订单接口返回确认订单ID，方便后续做排队查询</p>
</blockquote>
<ul>
<li>首先修改下BeforeConfirmOrderService的beforeDoConfirm方法返回为long类型，添加返回值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> confirmOrder.getId();</span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们ConfirmOrderController的doConfirm方法就可以接收了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> beforeConfirmOrderService.beforeDoConfirm(req);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(String.valueOf(id));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>增加查询排队数量接口，返回排队数量或订单终态（成功、失败、无票、取消等）</p>
</blockquote>
<ul>
<li>我们增加一个ConfirmOrderController查询接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/query-line-count/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;Integer&gt; <span class="title function_">queryLineCount</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> confirmOrderService.queryLineCount(id);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在ConfirmOrderService类中增加方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询前面有几个人在排队</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Integer <span class="title function_">queryLineCount</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">ConfirmOrder</span> <span class="variable">confirmOrder</span> <span class="operator">=</span> confirmOrderMapper.selectByPrimaryKey(id);</span><br><span class="line">    <span class="type">ConfirmOrderStatusEnum</span> <span class="variable">statusEnum</span> <span class="operator">=</span> EnumUtil.getBy(ConfirmOrderStatusEnum::getCode, confirmOrder.getStatus());</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">switch</span> (statusEnum) &#123;</span><br><span class="line">        <span class="keyword">case</span> PENDING -&gt; <span class="number">0</span>; <span class="comment">// 排队0</span></span><br><span class="line">        <span class="keyword">case</span> SUCCESS -&gt; -<span class="number">1</span>; <span class="comment">// 成功</span></span><br><span class="line">        <span class="keyword">case</span> FAILURE -&gt; -<span class="number">2</span>; <span class="comment">// 失败</span></span><br><span class="line">        <span class="keyword">case</span> EMPTY -&gt; -<span class="number">3</span>; <span class="comment">// 无票</span></span><br><span class="line">        <span class="keyword">case</span> CANCEL -&gt; -<span class="number">4</span>; <span class="comment">// 取消</span></span><br><span class="line">        <span class="keyword">case</span> INIT -&gt; <span class="number">999</span>; <span class="comment">// 需要查表得到实际排队数量</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">999</span>) &#123;</span><br><span class="line">        <span class="comment">// 排在第几位，下面的写法：where a=1 and (b=1 or c=1) 等价于 where (a=1 and b=1) or (a=1 and c=1)</span></span><br><span class="line">        <span class="type">ConfirmOrderExample</span> <span class="variable">confirmOrderExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmOrderExample</span>();</span><br><span class="line">        confirmOrderExample.or().andDateEqualTo(confirmOrder.getDate())</span><br><span class="line">                .andTrainCodeEqualTo(confirmOrder.getTrainCode())</span><br><span class="line">                .andCreateTimeLessThan(confirmOrder.getCreateTime())</span><br><span class="line">                .andStatusEqualTo(ConfirmOrderStatusEnum.INIT.getCode());</span><br><span class="line">        confirmOrderExample.or().andDateEqualTo(confirmOrder.getDate())</span><br><span class="line">                .andTrainCodeEqualTo(confirmOrder.getTrainCode())</span><br><span class="line">                .andCreateTimeLessThan(confirmOrder.getCreateTime())</span><br><span class="line">                .andStatusEqualTo(ConfirmOrderStatusEnum.PENDING.getCode());</span><br><span class="line">        <span class="keyword">return</span> Math.toIntExact(confirmOrderMapper.countByExample(confirmOrderExample));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>前端增加轮询购票结果功能，根据结果提示终态或排队人数</p>
</blockquote>
<ul>
<li>在ConfirmOrderService类中sell增加个延迟</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为了演示排队效果，每次出票增加200毫秒延时</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来全是对order的修改</li>
<li>先增加一个模态框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-modal v-model:visible=&quot;lineModalVisible&quot; title=&quot;排队购票&quot; :footer=&quot;null&quot; :maskClosable=&quot;false&quot; :closable=&quot;false&quot;</span><br><span class="line">         style=&quot;top: 50px; width: 400px&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;book-line&quot;&gt;</span><br><span class="line">    &lt;div v-show=&quot;confirmOrderLineCount &lt; 0&quot;&gt;</span><br><span class="line">      &lt;loading-outlined /&gt; 系统正在处理中...</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div v-show=&quot;confirmOrderLineCount &gt;= 0&quot;&gt;</span><br><span class="line">      &lt;loading-outlined /&gt; 您前面还有&#123;&#123;confirmOrderLineCount&#125;&#125;位用户在购票，排队中，请稍候</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/a-modal&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加三个定义初始化</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> lineModalVisible = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="keyword">const</span> confirmOrderId = <span class="title function_">ref</span>();</span><br><span class="line"><span class="keyword">const</span> confirmOrderLineCount = <span class="title function_">ref</span>(-<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>在点击确认post(“&#x2F;business&#x2F;confirm-order&#x2F;do”）成功时为以下代码</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">  <span class="comment">// notification.success(&#123;description:&quot;下单成功！&quot;&#125;);</span></span><br><span class="line">  visible.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">  imageCodeModalVisible.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">  lineModalVisible.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">  confirmOrderId.<span class="property">value</span> = data.<span class="property">content</span>;</span><br><span class="line">  <span class="title function_">queryLineCount</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>其中定时查询订单状态queryLineCount为</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ------------------- 定时查询订单状态 --------------------- */</span></span><br><span class="line"><span class="comment">// 确认订单后定时查询</span></span><br><span class="line"><span class="keyword">let</span> queryLineCountInterval;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定时查询订单结果/排队数量</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">queryLineCount</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  confirmOrderLineCount.<span class="property">value</span> = -<span class="number">1</span>;</span><br><span class="line">  queryLineCountInterval = <span class="built_in">setInterval</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    axios.<span class="title function_">get</span>(<span class="string">&quot;/business/confirm-order/query-line-count/&quot;</span> + confirmOrderId.<span class="property">value</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">      <span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> result = data.<span class="property">content</span>;</span><br><span class="line">        <span class="keyword">switch</span> (result) &#123;</span><br><span class="line">          <span class="keyword">case</span> -<span class="number">1</span> :</span><br><span class="line">            notification.<span class="title function_">success</span>(&#123;<span class="attr">description</span>: <span class="string">&quot;购票成功！&quot;</span>&#125;);</span><br><span class="line">            lineModalVisible.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">clearInterval</span>(queryLineCountInterval);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> -<span class="number">2</span>:</span><br><span class="line">            notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>: <span class="string">&quot;购票失败！&quot;</span>&#125;);</span><br><span class="line">            lineModalVisible.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">clearInterval</span>(queryLineCountInterval);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> -<span class="number">3</span>:</span><br><span class="line">            notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>: <span class="string">&quot;抱歉，没票了！&quot;</span>&#125;);</span><br><span class="line">            lineModalVisible.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">clearInterval</span>(queryLineCountInterval);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="attr">default</span>:</span><br><span class="line">            confirmOrderLineCount.<span class="property">value</span> = result;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>: data.<span class="property">message</span>&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, <span class="number">500</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>将下面的return回去</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lineModalVisible,</span><br><span class="line">confirmOrderId,</span><br><span class="line">confirmOrderLineCount</span><br></pre></td></tr></table></figure>

<h1 id="压力测试-高并发优化前后的性能对比（单机性能提升25倍左右）"><a href="#压力测试-高并发优化前后的性能对比（单机性能提升25倍左右）" class="headerlink" title="压力测试-高并发优化前后的性能对比（单机性能提升25倍左右）"></a>压力测试-高并发优化前后的性能对比（单机性能提升25倍左右）</h1><p>本章介绍介绍压测相关的知识，并使用JMeter对代码进行压测，对比高并发优化前后的性能，从结果看出，不管从吞吐量还是并发量来说，单机性能都提升了25倍左右。</p>
<hr>
<h2 id="压力测试相关概念讲解"><a href="#压力测试相关概念讲解" class="headerlink" title="压力测试相关概念讲解"></a>压力测试相关概念讲解</h2><ul>
<li><strong>并发量</strong>：指在同一时间点内，系统中同时处理的用户请求数（并发1000时，响应时间1S；并发5000时，响应时间5秒，处理得慢一点，但也能处理。那么并发量到底是1000还是5000呢）</li>
<li><strong>响应时间</strong>：指系统处理一个请求所需的时间。</li>
<li><strong>吞吐量</strong>：是指系统在给定时间内处理的业务请求数量</li>
<li><strong>QPS（Queries Per Second）</strong>，表示系统每秒钟处理的请求数量</li>
<li><strong>TPS（Transactions Per Second）</strong>，表示系统每秒钟完成的事务数量</li>
</ul>
<blockquote>
<p>后面这三基本就一样</p>
</blockquote>
<h2 id="吞吐量压测"><a href="#吞吐量压测" class="headerlink" title="吞吐量压测"></a>吞吐量压测</h2><ul>
<li>为了更准确的压出下单接口的吞吐量，设置令牌足够多。</li>
<li>要看我们系统的处理能力，先修改线程组里面的线程数，然后要在购票处增加一个监听器里面的聚合报告</li>
<li>一般我们需要把卖票功能放到另一个模块上，跟我们压测这个接口不在同一个服务器上</li>
<li>新的代码吞吐量将近450左右，旧的才17左右</li>
</ul>
<h2 id="修改JVM参数再次压测"><a href="#修改JVM参数再次压测" class="headerlink" title="修改JVM参数再次压测"></a>修改JVM参数再次压测</h2><ul>
<li>前面的压测里面没有对内存做限制，应该给一个固定内存</li>
<li>我们在Business的启动器增加一个JVM参数</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xms2048m -Xmx2048m</span><br></pre></td></tr></table></figure>

<ul>
<li>改完之后还是450左右，再把内存改为128m的，结果还是450左右，说明内存并没有太大的影响</li>
</ul>
<h2 id="最高并发数探测"><a href="#最高并发数探测" class="headerlink" title="最高并发数探测"></a>最高并发数探测</h2><ul>
<li>我们在线程组里修改的线程数：100个线程就相当于100个通道，每个通道一次处理一个请求，一个请求处理完，下个请求立马进来，每秒可以处理多个请求</li>
<li>最高并发数探测方法：<ul>
<li>增加线程数，直到出现异常</li>
<li>增加线程数，直到平均响应时间超过预期的值（依项目而定，比如买票最多让用户等待2秒）</li>
</ul>
</li>
</ul>
<blockquote>
<p>结论：经过改造后，吞吐量和并发量都提高了25倍左右，即整体性能提升了25倍左右</p>
</blockquote>
<h2 id="使用异步线程代替RocketMQ"><a href="#使用异步线程代替RocketMQ" class="headerlink" title="使用异步线程代替RocketMQ"></a>使用异步线程代替RocketMQ</h2><ul>
<li>上线的话就没必要使用RocketMQ增加压力了，直接使用异步线程，把相关RocketMQ去掉，再business启动类上增加一个注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用的话只需要在需要访问的方法上增加注解,并且必须是外部类来调用该方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br></pre></td></tr></table></figure>

<h1 id="项目优化"><a href="#项目优化" class="headerlink" title="项目优化"></a>项目优化</h1><p>本章从两个方面对项目做优化：1. 项目功能，在前面的章节已经完成了项目的核心功能，但还有些细节功能可以完善，本章将对项目功能做查缺补漏；2. 体验功能，项目做了很多高并发的优化，单从现有界面的操作来看，体现不出项目的特性，为了让大家更好的体验这个项目的功能，本章将加入一些体验功能。</p>
<hr>
<h2 id="本章介绍-5"><a href="#本章介绍-5" class="headerlink" title="本章介绍"></a>本章介绍</h2><ul>
<li>完善项目功能<ul>
<li>取消排队</li>
<li>途径车站</li>
<li>购票时间</li>
</ul>
</li>
<li>完善体验功能<ul>
<li>加入排队人数</li>
<li>乘客初始化</li>
<li>座位销售图</li>
</ul>
</li>
</ul>
<h2 id="购票页面增加取消排队的功能"><a href="#购票页面增加取消排队的功能" class="headerlink" title="购票页面增加取消排队的功能"></a>购票页面增加取消排队的功能</h2><ul>
<li>首先在ConfirmOrderController增加接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/cancel/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResp&lt;Integer&gt; <span class="title function_">cancel</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> confirmOrderService.cancel(id);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后在ConfirmOrderService增加方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取消排队，只有I状态才能取消排队，所以按状态更新</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Integer <span class="title function_">cancel</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    <span class="type">ConfirmOrderExample</span> <span class="variable">confirmOrderExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmOrderExample</span>();</span><br><span class="line">    ConfirmOrderExample.<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> confirmOrderExample.createCriteria();</span><br><span class="line">    criteria.andIdEqualTo(id).andStatusEqualTo(ConfirmOrderStatusEnum.INIT.getCode());</span><br><span class="line">    <span class="type">ConfirmOrder</span> <span class="variable">confirmOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfirmOrder</span>();</span><br><span class="line">    confirmOrder.setStatus(ConfirmOrderStatusEnum.CANCEL.getCode());</span><br><span class="line">    <span class="keyword">return</span> confirmOrderMapper.updateByExampleSelective(confirmOrder,confirmOrderExample);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改order.vue，添加一个取消按钮</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;br/&gt;</span><br><span class="line">&lt;a-button type=&quot;danger&quot; @click=&quot;onCancelOrder&quot;&gt;取消购票&lt;/a-button&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加确认方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取消排队</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onCancelOrder</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">  axios.<span class="title function_">get</span>(<span class="string">&quot;/business/confirm-order/cancel/&quot;</span> + confirmOrderId.<span class="property">value</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>)&#123;</span><br><span class="line">      <span class="keyword">let</span> result = data.<span class="property">content</span>;</span><br><span class="line">      <span class="keyword">if</span> (result ===<span class="number">1</span>)&#123;</span><br><span class="line">        notification.<span class="title function_">success</span>(&#123;<span class="attr">description</span>:<span class="string">&quot;取消成功！&quot;</span>&#125;);</span><br><span class="line">        <span class="comment">//取消成功时，不用再轮询排队结果</span></span><br><span class="line">        <span class="built_in">clearInterval</span>(queryLineCountInterval);</span><br><span class="line">        lineModalVisible.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:<span class="string">&quot;取消失败！&quot;</span>&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>:data.<span class="property">message</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后将onCancelOrder返回回去</li>
</ul>
<h2 id="余票查询页面增加显示车站信息"><a href="#余票查询页面增加显示车站信息" class="headerlink" title="余票查询页面增加显示车站信息"></a>余票查询页面增加显示车站信息</h2><ul>
<li>增加需要根据什么进行车辆查询的参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotBlank;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotNull;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DailyTrainStationQueryAllReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【日期】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 车次编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;【车次编号】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String trainCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDate</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrainCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrainCode</span><span class="params">(String trainCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trainCode = trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;DailyTrainStationQueryReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;date=&quot;</span>).append(date);</span><br><span class="line">        sb.append(<span class="string">&quot;, trainCode=&#x27;&quot;</span>).append(trainCode).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加车辆查询接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.DailyTrainStationQueryAllReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.resp.DailyTrainStationQueryResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.service.DailyTrainStationService;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/daily-train-station&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DailyTrainStationController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DailyTrainStationService dailyTrainStationService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/query-by-train-code&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;List&lt;DailyTrainStationQueryResp&gt;&gt; <span class="title function_">queryByTrain</span><span class="params">(<span class="meta">@Valid</span> DailyTrainStationQueryAllReq req)</span> &#123;</span><br><span class="line">        List&lt;DailyTrainStationQueryResp&gt; list = dailyTrainStationService.queryByTrain(req.getDate(), req.getTrainCode());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在DailyTrainStationService中增加方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按车次日期查询车站列表，用于界面显示一列车经过的车站</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;DailyTrainStationQueryResp&gt; <span class="title function_">queryByTrain</span><span class="params">(Date date, String trainCode)</span> &#123;</span><br><span class="line">    <span class="type">DailyTrainStationExample</span> <span class="variable">dailyTrainStationExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainStationExample</span>();</span><br><span class="line">    dailyTrainStationExample.setOrderByClause(<span class="string">&quot;`index` asc&quot;</span>);</span><br><span class="line">    dailyTrainStationExample.createCriteria().andDateEqualTo(date).andTrainCodeEqualTo(trainCode);</span><br><span class="line">    List&lt;DailyTrainStation&gt; list = dailyTrainStationMapper.selectByExample(dailyTrainStationExample);</span><br><span class="line">    <span class="keyword">return</span> BeanUtil.copyToList(list, DailyTrainStationQueryResp.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在ticket中增加一个途经车站按钮</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-space&gt;</span><br><span class="line">  &lt;a-button type=&quot;primary&quot; @click=&quot;toOrder(record)&quot;&gt;预定&lt;/a-button&gt;</span><br><span class="line">  &lt;a-button type=&quot;primary&quot; @click=&quot;showStation(record)&quot;&gt;途经车站&lt;/a-button&gt;</span><br><span class="line">&lt;/a-space&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加一个模态框</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 途经车站 --&gt;</span><br><span class="line">&lt;a-modal style=&quot;top: 30px&quot; v-model:visible=&quot;visible&quot; :title=&quot;null&quot; :footer=&quot;null&quot; :closable=&quot;false&quot;&gt;</span><br><span class="line">  &lt;a-table :data-source=&quot;stations&quot; :pagination=&quot;false&quot;&gt;</span><br><span class="line">    &lt;a-table-column key=&quot;index&quot; title=&quot;站序&quot; data-index=&quot;index&quot; /&gt;</span><br><span class="line">    &lt;a-table-column key=&quot;name&quot; title=&quot;站名&quot; data-index=&quot;name&quot; /&gt;</span><br><span class="line">    &lt;a-table-column key=&quot;inTime&quot; title=&quot;进站时间&quot; data-index=&quot;inTime&quot;&gt;</span><br><span class="line">      &lt;template #default=&quot;&#123; record &#125;&quot;&gt;</span><br><span class="line">        &#123;&#123;record.index === 0 ? &#x27;-&#x27; : record.inTime&#125;&#125;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/a-table-column&gt;</span><br><span class="line">    &lt;a-table-column key=&quot;outTime&quot; title=&quot;出站时间&quot; data-index=&quot;outTime&quot;&gt;</span><br><span class="line">      &lt;template #default=&quot;&#123; record &#125;&quot;&gt;</span><br><span class="line">        &#123;&#123;record.index === (stations.length - 1) ? &#x27;-&#x27; : record.outTime&#125;&#125;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/a-table-column&gt;</span><br><span class="line">    &lt;a-table-column key=&quot;stopTime&quot; title=&quot;停站时长&quot; data-index=&quot;stopTime&quot;&gt;</span><br><span class="line">      &lt;template #default=&quot;&#123; record &#125;&quot;&gt;</span><br><span class="line">        &#123;&#123;record.index === 0 || record.index === (stations.length - 1) ? &#x27;-&#x27; : record.stopTime&#125;&#125;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/a-table-column&gt;</span><br><span class="line">  &lt;/a-table&gt;</span><br><span class="line">&lt;/a-modal&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加对应的js方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ---------------------- 途经车站 ----------------------</span></span><br><span class="line"><span class="keyword">const</span> stations = <span class="title function_">ref</span>([]);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">showStation</span> = record =&gt; &#123;</span><br><span class="line">  visible.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">  axios.<span class="title function_">get</span>(<span class="string">&quot;/business/daily-train-station/query-by-train-code&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">params</span>: &#123;</span><br><span class="line">      <span class="attr">date</span>: record.<span class="property">date</span>,</span><br><span class="line">      <span class="attr">trainCode</span>: record.<span class="property">trainCode</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> data = response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span><br><span class="line">      stations.<span class="property">value</span> = data.<span class="property">content</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      notification.<span class="title function_">error</span>(&#123;<span class="attr">description</span>: data.<span class="property">message</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后将下面的返回</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">showStation,</span><br><span class="line">stations</span><br></pre></td></tr></table></figure>

<h2 id="购票页面增加发起多人排队功能"><a href="#购票页面增加发起多人排队功能" class="headerlink" title="购票页面增加发起多人排队功能"></a>购票页面增加发起多人排队功能</h2><ul>
<li>我们先修改前端order</li>
<li>在订单提交模态框增加</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;br/&gt;</span><br><span class="line">&lt;div style=&quot;color: red&quot;&gt;</span><br><span class="line">  体验排队购票，加入多人一起排队购票：</span><br><span class="line">  &lt;a-input-number v-model:value=&quot;lineNumber&quot; :min=&quot;0&quot; :max=&quot;20&quot; /&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加定义</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">LineNumber</span> = <span class="title function_">ref</span>(<span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>在handleOk的post请求中增加传入参数，最后将lineNumber返回</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lineNumber</span>: lineNumber.<span class="property">value</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改后端ConfirmOrderDoReq，增加前端传入参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加入排队人数，用于体验排队功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> lineNumber;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改BeforeConfirmOrderService，在beforeDoConfirm方法中增加一个for循环，将原来代码都放进去</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//根据前端传值，加入排队人数</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; req.getLineNumber(); i++) &#123;</span><br><span class="line">     <span class="comment">//......源代码</span></span><br><span class="line">        id = confirmOrder.getId();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="增加座位销售图"><a href="#增加座位销售图" class="headerlink" title="增加座位销售图"></a>增加座位销售图</h2><blockquote>
<p>增加查询座位销售详情接口</p>
</blockquote>
<ul>
<li>首先增加一个请求参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.req;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.validation.constraints.NotNull;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeatSellReq</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【日期】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 车次编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;【车次编号】不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String trainCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDate</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTrainCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTrainCode</span><span class="params">(String trainCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trainCode = trainCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;SeatSellQueryReq&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;date=&quot;</span>).append(date);</span><br><span class="line">        sb.append(<span class="string">&quot;, trainCode=&#x27;&quot;</span>).append(trainCode).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在增加一个返回参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.resp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeatSellResp</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 箱序</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer carriageIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排号|01, 02</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String row;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列号|枚举[SeatColEnum]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String col;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 座位类型|枚举[SeatTypeEnum]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String seatType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 售卖情况|将经过的车站用01拼接，0表示可卖，1表示已卖</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sell;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getCarriageIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> carriageIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCarriageIndex</span><span class="params">(Integer carriageIndex)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.carriageIndex = carriageIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> row;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRow</span><span class="params">(String row)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.row = row;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCol</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> col;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCol</span><span class="params">(String col)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.col = col;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSeatType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seatType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeatType</span><span class="params">(String seatType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seatType = seatType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSell</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sell;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSell</span><span class="params">(String sell)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sell = sell;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        sb.append(getClass().getSimpleName());</span><br><span class="line">        sb.append(<span class="string">&quot; [&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;Hash = &quot;</span>).append(hashCode());</span><br><span class="line">        sb.append(<span class="string">&quot;, carriageIndex=&quot;</span>).append(carriageIndex);</span><br><span class="line">        sb.append(<span class="string">&quot;, row=&quot;</span>).append(row);</span><br><span class="line">        sb.append(<span class="string">&quot;, col=&quot;</span>).append(col);</span><br><span class="line">        sb.append(<span class="string">&quot;, seatType=&quot;</span>).append(seatType);</span><br><span class="line">        sb.append(<span class="string">&quot;, sell=&quot;</span>).append(sell);</span><br><span class="line">        sb.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>写一个查询接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.train.business.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.req.SeatSellReq;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.resp.SeatSellResp;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.business.service.DailyTrainSeatService;</span><br><span class="line"><span class="keyword">import</span> com.fzx.train.common.resp.CommonResp;</span><br><span class="line"><span class="keyword">import</span> jakarta.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/seat-sell&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeatSellController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DailyTrainSeatService dailyTrainSeatService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/query&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResp&lt;List&lt;SeatSellResp&gt;&gt; <span class="title function_">query</span><span class="params">(<span class="meta">@Valid</span> SeatSellReq req)</span> &#123;</span><br><span class="line">        List&lt;SeatSellResp&gt; seatList = dailyTrainSeatService.querySeatSell(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResp</span>&lt;&gt;(seatList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>写里面对应的DailyTrainSeatService方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询某日某车次的所有座位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SeatSellResp&gt; <span class="title function_">querySeatSell</span><span class="params">(SeatSellReq req)</span> &#123;</span><br><span class="line">    <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> req.getDate();</span><br><span class="line">    <span class="type">String</span> <span class="variable">trainCode</span> <span class="operator">=</span> req.getTrainCode();</span><br><span class="line">    LOG.info(<span class="string">&quot;查询日期【&#123;&#125;】车次【&#123;&#125;】的座位销售信息&quot;</span>, DateUtil.formatDate(date), trainCode);</span><br><span class="line">    <span class="type">DailyTrainSeatExample</span> <span class="variable">dailyTrainSeatExample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DailyTrainSeatExample</span>();</span><br><span class="line">    dailyTrainSeatExample.setOrderByClause(<span class="string">&quot;`carriage_index` asc, carriage_seat_index asc&quot;</span>);</span><br><span class="line">    dailyTrainSeatExample.createCriteria()</span><br><span class="line">            .andDateEqualTo(date)</span><br><span class="line">            .andTrainCodeEqualTo(trainCode);</span><br><span class="line">    <span class="keyword">return</span> BeanUtil.copyToList(dailyTrainSeatMapper.selectByExample(dailyTrainSeatExample), SeatSellResp.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>增加座位销售图路由及页面，实现页面跳转和参数传递</p>
</blockquote>
<ul>
<li>这时我们首先增加一个销售图简单页面</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div v-if=&quot;!param.date&quot;&gt;</span><br><span class="line">    请到余票查询里选择一趟列车，</span><br><span class="line">    &lt;router-link to=&quot;/ticket&quot;&gt;</span><br><span class="line">      跳转到余票查询</span><br><span class="line">    &lt;/router-link&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div v-else&gt;</span><br><span class="line">    &lt;p style=&quot;font-weight: bold;&quot;&gt;</span><br><span class="line">      日期：&#123;&#123;param.date&#125;&#125;，车次：&#123;&#123;param.trainCode&#125;&#125;，出发站：&#123;&#123;param.start&#125;&#125;，到达站：&#123;&#123;param.end&#125;&#125;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123;defineComponent,ref&#125; from &#x27;vue&#x27;;</span><br><span class="line">import &#123;useRoute&#125; from &quot;vue-router&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;seat-view&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const route = useRoute();</span><br><span class="line">    const param = ref(&#123;&#125;);</span><br><span class="line">    param.value = route.query;</span><br><span class="line">    return &#123;</span><br><span class="line">      param,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>由于我们需要在ticket页面跳转到seat页面，所以在ticket的操作处增加一个路由</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;router-link :to=&quot;&#123;</span><br><span class="line">  path: &#x27;/seat&#x27;,</span><br><span class="line">  query: &#123;</span><br><span class="line">    date: record.date,</span><br><span class="line">    trainCode: record.trainCode,</span><br><span class="line">    start: record.start,</span><br><span class="line">    startIndex: record.startIndex,</span><br><span class="line">    end: record.end,</span><br><span class="line">    endIndex: record.endIndex</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&quot;&gt;</span><br><span class="line">  &lt;a-button type=&quot;primary&quot;&gt;座位销售图&lt;/a-button&gt;</span><br><span class="line">&lt;/router-link&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后就是常规的把seat增加到菜单处，和添加路由</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-menu-item key=&quot;/seat&quot;&gt;</span><br><span class="line">  &lt;router-link to=&quot;/seat&quot;&gt;</span><br><span class="line">    &lt;usergroup-add-outlined/&gt;&amp;nbsp;座位销售</span><br><span class="line">  &lt;/router-link&gt;</span><br><span class="line">&lt;/a-menu-item&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>座位销售图页面获得销售信息，同一趟车，不管查哪个区间，查到的销售信息是一样的，由界面再去截取区间的销售信息。功能设计经验：对于复杂的操作，能放到前端的都放到前端，减小后端的压力</p>
<p>显示各车厢各座位的销售详情，使用橙色灰色代码座位可卖与卖出</p>
</blockquote>
<ul>
<li>就是修改seat.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div v-if=&quot;!param.date&quot;&gt;</span><br><span class="line">    请到余票查询里选择一趟列车，</span><br><span class="line">    &lt;router-link to=&quot;/ticket&quot;&gt;</span><br><span class="line">      跳转到余票查询</span><br><span class="line">    &lt;/router-link&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div v-else&gt;</span><br><span class="line">    &lt;p style=&quot;font-weight: bold;&quot;&gt;</span><br><span class="line">      日期：&#123;&#123;param.date&#125;&#125;，车次：&#123;&#123;param.trainCode&#125;&#125;，出发站：&#123;&#123;param.start&#125;&#125;，到达站：&#123;&#123;param.end&#125;&#125;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line"></span><br><span class="line">    &lt;table&gt;</span><br><span class="line">      &lt;tr&gt;</span><br><span class="line">        &lt;td style=&quot;width: 25px; background: #FF9900;&quot;&gt;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;：已被购买&lt;/td&gt;</span><br><span class="line">        &lt;td style=&quot;width: 20px;&quot;&gt;&lt;/td&gt;</span><br><span class="line">        &lt;td style=&quot;width: 25px; background: #999999;&quot;&gt;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;：未被购买&lt;/td&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;div v-for=&quot;(seatObj, carriage) in train&quot; :key=&quot;carriage&quot;</span><br><span class="line">         style=&quot;border: 3px solid #99CCFF;</span><br><span class="line">                 margin-bottom: 30px;</span><br><span class="line">                 padding: 5px;</span><br><span class="line">                 border-radius: 4px&quot;&gt;</span><br><span class="line">      &lt;div style=&quot;display:block;</span><br><span class="line">                  width:50px;</span><br><span class="line">                  height:10px;</span><br><span class="line">                  position:relative;</span><br><span class="line">                  top:-15px;</span><br><span class="line">                  text-align: center;</span><br><span class="line">                  background: white;&quot;&gt;</span><br><span class="line">        &#123;&#123;carriage&#125;&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;table&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">          &lt;td v-for=&quot;(sell, index) in Object.values(seatObj)[0]&quot; :key=&quot;index&quot;</span><br><span class="line">              style=&quot;text-align: center&quot;&gt;</span><br><span class="line">            &#123;&#123;index + 1&#125;&#125;</span><br><span class="line">          &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr v-for=&quot;(sellList, col) in seatObj&quot; :key=&quot;col&quot;&gt;</span><br><span class="line">          &lt;td v-for=&quot;(sell, index) in sellList&quot; :key=&quot;index&quot;</span><br><span class="line">              style=&quot;text-align: center;</span><br><span class="line">                      border: 2px solid white;</span><br><span class="line">                      background: grey;</span><br><span class="line">                      padding: 0 4px;</span><br><span class="line">                      color: white;</span><br><span class="line">                      &quot;</span><br><span class="line">              :style=&quot;&#123;background: (sell &gt; 0 ? &#x27;#FF9900&#x27; : &#x27;#999999&#x27;)&#125;&quot;&gt;&#123;&#123;col&#125;&#125;&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">      &lt;/table&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import &#123;defineComponent, onMounted, ref&#125; from &#x27;vue&#x27;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import &#123;notification&#125; from &quot;ant-design-vue&quot;;</span><br><span class="line">import &#123;useRoute&#125; from &quot;vue-router&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">  name: &quot;seat-view&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const route = useRoute();</span><br><span class="line">    const param = ref(&#123;&#125;);</span><br><span class="line">    param.value = route.query;</span><br><span class="line">    const list = ref();</span><br><span class="line">    // 使用对象更便于组装数组，三维数组只能存储最终的01，不能存储“车箱1”，“A”这些数据</span><br><span class="line">    // &#123;</span><br><span class="line">    //   &quot;车箱1&quot;: &#123;</span><br><span class="line">    //      &quot;A&quot; : [&quot;000&quot;, &quot;001&quot;, &quot;001&quot;, &quot;001&quot;],</span><br><span class="line">    //      &quot;B&quot; : [&quot;000&quot;, &quot;001&quot;, &quot;001&quot;, &quot;001&quot;],</span><br><span class="line">    //      &quot;C&quot; : [&quot;000&quot;, &quot;001&quot;, &quot;001&quot;, &quot;001&quot;],</span><br><span class="line">    //      &quot;D&quot; : [&quot;000&quot;, &quot;001&quot;, &quot;001&quot;, &quot;001&quot;]</span><br><span class="line">    //    &#125;, &quot;车箱2&quot;: &#123;</span><br><span class="line">    //      &quot;A&quot; : [&quot;000&quot;, &quot;001&quot;, &quot;001&quot;, &quot;001&quot;],</span><br><span class="line">    //      &quot;B&quot; : [&quot;000&quot;, &quot;001&quot;, &quot;001&quot;, &quot;001&quot;],</span><br><span class="line">    //      &quot;C&quot; : [&quot;000&quot;, &quot;001&quot;, &quot;001&quot;, &quot;001&quot;],</span><br><span class="line">    //      &quot;D&quot; : [&quot;000&quot;, &quot;001&quot;, &quot;001&quot;, &quot;001&quot;],</span><br><span class="line">    //      &quot;D&quot; : [&quot;000&quot;, &quot;001&quot;, &quot;001&quot;, &quot;001&quot;]</span><br><span class="line">    //    &#125;</span><br><span class="line">    // &#125;</span><br><span class="line">    let train = ref(&#123;&#125;);</span><br><span class="line"></span><br><span class="line">    // 查询一列火车的所有车站</span><br><span class="line">    const querySeat = () =&gt; &#123;</span><br><span class="line">      axios.get(&quot;/business/seat-sell/query&quot;, &#123;</span><br><span class="line">        params: &#123;</span><br><span class="line">          date: param.value.date,</span><br><span class="line">          trainCode: param.value.trainCode,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then((response) =&gt; &#123;</span><br><span class="line">        let data = response.data;</span><br><span class="line">        if (data.success) &#123;</span><br><span class="line">          list.value = data.content;</span><br><span class="line">          format();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          notification.error(&#123;description: data.message&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 截取出当前区间的销售信息，并判断是否有票</span><br><span class="line">     */</span><br><span class="line">    const format = () =&gt; &#123;</span><br><span class="line">      let _train = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">      for (let i = 0; i &lt; list.value.length; i++) &#123;</span><br><span class="line">        let item = list.value[i];</span><br><span class="line"></span><br><span class="line">        // 计算当前区间是否还有票，约定：站序是从0开始</span><br><span class="line">        let sellDB = item.sell;</span><br><span class="line"></span><br><span class="line">        // 验证代码：</span><br><span class="line">        // let sellDB = &quot;123456789&quot;;</span><br><span class="line">        // let start = 1;</span><br><span class="line">        // let end = 3;</span><br><span class="line">        // let sell = sellDB.substr(start, end - start)</span><br><span class="line">        // console.log(sell)</span><br><span class="line">        let sell = sellDB.substr(param.value.startIndex, param.value.endIndex - param.value.startIndex);</span><br><span class="line">        // console.log(&quot;完整的销卖信息：&quot;, sellDB, &quot;区间内的销卖信息&quot;, sell);</span><br><span class="line"></span><br><span class="line">        // 将sell放入火车数据中</span><br><span class="line">        if (!_train[&quot;车箱&quot; + item.carriageIndex]) &#123;</span><br><span class="line">          _train[&quot;车箱&quot; + item.carriageIndex] = &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!_train[&quot;车箱&quot; + item.carriageIndex][item.col]) &#123;</span><br><span class="line">          _train[&quot;车箱&quot; + item.carriageIndex][item.col] = [];</span><br><span class="line">        &#125;</span><br><span class="line">        _train[&quot;车箱&quot; + item.carriageIndex][item.col].push(parseInt(sell));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      train.value = _train;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">      if (param.value.date) &#123;</span><br><span class="line">        querySeat();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      param,</span><br><span class="line">      train</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="只允许购买两周内的车次"><a href="#只允许购买两周内的车次" class="headerlink" title="只允许购买两周内的车次"></a>只允许购买两周内的车次</h2><blockquote>
<p>余票查询页面不能选择今天以前及两周以后的日期</p>
</blockquote>
<ul>
<li>这里就修改ticket</li>
<li>修改日期选择框，里面增加，日期显示条件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-date-picker v-model:value=&quot;params.date&quot; valueFormat=&quot;YYYY-MM-DD&quot; :disabled-date=&quot;disabledDate&quot; placeholder=&quot;请选择日期&quot;&gt;&lt;/a-date-picker&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义disabledDate的值</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不能选择今天以前及两周以后的日期</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">disabledDate</span> = current =&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> current &amp;&amp;(current &lt;= <span class="title function_">dayjs</span>().<span class="title function_">add</span>(-<span class="number">1</span>,<span class="string">&#x27;day&#x27;</span>) || current &gt;<span class="title function_">dayjs</span>().<span class="title function_">add</span>(<span class="number">14</span>,<span class="string">&#x27;day&#x27;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后返回disabledDate</li>
</ul>
<blockquote>
<p>当前时间已过车次出发时间的火车，不能选</p>
</blockquote>
<ul>
<li>首先修改ticket里面的操作中的预定按钮，加一个判断</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a-button type=&quot;primary&quot; @click=&quot;toOrder(record)&quot; :disabled=&quot;isExpire(record)&quot;&gt;&#123;&#123;isExpire(record) ? &quot;过期&quot; : &quot;预定&quot;&#125;&#125;&lt;/a-button&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来定义下这个方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否过期</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isExpire</span> = (<span class="params">record</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 标准时间：2000/01/01 00:00:00</span></span><br><span class="line">  <span class="keyword">let</span> startDateTimeString = record.<span class="property">date</span>.<span class="title function_">replace</span>(<span class="regexp">/-/g</span>, <span class="string">&quot;/&quot;</span>) + <span class="string">&quot; &quot;</span> + record.<span class="property">startTime</span>;</span><br><span class="line">  <span class="keyword">let</span> startDateTime = <span class="keyword">new</span> <span class="title class_">Date</span>(startDateTimeString);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//当前时间</span></span><br><span class="line">  <span class="keyword">let</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(startDateTime)</span><br><span class="line">  <span class="keyword">return</span> now.<span class="title function_">valueOf</span>() &gt;= startDateTime.<span class="title function_">valueOf</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="企业级项目上云（阿里云部署）"><a href="#企业级项目上云（阿里云部署）" class="headerlink" title="企业级项目上云（阿里云部署）"></a>企业级项目上云（阿里云部署）</h1><p>主要介绍如果将写好的项目部署到生产环境，供用户访问，包括前后端发布，及微服务器nacos, sentinal等组件的发布。</p>
<hr>
<h2 id="本章介绍-6"><a href="#本章介绍-6" class="headerlink" title="本章介绍"></a>本章介绍</h2><ul>
<li>阿里云资源准备;RDS ECS OSS SLB Redis等</li>
<li>前后端的发布：JDK Nacos SpringBoot Vue CLI</li>
<li>生产必备：多节点和域名</li>
</ul>
<h2 id="阿里云部署方案介绍"><a href="#阿里云部署方案介绍" class="headerlink" title="阿里云部署方案介绍"></a>阿里云部署方案介绍</h2><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202308031525450.png"
                      alt="image-20230803152515313" style="zoom:50%;" 
                >

<h2 id="阿里云RDS购买与配置"><a href="#阿里云RDS购买与配置" class="headerlink" title="阿里云RDS购买与配置"></a>阿里云RDS购买与配置</h2><ul>
<li>新买的RDS得配置下白名单，外部才能访问到 （mysql ）</li>
</ul>
<h2 id="阿里云Redis购买"><a href="#阿里云Redis购买" class="headerlink" title="阿里云Redis购买"></a>阿里云Redis购买</h2><ul>
<li>也得配置白名单</li>
</ul>
<h2 id="阿里云ECS购买与配置"><a href="#阿里云ECS购买与配置" class="headerlink" title="阿里云ECS购买与配置"></a>阿里云ECS购买与配置</h2><ul>
<li>生产的ECS中，可以配置只开放gateway的8000端口，其它80018002端口都不开放，这样就不用担心外部请求绕过gateway，直接访问member模块</li>
</ul>
<h2 id="本地登录阿里云ECS"><a href="#本地登录阿里云ECS" class="headerlink" title="本地登录阿里云ECS"></a>本地登录阿里云ECS</h2><ul>
<li>用xshell就行</li>
</ul>
<h2 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h2><ul>
<li>我们下载一个jdk包，然后将他拖进fshell，然后进行解压</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf jdk.tar.gz</span><br></pre></td></tr></table></figure>

<ul>
<li>然后配置环境变量，在.bash_profile中</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">export</span> <span class="string">JAVA_HOME=&quot;/root/jdk-17.0.7&quot;</span></span><br><span class="line"><span class="attr">export</span> <span class="string">CLASSPATH=&quot;$JAVA_HOME/lib&quot;</span></span><br><span class="line"><span class="attr">export</span> <span class="string">PATH=$JAVA_HOME/bin: $PATH</span></span><br></pre></td></tr></table></figure>

<ul>
<li>让其生效就使用命令行</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /root/.bash_profile</span><br></pre></td></tr></table></figure>

<h2 id="安装nacos"><a href="#安装nacos" class="headerlink" title="安装nacos"></a>安装nacos</h2><ul>
<li>也是下载后解压，记得修改nacos里面的application.properties</li>
<li>启动代码</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -/nacos/bin/startup.sh -m standalone</span><br></pre></td></tr></table></figure>

<ul>
<li>记得在ECS服务器下配置安全组，这样才能访问</li>
</ul>
<h2 id="SpringBoot应用的多环境打包"><a href="#SpringBoot应用的多环境打包" class="headerlink" title="SpringBoot应用的多环境打包"></a>SpringBoot应用的多环境打包</h2><ul>
<li>我们想要自定义打包位置和名字可以在各pom下得build中添加</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">finalName</span>&gt;</span>/dist/$&#123;artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>ECS RDS Redis都有分内网IP和外网IP，外网IP作我们维护用的，代码之前的连接都用内网IP</p>
</li>
<li><p>因为是要发布到ECS上得，所以需要重新配置bootstrap-prod.properties</p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##nacos server注册中心地址，使用ECS内网IP </span></span><br><span class="line"><span class="attr">spring.cloud.nacos.discovery.server-addr</span>=<span class="string">172.17.208.8：8848</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.discovery.namespace</span>=<span class="string">train I</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后我们记得修改gateway得application.properties文件，这样做访问域名的时候就不用加端口号访问了，80端口是自动隐藏的</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">80</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如何使上面的配置生效呢，就需要在各自启动器得JVM参数进行修改。这样就声明了环境配置</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dspring.profiles.active=prod</span><br></pre></td></tr></table></figure>

<h2 id="SpringBoot应用的生产发布"><a href="#SpringBoot应用的生产发布" class="headerlink" title="SpringBoot应用的生产发布"></a>SpringBoot应用的生产发布</h2><ul>
<li>这里直接写了四个脚本，我们把生成的jar包和这四个脚本都放到ECS中，然后运行脚本</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;publish batch----------&quot;</span></span><br><span class="line"></span><br><span class="line">process_id=`ps -ef | grep batch.jar | grep -v grep |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$process_id</span> ] ; <span class="keyword">then</span></span><br><span class="line">sudo <span class="built_in">kill</span> -9 <span class="variable">$process_id</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="built_in">nohup</span> java -jar -Dspring.profiles.active=prod ~/batch.jar &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;end publish&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;publish business----------&quot;</span></span><br><span class="line"></span><br><span class="line">process_id=`ps -ef | grep business.jar | grep -v grep |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$process_id</span> ] ; <span class="keyword">then</span></span><br><span class="line">sudo <span class="built_in">kill</span> -9 <span class="variable">$process_id</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="built_in">nohup</span> java -jar -Dspring.profiles.active=prod ~/business.jar &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;end publish&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;publish gateway----------&quot;</span></span><br><span class="line"></span><br><span class="line">process_id=`ps -ef | grep gateway.jar | grep -v grep |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$process_id</span> ] ; <span class="keyword">then</span></span><br><span class="line">sudo <span class="built_in">kill</span> -9 <span class="variable">$process_id</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="built_in">nohup</span> java -jar -Dspring.profiles.active=prod ~/gateway.jar &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;end publish&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;publish member----------&quot;</span></span><br><span class="line"></span><br><span class="line">process_id=`ps -ef | grep member.jar | grep -v grep |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$process_id</span> ] ; <span class="keyword">then</span></span><br><span class="line">sudo <span class="built_in">kill</span> -9 <span class="variable">$process_id</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="built_in">nohup</span> java -jar -Dspring.profiles.active=prod ~/member.jar &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;end publish&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Vue-CLI模块的生产打包"><a href="#Vue-CLI模块的生产打包" class="headerlink" title="Vue CLI模块的生产打包"></a>Vue CLI模块的生产打包</h2><ul>
<li>我们在vue模块下的package.json的scripts中添加，进行编译。<strong>然后就生成了dist文件，里面就是我们要发布的静态代码</strong></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;build-admin-prod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-cli-service build --mode prod&quot;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<h2 id="Vue-CLI模块的生产发布"><a href="#Vue-CLI模块的生产发布" class="headerlink" title="Vue CLI模块的生产发布"></a>Vue CLI模块的生产发布</h2><ul>
<li>这里使用OSS来发布</li>
<li>然后我们就可以创建Bucket列表了，就相当于文件夹，一个项目一个Bucket</li>
<li>当我们把我们之前打包的文件拖到OSS中，就要设置静态页面那个选项，其中默认首页和默认404页都是index.html，错误文档响应码为200</li>
</ul>
<h2 id="修复服务端访问失败的问题"><a href="#修复服务端访问失败的问题" class="headerlink" title="修复服务端访问失败的问题"></a>修复服务端访问失败的问题</h2><ul>
<li>hutool工具包在上云后会签名报错</li>
<li>这时我们可以在每个我们定义的JwtUtil类的每个方法都加上.这就可以重新打包了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GlobalBouncyCastleProvider.setUseBouncyCastle(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>也可以将第三方包进行打包</li>
</ul>
<blockquote>
<p>解决后端访问报错的问题，BouncyCastle用于加密计算，不允许再被打包，解决方案就不是不使用它，而用JDK自带的算法；图片验证码访问失败，因为服务器缺少字体，解决方案：yum install fontconfig fc-cache–force</p>
</blockquote>
<h2 id="多节点的配置，保证服务高可用"><a href="#多节点的配置，保证服务高可用" class="headerlink" title="多节点的配置，保证服务高可用"></a>多节点的配置，保证服务高可用</h2><blockquote>
<p>多节点是服务高可用最基本的要求，否则，一旦我们遇到服务器宕机、服务器升级重启、应用发布，此时，服务就不可用了。</p>
</blockquote>
<ul>
<li>多节点要求：应用是无状态的</li>
<li>无状态：应用内没有保存特殊的数据，比如将登录信息保存在session里，这种就是保存了和别的节点不一样的数据，属于有状态的应用。</li>
<li>我们可以在ECS中创建一个自定义镜像，然后重新购买一台，购买时选择我们自定义的镜像</li>
<li>但是这时我们的服务配置的是第一台的ECS的内网ip，这时我们需要做的就是关联一个负载均衡SLB，选择ALB</li>
<li>然后就可以进行监听配置了，并在配置里创建一个组，将两台ECS放到这个组里做负载均衡</li>
<li>可以增加健康检查，好让SLB来定时的查看两台ECS是否正常</li>
</ul>
<h2 id="cdn配置介绍"><a href="#cdn配置介绍" class="headerlink" title="cdn配置介绍"></a>cdn配置介绍</h2><ul>
<li>CDN费用：外部流量费（大头）、回源流量费</li>
<li>在OSS的域名管理那可以配置CDN</li>
<li>CDN就是上海人访问上海节点和北京人访问上海节点的速度肯定不一样，CDN就是解决这个问题，使他们有一样的速度。我们在OSS配置CDN，使有访问的人访问离他们最近的节点，提高访问速度</li>
</ul>
<h2 id="https配置介绍"><a href="#https配置介绍" class="headerlink" title="https配置介绍"></a>https配置介绍</h2><ul>
<li>有证书才能配https</li>
</ul>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post title：Springboot3+微服务实战12306高性能售票系统</li>
        <li>Post author：Fang</li>
        <li>Create time：2023-07-03 11:20:30</li>
        <li>
            Post link：https://ainianxu.github.io/2023/07/03/Springboot3-微服务实战12306高性能售票系统/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E9%A1%B9%E7%9B%AE/">#项目</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2023/08/07/java%E7%AC%94%E8%AF%95/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">java笔试</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2023/06/28/%E3%80%90%E5%B7%A5%E4%BD%9C%E6%B5%81%E3%80%91Flowable/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">【工作流】Flowable</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;Comments</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'loa9BVbgmyFLwBMHhg1Cycx1-gzGzoHsz',
                    appKey: '47pIz6ewIXRi5251WyfUpQOB',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情吐槽吧~',
                    lang: 'en'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Fang';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>
              -
            
            2023&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Fang</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.4</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#12306%E8%BF%99%E4%B8%AA%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%88%B0%E5%BA%95%E6%9C%89%E5%A4%9A%E7%89%9B%EF%BC%9F"><span class="nav-number">1.</span> <span class="nav-text">12306这个系统架构到底有多牛？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%97%E5%A4%9A%E6%B5%81%E8%A1%8C%E5%B9%B6%E5%8F%91%E9%A1%B9%E7%9B%AE%EF%BC%8C%E4%B8%BA%E4%BD%95%E9%80%89%E6%8B%A912306%EF%BC%9F"><span class="nav-number">1.1.</span> <span class="nav-text">众多流行并发项目，为何选择12306？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12306-%E6%98%AF%E5%A6%82%E4%BD%95%E6%88%90%E4%B8%BA%E5%85%A8%E7%90%83%E6%9C%80%E5%BF%99%E7%A2%8C%E7%9A%84%E7%BD%91%E7%AB%99%E4%B9%8B%E4%B8%80"><span class="nav-number">1.2.</span> <span class="nav-text">12306 是如何成为全球最忙碌的网站之一</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E8%B6%85%E5%8D%96%E3%80%81%E4%B8%8D%E5%B0%91%E5%8D%96%EF%BC%8C%E8%BF%98%E8%A6%81%E8%83%BD%E6%89%BF%E5%8F%97%E6%9E%81%E9%AB%98%E7%9A%84%E5%B9%B6%E5%8F%91%EF%BC%9F"><span class="nav-number">1.3.</span> <span class="nav-text">如何保证不超卖、不少卖，还要能承受极高的并发？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12306%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="nav-number">1.4.</span> <span class="nav-text">12306系统核心功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12306%E7%B3%BB%E7%BB%9F%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86"><span class="nav-number">1.5.</span> <span class="nav-text">12306系统功能模块划分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12306%E6%95%B4%E4%BD%93%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.6.</span> <span class="nav-text">12306整体系统架构设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12306%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="nav-number">1.7.</span> <span class="nav-text">12306系统数据库表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%99%BE%E4%B8%87%E4%BA%BA%E5%90%8C%E6%97%B6%E6%8A%A21%E4%B8%87%E5%BC%A0%E7%A5%A8%EF%BC%8C%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%85%B6%E6%AD%A3%E5%B8%B8%E5%8F%8A%E7%A8%B3%E5%AE%9A%E6%80%A7%EF%BC%9F-%E6%8C%81%E7%BB%AD%E7%A7%92%E6%9D%80%E9%AB%98%E5%B9%B6%E5%8F%91%E6%8A%80%E6%9C%AF"><span class="nav-number">1.8.</span> <span class="nav-text">百万人同时抢1万张票，系统如何保证其正常及稳定性？(持续秒杀高并发技术)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%80%E6%96%B0%E7%89%88%E7%9A%84SpringBoot3-amp-JDK9-17%E6%96%B0%E7%89%B9%E6%80%A7%E8%AF%A6%E8%A7%A3"><span class="nav-number">2.</span> <span class="nav-text">最新版的SpringBoot3&amp;JDK9~17新特性详解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK9%E6%96%B0%E7%89%B9%E6%80%A7-jshell%E4%BA%A4%E4%BA%92%E5%BC%8F%E5%B7%A5%E5%85%B7-%E5%8A%A0%E7%89%87%E5%A4%B4"><span class="nav-number">2.1.</span> <span class="nav-text">JDK9新特性-jshell交互式工具(加片头)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK9%E6%96%B0%E7%89%B9%E6%80%A7-%E6%A8%A1%E5%9D%97%E5%8C%96%E5%BC%80%E5%8F%91"><span class="nav-number">2.2.</span> <span class="nav-text">JDK9新特性-模块化开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK10%E6%96%B0%E7%89%B9%E6%80%A7-var%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E6%8E%A8%E5%AF%BC"><span class="nav-number">2.3.</span> <span class="nav-text">JDK10新特性-var局部变量推导</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK11%E6%96%B0%E7%89%B9%E6%80%A7-%E5%8D%95%E6%96%87%E4%BB%B6%E7%A8%8B%E5%BA%8F"><span class="nav-number">2.4.</span> <span class="nav-text">JDK11新特性-单文件程序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK11%E6%96%B0%E7%89%B9%E6%80%A7-shebang%E8%84%9A%E6%9C%AC"><span class="nav-number">2.5.</span> <span class="nav-text">JDK11新特性-shebang脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK14%E6%96%B0%E7%89%B9%E6%80%A7-%E6%96%87%E6%9C%AC%E5%9D%97"><span class="nav-number">2.6.</span> <span class="nav-text">JDK14新特性-文本块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK14%E6%96%B0%E7%89%B9%E6%80%A7-instanceof%E5%A2%9E%E5%BC%BA"><span class="nav-number">2.7.</span> <span class="nav-text">JDK14新特性-instanceof增强</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK14%E6%96%B0%E7%89%B9%E6%80%A7-%E7%A9%BA%E6%8C%87%E9%92%88%E6%8F%90%E7%A4%BA"><span class="nav-number">2.8.</span> <span class="nav-text">JDK14新特性-空指针提示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK16%E6%96%B0%E7%89%B9%E6%80%A7-record%E7%B1%BB"><span class="nav-number">2.9.</span> <span class="nav-text">JDK16新特性-record类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK17%E6%96%B0%E7%89%B9%E6%80%A7-sealed%E7%B1%BB"><span class="nav-number">2.10.</span> <span class="nav-text">JDK17新特性-sealed类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK17%E6%96%B0%E7%89%B9%E6%80%A7-switch%E5%A2%9E%E5%BC%BA"><span class="nav-number">2.11.</span> <span class="nav-text">JDK17新特性-switch增强</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringBoot3-AOT%E4%B8%8EJIT%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.12.</span> <span class="nav-text">SpringBoot3-AOT与JIT介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JIT%E5%9C%A8%E9%AB%98%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%AD%E7%9A%84%E7%94%9F%E4%BA%A7%E9%97%AE%E9%A2%98%E5%88%86%E4%BA%AB"><span class="nav-number">2.13.</span> <span class="nav-text">JIT在高并发场景中的生产问题分享</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringBoot3-GraalVM%E4%BB%A3%E6%9B%BFJDK%E5%AE%9E%E7%8E%B0AOT"><span class="nav-number">2.14.</span> <span class="nav-text">SpringBoot3-GraalVM代替JDK实现AOT</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%B0%E7%89%88Spring-Cloud-Alibaba%E4%B8%8ESpringbooot%E6%90%AD%E5%BB%BA%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84"><span class="nav-number">3.</span> <span class="nav-text">新版Spring Cloud Alibaba与Springbooot搭建后端架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E6%8A%8A%E6%89%8B%E5%BF%AB%E9%80%9F%E5%AE%8C%E6%88%90%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E6%90%AD%E5%BB%BA-%E5%8A%A0%E7%89%87%E5%A4%B4"><span class="nav-number">3.1.</span> <span class="nav-text">手把手快速完成微服务架构的搭建(加片头)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="nav-number">3.2.</span> <span class="nav-text">项目初始化配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%85%B3%E8%81%94Git%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93"><span class="nav-number">3.3.</span> <span class="nav-text">实现代码关联Git远程仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B0%E5%A2%9Emember%E4%BC%9A%E5%91%98%E6%A8%A1%E5%9D%97"><span class="nav-number">3.4.</span> <span class="nav-text">新增member会员模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%97%A5%E5%BF%97%E7%9A%84%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="nav-number">3.5.</span> <span class="nav-text">实现日志的相关配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8HTTP-Client%E5%AE%8C%E6%88%90%E6%B5%8B%E8%AF%95%E6%8E%A5%E5%8F%A3"><span class="nav-number">3.6.</span> <span class="nav-text">使用HTTP Client完成测试接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0AOP%E6%89%93%E5%8D%B0%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E5%92%8C%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C"><span class="nav-number">3.7.</span> <span class="nav-text">增加AOP打印请求参数和返回结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%A2%9E%E5%8A%A0%E9%80%9A%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="nav-number">3.8.</span> <span class="nav-text">详解项目中增加通用模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%A2%9E%E5%8A%A0%E7%BD%91%E5%85%B3%E6%A8%A1%E5%9D%97"><span class="nav-number">3.9.</span> <span class="nav-text">详解项目中增加网关模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E6%9C%AC%E5%9C%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">3.10.</span> <span class="nav-text">详解本地数据库的准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E9%98%BF%E9%87%8C%E4%BA%91RDS%E7%9A%84%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">3.11.</span> <span class="nav-text">详解阿里云RDS的准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8IDEA%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5"><span class="nav-number">3.12.</span> <span class="nav-text">使用IDEA配置数据库连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E6%88%90Mybatis%E6%8C%81%E4%B9%85%E5%B1%82%E6%A1%86%E6%9E%B6"><span class="nav-number">3.13.</span> <span class="nav-text">集成Mybatis持久层框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E6%88%90Mybatis%E5%AE%98%E6%96%B9%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-number">3.14.</span> <span class="nav-text">集成Mybatis官方生成器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%88%90%E4%BC%9A%E5%91%98%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%BC%80%E5%8F%91"><span class="nav-number">3.15.</span> <span class="nav-text">完成会员注册接口的开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%81%E8%A3%85%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E5%92%8C%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C"><span class="nav-number">3.16.</span> <span class="nav-text">封装请求参数和返回结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E9%A1%B9%E7%9B%AE%E5%A2%9E%E5%8A%A0%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">3.17.</span> <span class="nav-text">为项目增加统一异常处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8%E4%B8%9A%E5%8A%A1"><span class="nav-number">3.18.</span> <span class="nav-text">使用自定义异常处理异常业务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E6%88%90%E6%A0%A1%E9%AA%8C%E6%A1%86%E6%9E%B6Validation"><span class="nav-number">3.19.</span> <span class="nav-text">集成校验框架Validation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95"><span class="nav-number">3.20.</span> <span class="nav-text">详解雪花算法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Vue3-Vue-CLI-%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E5%89%8D%E7%AB%AF%E6%A8%A1%E5%9D%97%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="nav-number">4.</span> <span class="nav-text">使用Vue3 + Vue CLI 实现系统前端模块的搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">4.1.</span> <span class="nav-text">本地环境准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E6%8A%8A%E6%89%8B%E5%88%9B%E5%BB%BA%E5%9F%BA%E4%BA%8EVue-CLI%E7%9A%84web%E6%A8%A1%E5%9D%97"><span class="nav-number">4.2.</span> <span class="nav-text">手把手创建基于Vue CLI的web模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#web%E6%A8%A1%E5%9D%97%E9%9B%86%E6%88%90Ant-Design-Vue"><span class="nav-number">4.3.</span> <span class="nav-text">web模块集成Ant Design Vue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E8%AE%B2%E8%A7%A3"><span class="nav-number">4.4.</span> <span class="nav-text">短信验证码登录流程讲解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E4%BA%8C%E5%90%88%E4%B8%80%E7%95%8C%E9%9D%A2%E5%BC%80%E5%8F%91"><span class="nav-number">4.5.</span> <span class="nav-text">注册登录二合一界面开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="nav-number">4.6.</span> <span class="nav-text">发送短信验证码接口开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="nav-number">4.7.</span> <span class="nav-text">短信验证码登录接口开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E6%88%90Axios%E5%AE%8C%E6%88%90%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="nav-number">4.8.</span> <span class="nav-text">集成Axios完成登录功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0Axios%E6%8B%A6%E6%88%AA%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">4.9.</span> <span class="nav-text">增加Axios拦截器配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vue-CLI%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-number">4.10.</span> <span class="nav-text">Vue CLI多环境配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0web%E6%8E%A7%E5%8F%B0%E4%B8%BB%E9%A1%B5"><span class="nav-number">4.11.</span> <span class="nav-text">增加web控台主页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%B6%E4%BD%9CVue3%E5%85%AC%E5%85%B1%E7%BB%84%E4%BB%B6"><span class="nav-number">4.12.</span> <span class="nav-text">制作Vue3公共组件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0JWT%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="nav-number">5.</span> <span class="nav-text">实现JWT单点登录功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D%E4%B8%A4%E7%A7%8D%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1"><span class="nav-number">5.1.</span> <span class="nav-text">介绍两种单点登录方案设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JWT%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E8%AE%B2%E8%A7%A3"><span class="nav-number">5.2.</span> <span class="nav-text">JWT单点登录原理与存在的问题及解决方案讲解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E7%94%9F%E6%88%90JWT%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95token"><span class="nav-number">5.3.</span> <span class="nav-text">详解生成JWT单点登录token</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8vuex%E4%BF%9D%E5%AD%98%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF"><span class="nav-number">5.4.</span> <span class="nav-text">使用vuex保存登录信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vuex%E9%85%8D%E5%90%88h5%E7%9A%84session%E8%A7%A3%E5%86%B3%E6%B5%8F%E8%A7%88%E5%99%A8%E5%88%B7%E6%96%B0%E9%97%AE%E9%A2%98"><span class="nav-number">5.5.</span> <span class="nav-text">vuex配合h5的session解决浏览器刷新问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%94%E7%A4%BAgateway%E6%8B%A6%E6%88%AA%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">5.6.</span> <span class="nav-text">演示gateway拦截器的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BAgateway%E5%A2%9E%E5%8A%A0%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">5.7.</span> <span class="nav-text">为gateway增加登录校验拦截器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BAaxios%E8%AF%B7%E6%B1%82%E5%A2%9E%E5%8A%A0%E7%BB%9F%E4%B8%80%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">5.8.</span> <span class="nav-text">为axios请求增加统一拦截器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E8%B7%AF%E7%94%B1%E9%A1%B5%E9%9D%A2%E5%A2%9E%E5%8A%A0%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA"><span class="nav-number">5.9.</span> <span class="nav-text">为路由页面增加登录拦截</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#12306%E7%B3%BB%E7%BB%9F%E4%BC%9A%E5%91%98%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.</span> <span class="nav-text">12306系统会员基础功能的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E4%B9%98%E8%BD%A6%E4%BA%BA%E8%A1%A8%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">6.1.</span> <span class="nav-text">详解乘车人表的设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E6%96%B0%E5%A2%9E%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="nav-number">6.2.</span> <span class="nav-text">乘车人新增接口开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8HttpClient%E4%BF%9D%E5%AD%98%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF"><span class="nav-number">6.3.</span> <span class="nav-text">使用HttpClient保存登录信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%9C%AC%E5%9C%B0%E5%8F%98%E9%87%8F%E5%AD%98%E5%82%A8%E4%BC%9A%E5%91%98%E4%BF%A1%E6%81%AF"><span class="nav-number">6.4.</span> <span class="nav-text">使用线程本地变量存储会员信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF%E4%BA%8C%E7%BA%A7%E8%B7%AF%E7%94%B1%E9%A1%B5%E9%9D%A2%E5%BC%80%E5%8F%91"><span class="nav-number">6.5.</span> <span class="nav-text">前端二级路由页面开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E6%96%B0%E5%A2%9E%E7%95%8C%E9%9D%A2%E5%BC%80%E5%8F%91"><span class="nav-number">6.6.</span> <span class="nav-text">乘车人新增界面开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E5%88%97%E8%A1%A8%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="nav-number">6.7.</span> <span class="nav-text">乘车人列表查询接口开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E6%88%90PageHelper%E5%AE%9E%E7%8E%B0%E5%90%8E%E7%AB%AF%E5%88%86%E9%A1%B5"><span class="nav-number">6.8.</span> <span class="nav-text">集成PageHelper实现后端分页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E5%88%97%E8%A1%A8%E6%9F%A5%E8%AF%A2%E7%95%8C%E9%9D%A2%E5%BC%80%E5%8F%91"><span class="nav-number">6.9.</span> <span class="nav-text">乘车人列表查询界面开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3Long%E7%B1%BB%E5%9E%8B%E7%B2%BE%E5%BA%A6%E4%B8%A2%E5%A4%B1%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">6.10.</span> <span class="nav-text">解决Long类型精度丢失的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E7%BC%96%E8%BE%91%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="nav-number">6.11.</span> <span class="nav-text">乘车人编辑接口开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E7%BC%96%E8%BE%91%E7%95%8C%E9%9D%A2%E5%BC%80%E5%8F%91"><span class="nav-number">6.12.</span> <span class="nav-text">乘车人编辑界面开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E5%88%A0%E9%99%A4%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="nav-number">6.13.</span> <span class="nav-text">乘车人删除接口开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%98%E8%BD%A6%E4%BA%BA%E5%88%A0%E9%99%A4%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="nav-number">6.14.</span> <span class="nav-text">乘车人删除功能开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF%E6%9E%9A%E4%B8%BE%E5%B1%95%E7%A4%BA%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.15.</span> <span class="nav-text">前端枚举展示的解决方案介绍</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%87%AA%E5%88%B6%E5%89%8D%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8%E6%8F%90%E9%AB%98%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87"><span class="nav-number">7.</span> <span class="nav-text">自制前后端代码生成器提高开发效率</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%96%E6%9E%90%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="nav-number">7.1.</span> <span class="nav-text">剖析代码生成器的底层原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E6%88%90DOM4j%E8%AF%BB%E5%8F%96xml"><span class="nav-number">7.2.</span> <span class="nav-text">集成DOM4j读取xml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3Service%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-number">7.3.</span> <span class="nav-text">详解Service生成器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3Controller%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-number">7.4.</span> <span class="nav-text">详解Controller生成器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%B6%E4%BD%9CDBUtil%E8%AF%BB%E5%8F%96%E8%A1%A8%E5%AD%97%E6%AE%B5%E4%BF%A1%E6%81%AF"><span class="nav-number">7.5.</span> <span class="nav-text">制作DBUtil读取表字段信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E5%AE%9E%E4%BD%93%E7%B1%BB%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-number">7.6.</span> <span class="nav-text">详解实体类生成器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%89%E6%A8%A1%E5%9D%97%E7%94%9F%E6%88%90%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="nav-number">7.7.</span> <span class="nav-text">按模块生成后端代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3vue%E7%95%8C%E9%9D%A2%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-number">7.8.</span> <span class="nav-text">详解vue界面生成器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E5%89%8D%E7%AB%AF%E6%9E%9A%E4%B8%BE%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-number">7.9.</span> <span class="nav-text">详解前端枚举代码生成器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8%E5%BF%AB%E9%80%9F%E5%AE%9E%E7%8E%B0%E7%81%AB%E8%BD%A6%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%9A%84%E7%BB%B4%E6%8A%A4"><span class="nav-number">8.</span> <span class="nav-text">利用代码生成器快速实现火车基础数据的维护</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%8D%A2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93"><span class="nav-number">8.1.</span> <span class="nav-text">更换远程代码仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%A2%9E%E5%8A%A0admin%E6%8E%A7%E5%8F%B0%E6%A8%A1%E5%9D%97"><span class="nav-number">8.2.</span> <span class="nav-text">项目中增加admin控台模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%A2%9E%E5%8A%A0business%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97"><span class="nav-number">8.3.</span> <span class="nav-text">项目中增加business业务模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BAbusiness%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE%E6%8C%81%E4%B9%85%E5%B1%82%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-number">8.4.</span> <span class="nav-text">为business模块配置持久层生成器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E8%BD%A6%E7%AB%99%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE"><span class="nav-number">8.5.</span> <span class="nav-text">快速生成车站基础数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E7%81%AB%E8%BD%A6%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="nav-number">8.6.</span> <span class="nav-text">快速生成火车基础数据管理功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E7%81%AB%E8%BD%A6%E8%BD%A6%E7%AB%99%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="nav-number">8.7.</span> <span class="nav-text">快速生成火车车站基础数据管理功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E7%81%AB%E8%BD%A6%E8%BD%A6%E5%8E%A2%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="nav-number">8.8.</span> <span class="nav-text">快速生成火车车厢基础数据管理功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E7%81%AB%E8%BD%A6%E5%BA%A7%E4%BD%8D%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="nav-number">8.9.</span> <span class="nav-text">快速生成火车座位基础数据管理功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8pinyin-pro%E5%B0%86%E6%B1%89%E5%AD%97%E8%BD%AC%E6%88%90%E6%8B%BC%E9%9F%B3"><span class="nav-number">8.10.</span> <span class="nav-text">使用pinyin-pro将汉字转成拼音</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%A6%E6%AC%A1%E8%A1%A8%E5%8D%95%E5%A2%9E%E5%8A%A0%E8%BD%A6%E7%AB%99%E4%B8%8B%E6%8B%89%E9%80%89%E6%8B%A9"><span class="nav-number">8.11.</span> <span class="nav-text">车次表单增加车站下拉选择</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%B6%E4%BD%9C%E8%BD%A6%E6%AC%A1%E4%B8%8B%E6%8B%89%E6%A1%86%E7%BB%84%E4%BB%B6"><span class="nav-number">8.12.</span> <span class="nav-text">制作车次下拉框组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%B6%E4%BD%9C%E8%BD%A6%E7%AB%99%E4%B8%8B%E6%8B%89%E6%A1%86%E7%BB%84%E4%BB%B6%EF%BC%88Station%EF%BC%89"><span class="nav-number">8.13.</span> <span class="nav-text">制作车站下拉框组件（Station）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%8A%A0%E8%BD%A6%E6%AC%A1%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6"><span class="nav-number">8.14.</span> <span class="nav-text">为基础数据增加车次查询条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%8C%89%E8%BD%A6%E6%AC%A1%E7%94%9F%E6%88%90%E8%BD%A6%E5%BA%A7%E5%8A%9F%E8%83%BD"><span class="nav-number">8.15.</span> <span class="nav-text">实现按车次生成车座功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E5%96%84%E8%BD%A6%E6%AC%A1-amp-%E8%BD%A6%E5%8E%A2-amp-%E5%BA%A7%E4%BD%8D%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="nav-number">8.16.</span> <span class="nav-text">完善车次&amp;车厢&amp;座位管理功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E8%BD%A6%E6%AC%A1-amp-%E8%BD%A6%E5%8E%A2-amp-%E8%BD%A6%E7%AB%99%E5%A2%9E%E5%8A%A0%E5%AD%98%E5%9C%A8%E6%80%A7%E6%A0%A1%E9%AA%8C"><span class="nav-number">8.17.</span> <span class="nav-text">为车次&amp;车厢&amp;车站增加存在性校验</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6quartz%EF%BC%8C%E4%B8%BA12306%E7%B3%BB%E7%BB%9F%E5%A2%9E%E5%8A%A0%E5%AE%9A%E6%97%B6%E8%B0%83%E5%BA%A6%E5%8A%9F%E8%83%BD"><span class="nav-number">9.</span> <span class="nav-text">使用调度框架quartz，为12306系统增加定时调度功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%A2%9E%E5%8A%A0batch%E5%AE%9A%E6%97%B6%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97"><span class="nav-number">9.1.</span> <span class="nav-text">项目中增加batch定时调度模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BAbatch%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE%E6%8C%81%E4%B9%85%E5%B1%82%E7%94%9F%E6%88%90%E5%99%A8"><span class="nav-number">9.2.</span> <span class="nav-text">为batch模块配置持久层生成器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%94%E7%A4%BASpringboot%E8%87%AA%E5%B8%A6%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="nav-number">9.3.</span> <span class="nav-text">演示Springboot自带的定时任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E6%97%B6%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97%E9%9B%86%E6%88%90quartz"><span class="nav-number">9.4.</span> <span class="nav-text">定时调度模块集成quartz</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E8%B0%83%E5%BA%A6%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C"><span class="nav-number">9.5.</span> <span class="nav-text">关于调度任务的并发执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AEquartz%E8%B0%83%E5%BA%A6%E4%BB%BB%E5%8A%A1"><span class="nav-number">9.6.</span> <span class="nav-text">使用数据库配置quartz调度任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E6%8E%A7%E5%8F%B0%E7%95%8C%E9%9D%A2%E6%93%8D%E4%BD%9C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="nav-number">9.7.</span> <span class="nav-text">通过控台界面操作定时任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E4%BB%BB%E5%8A%A1%E6%89%8B%E5%B7%A5%E8%A1%A5%E5%81%BF%E5%8A%9F%E8%83%BD"><span class="nav-number">9.8.</span> <span class="nav-text">增加任务手工补偿功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%94%E7%A4%BA%E5%A4%9A%E8%8A%82%E7%82%B9%E5%9C%BA%E6%99%AF%E4%B8%ADquartz%E7%9A%84%E8%B0%83%E5%BA%A6%E6%83%85%E5%86%B5"><span class="nav-number">9.9.</span> <span class="nav-text">演示多节点场景中quartz的调度情况</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E7%81%AB%E8%BD%A6%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90%E6%AF%8F%E6%97%A5%E7%81%AB%E8%BD%A6%E6%95%B0%E6%8D%AE"><span class="nav-number">10.</span> <span class="nav-text">通过火车基础数据生成每日火车数据</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E7%AB%A0%E4%B8%BB%E8%A6%81%E5%86%85%E5%AE%B9"><span class="nav-number">10.1.</span> <span class="nav-text">本章主要内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E6%AF%8F%E6%97%A5%E8%BD%A6%E6%AC%A1%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="nav-number">10.2.</span> <span class="nav-text">快速生成每日车次数据管理功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E5%96%84%E6%AF%8F%E6%97%A5%E8%BD%A6%E6%AC%A1%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2%E5%8A%9F%E8%83%BD"><span class="nav-number">10.3.</span> <span class="nav-text">完善每日车次管理页面功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E6%AF%8F%E6%97%A5%E8%BD%A6%E7%AB%99%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="nav-number">10.4.</span> <span class="nav-text">快速生成每日车站数据管理功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E6%AF%8F%E6%97%A5%E8%BD%A6%E5%8E%A2%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="nav-number">10.5.</span> <span class="nav-text">快速生成每日车厢数据管理功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E6%AF%8F%E6%97%A5%E5%BA%A7%E4%BD%8D%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="nav-number">10.6.</span> <span class="nav-text">快速生成每日座位数据管理功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E7%94%9F%E6%88%90%E6%AF%8F%E6%97%A5%E8%BD%A6%E6%AC%A1%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="nav-number">10.7.</span> <span class="nav-text">增加生成每日车次定时任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E6%88%90OpenFeign%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%B0%83%E7%94%A8"><span class="nav-number">10.8.</span> <span class="nav-text">集成OpenFeign实现服务间调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E7%94%9F%E6%88%90%E6%AF%8F%E6%97%A5%E8%BD%A6%E6%AC%A1%E5%8A%9F%E8%83%BD"><span class="nav-number">10.9.</span> <span class="nav-text">增加生成每日车次功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E7%94%9F%E6%88%90%E6%AF%8F%E6%97%A5%E8%BD%A6%E7%AB%99%E5%8A%9F%E8%83%BD"><span class="nav-number">10.10.</span> <span class="nav-text">增加生成每日车站功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E7%94%9F%E6%88%90%E6%AF%8F%E6%97%A5%E8%BD%A6%E5%8E%A2%E5%8A%9F%E8%83%BD"><span class="nav-number">10.11.</span> <span class="nav-text">增加生成每日车厢功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E7%94%9F%E6%88%90%E6%AF%8F%E6%97%A5%E5%BA%A7%E4%BD%8D%E5%8A%9F%E8%83%BD"><span class="nav-number">10.12.</span> <span class="nav-text">增加生成每日座位功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E6%89%8B%E5%8A%A8%E7%94%9F%E6%88%90%E6%9F%90%E6%97%A5%E8%BD%A6%E6%AC%A1%E6%95%B0%E6%8D%AE%E5%8A%9F%E8%83%BD"><span class="nav-number">10.13.</span> <span class="nav-text">增加手动生成某日车次数据功能</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E8%BD%A6%E7%A5%A8%E9%A2%84%E5%AE%9A%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="nav-number">11.</span> <span class="nav-text">基本的车票预定功能开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E4%BD%99%E7%A5%A8%E4%BF%A1%E6%81%AF%E8%A1%A8%E4%BB%A5%E6%8F%90%E9%AB%98%E4%BD%99%E7%A5%A8%E6%9F%A5%E8%AF%A2%E6%95%88%E7%8E%87"><span class="nav-number">11.1.</span> <span class="nav-text">增加余票信息表以提高余票查询效率</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E8%BD%A6%E6%AC%A1%E6%97%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BD%99%E7%A5%A8%E4%BF%A1%E6%81%AF"><span class="nav-number">11.2.</span> <span class="nav-text">生成车次时初始化余票信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BD%99%E7%A5%A8%E4%BF%A1%E6%81%AF%E9%A1%B5%E9%9D%A2%E5%A2%9E%E5%8A%A0%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6"><span class="nav-number">11.3.</span> <span class="nav-text">为余票信息页面增加查询条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BC%9A%E5%91%98%E7%AB%AF%E5%A2%9E%E4%BD%99%E7%A5%A8%E6%9F%A5%E8%AF%A2%E5%8A%9F%E8%83%BD"><span class="nav-number">11.4.</span> <span class="nav-text">为会员端增余票查询功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E8%AE%A2%E7%A5%A8%E9%A1%B5%E9%9D%A2%E5%B9%B6%E5%AE%9E%E7%8E%B0%E8%BD%A6%E6%AC%A1%E4%BF%A1%E6%81%AF%E4%BC%A0%E9%80%92"><span class="nav-number">11.5.</span> <span class="nav-text">增加订票页面并实现车次信息传递</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A2%E7%A5%A8%E9%A1%B5%E9%9D%A2%E5%8B%BE%E9%80%89%E4%B9%98%E5%AE%A2%E5%B9%B6%E6%98%BE%E7%A4%BA%E8%B4%AD%E7%A5%A8%E5%88%97%E8%A1%A8"><span class="nav-number">11.6.</span> <span class="nav-text">订票页面勾选乘客并显示购票列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E8%A7%A3%E9%80%89%E5%BA%A7%E8%B4%AD%E7%A5%A8%E5%8A%9F%E8%83%BD%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E9%80%BB%E8%BE%91"><span class="nav-number">11.7.</span> <span class="nav-text">分解选座购票功能的前后端逻辑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A2%E7%A5%A8%E9%A1%B5%E9%9D%A2%E5%A2%9E%E5%8A%A0%E9%80%89%E5%BA%A7%E6%95%88%E6%9E%9C"><span class="nav-number">11.8.</span> <span class="nav-text">订票页面增加选座效果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E7%A1%AE%E8%AE%A4%E8%AE%A2%E5%8D%95%E8%A1%A8%E5%B9%B6%E7%94%9F%E6%88%90%E5%89%8D%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="nav-number">11.9.</span> <span class="nav-text">增加确认订单表并生成前后端代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E5%A2%9E%E5%8A%A0%E7%A1%AE%E8%AE%A4%E4%B8%8B%E5%8D%95%E8%B4%AD%E7%A5%A8%E6%8E%A5%E5%8F%A3"><span class="nav-number">11.10.</span> <span class="nav-text">后端增加确认下单购票接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AE%E8%AE%A4%E4%B8%8B%E5%8D%95%E6%8E%A5%E5%8F%A3%E6%95%B0%E6%8D%AE%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">11.11.</span> <span class="nav-text">确认下单接口数据初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A2%84%E6%89%A3%E5%87%8F%E5%BA%93%E5%AD%98%E5%B9%B6%E5%88%A4%E6%96%AD%E4%BD%99%E7%A5%A8%E6%98%AF%E5%90%A6%E8%B6%B3%E5%A4%9F"><span class="nav-number">11.12.</span> <span class="nav-text">预扣减库存并判断余票是否足够</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E5%A4%9A%E4%B8%AA%E9%80%89%E5%BA%A7%E4%B9%8B%E9%97%B4%E7%9A%84%E5%81%8F%E7%A7%BB%E5%80%BC"><span class="nav-number">11.13.</span> <span class="nav-text">计算多个选座之间的偏移值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E8%8E%B7%E5%8F%96%E6%AF%8F%E4%B8%AA%E8%BD%A6%E5%8E%A2%E7%9A%84%E6%AF%8F%E4%B8%AA%E5%BA%A7%E4%BD%8D"><span class="nav-number">11.14.</span> <span class="nav-text">循环获取每个车厢的每个座位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E5%BA%A7%E4%BD%8D%E9%94%80%E5%94%AE%E8%AF%A6%E6%83%85%E5%88%A4%E6%96%AD%E6%9C%AC%E6%AC%A1%E6%98%AF%E5%90%A6%E5%8F%AF%E9%80%89"><span class="nav-number">11.15.</span> <span class="nav-text">根据座位销售详情判断本次是否可选</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%88%90%E6%9C%89%E9%80%89%E5%BA%A7%E7%9A%84%E6%8C%91%E5%BA%A7%E4%BD%8D%E9%80%BB%E8%BE%91"><span class="nav-number">11.16.</span> <span class="nav-text">完成有选座的挑座位逻辑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%9D%E5%AD%98%E6%9C%80%E7%BB%88%E7%9A%84%E9%80%89%E5%BA%A7%E7%BB%93%E6%9E%9C"><span class="nav-number">11.17.</span> <span class="nav-text">保存最终的选座结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E5%BA%A7%E6%88%90%E5%8A%9F%E5%90%8E%E6%9B%B4%E6%96%B0%E5%90%84%E5%BA%A7%E4%BD%8D%E7%9A%84%E9%94%80%E5%94%AE%E8%AF%A6%E6%83%85"><span class="nav-number">11.18.</span> <span class="nav-text">选座成功后更新各座位的销售详情</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E5%BA%A7%E6%88%90%E5%8A%9F%E5%90%8E%E6%89%B9%E9%87%8F%E6%89%A3%E5%87%8F%E5%BD%B1%E5%93%8D%E5%88%B0%E7%9A%84%E5%A4%9A%E4%B8%AA%E5%BA%93%E5%AD%98"><span class="nav-number">11.19.</span> <span class="nav-text">选座成功后批量扣减影响到的多个库存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E5%BA%A7%E6%88%90%E5%8A%9F%E5%90%8E%E4%BC%9A%E4%BC%9A%E5%91%98%E5%A2%9E%E5%8A%A0%E8%BD%A6%E7%A5%A8%E8%AE%B0%E5%BD%95"><span class="nav-number">11.20.</span> <span class="nav-text">选座成功后会会员增加车票记录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E5%BA%A7%E6%88%90%E5%8A%9F%E5%90%8E%E6%9B%B4%E6%96%B0%E7%A1%AE%E8%AE%A4%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E4%B8%BA%E6%88%90%E5%8A%9F"><span class="nav-number">11.21.</span> <span class="nav-text">选座成功后更新确认订单状态为成功</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%95%AA%E5%A4%96"><span class="nav-number">11.22.</span> <span class="nav-text">番外</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%86%E6%88%90%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E4%B8%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E7%BB%84%E4%BB%B6Nacos%EF%BC%88%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9%E7%BA%BF%E4%B8%8A%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%89"><span class="nav-number">12.</span> <span class="nav-text">集成注册中心与配置中心组件Nacos（动态修改线上的配置）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E7%AB%A0%E4%BB%8B%E7%BB%8D"><span class="nav-number">12.1.</span> <span class="nav-text">本章介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="nav-number">12.2.</span> <span class="nav-text">Nacos快速开始</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%BC%94%E7%A4%BA"><span class="nav-number">12.3.</span> <span class="nav-text">Nacos配置中心演示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E6%BC%94%E7%A4%BA"><span class="nav-number">12.4.</span> <span class="nav-text">Nacos多环境配置演示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E5%88%A9%E7%94%A8%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%81%9A%E9%A1%B9%E7%9B%AE%E9%9A%94%E7%A6%BB"><span class="nav-number">12.5.</span> <span class="nav-text">Nacos利用命名空间做项目隔离</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%BC%94%E7%A4%BA"><span class="nav-number">12.6.</span> <span class="nav-text">Nacos注册中心演示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEGateway-Nacos%E6%94%AF%E6%8C%81%E5%BA%94%E7%94%A8%E5%90%8D%E8%B7%AF%E7%94%B1%E8%BD%AC%E5%8F%91"><span class="nav-number">12.7.</span> <span class="nav-text">配置Gateway+Nacos支持应用名路由转发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEFeign-Nacos%E6%94%AF%E6%8C%81%E5%BA%94%E7%94%A8%E5%90%8D%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="nav-number">12.8.</span> <span class="nav-text">配置Feign+Nacos支持应用名远程调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E6%8C%82%E4%BA%86%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="nav-number">12.9.</span> <span class="nav-text">Nacos挂了怎么办</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AB%98%E6%80%A7%E8%83%BD%E4%BD%99%E7%A5%A8%E6%9F%A5%E8%AF%A2%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%88%E5%89%8D%E7%AB%AF%E7%BC%93%E5%AD%98-amp-%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98-amp-%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%EF%BC%89"><span class="nav-number">13.</span> <span class="nav-text">高性能余票查询的实现（前端缓存&amp;本地缓存&amp;分布式缓存）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E7%AB%A0%E4%BB%8B%E7%BB%8D-1"><span class="nav-number">13.1.</span> <span class="nav-text">本章介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3Mybatis%E7%9A%84%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-number">13.2.</span> <span class="nav-text">详解Mybatis的一级缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3Mybatis%E7%9A%84%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-number">13.3.</span> <span class="nav-text">详解Mybatis的二级缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3SpringBoot%E5%86%85%E7%BD%AE%E7%BC%93%E5%AD%98"><span class="nav-number">13.4.</span> <span class="nav-text">详解SpringBoot内置缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringBoot%E6%95%B4%E5%90%88redis%E7%BC%93%E5%AD%98"><span class="nav-number">13.5.</span> <span class="nav-text">SpringBoot整合redis缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">13.6.</span> <span class="nav-text">详解缓存击穿与解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">13.7.</span> <span class="nav-text">详解缓存穿透与解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">13.8.</span> <span class="nav-text">详解缓存雪崩与解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E5%9C%A8%E9%AB%98%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%AD%E7%9A%84%E7%94%9F%E4%BA%A7%E9%97%AE%E9%A2%98%E5%88%86%E4%BA%AB"><span class="nav-number">13.9.</span> <span class="nav-text">缓存在高并发场景中的生产问题分享</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF%E7%BC%93%E5%AD%98%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">13.10.</span> <span class="nav-text">前端缓存的使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%86%E6%88%90%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%BB%84%E4%BB%B6Seata%EF%BC%88%E8%A7%A3%E5%86%B3%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%EF%BC%89"><span class="nav-number">14.</span> <span class="nav-text">集成分布式事务组件Seata（解决分布式系统中的数据一致性问题）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E8%AF%86Seata"><span class="nav-number">14.1.</span> <span class="nav-text">初识Seata</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%B2%E8%A7%A3Seata%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">14.2.</span> <span class="nav-text">讲解Seata分布式事务的原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%B2%E8%A7%A3Seata%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%A8%A1%E5%BC%8F"><span class="nav-number">14.3.</span> <span class="nav-text">讲解Seata分布式事务的四种模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%88%9D%E4%BD%93%E9%AA%8C"><span class="nav-number">14.4.</span> <span class="nav-text">Seata分布式事务初体验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata-Server%E9%85%8D%E7%BD%AENacos"><span class="nav-number">14.5.</span> <span class="nav-text">Seata Server配置Nacos</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata-Client%E9%85%8D%E7%BD%AENacos"><span class="nav-number">14.6.</span> <span class="nav-text">Seata Client配置Nacos</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata%E5%92%8CMysql%E5%AD%98%E5%82%A8%E6%BC%94%E7%A4%BA"><span class="nav-number">14.7.</span> <span class="nav-text">Seata和Mysql存储演示</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E6%8A%A2%E7%A5%A8%E6%97%B6%EF%BC%8C%E5%88%A9%E7%94%A8%E5%90%84%E7%A7%8D%E9%94%81%E8%A7%A3%E5%86%B3%E8%BD%A6%E7%A5%A8%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98%EF%BC%88JDK%E9%94%81-amp-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-amp-%E7%9C%8B%E9%97%A8%E7%8B%97%E8%AE%BE%E8%AE%A1-amp-%E7%BA%A2%E9%94%81%EF%BC%89"><span class="nav-number">15.</span> <span class="nav-text">高并发抢票时，利用各种锁解决车票超卖问题（JDK锁&amp;分布式锁&amp;看门狗设计&amp;红锁）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E7%AB%A0%E4%BB%8B%E7%BB%8D-2"><span class="nav-number">15.1.</span> <span class="nav-text">本章介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JMeter%E5%88%9D%E4%BD%93%E9%AA%8C"><span class="nav-number">15.2.</span> <span class="nav-text">JMeter初体验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B6%85%E5%8D%96%E6%BC%94%E7%A4%BA-amp-%E4%BD%BF%E7%94%A8JMeter%E5%AF%B9%E8%B4%AD%E7%A5%A8%E5%8A%9F%E8%83%BD%E8%BF%9B%E8%A1%8C%E5%8E%8B%E6%B5%8B"><span class="nav-number">15.3.</span> <span class="nav-text">超卖演示&amp;使用JMeter对购票功能进行压测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8synchronized%E6%98%AF%E5%90%A6%E8%83%BD%E8%A7%A3%E5%86%B3%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96%EF%BC%9F"><span class="nav-number">15.4.</span> <span class="nav-text">使用synchronized是否能解决库存超卖？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%98%AF%E5%90%A6%E8%83%BD%E8%A7%A3%E5%86%B3%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96%EF%BC%9F"><span class="nav-number">15.5.</span> <span class="nav-text">使用Redis分布式锁是否能解决库存超卖？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Redisson%E7%9C%8B%E9%97%A8%E7%8B%97%E8%A7%A3%E5%86%B3%E9%94%81%E8%B6%85%E6%97%B6%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">15.6.</span> <span class="nav-text">使用Redisson看门狗解决锁超时的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8DRedis%E7%BA%A2%E9%94%81"><span class="nav-number">15.7.</span> <span class="nav-text">介绍Redis红锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E7%AB%A0%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96"><span class="nav-number">15.8.</span> <span class="nav-text">本章代码优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JMeter%E7%BA%BF%E7%A8%8B%E7%BB%84%E4%B9%8B%E9%97%B4%E4%BC%A0%E9%80%92token%E5%8F%98%E9%87%8F"><span class="nav-number">15.9.</span> <span class="nav-text">JMeter线程组之间传递token变量</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E6%8A%A2%E7%A5%A8%E6%97%B6%EF%BC%8C%E4%BD%BF%E7%94%A8Sentinal%E7%BB%84%E4%BB%B6%E8%BF%9B%E8%A1%8C%E8%AF%B7%E6%B1%82%E9%99%90%E6%B5%81%E9%99%8D%E7%BA%A7%EF%BC%88%E8%BF%87%E6%BB%A490-%E7%9A%84%E6%97%A0%E6%95%88%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="nav-number">16.</span> <span class="nav-text">高并发抢票时，使用Sentinal组件进行请求限流降级（过滤90%的无效请求）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E7%AB%A0%E4%BB%8B%E7%BB%8D-3"><span class="nav-number">16.1.</span> <span class="nav-text">本章介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95"><span class="nav-number">16.2.</span> <span class="nav-text">常见的限流算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E8%AF%86Sentinel"><span class="nav-number">16.3.</span> <span class="nav-text">初识Sentinel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Sentinel%E6%8E%A7%E5%8F%B0%E7%9B%91%E6%8E%A7%E6%B5%81%E9%87%8F"><span class="nav-number">16.4.</span> <span class="nav-text">使用Sentinel控台监控流量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Sentinel%E9%85%8D%E7%BD%AE%E9%99%90%E6%B5%81"><span class="nav-number">16.5.</span> <span class="nav-text">使用Sentinel配置限流</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-Nacos%E5%AE%9E%E7%8E%B0%E9%99%90%E6%B5%81%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">16.6.</span> <span class="nav-text">Sentinel+Nacos实现限流规则持久化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel%E9%99%90%E6%B5%81%E4%B8%8D%E5%90%8C%E7%9A%84%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C%E8%AE%B2%E8%A7%A3-Warm-Up-amp-%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="nav-number">16.7.</span> <span class="nav-text">Sentinel限流不同的流控效果讲解 - Warm Up&amp;排队等待</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel%E9%99%90%E6%B5%81%E4%B8%8D%E5%90%8C%E7%9A%84%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F%E8%AE%B2%E8%A7%A3-%E5%85%B3%E8%81%94-amp-%E9%93%BE%E8%B7%AF"><span class="nav-number">16.8.</span> <span class="nav-text">Sentinel限流不同的流控模式讲解 - 关联&amp;链路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-Feign%E7%86%94%E6%AE%B5%E5%88%9D%E4%BD%93%E9%AA%8C"><span class="nav-number">16.9.</span> <span class="nav-text">Sentinel+Feign熔段初体验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-Feign%E7%86%94%E6%96%AD%E5%90%8E%E7%9A%84%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86"><span class="nav-number">16.10.</span> <span class="nav-text">Sentinel+Feign熔断后的降级处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE%E6%BC%94%E7%A4%BA"><span class="nav-number">16.11.</span> <span class="nav-text">Sentinel熔断规则配置演示</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E6%8A%A2%E7%A5%A8%E6%97%B6%EF%BC%8C%E9%98%B2%E6%AD%A2%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%88%B7%E7%A5%A8%E7%9A%84%E4%BB%A4%E7%89%8C%E5%A4%A7%E9%97%B8%EF%BC%8C%E5%8F%AF%E5%87%8F%E8%BD%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%8E%8B%E5%8A%9B%EF%BC%88%E9%98%B2%E5%88%B7-%E9%99%90%E6%B5%81%EF%BC%89"><span class="nav-number">17.</span> <span class="nav-text">高并发抢票时，防止机器人刷票的令牌大闸，可减轻服务器的压力（防刷+限流）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E7%AB%A0%E4%BB%8B%E7%BB%8D-4"><span class="nav-number">17.1.</span> <span class="nav-text">本章介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E7%A7%92%E6%9D%80%E4%BB%A4%E7%89%8C%E8%A1%A8%E7%94%A8%E4%BB%A5%E7%BB%B4%E6%8A%A4%E4%BB%A4%E7%89%8C%E4%BF%A1%E6%81%AF"><span class="nav-number">17.2.</span> <span class="nav-text">增加秒杀令牌表用以维护令牌信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BD%A6%E6%AC%A1%E4%BF%A1%E6%81%AF%E6%97%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E7%A7%92%E6%9D%80%E4%BB%A4%E7%89%8C%E4%BF%A1%E6%81%AF"><span class="nav-number">17.3.</span> <span class="nav-text">初始化车次信息时初始化秒杀令牌信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E6%A0%A1%E9%AA%8C%E7%A7%92%E6%9D%80%E4%BB%A4%E7%89%8C%E5%8A%9F%E8%83%BD"><span class="nav-number">17.4.</span> <span class="nav-text">增加校验秒杀令牌功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%BB%A4%E7%89%8C%E9%94%81%E9%98%B2%E6%AD%A2%E6%9C%BA%E5%99%A8%E4%BA%BA%E6%8A%A2%E7%A5%A8"><span class="nav-number">17.5.</span> <span class="nav-text">使用令牌锁防止机器人抢票</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98%E5%8A%A0%E9%80%9F%E4%BB%A4%E7%89%8C%E9%94%81%E5%8A%9F%E8%83%BD"><span class="nav-number">17.6.</span> <span class="nav-text">使用缓存加速令牌锁功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E9%AA%8C%E8%AF%81%E7%A0%81%E5%89%8A%E5%BC%B1%E7%9E%AC%E6%97%B6%E9%AB%98%E5%B3%B0%E5%B9%B6%E9%98%B2%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%88%B7%E7%A5%A8"><span class="nav-number">17.7.</span> <span class="nav-text">增加验证码削弱瞬时高峰并防机器人刷票</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E7%AC%AC%E4%B8%80%E5%B1%82%E9%AA%8C%E8%AF%81%E7%A0%81%E5%89%8A%E5%BC%B1%E7%9E%AC%E6%97%B6%E9%AB%98%E5%B3%B0"><span class="nav-number">17.8.</span> <span class="nav-text">增加第一层验证码削弱瞬时高峰</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%B5%81%E8%A1%8C%E7%9A%84MQ%E7%BB%84%E4%BB%B6%E5%AF%B9%E8%AF%B7%E6%B1%82%E5%81%9A%E5%89%8A%E5%B3%B0%E5%A4%84%E7%90%86%EF%BC%8C%E8%A7%A3%E5%86%B3%E5%90%9E%E5%90%90%E9%87%8F%E9%97%AE%E9%A2%98%EF%BC%88%E5%AE%9E%E7%8E%B0%E6%9C%80%E7%9F%AD%E6%97%B6%E9%97%B4%E5%86%85%E7%BB%99%E7%94%A8%E6%88%B7%E5%8F%8D%E9%A6%88%EF%BC%89"><span class="nav-number">18.</span> <span class="nav-text">利用流行的MQ组件对请求做削峰处理，解决吞吐量问题（实现最短时间内给用户反馈）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%AD%E7%A5%A8%E6%97%B6%E5%BA%8F%E5%9B%BE%E6%BC%94%E8%BF%9B"><span class="nav-number">18.1.</span> <span class="nav-text">购票时序图演进</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8BRocketMQ"><span class="nav-number">18.2.</span> <span class="nav-text">初始RocketMQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RocketMQ%E5%88%9D%E4%BD%93%E9%AA%8C"><span class="nav-number">18.3.</span> <span class="nav-text">RocketMQ初体验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RocketMQ%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">18.4.</span> <span class="nav-text">RocketMQ控制台的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8RocketMQ%E5%B0%86%E8%B4%AD%E7%A5%A8%E6%B5%81%E7%A8%8B%E4%B8%80%E5%88%86%E4%B8%BA%E4%BA%8C"><span class="nav-number">18.5.</span> <span class="nav-text">使用RocketMQ将购票流程一分为二</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%88%90MQ%E6%B6%88%E8%B4%B9%E9%87%8C%E7%9A%84%E8%B4%AD%E7%A5%A8%E5%8A%9F%E8%83%BD"><span class="nav-number">18.6.</span> <span class="nav-text">完成MQ消费里的购票功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E5%90%8C%E8%BD%AC%E5%BC%82%E5%A2%9E%E5%8A%A0logId%EF%BC%8C%E6%96%B9%E4%BE%BF%E6%97%A5%E5%BF%97%E8%B7%9F%E8%B8%AA"><span class="nav-number">18.7.</span> <span class="nav-text">为同转异增加logId，方便日志跟踪</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E6%8E%92%E9%98%9F%E5%8A%9F%E8%83%BD%E6%80%9D%E8%B7%AF%E8%AE%B2%E8%A7%A3"><span class="nav-number">18.8.</span> <span class="nav-text">增加排队功能思路讲解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%88%90%E6%8E%92%E9%98%9F%E5%87%BA%E7%A5%A8%E5%8A%9F%E8%83%BD"><span class="nav-number">18.9.</span> <span class="nav-text">完成排队出票功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E8%BD%AE%E8%AF%A2%E8%B4%AD%E7%A5%A8%E7%BB%93%E6%9E%9C%E5%8A%9F%E8%83%BD"><span class="nav-number">18.10.</span> <span class="nav-text">增加轮询购票结果功能</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95-%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E5%89%8D%E5%90%8E%E7%9A%84%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%EF%BC%88%E5%8D%95%E6%9C%BA%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%8725%E5%80%8D%E5%B7%A6%E5%8F%B3%EF%BC%89"><span class="nav-number">19.</span> <span class="nav-text">压力测试-高并发优化前后的性能对比（单机性能提升25倍左右）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E8%AE%B2%E8%A7%A3"><span class="nav-number">19.1.</span> <span class="nav-text">压力测试相关概念讲解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%9E%E5%90%90%E9%87%8F%E5%8E%8B%E6%B5%8B"><span class="nav-number">19.2.</span> <span class="nav-text">吞吐量压测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9JVM%E5%8F%82%E6%95%B0%E5%86%8D%E6%AC%A1%E5%8E%8B%E6%B5%8B"><span class="nav-number">19.3.</span> <span class="nav-text">修改JVM参数再次压测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E9%AB%98%E5%B9%B6%E5%8F%91%E6%95%B0%E6%8E%A2%E6%B5%8B"><span class="nav-number">19.4.</span> <span class="nav-text">最高并发数探测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%BC%82%E6%AD%A5%E7%BA%BF%E7%A8%8B%E4%BB%A3%E6%9B%BFRocketMQ"><span class="nav-number">19.5.</span> <span class="nav-text">使用异步线程代替RocketMQ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96"><span class="nav-number">20.</span> <span class="nav-text">项目优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E7%AB%A0%E4%BB%8B%E7%BB%8D-5"><span class="nav-number">20.1.</span> <span class="nav-text">本章介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%AD%E7%A5%A8%E9%A1%B5%E9%9D%A2%E5%A2%9E%E5%8A%A0%E5%8F%96%E6%B6%88%E6%8E%92%E9%98%9F%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="nav-number">20.2.</span> <span class="nav-text">购票页面增加取消排队的功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%99%E7%A5%A8%E6%9F%A5%E8%AF%A2%E9%A1%B5%E9%9D%A2%E5%A2%9E%E5%8A%A0%E6%98%BE%E7%A4%BA%E8%BD%A6%E7%AB%99%E4%BF%A1%E6%81%AF"><span class="nav-number">20.3.</span> <span class="nav-text">余票查询页面增加显示车站信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%AD%E7%A5%A8%E9%A1%B5%E9%9D%A2%E5%A2%9E%E5%8A%A0%E5%8F%91%E8%B5%B7%E5%A4%9A%E4%BA%BA%E6%8E%92%E9%98%9F%E5%8A%9F%E8%83%BD"><span class="nav-number">20.4.</span> <span class="nav-text">购票页面增加发起多人排队功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E5%BA%A7%E4%BD%8D%E9%94%80%E5%94%AE%E5%9B%BE"><span class="nav-number">20.5.</span> <span class="nav-text">增加座位销售图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AA%E5%85%81%E8%AE%B8%E8%B4%AD%E4%B9%B0%E4%B8%A4%E5%91%A8%E5%86%85%E7%9A%84%E8%BD%A6%E6%AC%A1"><span class="nav-number">20.6.</span> <span class="nav-text">只允许购买两周内的车次</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BC%81%E4%B8%9A%E7%BA%A7%E9%A1%B9%E7%9B%AE%E4%B8%8A%E4%BA%91%EF%BC%88%E9%98%BF%E9%87%8C%E4%BA%91%E9%83%A8%E7%BD%B2%EF%BC%89"><span class="nav-number">21.</span> <span class="nav-text">企业级项目上云（阿里云部署）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E7%AB%A0%E4%BB%8B%E7%BB%8D-6"><span class="nav-number">21.1.</span> <span class="nav-text">本章介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D"><span class="nav-number">21.2.</span> <span class="nav-text">阿里云部署方案介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91RDS%E8%B4%AD%E4%B9%B0%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-number">21.3.</span> <span class="nav-text">阿里云RDS购买与配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91Redis%E8%B4%AD%E4%B9%B0"><span class="nav-number">21.4.</span> <span class="nav-text">阿里云Redis购买</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91ECS%E8%B4%AD%E4%B9%B0%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-number">21.5.</span> <span class="nav-text">阿里云ECS购买与配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E7%99%BB%E5%BD%95%E9%98%BF%E9%87%8C%E4%BA%91ECS"><span class="nav-number">21.6.</span> <span class="nav-text">本地登录阿里云ECS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85JDK"><span class="nav-number">21.7.</span> <span class="nav-text">安装JDK</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85nacos"><span class="nav-number">21.8.</span> <span class="nav-text">安装nacos</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringBoot%E5%BA%94%E7%94%A8%E7%9A%84%E5%A4%9A%E7%8E%AF%E5%A2%83%E6%89%93%E5%8C%85"><span class="nav-number">21.9.</span> <span class="nav-text">SpringBoot应用的多环境打包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringBoot%E5%BA%94%E7%94%A8%E7%9A%84%E7%94%9F%E4%BA%A7%E5%8F%91%E5%B8%83"><span class="nav-number">21.10.</span> <span class="nav-text">SpringBoot应用的生产发布</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vue-CLI%E6%A8%A1%E5%9D%97%E7%9A%84%E7%94%9F%E4%BA%A7%E6%89%93%E5%8C%85"><span class="nav-number">21.11.</span> <span class="nav-text">Vue CLI模块的生产打包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vue-CLI%E6%A8%A1%E5%9D%97%E7%9A%84%E7%94%9F%E4%BA%A7%E5%8F%91%E5%B8%83"><span class="nav-number">21.12.</span> <span class="nav-text">Vue CLI模块的生产发布</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AE%BF%E9%97%AE%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">21.13.</span> <span class="nav-text">修复服务端访问失败的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E8%8A%82%E7%82%B9%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E4%BF%9D%E8%AF%81%E6%9C%8D%E5%8A%A1%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">21.14.</span> <span class="nav-text">多节点的配置，保证服务高可用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cdn%E9%85%8D%E7%BD%AE%E4%BB%8B%E7%BB%8D"><span class="nav-number">21.15.</span> <span class="nav-text">cdn配置介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#https%E9%85%8D%E7%BD%AE%E4%BB%8B%E7%BB%8D"><span class="nav-number">21.16.</span> <span class="nav-text">https配置介绍</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/code-copy.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/lazyload.js"></script>


<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/toc.js"></script>
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
