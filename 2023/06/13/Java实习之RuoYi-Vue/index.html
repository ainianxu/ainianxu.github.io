<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Fang">
    
    <title>
        
            Java实习之RuoYi-Vue |
        
        念~旭
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/favicon.ico","favicon":"/images/favicon.ico","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_img":"source/images/bg.svg","description":"进来就别走了！"},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.4"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                念~旭
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                LINKS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">LINKS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Java实习之RuoYi-Vue</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/favicon.ico">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Fang</span>
                        
                            <span class="author-label">Lv7</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2023-06-13 09:54:33</span>
        <span class="mobile">2023-06-13 09:54</span>
    </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E5%AE%9E%E4%B9%A0/">实习</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>49.7k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>233 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="一、后端在本地运行"><a href="#一、后端在本地运行" class="headerlink" title="一、后端在本地运行"></a>一、后端在本地运行</h1><h2 id="1-系统需求"><a href="#1-系统需求" class="headerlink" title="1.系统需求"></a>1.系统需求</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">JDK &gt;= 1.8 (推荐1.8版本)</span><br><span class="line">Mysql &gt;= 5.7.0 (推荐5.7版本)</span><br><span class="line">Redis &gt;= 3.0</span><br><span class="line">Maven &gt;= 3.0</span><br><span class="line">Node &gt;= 12</span><br></pre></td></tr></table></figure>

<h2 id="2-将项目导入IDEA"><a href="#2-将项目导入IDEA" class="headerlink" title="2.将项目导入IDEA"></a>2.将项目导入IDEA</h2><ol>
<li>新建数据库、新建查询，将RuoYi项目的sql中的quartz.sql和ry_20230223.sql导入新建的数据库中</li>
<li>修改ruoyi-admin\src\main\resources\application-druid.yml的数据库</li>
<li>再启动一个redis就能启动成功了（记得把Vue部分给分离出来哈）</li>
</ol>
<h2 id="3-项目结构"><a href="#3-项目结构" class="headerlink" title="3.项目结构"></a>3.项目结构</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">com.ruoyi     </span><br><span class="line">├── common            // 工具类</span><br><span class="line">│       └── annotation                    // 自定义注解</span><br><span class="line">│       └── config                        // 全局配置</span><br><span class="line">│       └── constant                      // 通用常量</span><br><span class="line">│       └── core                          // 核心控制</span><br><span class="line">│       └── enums                         // 通用枚举</span><br><span class="line">│       └── exception                     // 通用异常</span><br><span class="line">│       └── filter                        // 过滤器处理</span><br><span class="line">│       └── utils                         // 通用类处理</span><br><span class="line">├── framework         // 框架核心</span><br><span class="line">│       └── aspectj                       // 注解实现</span><br><span class="line">│       └── config                        // 系统配置</span><br><span class="line">│       └── datasource                    // 数据权限</span><br><span class="line">│       └── interceptor                   // 拦截器</span><br><span class="line">│       └── manager                       // 异步处理</span><br><span class="line">│       └── security                      // 权限控制</span><br><span class="line">│       └── web                           // 前端控制</span><br><span class="line">├── ruoyi-generator   // 代码生成（可移除）</span><br><span class="line">├── ruoyi-quartz      // 定时任务（可移除）</span><br><span class="line">├── ruoyi-system      // 系统代码</span><br><span class="line">├── ruoyi-admin       // 后台服务</span><br><span class="line">├── ruoyi-xxxxxx      // 其他模块</span><br></pre></td></tr></table></figure>

<h1 id="二、部署前端"><a href="#二、部署前端" class="headerlink" title="二、部署前端"></a>二、部署前端</h1><h2 id="1-将项目导入IDEA"><a href="#1-将项目导入IDEA" class="headerlink" title="1.将项目导入IDEA"></a>1.将项目导入IDEA</h2><ol>
<li>先在IDEA安装一个插件Vue.js</li>
<li>在安装一个依赖</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --registry=https://registry.npmmirror.com</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>接下来就可以启动package.json里面的dev了</li>
</ol>
<h2 id="2-项目结构"><a href="#2-项目结构" class="headerlink" title="2.项目结构"></a>2.项目结构</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">├── build                      // 构建相关  </span><br><span class="line">├── bin                        // 执行脚本</span><br><span class="line">├── public                     // 公共文件</span><br><span class="line">│   ├── favicon.ico            // favicon图标</span><br><span class="line">│   └── index.html             // html模板</span><br><span class="line">│   └── robots.txt             // 反爬虫</span><br><span class="line">├── src                        // 源代码</span><br><span class="line">│   ├── api                    // 所有请求</span><br><span class="line">│   ├── assets                 // 主题 字体等静态资源</span><br><span class="line">│   ├── components             // 全局公用组件</span><br><span class="line">│   ├── directive              // 全局指令</span><br><span class="line">│   ├── layout                 // 布局</span><br><span class="line">│   ├── plugins                // 通用方法</span><br><span class="line">│   ├── router                 // 路由</span><br><span class="line">│   ├── store                  // 全局 store管理</span><br><span class="line">│   ├── utils                  // 全局公用方法</span><br><span class="line">│   ├── views                  // view</span><br><span class="line">│   ├── App.vue                // 入口页面</span><br><span class="line">│   ├── main.js                // 入口 加载组件 初始化等</span><br><span class="line">│   ├── permission.js          // 权限管理</span><br><span class="line">│   └── settings.js            // 系统配置</span><br><span class="line">├── .editorconfig              // 编码格式</span><br><span class="line">├── .env.development           // 开发环境配置</span><br><span class="line">├── .env.production            // 生产环境配置</span><br><span class="line">├── .env.staging               // 测试环境配置</span><br><span class="line">├── .eslintignore              // 忽略语法检查</span><br><span class="line">├── .eslintrc.js               // eslint 配置项</span><br><span class="line">├── .gitignore                 // git 忽略项</span><br><span class="line">├── babel.config.js            // babel.config.js</span><br><span class="line">├── package.json               // package.json</span><br><span class="line">└── vue.config.js              // vue.config.js</span><br></pre></td></tr></table></figure>

<h1 id="三、前端request-js对axios的封装理解和基本使用"><a href="#三、前端request-js对axios的封装理解和基本使用" class="headerlink" title="三、前端request.js对axios的封装理解和基本使用"></a>三、前端request.js对axios的封装理解和基本使用</h1><p>ruoyi的前端对axios进行了封装，让我们发get请求或者是post请求更加方便了。</p>
<p>ruoyi对axios的封装在下面文件中：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306131337178.png"
                      alt="image-20230613133722299"
                ></p>
<p>打开文件，可以看到它有三个显眼的方法，分别是request拦截器、response拦截器和通用下载方法。</p>
<h2 id="1-Get"><a href="#1-Get" class="headerlink" title="1.Get"></a>1.Get</h2><ul>
<li>request拦截器对我们发送的请求进行了封装，当我们发送Get请求，那么我们携带参数的时候应该用param。，对应下面的源码。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get请求映射params参数</span></span><br><span class="line"><span class="keyword">if</span> (config.<span class="property">method</span> === <span class="string">&#x27;get&#x27;</span> &amp;&amp; config.<span class="property">params</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> url = config.<span class="property">url</span> + <span class="string">&#x27;?&#x27;</span> + <span class="title function_">tansParams</span>(config.<span class="property">params</span>);</span><br><span class="line">  url = url.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">  config.<span class="property">params</span> = &#123;&#125;;</span><br><span class="line">  config.<span class="property">url</span> = url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>通过此这简单的代码，可以让get请求自动变为我们熟悉的形式[<a href="http://xxxxx:port/aaa?key1=value1&amp;key2=value2]。">http://xxxxx:port/aaa?key1=value1&amp;key2=value2]。</a></p>
</li>
<li><p>看一个get请求的案例：</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取验证码 不带参数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getCodeImg</span>(<span class="params"></span>) &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">   <span class="attr">url</span>: <span class="string">&#x27;/captchaImage&#x27;</span>,</span><br><span class="line">   <span class="attr">headers</span>: &#123;</span><br><span class="line">     <span class="attr">isToken</span>: <span class="literal">false</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">   <span class="attr">timeout</span>: <span class="number">20000</span></span><br><span class="line"> &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询在线用户列表 带参数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">list</span>(<span class="params">query</span>) &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">   <span class="attr">url</span>: <span class="string">&#x27;/monitor/online/list&#x27;</span>,</span><br><span class="line">   <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">   <span class="attr">params</span>: query</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Post"><a href="#2-Post" class="headerlink" title="2.Post"></a>2.Post</h2><ol>
<li>Post请求带参数使用data。并且以下代码规避了重复提交</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isRepeatSubmit &amp;&amp; (config.<span class="property">method</span> === <span class="string">&#x27;post&#x27;</span> || config.<span class="property">method</span> === <span class="string">&#x27;put&#x27;</span>)) &#123;</span><br><span class="line">  <span class="keyword">const</span> requestObj = &#123;</span><br><span class="line">    <span class="attr">url</span>: config.<span class="property">url</span>,</span><br><span class="line">    <span class="attr">data</span>: <span class="keyword">typeof</span> config.<span class="property">data</span> === <span class="string">&#x27;object&#x27;</span> ? <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(config.<span class="property">data</span>) : config.<span class="property">data</span>,</span><br><span class="line">    <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> sessionObj = cache.<span class="property">session</span>.<span class="title function_">getJSON</span>(<span class="string">&#x27;sessionObj&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (sessionObj === <span class="literal">undefined</span> || sessionObj === <span class="literal">null</span> || sessionObj === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    cache.<span class="property">session</span>.<span class="title function_">setJSON</span>(<span class="string">&#x27;sessionObj&#x27;</span>, requestObj)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s_url = sessionObj.<span class="property">url</span>;                  <span class="comment">// 请求地址</span></span><br><span class="line">    <span class="keyword">const</span> s_data = sessionObj.<span class="property">data</span>;                <span class="comment">// 请求数据</span></span><br><span class="line">    <span class="keyword">const</span> s_time = sessionObj.<span class="property">time</span>;                <span class="comment">// 请求时间</span></span><br><span class="line">    <span class="keyword">const</span> interval = <span class="number">1000</span>;                         <span class="comment">// 间隔时间(ms)，小于此时间视为重复提交</span></span><br><span class="line">    <span class="keyword">if</span> (s_data === requestObj.<span class="property">data</span> &amp;&amp; requestObj.<span class="property">time</span> - s_time &lt; interval &amp;&amp; s_url === requestObj.<span class="property">url</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> message = <span class="string">&#x27;数据正在处理，请勿重复提交&#x27;</span>;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[<span class="subst">$&#123;s_url&#125;</span>]: `</span> + message)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(message))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cache.<span class="property">session</span>.<span class="title function_">setJSON</span>(<span class="string">&#x27;sessionObj&#x27;</span>, requestObj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-预防重复提交开关"><a href="#3-预防重复提交开关" class="headerlink" title="3.预防重复提交开关"></a>3.预防重复提交开关</h2><ul>
<li>就是在请求头处设置repeatSubmit为false还是不加repeatSubmit</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否需要防止数据重复提交</span></span><br><span class="line"><span class="keyword">const</span> isRepeatSubmit = (config.<span class="property">headers</span> || &#123;&#125;).<span class="property">repeatSubmit</span> === <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">getToken</span>() &amp;&amp; !isToken) &#123;</span><br><span class="line">  config.<span class="property">headers</span>[<span class="string">&#x27;Authorization&#x27;</span>] = <span class="string">&#x27;Bearer &#x27;</span> + <span class="title function_">getToken</span>() <span class="comment">// 让每个请求携带自定义token 请根据实际情况自行修改</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-响应拦截器"><a href="#4-响应拦截器" class="headerlink" title="4.响应拦截器"></a>4.响应拦截器</h2><ul>
<li>用于每一个响应的拦截过滤处理。对不同状态码进行判断给出处理逻辑，并不是特别重要。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 未设置状态码则默认成功状态</span></span><br><span class="line">    <span class="keyword">const</span> code = res.<span class="property">data</span>.<span class="property">code</span> || <span class="number">200</span>;</span><br><span class="line">    <span class="comment">// 获取错误信息</span></span><br><span class="line">    <span class="keyword">const</span> msg = errorCode[code] || res.<span class="property">data</span>.<span class="property">msg</span> || errorCode[<span class="string">&#x27;default&#x27;</span>]</span><br><span class="line">    <span class="comment">// 二进制数据则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">request</span>.<span class="property">responseType</span> ===  <span class="string">&#x27;blob&#x27;</span> || res.<span class="property">request</span>.<span class="property">responseType</span> ===  <span class="string">&#x27;arraybuffer&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="property">data</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (code === <span class="number">401</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!isRelogin.<span class="property">show</span>) &#123;</span><br><span class="line">        isRelogin.<span class="property">show</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="title class_">MessageBox</span>.<span class="title function_">confirm</span>(<span class="string">&#x27;登录状态已过期，您可以继续留在该页面，或者重新登录&#x27;</span>, <span class="string">&#x27;系统提示&#x27;</span>, &#123; <span class="attr">confirmButtonText</span>: <span class="string">&#x27;重新登录&#x27;</span>, <span class="attr">cancelButtonText</span>: <span class="string">&#x27;取消&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;warning&#x27;</span> &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          isRelogin.<span class="property">show</span> = <span class="literal">false</span>;</span><br><span class="line">          store.<span class="title function_">dispatch</span>(<span class="string">&#x27;LogOut&#x27;</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            location.<span class="property">href</span> = <span class="string">&#x27;/index&#x27;</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        isRelogin.<span class="property">show</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;无效的会话，或者会话已过期，请重新登录。&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code === <span class="number">500</span>) &#123;</span><br><span class="line">      <span class="title class_">Message</span>(&#123; <span class="attr">message</span>: msg, <span class="attr">type</span>: <span class="string">&#x27;error&#x27;</span> &#125;)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(msg))</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code === <span class="number">601</span>) &#123;</span><br><span class="line">      <span class="title class_">Message</span>(&#123; <span class="attr">message</span>: msg, <span class="attr">type</span>: <span class="string">&#x27;warning&#x27;</span> &#125;)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code !== <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="title class_">Notification</span>.<span class="title function_">error</span>(&#123; <span class="attr">title</span>: msg &#125;)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="property">data</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;err&#x27;</span> + error)</span><br><span class="line">    <span class="keyword">let</span> &#123; message &#125; = error;</span><br><span class="line">    <span class="keyword">if</span> (message == <span class="string">&quot;Network Error&quot;</span>) &#123;</span><br><span class="line">      message = <span class="string">&quot;后端接口连接异常&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.<span class="title function_">includes</span>(<span class="string">&quot;timeout&quot;</span>)) &#123;</span><br><span class="line">      message = <span class="string">&quot;系统接口请求超时&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.<span class="title function_">includes</span>(<span class="string">&quot;Request failed with status code&quot;</span>)) &#123;</span><br><span class="line">      message = <span class="string">&quot;系统接口&quot;</span> + message.<span class="title function_">substr</span>(message.<span class="property">length</span> - <span class="number">3</span>) + <span class="string">&quot;异常&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Message</span>(&#123; <span class="attr">message</span>: message, <span class="attr">type</span>: <span class="string">&#x27;error&#x27;</span>, <span class="attr">duration</span>: <span class="number">5</span> * <span class="number">1000</span> &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="5-通用下载方法前段代码"><a href="#5-通用下载方法前段代码" class="headerlink" title="5.通用下载方法前段代码"></a>5.通用下载方法前段代码</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通用下载方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">download</span>(<span class="params">url, params, filename, config</span>) &#123;</span><br><span class="line">  downloadLoadingInstance = <span class="title class_">Loading</span>.<span class="title function_">service</span>(&#123; <span class="attr">text</span>: <span class="string">&quot;正在下载数据，请稍候&quot;</span>, <span class="attr">spinner</span>: <span class="string">&quot;el-icon-loading&quot;</span>, <span class="attr">background</span>: <span class="string">&quot;rgba(0, 0, 0, 0.7)&quot;</span>, &#125;)</span><br><span class="line">  <span class="keyword">return</span> service.<span class="title function_">post</span>(url, params, &#123;</span><br><span class="line">    <span class="attr">transformRequest</span>: [<span class="function">(<span class="params">params</span>) =&gt;</span> &#123; <span class="keyword">return</span> <span class="title function_">tansParams</span>(params) &#125;],</span><br><span class="line">    <span class="attr">headers</span>: &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">responseType</span>: <span class="string">&#x27;blob&#x27;</span>,</span><br><span class="line">    ...config</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="keyword">async</span> (data) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> isBlob = <span class="title function_">blobValidate</span>(data);</span><br><span class="line">    <span class="keyword">if</span> (isBlob) &#123;</span><br><span class="line">      <span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([data])</span><br><span class="line">      <span class="title function_">saveAs</span>(blob, filename)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> resText = <span class="keyword">await</span> data.<span class="title function_">text</span>();</span><br><span class="line">      <span class="keyword">const</span> rspObj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(resText);</span><br><span class="line">      <span class="keyword">const</span> errMsg = errorCode[rspObj.<span class="property">code</span>] || rspObj.<span class="property">msg</span> || errorCode[<span class="string">&#x27;default&#x27;</span>]</span><br><span class="line">      <span class="title class_">Message</span>.<span class="title function_">error</span>(errMsg);</span><br><span class="line">    &#125;</span><br><span class="line">    downloadLoadingInstance.<span class="title function_">close</span>();</span><br><span class="line">  &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(r)</span><br><span class="line">    <span class="title class_">Message</span>.<span class="title function_">error</span>(<span class="string">&#x27;下载文件出现错误，请联系管理员！&#x27;</span>)</span><br><span class="line">    downloadLoadingInstance.<span class="title function_">close</span>();</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将该方法在main.js全局方法中挂载</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">download</span> = download</span><br></pre></td></tr></table></figure>

<ul>
<li>就可以使用了，比如说字典查询处</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 导出按钮操作 */</span></span><br><span class="line"><span class="title function_">handleExport</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">download</span>(<span class="string">&#x27;system/dict/type/export&#x27;</span>, &#123;</span><br><span class="line">    ...<span class="variable language_">this</span>.<span class="property">queryParams</span></span><br><span class="line">  &#125;, <span class="string">`type_<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()&#125;</span>.xlsx`</span>)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h1 id="四-在线用户展示-仅仅从Redis取一下数据做展示"><a href="#四-在线用户展示-仅仅从Redis取一下数据做展示" class="headerlink" title="四.在线用户展示-仅仅从Redis取一下数据做展示"></a>四.在线用户展示-仅仅从Redis取一下数据做展示</h1><ul>
<li>这个在线用户的功能怎么实现的呢？<ul>
<li>ruoyi的在线用户存在redis中的，每次一个人登录，就会把他的登录信息存在redis中，当我们去查询在线用户，无非就是去redis中取一下有哪一些用户罢了！</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;monitor:online:list&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> TableDataInfo <span class="title function_">list</span><span class="params">(String ipaddr, String userName)</span></span><br><span class="line">&#123;</span><br><span class="line">    Collection&lt;String&gt; keys = redisCache.keys(CacheConstants.LOGIN_TOKEN_KEY + <span class="string">&quot;*&quot;</span>);</span><br><span class="line">    List&lt;SysUserOnline&gt; userOnlineList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SysUserOnline&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String key : keys)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">user</span> <span class="operator">=</span> redisCache.getCacheObject(key);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(ipaddr) &amp;&amp; StringUtils.isNotEmpty(userName))</span><br><span class="line">        &#123;</span><br><span class="line">            userOnlineList.add(userOnlineService.selectOnlineByInfo(ipaddr, userName, user));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotEmpty(ipaddr))</span><br><span class="line">        &#123;</span><br><span class="line">            userOnlineList.add(userOnlineService.selectOnlineByIpaddr(ipaddr, user));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotEmpty(userName) &amp;&amp; StringUtils.isNotNull(user.getUser()))</span><br><span class="line">        &#123;</span><br><span class="line">            userOnlineList.add(userOnlineService.selectOnlineByUserName(userName, user));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            userOnlineList.add(userOnlineService.loginUserToUserOnline(user));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Collections.reverse(userOnlineList);</span><br><span class="line">    userOnlineList.removeAll(Collections.singleton(<span class="literal">null</span>));</span><br><span class="line">    <span class="keyword">return</span> getDataTable(userOnlineList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="五、登录的时候用户信息存入redis代码在哪"><a href="#五、登录的时候用户信息存入redis代码在哪" class="headerlink" title="五、登录的时候用户信息存入redis代码在哪"></a>五、登录的时候用户信息存入redis代码在哪</h1><ul>
<li>那么他又是怎么将登陆信息存到redis里面呢，首先在SysLoginService里面的login，返回处调用TokenService生成token方法，createToken里面包含一个refreshToken方法，该方法里面调用RedisCache生成缓存对象方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成token</span></span><br><span class="line"><span class="keyword">return</span> tokenService.createToken(loginUser);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">refreshToken(loginUser);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 刷新令牌有效期</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loginUser 登录信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshToken</span><span class="params">(LoginUser loginUser)</span></span><br><span class="line">&#123;</span><br><span class="line">    loginUser.setLoginTime(System.currentTimeMillis());</span><br><span class="line">    loginUser.setExpireTime(loginUser.getLoginTime() + expireTime * MILLIS_MINUTE);</span><br><span class="line">    <span class="comment">// 根据uuid将loginUser缓存</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> getTokenKey(loginUser.getToken());</span><br><span class="line">    redisCache.setCacheObject(userKey, loginUser, expireTime, TimeUnit.MINUTES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 缓存基本的对象，Integer、String、实体类等</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 缓存的键值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value 缓存的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeout 时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeUnit 时间颗粒度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">setCacheObject</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> T value, <span class="keyword">final</span> Integer timeout, <span class="keyword">final</span> TimeUnit timeUnit)</span></span><br><span class="line">&#123;</span><br><span class="line">    redisTemplate.opsForValue().set(key, value, timeout, timeUnit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="六、强退用户"><a href="#六、强退用户" class="headerlink" title="六、强退用户"></a>六、强退用户</h1><ol>
<li>就是用了SysUserOnlineController中的forceLogout方法，调用了reids中的删除用户方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 强退用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;monitor:online:forceLogout&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@Log(title = &quot;在线用户&quot;, businessType = BusinessType.FORCE)</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/&#123;tokenId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">forceLogout</span><span class="params">(<span class="meta">@PathVariable</span> String tokenId)</span></span><br><span class="line">&#123;</span><br><span class="line">    redisCache.deleteObject(CacheConstants.LOGIN_TOKEN_KEY + tokenId);</span><br><span class="line">    <span class="keyword">return</span> success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除单个对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteObject</span><span class="params">(<span class="keyword">final</span> String key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="七、下载字典类型后端三句话在做啥"><a href="#七、下载字典类型后端三句话在做啥" class="headerlink" title="七、下载字典类型后端三句话在做啥"></a>七、下载字典类型后端三句话在做啥</h1><ol>
<li>在SysDictTypeController中</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Log(title = &quot;字典类型&quot;, businessType = BusinessType.EXPORT)</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;system:dict:export&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/export&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">export</span><span class="params">(HttpServletResponse response, SysDictType dictType)</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;SysDictType&gt; list = dictTypeService.selectDictTypeList(dictType);</span><br><span class="line">    ExcelUtil&lt;SysDictType&gt; util = <span class="keyword">new</span> <span class="title class_">ExcelUtil</span>&lt;SysDictType&gt;(SysDictType.class);</span><br><span class="line">    util.exportExcel(response, list, <span class="string">&quot;字典类型&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>response：是用來返回給前端的，可以让前端接收数据</li>
<li>list：用来存搜索出来的对象</li>
<li>util的exportExcel方法就可以导出excel</li>
</ul>
<h1 id="八、前端向后端传参的方式"><a href="#八、前端向后端传参的方式" class="headerlink" title="八、前端向后端传参的方式"></a>八、前端向后端传参的方式</h1><p>本节课主要讲述ruoyi中存在的restful风格在路径中传参和直接通过get或post携带的param、data传参。</p>
<h2 id="1-RESTful"><a href="#1-RESTful" class="headerlink" title="1.RESTful"></a>1.RESTful</h2><ul>
<li>以参数管理为例子，用过configId查询它用到了restful风格的传参方式：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询字典数据详细</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;system:dict:query&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/&#123;dictCode&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long dictCode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> success(dictDataService.selectDictDataById(dictCode));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上的&#x2F;{configId}就是一种在路径中传参数的例子。</li>
</ul>
<h2 id="2-普通方式"><a href="#2-普通方式" class="headerlink" title="2.普通方式"></a>2.普通方式</h2><blockquote>
<p>第二种直接在get的param中写，或者在post的data中写即可。</p>
</blockquote>
<h1 id="九、开关原理（验证码开关、IP开关）"><a href="#九、开关原理（验证码开关、IP开关）" class="headerlink" title="九、开关原理（验证码开关、IP开关）"></a>九、开关原理（验证码开关、IP开关）</h1><h2 id="1-开关原理（验证码开关）"><a href="#1-开关原理（验证码开关）" class="headerlink" title="1.开关原理（验证码开关）"></a>1.开关原理（验证码开关）</h2><p>我们打开页面“参数管理”，所谓参数管理，就是在系统运行起来的时候，可以动态修改一些值，这些值会被系统实时修改，下次如果需要读值，则会是最新的值。</p>
<p>对于验证码而言，可以将下面的参数值修改为false即可：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141011541.png"
                      alt="image-20230614101121134"
                ></p>
<ul>
<li>前端login.vue关键代码：主要就是这个v-if</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form-item prop=&quot;code&quot; v-if=&quot;captchaEnabled&quot;&gt;</span><br><span class="line">  &lt;el-input</span><br><span class="line">    v-model=&quot;loginForm.code&quot;</span><br><span class="line">    auto-complete=&quot;off&quot;</span><br><span class="line">    placeholder=&quot;验证码&quot;</span><br><span class="line">    style=&quot;width: 63%&quot;</span><br><span class="line">    @keyup.enter.native=&quot;handleLogin&quot;</span><br><span class="line">  &gt;</span><br><span class="line">    &lt;svg-icon slot=&quot;prefix&quot; icon-class=&quot;validCode&quot; class=&quot;el-input__icon input-icon&quot; /&gt;</span><br><span class="line">  &lt;/el-input&gt;</span><br><span class="line">  &lt;div class=&quot;login-code&quot;&gt;</span><br><span class="line">    &lt;img :src=&quot;codeUrl&quot; @click=&quot;getCode&quot; class=&quot;login-code-img&quot;/&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/el-form-item&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getCode</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">getCodeImg</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">captchaEnabled</span> = res.<span class="property">captchaEnabled</span> === <span class="literal">undefined</span> ? <span class="literal">true</span> : res.<span class="property">captchaEnabled</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">captchaEnabled</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">codeUrl</span> = <span class="string">&quot;data:image/gif;base64,&quot;</span> + res.<span class="property">img</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loginForm</span>.<span class="property">uuid</span> = res.<span class="property">uuid</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>CaptchaController后端关键代码：获取数据先从Redis（程序开始就存到了Redis中）中获取，如果Reids获取不到就在数据库中获取</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/captchaImage&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getCode</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">AjaxResult</span> <span class="variable">ajax</span> <span class="operator">=</span> AjaxResult.success();</span><br><span class="line">    <span class="comment">//主要就靠这句话获取是false还是true</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">captchaEnabled</span> <span class="operator">=</span> configService.selectCaptchaEnabled();</span><br><span class="line">    ajax.put(<span class="string">&quot;captchaEnabled&quot;</span>, captchaEnabled);</span><br><span class="line">    <span class="keyword">if</span> (!captchaEnabled)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ajax;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存验证码信息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> IdUtils.simpleUUID();</span><br><span class="line">    <span class="type">String</span> <span class="variable">verifyKey</span> <span class="operator">=</span> CacheConstants.CAPTCHA_CODE_KEY + uuid;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">capStr</span> <span class="operator">=</span> <span class="literal">null</span>, code = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">captchaType</span> <span class="operator">=</span> RuoYiConfig.getCaptchaType();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;math&quot;</span>.equals(captchaType))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">capText</span> <span class="operator">=</span> captchaProducerMath.createText();</span><br><span class="line">        capStr = capText.substring(<span class="number">0</span>, capText.lastIndexOf(<span class="string">&quot;@&quot;</span>));</span><br><span class="line">        code = capText.substring(capText.lastIndexOf(<span class="string">&quot;@&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        image = captchaProducerMath.createImage(capStr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;char&quot;</span>.equals(captchaType))</span><br><span class="line">    &#123;</span><br><span class="line">        capStr = code = captchaProducer.createText();</span><br><span class="line">        image = captchaProducer.createImage(capStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    redisCache.setCacheObject(verifyKey, code, Constants.CAPTCHA_EXPIRATION, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">// 转换流信息写出</span></span><br><span class="line">    <span class="type">FastByteArrayOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastByteArrayOutputStream</span>();</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        ImageIO.write(image, <span class="string">&quot;jpg&quot;</span>, os);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> AjaxResult.error(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ajax.put(<span class="string">&quot;uuid&quot;</span>, uuid);</span><br><span class="line">    ajax.put(<span class="string">&quot;img&quot;</span>, Base64.encode(os.toByteArray()));</span><br><span class="line">    <span class="keyword">return</span> ajax;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>怎么程序一启动就自动存到了Redis中呢？是通过一个注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 项目启动时，初始化参数到缓存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    loadingConfigCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>参数配置还能改用户初始密码和是否允许注册</li>
</ul>
<h2 id="2-开关原理（IP开关）"><a href="#2-开关原理（IP开关）" class="headerlink" title="2.开关原理（IP开关）"></a>2.开关原理（IP开关）</h2><ul>
<li>上一种验证码开关是在参数设置里面设置的，随着程序运行之后，也能随时改。主要通过redis实现。</li>
<li>那么，IP开关呢？IP开关在YML，主要是用来看日志的时候能不能看到公网IP。</li>
<li><strong>IP开关通过YML文件中写死实现，也就是说，一旦程序启动，就改不了了。</strong></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目相关配置</span></span><br><span class="line"><span class="attr">ruoyi:</span></span><br><span class="line">  <span class="comment"># 获取ip地址开关</span></span><br><span class="line">  <span class="attr">addressEnabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>通过AddressUtils这个来根据IP地址查询所在地</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.common.utils.ip;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.config.RuoYiConfig;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.http.HttpUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取地址类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddressUtils</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(AddressUtils.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// IP地址查询</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">IP_URL</span> <span class="operator">=</span> <span class="string">&quot;http://whois.pconline.com.cn/ipJson.jsp&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 未知地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UNKNOWN</span> <span class="operator">=</span> <span class="string">&quot;XX XX&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getRealAddressByIP</span><span class="params">(String ip)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 内网不查询</span></span><br><span class="line">        <span class="keyword">if</span> (IpUtils.internalIp(ip))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;内网IP&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (RuoYiConfig.isAddressEnabled())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">rspStr</span> <span class="operator">=</span> HttpUtils.sendGet(IP_URL, <span class="string">&quot;ip=&quot;</span> + ip + <span class="string">&quot;&amp;json=true&quot;</span>, Constants.GBK);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isEmpty(rspStr))</span><br><span class="line">                &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;获取地理位置异常 &#123;&#125;&quot;</span>, ip);</span><br><span class="line">                    <span class="keyword">return</span> UNKNOWN;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">JSONObject</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(rspStr);</span><br><span class="line">                <span class="type">String</span> <span class="variable">region</span> <span class="operator">=</span> obj.getString(<span class="string">&quot;pro&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> obj.getString(<span class="string">&quot;city&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">&quot;%s %s&quot;</span>, region, city);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                log.error(<span class="string">&quot;获取地理位置异常 &#123;&#125;&quot;</span>, ip);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在线用户的地址IP转location也是登录的时候创建令牌中setUserAgent方法干的，并且30分钟掉线是在yml中设置的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建令牌</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loginUser 用户信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 令牌</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">createToken</span><span class="params">(LoginUser loginUser)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> IdUtils.fastUUID();</span><br><span class="line">    loginUser.setToken(token);</span><br><span class="line">    setUserAgent(loginUser);</span><br><span class="line">    refreshToken(loginUser);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    claims.put(Constants.LOGIN_USER_KEY, token);</span><br><span class="line">    <span class="keyword">return</span> createToken(claims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># token配置</span></span><br><span class="line"><span class="attr">token:</span></span><br><span class="line">    <span class="comment"># 令牌自定义标识</span></span><br><span class="line">    <span class="attr">header:</span> <span class="string">Authorization</span></span><br><span class="line">    <span class="comment"># 令牌密钥</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">abcdefghijklmnopqrstuvwxyz</span></span><br><span class="line">    <span class="comment"># 令牌有效期（默认30分钟）</span></span><br><span class="line">    <span class="attr">expireTime:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<h1 id="十、前端页面的布局详解"><a href="#十、前端页面的布局详解" class="headerlink" title="十、前端页面的布局详解"></a>十、前端页面的布局详解</h1><h2 id="1-Vue-Devtools工具安装"><a href="#1-Vue-Devtools工具安装" class="headerlink" title="1.Vue-Devtools工具安装"></a>1.Vue-Devtools工具安装</h2><ul>
<li>在谷歌商店中添加插件</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141440219.png"
                      alt="image-20230614144016984"
                ></p>
<h2 id="2-前端页面的布局"><a href="#2-前端页面的布局" class="headerlink" title="2.前端页面的布局"></a>2.前端页面的布局</h2><h3 id="情况一：不依赖Layout的情况"><a href="#情况一：不依赖Layout的情况" class="headerlink" title="情况一：不依赖Layout的情况"></a>情况一：不依赖Layout的情况</h3><ul>
<li>ruoyi的前端页面目前存在两种情况，一种是依赖layout组件，一种是不依赖layout组件。</li>
<li>比如说登录页面，注册页面，404页面就不依赖于layout组件，layout组件实际上就是一个vue的组件。</li>
<li>这种组件比较简单，就是跟写HTML基本也没啥两样。</li>
<li>关于login.vue页面的对应组件树如下：用的就是<a class="link"   target="_blank" rel="noopener" href="https://element.eleme.cn/#/zh-CN/component/installation%E8%BF%99%E9%87%8C%E9%9D%A2%E7%9A%84%E7%BB%84%E4%BB%B6" >https://element.eleme.cn/#/zh-CN/component/installation这里面的组件<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141507353.png"
                      alt="图片"
                ></p>
<h3 id="情况二：依赖Layout组件"><a href="#情况二：依赖Layout组件" class="headerlink" title="情况二：依赖Layout组件"></a>情况二：依赖Layout组件</h3><ul>
<li>当我们成功登录，接下来基本上每一个页面都是出于Layout组件之下，也就是说，它是layout组件的子组件！</li>
<li>当我们登录之后，会自动到首页</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141529090.png"
                      alt="图片"
                ></p>
<ul>
<li>Sidebar：对应左边菜单区。</li>
<li>Navbar：导航区。</li>
<li>TagsView：页签区。</li>
<li>RightPanel：右面板区，平常不可见。</li>
<li>AppMain：内容页面区，我们一般业务页面会出现在此区域。</li>
</ul>
<h1 id="十一、天气小案例"><a href="#十一、天气小案例" class="headerlink" title="十一、天气小案例"></a>十一、天气小案例</h1><h2 id="1-新增带Layout组件的页面"><a href="#1-新增带Layout组件的页面" class="headerlink" title="1.新增带Layout组件的页面"></a>1.新增带Layout组件的页面</h2><ul>
<li><p>直接在views文件夹下面新增weather.vue。然后随便写一个123，现在先让我们页面能跳过去先。</p>
</li>
<li><p>让页面能跳过去，有好几种方法：</p>
<ul>
<li>在菜单管理自己添加一个菜单，然后把菜单分配给某个角色，再把该角色分给某个人。【然而超级管理员什么时候都能看到此菜单，因为超级管理员能无视一切权限问题】</li>
<li>在路由文件（router&#x2F;index.js直接写相关路由），然后可以手动切换浏览器网址进入该路由。</li>
</ul>
</li>
<li><p>本次例子利用使用自己添加菜单的方法，这样比较简单。简单如下图：</p>
</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141711219.png"
                      alt="image-20230614171107830"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141715722.png"
                      alt="image-20230614171559529"
                ></p>
<ul>
<li>组件路径一定要写对，写不对直接进不去相应的组件。路由地址可以乱写，但是起码也要有点“path”的样子</li>
</ul>
<h2 id="2-专注weather业务"><a href="#2-专注weather业务" class="headerlink" title="2.专注weather业务"></a>2.专注weather业务</h2><ol>
<li>首先weather.vue文件的代码如下：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div v-loading=&quot;loading&quot;&gt;</span><br><span class="line">    &lt;el-row style=&quot;margin-top: 30px;&quot; :gutter=&quot;20&quot;&gt;</span><br><span class="line">      &lt;el-col :offset=&quot;10&quot; :span=&quot;4&quot;&gt;</span><br><span class="line">        &lt;el-button type=&quot;success&quot; @click=&quot;handleWeather&quot;&gt;当前城市天气&lt;/el-button&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">    &lt;el-row :gutter=&quot;20&quot; v-if=&quot;city.length&gt;0&quot;&gt;</span><br><span class="line">      &lt;el-col :offset=&quot;2&quot; :span=&quot;20&quot;&gt;</span><br><span class="line">        &lt;el-descriptions title=&quot;当前实时天气&quot;&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;当前城市&quot;&gt;&#123;&#123; city &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;温度&quot;&gt;&#123;&#123; weather.realtime.temperature &#125;&#125;℃&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;风向&quot;&gt;&#123;&#123; weather.realtime.direct &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;风力&quot;&gt;&#123;&#123; weather.realtime.power &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;湿度&quot;&gt;&#123;&#123; weather.realtime.humidity &#125;&#125;%&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;天气状况&quot;&gt;&#123;&#123; weather.realtime.info &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">        &lt;/el-descriptions&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">    &lt;el-row v-for=&quot;item in weather.future&quot; :key=&quot;item.date&quot; style=&quot;margin-top: 30px;&quot; :gutter=&quot;20&quot;&gt;</span><br><span class="line">      &lt;el-col :offset=&quot;2&quot; :span=&quot;20&quot;&gt;</span><br><span class="line">        &lt;el-descriptions :title=&quot;item.date&quot; :column=&quot;4&quot;&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;风向&quot;&gt;&#123;&#123; item.direct &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;温度&quot;&gt;&#123;&#123; item.temperature &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;天气情况&quot;&gt;&#123;&#123; item.weather &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">        &lt;/el-descriptions&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;getWeather&#125; from &#x27;@/api/gzh/weather&#x27;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;weather&quot;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      loading : false,</span><br><span class="line">      city: &quot;&quot;,</span><br><span class="line">      weather: &#123;</span><br><span class="line">        realtime: &#123;&#125;,</span><br><span class="line">        future: []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handleWeather() &#123;</span><br><span class="line">      this.loading = true</span><br><span class="line">      getWeather().then(res =&gt; &#123;</span><br><span class="line">        const weatherInfo = JSON.parse(res.msg);</span><br><span class="line">        this.city = weatherInfo.result.city</span><br><span class="line">        this.weather.realtime = weatherInfo.result.realtime</span><br><span class="line">        this.weather.future = weatherInfo.result.future</span><br><span class="line">        this.loading = false</span><br><span class="line">        console.log(weatherInfo)</span><br><span class="line">      &#125;).catch(err =&gt; &#123;</span><br><span class="line">        console.error(err)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>然后是前端api调用代码&#x2F;api&#x2F;gzh&#x2F;weather.js：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&quot;@/utils/request&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询参数列表</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getWeather</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/getWeatherByLocalIP&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>接下来是后端的工具类代码：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.web.controller.weather;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.http.HttpUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getWeatherByLocalIP&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">getWeather</span><span class="params">()</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">        <span class="type">AjaxResult</span> <span class="variable">result</span> <span class="operator">=</span> AjaxResult.success();</span><br><span class="line">        <span class="type">String</span> <span class="variable">localCityName</span> <span class="operator">=</span> GetLocationAndIP.getLocalCityName();</span><br><span class="line">        <span class="comment">//调用天气API</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">encodeCity</span> <span class="operator">=</span> URLEncoder.encode(localCityName, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        System.out.println(encodeCity);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://apis.juhe.cn/simpleWeather/query?city=&quot;</span> + encodeCity + <span class="string">&quot;&amp;key=81fe33a6077267b2e4ae2967af47eeb7&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">weatherInfo</span> <span class="operator">=</span> HttpUtils.sendGet(url);</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, weatherInfo);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>然后是后端接口的代码：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.web.controller.weather;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONException;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetLocationAndIP</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">readAll</span><span class="params">(BufferedReader rd)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">int</span> cp;</span><br><span class="line">        <span class="keyword">while</span> ((cp = rd.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            sb.append((<span class="type">char</span>) cp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title function_">readJsonFromUrl</span><span class="params">(String url)</span> <span class="keyword">throws</span> IOException, JSONException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url).openStream()) &#123;</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">rd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is, StandardCharsets.UTF_8));</span><br><span class="line">            <span class="type">String</span> <span class="variable">jsonText</span> <span class="operator">=</span> readAll(rd);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(jsonText);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getAddress</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// 这个网址似乎不能了用了</span></span><br><span class="line">        <span class="comment">// String chinaz = &quot;http://ip.chinaz.com&quot;;</span></span><br><span class="line">        <span class="comment">// 改用了太平洋的一个网址</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chinaz</span> <span class="operator">=</span> <span class="string">&quot;http://whois.pconline.com.cn/&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">inputLine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">read</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">HttpURLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            url = <span class="keyword">new</span> <span class="title class_">URL</span>(chinaz);</span><br><span class="line">            urlConnection = (HttpURLConnection) url.openConnection();</span><br><span class="line">            <span class="comment">// 如有乱码的，请修改相应的编码集，这里是 gbk</span></span><br><span class="line">            in = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(urlConnection.getInputStream(), <span class="string">&quot;gbk&quot;</span>));</span><br><span class="line">            <span class="keyword">while</span> ((read = in.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                inputLine.append(read).append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这个是之前的正则表达式,</span></span><br><span class="line">        <span class="comment">// Pattern p = Pattern.compile(&quot;\\&lt;dd class\\=\&quot;fz24\&quot;&gt;(.*?)\\&lt;\\/dd&gt;&quot;);</span></span><br><span class="line">        <span class="comment">// 通过正则表达式匹配我们想要的内容，根据拉取的网页内容不同，正则表达式作相应的改变</span></span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">p</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;显示IP地址为(.*?)的位置信息&quot;</span>);</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">m</span> <span class="operator">=</span> p.matcher(inputLine.toString());</span><br><span class="line">        <span class="keyword">if</span> (m.find()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">ipstr</span> <span class="operator">=</span> m.group(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 这里根据具体情况，来截取想要的内容</span></span><br><span class="line">            ip = ipstr.substring(ipstr.indexOf(<span class="string">&quot;为&quot;</span>) + <span class="number">2</span>, ipstr.indexOf(<span class="string">&quot;的&quot;</span>) - <span class="number">1</span>);</span><br><span class="line">            map.put(<span class="string">&quot;ip&quot;</span>, ip);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">json</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 这里调用百度的ip定位api服务 详见 http://api.map.baidu.com/lbsapi/cloud/ip-location-api.htm</span></span><br><span class="line">            json = readJsonFromUrl(<span class="string">&quot;http://api.map.baidu.com/location/ip?ak=laOQElaF53xGGBjscGtrd10nN4j1zGki&amp;ip=&quot;</span> + ip);</span><br><span class="line">            <span class="comment">//city = (((JSONObject) ((JSONObject) json.get(&quot;content&quot;)).get(&quot;address_detail&quot;)).get(&quot;city&quot;)).toString();</span></span><br><span class="line">            map.put(<span class="string">&quot;city&quot;</span>, ((JSONObject) ((JSONObject) json.get(<span class="string">&quot;content&quot;</span>)).get(<span class="string">&quot;address_detail&quot;</span>)).get(<span class="string">&quot;city&quot;</span>).toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLocalCityName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GetLocationAndIP</span> <span class="variable">getLocationANDIp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetLocationAndIP</span>();</span><br><span class="line">        Map&lt;String, Object&gt; map = getLocationANDIp.getAddress();</span><br><span class="line">        <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> map.get(<span class="string">&quot;city&quot;</span>).toString();</span><br><span class="line">        <span class="keyword">return</span> city.substring(<span class="number">0</span>, city.length() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GetLocationAndIP</span> <span class="variable">getLocationANDIp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetLocationAndIP</span>();</span><br><span class="line">        Map&lt;String, Object&gt; map = getLocationANDIp.getAddress();</span><br><span class="line">        <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> map.get(<span class="string">&quot;city&quot;</span>).toString();</span><br><span class="line">        <span class="type">String</span> <span class="variable">city_1</span> <span class="operator">=</span> city.substring(<span class="number">0</span>, city.length() - <span class="number">1</span>);</span><br><span class="line">        System.out.println(city_1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.json<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>20090211<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>由此，天气小demo就跑起来了，效果图如下：</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141758797.png"
                      alt="image-20230614175845403"
                ></p>
<h1 id="十二、JWT"><a href="#十二、JWT" class="headerlink" title="十二、JWT"></a>十二、JWT</h1><h2 id="1-跨域认证的问题"><a href="#1-跨域认证的问题" class="headerlink" title="1.跨域认证的问题"></a>1.跨域认证的问题</h2><ul>
<li>互联网服务离不开用户认证。一般流程是下面这样。</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1、用户向服务器发送用户名和密码。</span><br><span class="line"></span><br><span class="line">2、服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间等等。</span><br><span class="line"></span><br><span class="line">3、服务器向用户返回一个 session_id，写入用户的 Cookie。</span><br><span class="line"></span><br><span class="line">4、用户随后的每一次请求，都会通过 Cookie，将 session_id 传回服务器。</span><br><span class="line"></span><br><span class="line">5、服务器收到 session_id，找到前期保存的数据，由此得知用户的身份。</span><br></pre></td></tr></table></figure>

<ul>
<li>这种模式的问题在于，扩展性（scaling）不好。单机当然没有问题，如果是服务器集群，或者是<strong>跨域的服务导向架构，就要求 session 数据共享，每台服务器都能够读取 session。</strong></li>
<li>举例来说，A 网站和 B 网站是同一家公司的关联服务。现在要求，用户只要在其中一个网站登录，再访问另一个网站就会自动登录，请问怎么实现？</li>
<li>一种解决方案是 <strong>session 数据持久化</strong>，写入数据库或别的持久层。各种服务收到请求后，都向持久层请求数据。这种方案的优点是架构清晰，缺点是工程量比较大。另外，持久层万一挂了，就会单点失败。</li>
<li>另一种方案是服务器索性不保存 session 数据了，<strong>所有数据都保存在客户端</strong>，每次请求都发回服务器。JWT 就是这种方案的一个代表。</li>
</ul>
<h2 id="2-JWT-的原理"><a href="#2-JWT-的原理" class="headerlink" title="2.JWT 的原理"></a>2.JWT 的原理</h2><p>JWT 的原理是，服务器认证以后，生成一个 JSON 对象，发回给用户，就像下面这样。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;姓名&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="string">&quot;角色&quot;</span>: <span class="string">&quot;管理员&quot;</span>,</span><br><span class="line">  <span class="string">&quot;到期时间&quot;</span>: <span class="string">&quot;2018年7月1日0点0分&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li>以后，用户与服务端通信的时候，都要发回这个 JSON 对象。服务器完全只靠这个对象认定用户身份。为了防止用户篡改数据，服务器在生成这个对象的时候，会加上签名（详见后文）。</li>
<li>服务器就不保存任何 session 数据了，也就是说，服务器变成无状态了，从而比较容易实现扩展。</li>
</ul>
<h2 id="3-JWT-的数据结构"><a href="#3-JWT-的数据结构" class="headerlink" title="3.JWT 的数据结构"></a>3.JWT 的数据结构</h2><p>实际的 JWT 大概就像下面这样。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://www.wangbase.com/blogimg/asset/201807/bg2018072304.jpg"
                      alt="img"
                ></p>
<p>它是一个很长的字符串，中间用点（<code>.</code>）分隔成三个部分。注意，JWT 内部是没有换行的，这里只是为了便于展示，将它写成了几行。</p>
<p>JWT 的三个部分依次如下。</p>
<blockquote>
<ul>
<li>Header（头部）</li>
<li>Payload（负载）</li>
<li>Signature（签名）</li>
</ul>
</blockquote>
<p>写成一行，就是下面的样子。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Header</span>.<span class="property">Payload</span>.<span class="property">Signature</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://www.wangbase.com/blogimg/asset/201807/bg2018072303.jpg"
                      alt="img"
                ></p>
<p>下面依次介绍这三个部分。</p>
<h3 id="3-1-Header"><a href="#3-1-Header" class="headerlink" title="3.1 Header"></a>3.1 Header</h3><p>Header 部分是一个 JSON 对象，描述 JWT 的元数据，通常是下面的样子。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">  <span class="string">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面代码中，<code>alg</code>属性表示签名的算法（algorithm），默认是 HMAC SHA256（写成 HS256）；<code>typ</code>属性表示这个令牌（token）的类型（type），JWT 令牌统一写为<code>JWT</code>。</p>
<p>最后，将上面的 JSON 对象使用 Base64URL 算法（详见后文）转成字符串。</p>
<h3 id="3-2-Payload"><a href="#3-2-Payload" class="headerlink" title="3.2 Payload"></a>3.2 Payload</h3><p>Payload 部分也是一个 JSON 对象，用来存放实际需要传递的数据。JWT 规定了7个官方字段，供选用。</p>
<blockquote>
<ul>
<li>iss (issuer)：签发人</li>
<li>exp (expiration time)：过期时间</li>
<li>sub (subject)：主题</li>
<li>aud (audience)：受众</li>
<li>nbf (Not Before)：生效时间</li>
<li>iat (Issued At)：签发时间</li>
<li>jti (JWT ID)：编号</li>
</ul>
</blockquote>
<p>除了官方字段，你还可以在这个部分定义私有字段，下面就是一个例子。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;sub&quot;</span>: <span class="string">&quot;1234567890&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">  <span class="string">&quot;admin&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>注意，JWT 默认是不加密的，任何人都可以读到，所以不要把秘密信息放在这个部分。</p>
<p>这个 JSON 对象也要使用 Base64URL 算法转成字符串。</p>
<h3 id="3-3-Signature"><a href="#3-3-Signature" class="headerlink" title="3.3 Signature"></a>3.3 Signature</h3><p>Signature 部分是对前两部分的签名，防止数据篡改。</p>
<p>首先，需要指定一个密钥（secret）。这个密钥只有服务器才知道，不能泄露给用户。然后，使用 Header 里面指定的签名算法（默认是 HMAC SHA256），按照下面的公式产生签名。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">HMACSHA256</span>(</span><br><span class="line">  <span class="title function_">base64UrlEncode</span>(header) + <span class="string">&quot;.&quot;</span> +</span><br><span class="line">  <span class="title function_">base64UrlEncode</span>(payload),</span><br><span class="line">  secret)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用”点”（<code>.</code>）分隔，就可以返回给用户。</p>
<h3 id="3-4-Base64URL"><a href="#3-4-Base64URL" class="headerlink" title="3.4 Base64URL"></a>3.4 Base64URL</h3><p>前面提到，Header 和 Payload 串型化的算法是 Base64URL。这个算法跟 Base64 算法基本类似，但有一些小的不同。</p>
<p>JWT 作为一个令牌（token），有些场合可能会放到 URL（比如 api.example.com&#x2F;?token&#x3D;xxx）。Base64 有三个字符<code>+</code>、<code>/</code>和<code>=</code>，在 URL 里面有特殊含义，所以要被替换掉：<code>=</code>被省略、<code>+</code>替换成<code>-</code>，<code>/</code>替换成<code>_</code> 。这就是 Base64URL 算法。</p>
<h2 id="4-JWT-的使用方式"><a href="#4-JWT-的使用方式" class="headerlink" title="4.JWT 的使用方式"></a>4.JWT 的使用方式</h2><p>客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage。</p>
<p>此后，客户端每次与服务器通信，都要带上这个 JWT。你可以把它放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求的头信息<code>Authorization</code>字段里面。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Authorization</span>: <span class="title class_">Bearer</span> &lt;token&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>另一种做法是，跨域的时候，JWT 就放在 POST 请求的数据体里面。</p>
<h2 id="5-JWT-的几个特点"><a href="#5-JWT-的几个特点" class="headerlink" title="5.JWT 的几个特点"></a>5.JWT 的几个特点</h2><p>（1）JWT 默认是不加密，但也是可以加密的。<strong>生成原始 Token 以后，可以用密钥再加密一次。</strong></p>
<p>（2）JWT 不加密的情况下，不能将秘密数据写入 JWT。</p>
<p>（3）<strong>JWT 不仅可以用于认证，也可以用于交换信息</strong>。有效使用 JWT，可以降低服务器查询数据库的次数。</p>
<p>（4）JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，<strong>一旦 JWT 签发了，在到期之前就会始终有效</strong>，除非服务器部署额外的逻辑。</p>
<p>（5）JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。<strong>对于一些比较重要的权限，使用时应该再次对用户进行认证</strong>。</p>
<p>（6）<strong>为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输。</strong></p>
<h2 id="6-ry是怎么践行JWT的呢？"><a href="#6-ry是怎么践行JWT的呢？" class="headerlink" title="6.ry是怎么践行JWT的呢？"></a>6.ry是怎么践行JWT的呢？</h2><ol>
<li>问题一：不登录的时候有token吗？<ul>
<li>答：没有，所以只能在login页面，凡是想跳转其他界面，都被重定向到登录，硬生生让你登录。前端阻拦的代码在permission.js如下：</li>
</ul>
</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306151411324.png"
                      alt="image-20230615141138093"
                ></p>
<ol start="2">
<li>问题二：token什么时候生成的？<ul>
<li>答：登录的时候生成的，具体代码讲述：</li>
</ul>
</li>
</ol>
<ul>
<li>在login控制器的SysLoginService层代码中，有login方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String username, String password, String code, String uuid)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">captchaOnOff</span> <span class="operator">=</span> configService.selectCaptchaOnOff();</span><br><span class="line">        <span class="comment">// 验证码开关</span></span><br><span class="line">        <span class="keyword">if</span> (captchaOnOff)</span><br><span class="line">        &#123;</span><br><span class="line">            validateCaptcha(username, code, uuid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 用户验证</span></span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 该方法会去调用UserDetailsServiceImpl.loadUserByUsername</span></span><br><span class="line">            authentication = authenticationManager</span><br><span class="line">                    .authenticate(<span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BadCredentialsException)</span><br><span class="line">            &#123;</span><br><span class="line">                AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, MessageUtils.message(<span class="string">&quot;user.password.not.match&quot;</span>)));</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UserPasswordNotMatchException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, e.getMessage()));</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_SUCCESS, MessageUtils.message(<span class="string">&quot;user.login.success&quot;</span>)));</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> (LoginUser) authentication.getPrincipal();</span><br><span class="line">        recordLoginInfo(loginUser.getUserId());</span><br><span class="line">        <span class="comment">// 生成token</span></span><br><span class="line">        <span class="keyword">return</span> tokenService.createToken(loginUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>最后一句话，他说生成token，于是他执行TokenService：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> String <span class="title function_">createToken</span><span class="params">(LoginUser loginUser)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> IdUtils.fastUUID();</span><br><span class="line">        loginUser.setToken(token);</span><br><span class="line">        setUserAgent(loginUser);</span><br><span class="line">        refreshToken(loginUser);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        claims.put(Constants.LOGIN_USER_KEY, token);</span><br><span class="line">        <span class="keyword">return</span> createToken(claims);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后它又是最后一个话在生成token，TokenService点进去我们才看到真的生成方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">createToken</span><span class="params">(Map&lt;String, Object&gt; claims)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setClaims(claims)</span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, secret).compact();</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>现在token生成好了，大家要注意，refreshToken方法已经把当前成功登录的人的信息存到了redis中，前缀是login_tokens: + 当前的tokenId，tokenId是一个uuid。</li>
<li>所以再看login方法，不仅仅生成了token，还把登录人的信息存到了Redis中。方便下次用户带着token来的时候，后端可以拿到tokenId来redis中找用户的tokenId是否存在。</li>
</ul>
<ol start="3">
<li>问题三，用户登录后，发请求是怎么自动带上token的？</li>
</ol>
<ul>
<li>登录成功的时候，前端存了一份token在cookie中，登录代码user.js如下：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录</span></span><br><span class="line"><span class="title class_">Login</span>(&#123; commit &#125;, userInfo) &#123;</span><br><span class="line">  <span class="keyword">const</span> username = userInfo.<span class="property">username</span>.<span class="title function_">trim</span>()</span><br><span class="line">  <span class="keyword">const</span> password = userInfo.<span class="property">password</span></span><br><span class="line">  <span class="keyword">const</span> code = userInfo.<span class="property">code</span></span><br><span class="line">  <span class="keyword">const</span> uuid = userInfo.<span class="property">uuid</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">login</span>(username, password, code, uuid).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setToken</span>(res.<span class="property">token</span>)</span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;SET_TOKEN&#x27;</span>, res.<span class="property">token</span>)</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">reject</span>(error)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>引入眼帘有一个setToken，里面就将token放cookie，代码auth.js如下：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setToken</span>(<span class="params">token</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Cookies</span>.<span class="title function_">set</span>(<span class="title class_">TokenKey</span>, token)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来如果要发请求，request.js会自动带上，如下代码：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306151437006.png"
                      alt="image-20230615143747780"
                ></p>
<ul>
<li>可以看到，它会去config.headers看看到底要不要，如果我们在请求头指定了不要，那么发请求就不会带上token，否则就会被带上token。</li>
</ul>
<ol start="4">
<li>问题四：我再次请求的时候带上了token，后端在哪问我带没带token呢？</li>
</ol>
<ul>
<li>其实后端有一个拦截器，总是在悄悄检查。如下代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.security.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.web.service.TokenService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * token过滤器 验证token有效性</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUser(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(loginUser) &amp;&amp; StringUtils.isNull(SecurityUtils.getAuthentication()))</span><br><span class="line">        &#123;</span><br><span class="line">            tokenService.verifyToken(loginUser);</span><br><span class="line">            <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, loginUser.getAuthorities());</span><br><span class="line">            authenticationToken.setDetails(<span class="keyword">new</span> <span class="title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>getLoginUser方法总是在试图拿到token。然后验证token是否正确，token有没有过期，然后把用户该有的权限重新设置在上下文中。</li>
<li>该拦截器是在SecurityConfig设置的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * anyRequest          |   匹配所有请求路径</span></span><br><span class="line"><span class="comment"> * access              |   SpringEl表达式结果为true时可以访问</span></span><br><span class="line"><span class="comment"> * anonymous           |   匿名可以访问</span></span><br><span class="line"><span class="comment"> * denyAll             |   用户不能访问</span></span><br><span class="line"><span class="comment"> * fullyAuthenticated  |   用户完全认证可以访问（非remember-me下自动登录）</span></span><br><span class="line"><span class="comment"> * hasAnyAuthority     |   如果有参数，参数表示权限，则其中任何一个权限可以访问</span></span><br><span class="line"><span class="comment"> * hasAnyRole          |   如果有参数，参数表示角色，则其中任何一个角色可以访问</span></span><br><span class="line"><span class="comment"> * hasAuthority        |   如果有参数，参数表示权限，则其权限可以访问</span></span><br><span class="line"><span class="comment"> * hasIpAddress        |   如果有参数，参数表示IP地址，如果用户IP和参数匹配，则可以访问</span></span><br><span class="line"><span class="comment"> * hasRole             |   如果有参数，参数表示角色，则其角色可以访问</span></span><br><span class="line"><span class="comment"> * permitAll           |   用户可以任意访问</span></span><br><span class="line"><span class="comment"> * rememberMe          |   允许通过remember-me登录的用户访问</span></span><br><span class="line"><span class="comment"> * authenticated       |   用户登录后可访问</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注解标记允许匿名访问的url</span></span><br><span class="line">    ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.<span class="type">ExpressionInterceptUrlRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> httpSecurity.authorizeRequests();</span><br><span class="line">    permitAllUrl.getUrls().forEach(url -&gt; registry.antMatchers(url).permitAll());</span><br><span class="line"></span><br><span class="line">    httpSecurity</span><br><span class="line">            <span class="comment">// CSRF禁用，因为不使用session</span></span><br><span class="line">            .csrf().disable()</span><br><span class="line">            <span class="comment">// 禁用HTTP响应标头</span></span><br><span class="line">            .headers().cacheControl().disable().and()</span><br><span class="line">            <span class="comment">// 认证失败处理类</span></span><br><span class="line">            .exceptionHandling().authenticationEntryPoint(unauthorizedHandler).and()</span><br><span class="line">            <span class="comment">// 基于token，所以不需要session</span></span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()</span><br><span class="line">            <span class="comment">// 过滤请求</span></span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            <span class="comment">// 对于登录login 注册register 验证码captchaImage 允许匿名访问</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/captchaImage&quot;</span>).permitAll()</span><br><span class="line">            <span class="comment">// 静态资源，可匿名访问</span></span><br><span class="line">            .antMatchers(HttpMethod.GET, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;/*.html&quot;</span>, <span class="string">&quot;/**/*.html&quot;</span>, <span class="string">&quot;/**/*.css&quot;</span>, <span class="string">&quot;/**/*.js&quot;</span>, <span class="string">&quot;/profile/**&quot;</span>).permitAll()</span><br><span class="line">            .antMatchers(<span class="string">&quot;/swagger-ui.html&quot;</span>, <span class="string">&quot;/swagger-resources/**&quot;</span>, <span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;/*/api-docs&quot;</span>, <span class="string">&quot;/druid/**&quot;</span>).permitAll()</span><br><span class="line">            <span class="comment">// 除上面外的所有请求全部需要鉴权认证</span></span><br><span class="line">            .anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .headers().frameOptions().disable();</span><br><span class="line">    <span class="comment">// 添加Logout filter</span></span><br><span class="line">    httpSecurity.logout().logoutUrl(<span class="string">&quot;/logout&quot;</span>).logoutSuccessHandler(logoutSuccessHandler);</span><br><span class="line">    <span class="comment">// 添加JWT filter</span></span><br><span class="line">    httpSecurity.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    <span class="comment">// 添加CORS filter</span></span><br><span class="line">    httpSecurity.addFilterBefore(corsFilter, JwtAuthenticationTokenFilter.class);</span><br><span class="line">    httpSecurity.addFilterBefore(corsFilter, LogoutFilter.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十三、ry如何践行SpringSecurity用于认证"><a href="#十三、ry如何践行SpringSecurity用于认证" class="headerlink" title="十三、ry如何践行SpringSecurity用于认证"></a>十三、ry如何践行SpringSecurity用于认证</h1><h2 id="1-SpringSecurity基础"><a href="#1-SpringSecurity基础" class="headerlink" title="1.SpringSecurity基础"></a>1.SpringSecurity基础</h2><ol>
<li>先看一个篇文章<a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/342755411?utm_medium=social&amp;utm_oi=1343915562263547904" >https://zhuanlan.zhihu.com/p/342755411?utm_medium=social&amp;utm_oi=1343915562263547904<i class="fas fa-external-link-alt"></i></a></li>
<li>简而言之，如果要自定义认证逻辑，需要我们去写一个类，实现UserDetailsService接口。UserDetailsService中重写loadUserByUsername方法，该方法是通过username找到用户，往往是通过数据库查询。loadUserByUsername方法的返回值是一个实现UserDetails接口的类，该类是为了存储从数据库查询用户的详细信息的点点滴滴【见名知意，UserDetails意为用户细节】。</li>
</ol>
<h2 id="2-Ry是如何践行这套规则？"><a href="#2-Ry是如何践行这套规则？" class="headerlink" title="2.Ry是如何践行这套规则？"></a>2.Ry是如何践行这套规则？</h2><ol>
<li>在SysLoginService的login方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户验证</span></span><br><span class="line"><span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">    AuthenticationContextHolder.setContext(authenticationToken);</span><br><span class="line">    <span class="comment">// 该方法会去调用UserDetailsServiceImpl.loadUserByUsername</span></span><br><span class="line">    authentication = authenticationManager.authenticate(authenticationToken);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BadCredentialsException)</span><br><span class="line">    &#123;</span><br><span class="line">        AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, MessageUtils.message(<span class="string">&quot;user.password.not.match&quot;</span>)));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UserPasswordNotMatchException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, e.getMessage()));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在ry中，SpringSecurity接管了整个后端的认证和授权，我们现在来看认证相关的问题。登录的时候，执行了一句代码：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authentication = authenticationManager.authenticate(authenticationToken);</span><br></pre></td></tr></table></figure>

<ul>
<li>根据ry作者的提示，会去自动执行loadUserByUsername方法，那么为何会去执行loadUserByUsername方法呢？</li>
<li>事实上，我们使用SpringSecurity用来认证的时候，<strong>只需要调用AuthenticationManager接口上的authenticate方法即可</strong>。若需要获得AuthenticationManager的实例，则需要写个类，该类继承WebSecurityConfigurerAdapter类，然后通过重写下面的代码可以获得认证管理器：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解决 无法直接注入 AuthenticationManager</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在ry中的SecurityConfig类正好就是写了该代码，如此操作之后，认证管理器被注入到了Spring容器中，可以在Spring环境中随时获得认证管理器的Bean。</li>
<li>在我们的登录SysLoginService类中，通过下面的代码把认证管理器拿来了：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br></pre></td></tr></table></figure>

<ul>
<li>此时，在此我们只需要调用authenticationManager实例的authenticate方法即可完成认证。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">   ...省略其他代码</span><br><span class="line"> <span class="comment">// 传递过来的用户名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">    <span class="comment">// 调用UserDetailService的方法，通过用户名查询出用户对象UserDetail（查询不出来UserDetailService则会抛出异常）</span></span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> <span class="built_in">this</span>.getUserDetailsService().loadUserByUsername(username);</span><br><span class="line">    <span class="type">String</span> <span class="variable">presentedPassword</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 传递过来的密码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line">    <span class="comment">// 使用密码解析器PasswordEncoder传递过来的密码是否和真实的用户密码匹配</span></span><br><span class="line">    <span class="keyword">if</span> (!passwordEncoder.matches(password, userDetails.getPassword())) &#123;</span><br><span class="line">        <span class="comment">// 密码错误则抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="string">&quot;错误信息...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 注意哦，这里返回的已认证Authentication，是将整个UserDetails放进去充当Principal</span></span><br><span class="line">    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(userDetails,</span><br><span class="line">                authentication.getCredentials(), userDetails.getAuthorities());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    ...省略其他代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>UserDetialsService UserDetails PasswordEncoder，这三个组件Spring Security都有默认实现，这一般是满足不了我们的实际需求的，所以这里我们自己来实现这些组件！</li>
<li>ry写了UserDetailsServiceImpl类实现了UserDetialsService 接口，并重写了loadUserByUsername方法，该方法返回UserDetails接口实例对象，ry并不满足于SpringSecurity提供的User类，于是自己写了LoginUser类，LoginUser类实现了UserDetails接口，并重写了接口内要求的方法getPassword和getUsername，其他方法并不重要，ry仅仅简单返回一个true。值得注意的是，getAuthorities方法ry仅仅是简单返回一个null！！！原因是因为ry有着自己的一套权限检查方法。</li>
<li>对于PasswordEncoder，ry使用的BCryptPasswordEncoder，只需要注入到Spring容器即可被SpringSecurity找到，当然在Spring容器中也方便我们在注册的时候也拿到该单例对象对密码做加密处理：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>    </span><br><span class="line"><span class="keyword">public</span> BCryptPasswordEncoder <span class="title function_">bCryptPasswordEncoder</span><span class="params">()</span></span><br><span class="line">&#123;        </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ry的UserDetailsServiceImpl类中的loadUserByUsername方法主要是去数据库查询，通过username找到需要检索的用户，然后对用户做简单校验：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (StringUtils.isNull(user))</span><br><span class="line">&#123;</span><br><span class="line">    log.info(<span class="string">&quot;登录用户：&#123;&#125; 不存在.&quot;</span>, username);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;登录用户：&quot;</span> + username + <span class="string">&quot; 不存在&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (UserStatus.DELETED.getCode().equals(user.getDelFlag()))</span><br><span class="line">&#123;</span><br><span class="line">    log.info(<span class="string">&quot;登录用户：&#123;&#125; 已被删除.&quot;</span>, username);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;对不起，您的账号：&quot;</span> + username + <span class="string">&quot; 已被删除&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (UserStatus.DISABLE.getCode().equals(user.getStatus()))</span><br><span class="line">&#123;</span><br><span class="line">    log.info(<span class="string">&quot;登录用户：&#123;&#125; 已被停用.&quot;</span>, username);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;对不起，您的账号：&quot;</span> + username + <span class="string">&quot; 已停用&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>之后，ry就想new LoginUser，LoginUser类是loadUserByUsername方法返回值所需要的，如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user.getUserId(), user.getDeptId(), user, permissionService.getMenuPermission(user));</span><br></pre></td></tr></table></figure>

<ul>
<li>这里把用户id，部门，用户详情“user”都封装进入了LoginUser的实例。需要注意最后一个参数，这里去数据库查询了权限！！！也就是查询登录人的权限【包括页面权限和按钮权限】。关于权限，后面再说。</li>
<li>接下来，SpringSecurity会自动去检查密码对不对</li>
<li>认证完成之后，login方法拿着经过认证的authentication实例生成了token，并把token和LoginUser存到了Redis，再把token返回给了前端。</li>
<li>前端拿到token就立刻存到了cookie中，并且下次给后端发请求的时候带上了token表明自己的身份。</li>
<li>每一次后端被请求时，都会执行JwtAuthenticationTokenFilter过滤器，该过滤器是在从请求request的请求头（key为Authorization的条目）中获得token，然后验证token，验证成功则直接封装一个已经成功认证的信息authenticationToken，并存在上下文中。相关代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.security.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.web.service.TokenService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * token过滤器 验证token有效性</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUser(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(loginUser) &amp;&amp; StringUtils.isNull(SecurityUtils.getAuthentication()))</span><br><span class="line">        &#123;</span><br><span class="line">            tokenService.verifyToken(loginUser);</span><br><span class="line">            <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, loginUser.getAuthorities());</span><br><span class="line">            authenticationToken.setDetails(<span class="keyword">new</span> <span class="title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-ry认证出现问题如何处理的？"><a href="#3-ry认证出现问题如何处理的？" class="headerlink" title="3.ry认证出现问题如何处理的？"></a>3.ry认证出现问题如何处理的？</h2><ol>
<li>认证配置类中最重要的HttpSecurity配置如下：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * anyRequest          |   匹配所有请求路径</span></span><br><span class="line"><span class="comment"> * access              |   SpringEl表达式结果为true时可以访问</span></span><br><span class="line"><span class="comment"> * anonymous           |   匿名可以访问</span></span><br><span class="line"><span class="comment"> * denyAll             |   用户不能访问</span></span><br><span class="line"><span class="comment"> * fullyAuthenticated  |   用户完全认证可以访问（非remember-me下自动登录）</span></span><br><span class="line"><span class="comment"> * hasAnyAuthority     |   如果有参数，参数表示权限，则其中任何一个权限可以访问</span></span><br><span class="line"><span class="comment"> * hasAnyRole          |   如果有参数，参数表示角色，则其中任何一个角色可以访问</span></span><br><span class="line"><span class="comment"> * hasAuthority        |   如果有参数，参数表示权限，则其权限可以访问</span></span><br><span class="line"><span class="comment"> * hasIpAddress        |   如果有参数，参数表示IP地址，如果用户IP和参数匹配，则可以访问</span></span><br><span class="line"><span class="comment"> * hasRole             |   如果有参数，参数表示角色，则其角色可以访问</span></span><br><span class="line"><span class="comment"> * permitAll           |   用户可以任意访问</span></span><br><span class="line"><span class="comment"> * rememberMe          |   允许通过remember-me登录的用户访问</span></span><br><span class="line"><span class="comment"> * authenticated       |   用户登录后可访问</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注解标记允许匿名访问的url</span></span><br><span class="line">    ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.<span class="type">ExpressionInterceptUrlRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> httpSecurity.authorizeRequests();</span><br><span class="line">    permitAllUrl.getUrls().forEach(url -&gt; registry.antMatchers(url).permitAll());</span><br><span class="line"></span><br><span class="line">    httpSecurity</span><br><span class="line">            <span class="comment">// CSRF禁用，因为不使用session</span></span><br><span class="line">            .csrf().disable()</span><br><span class="line">            <span class="comment">// 禁用HTTP响应标头</span></span><br><span class="line">            .headers().cacheControl().disable().and()</span><br><span class="line">            <span class="comment">// 认证失败处理类</span></span><br><span class="line">            .exceptionHandling().authenticationEntryPoint(unauthorizedHandler).and()</span><br><span class="line">            <span class="comment">// 基于token，所以不需要session</span></span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()</span><br><span class="line">            <span class="comment">// 过滤请求</span></span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            <span class="comment">// 对于登录login 注册register 验证码captchaImage 允许匿名访问</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/captchaImage&quot;</span>).permitAll()</span><br><span class="line">            <span class="comment">// 静态资源，可匿名访问</span></span><br><span class="line">            .antMatchers(HttpMethod.GET, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;/*.html&quot;</span>, <span class="string">&quot;/**/*.html&quot;</span>, <span class="string">&quot;/**/*.css&quot;</span>, <span class="string">&quot;/**/*.js&quot;</span>, <span class="string">&quot;/profile/**&quot;</span>).permitAll()</span><br><span class="line">            .antMatchers(<span class="string">&quot;/swagger-ui.html&quot;</span>, <span class="string">&quot;/swagger-resources/**&quot;</span>, <span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;/*/api-docs&quot;</span>, <span class="string">&quot;/druid/**&quot;</span>).permitAll()</span><br><span class="line">            <span class="comment">// 除上面外的所有请求全部需要鉴权认证</span></span><br><span class="line">            .anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .headers().frameOptions().disable();</span><br><span class="line">    <span class="comment">// 添加Logout filter</span></span><br><span class="line">    httpSecurity.logout().logoutUrl(<span class="string">&quot;/logout&quot;</span>).logoutSuccessHandler(logoutSuccessHandler);</span><br><span class="line">    <span class="comment">// 添加JWT filter</span></span><br><span class="line">    httpSecurity.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    <span class="comment">// 添加CORS filter</span></span><br><span class="line">    httpSecurity.addFilterBefore(corsFilter, JwtAuthenticationTokenFilter.class);</span><br><span class="line">    httpSecurity.addFilterBefore(corsFilter, LogoutFilter.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在SecurityConfig类中明确指定了认证失败后handle：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.exceptionHandling().authenticationEntryPoint(unauthorizedHandler).and()</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>也就是如下的方式来处理：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.security.handle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSON;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证失败处理类 返回未授权</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationEntryPointImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span>, Serializable</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8970718410437077606L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> HttpStatus.UNAUTHORIZED;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> StringUtils.format(<span class="string">&quot;请求访问：&#123;&#125;，认证失败，无法访问系统资源&quot;</span>, request.getRequestURI());</span><br><span class="line">        ServletUtils.renderString(response, JSON.toJSONString(AjaxResult.error(code, msg)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到如果认证失败就简单返回一句话【请求访问：{}，认证失败，无法访问系统资源】。</li>
<li>通过postman或apifox等发请求的软件，随便给后端发一个请求，很容易就能得到一个这样的返回：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306151701160.png"
                      alt="图片"
                ></p>
<h2 id="4-新问题：postman如何调接口？"><a href="#4-新问题：postman如何调接口？" class="headerlink" title="4.新问题：postman如何调接口？"></a>4.新问题：postman如何调接口？</h2><ul>
<li>现在有一个这样的问题，遇到认证失败，但是自己想用postman、apifox、apipost等软件就想要调通API，怎么办？现在介绍一种方法，因为超级管理员是无视一切权限的，只要用上超级管理员的token，一切权限都能轻轻松松越过去。</li>
<li>然而，如果用上了超级管理员token，一切查询方面的结果都是和超级管理员有关的，有时候可能并不是自己想要的，这就需要给授权，后面再说。</li>
</ul>
<h2 id="5-Swagger好像也调不通"><a href="#5-Swagger好像也调不通" class="headerlink" title="5.Swagger好像也调不通"></a>5.Swagger好像也调不通</h2><ol>
<li>swagger也不通，如下：</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306151704484.png"
                      alt="image-20230615170430330"
                ></p>
<ol start="2">
<li>也是因为没有权限，如下方式加上token就能调通：</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306151705365.png"
                      alt="image-20230615170506089"
                ></p>
<h1 id="十四、深入认证源码过滤器链"><a href="#十四、深入认证源码过滤器链" class="headerlink" title="十四、深入认证源码过滤器链"></a>十四、深入认证源码过滤器链</h1><h2 id="1-手动修改过滤器链和认识addFilterAfter方法"><a href="#1-手动修改过滤器链和认识addFilterAfter方法" class="headerlink" title="1.手动修改过滤器链和认识addFilterAfter方法"></a>1.手动修改过滤器链和认识addFilterAfter方法</h2><h3 id="1-手动修改过滤器链和认识addFilterAfter方法-1"><a href="#1-手动修改过滤器链和认识addFilterAfter方法-1" class="headerlink" title="1.手动修改过滤器链和认识addFilterAfter方法"></a>1.手动修改过滤器链和认识addFilterAfter方法</h3><p>我们知道，SpringSecurity的机制无非就是过滤器链，一个一个执行过滤器，当前ry的过滤器链如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161040165.png"
                      alt="图片"
                ></p>
<ul>
<li>这里我先看cors（处理跨域）的过滤器有两个，但是处理跨域的过滤器只会执行一次（因为继承了<strong>OncePerRequestFilter</strong>），所以没有加入两个解决跨域过滤器的必要。所以我删除了一个，我怎么删除的呢？我直接在ry添加两个过滤器的地方注释了一个：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161043455.png"
                      alt="image-20230616104344315"
                ></p>
<ul>
<li>从上面的红色框可以看出，我就是删除了在JwtAuthenticationTokenFilter过滤器前面的一个cors过滤器。</li>
<li><strong>addFilterBefore（参数一，参数二）方法的功能是添加一个过滤器，并且添加到参数二过滤器之前。</strong></li>
<li>当我删除了一个跨域过滤器之后，新的过滤器链如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161045869.png"
                      alt="图片"
                ></p>
<h3 id="2-新方法：addFilterAfter"><a href="#2-新方法：addFilterAfter" class="headerlink" title="2.新方法：addFilterAfter"></a>2.新方法：addFilterAfter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        httpSecurity.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);           </span></span><br><span class="line">       httpSecurity.addFilterAfter(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br></pre></td></tr></table></figure>

<ul>
<li>刚刚说到addFilterBefore是在添加到指定过滤器之前，而addFilterAfter相反，添加到指定过滤器之后。</li>
<li>通过addFilterAfter和addFilterBefore，我们可以控制additionalFilters过滤器链每一个过滤器的顺序。</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161055326.png"
                      alt="图片"
                ></p>
<ul>
<li>其实上面几行，已经用过了addFilterAfter方法，然而，这里虽然把addFilterBefore改成了addFilterAfter，但是其实结果还是一样的。</li>
<li>因为没有启用表单认证所以UsernamePasswordAuthenticationFilter被移除了。UsernamePasswordAuthenticationFilter自然也不起作用了，相当于我们刚刚的addFilterAfter其实就是取代了UsernamePasswordAuthenticationFilter的位置，由authenticationTokenFilter（JwtAuthenticationTokenFilter）实例来完成认证。</li>
</ul>
<h2 id="2-安全过滤器链条的每个过滤器作用"><a href="#2-安全过滤器链条的每个过滤器作用" class="headerlink" title="2.安全过滤器链条的每个过滤器作用"></a>2.安全过滤器链条的每个过滤器作用</h2><p>Tips：SpringSecurity成功认证的标志是上下文存储着经过认证的用户信息，像下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, loginUser.getAuthorities());</span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br></pre></td></tr></table></figure>

<ul>
<li>当前过滤器链共12个过滤器：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161111223.png"
                      alt="图片"
                ></p>
<ul>
<li><strong>WebAsyncManagerIntegrationFilter</strong>，用于将SecurityContext传递到异步线程中(异步线程就可以获取安全上下文)。</li>
<li><strong>SecurityContextPersistenceFilter</strong>，它主要是使用SecurityContextRepository在session中保存或更新一个SecurityContext，并将SecurityContext给以后的过滤器使用，来为后续filter建立所需的上下文。</li>
<li><strong>HeaderWriterFilter</strong>，它用于向请求的Header中添加相应的信息。</li>
<li><strong>CorsFilter</strong>，它用于处理跨域，ry有自定义此过滤器，如下：文件ResourcesConfig.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跨域配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CorsFilter <span class="title function_">corsFilter</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">    config.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 设置访问源地址</span></span><br><span class="line">    config.addAllowedOriginPattern(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置访问源请求头</span></span><br><span class="line">    config.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置访问源请求方法</span></span><br><span class="line">    config.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="comment">// 有效期 1800秒</span></span><br><span class="line">    config.setMaxAge(<span class="number">1800L</span>);</span><br><span class="line">    <span class="comment">// 添加映射路径，拦截一切请求</span></span><br><span class="line">    <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">    source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, config);</span><br><span class="line">    <span class="comment">// 返回新的CorsFilter</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CorsFilter</span>(source);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的配置可以让前端请求基本上是随便跨域了。ry把此过滤器设置了两次，一次在LogoutFilter.class之前，一次在JwtAuthenticationTokenFilter.class之前，但是被我删除了JwtAuthenticationTokenFilter.class前面的，但是执行的效果还是一样的。</li>
<li><strong>LogoutFilter，用于处理注销主体。</strong></li>
<li>LogoutFilter会去执行两个handler，分别是SecurityContextLogoutHandler和LogoutSuccessEventPublishingLogoutHandler。SecurityContextLogoutHandler用于清除上下文认证信息。做的一些关键代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.clearAuthentication) &#123;</span><br><span class="line">    <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.getContext();</span><br><span class="line">    context.setAuthentication((Authentication)<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SecurityContextHolder.clearContext();</span><br></pre></td></tr></table></figure>

<ul>
<li>LogoutSuccessEventPublishingLogoutHandler啥都没干，如果authentication已经是Null的情况下，正好上一个handler已经将authentication清理了，所以可以理解LogoutSuccessEventPublishingLogoutHandler啥都没做。<strong>如果前一个handler执行出现问题，本handler也可以理解为一种补偿机制，发布一个事件说authentication已经登出了</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.eventPublisher != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (authentication != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.eventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">LogoutSuccessEvent</span>(authentication));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ry对成功注销做了自定义实现：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.security.handle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.token.TokenService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.logout.LogoutSuccessHandler;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSON;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.manager.AsyncManager;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.manager.factory.AsyncFactory;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.web.service.TokenService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义退出处理类 返回成功</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogoutSuccessHandlerImpl</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退出处理</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUser(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(loginUser))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> loginUser.getUsername();</span><br><span class="line">            <span class="comment">// 删除用户缓存记录</span></span><br><span class="line">            tokenService.delLoginUser(loginUser.getToken());</span><br><span class="line">            <span class="comment">// 记录用户退出日志</span></span><br><span class="line">            AsyncManager.me().execute(AsyncFactory.recordLogininfor(userName, Constants.LOGOUT, <span class="string">&quot;退出成功&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ServletUtils.renderString(response, JSON.toJSONString(AjaxResult.success(<span class="string">&quot;退出成功&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>无非就是在退出的时候做一下收尾工作，清缓存，写登出日志，最后再返回一个退出成功的信息。</li>
<li><strong>JwtAuthenticationTokenFilter，用于认证用户</strong></li>
<li>当用户登陆成功之后，发请求会带上token，<strong>JwtAuthenticationTokenFilter</strong>是专门用于<strong>解析token并把认证成功的用户信息设置到上下文中</strong>，用于后续的鉴权（认证成功的LoginUser里面有字段里面带着用户的权限的）。相关代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.security.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.web.service.TokenService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * token过滤器 验证token有效性</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUser(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(loginUser) &amp;&amp; StringUtils.isNull(SecurityUtils.getAuthentication()))</span><br><span class="line">        &#123;</span><br><span class="line">            tokenService.verifyToken(loginUser);</span><br><span class="line">            <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, loginUser.getAuthorities());</span><br><span class="line">            authenticationToken.setDetails(<span class="keyword">new</span> <span class="title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>RequestCacheAwareFilter</strong>，通过HttpSessionRequestCache内部维护了一个RequestCache，用于缓存HttpServletRequest。</li>
<li><strong>SecurityContextHolderAwareRequestFilter，针对ServletRequest进行了一次包装，使得request具有更加丰富的API。</strong>通过SecurityContextHolderAwareRequestWrapper把ServletRequest包装起来，多了一些方法如getUserPrincipal，getAuthentication方便后续的确认是否目前已经认证。因为在过滤器链条上面request和response一直在链条上传输，这也是包装request的原因。</li>
<li><strong>AnonymousAuthenticationFilter</strong>，当SecurityContextHolder中认证信息为空,则会创建一个匿名用户存入到SecurityContextHolder中。<strong>SpringSecurity为了兼容未登录的访问，也走了一套认证流程，只不过是一个匿名的身份</strong>。</li>
<li><strong>SessionManagementFilter</strong>，SecurityContextRepository限制同一用户开启多个会话的数量，但是<strong>前后端分离往往会禁用session，改用Redis存储用户会话状态。</strong></li>
<li><strong>ExceptionTranslationFilter，用于处理异常</strong>，它的过滤器方法直接放行，但是catch了许多异常例如认证过程的异常</li>
<li><strong>FilterSecurityInterceptor</strong>，获取所配置资源访问的授权信息，根据SecurityContextHolder中存储的用户信息来决定其是否有权限，然而ry自创了一套鉴权方式，所以原生FilterSecurityInterceptor这里不做展开。</li>
<li><strong>这些过滤器由一个代理管理</strong>，从上依次往下执行。下面我来来看一下代理（FilterChainProxy.VirtualFilterChain）的关键性代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.currentPosition == <span class="built_in">this</span>.size) &#123;</span><br><span class="line">     ...省略非关键代码 </span><br><span class="line">        <span class="comment">// Deactivate path stripping as we exit the security filter chain</span></span><br><span class="line">        <span class="built_in">this</span>.firewalledRequest.reset();</span><br><span class="line">        <span class="built_in">this</span>.originalChain.doFilter(request, response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ++<span class="built_in">this</span>.currentPosition;</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">nextFilter</span> <span class="operator">=</span> (Filter)<span class="built_in">this</span>.additionalFilters.get(<span class="built_in">this</span>.currentPosition - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (FilterChainProxy.logger.isTraceEnabled()) &#123;</span><br><span class="line">            FilterChainProxy.logger.trace(LogMessage.format(<span class="string">&quot;Invoking %s (%d/%d)&quot;</span>, nextFilter.getClass().getSimpleName(), <span class="built_in">this</span>.currentPosition, <span class="built_in">this</span>.size));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nextFilter.doFilter(request, response, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从上面的代码可以看得出，有一个名为additionalFilters的ArrayList存储了12个过滤器，一个一个依次执行，执行完毕之后继续执行originalChain里面的过滤器。</li>
</ul>
<h1 id="十五、RBAC"><a href="#十五、RBAC" class="headerlink" title="十五、RBAC"></a>十五、RBAC</h1><h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h2><ul>
<li><strong>RBAC是一种基于角色权限控制，进而控制用户的权限</strong>。具体而言，对系统操作的各种权限不是直接授予具体的用户，而是在<strong>用户集合与权限集合之间建立一个角色集合</strong>。每一种角色对应一组相应的权限。一旦用户被分配了适当的角色后，该用户就拥有此角色的所有操作权限。这样做的好处是，不必在每次创建用户时都进行分配权限的操作，只要分配用户相应的角色即可，而且角色的权限变更比用户的权限变更要少得多，这样将简化用户的权限管理，减少系统的开销。</li>
</ul>
<h2 id="2-什么是页面权限、按钮权限"><a href="#2-什么是页面权限、按钮权限" class="headerlink" title="2.什么是页面权限、按钮权限"></a>2.什么是页面权限、按钮权限</h2><ul>
<li>所谓页面权限，就是进入某个页面所需要的权限。</li>
<li>按钮权限则是能点击某个按钮所需要的权限。</li>
</ul>
<h2 id="3-权限表现形式"><a href="#3-权限表现形式" class="headerlink" title="3.权限表现形式"></a>3.权限表现形式</h2><ul>
<li><strong>对于权限，在程序中往往表现为一个字符串</strong>，比如说“system:user:add”表示对用户具有增加权限，当然也可以说“dsadsaddsadsadsa”表示对用户有增加权限，字符串是随意定的，但是为了符合人类的想法，要做到尽量的见名知意。</li>
<li>对于ry而言，在系统管理→菜单管理对每一个菜单对应了某种权限，如下图所示：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161358029.png"
                      alt="图片"
                ></p>
<ul>
<li>下面我们以岗位管理为例子，说明岗位管理的每个字符串的作用，岗位管理的权限字符串如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161358774.png"
                      alt="图片"
                ></p>
<ul>
<li>上图的岗位管理对应的字符串为“system:post:list”，该字符串的意思是，有了这个字符串才能查看岗位管理的菜单。</li>
<li>“system:post:query”字符串表示对单个岗位详情的查询权限。“system:post:add”表示增权限，“system:post:edit”表示修改权限，“system:post:remove”表示删岗位权限，“system:post:export”表示导出岗位数据Excel文件的权限。</li>
<li>岗位管理的“system:post:list”是<strong>页面权限</strong>，如果没有该权限，连菜单都看不到，自然页面也看不到。</li>
<li>其他的“system:post:add”、“system:post:edit”、“system:post:remove”、“system:post:export”都是<strong>按钮权限</strong>。</li>
<li>按钮权限在前端页面的表现就是能不能看到按钮，在后端的表现就是能不能执行按钮对应的controller的增删改查方法。</li>
</ul>
<h2 id="4-ry如何进行权限控制"><a href="#4-ry如何进行权限控制" class="headerlink" title="4.ry如何进行权限控制"></a>4.ry如何进行权限控制</h2><ul>
<li>在ry中，页面菜单、目录菜单和按钮菜单基本上都是存在数据库中（首页、404等特殊页面除外），在系统管理→菜单管理可以填写每一个菜单对应的权限字符串，不过目前目录菜单不能添加权限字符串。</li>
<li>当我们在菜单管理写好权限字符串之后，在角色管理我们可以添加角色，并把相关的权限赋予给角色。</li>
<li>角色和权限是多对多关系，<strong>一个权限可以给多个角色，一个角色可以有多个权限</strong>。</li>
<li>当我们让给角色赋权完毕之后，我们可以在角色管理页面直接给角色分配用户，比如把角色1和角色2分给用户1，那么用户1就会拥有角色1和角色2的全部权限。角色1和角色2的权限可以重复，但是没有双倍权限这种快乐。角色和用户的关系也是多对多，<strong>一个用户可以有多个角色，一个角色也可以给多个用户</strong>。</li>
<li>以上就是ry控制权限的基本思想。</li>
</ul>
<h1 id="十六、深入源码理解权限控制"><a href="#十六、深入源码理解权限控制" class="headerlink" title="十六、深入源码理解权限控制"></a>十六、深入源码理解权限控制</h1><h2 id="1-何时获得权限"><a href="#1-何时获得权限" class="headerlink" title="1.何时获得权限"></a>1.何时获得权限</h2><ol>
<li>对于ry系统的ry用户（userId&#x3D;2的用户），它是在登录的时候就在数据库得到了属于自己的权限。回顾登录过程，在执行loadUserByUsername方法的时候，权限就已经被拿到了：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.web.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.entity.SysUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.enums.UserStatus;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.exception.ServiceException;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.system.service.ISysUserService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户验证处理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(UserDetailsServiceImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ISysUserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysPasswordService passwordService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysPermissionService permissionService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">SysUser</span> <span class="variable">user</span> <span class="operator">=</span> userService.selectUserByUserName(username);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNull(user))</span><br><span class="line">        &#123;</span><br><span class="line">            log.info(<span class="string">&quot;登录用户：&#123;&#125; 不存在.&quot;</span>, username);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;登录用户：&quot;</span> + username + <span class="string">&quot; 不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (UserStatus.DELETED.getCode().equals(user.getDelFlag()))</span><br><span class="line">        &#123;</span><br><span class="line">            log.info(<span class="string">&quot;登录用户：&#123;&#125; 已被删除.&quot;</span>, username);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;对不起，您的账号：&quot;</span> + username + <span class="string">&quot; 已被删除&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (UserStatus.DISABLE.getCode().equals(user.getStatus()))</span><br><span class="line">        &#123;</span><br><span class="line">            log.info(<span class="string">&quot;登录用户：&#123;&#125; 已被停用.&quot;</span>, username);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;对不起，您的账号：&quot;</span> + username + <span class="string">&quot; 已停用&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        passwordService.validate(user);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> createLoginUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">createLoginUser</span><span class="params">(SysUser user)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user.getUserId(), user.getDeptId(), user, permissionService.getMenuPermission(user));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>permissionService.getMenuPermission(user)则是根据当前登录的用户查询该用户的权限。转到方法进去看看：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取菜单数据权限</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> user 用户信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 菜单权限信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getMenuPermission</span><span class="params">(SysUser user)</span></span><br><span class="line">&#123;</span><br><span class="line">    Set&lt;String&gt; perms = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line">    <span class="comment">// 管理员拥有所有权限</span></span><br><span class="line">    <span class="keyword">if</span> (user.isAdmin())</span><br><span class="line">    &#123;</span><br><span class="line">        perms.add(<span class="string">&quot;*:*:*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;SysRole&gt; roles = user.getRoles();</span><br><span class="line">        <span class="keyword">if</span> (!roles.isEmpty() &amp;&amp; roles.size() &gt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 多角色设置permissions属性，以便数据权限匹配权限</span></span><br><span class="line">            <span class="keyword">for</span> (SysRole role : roles)</span><br><span class="line">            &#123;</span><br><span class="line">                Set&lt;String&gt; rolePerms = menuService.selectMenuPermsByRoleId(role.getRoleId());</span><br><span class="line">                role.setPermissions(rolePerms);</span><br><span class="line">                perms.addAll(rolePerms);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            perms.addAll(menuService.selectMenuPermsByUserId(user.getUserId()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> perms;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从上面的代码可以看到，如果是超级管理员就给权限字符串为“*:*:*”，那么什么样的人是超级管理员呢？我们直接看源码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAdmin</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> isAdmin(<span class="built_in">this</span>.userId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isAdmin</span><span class="params">(Long userId)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> userId != <span class="literal">null</span> &amp;&amp; <span class="number">1L</span> == userId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>原来userId&#x3D;1的用户就是超级管理员，也就是说超级管理员是代码写死的，牛逼和气质是与生俱来的，在前端判断字符串也要先看看权限字符串是不是“*:*:*”，如果是就知道是大爷来了都让道，直接获得所有权限。</li>
<li>那么如果不是超级管理员呢？代码中是执行了perms.addAll(menuService.selectMenuPermsByUserId(user.getUserId()))，也就是获得当前用户的userId，拿着userId去数据库查询权限。继续进入Service层代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户ID查询权限</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 权限列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">selectMenuPermsByUserId</span><span class="params">(Long userId)</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;String&gt; perms = menuMapper.selectMenuPermsByUserId(userId);</span><br><span class="line">    Set&lt;String&gt; permsSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String perm : perms)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(perm))</span><br><span class="line">        &#123;</span><br><span class="line">            permsSet.addAll(Arrays.asList(perm.trim().split(<span class="string">&quot;,&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> permsSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看出，此时去数据库查询权限，然后迭代查询的每个权限并且split分割了一下，通过“，”做的分割，所以<strong>我们写权限的时候可以这样写“system:user:add,system:user:edit”</strong>，可以在一个菜单的权限标识写好几个权限字符串，用逗号分割。</li>
<li>话说回来，去数据库怎么查询的权限呢？我们看到传入的只有userId，我们继续上源码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;selectMenuPermsByUserId&quot;</span> parameterType=<span class="string">&quot;Long&quot;</span> resultType=<span class="string">&quot;String&quot;</span>&gt;</span><br><span class="line">   select distinct m.perms</span><br><span class="line">   from sys_menu m</span><br><span class="line">       left join sys_role_menu rm on m.menu_id = rm.menu_id</span><br><span class="line">       left join sys_user_role ur on rm.role_id = ur.role_id</span><br><span class="line">       left join sys_role r on r.role_id = ur.role_id</span><br><span class="line">   where m.status = <span class="string">&#x27;0&#x27;</span> and r.status = <span class="string">&#x27;0&#x27;</span> and ur.user_id = #&#123;userId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到，到目前为止就已经是到了执行SQL了。我手动在navicat查询一下userId&#x3D;2用户的权限是什么，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161457067.png"
                      alt="图片"
                ></p>
<ul>
<li>可以看到SQL实际上就是不断在左连接，所谓左连接通俗而言就是左边表展示全部数据，右边表若匹配成功就连接，没有匹配成功就右边表空着。</li>
<li>学习左连接：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46628605/article/details/119728797" >https://blog.csdn.net/m0_46628605/article/details/119728797<i class="fas fa-external-link-alt"></i></a></li>
<li>从ry获取userId &#x3D; 2用户权限的SQL来看，实际就是所有权限左连接了角色，然后左连接用户，从而得到该用户的所有权限</li>
<li>值得注意的是，我们发现where后面有俩校验，校验status是不是＝0，其实在ry系统中status&#x3D;0表示正常的意思，status&#x3D;1表示停用的意思。</li>
<li>至此，我们说完了认证的时候获得权限的代码，ry把获得的权限放到了LoginUser类的实例中的字段permissions中存储起来，并把LoginUser的实例对象存储到了Redis中。</li>
<li>也就是说，登录过的用户Redis中存储着该用户的权限【那么这里就涉及到一个问题：当我用超级管理员修改了角色的权限，对于已经登录的和该角色相关联的用户，是不是立刻生效呢？<strong>其实对于页面权限是立刻生效的，但是对于按钮权限并不是立刻生效的，而是要重新登录重新从数据库获取权限，然后再存入Redis</strong>】。</li>
</ul>
<h2 id="2-用户菜单（页面权限）的获取"><a href="#2-用户菜单（页面权限）的获取" class="headerlink" title="2.用户菜单（页面权限）的获取"></a>2.用户菜单（页面权限）的获取</h2><ul>
<li>当用户登录完毕之后，左侧菜单栏展示出来了大量的菜单，对于不同权限的用户，展示的菜单不尽相同。那么，左侧菜单是怎么来的呢？这就需要打开“Layout”组件，然后找到侧边栏组件，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161526218.png"
                      alt="图片"
                ></p>
<ul>
<li>通过以上代码，发现每一个菜单为一个“SidebarItem”组件，我们也可以用开发者工具确定，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161526488.png"
                      alt="图片"
                ></p>
<ul>
<li><p>发现Layout组件的菜单栏组件是Sidebar，里面有一个ElMenu组件（对应整个菜单整体），这里面的SidebarItem全部都是一级菜单，一级菜单里面有ElSubmenu组件，对应我们的二级菜单整体，里面的SidebarItem组件为具体的每一个二级菜单。</p>
<p>我们可以发现，ElMenu中的菜单项的迭代数据来自变量sidebarRouters，所以我们到这里就知道，<strong>sidebarRouters变量的数据一定是后端查询来的菜单数据</strong>。我们继续深入，它是vuex的getters：</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...<span class="title function_">mapGetters</span>([<span class="string">&quot;sidebarRouters&quot;</span>, <span class="string">&quot;sidebar&quot;</span>]),</span><br></pre></td></tr></table></figure>

<p>继续追代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sidebarRouters</span>:<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">permission</span>.<span class="property">sidebarRouters</span>,</span><br></pre></td></tr></table></figure>

<p>追：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">state</span>: &#123;</span><br><span class="line">  <span class="attr">routes</span>: [],</span><br><span class="line">  <span class="attr">addRoutes</span>: [],</span><br><span class="line">  <span class="attr">defaultRoutes</span>: [],</span><br><span class="line">  <span class="attr">topbarRouters</span>: [],</span><br><span class="line">  <span class="attr">sidebarRouters</span>: []</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>到这里就追到底了，那么sidebarRouters是在哪里赋值的呢？我们继续看：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161532870.png"
                      alt="图片"
                ></p>
<ul>
<li>从上面发现，<strong>sidebarRouters</strong>的数据是来自<strong>两部分</strong>，一部分来自getRouters方法向后端发请求，返回的res的data经过filterAsyncRouter（<strong>ry解释了该方法的作用：遍历后台传来的路由字符串，转换为组件对象</strong>）方法过滤后的路由；另一部分来自constantRoutes，constantRoutes是写死的，<strong>来自router文件夹下的index.js文件</strong>：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 公共路由</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> constantRoutes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/redirect&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/redirect/:path(.*)&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/redirect&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/login&#x27;</span>),</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/register&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/register&#x27;</span>),</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/404&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/error/404&#x27;</span>),</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/401&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/error/401&#x27;</span>),</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&#x27;index&#x27;</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;index&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/index&#x27;</span>),</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Index&#x27;</span>,</span><br><span class="line">        <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;首页&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;dashboard&#x27;</span>, <span class="attr">affix</span>: <span class="literal">true</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/user&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&#x27;noredirect&#x27;</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;profile&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/system/user/profile/index&#x27;</span>),</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Profile&#x27;</span>,</span><br><span class="line">        <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;个人中心&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;user&#x27;</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>现在的问题就是getRouters方法从后端拿菜单，我们需要深入，追：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;@/utils/request&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取路由</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getRouters</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/getRouters&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>现在可以进入后端SysLoginController的getRouters方法了：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取路由信息</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 路由信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;getRouters&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getRouters</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> SecurityUtils.getUserId();</span><br><span class="line">    List&lt;SysMenu&gt; menus = menuService.selectMenuTreeByUserId(userId);</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.success(menuService.buildMenus(menus));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第一句话拿到了userId，然后通过userId获得了菜单树：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户ID查询菜单</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId 用户名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 菜单列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SysMenu&gt; <span class="title function_">selectMenuTreeByUserId</span><span class="params">(Long userId)</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;SysMenu&gt; menus = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (SecurityUtils.isAdmin(userId))</span><br><span class="line">    &#123;</span><br><span class="line">        menus = menuMapper.selectMenuTreeAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        menus = menuMapper.selectMenuTreeByUserId(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getChildPerms(menus, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从以上代码可以发现，如果是超级管理员直接获得全部菜单（ry在系统中对userId&#x3D;1的用户采取了硬编码方案，手动制造了一个超级牛逼管理员），普通用户则需要根据权限获得菜单：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectMenuTreeByUserId&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;SysMenuResult&quot;</span>&gt;</span></span><br><span class="line">   select distinct m.menu_id, m.parent_id, m.menu_name, m.path, m.component, m.`query`, m.visible, m.status, ifnull(m.perms,&#x27;&#x27;) as perms, m.is_frame, m.is_cache, m.menu_type, m.icon, m.order_num, m.create_time</span><br><span class="line">   from sys_menu m</span><br><span class="line">       left join sys_role_menu rm on m.menu_id = rm.menu_id</span><br><span class="line">       left join sys_user_role ur on rm.role_id = ur.role_id</span><br><span class="line">       left join sys_role ro on ur.role_id = ro.role_id</span><br><span class="line">       left join sys_user u on ur.user_id = u.user_id</span><br><span class="line">   where u.user_id = #&#123;userId&#125; and m.menu_type in (&#x27;M&#x27;, &#x27;C&#x27;) and m.status = 0  AND ro.status = 0</span><br><span class="line">   order by m.parent_id, m.order_num</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>上面SQL再明显不过了，查询menu_type类型为M和C的菜单，M表示目录，C表示菜单，从ry的数据库建表语句也可以得到证实：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161542657.png"
                      alt="图片"
                ></p>
<ul>
<li>查询到目录和菜单之后，通过构造树结构，然后再把树结构返回给了前端，关于树结构的构造逻辑不再赘述</li>
<li>目前还有一个问题，GenerateRoutes方法是什么时候执行的？如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161543778.png"
                      alt="图片"
                ></p>
<ul>
<li>可以发现，是在已经登录，并且不是去“&#x2F;login”的情况下，会执行生成路由方法。</li>
<li>以上我只是说明了左侧菜单栏能展示那么多菜单，但是要实现跳转，路由器的路由表也必须到位，实际上路由表就在下面一句话就成功添加到了路由器：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161544387.png"
                      alt="图片"
                ></p>
<ul>
<li>另外，左侧的菜单能进行跳转，利用了Applink组件（Sidebar文件夹下的Link.vue组件），如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161545102.png"
                      alt="图片"
                ></p>
<ul>
<li>Applink被渲染为了a标签，to&#x3D;xxxx被渲染为了href&#x3D;xxxx。关于组件的具体代码，不做展开。</li>
</ul>
<h2 id="3-页面权限补充"><a href="#3-页面权限补充" class="headerlink" title="3.页面权限补充"></a>3.页面权限补充</h2><ul>
<li>上一讲，我们只是说了页面权限的前端，前端为什么能展示出来那么多菜单，因为前端请求后端接口“getRouters”，后端根据前端人员的角色，查询出来了该用户的菜单权限，然后返回给前端，前端所以才显示那么多菜单。</li>
<li>一个新注册的用户，默认是没有任何角色的，那么登录就只有一个菜单，那就是首页，就像下面这样：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161756266.png"
                      alt="图片"
                ></p>
<ul>
<li>页面权限往往不仅仅和前端菜单展示有关，前端点击岗位管理的时候，调用了岗位管理的“system&#x2F;post&#x2F;list”接口，难道调用该接口不需要权限吗？？？</li>
<li>其实，调用该接口是需要权限的，并且权限为“system:post:list”，每一个接口的调用需要什么权限，我们都可以在上面的注解可以看到：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161756481.png"
                      alt="图片"
                ></p>
<ul>
<li>@<strong>PreAuthorize</strong>注解是SpringSecurity框架的注解，注解的value值所需要填写一个表达式，如果表达式计算的结果是true，那么就允许访问对应的接口，如果表达式计算的结果是false，则表示没有权限。</li>
<li>如果没有权限，那么会怎么样呢？我现在手动把岗位管理的接口权限改成“system:post:list1”，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161757413.png"
                      alt="图片"
                ></p>
<h2 id="4-PreAuthorize-启动奥义"><a href="#4-PreAuthorize-启动奥义" class="headerlink" title="4.@PreAuthorize 启动奥义"></a>4.@PreAuthorize 启动奥义</h2><ul>
<li>当我们需要用到@PreAuthorize注解，先需要写另一个注解来让@PreAuthorize注解能生效，ry程序在SecurityConfig类已经写了，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306191016894.png"
                      alt="image-20230619101620693"
                ></p>
<ul>
<li>EnableGlobalMethodSecurity注解后面的<strong>prePostEnabled方法</strong>（Determines if Spring Security’s pre post annotations should be enabled. Default is false.）表示**@PreAuthorize和@PostAuthorize注解要不要启用<strong>。@PreAuthorize表示在执行方法前验证权限，@PostAuthorize表示在执行方法后验证权限。</strong>一般用@PreAuthorize就够了**。</li>
<li>securedEnabled方法（Determines if Spring Security’s Secured annotations should be enabled.）没啥用，ry项目虽然开启使用，但也没用到，不做展开，需要了解的同学自行到下面了解：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/chihaihai/article/details/104678864" >https://blog.csdn.net/chihaihai/article/details/104678864<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<h2 id="5-PreAuthorize-的value方法奥义"><a href="#5-PreAuthorize-的value方法奥义" class="headerlink" title="5.@PreAuthorize 的value方法奥义"></a>5.@PreAuthorize 的value方法奥义</h2><ul>
<li>刚刚我们说到，@PreAuthorize的value值写SpEL表达式，并且返回值为true则可以执行方法，返回值为false则表示不能执行方法。</li>
<li>现在我们来分析SpEL表达式。SpEL表达式能写方法调用，ry程序就是写的方法表达式。岗位管理的表达式如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;system:post:list&#x27;)&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>SpEL表达式可以通过“@”来引用bean，这些知识大家可以通过查阅资料来学习</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306191024850.png"
                      alt="图片"
                ></p>
<ul>
<li>所以@ss在引用名为ss的Bean，然后调用该Bean的hasPermi方法，并传入了参数。@ss的bean为：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.web.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.entity.SysRole;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.security.context.PermissionContextHolder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RuoYi首创 自定义权限实现，ss取自SpringSecurity首字母</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(&quot;ss&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PermissionService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/** 所有权限标识 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ALL_PERMISSION</span> <span class="operator">=</span> <span class="string">&quot;*:*:*&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 管理员角色权限标识 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUPER_ADMIN</span> <span class="operator">=</span> <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROLE_DELIMETER</span> <span class="operator">=</span> <span class="string">&quot;,&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PERMISSION_DELIMETER</span> <span class="operator">=</span> <span class="string">&quot;,&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证用户是否具备某权限</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> permission 权限字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户是否具备某权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasPermi</span><span class="params">(String permission)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(permission))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> SecurityUtils.getLoginUser();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNull(loginUser) || CollectionUtils.isEmpty(loginUser.getPermissions()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        PermissionContextHolder.setContext(permission);</span><br><span class="line">        <span class="keyword">return</span> hasPermissions(loginUser.getPermissions(), permission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证用户是否不具备某权限，与 hasPermi逻辑相反</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> permission 权限字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户是否不具备某权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lacksPermi</span><span class="params">(String permission)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> hasPermi(permission) != <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证用户是否具有以下任意一个权限</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> permissions 以 PERMISSION_NAMES_DELIMETER 为分隔符的权限列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户是否具有以下任意一个权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasAnyPermi</span><span class="params">(String permissions)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(permissions))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> SecurityUtils.getLoginUser();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNull(loginUser) || CollectionUtils.isEmpty(loginUser.getPermissions()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        PermissionContextHolder.setContext(permissions);</span><br><span class="line">        Set&lt;String&gt; authorities = loginUser.getPermissions();</span><br><span class="line">        <span class="keyword">for</span> (String permission : permissions.split(PERMISSION_DELIMETER))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (permission != <span class="literal">null</span> &amp;&amp; hasPermissions(authorities, permission))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断用户是否拥有某个角色</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> role 角色字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户是否具备某角色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasRole</span><span class="params">(String role)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(role))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> SecurityUtils.getLoginUser();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNull(loginUser) || CollectionUtils.isEmpty(loginUser.getUser().getRoles()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (SysRole sysRole : loginUser.getUser().getRoles())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">roleKey</span> <span class="operator">=</span> sysRole.getRoleKey();</span><br><span class="line">            <span class="keyword">if</span> (SUPER_ADMIN.equals(roleKey) || roleKey.equals(StringUtils.trim(role)))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证用户是否不具备某角色，与 isRole逻辑相反。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> role 角色名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户是否不具备某角色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lacksRole</span><span class="params">(String role)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> hasRole(role) != <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证用户是否具有以下任意一个角色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> roles 以 ROLE_NAMES_DELIMETER 为分隔符的角色列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户是否具有以下任意一个角色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasAnyRoles</span><span class="params">(String roles)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(roles))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> SecurityUtils.getLoginUser();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNull(loginUser) || CollectionUtils.isEmpty(loginUser.getUser().getRoles()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (String role : roles.split(ROLE_DELIMETER))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasRole(role))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否包含权限</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> permissions 权限列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> permission 权限字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户是否具备某权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasPermissions</span><span class="params">(Set&lt;String&gt; permissions, String permission)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> permissions.contains(ALL_PERMISSION) || permissions.contains(StringUtils.trim(permission));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>综上所述，表达式“@ss.hasPermi(‘system:post:list’)”的意思是调用下面的方法，并传参数为system:post:list，如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证用户是否具备某权限</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> permission 权限字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 用户是否具备某权限</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasPermi</span><span class="params">(String permission)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(permission))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> SecurityUtils.getLoginUser();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNull(loginUser) || CollectionUtils.isEmpty(loginUser.getPermissions()))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    PermissionContextHolder.setContext(permission);</span><br><span class="line">    <span class="keyword">return</span> hasPermissions(loginUser.getPermissions(), permission);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>该方法的作用是验证请求API的用户是否具有接口权限，从源码可以看到，该方法先获得了安全上下文的认证授权相关的信息：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> LoginUser <span class="title function_">getLoginUser</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (LoginUser) getAuthentication().getPrincipal();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;获取用户信息异常&quot;</span>, HttpStatus.UNAUTHORIZED);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取Authentication</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Authentication <span class="title function_">getAuthentication</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>验证是否有权限的源码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断是否包含权限</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> permissions 权限列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> permission 权限字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 用户是否具备某权限</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasPermissions</span><span class="params">(Set&lt;String&gt; permissions, String permission)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> permissions.contains(ALL_PERMISSION) || permissions.contains(StringUtils.trim(permission));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>值得注意的是，这里验证时给超级管理员开了后门（如果权限是*:*:*则会直接返回true）：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306211010027.png"
                      alt="image-20230621101029869"
                ></p>
<p>以上只要返回true，则表达式“@ss.hasPermi(‘system:post:list’)”返回true，则用户可以执行对应的方法，所以用户自然也正常打开了页面。</p>
<h2 id="6-按钮权限在前端的表现形式"><a href="#6-按钮权限在前端的表现形式" class="headerlink" title="6.按钮权限在前端的表现形式"></a>6.按钮权限在前端的表现形式</h2><ul>
<li>按钮权限在前端的表现为vue组件、HTML标签是否显示。在ry程序中，最常用的方式就是控制按钮显示还是不显示，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306211023776.png"
                      alt="image-20230621102355587"
                ></p>
<ul>
<li>也就是说，当用户具有“system:user:export”权限时，新增的el-button组件才会显示，否则直接不显示按钮。</li>
</ul>
<h2 id="7-v-hasPermi指令奥义"><a href="#7-v-hasPermi指令奥义" class="headerlink" title="7.v-hasPermi指令奥义"></a>7.v-hasPermi指令奥义</h2><ul>
<li>v-hasPermi是一个新指令，vue本身自身没有的，那么只能是ry自己写的一个新指令。ry所有自定义指令在src&#x2F;directive下，在main.js引入了src&#x2F;directive&#x2F;index.js：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...省略其他源码</span><br><span class="line"><span class="keyword">import</span> directive <span class="keyword">from</span> <span class="string">&#x27;./directive&#x27;</span> <span class="comment">// directive</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(directive)</span><br><span class="line">...省略其他源码</span><br></pre></td></tr></table></figure>

<ul>
<li>从上面可以发现，自定义指令是以插件的形式包装的，Vue.use方法会自动执行插件的install方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="variable">install</span> <span class="operator">=</span> function(Vue) &#123;</span><br><span class="line">  Vue.directive(<span class="string">&#x27;hasRole&#x27;</span>, hasRole)</span><br><span class="line">  Vue.directive(<span class="string">&#x27;hasPermi&#x27;</span>, hasPermi)</span><br><span class="line">  Vue.directive(<span class="string">&#x27;clipboard&#x27;</span>, clipboard)</span><br><span class="line">  Vue.directive(<span class="string">&#x27;dialogDrag&#x27;</span>, dialogDrag)</span><br><span class="line">  Vue.directive(<span class="string">&#x27;dialogDragWidth&#x27;</span>, dialogDragWidth)</span><br><span class="line">  Vue.directive(<span class="string">&#x27;dialogDragHeight&#x27;</span>, dialogDragHeight)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>install方法中，我们看到v-hasPermi被注册。具体的源码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * v-hasPermi 操作权限处理</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2019 ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> store from <span class="string">&#x27;@/store&#x27;</span></span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> &#123;</span><br><span class="line">  inserted(el, binding, vnode) &#123;</span><br><span class="line">    const &#123; value &#125; = binding</span><br><span class="line">    <span class="type">const</span> <span class="variable">all_permission</span> <span class="operator">=</span> <span class="string">&quot;*:*:*&quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="variable">permissions</span> <span class="operator">=</span> store.getters &amp;&amp; store.getters.permissions</span><br><span class="line"></span><br><span class="line">    <span class="title function_">if</span> <span class="params">(value &amp;&amp; value <span class="keyword">instanceof</span> Array &amp;&amp; value.length &gt; <span class="number">0</span>)</span> &#123;</span><br><span class="line">      <span class="type">const</span> <span class="variable">permissionFlag</span> <span class="operator">=</span> value</span><br><span class="line"></span><br><span class="line">      <span class="type">const</span> <span class="variable">hasPermissions</span> <span class="operator">=</span> permissions.some(permission =&gt; &#123;</span><br><span class="line">        <span class="type">return</span> <span class="variable">all_permission</span> <span class="operator">=</span>== permission || permissionFlag.includes(permission)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!hasPermissions) &#123;</span><br><span class="line">        el.parentNode &amp;&amp; el.parentNode.removeChild(el)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(`请设置操作权限标签值`)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看出，对象里面只有一个方法inserted，也就是在被绑定元素插入父节点时调用，<strong>这里正好可以判断有没有权限，有就插入，没有就直接移除dom即可</strong>。inserted有三个形参，介绍如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306211032151.png"
                      alt="图片"
                ></p>
<ul>
<li>为什么我用红色框框起来了el和value？因为v-hasPermi指令就只用到了el和value，其他参数不做介绍</li>
</ul>
<h2 id="8-前端debug，秘奥义·震雷削"><a href="#8-前端debug，秘奥义·震雷削" class="headerlink" title="8.前端debug，秘奥义·震雷削"></a>8.前端debug，秘奥义·震雷削</h2><ul>
<li>首先需要修改vue.config.js：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">configureWebpack</span>: &#123;    </span><br><span class="line">    ...省略其他代码    </span><br><span class="line">    <span class="attr">devtool</span>: process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span> ? <span class="string">&#x27;source-map&#x27;</span> : <span class="literal">undefined</span>,    </span><br><span class="line">    ...省略其他代码 </span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li><p>以上的一句话意思是，在dev模式启动程序，则允许源码被浏览器看到。关于devtool的配置选项其他还有很多，大家可以自行学习：</p>
<ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40599109/article/details/107845431" >https://blog.csdn.net/weixin_40599109/article/details/107845431<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/sshuai131400/article/details/121223357" >https://blog.csdn.net/sshuai131400/article/details/121223357<i class="fas fa-external-link-alt"></i></a></li>
</ul>
</li>
<li><p>此时此刻，前端就可以看到源码</p>
</li>
<li><p>debug时需要看作用域下的各个变量的值来确认程序是不是按照自己的想法来进行走向。经过debug，发现关键代码就是如果没权限，那么移除当前el，源码：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="variable">hasPermissions</span> <span class="operator">=</span> permissions.some(permission =&gt; &#123;</span><br><span class="line">  <span class="type">return</span> <span class="variable">all_permission</span> <span class="operator">=</span>== permission || permissionFlag.includes(permission)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!hasPermissions) &#123;</span><br><span class="line">  el.parentNode &amp;&amp; el.parentNode.removeChild(el)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面涉及JavaScript的Array的some方法，需要详细了解的话：<a class="link"   target="_blank" rel="noopener" href="https://www.runoob.com/jsref/jsref-some.html" >https://www.runoob.com/jsref/jsref-some.html<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306211049340.png"
                      alt="image-20230621104951110"
                ></p>
<ul>
<li>以上变量的值怎么来的？原来是在mutations里面的如下方法赋值的：src&#x2F;store&#x2F;modules&#x2F;user.js</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET_PERMISSIONS: (state, permissions) =&gt; &#123;</span><br><span class="line">  state.permissions = permissions</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>那么SET_PERMISSIONS方法是谁调用的呢？如下：src&#x2F;store&#x2F;modules&#x2F;user.js</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取用户信息</span></span><br><span class="line">GetInfo(&#123; commit, state &#125;) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>((resolve, reject) =&gt; &#123;</span><br><span class="line">    getInfo().then(res =&gt; &#123;</span><br><span class="line">      <span class="type">const</span> <span class="variable">user</span> <span class="operator">=</span> res.user</span><br><span class="line">      <span class="type">const</span> <span class="variable">avatar</span> <span class="operator">=</span> (user.avatar == <span class="string">&quot;&quot;</span> || user.avatar == <span class="literal">null</span>) ? require(<span class="string">&quot;@/assets/images/profile.jpg&quot;</span>) : process.env.VUE_APP_BASE_API + user.avatar;</span><br><span class="line">      <span class="keyword">if</span> (res.roles &amp;&amp; res.roles.length &gt; <span class="number">0</span>) &#123; <span class="comment">// 验证返回的roles是否是一个非空数组</span></span><br><span class="line">        commit(<span class="string">&#x27;SET_ROLES&#x27;</span>, res.roles)</span><br><span class="line">        commit(<span class="string">&#x27;SET_PERMISSIONS&#x27;</span>, res.permissions)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        commit(<span class="string">&#x27;SET_ROLES&#x27;</span>, [<span class="string">&#x27;ROLE_DEFAULT&#x27;</span>])</span><br><span class="line">      &#125;</span><br><span class="line">      commit(<span class="string">&#x27;SET_NAME&#x27;</span>, user.userName)</span><br><span class="line">      commit(<span class="string">&#x27;SET_AVATAR&#x27;</span>, avatar)</span><br><span class="line">      resolve(res)</span><br><span class="line">    &#125;).<span class="keyword">catch</span>(error =&gt; &#123;</span><br><span class="line">      reject(error)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>原来是在GetInfo的时候获取到的，并且拿到了res的permissions。那么GetInfo又是什么时候调用的呢？继续追代码：src&#x2F;permission.js</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306211052743.png"
                      alt="image-20230621105244507"
                ></p>
<ul>
<li>到这里就追到底了，原来是全局前置路由守卫，只要带了token，不访问&#x2F;login路由，并且vuex的user的roles的size为0，就会执行一次GetInfo方法。如果要细细理解，建议看懂每一句话：src&#x2F;permission.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Message</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">NProgress</span> <span class="keyword">from</span> <span class="string">&#x27;nprogress&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;nprogress/nprogress.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; getToken &#125; <span class="keyword">from</span> <span class="string">&#x27;@/utils/auth&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; isRelogin &#125; <span class="keyword">from</span> <span class="string">&#x27;@/utils/request&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">NProgress</span>.<span class="title function_">configure</span>(&#123; <span class="attr">showSpinner</span>: <span class="literal">false</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> whiteList = [<span class="string">&#x27;/login&#x27;</span>, <span class="string">&#x27;/register&#x27;</span>]</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">NProgress</span>.<span class="title function_">start</span>()</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">getToken</span>()) &#123;</span><br><span class="line">    to.<span class="property">meta</span>.<span class="property">title</span> &amp;&amp; store.<span class="title function_">dispatch</span>(<span class="string">&#x27;settings/setTitle&#x27;</span>, to.<span class="property">meta</span>.<span class="property">title</span>)</span><br><span class="line">    <span class="comment">/* has token*/</span></span><br><span class="line">    <span class="keyword">if</span> (to.<span class="property">path</span> === <span class="string">&#x27;/login&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">next</span>(&#123; <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span> &#125;)</span><br><span class="line">      <span class="title class_">NProgress</span>.<span class="title function_">done</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (store.<span class="property">getters</span>.<span class="property">roles</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        isRelogin.<span class="property">show</span> = <span class="literal">true</span></span><br><span class="line">        <span class="comment">// 判断当前用户是否已拉取完user_info信息</span></span><br><span class="line">        store.<span class="title function_">dispatch</span>(<span class="string">&#x27;GetInfo&#x27;</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          isRelogin.<span class="property">show</span> = <span class="literal">false</span></span><br><span class="line">          store.<span class="title function_">dispatch</span>(<span class="string">&#x27;GenerateRoutes&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">accessRoutes</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 根据roles权限生成可访问的路由表</span></span><br><span class="line">            router.<span class="title function_">addRoutes</span>(accessRoutes) <span class="comment">// 动态添加可访问路由表</span></span><br><span class="line">            <span class="title function_">next</span>(&#123; ...to, <span class="attr">replace</span>: <span class="literal">true</span> &#125;) <span class="comment">// hack方法 确保addRoutes已完成</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">            store.<span class="title function_">dispatch</span>(<span class="string">&#x27;LogOut&#x27;</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">              <span class="title class_">Message</span>.<span class="title function_">error</span>(err)</span><br><span class="line">              <span class="title function_">next</span>(&#123; <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span> &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 没有token</span></span><br><span class="line">    <span class="keyword">if</span> (whiteList.<span class="title function_">indexOf</span>(to.<span class="property">path</span>) !== -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// 在免登录白名单，直接进入</span></span><br><span class="line">      <span class="title function_">next</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">next</span>(<span class="string">`/login?redirect=<span class="subst">$&#123;to.fullPath&#125;</span>`</span>) <span class="comment">// 否则全部重定向到登录页</span></span><br><span class="line">      <span class="title class_">NProgress</span>.<span class="title function_">done</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">afterEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">NProgress</span>.<span class="title function_">done</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="十七、第三方登陆"><a href="#十七、第三方登陆" class="headerlink" title="十七、第三方登陆"></a>十七、第三方登陆</h1><h2 id="1-第三方登录"><a href="#1-第三方登录" class="headerlink" title="1.第三方登录"></a>1.第三方登录</h2><ul>
<li>当今社会，微信登录、QQ登录、抖音登录等等三方登录已经层出不穷，学会三方登录势在必行。微信登录要认证开发者，必须为企业，个人不行，而且还要交300块钱。一听到钱，白嫖党的钱是不可能被赚的，不学微信登录。QQ登录也要申请、微博登录也要申请。还好Gitee给力，申请轻轻松松，谁都能轻松让Gitee作为第三方登录，此次我们就讲解Gitee来登录ry。其实其他的登录也是基本上一样的。</li>
</ul>
<h2 id="2-JustAuth-奥义·穿风刺"><a href="#2-JustAuth-奥义·穿风刺" class="headerlink" title="2.JustAuth 奥义·穿风刺"></a>2.JustAuth 奥义·穿风刺</h2><ul>
<li>JustAuth能让我们第三方登录写少一些代码，它包装了国内外30多种三方登录。</li>
<li>学习JustAuth网站：<a class="link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA3NDk3OTIwMg==&amp;mid=2450633106&amp;idx=1&amp;sn=131e39d52347dffefbd4227b18b794bf&amp;chksm=8892937fbfe51a69950cb0769e2b22d04217254b0e79cdcee4204aedb2007627ab6511b58355&amp;token=29120304&amp;lang=zh_CN#rd](https://mp.weixin.qq.com/s?__biz=MzA3NDk3OTIwMg==&amp;mid=2450633106&amp;idx=1&amp;sn=131e39d52347dffefbd4227b18b794bf&amp;chksm=8892937fbfe51a69950cb0769e2b22d04217254b0e79cdcee4204aedb2007627ab6511b58355&amp;token=29120304&amp;lang=zh_CN&amp;scene=21#wechat_redirect)" >https://mp.weixin.qq.com/s?__biz=MzA3NDk3OTIwMg==&amp;mid=2450633106&amp;idx=1&amp;sn=131e39d52347dffefbd4227b18b794bf&amp;chksm=8892937fbfe51a69950cb0769e2b22d04217254b0e79cdcee4204aedb2007627ab6511b58355&amp;token=29120304&amp;lang=zh_CN#rd](https://mp.weixin.qq.com/s?__biz=MzA3NDk3OTIwMg==&amp;mid=2450633106&amp;idx=1&amp;sn=131e39d52347dffefbd4227b18b794bf&amp;chksm=8892937fbfe51a69950cb0769e2b22d04217254b0e79cdcee4204aedb2007627ab6511b58355&amp;token=29120304&amp;lang=zh_CN&amp;scene=21#wechat_redirect)<i class="fas fa-external-link-alt"></i></a>  <a class="link"   target="_blank" rel="noopener" href="https://justauth.wiki/guide/quickstart/how-to-use/#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4" >https://justauth.wiki/guide/quickstart/how-to-use/#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4<i class="fas fa-external-link-alt"></i></a></li>
<li><strong>使用步骤</strong>使用JustAuth总共分三步（这三步也适合于JustAuth支持的任何一个平台）：<ul>
<li>申请注册第三方平台的开发者账号。我们找到gitee的设置，进入第三方应用，如下：</li>
</ul>
</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306211334669.png"
                      alt="image-20230621133411315"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306211340087.png"
                      alt="image-20230621134054871"
                ></p>
<ul>
<li><p>应用主页随便填一个自己的应用页面即可。<strong>但是应用回调不能乱填，当我们gitee登录成功之后，gitee会自动跳转到应用回调地址，并且gitee会带上code，利用code可以得到所登录gitee用户信息。</strong></p>
</li>
<li><p>创建第三方平台的应用，获取配置信息(accessKey, secretKey, redirectUri)。<strong>上面我们已经创建了应用，自然有了这三个值。</strong></p>
</li>
<li><p>使用该工具实现授权登陆。利用工具先要引入依赖：依赖引入到核心框架（framework）下。</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>me.zhyd.oauth<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>JustAuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>接下来改login.vue，如下：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div style=&quot;width: 32px;height: 32px;margin-top: 5px;cursor: pointer;&quot; title=&quot;利用Gitee登录&quot; @click=&quot;giteeLogin&quot;&gt;</span><br><span class="line">  &lt;img style=&quot;height: 100%;width: 100%;&quot; src=&quot;../assets/logo/gitee.png&quot;&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306211349803.png"
                      alt="image-20230621134940626"
                ></p>
<ul>
<li>然后我们看一下点击事件：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">giteeLogin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title class_">PreLoginByGitee</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Cookies</span>.<span class="title function_">set</span>(<span class="string">&quot;user-uuid&quot;</span>, res.<span class="property">uuid</span>)</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">location</span> = res.<span class="property">authorizeUrl</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>以上是在methods中，我们看到直接请求了PreLoginByGitee：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">PreLoginByGitee</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/PreLoginByGitee&#x27;</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="attr">isToken</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对应的后端接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.web.controller.login;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.uuid.IdUtils;</span><br><span class="line"><span class="keyword">import</span> me.zhyd.oauth.config.AuthConfig;</span><br><span class="line"><span class="keyword">import</span> me.zhyd.oauth.request.AuthGiteeRequest;</span><br><span class="line"><span class="keyword">import</span> me.zhyd.oauth.request.AuthRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GiteeLoginController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/PreLoginByGitee&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">PreLoginByGitee</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AjaxResult</span> <span class="variable">ajax</span> <span class="operator">=</span> AjaxResult.success();</span><br><span class="line">        <span class="type">AuthRequest</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthGiteeRequest</span>(AuthConfig.builder()</span><br><span class="line">                .clientId(<span class="string">&quot;f76be3cb0b59e6a35ae52f0e860ebb2fa6d02135db65aa50863ae83ae39c44b0&quot;</span>)</span><br><span class="line">                .clientSecret(<span class="string">&quot;e6c7d5f81d2b043524293e5ecf289a60dcebe1b75575a1eea636968a673aed42&quot;</span>)</span><br><span class="line">                .redirectUri(<span class="string">&quot;http://localhost/callback&quot;</span>)</span><br><span class="line">                .build());</span><br><span class="line">        <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> IdUtils.fastUUID();</span><br><span class="line">        <span class="type">String</span> <span class="variable">authorizeUrl</span> <span class="operator">=</span> authRequest.authorize(uuid);</span><br><span class="line">        <span class="comment">//存储</span></span><br><span class="line">        ajax.put(<span class="string">&quot;authorizeUrl&quot;</span>, authorizeUrl);</span><br><span class="line">        ajax.put(<span class="string">&quot;uuid&quot;</span>, uuid);</span><br><span class="line">        <span class="keyword">return</span> ajax;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>记得去SecurityConfig中添加接口，允许匿名访问</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对于登录login 注册register 验证码captchaImage 允许匿名访问</span></span><br><span class="line">.antMatchers(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/captchaImage&quot;</span>,<span class="string">&quot;/PreLoginByGitee&quot;</span>).permitAll()</span><br></pre></td></tr></table></figure>

<ul>
<li>以上的代码是生成跳转路径。生成一个gitee的路径，在该页面gitee只要登录完成，gitee程序会自动跳转到我们之前设置好的回调地址。这里我们发现我们一直拿着一个uuid在传来传去，还传去了前端，它有什么鸟用呢？</li>
<li>authRequest.authorize(uuid)用到了uuid，并且后面要执行：要保证俩uuid为同一个，所以uuid才传来传去。</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authRequest.login(AuthCallback.builder().state(uuid).code(code).build());</span><br></pre></td></tr></table></figure>

<ul>
<li>在views中新建一个loginByGitee.vue</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div v-loading=&quot;loading&quot; style=&quot;height: 100%;width: 100%;&quot;&gt;</span><br><span class="line">    正在加载中...</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import Cookies from &quot;js-cookie&quot;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;loginByGitee&quot;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      loading: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    this.loading = true;</span><br><span class="line">    console.log(&quot;uuid&quot;, Cookies.get(&quot;user-uuid&quot;))</span><br><span class="line">    const formBody = &#123;</span><br><span class="line">      uuid: Cookies.get(&quot;user-uuid&quot;),</span><br><span class="line">      code: this.$route.query.code</span><br><span class="line">    &#125;</span><br><span class="line">    this.$store.dispatch(&quot;LoginByGitee&quot;, formBody).then(() =&gt; &#123;</span><br><span class="line">      this.$router.push(&#123;path: this.redirect || &quot;/&quot;&#125;).catch(() =&gt; &#123;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;).catch(() =&gt; &#123;</span><br><span class="line">      this.loading = false;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>在路由中注册路径</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/callback&#x27;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/loginByGitee &#x27;</span>),</span><br><span class="line">  <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>在user.js中写入方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">LoginByGitee</span>(&#123;commit&#125;, body) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">loginByGitee</span>(body.<span class="property">code</span>, body.<span class="property">uuid</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setToken</span>(res.<span class="property">token</span>)</span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;SET_TOKEN&#x27;</span>, res.<span class="property">token</span>)</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">reject</span>(error)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>在login.js中也写入loginByGitee方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">loginByGitee</span>(<span class="params">code, uuid</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = &#123;</span><br><span class="line">    code,</span><br><span class="line">    <span class="attr">source</span>: <span class="string">&quot;Gitee&quot;</span>,</span><br><span class="line">    uuid</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/loginByGitee&#x27;</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="attr">isToken</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: data</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用后端的代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/loginByGitee&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">loginByGitee</span><span class="params">(<span class="meta">@RequestBody</span> LoginByOtherSourceBody loginByOtherSourceBody)</span> &#123;</span><br><span class="line">    <span class="type">AjaxResult</span> <span class="variable">ajax</span> <span class="operator">=</span> AjaxResult.success();</span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> loginService</span><br><span class="line">            .loginByOtherSource(loginByOtherSourceBody.getCode(), loginByOtherSourceBody.getSource(), loginByOtherSourceBody.getUuid());</span><br><span class="line">    ajax.put(Constants.TOKEN, token);</span><br><span class="line">    <span class="keyword">return</span> ajax;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<ul>
<li>loginService层</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">loginByOtherSource</span><span class="params">(String code, String source, String uuid)</span> &#123;</span><br><span class="line">    <span class="comment">//先到数据库查询这个人曾经有没有登录过，没有就注册</span></span><br><span class="line">    <span class="comment">// 创建授权request</span></span><br><span class="line">    <span class="type">AuthRequest</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthGiteeRequest</span>(AuthConfig.builder()</span><br><span class="line">            .clientId(<span class="string">&quot;f76be3cb0b59e6a35ae52f0e860ebb2fa6d02135db65aa50863ae83ae39c44b0&quot;</span>)</span><br><span class="line">            .clientSecret(<span class="string">&quot;e6c7d5f81d2b043524293e5ecf289a60dcebe1b75575a1eea636968a673aed42&quot;</span>)</span><br><span class="line">            .redirectUri(<span class="string">&quot;http://localhost/callback&quot;</span>)</span><br><span class="line">            .build());</span><br><span class="line">    AuthResponse&lt;AuthUser&gt; login = authRequest.login(AuthCallback.builder().state(uuid).code(code).build());</span><br><span class="line">    System.out.println(login);</span><br><span class="line">    <span class="comment">//先查询数据库有没有该用户</span></span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">authUser</span> <span class="operator">=</span> login.getData();</span><br><span class="line">    <span class="type">SysUser</span> <span class="variable">sysUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SysUser</span>();</span><br><span class="line">    sysUser.setUserName(authUser.getUsername());</span><br><span class="line">    sysUser.setSource(authUser.getSource());</span><br><span class="line">    List&lt;SysUser&gt; sysUsers = userService.selectUserListNoDataScope(sysUser);</span><br><span class="line">    <span class="keyword">if</span> (sysUsers.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;第三方登录异常，账号重叠&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sysUsers.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//相当于注册</span></span><br><span class="line">        sysUser.setNickName(authUser.getNickname());</span><br><span class="line">        sysUser.setAvatar(authUser.getAvatar());</span><br><span class="line">        sysUser.setEmail(authUser.getEmail());</span><br><span class="line">        sysUser.setRemark(authUser.getRemark());</span><br><span class="line">        userService.registerUserAndGetUserId(sysUser);</span><br><span class="line">        AsyncManager.me().execute(AsyncFactory.recordLogininfor(sysUser.getUserName(), Constants.REGISTER,</span><br><span class="line">                MessageUtils.message(<span class="string">&quot;user.register.success&quot;</span>)));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sysUser = sysUsers.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    AsyncManager.me().execute(AsyncFactory.recordLogininfor(sysUser.getUserName(), Constants.LOGIN_SUCCESS, MessageUtils.message(<span class="string">&quot;user.login.success&quot;</span>)));</span><br><span class="line">    <span class="comment">//注册成功或者是已经存在的用户</span></span><br><span class="line">    <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LoginUser</span>(sysUser.getUserId(), sysUser.getDeptId(), sysUser, permissionService.getMenuPermission(sysUser));</span><br><span class="line">    recordLoginInfo(loginUser.getUserId());</span><br><span class="line">    <span class="comment">// 生成token</span></span><br><span class="line">    <span class="keyword">return</span> tokenService.createToken(loginUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上添加的代码会有很多爆红，SysUser首先添加一个字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String source;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getSource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> source;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSource</span><span class="params">(String source)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.source = source;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后再数据库sys_user中添加一个字段source，对应的mapper该加加</li>
<li>registerUserAndGetUserId是自己创建的方法写接口和实现类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Long <span class="title function_">registerUserAndGetUserId</span><span class="params">(SysUser user)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">registerUserAndGetUserId</span><span class="params">(SysUser user)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> userMapper.registerUserAndGetUserId(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用的userMapper</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Long <span class="title function_">registerUserAndGetUserId</span><span class="params">(SysUser user)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=<span class="string">&quot;registerUserAndGetUserId&quot;</span> parameterType=<span class="string">&quot;SysUser&quot;</span> useGeneratedKeys=<span class="string">&quot;true&quot;</span> keyProperty=<span class="string">&quot;userId&quot;</span>&gt;</span><br><span class="line">      insert into <span class="title function_">sys_user</span><span class="params">(</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;userId != null and userId != 0&quot;</span>&gt;user_id,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;deptId != null and deptId != 0&quot;</span>&gt;dept_id,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;userName != null and userName != &#x27;&#x27;&quot;</span>&gt;user_name,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;source != null and source != &#x27;&#x27;&quot;</span>&gt;source,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;nickName != null and nickName != &#x27;&#x27;&quot;</span>&gt;nick_name,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;email != null and email != &#x27;&#x27;&quot;</span>&gt;email,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;avatar != null and avatar != &#x27;&#x27;&quot;</span>&gt;avatar,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;phonenumber != null and phonenumber != &#x27;&#x27;&quot;</span>&gt;phonenumber,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;sex != null and sex != &#x27;&#x27;&quot;</span>&gt;sex,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;password != null and password != &#x27;&#x27;&quot;</span>&gt;password,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;status != null and status != &#x27;&#x27;&quot;</span>&gt;status,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;createBy != null and createBy != &#x27;&#x27;&quot;</span>&gt;create_by,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;remark != null and remark != &#x27;&#x27;&quot;</span>&gt;remark,&lt;/<span class="keyword">if</span>&gt;</span></span><br><span class="line"><span class="params">         create_time</span></span><br><span class="line"><span class="params">      )</span>values(</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;userId != null and userId != &#x27;&#x27;&quot;</span>&gt;#&#123;userId&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;deptId != null and deptId != &#x27;&#x27;&quot;</span>&gt;#&#123;deptId&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;userName != null and userName != &#x27;&#x27;&quot;</span>&gt;#&#123;userName&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;source != null and source != &#x27;&#x27;&quot;</span>&gt;#&#123;source&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;nickName != null and nickName != &#x27;&#x27;&quot;</span>&gt;#&#123;nickName&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;email != null and email != &#x27;&#x27;&quot;</span>&gt;#&#123;email&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;avatar != null and avatar != &#x27;&#x27;&quot;</span>&gt;#&#123;avatar&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;phonenumber != null and phonenumber != &#x27;&#x27;&quot;</span>&gt;#&#123;phonenumber&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;sex != null and sex != &#x27;&#x27;&quot;</span>&gt;#&#123;sex&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;password != null and password != &#x27;&#x27;&quot;</span>&gt;#&#123;password&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;status != null and status != &#x27;&#x27;&quot;</span>&gt;#&#123;status&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;createBy != null and createBy != &#x27;&#x27;&quot;</span>&gt;#&#123;createBy&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;remark != null and remark != &#x27;&#x27;&quot;</span>&gt;#&#123;remark&#125;,&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         sysdate()</span><br><span class="line">      )</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>字段source。如下代码可以获得登录source</strong>：source表示登录平台，如微信登录，支付宝登录，因为要确定用户的唯一性。username在不同的平台可能会重复，但是username+source就不会重复了。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AuthUser</span> <span class="variable">authUser</span> <span class="operator">=</span> login.getData();</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>新写了一个查询方法，如下：</strong>新重写一个查询的原因是原来的的方法有数据权限：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">userService.selectUserListNoDataScope(sysUser);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;SysUser&gt; <span class="title function_">selectUserListNoDataScope</span><span class="params">(SysUser user)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> userMapper.selectUserList(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>当我们第一次登录成功，什么权限都没有，需要admin设置一下权限，或者在注册的时候给新用户一个“普通角色”。</strong></p>
</li>
<li><p><strong>新登录用户，头像根本显示不了，改成如下就能显示了【文件user.js】：</strong></p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> avatar;</span><br><span class="line"><span class="keyword">if</span> (user.<span class="property">avatar</span> == <span class="string">&quot;&quot;</span> || user.<span class="property">avatar</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">  avatar = <span class="built_in">require</span>(<span class="string">&quot;@/assets/images/profile.jpg&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (user.<span class="property">avatar</span>.<span class="title function_">startsWith</span>(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">  avatar = user.<span class="property">avatar</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  avatar = process.<span class="property">env</span>.<span class="property">VUE_APP_BASE_API</span> + user.<span class="property">avatar</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>前端一定要放行白名单</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306251008143.png"
                      alt="image-20230625100808827"
                ></p>
<h1 id="十八、新建后端模块与包名的修改"><a href="#十八、新建后端模块与包名的修改" class="headerlink" title="十八、新建后端模块与包名的修改"></a>十八、新建后端模块与包名的修改</h1><h2 id="1-包名的修改"><a href="#1-包名的修改" class="headerlink" title="1.包名的修改"></a>1.包名的修改</h2><p>我们所说的包名修改，是一次性修改ruoyi的全部包名，因为发现很多人有这样的需求，下载别人的代码，想要改成自己公司的包名，结果一改就各种出现问题，程序都起不来了，气死。</p>
<hr>
<ul>
<li><p>给大家介绍一款工具，下载它能一键修改：</p>
<ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://gitee.com/lpf_project/common-tools" >https://gitee.com/lpf_project/common-tools<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://gitee.com/lpf_project/common-tools/releases/tag/V4-20220517" >https://gitee.com/lpf_project/common-tools/releases/tag/V4-20220517<i class="fas fa-external-link-alt"></i></a></li>
</ul>
</li>
<li><p>通过修改器可以一键修改包名和外层文件夹名字。</p>
</li>
</ul>
<h2 id="2-后端模块的新建"><a href="#2-后端模块的新建" class="headerlink" title="2.后端模块的新建"></a>2.后端模块的新建</h2><ul>
<li>对准项目根文件右键新建选择模块：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306251130826.png"
                      alt="image-20230625113039660"
                ></p>
<ul>
<li>然后新建模块，注意父模块要选fzx，名称随便取一个，但是要符合起名习惯，我现在取名字为fzx：(就是新建maven项目)</li>
<li>接下来就是要在根pom和admin的pom下引入该模块</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306251433398.png"
                      alt="image-20230625143336090"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306251433365.png"
                      alt="image-20230625143355204"
                ></p>
<blockquote>
<p>关于依赖，说的是什么呢？我新建的ruoyi-wqj可能或多或少依赖于ruoyi-framework或者ruoyi-common，当我们引入依赖的时候，一定不要造成循环依赖。</p>
<p>循环依赖会造成打包直接报错。循环依赖就是说A依赖B，B又依赖A。</p>
<p>当我们自己新建的模块需要依赖ruoyi-system和ruoyi-framework的时候，只需要引入ruoyi-framework即可，因为ruoyi-framework里面引入了ruoyi-system。但是再引也不会报错，因为没有循环依赖。</p>
</blockquote>
<ul>
<li>记得在该模块中引入fzx-common依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fzx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fzx-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>写一个测试类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fzx.common.annotation.Anonymous;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TextController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Anonymous</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/abc&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;asd&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十九、-Anonymous？"><a href="#十九、-Anonymous？" class="headerlink" title="十九、@Anonymous？"></a>十九、@Anonymous？</h1><h2 id="1-Anonymous原理"><a href="#1-Anonymous原理" class="headerlink" title="1.@Anonymous原理"></a>1.@Anonymous原理</h2><ul>
<li><p>上节课我们使用了注解@Anonymous，然后接口就可以直接被访问到了，不用token！不用token！不用token！</p>
</li>
<li><p>我们一般知道，注解是给程序看的，给机器看的，当然也是给程序员看的。注解如果没有<strong>注解解析器</strong>（注解处理器，注解解释器），那么注解就没有什么作用。所以@Anonyous一定是在某个地方被干嘛干嘛了</p>
</li>
<li><p>@Anonyous的源码：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 匿名访问不鉴权注解</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(&#123; ElementType.METHOD, ElementType.TYPE &#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Anonymous</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从源码可以看到，它可以放到类上，或者方法上。</li>
<li>那么我们就可以这样想：<strong>放到类上，该类所有方法都可以匿名访问；放到方法上，那么就该方法可以被匿名访问。</strong></li>
<li>下面直接上注解解析器：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.framework.config.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.RegExUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AnnotationUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.HandlerMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"><span class="keyword">import</span> com.fzx.common.annotation.Anonymous;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置Anonymous注解允许匿名访问的url</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PermitAllUrlProperties</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span>, ApplicationContextAware</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;\\&#123;(.*?)\\&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; urls = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">ASTERISK</span> <span class="operator">=</span> <span class="string">&quot;*&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">RequestMappingHandlerMapping</span> <span class="variable">mapping</span> <span class="operator">=</span> applicationContext.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        Map&lt;RequestMappingInfo, HandlerMethod&gt; map = mapping.getHandlerMethods();</span><br><span class="line"></span><br><span class="line">        map.keySet().forEach(info -&gt; &#123;</span><br><span class="line">            <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> map.get(info);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取方法上边的注解 替代path variable 为 *</span></span><br><span class="line">            <span class="type">Anonymous</span> <span class="variable">method</span> <span class="operator">=</span> AnnotationUtils.findAnnotation(handlerMethod.getMethod(), Anonymous.class);</span><br><span class="line">            Optional.ofNullable(method).ifPresent(anonymous -&gt; Objects.requireNonNull(info.getPatternsCondition().getPatterns())</span><br><span class="line">                    .forEach(url -&gt; urls.add(RegExUtils.replaceAll(url, PATTERN, ASTERISK))));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取类上边的注解, 替代path variable 为 *</span></span><br><span class="line">            <span class="type">Anonymous</span> <span class="variable">controller</span> <span class="operator">=</span> AnnotationUtils.findAnnotation(handlerMethod.getBeanType(), Anonymous.class);</span><br><span class="line">            Optional.ofNullable(controller).ifPresent(anonymous -&gt; Objects.requireNonNull(info.getPatternsCondition().getPatterns())</span><br><span class="line">                    .forEach(url -&gt; urls.add(RegExUtils.replaceAll(url, PATTERN, ASTERISK))));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext context)</span> <span class="keyword">throws</span> BeansException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.applicationContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getUrls</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> urls;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUrls</span><span class="params">(List&lt;String&gt; urls)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.urls = urls;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从以上的代码我们可以发现，这个类实现了两个接口。</li>
<li><strong>InitializingBean</strong>接口实现之后，<strong>初始化bean的时候会执行接口中的方法afterPropertiesSet</strong>。</li>
<li><strong>ApplicationContextAware</strong>接口实现之后，可以重写<strong>setApplicationContext</strong>方法，该方法<strong>可以拿到Spring的上下文</strong>，相当于Spring容器在手，天下我有。</li>
<li>可以很容易发现，无非是先拿到一个包含<strong>所有映射和HandlerMethod的</strong>(只读)映射。</li>
<li>通过拿到映射后，获得每个映射的<strong>HandlerMethod</strong>，也就是获得处理它的方法。然后看看该方法有没有<strong>Anonymous.class</strong>注解，有的话保存成<strong>method</strong>变量，然后<strong>后续校验后加入到urls的ArrayList中</strong>保存起来供后续使用。</li>
<li><strong>值得注意的是：</strong><ul>
<li>这里涉及到一个正则表达式，处理了特殊情况。当我们的url为 &#x2F;{getget} 的时候，会被替换为&#x2F;*，当我们的url为&#x2F;{getget}&#x2F;{abc}的时候，会被替换为&#x2F; * &#x2F; * 。</li>
<li>正则表达式为：\ {(.*?) \ }</li>
<li>相关链接：<a class="link"   target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000010680178%E3%80%82" >https://segmentfault.com/q/1010000010680178。<i class="fas fa-external-link-alt"></i></a></li>
</ul>
</li>
<li>后续在SecurityConfig中把访问权限改成了<strong>permitAll</strong>：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注解标记允许匿名访问的url</span></span><br><span class="line">       ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.<span class="type">ExpressionInterceptUrlRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> httpSecurity.authorizeRequests();</span><br><span class="line">       permitAllUrl.getUrls().forEach(url -&gt; registry.antMatchers(url).permitAll());</span><br></pre></td></tr></table></figure>

<h1 id="二十、前端通用方法"><a href="#二十、前端通用方法" class="headerlink" title="二十、前端通用方法"></a>二十、前端通用方法</h1><ul>
<li>所谓通用方法，就是随时能调用的方法。</li>
<li>例如：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">openPage</span>(<span class="string">&quot;用户管理&quot;</span>, <span class="string">&quot;/system/user&quot;</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">msg</span>(<span class="string">&quot;默认反馈&quot;</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$auth</span>.<span class="title function_">hasPermi</span>(<span class="string">&quot;system:user:add&quot;</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$auth</span>.<span class="title function_">hasRole</span>(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$cache</span>.<span class="property">local</span>.<span class="title function_">set</span>(<span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;local value&#x27;</span>)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$download</span>.<span class="title function_">name</span>(name);</span><br></pre></td></tr></table></figure>

<ul>
<li>为什么说这些方法可以随时调用呢？</li>
<li>首先，ry准备好了插件：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tab <span class="keyword">from</span> <span class="string">&#x27;./tab&#x27;</span></span><br><span class="line"><span class="keyword">import</span> auth <span class="keyword">from</span> <span class="string">&#x27;./auth&#x27;</span></span><br><span class="line"><span class="keyword">import</span> cache <span class="keyword">from</span> <span class="string">&#x27;./cache&#x27;</span></span><br><span class="line"><span class="keyword">import</span> modal <span class="keyword">from</span> <span class="string">&#x27;./modal&#x27;</span></span><br><span class="line"><span class="keyword">import</span> download <span class="keyword">from</span> <span class="string">&#x27;./download&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">install</span>(<span class="params">Vue</span>) &#123;</span><br><span class="line">    <span class="comment">// 页签操作</span></span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$tab</span> = tab</span><br><span class="line">    <span class="comment">// 认证对象</span></span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$auth</span> = auth</span><br><span class="line">    <span class="comment">// 缓存对象</span></span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$cache</span> = cache</span><br><span class="line">    <span class="comment">// 模态框对象</span></span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$modal</span> = modal</span><br><span class="line">    <span class="comment">// 下载文件</span></span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$download</span> = download</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后在main.js调用了安装插件方法：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...省略其他代码</span><br><span class="line"><span class="keyword">import</span> plugins <span class="keyword">from</span> <span class="string">&#x27;./plugins&#x27;</span> <span class="comment">// plugins</span></span><br><span class="line">...省略其他代码</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(plugins)</span><br><span class="line">...省略其他代码</span><br></pre></td></tr></table></figure>

<ul>
<li>我们知道，Vue.use（plugins），会去自动调用plugins中的install方法，在install方法中，发现Vue.prototype上面装了一些东西。</li>
<li>到此我们明白了，Vue原型上挂载了，所以随时能访问到。为什么原型挂载就能访问到呢？</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306251555220.png"
                      alt="图片"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306251555122.png"
                      alt="图片"
                ></p>
<h2 id="1-tab对象"><a href="#1-tab对象" class="headerlink" title="1.$tab对象"></a>1.$tab对象</h2><p><a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#tab%E5%AF%B9%E8%B1%A1" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#tab%E5%AF%B9%E8%B1%A1<i class="fas fa-external-link-alt"></i></a></p>
<ul>
<li>下面我们亲自编码测试一下如何使用即可。</li>
<li>在对应的目录菜单下创建对应的vue，方法放到methods</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;el-button type=&quot;primary&quot; @click=&quot;openTZGGAndWindows&quot;&gt;打开通知公告&lt;/el-button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;tab&#x27;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-打开新页面"><a href="#1-打开新页面" class="headerlink" title="1.打开新页面"></a>1.打开新页面</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单纯打开新页面</span></span><br><span class="line"><span class="title function_">openTZGG</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">openPage</span>(<span class="string">&quot;打开的通知公告&quot;</span>, <span class="string">&quot;/system/notice&quot;</span>);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 打开页面之后，并且做一点其他事情。</span></span><br><span class="line"><span class="title function_">openTZGGAndWindows</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">openPage</span>(<span class="string">&quot;打开的通知公告并且弹窗&quot;</span>, <span class="string">&quot;/system/notice&quot;</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">msg</span>(<span class="string">&quot;我是弹窗&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>看看源码：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加tab页签</span></span><br><span class="line"><span class="title function_">openPage</span>(<span class="params">title, url, params</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> obj = &#123; <span class="attr">path</span>: url, <span class="attr">meta</span>: &#123; <span class="attr">title</span>: title &#125; &#125;</span><br><span class="line">  store.<span class="title function_">dispatch</span>(<span class="string">&#x27;tagsView/addView&#x27;</span>, obj);</span><br><span class="line">  <span class="keyword">return</span> router.<span class="title function_">push</span>(&#123; <span class="attr">path</span>: url, <span class="attr">query</span>: params &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li><p>从上面的源码可以看出，做了两件事。</p>
<p><strong>第一件事：</strong></p>
<p>调用Vuex的tagsView&#x2F;addView方法，并传参数obj。该方法是为了把新打开的页签添加到Vuex维护的页签数组visitedViews。</p>
<p>当添加成功，组件TagsView的计算属性visitedViews变化，页面重新渲染，页签自然多一个。</p>
<p><strong>第二件事：</strong></p>
<p>第二件事就是将路由做简单的跳转。</p>
</li>
</ul>
<h3 id="2-修改页签"><a href="#2-修改页签" class="headerlink" title="2.修改页签"></a>2.修改页签</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">updateMyself</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">//修改自己</span></span><br><span class="line"><span class="keyword">const</span> obj = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, <span class="variable language_">this</span>.<span class="property">$route</span>, &#123;<span class="attr">title</span>: <span class="string">&quot;自定义标题&quot;</span>&#125;)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">updatePage</span>(obj);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="title function_">updateTZGG</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// 修改别的</span></span><br><span class="line"><span class="keyword">const</span> obj = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, &#123;<span class="attr">path</span>: <span class="string">&quot;/system/notice&quot;</span>&#125;, &#123;<span class="attr">title</span>: <span class="string">&quot;自定义标题222&quot;</span>&#125;)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">updatePage</span>(obj).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">msg</span>(<span class="string">&quot;修改页签完毕&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="3-关闭页签"><a href="#3-关闭页签" class="headerlink" title="3.关闭页签"></a>3.关闭页签</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关闭当前并且打开新页面</span></span><br><span class="line"><span class="title function_">closeAndOpen</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> obj = &#123;<span class="attr">path</span>: <span class="string">&quot;/system/user&quot;</span>&#125;;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">closeOpenPage</span>(obj);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">//关闭当前并回到首页</span></span><br><span class="line"><span class="title function_">closeAndGoIndex</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">closePage</span>();</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">//关闭指定的页面</span></span><br><span class="line"><span class="title function_">closeSpecifyPage</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> obj = &#123;<span class="attr">path</span>: <span class="string">&quot;/system/user&quot;</span>&#125;;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">closePage</span>(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-刷新页签"><a href="#4-刷新页签" class="headerlink" title="4.刷新页签"></a>4.刷新页签</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//刷新当前页签</span></span><br><span class="line"><span class="title function_">refreshPage</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">refreshPage</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-关闭所有页签"><a href="#5-关闭所有页签" class="headerlink" title="5.关闭所有页签"></a>5.关闭所有页签</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关闭所有页签</span></span><br><span class="line"><span class="title function_">closeAll</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">closeAllPage</span>();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="6-关闭左侧"><a href="#6-关闭左侧" class="headerlink" title="6.关闭左侧"></a>6.关闭左侧</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">closeAll</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">closeAllPage</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">openPage</span>(<span class="string">&quot;shouye&quot;</span>, <span class="string">&quot;/index&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="7-关闭右侧"><a href="#7-关闭右侧" class="headerlink" title="7.关闭右侧"></a>7.关闭右侧</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关闭右侧</span></span><br><span class="line"><span class="title function_">closeRight</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">closeRightPage</span>();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="8-关闭其他"><a href="#8-关闭其他" class="headerlink" title="8.关闭其他"></a>8.关闭其他</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关闭其他</span></span><br><span class="line"><span class="title function_">closeOther</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$tab</span>.<span class="title function_">closeOtherPage</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-modal对象"><a href="#2-modal对象" class="headerlink" title="2.$modal对象"></a>2.$modal对象</h2><p>官方文档已经很齐备了：</p>
<p><a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#modal%E5%AF%B9%E8%B1%A1" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#modal%E5%AF%B9%E8%B1%A1<i class="fas fa-external-link-alt"></i></a></p>
<hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;el-button type=&quot;success&quot; @click=&quot;msg&quot;&gt;消息&lt;/el-button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;modal&#x27;,</span><br><span class="line">  methods:&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>在上述的methods中添加方法</li>
</ul>
<h3 id="1-提供成功、警告和错误等反馈信息"><a href="#1-提供成功、警告和错误等反馈信息" class="headerlink" title="1.提供成功、警告和错误等反馈信息"></a>1.提供成功、警告和错误等反馈信息</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">msg</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">msg</span>(<span class="string">&quot;默认反馈&quot;</span>);</span><br><span class="line"><span class="comment">// this.$modal.msgError(&quot;错误反馈&quot;);</span></span><br><span class="line"><span class="comment">// this.$modal.msgSuccess(&quot;成功反馈&quot;);</span></span><br><span class="line"><span class="comment">// this.$modal.msgWarning(&quot;警告反馈&quot;);</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="2-提供成功、警告和错误等提示信息"><a href="#2-提供成功、警告和错误等提示信息" class="headerlink" title="2.提供成功、警告和错误等提示信息"></a>2.提供成功、警告和错误等提示信息</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">alert</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">alert</span>(<span class="string">&quot;默认提示&quot;</span>);</span><br><span class="line"><span class="comment">// this.$modal.alertError(&quot;错误提示&quot;);</span></span><br><span class="line"><span class="comment">// this.$modal.alertSuccess(&quot;成功提示&quot;);</span></span><br><span class="line"><span class="comment">// this.$modal.alertWarning(&quot;警告提示&quot;);</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="3-提供成功、警告和错误等通知信息"><a href="#3-提供成功、警告和错误等通知信息" class="headerlink" title="3.提供成功、警告和错误等通知信息"></a>3.提供成功、警告和错误等通知信息</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">notify</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">notify</span>(<span class="string">&quot;默认通知&quot;</span>);</span><br><span class="line"><span class="comment">// this.$modal.notifyError(&quot;错误通知&quot;);</span></span><br><span class="line"><span class="comment">// this.$modal.notifySuccess(&quot;成功通知&quot;);</span></span><br><span class="line"><span class="comment">// this.$modal.notifyWarning(&quot;警告通知&quot;);</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="4-提供确认窗体信息"><a href="#4-提供确认窗体信息" class="headerlink" title="4.提供确认窗体信息"></a>4.提供确认窗体信息</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">confirm</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">confirm</span>(<span class="string">&#x27;你确定要确定吗&#x27;</span>).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">notify</span>(<span class="string">&quot;点了确定&quot;</span>)</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">notify</span>(<span class="string">&quot;点了取消&quot;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="5-提供遮罩层信息"><a href="#5-提供遮罩层信息" class="headerlink" title="5.提供遮罩层信息"></a>5.提供遮罩层信息</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//遮罩层</span></span><br><span class="line"><span class="title function_">startLoading</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 打开遮罩层</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">loading</span>(<span class="string">&quot;正在Loading，请稍后...&quot;</span>);</span><br><span class="line">    <span class="title function_">wait5Second</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">closeLoading</span>();</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;,</span><br><span class="line">    <span class="comment">//如若已经loading则只能程序自己调用</span></span><br><span class="line">    <span class="title function_">stopLoading</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">closeLoading</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这个需要调用后端接口，首先在api的login.js中定义wait5Second接口</li>
</ul>
<h2 id="3-auth对象"><a href="#3-auth对象" class="headerlink" title="3.$auth对象"></a>3.$auth对象</h2><p>该对象用于鉴权。</p>
<p>官方说明：<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#auth%E5%AF%B9%E8%B1%A1" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#auth%E5%AF%B9%E8%B1%A1<i class="fas fa-external-link-alt"></i></a></p>
<hr>
<h3 id="1-验证用户权限"><a href="#1-验证用户权限" class="headerlink" title="1.验证用户权限"></a>1.验证用户权限</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">validMyPermission</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">$auth</span>.<span class="title function_">hasPermi</span>(<span class="string">&quot;system:user:list&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-验证用户角色"><a href="#2-验证用户角色" class="headerlink" title="2.验证用户角色"></a>2.验证用户角色</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">validMyRole</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">notify</span>(<span class="variable language_">this</span>.<span class="property">$auth</span>.<span class="title function_">hasRole</span>(<span class="string">&quot;admin&quot;</span>) + <span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>验证用户角色的源码：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">authRole</span>(<span class="params">role</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> super_admin = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> roles = store.<span class="property">getters</span> &amp;&amp; store.<span class="property">getters</span>.<span class="property">roles</span></span><br><span class="line">  <span class="keyword">if</span> (role &amp;&amp; role.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> roles.<span class="title function_">some</span>(<span class="function"><span class="params">v</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> super_admin === v || v === role</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-cache对象"><a href="#4-cache对象" class="headerlink" title="4.$cache对象"></a>4.$cache对象</h2><ul>
<li>$cache对象用于处理缓存。我们并不建议您直接使用sessionStorage或localStorage，因为项目的缓存策略可能发生变化，通过$cache对象做一层调用代理则是一个不错的选择。$cache提供session和local两种级别的缓存，如下：</li>
</ul>
<table>
<thead>
<tr>
<th align="center">对象名称</th>
<th align="center">缓存类型</th>
</tr>
</thead>
<tbody><tr>
<td align="center">session</td>
<td align="center">会话级缓存，通过sessionStorage实现</td>
</tr>
<tr>
<td align="center">local</td>
<td align="center">本地级缓存，通过localStorage实现</td>
</tr>
</tbody></table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// local 普通值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$cache</span>.<span class="property">local</span>.<span class="title function_">set</span>(<span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;local value&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">$cache</span>.<span class="property">local</span>.<span class="title function_">get</span>(<span class="string">&#x27;key&#x27;</span>)) <span class="comment">// 输出&#x27;local value&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// session 普通值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$cache</span>.<span class="property">session</span>.<span class="title function_">set</span>(<span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;session value&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">$cache</span>.<span class="property">session</span>.<span class="title function_">get</span>(<span class="string">&#x27;key&#x27;</span>)) <span class="comment">// 输出&#x27;session value&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// local JSON值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$cache</span>.<span class="property">local</span>.<span class="title function_">setJSON</span>(<span class="string">&#x27;jsonKey&#x27;</span>, &#123; <span class="attr">localProp</span>: <span class="number">1</span> &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">$cache</span>.<span class="property">local</span>.<span class="title function_">getJSON</span>(<span class="string">&#x27;jsonKey&#x27;</span>)) <span class="comment">// 输出&#x27;&#123;localProp: 1&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// session JSON值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$cache</span>.<span class="property">session</span>.<span class="title function_">setJSON</span>(<span class="string">&#x27;jsonKey&#x27;</span>, &#123; <span class="attr">sessionProp</span>: <span class="number">1</span> &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">$cache</span>.<span class="property">session</span>.<span class="title function_">getJSON</span>(<span class="string">&#x27;jsonKey&#x27;</span>)) <span class="comment">// 输出&#x27;&#123;sessionProp: 1&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$cache</span>.<span class="property">local</span>.<span class="title function_">remove</span>(<span class="string">&#x27;key&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$cache</span>.<span class="property">session</span>.<span class="title function_">remove</span>(<span class="string">&#x27;key&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="5-download对象"><a href="#5-download对象" class="headerlink" title="5.$download对象"></a>5.$download对象</h2><p>$download对象用于文件下载，它定义在plugins&#x2F;download.js文件中，它有如下方法</p>
<h3 id="1-根据名称下载download路径下的文件"><a href="#1-根据名称下载download路径下的文件" class="headerlink" title="1.根据名称下载download路径下的文件"></a>1.根据名称下载<strong>download</strong>路径下的文件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">downloadByName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> name = <span class="string">&quot;1.txt&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> isDelete = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 默认下载方法</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$download</span>.<span class="title function_">name</span>(name);</span><br><span class="line">    <span class="comment">// 下载完成后是否删除文件</span></span><br><span class="line">    <span class="comment">// this.$download.name(name, isDelete);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>那么如何正确使用它呢？：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">testDownload</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="comment">//通过sheng_cheng_wen_jian方法去调用后端某一个接口，后端把文件保存在ruoyi/download/下面，</span></span><br><span class="line">  <span class="comment">// 然后后端返回文件名，然后前端收到文件名之后才去真正的下载。</span></span><br><span class="line">  <span class="comment">//然而既然要重新调用第二次下载接口，为什么不一次性解决呢？所以这个接口不是那么好用。</span></span><br><span class="line">  <span class="title function_">sheng_cheng_wen_jian</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$download</span>.<span class="title function_">name</span>(res.<span class="property">name</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在若依系统上上传的文件在fzx-admin的application.yml中定义</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文件路径 示例（ Windows配置D:/ruoyi/uploadPath，Linux配置 /home/ruoyi/uploadPath）</span></span><br><span class="line"><span class="attr">profile:</span> <span class="string">C:\Users\1\Desktop\ruoyi</span></span><br></pre></td></tr></table></figure>

<h3 id="2-根据名称下载upload路径下的文件"><a href="#2-根据名称下载upload路径下的文件" class="headerlink" title="2.根据名称下载upload路径下的文件"></a>2.根据名称下载<strong>upload</strong>路径下的文件</h3><p>我们可以看到，官网就发了下面这段代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> resource = <span class="string">&quot;/profile/upload/2021/09/27/be756b96-c8b5-46c4-ab67-02e988973090.png&quot;</span>;</span><br><span class="line"><span class="comment">// 默认方法</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$download</span>.<span class="title function_">resource</span>(resource);</span><br></pre></td></tr></table></figure>

<ul>
<li>事实上，通过该方法可以下载到ruoyi&#x2F;upload文件夹下面的若干文件。</li>
<li>我们观察到，作者的例子中带着日期什么的，其实这些数据都是存在数据库中的。有时候我们要存用户的头像怎么办呢？我们就可以把用户头像的URI存到数据库中，然后通过该URI直接在前端展示，当然也可以通过resource方法下载下来。下面我们通过一个简单的案例来说明。</li>
</ul>
<ol>
<li>建立数据表</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ry<span class="operator">-</span>vue`.`test`  (</span><br><span class="line">                                     `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                                     `uri` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;URI&#x27;</span>,</span><br><span class="line">                                     <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 下面因为忘记主键自增，回来改的数据库。</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `ry<span class="operator">-</span>vue`.`test`</span><br><span class="line">    MODIFY <span class="keyword">COLUMN</span> `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span> <span class="keyword">FIRST</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成代码，修改下配置</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306260955605.png"
                      alt="image-20230626095504274"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306260956726.png"
                      alt="image-20230626095659569"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261001872.png"
                      alt="image-20230626100131667"
                ></p>
<ul>
<li>按部就班的将代码复制到相应的位置</li>
<li>测试页面如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261020959.png"
                      alt="image-20230626102046635"
                ></p>
<ul>
<li>我们存的图片连接如：<a class="link"   target="_blank" rel="noopener" href="http://localhost/dev-api/profile/upload/2023/06/26/qq_20230626101518A001.png" >http://localhost/dev-api/profile/upload/2023/06/26/qq_20230626101518A001.png<i class="fas fa-external-link-alt"></i></a></li>
<li>该路径为何能显示图片呢？首先是dev-api走的前端代理，代理到了后端，并且削掉了dev-api的前缀。找到后端后，后端静态资源是直接映射的。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/** 本地文件上传路径 */</span></span><br><span class="line">    registry.addResourceHandler(Constants.RESOURCE_PREFIX + <span class="string">&quot;/**&quot;</span>)</span><br><span class="line">            .addResourceLocations(<span class="string">&quot;file:&quot;</span> + RuoYiConfig.getProfile() + <span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** swagger配置 */</span></span><br><span class="line">    registry.addResourceHandler(<span class="string">&quot;/swagger-ui/**&quot;</span>)</span><br><span class="line">            .addResourceLocations(<span class="string">&quot;classpath:/META-INF/resources/webjars/springfox-swagger-ui/&quot;</span>)</span><br><span class="line">            .setCacheControl(CacheControl.maxAge(<span class="number">5</span>, TimeUnit.HOURS).cachePublic());;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上代码是说：如果收到 &#x2F;profile&#x2F;…..的请求，就去D：&#x2F;ruoyi&#x2F;upload&#x2F;下面去找对应的资源文件。</li>
</ul>
<h3 id="3-根据请求地址下载zip包"><a href="#3-根据请求地址下载zip包" class="headerlink" title="3.根据请求地址下载zip包"></a>3.根据请求地址下载<strong>zip</strong>包</h3><ul>
<li>ry自己用过该方法，当我们生成代码的时候可以下载，对应的下载zip包：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 生成代码操作 */</span></span><br><span class="line"><span class="title function_">handleGenTable</span>(<span class="params">row</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> tableNames = row.<span class="property">tableName</span> || <span class="variable language_">this</span>.<span class="property">tableNames</span>;</span><br><span class="line">  <span class="keyword">if</span> (tableNames == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">msgError</span>(<span class="string">&quot;请选择要生成的数据&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(row.<span class="property">genType</span> === <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">    <span class="title function_">genCode</span>(row.<span class="property">tableName</span>).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">msgSuccess</span>(<span class="string">&quot;成功生成到自定义路径：&quot;</span> + row.<span class="property">genPath</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$download</span>.<span class="title function_">zip</span>(<span class="string">&quot;/tool/gen/batchGenCode?tables=&quot;</span> + tableNames, <span class="string">&quot;ruoyi.zip&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>需要保证请求的地址返回的输出流是zip包。</li>
</ul>
<h3 id="4-更多文件下载操作"><a href="#4-更多文件下载操作" class="headerlink" title="4.更多文件下载操作"></a>4.更多文件下载操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;el-row&gt;</span><br><span class="line">      &lt;el-button type=&quot;primary&quot; @click=&quot;downloadByName&quot;&gt;downloadByName&lt;/el-button&gt;</span><br><span class="line">      &lt;hr&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;el-row&gt;</span><br><span class="line">      &lt;el-button type=&quot;danger&quot; @click=&quot;hello&quot;&gt;自定义文本保存1&lt;/el-button&gt;</span><br><span class="line">      &lt;el-button type=&quot;danger&quot; @click=&quot;hello1&quot;&gt;自定义文本保存2&lt;/el-button&gt;</span><br><span class="line">      &lt;el-button type=&quot;danger&quot; @click=&quot;hello2&quot;&gt;自定义文本保存3&lt;/el-button&gt;</span><br><span class="line">      &lt;el-button type=&quot;danger&quot; @click=&quot;hello3&quot;&gt;自定义文本保存4&lt;/el-button&gt;</span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;modal&#x27;,</span><br><span class="line">  methods:&#123;</span><br><span class="line"></span><br><span class="line">    downloadByName() &#123;</span><br><span class="line">      const name = &quot;1.txt&quot;;</span><br><span class="line">      const isDelete = true;</span><br><span class="line">      // 默认下载方法</span><br><span class="line">      this.$download.name(name);</span><br><span class="line">      // 下载完成后是否删除文件</span><br><span class="line">      // this.$download.name(name, isDelete);</span><br><span class="line">    &#125;,</span><br><span class="line">    hello() &#123;</span><br><span class="line">      // 自定义文本保存</span><br><span class="line">      const blob = new Blob([&quot;Hello, world!&quot;], &#123;type: &quot;text/plain;charset=utf-8&quot;&#125;);</span><br><span class="line">      this.$download.saveAs(blob, &quot;hello world.txt&quot;);</span><br><span class="line">    &#125;,</span><br><span class="line">    hello1() &#123;</span><br><span class="line">      // 自定义文件保存</span><br><span class="line">      const file = new File([&quot;Hello, world!&quot;], &quot;hello world.txt&quot;, &#123;type: &quot;text/plain;charset=utf-8&quot;&#125;);</span><br><span class="line">      this.$download.saveAs(file);</span><br><span class="line">    &#125;,</span><br><span class="line">    hello2() &#123;</span><br><span class="line">      // 自定义data数据保存</span><br><span class="line">      const data = &quot;中国共产党是世界第一大党！&quot;;</span><br><span class="line">      const blob = new Blob([data], &#123;type: &#x27;text/plain;charset=utf-8&#x27;&#125;)</span><br><span class="line">      this.$download.saveAs(blob, &quot;2.txt&quot;)</span><br><span class="line">    &#125;,</span><br><span class="line">    hello3() &#123;</span><br><span class="line">      // 根据地址保存文件</span><br><span class="line">      this.$download.saveAs(&quot;https://ruoyi.vip/images/logo.png&quot;, &quot;logo.jpg&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="二十一、token补充"><a href="#二十一、token补充" class="headerlink" title="二十一、token补充"></a>二十一、token补充</h1><h2 id="1-HTTP？"><a href="#1-HTTP？" class="headerlink" title="1.HTTP？"></a>1.HTTP？</h2><ul>
<li>曾经我们在讲JWT的时候，当时JWT需要配合https使用呢？因为http自身是明码传输，我们通过网卡抓包可以轻而易举得到token。我们的token相当于在网络上明码传输，很容易被人拦截查看！下面演示一下拦截token！效果图：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261041966.png"
                      alt="图片"
                ></p>
<h2 id="2-不安全怎么办呐？"><a href="#2-不安全怎么办呐？" class="headerlink" title="2.不安全怎么办呐？"></a>2.不安全怎么办呐？</h2><p>既然不安全，那咋办呢？上https！</p>
<hr>
<ul>
<li>首先得有一个域名吧？怎么买我就不多说了，直接在腾讯云搜索域名，选择自己喜欢的购买。</li>
<li>然后呢，还需要购买SSL证书，一般来说，买域名会送一个SSL证书，反正我的是送的。如果没送可以点击申请免费证书，证书界面如下：<a class="link"   target="_blank" rel="noopener" href="https://console.cloud.tencent.com/ssl" >https://console.cloud.tencent.com/ssl<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261042404.png"
                      alt="图片"
                ></p>
<ul>
<li>有了证书之后，我们需要先下载证书，下载nginx证书。</li>
<li>腾讯云官方学习视频：<a class="link"   target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/400/35244" >https://cloud.tencent.com/document/product/400/35244<i class="fas fa-external-link-alt"></i></a></li>
<li>把打包下载的证书直接全部丢到nginx&#x2F;conf文件夹，然后改写nginx配置文件：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">user  www;</span><br><span class="line"></span><br><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line">error_log  /www/wwwlogs/nginx_error.<span class="property">log</span>  crit;</span><br><span class="line"></span><br><span class="line">pid        /www/server/nginx/logs/nginx.<span class="property">pid</span>;</span><br><span class="line"></span><br><span class="line">worker_rlimit_nofile <span class="number">51200</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    use epoll;</span><br><span class="line"></span><br><span class="line">    worker_connections <span class="number">51200</span>;</span><br><span class="line"></span><br><span class="line">    multi_accept on;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    include       mime.<span class="property">types</span>;</span><br><span class="line"></span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 100m;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #用于tomcat反向代理,解决nginx <span class="number">504</span>错误</span><br><span class="line"></span><br><span class="line">    proxy_connect_timeout <span class="number">7200</span>; #单位秒</span><br><span class="line"></span><br><span class="line">    proxy_send_timeout <span class="number">7200</span>; #单位秒</span><br><span class="line"></span><br><span class="line">    proxy_read_timeout <span class="number">7200</span>; #单位秒</span><br><span class="line"></span><br><span class="line">    proxy_buffer_size 16k;</span><br><span class="line"></span><br><span class="line">    proxy_buffers <span class="number">4</span> 64k;</span><br><span class="line"></span><br><span class="line">    proxy_busy_buffers_size 128k;</span><br><span class="line"></span><br><span class="line">    proxy_temp_file_write_size 128k;</span><br><span class="line"></span><br><span class="line">    # <span class="attr">ps</span>:以timeout结尾配置项时间要配置大点</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        listen       <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        charset utf-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line"></span><br><span class="line">            root   /home/wqj/dist;</span><br><span class="line"></span><br><span class="line">            try_files $uri $uri/ /index.<span class="property">html</span>;</span><br><span class="line"></span><br><span class="line">            index  index.<span class="property">html</span> index.<span class="property">htm</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /prod-api/ &#123;</span><br><span class="line"></span><br><span class="line">            proxy_set_header <span class="title class_">Host</span> $http_host;</span><br><span class="line"></span><br><span class="line">            proxy_set_header X-<span class="title class_">Real</span>-<span class="variable constant_">IP</span> $remote_addr;</span><br><span class="line"></span><br><span class="line">            proxy_set_header <span class="variable constant_">REMOTE</span>-<span class="variable constant_">HOST</span> $remote_addr;</span><br><span class="line"></span><br><span class="line">            proxy_set_header X-<span class="title class_">Forwarded</span>-<span class="title class_">For</span> $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">            proxy_pass <span class="attr">http</span>:<span class="comment">//localhost:8765/;</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.<span class="property">html</span>;</span><br><span class="line"></span><br><span class="line">        location = /50x.<span class="property">html</span> &#123;</span><br><span class="line"></span><br><span class="line">        root   html;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    #<span class="variable constant_">SSL</span> 默认访问端口号为 <span class="number">443</span></span><br><span class="line">    listen <span class="number">443</span> ssl;</span><br><span class="line">    #请填写绑定证书的域名</span><br><span class="line">    server_name wangqingjiang.<span class="property">top</span>;</span><br><span class="line">    #请填写证书文件的相对路径或绝对路径</span><br><span class="line">    ssl_certificate wangqingjiang.<span class="property">top_bundle</span>.<span class="property">crt</span>;</span><br><span class="line">    #请填写私钥文件的相对路径或绝对路径</span><br><span class="line">    ssl_certificate_key wangqingjiang.<span class="property">top</span>.<span class="property">key</span>;</span><br><span class="line">    ssl_session_timeout 5m;</span><br><span class="line">    #请按照以下协议配置</span><br><span class="line">    ssl_protocols <span class="title class_">TLSv1</span><span class="number">.2</span> <span class="title class_">TLSv1</span><span class="number">.3</span>;</span><br><span class="line">    #请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。</span><br><span class="line">    ssl_ciphers <span class="variable constant_">ECDHE</span>-<span class="variable constant_">RSA</span>-<span class="title class_">AES128</span>-<span class="variable constant_">GCM</span>-<span class="title class_">SHA256</span>:<span class="attr">HIGH</span>:!<span class="attr">aNULL</span>:!<span class="title class_">MD5</span>:!<span class="title class_">RC4</span>:!<span class="variable constant_">DHE</span>;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    charset utf-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /home/wqj/dist;</span><br><span class="line">        try_files $uri $uri/ /index.<span class="property">html</span>;</span><br><span class="line">        index  index.<span class="property">html</span> index.<span class="property">htm</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /prod-api/ &#123;</span><br><span class="line">        proxy_set_header <span class="title class_">Host</span> $http_host;</span><br><span class="line">        proxy_set_header X-<span class="title class_">Real</span>-<span class="variable constant_">IP</span> $remote_addr;</span><br><span class="line">        proxy_set_header <span class="variable constant_">REMOTE</span>-<span class="variable constant_">HOST</span> $remote_addr;</span><br><span class="line">        proxy_set_header X-<span class="title class_">Forwarded</span>-<span class="title class_">For</span> $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass <span class="attr">http</span>:<span class="comment">//localhost:8765/;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.<span class="property">html</span>;</span><br><span class="line">    location = /50x.<span class="property">html</span> &#123;</span><br><span class="line">    root   html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>回头再看，其实就是一些固定的配置。然后重启nginx之后就发现https已经生效：</li>
</ul>
<h1 id="二十二、分页前后端配置"><a href="#二十二、分页前后端配置" class="headerlink" title="二十二、分页前后端配置"></a>二十二、分页前后端配置</h1><blockquote>
<p><strong>Tips：分页主要是后端做，前端只需要传给后端，我要第几页，每页多少条数据。</strong></p>
</blockquote>
<h2 id="1-分页的前端配置"><a href="#1-分页的前端配置" class="headerlink" title="1.分页的前端配置"></a>1.分页的前端配置</h2><ul>
<li>接下来以操作日志页面为例子，进行讲述。</li>
<li>前端每次给后端发请求的时候，都是带了分页参数的，默认都是请求第一页，每页10条数据。源码：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询参数</span></span><br><span class="line"><span class="attr">queryParams</span>: &#123;</span><br><span class="line">  <span class="attr">pageNum</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">pageSize</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">title</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="attr">operName</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="attr">businessType</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="attr">status</span>: <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 查询登录日志 */</span></span><br><span class="line">    <span class="title function_">getList</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loading</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="title function_">list</span>(<span class="variable language_">this</span>.<span class="title function_">addDateRange</span>(<span class="variable language_">this</span>.<span class="property">queryParams</span>, <span class="variable language_">this</span>.<span class="property">dateRange</span>)).<span class="title function_">then</span>( <span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">list</span> = response.<span class="property">rows</span>;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">total</span> = response.<span class="property">total</span>;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">loading</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>ry对elementUI的分页组件进行了小小的封装：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div :class=&quot;&#123;&#x27;hidden&#x27;:hidden&#125;&quot; class=&quot;pagination-container&quot;&gt;</span><br><span class="line">    &lt;el-pagination</span><br><span class="line">      :background=&quot;background&quot;</span><br><span class="line">      :current-page.sync=&quot;currentPage&quot;</span><br><span class="line">      :page-size.sync=&quot;pageSize&quot;</span><br><span class="line">      :layout=&quot;layout&quot;</span><br><span class="line">      :page-sizes=&quot;pageSizes&quot;</span><br><span class="line">      :pager-count=&quot;pagerCount&quot;</span><br><span class="line">      :total=&quot;total&quot;</span><br><span class="line">      v-bind=&quot;$attrs&quot;</span><br><span class="line">      @size-change=&quot;handleSizeChange&quot;</span><br><span class="line">      @current-change=&quot;handleCurrentChange&quot;</span><br><span class="line">    /&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; scrollTo &#125; from &#x27;@/utils/scroll-to&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;Pagination&#x27;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    total: &#123;</span><br><span class="line">      required: true,</span><br><span class="line">      type: Number</span><br><span class="line">    &#125;,</span><br><span class="line">    page: &#123;</span><br><span class="line">      type: Number,</span><br><span class="line">      default: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    limit: &#123;</span><br><span class="line">      type: Number,</span><br><span class="line">      default: 20</span><br><span class="line">    &#125;,</span><br><span class="line">    pageSizes: &#123;</span><br><span class="line">      type: Array,</span><br><span class="line">      default() &#123;</span><br><span class="line">        return [10, 20, 30, 50]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 移动端页码按钮的数量端默认值5</span><br><span class="line">    pagerCount: &#123;</span><br><span class="line">      type: Number,</span><br><span class="line">      default: document.body.clientWidth &lt; 992 ? 5 : 7</span><br><span class="line">    &#125;,</span><br><span class="line">    layout: &#123;</span><br><span class="line">      type: String,</span><br><span class="line">      default: &#x27;total, sizes, prev, pager, next, jumper&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">    background: &#123;</span><br><span class="line">      type: Boolean,</span><br><span class="line">      default: true</span><br><span class="line">    &#125;,</span><br><span class="line">    autoScroll: &#123;</span><br><span class="line">      type: Boolean,</span><br><span class="line">      default: true</span><br><span class="line">    &#125;,</span><br><span class="line">    hidden: &#123;</span><br><span class="line">      type: Boolean,</span><br><span class="line">      default: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    currentPage: &#123;</span><br><span class="line">      get() &#123;</span><br><span class="line">        return this.page</span><br><span class="line">      &#125;,</span><br><span class="line">      set(val) &#123;</span><br><span class="line">        this.$emit(&#x27;update:page&#x27;, val)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    pageSize: &#123;</span><br><span class="line">      get() &#123;</span><br><span class="line">        return this.limit</span><br><span class="line">      &#125;,</span><br><span class="line">      set(val) &#123;</span><br><span class="line">        this.$emit(&#x27;update:limit&#x27;, val)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handleSizeChange(val) &#123;</span><br><span class="line">      if (this.currentPage * val &gt; this.total) &#123;</span><br><span class="line">        this.currentPage = 1</span><br><span class="line">      &#125;</span><br><span class="line">      this.$emit(&#x27;pagination&#x27;, &#123; page: this.currentPage, limit: val &#125;)</span><br><span class="line">      if (this.autoScroll) &#123;</span><br><span class="line">        scrollTo(0, 800)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    handleCurrentChange(val) &#123;</span><br><span class="line">      this.$emit(&#x27;pagination&#x27;, &#123; page: val, limit: this.pageSize &#125;)</span><br><span class="line">      if (this.autoScroll) &#123;</span><br><span class="line">        scrollTo(0, 800)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.pagination-container &#123;</span><br><span class="line">  background: #fff;</span><br><span class="line">  padding: 32px 16px;</span><br><span class="line">&#125;</span><br><span class="line">.pagination-container.hidden &#123;</span><br><span class="line">  display: none;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们跟着elementUI学习一下分页插件即可：<a class="link"   target="_blank" rel="noopener" href="https://element.eleme.cn/#/zh-CN/component/pagination" >https://element.eleme.cn/#/zh-CN/component/pagination<i class="fas fa-external-link-alt"></i></a></li>
<li>参考学习资料：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/chenxi_li/article/details/118682708" >https://blog.csdn.net/chenxi_li/article/details/118682708<i class="fas fa-external-link-alt"></i></a></li>
<li>我们看到了，前端只需要维护好数据，<strong>我需要当前是第几页，一共有几条数据，每页多少条。</strong></li>
<li>前端只需要维护好这三个数据，其他的交给后端就行了。</li>
</ul>
<h2 id="2-后端分页实现pagehelper"><a href="#2-后端分页实现pagehelper" class="headerlink" title="2.后端分页实现pagehelper"></a>2.后端分页实现pagehelper</h2><ul>
<li>后端是通过pagehelper插件实现的。ry通过pagehelper间接引入了mybatis：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261333289.png"
                      alt="图片"
                ></p>
<ul>
<li>现在我们需要学习一波<strong>pagehelper</strong>的使用。这就不得不介绍一波pagehelper的官网了：<a class="link"   target="_blank" rel="noopener" href="https://pagehelper.github.io/docs/howtouse/" >https://pagehelper.github.io/docs/howtouse/<i class="fas fa-external-link-alt"></i></a></li>
<li>通过官网，我们需要知道为啥ry引入了分页插件就可以使用了，难道没有配置吗？确实，如果使用了SpringBoot可以零配置。</li>
<li>通过官网讲述常见的下面的分页方式：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// //第二种，Mapper接口方式的调用，推荐这种使用方式。</span></span><br><span class="line"><span class="comment">//获取第1页，10条内容，默认查询总数count</span></span><br><span class="line"><span class="comment">// ry用的就是下面这种。</span></span><br><span class="line">PageHelper.startPage(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//第五种，参数对象</span></span><br><span class="line"><span class="comment">//如果 pageNum 和 pageSize 存在于 User 对象中，只要参数有值，也会被分页</span></span><br><span class="line"><span class="comment">//有如下 User 对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="comment">//其他fields</span></span><br><span class="line">    <span class="comment">//下面两个参数名和 params 配置的名字一致</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNum;</span><br><span class="line">    <span class="keyword">private</span> Integer pageSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//支持 ServletRequest,Map,POJO 对象，需要配合 params 参数</span></span><br><span class="line"><span class="comment">// 1、如果是request 则需要请求的时候带上对应的参数。</span></span><br><span class="line"><span class="comment">// 2、如果是Map 则Map中需要包含pageNum，pageSize等选项。</span></span><br><span class="line"><span class="comment">// 3、如果是POJO  则需要在pojo中带上对应的属性。</span></span><br><span class="line">PageHelper.startPage(request);</span><br></pre></td></tr></table></figure>

<p><strong>通过官网讲解常见的几种分页方式：</strong></p>
<ul>
<li>PageHelper.startPage传普通参数（ry使用的）。</li>
<li>PageHelper.startPage方法传POJO或Map或ServletRequest。</li>
</ul>
<h3 id="1-分析pagehelper源码"><a href="#1-分析pagehelper源码" class="headerlink" title="1.分析pagehelper源码"></a>1.分析pagehelper源码</h3><ul>
<li>首先是需要分析分页拦截器。分页插件在哪进行注入到SqlSessionFactory的？这就不得不提到两个主动配置的类了：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261351254.png"
                      alt="图片"
                ></p>
<ul>
<li>其中PageHelperProperties是为了去yml取出相应的配置，以供PageHelperAutoConfiguration在执行构造方法的时候找到。<strong>PageHelperAutoConfiguration实现了InitializingBean接口</strong>，所以<strong>重写了afterPropertiesSet方法</strong>，该方法会在构造方法执行后执行。</li>
<li>我们的yml配置是这样写的：</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pagehelper:</span></span><br><span class="line">    <span class="attr">helperDialect:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">supportMethodsArguments:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">params:</span> <span class="string">count=countSql</span></span><br></pre></td></tr></table></figure>

<ul>
<li>经过debug发现其实ry设置的几个参数全部不设置也可以。<strong>helperDialect如果不设置，程序每次执行SQL都要分析方言</strong>，何不索性告诉分页插件，这样也让程序执行略快一点。<strong>supportMethodsArguments</strong>虽然设置了，但是其实ry中根本没用过<strong>params</strong>设置了个寂寞，原本默认就是count&#x3D;countSql，本来就是默认值，设置也是白设置。</li>
</ul>
<h3 id="2-分析ry如何使用pagehelper"><a href="#2-分析ry如何使用pagehelper" class="headerlink" title="2.分析ry如何使用pagehelper"></a>2.分析ry如何使用pagehelper</h3><ul>
<li><strong>ry在BaseController中封装了分页方法。也就是说我们自己写的controller只要继承了BaseController，直接调用startPage方法即可完成分页。</strong></li>
<li>ry的分页源码也非常简单：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置请求分页数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">startPage</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">PageDomain</span> <span class="variable">pageDomain</span> <span class="operator">=</span> TableSupport.buildPageRequest();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">pageNum</span> <span class="operator">=</span> pageDomain.getPageNum();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">pageSize</span> <span class="operator">=</span> pageDomain.getPageSize();</span><br><span class="line">    <span class="type">String</span> <span class="variable">orderBy</span> <span class="operator">=</span> SqlUtil.escapeOrderBySql(pageDomain.getOrderBy());</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">reasonable</span> <span class="operator">=</span> pageDomain.getReasonable();</span><br><span class="line">    PageHelper.startPage(pageNum, pageSize, orderBy).setReasonable(reasonable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从源码可以发现，<strong>无非就是从请求中拿到从前端传来的pageNum，pageSize，reasonable，orderBy和isAsc这些分页参数，然后直接调用分页插件pagehelper的静态分页方法PageHelper.startPage。</strong></li>
</ul>
<h1 id="二十三、ry中的Mybatis详解"><a href="#二十三、ry中的Mybatis详解" class="headerlink" title="二十三、ry中的Mybatis详解"></a>二十三、ry中的Mybatis详解</h1><h2 id="1-mybatis和SpringBoot结合方式"><a href="#1-mybatis和SpringBoot结合方式" class="headerlink" title="1.mybatis和SpringBoot结合方式"></a>1.mybatis和SpringBoot结合方式</h2><ul>
<li>经过以前的经验，我们直接看mybatis的自动配置类：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">SqlSessionFactoryBean</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">    factory.setDataSource(dataSource);</span><br><span class="line">    factory.setVfs(SpringBootVFS.class);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(<span class="built_in">this</span>.properties.getConfigLocation())) &#123;</span><br><span class="line">        factory.setConfigLocation(<span class="built_in">this</span>.resourceLoader.getResource(<span class="built_in">this</span>.properties.getConfigLocation()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.applyConfiguration(factory);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.getConfigurationProperties() != <span class="literal">null</span>) &#123;</span><br><span class="line">        factory.setConfigurationProperties(<span class="built_in">this</span>.properties.getConfigurationProperties());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ObjectUtils.isEmpty(<span class="built_in">this</span>.interceptors)) &#123;</span><br><span class="line">        factory.setPlugins(<span class="built_in">this</span>.interceptors);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.databaseIdProvider != <span class="literal">null</span>) &#123;</span><br><span class="line">        factory.setDatabaseIdProvider(<span class="built_in">this</span>.databaseIdProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(<span class="built_in">this</span>.properties.getTypeAliasesPackage())) &#123;</span><br><span class="line">        factory.setTypeAliasesPackage(<span class="built_in">this</span>.properties.getTypeAliasesPackage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.getTypeAliasesSuperType() != <span class="literal">null</span>) &#123;</span><br><span class="line">        factory.setTypeAliasesSuperType(<span class="built_in">this</span>.properties.getTypeAliasesSuperType());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(<span class="built_in">this</span>.properties.getTypeHandlersPackage())) &#123;</span><br><span class="line">        factory.setTypeHandlersPackage(<span class="built_in">this</span>.properties.getTypeHandlersPackage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ObjectUtils.isEmpty(<span class="built_in">this</span>.typeHandlers)) &#123;</span><br><span class="line">        factory.setTypeHandlers(<span class="built_in">this</span>.typeHandlers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ObjectUtils.isEmpty(<span class="built_in">this</span>.properties.resolveMapperLocations())) &#123;</span><br><span class="line">        factory.setMapperLocations(<span class="built_in">this</span>.properties.resolveMapperLocations());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Set&lt;String&gt; factoryPropertyNames = (Set)Stream.of((<span class="keyword">new</span> <span class="title class_">BeanWrapperImpl</span>(SqlSessionFactoryBean.class)).getPropertyDescriptors()).map(FeatureDescriptor::getName).collect(Collectors.toSet());</span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">LanguageDriver</span>&gt; defaultLanguageDriver = <span class="built_in">this</span>.properties.getDefaultScriptingLanguageDriver();</span><br><span class="line">    <span class="keyword">if</span> (factoryPropertyNames.contains(<span class="string">&quot;scriptingLanguageDrivers&quot;</span>) &amp;&amp; !ObjectUtils.isEmpty(<span class="built_in">this</span>.languageDrivers)) &#123;</span><br><span class="line">        factory.setScriptingLanguageDrivers(<span class="built_in">this</span>.languageDrivers);</span><br><span class="line">        <span class="keyword">if</span> (defaultLanguageDriver == <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.languageDrivers.length == <span class="number">1</span>) &#123;</span><br><span class="line">            defaultLanguageDriver = <span class="built_in">this</span>.languageDrivers[<span class="number">0</span>].getClass();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (factoryPropertyNames.contains(<span class="string">&quot;defaultScriptingLanguageDriver&quot;</span>)) &#123;</span><br><span class="line">        factory.setDefaultScriptingLanguageDriver(defaultLanguageDriver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.applySqlSessionFactoryBeanCustomizers(factory);</span><br><span class="line">    <span class="keyword">return</span> factory.getObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以发现，无非就是创建SqlSessionFactoryBean并且进行一系列配置之后，getObject得到SqlSessionFactory（实际是DefaultSqlSessionFactory对象）对象。</li>
<li>so，ry也是如此，重写了一个方法来获得sqlSessionFactory：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">typeAliasesPackage</span> <span class="operator">=</span> env.getProperty(<span class="string">&quot;mybatis.typeAliasesPackage&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">mapperLocations</span> <span class="operator">=</span> env.getProperty(<span class="string">&quot;mybatis.mapperLocations&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">configLocation</span> <span class="operator">=</span> env.getProperty(<span class="string">&quot;mybatis.configLocation&quot;</span>);</span><br><span class="line">    typeAliasesPackage = setTypeAliasesPackage(typeAliasesPackage);</span><br><span class="line">    VFS.addImplClass(SpringBootVFS.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SqlSessionFactoryBean</span> <span class="variable">sessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">    sessionFactory.setDataSource(dataSource);</span><br><span class="line">    sessionFactory.setTypeAliasesPackage(typeAliasesPackage);</span><br><span class="line">    sessionFactory.setMapperLocations(resolveMapperLocations(StringUtils.split(mapperLocations, <span class="string">&quot;,&quot;</span>)));</span><br><span class="line">    sessionFactory.setConfigLocation(<span class="keyword">new</span> <span class="title class_">DefaultResourceLoader</span>().getResource(configLocation));</span><br><span class="line">    <span class="keyword">return</span> sessionFactory.getObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在SpringBoot项目中，把SqlSessionFactory接口的实例注入到Spring<strong>容器中</strong>，<strong>mybatis的配置也就随之完成</strong>。</li>
<li>经过debug源码，发现本质上ry的注入SqlSessionFactory和原本的自动注入没什么差别，<strong>如果一定要说有差别，那就是亲自去扫描了别名包typeAliasesPackage</strong>。但其实必要性不大，框架自己也会去扫。</li>
<li>通过以上的说明，我们发现其实可以把ry的mybatis配置必要性并不大，<strong>可以完全删除ry自己配置的bean</strong>，发现一点也不影响当前项目的功能。</li>
</ul>
<h2 id="2-mybatis-plus集成"><a href="#2-mybatis-plus集成" class="headerlink" title="2.mybatis-plus集成"></a>2.mybatis-plus集成</h2><ol>
<li>第一步，引入mybatis-plus，在<strong>common</strong>模块中：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>第二步，<strong>删除冲突依赖</strong>：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pagehelper 分页插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>第三步，填写yml配置：</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">	<span class="comment">#加载全局的配置文件</span></span><br><span class="line">        <span class="attr">configLocation:</span> <span class="string">classpath:mybatis/mybatis-config.xml</span></span><br><span class="line">        <span class="comment">#搜索指定包别名</span></span><br><span class="line">        <span class="attr">typeAliasesPackage:</span> <span class="string">com.ruoyi.**.domain</span></span><br><span class="line">        <span class="comment">#配置mapper的扫描，找到所有的mapper.xml映射文件</span></span><br><span class="line">        <span class="attr">mapperLocations:</span> <span class="string">classpath*:mapper/**/*Mapper.xml</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>第四步，删除MyBatisConfig，也就是删除ry自己的配置文件，删除下面这个文件：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.framework.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.VFS;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.boot.autoconfigure.SpringBootVFS;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.DefaultResourceLoader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.ResourcePatternResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.classreading.CachingMetadataReaderFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.classreading.MetadataReader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.classreading.MetadataReaderFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ClassUtils;</span><br><span class="line"><span class="keyword">import</span> com.fzx.common.utils.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mybatis支持*匹配扫描包</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Environment env;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_RESOURCE_PATTERN</span> <span class="operator">=</span> <span class="string">&quot;**/*.class&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">setTypeAliasesPackage</span><span class="params">(String typeAliasesPackage)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">ResourcePatternResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> (ResourcePatternResolver) <span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>();</span><br><span class="line">        <span class="type">MetadataReaderFactory</span> <span class="variable">metadataReaderFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CachingMetadataReaderFactory</span>(resolver);</span><br><span class="line">        List&lt;String&gt; allResult = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (String aliasesPackage : typeAliasesPackage.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                List&lt;String&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">                aliasesPackage = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX</span><br><span class="line">                        + ClassUtils.convertClassNameToResourcePath(aliasesPackage.trim()) + <span class="string">&quot;/&quot;</span> + DEFAULT_RESOURCE_PATTERN;</span><br><span class="line">                Resource[] resources = resolver.getResources(aliasesPackage);</span><br><span class="line">                <span class="keyword">if</span> (resources != <span class="literal">null</span> &amp;&amp; resources.length &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">MetadataReader</span> <span class="variable">metadataReader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (Resource resource : resources)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (resource.isReadable())</span><br><span class="line">                        &#123;</span><br><span class="line">                            metadataReader = metadataReaderFactory.getMetadataReader(resource);</span><br><span class="line">                            <span class="keyword">try</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                result.add(Class.forName(metadataReader.getClassMetadata().getClassName()).getPackage().getName());</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">catch</span> (ClassNotFoundException e)</span><br><span class="line">                            &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (result.size() &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    HashSet&lt;String&gt; hashResult = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;(result);</span><br><span class="line">                    allResult.addAll(hashResult);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (allResult.size() &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                typeAliasesPackage = String.join(<span class="string">&quot;,&quot;</span>, (String[]) allResult.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;mybatis typeAliasesPackage 路径扫描错误,参数typeAliasesPackage:&quot;</span> + typeAliasesPackage + <span class="string">&quot;未找到任何包&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> typeAliasesPackage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Resource[] resolveMapperLocations(String[] mapperLocations)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">ResourcePatternResolver</span> <span class="variable">resourceResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>();</span><br><span class="line">        List&lt;Resource&gt; resources = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Resource&gt;();</span><br><span class="line">        <span class="keyword">if</span> (mapperLocations != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (String mapperLocation : mapperLocations)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Resource[] mappers = resourceResolver.getResources(mapperLocation);</span><br><span class="line">                    resources.addAll(Arrays.asList(mappers));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (IOException e)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resources.toArray(<span class="keyword">new</span> <span class="title class_">Resource</span>[resources.size()]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">typeAliasesPackage</span> <span class="operator">=</span> env.getProperty(<span class="string">&quot;mybatis.typeAliasesPackage&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">mapperLocations</span> <span class="operator">=</span> env.getProperty(<span class="string">&quot;mybatis.mapperLocations&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">configLocation</span> <span class="operator">=</span> env.getProperty(<span class="string">&quot;mybatis.configLocation&quot;</span>);</span><br><span class="line">        typeAliasesPackage = setTypeAliasesPackage(typeAliasesPackage);</span><br><span class="line">        VFS.addImplClass(SpringBootVFS.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">SqlSessionFactoryBean</span> <span class="variable">sessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        sessionFactory.setDataSource(dataSource);</span><br><span class="line">        sessionFactory.setTypeAliasesPackage(typeAliasesPackage);</span><br><span class="line">        sessionFactory.setMapperLocations(resolveMapperLocations(StringUtils.split(mapperLocations, <span class="string">&quot;,&quot;</span>)));</span><br><span class="line">        sessionFactory.setConfigLocation(<span class="keyword">new</span> <span class="title class_">DefaultResourceLoader</span>().getResource(configLocation));</span><br><span class="line">        <span class="keyword">return</span> sessionFactory.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后直接重启项目，成功！</li>
</ul>
<h2 id="3-解释疑问："><a href="#3-解释疑问：" class="headerlink" title="3.解释疑问："></a>3.解释疑问：</h2><ul>
<li>疑问一：为什么要排除pagehelper中的mybatis依赖？</li>
</ul>
<blockquote>
<p>答：因为mybatis-plus的启动器和pagehelper都引入了mybatis，mybatis-plus的启动器的mybatis版本比较高。pagehelper引入的mybatis的版本比较低，mybatis-plus用到了高版本mybatis的方法。所以需要排除pagehelper中的mybatis。否则报错没找到方法。</p>
</blockquote>
<ul>
<li>疑问二：pagehelper中排除了mybatis，为啥不把mybatis-spring一块给排除掉？</li>
</ul>
<blockquote>
<p>答：确实可以一块排除掉，可以。但是mybatis-plus也引入了mybatis-spring，所以并不冲突，maven会自动排除一个。</p>
</blockquote>
<ul>
<li>疑问三：为啥在pagehelper中不把MybatisAutoConfiguration的依赖排除掉？不都有mybatis-plus了吗，我还要MybatisAutoConfiguration有啥用？</li>
</ul>
<blockquote>
<p>答：因为pagehelper的自动配置类用到了MybatisAutoConfiguration，虽然不起作用，但是也不能排除依赖，否则直接报【类没有找到异常】。那么在哪里用到的呢？</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261432764.png"
                      alt="图片"
                ></p>
<ul>
<li>疑问四：为啥yml配置中不写mapperLocations的相关配置？</li>
</ul>
<blockquote>
<p>答：可以写，但是默认就是classpath*:mapper&#x2F;**&#x2F;*Mapper.xml，写不写都一样，相关源码：</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261434087.png"
                      alt="图片"
                ></p>
<ul>
<li>疑问五：为啥要删除原本的MybatisConfig？</li>
</ul>
<blockquote>
<p>答：因为原来的MybatisConfig会生成一个名字为sqlSessionFactory的bean，那么mybatis-plus的自动配置bean失效，因为mybatis-plus的自动配置加了注解@ConditionalOnMissingBean，也就是说sqlSessionFactory若存在，mybatis-plus则不会注入sqlSessionFactory。相关代码：</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261435930.png"
                      alt="图片"
                ></p>
<h2 id="4-测试mybatis-plus"><a href="#4-测试mybatis-plus" class="headerlink" title="4.测试mybatis-plus"></a>4.测试mybatis-plus</h2><ul>
<li>先给mapper接口加buff：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SysLogininforMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;SysLogininfor&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后直接查询即可：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SysLogininfor&gt; <span class="title function_">selectLogininforList</span><span class="params">(SysLogininfor logininfor)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> logininforMapper.selectList(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//        return logininforMapper.selectLogininforList(logininfor);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>报错！然后生成的SQL：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  info_id,</span><br><span class="line">  user_name,</span><br><span class="line">  STATUS,</span><br><span class="line">  ipaddr,</span><br><span class="line">  login_location,</span><br><span class="line">  browser,</span><br><span class="line">  os,</span><br><span class="line">  msg,</span><br><span class="line">  login_time,</span><br><span class="line">  search_value,</span><br><span class="line">  create_by,</span><br><span class="line">  create_time,</span><br><span class="line">  update_by,</span><br><span class="line">  update_time,</span><br><span class="line">  remark,</span><br><span class="line">  params   </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  sys_logininfor   </span><br><span class="line">  LIMIT ?</span><br></pre></td></tr></table></figure>

<ul>
<li>好玩的事情发生了，BaseEntity的属性也被写入了SQL中。对于这种残花败柳，我们直接标记它不存在：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 搜索值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@TableField(exist = false)</span></span><br><span class="line">  <span class="keyword">private</span> String searchValue;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建者</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@TableField(exist = false)</span></span><br><span class="line">  <span class="keyword">private</span> String createBy;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建时间</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">  <span class="meta">@TableField(exist = false)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 更新者</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@TableField(exist = false)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String updateBy;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 更新时间</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">  <span class="meta">@TableField(exist = false)</span></span><br><span class="line">  <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 备注</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@TableField(exist = false)</span></span><br><span class="line">  <span class="keyword">private</span> String remark;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 请求参数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@TableField(exist = false)</span></span><br><span class="line">  <span class="keyword">private</span> Map&lt;String, Object&gt; params;</span><br></pre></td></tr></table></figure>

<h2 id="5-拓展学习"><a href="#5-拓展学习" class="headerlink" title="5.拓展学习"></a>5.拓展学习</h2><p>请大家自主学习下面注解的含义。</p>
<ul>
<li>网站一：<a class="link"   target="_blank" rel="noopener" href="https://wenku.baidu.com/view/20631ddf0142a8956bec0975f46527d3240ca624.html" >https://wenku.baidu.com/view/20631ddf0142a8956bec0975f46527d3240ca624.html<i class="fas fa-external-link-alt"></i></a></li>
<li>网站二：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/Lou_Lan/article/details/106192074" >https://blog.csdn.net/Lou_Lan/article/details/106192074<i class="fas fa-external-link-alt"></i></a></li>
<li>网站三：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43808717/article/details/118214615" >https://blog.csdn.net/weixin_43808717/article/details/118214615<i class="fas fa-external-link-alt"></i></a></li>
<li>网站四：<a class="link"   target="_blank" rel="noopener" href="https://baijiahao.baidu.com/s?id=1740059649839757132&amp;wfr=spider&amp;for=pc" >https://baijiahao.baidu.com/s?id=1740059649839757132&amp;wfr=spider&amp;for=pc<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261446429.png"
                      alt="图片"
                ></p>
<h1 id="二十四、多数据源原理以及实现"><a href="#二十四、多数据源原理以及实现" class="headerlink" title="二十四、多数据源原理以及实现"></a>二十四、多数据源原理以及实现</h1><h2 id="1-多数据源原理以及实现"><a href="#1-多数据源原理以及实现" class="headerlink" title="1.多数据源原理以及实现"></a>1.多数据源原理以及实现</h2><ul>
<li>多数据源不是必须的，只是有的人有相关的需求，想让一个项目同时连接操作多个数据库，仅此而已。</li>
</ul>
<h2 id="2-多数据源在什么地方做文章？"><a href="#2-多数据源在什么地方做文章？" class="headerlink" title="2.多数据源在什么地方做文章？"></a>2.多数据源在什么地方做文章？</h2><ul>
<li>对于一个请求（假如此请求需要查询数据库），我们首先是权限点击，然后前端给后端发请求，后端controller层拿到请求，哟，要查数据，controller把请求发给service层，service层把数据再递交给mapper层，mapper层在ry中是mybatis接管。</li>
<li>当mybatis看到数据库查询请求后，这时候代理模式就开始了，我们的mapper层的接口被代理，框架直接通过反射拿到当前的代理对象、方法、相关参数、DefaultSqlSession去执行相关查询。</li>
<li>重点来了，怎么查询？首先要干嘛？当然是得到当前数据库的连接Connection，然后通过此数据库连接进行执行相关查询。</li>
<li>相关重要代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一段代码，第一次出现getConnection：</span></span><br><span class="line">    <span class="keyword">private</span> Statement <span class="title function_">prepareStatement</span><span class="params">(StatementHandler handler, Log statementLog)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="built_in">this</span>.getConnection(statementLog);</span><br><span class="line">        <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> handler.prepare(connection, <span class="built_in">this</span>.transaction.getTimeout());</span><br><span class="line">        handler.parameterize(stmt);</span><br><span class="line">        <span class="keyword">return</span> stmt;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 第二段代码，关键性代码，从dataSource中获得连接：</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Connection <span class="title function_">fetchConnection</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">    <span class="keyword">if</span> (con == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;DataSource returned null from getConnection(): &quot;</span> + dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> con;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从以上的代码可以发现，要一拿到连接就开始执行查询了。所以我们怎么搞多个数据源？我们可以利用<strong>委托模式</strong>。</li>
<li>我们自己写一个类<strong>DynamicDataSource</strong>（动态数据源的英文），实现DataSource接口，然后重写getConnection方法，<strong>我们可以在DynamicDataSource类中准备好几个连接，然后getConnection方法中根据情况获得不同的连接</strong>。</li>
<li>在spring-jdbc中，给我们提供了一个特殊的类，名为<strong>AbstractRoutingDataSource</strong>，该类是专门给我们实现多数据源使用的。</li>
<li>该类在getConnection做文章：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">   <span class="keyword">return</span> determineTargetDataSource().getConnection();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从以上看到，获得数据连接依赖了另外一个方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Retrieve the current target DataSource. Determines the</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> #determineCurrentLookupKey() current lookup key&#125;, performs</span></span><br><span class="line"><span class="comment">   * a lookup in the &#123;<span class="doctag">@link</span> #setTargetDataSources targetDataSources&#125; map,</span></span><br><span class="line"><span class="comment">   * falls back to the specified</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> #setDefaultTargetDataSource default target DataSource&#125; if necessary.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@see</span> #determineCurrentLookupKey()</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> DataSource <span class="title function_">determineTargetDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">    Assert.notNull(<span class="built_in">this</span>.resolvedDataSources, <span class="string">&quot;DataSource router not initialized&quot;</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">lookupKey</span> <span class="operator">=</span> determineCurrentLookupKey();</span><br><span class="line">    <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="built_in">this</span>.resolvedDataSources.get(lookupKey);</span><br><span class="line">    <span class="keyword">if</span> (dataSource == <span class="literal">null</span> &amp;&amp; (<span class="built_in">this</span>.lenientFallback || lookupKey == <span class="literal">null</span>)) &#123;</span><br><span class="line">      dataSource = <span class="built_in">this</span>.resolvedDefaultDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dataSource == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot determine target DataSource for lookup key [&quot;</span> + lookupKey + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上代码中有一个特殊的方法叫<strong>determineCurrentLookupKey</strong>，该方法需要用户自己重写，<strong>该方法获得一个KEY，用KEY去Map中找到了对应的Connection。</strong></li>
<li>也就是说，用户可以自己<strong>先</strong>在resolvedDataSources（存若干数据源的Map）存储自己的多个数据库连接，例如A对应A连接，B对应B连接。<strong>然后</strong>用户不是可以自己重写determineCurrentLookupKey方法得到KEY吗，也就是是得到的KEY是A还是得到B程序员说了算。如此数据连接就可以动态切换了。</li>
</ul>
<h2 id="3-ry中多数据源实践"><a href="#3-ry中多数据源实践" class="headerlink" title="3.ry中多数据源实践"></a>3.ry中多数据源实践</h2><h3 id="步骤一：首先是准备多个数据源："><a href="#步骤一：首先是准备多个数据源：" class="headerlink" title="步骤一：首先是准备多个数据源："></a>步骤一：首先是准备多个数据源：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.druid.master&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">masterDataSource</span><span class="params">(DruidProperties druidProperties)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">        <span class="keyword">return</span> druidProperties.dataSource(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.druid.slave&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix = &quot;spring.datasource.druid.slave&quot;, name = &quot;enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">slaveDataSource</span><span class="params">(DruidProperties druidProperties)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">        <span class="keyword">return</span> druidProperties.dataSource(dataSource);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上代码的从数据源，也就是slave数据源，需要把条件注解的enabled条件设置为true，该Bean才会生效。同时，yml文件中也需要写好多个数据源：</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="comment"># 主库数据源</span></span><br><span class="line">      <span class="attr">master:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test1?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="comment"># 从库数据源</span></span><br><span class="line">      <span class="attr">slave:</span></span><br><span class="line">        <span class="comment"># 从数据源开关/默认关闭</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test2?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如此，关于数据源的Bean就已经有两个了，但是mybatis-plus的自动配置类中要求有一个beanName为dataSource的bean，当前两个数据源bean名字为masterDataSource和slaveDataSource，所以都不匹配，就会根据Bean的类型来注入，发现类型为DataSource的bean为两个。所以说，启动会报错。</li>
<li>下面是mybatis-plus的注入SqlSessionFactory的签名：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br></pre></td></tr></table></figure>

<h3 id="步骤二：整合多个数据源："><a href="#步骤二：整合多个数据源：" class="headerlink" title="步骤二：整合多个数据源："></a>步骤二：整合多个数据源：</h3><ul>
<li>ry写了一个新的类：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.wqj.test.datasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态数据源</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DynamicDataSource</span><span class="params">(DataSource defaultTargetDataSource, Map&lt;Object, Object&gt; targetDataSources)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">super</span>.setDefaultTargetDataSource(defaultTargetDataSource);</span><br><span class="line">        <span class="built_in">super</span>.setTargetDataSources(targetDataSources);</span><br><span class="line">        <span class="built_in">super</span>.afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> DynamicDataSourceContextHolder.getDataSourceType();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>该类继承了AbstractRoutingDataSource，类图如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261539362.png"
                      alt="图片"
                ></p>
<ul>
<li>可以发现DynamicDataSource也是一个DataSource。该类是如何注入的呢？如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="keyword">public</span> DynamicDataSource <span class="title function_">dataSource</span><span class="params">(DataSource masterDataSource)</span> &#123;</span><br><span class="line">    Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    targetDataSources.put(DataSourceType.MASTER.name(), masterDataSource);</span><br><span class="line">    setDataSource(targetDataSources, DataSourceType.SLAVE.name(), <span class="string">&quot;slaveDataSource&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DynamicDataSource</span>(masterDataSource, targetDataSources);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注入之后，Spring容器中出现了惊人的三个DataSource，<strong>其中DynamicDataSource是对masterDataSource和slaveDataSource的整合</strong>。其中masterDataSource是默认数据源，targetDataSources放着全部的数据源（包括默认数据源和其他数据源）。再次回到下面这段代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="title function_">DynamicDataSource</span><span class="params">(DataSource defaultTargetDataSource, Map&lt;Object, Object&gt; targetDataSources)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">super</span>.setDefaultTargetDataSource(defaultTargetDataSource);</span><br><span class="line">        <span class="built_in">super</span>.setTargetDataSources(targetDataSources);</span><br><span class="line">        <span class="built_in">super</span>.afterPropertiesSet();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>这是DynamicDataSource的构造方法</strong>，第一句话是设置默认数据源，第二句话是设置全部数据源（包括默认和其他），第三句话是执行下面的代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.targetDataSources == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Property &#x27;targetDataSources&#x27; is required&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.resolvedDataSources = CollectionUtils.newHashMap(<span class="built_in">this</span>.targetDataSources.size());</span><br><span class="line">  <span class="built_in">this</span>.targetDataSources.forEach((key, value) -&gt; &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">lookupKey</span> <span class="operator">=</span> resolveSpecifiedLookupKey(key);</span><br><span class="line">    <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> resolveSpecifiedDataSource(value);</span><br><span class="line">    <span class="built_in">this</span>.resolvedDataSources.put(lookupKey, dataSource);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.defaultTargetDataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.resolvedDefaultDataSource = resolveSpecifiedDataSource(<span class="built_in">this</span>.defaultTargetDataSource);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从以上代码可以看到，对于我们目前的程序来说，啥都没做。</li>
<li>目前，出现三个数据源，我们需要标记一个主数据源，方便mybatis-plus获得相关的DataSource，以上我们看到通过@Primary标记了dataSource为主数据源（新写的动态数据源，dataSource是它的beanName）。</li>
</ul>
<h3 id="步骤三：在请求时选择合适的数据源："><a href="#步骤三：在请求时选择合适的数据源：" class="headerlink" title="步骤三：在请求时选择合适的数据源："></a>步骤三：在请求时选择合适的数据源：</h3><ul>
<li>每次对数据库的请求，都要拿到数据源DynamicDataSource执行getConnection方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  <span class="keyword">return</span> determineTargetDataSource().getConnection();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后去determineTargetDataSource方法找到数据源：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Retrieve the current target DataSource. Determines the</span></span><br><span class="line"><span class="comment">  * &#123;<span class="doctag">@link</span> #determineCurrentLookupKey() current lookup key&#125;, performs</span></span><br><span class="line"><span class="comment">  * a lookup in the &#123;<span class="doctag">@link</span> #setTargetDataSources targetDataSources&#125; map,</span></span><br><span class="line"><span class="comment">  * falls back to the specified</span></span><br><span class="line"><span class="comment">  * &#123;<span class="doctag">@link</span> #setDefaultTargetDataSource default target DataSource&#125; if necessary.</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@see</span> #determineCurrentLookupKey()</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">protected</span> DataSource <span class="title function_">determineTargetDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">   Assert.notNull(<span class="built_in">this</span>.resolvedDataSources, <span class="string">&quot;DataSource router not initialized&quot;</span>);</span><br><span class="line">   <span class="type">Object</span> <span class="variable">lookupKey</span> <span class="operator">=</span> determineCurrentLookupKey();</span><br><span class="line">   <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="built_in">this</span>.resolvedDataSources.get(lookupKey);</span><br><span class="line">   <span class="keyword">if</span> (dataSource == <span class="literal">null</span> &amp;&amp; (<span class="built_in">this</span>.lenientFallback || lookupKey == <span class="literal">null</span>)) &#123;</span><br><span class="line">     dataSource = <span class="built_in">this</span>.resolvedDefaultDataSource;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (dataSource == <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot determine target DataSource for lookup key [&quot;</span> + lookupKey + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> dataSource;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后找到KEY：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> DynamicDataSourceContextHolder.getDataSourceType();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实际上是一个ThreadLocal类的get：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; CONTEXT_HOLDER = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDataSourceType</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> CONTEXT_HOLDER.get();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>也就是拿到线程私有设置的String字符串，<strong>当然当前还没有讲在哪里设置的，但是告诉大家，大部分时候都没有设置，也就是找到一个NULL。</strong>那么变量lookupKey是NULL的情况下，视频讲解下面这段代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> DataSource <span class="title function_">determineTargetDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">   Assert.notNull(<span class="built_in">this</span>.resolvedDataSources, <span class="string">&quot;DataSource router not initialized&quot;</span>);</span><br><span class="line">   <span class="type">Object</span> <span class="variable">lookupKey</span> <span class="operator">=</span> determineCurrentLookupKey();</span><br><span class="line">   <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="built_in">this</span>.resolvedDataSources.get(lookupKey);</span><br><span class="line">   <span class="keyword">if</span> (dataSource == <span class="literal">null</span> &amp;&amp; (<span class="built_in">this</span>.lenientFallback || lookupKey == <span class="literal">null</span>)) &#123;</span><br><span class="line">     dataSource = <span class="built_in">this</span>.resolvedDefaultDataSource;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (dataSource == <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot determine target DataSource for lookup key [&quot;</span> + lookupKey + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> dataSource;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>情况一：lookupKey为null，那么dataSource也是null，那么肯定是走默认的数据源。【大部分时候都是走的本情况，因为基本没有主动设置过数据源】</li>
<li>情况二：lookupKey不为null，dataSource找到了。那么程序直接返回了，就用找到的数据源。</li>
<li>情况三：lookupKey不为null，dataSource没找到。这个时候就要看lenientFallback属性的值了，如果是true就用默认的数据源，如果是false就抛异常。默认lenientFallback是true。而且我们新写的类也没有去改过，所以找不到数据源必然会用默认数据源。</li>
<li>另外，从以上的代码可以发现DynamicDataSourceContextHolder的lookupKey决定着去取哪个数据源。那么DynamicDataSourceContextHolder的值在哪里设置的呢？这就是步骤四的内容了。</li>
</ul>
<h3 id="步骤四：DynamicDataSourceContextHolder中的数据变化。"><a href="#步骤四：DynamicDataSourceContextHolder中的数据变化。" class="headerlink" title="步骤四：DynamicDataSourceContextHolder中的数据变化。"></a>步骤四：DynamicDataSourceContextHolder中的数据变化。</h3><ul>
<li>DynamicDataSourceContextHolder的变化和AOP有关了，直接来看相关的AOP切面：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源处理</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order(1)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAspect</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.ruoyi.common.annotation.DataSource)&quot;</span></span><br><span class="line"><span class="meta">            + &quot;|| @within(com.ruoyi.common.annotation.DataSource)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dsPointCut</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;dsPointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Throwable</span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> getDataSource(point);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(dataSource))</span><br><span class="line">        &#123;</span><br><span class="line">            DynamicDataSourceContextHolder.setDataSourceType(dataSource.value().name());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> point.proceed();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 销毁数据源 在执行方法之后</span></span><br><span class="line">            DynamicDataSourceContextHolder.clearDataSourceType();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取需要切换的数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">getDataSource</span><span class="params">(ProceedingJoinPoint point)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) point.getSignature();</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> AnnotationUtils.findAnnotation(signature.getMethod(), DataSource.class);</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(dataSource))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> dataSource;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> AnnotationUtils.findAnnotation(signature.getDeclaringType(), DataSource.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到，首先是定义了切入点：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Pointcut(&quot;@annotation(com.ruoyi.common.annotation.DataSource)&quot;</span></span><br><span class="line"><span class="meta">            + &quot;|| @within(com.ruoyi.common.annotation.DataSource)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dsPointCut</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>关于此切入点，是什么意思？</p>
<blockquote>
<p>@annotation是说，如果括号内的值【也就是DataSouce注解】被注解在某个方法上，那么能切入到该方法。</p>
</blockquote>
<blockquote>
<p>@within是说，如果括号内的值注解到类上，那我能切到该类的全部方法中。</p>
</blockquote>
</li>
<li><p>总结：如果需要切换多个数据源，只需要把@DataSource注解加到方法上或者类上，切面会把注解中的value读出来并设置到线程私有上下文中，然后<strong>在getConnection的时候读取线程私有的value来确定用哪个数据源</strong>。</p>
</li>
</ul>
<h2 id="4-三个MySQL数据源走起"><a href="#4-三个MySQL数据源走起" class="headerlink" title="4.三个MySQL数据源走起"></a>4.三个MySQL数据源走起</h2><ul>
<li>准备多个数据源：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.druid.master&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">masterDataSource</span><span class="params">(DruidProperties druidProperties)</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">        <span class="keyword">return</span> druidProperties.dataSource(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.druid.slave&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix = &quot;spring.datasource.druid.slave&quot;, name = &quot;enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">slaveDataSource</span><span class="params">(DruidProperties druidProperties)</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">        <span class="keyword">return</span> druidProperties.dataSource(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.druid.third&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix = &quot;spring.datasource.druid.third&quot;, name = &quot;enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">thirdDataSource</span><span class="params">(DruidProperties druidProperties)</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">        <span class="keyword">return</span> druidProperties.dataSource(dataSource);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>yml配置三个走起：</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="comment"># 主库数据源</span></span><br><span class="line">      <span class="attr">master:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test1?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="comment"># 从库数据源</span></span><br><span class="line">      <span class="attr">slave:</span></span><br><span class="line">        <span class="comment"># 从数据源开关/默认关闭</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test2?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">third:</span></span><br><span class="line">        <span class="comment"># 从数据源开关/默认关闭</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test3?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="comment"># 初始连接数</span></span><br><span class="line">      <span class="attr">initialSize:</span> <span class="number">5</span></span><br><span class="line">      <span class="comment"># 最小连接池数量</span></span><br><span class="line">      <span class="attr">minIdle:</span> <span class="number">10</span></span><br><span class="line">      <span class="comment"># 最大连接池数量</span></span><br><span class="line">      <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">      <span class="comment"># 配置获取连接等待超时的时间</span></span><br><span class="line">      <span class="attr">maxWait:</span> <span class="number">60000</span></span><br><span class="line">      <span class="comment"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span></span><br><span class="line">      <span class="attr">timeBetweenEvictionRunsMillis:</span> <span class="number">60000</span></span><br><span class="line">      <span class="comment"># 配置一个连接在池中最小生存的时间，单位是毫秒</span></span><br><span class="line">      <span class="attr">minEvictableIdleTimeMillis:</span> <span class="number">300000</span></span><br><span class="line">      <span class="comment"># 配置一个连接在池中最大生存的时间，单位是毫秒</span></span><br><span class="line">      <span class="attr">maxEvictableIdleTimeMillis:</span> <span class="number">900000</span></span><br><span class="line">      <span class="comment"># 配置检测连接是否有效</span></span><br><span class="line">      <span class="attr">validationQuery:</span> <span class="string">SELECT</span> <span class="number">1</span> <span class="string">FROM</span> <span class="string">DUAL</span></span><br><span class="line">      <span class="attr">testWhileIdle:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">testOnBorrow:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">testOnReturn:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">webStatFilter:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">statViewServlet:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 设置白名单，不填则允许所有访问</span></span><br><span class="line">        <span class="attr">allow:</span></span><br><span class="line">        <span class="attr">url-pattern:</span> <span class="string">/druid/*</span></span><br><span class="line">        <span class="comment"># 控制台管理用户名和密码</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">ruoyi</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="comment"># 慢SQL记录</span></span><br><span class="line">          <span class="attr">log-slow-sql:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">1000</span></span><br><span class="line">          <span class="attr">merge-sql:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">wall:</span></span><br><span class="line">          <span class="attr">config:</span></span><br><span class="line">            <span class="attr">multi-statement-allow:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>当然数据库三个数据库先建立好，目前都是ry的数据库复制三份。</li>
<li>修改三个数据库的枚举：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 主库</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   MASTER,</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 从库</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   SLAVE,</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 第三数据库</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   THIRD</span><br></pre></td></tr></table></figure>

<ul>
<li>注入三个数据库到动态数据库：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@Primary</span></span><br><span class="line">   <span class="keyword">public</span> DynamicDataSource <span class="title function_">dataSource</span><span class="params">(DataSource masterDataSource,</span></span><br><span class="line"><span class="params">                                       DataSource slaveDataSource,</span></span><br><span class="line"><span class="params">                                       DataSource thirdDataSource)</span> &#123;</span><br><span class="line">       Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">       targetDataSources.put(DataSourceType.MASTER.name(), masterDataSource);</span><br><span class="line">       targetDataSources.put(DataSourceType.SLAVE.name(),slaveDataSource);</span><br><span class="line">       targetDataSources.put(DataSourceType.THIRD.name(),thirdDataSource);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DynamicDataSource</span>(masterDataSource, targetDataSources);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-四个数据源"><a href="#5-四个数据源" class="headerlink" title="5.四个数据源"></a>5.四个数据源</h2><ul>
<li>以上的三个数据源都是MySQL，一点气质都没有。现在我们再来一个不是MySQL的数据库，气质要拉满！</li>
<li>我们来MySQL+MySQL+MySQL+SQL Server。</li>
</ul>
<h3 id="第一步：引入SQL-Server驱动："><a href="#第一步：引入SQL-Server驱动：" class="headerlink" title="第一步：引入SQL Server驱动："></a>第一步：引入SQL Server驱动：</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.microsoft.sqlserver<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mssql-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>11.2.1.jre11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>SQL Server驱动有时和JDK版本挂了一点小勾，所有大家的JDK尽量和我保持一致，JDK11。</li>
</ul>
<h3 id="第二步：修改YML："><a href="#第二步：修改YML：" class="headerlink" title="第二步：修改YML："></a>第二步：修改YML：</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 数据源配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="comment">#    driverClassName: com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="comment"># 主库数据源</span></span><br><span class="line">      <span class="attr">master:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test1?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">        <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="comment"># 从库数据源</span></span><br><span class="line">      <span class="attr">slave:</span></span><br><span class="line">        <span class="comment"># 从数据源开关/默认关闭</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test2?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">        <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">third:</span></span><br><span class="line">        <span class="comment"># 从数据源开关/默认关闭</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test3?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">        <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">fourth:</span></span><br><span class="line">        <span class="comment"># 从数据源开关/默认关闭</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:sqlserver://wangqingjiang.top:1433;DatabaseName=test4;encrypt=false;SelectMethod=cursor</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">sa</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">qwe20211114.</span></span><br><span class="line">        <span class="attr">driverClassName:</span> <span class="string">com.microsoft.sqlserver.jdbc.SQLServerDriver</span></span><br><span class="line">      <span class="comment"># 初始连接数</span></span><br><span class="line">      <span class="attr">initialSize:</span> <span class="number">5</span></span><br><span class="line">      <span class="comment"># 最小连接池数量</span></span><br><span class="line">      <span class="attr">minIdle:</span> <span class="number">10</span></span><br><span class="line">      <span class="comment"># 最大连接池数量</span></span><br><span class="line">      <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">      <span class="comment"># 配置获取连接等待超时的时间</span></span><br><span class="line">      <span class="attr">maxWait:</span> <span class="number">60000</span></span><br><span class="line">      <span class="comment"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span></span><br><span class="line">      <span class="attr">timeBetweenEvictionRunsMillis:</span> <span class="number">60000</span></span><br><span class="line">      <span class="comment"># 配置一个连接在池中最小生存的时间，单位是毫秒</span></span><br><span class="line">      <span class="attr">minEvictableIdleTimeMillis:</span> <span class="number">300000</span></span><br><span class="line">      <span class="comment"># 配置一个连接在池中最大生存的时间，单位是毫秒</span></span><br><span class="line">      <span class="attr">maxEvictableIdleTimeMillis:</span> <span class="number">900000</span></span><br><span class="line">      <span class="comment"># 配置检测连接是否有效</span></span><br><span class="line">      <span class="attr">validationQuery:</span> <span class="string">select</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">testWhileIdle:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">testOnBorrow:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">testOnReturn:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">webStatFilter:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">statViewServlet:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 设置白名单，不填则允许所有访问</span></span><br><span class="line">        <span class="attr">allow:</span></span><br><span class="line">        <span class="attr">url-pattern:</span> <span class="string">/druid/*</span></span><br><span class="line">        <span class="comment"># 控制台管理用户名和密码</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">ruoyi</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="comment"># 慢SQL记录</span></span><br><span class="line">          <span class="attr">log-slow-sql:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">1000</span></span><br><span class="line">          <span class="attr">merge-sql:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">wall:</span></span><br><span class="line">          <span class="attr">config:</span></span><br><span class="line">            <span class="attr">multi-statement-allow:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>值得注意的是，<strong>driverClassName类被我移动了位置，因为MySQL的驱动并不是万能的</strong>。</li>
<li>第二点五步：改枚举：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DataSourceType</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    MASTER,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SLAVE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第三数据库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    THIRD,</span><br><span class="line">    FOURTH</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第三步：在DruidConfig中注入数据源Bean："><a href="#第三步：在DruidConfig中注入数据源Bean：" class="headerlink" title="第三步：在DruidConfig中注入数据源Bean："></a>第三步：在DruidConfig中注入数据源Bean：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"> <span class="meta">@ConfigurationProperties(&quot;spring.datasource.druid.fourth&quot;)</span></span><br><span class="line"> <span class="meta">@ConditionalOnProperty(prefix = &quot;spring.datasource.druid.fourth&quot;, name = &quot;enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> DataSource <span class="title function_">fourthDataSource</span><span class="params">(DruidProperties druidProperties)</span> &#123;</span><br><span class="line">     <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">     <span class="keyword">return</span> druidProperties.dataSource(dataSource);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="第四步：在DruidConfig第四个数据源被动态数据源读入："><a href="#第四步：在DruidConfig第四个数据源被动态数据源读入：" class="headerlink" title="第四步：在DruidConfig第四个数据源被动态数据源读入："></a>第四步：在DruidConfig第四个数据源被动态数据源读入：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"> <span class="meta">@Primary</span></span><br><span class="line"> <span class="keyword">public</span> DynamicDataSource <span class="title function_">dataSource</span><span class="params">(DataSource masterDataSource,</span></span><br><span class="line"><span class="params">                                     DataSource slaveDataSource,</span></span><br><span class="line"><span class="params">                                     DataSource thirdDataSource,</span></span><br><span class="line"><span class="params">                                     DataSource fourthDataSource)</span> &#123;</span><br><span class="line">     Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">     targetDataSources.put(DataSourceType.MASTER.name(), masterDataSource);</span><br><span class="line">     targetDataSources.put(DataSourceType.SLAVE.name(),slaveDataSource);</span><br><span class="line">     targetDataSources.put(DataSourceType.THIRD.name(),thirdDataSource);</span><br><span class="line">     targetDataSources.put(DataSourceType.FOURTH.name(),fourthDataSource);</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DynamicDataSource</span>(masterDataSource, targetDataSources);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过写下面的代码来进行测试：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> TableDataInfo <span class="title function_">list</span><span class="params">(SysOperLog operLog)</span> &#123;</span><br><span class="line">    PageHelper.startPage(operLog);</span><br><span class="line">    List&lt;SysOperLog&gt; list = operLogService.selectOperLogList(operLog);</span><br><span class="line">    <span class="keyword">return</span> getDataTable(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/listMaster&quot;)</span></span><br><span class="line"><span class="keyword">public</span> TableDataInfo <span class="title function_">listMaster</span><span class="params">(SysOperLog operLog)</span> &#123;</span><br><span class="line">    PageHelper.startPage(operLog);</span><br><span class="line">    List&lt;SysOperLog&gt; list = operLogService.selectOperLogListMaster(operLog);</span><br><span class="line">    <span class="keyword">return</span> getDataTable(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/listSlave&quot;)</span></span><br><span class="line"><span class="keyword">public</span> TableDataInfo <span class="title function_">listSlave</span><span class="params">(SysOperLog operLog)</span> &#123;</span><br><span class="line">    PageHelper.startPage(operLog);</span><br><span class="line">    List&lt;SysOperLog&gt; list = operLogService.selectOperLogListSlave(operLog);</span><br><span class="line">    <span class="keyword">return</span> getDataTable(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/listFourth&quot;)</span></span><br><span class="line"><span class="keyword">public</span> TableDataInfo <span class="title function_">listFourth</span><span class="params">(SysOperLog operLog)</span> &#123;</span><br><span class="line">    PageHelper.startPage(operLog);</span><br><span class="line">    List&lt;SysOperLog&gt; list = operLogService.selectOperLogListFourth(operLog);</span><br><span class="line">    <span class="keyword">return</span> getDataTable(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@DataSource(DataSourceType.THIRD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysOperLogServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ISysOperLogService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysOperLogMapper operLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询系统操作日志集合</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> operLog 操作日志对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 操作日志集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SysOperLog&gt; <span class="title function_">selectOperLogList</span><span class="params">(SysOperLog operLog)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> operLogMapper.selectOperLogList(operLog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@DataSource(DataSourceType.MASTER)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SysOperLog&gt; <span class="title function_">selectOperLogListMaster</span><span class="params">(SysOperLog operLog)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> operLogMapper.selectOperLogList(operLog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@DataSource(DataSourceType.SLAVE)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SysOperLog&gt; <span class="title function_">selectOperLogListSlave</span><span class="params">(SysOperLog operLog)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> operLogMapper.selectOperLogList(operLog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@DataSource(DataSourceType.FOURTH)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SysOperLog&gt; <span class="title function_">selectOperLogListFourth</span><span class="params">(SysOperLog operLog)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> operLogMapper.selectOperLogList(operLog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二十五、事务"><a href="#二十五、事务" class="headerlink" title="二十五、事务"></a>二十五、事务</h1><h2 id="1-事务"><a href="#1-事务" class="headerlink" title="1.事务"></a>1.事务</h2><ul>
<li>在Boot项目中，倡导使用声明式事务，一句话就是善用如下的注解：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(SysJob job)</span> <span class="keyword">throws</span> SchedulerException</span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">jobId</span> <span class="operator">=</span> job.getJobId();</span><br><span class="line">        <span class="type">String</span> <span class="variable">jobGroup</span> <span class="operator">=</span> job.getJobGroup();</span><br><span class="line">        <span class="type">SysJob</span> <span class="variable">properties</span> <span class="operator">=</span> selectJobById(job.getJobId());</span><br><span class="line">        <span class="comment">// 参数</span></span><br><span class="line">        <span class="type">JobDataMap</span> <span class="variable">dataMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JobDataMap</span>();</span><br><span class="line">        dataMap.put(ScheduleConstants.TASK_PROPERTIES, properties);</span><br><span class="line">        scheduler.triggerJob(ScheduleUtils.getJobKey(jobId, jobGroup), dataMap);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>只要该注解加上，方法中无论有多少个执行SQL的地方，只要执行遇到一个异常，所有的操作都将会回滚。</li>
<li>也就是说，如果说一共要执行四次insert，前面三个都没问题，第四个insert出现了问题，那么前面的三个insert也将会回滚。</li>
</ul>
<h2 id="2-故意回滚例子"><a href="#2-故意回滚例子" class="headerlink" title="2.故意回滚例子"></a>2.故意回滚例子</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RollbackTestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SysOperLogMapper operLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testRollback&quot;)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Anonymous</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SysOperLog</span> <span class="variable">sysOperLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SysOperLog</span>();</span><br><span class="line">        sysOperLog.setOperIp(<span class="string">&quot;localhost!&quot;</span>);</span><br><span class="line">        operLogMapper.insertOperlog(sysOperLog);</span><br><span class="line">        System.out.println(<span class="string">&quot;成功1&quot;</span>);</span><br><span class="line">        operLogMapper.insertOperlog(sysOperLog);</span><br><span class="line">        System.out.println(<span class="string">&quot;成功2&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (count % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;捣蛋&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">        operLogMapper.insertOperlog(sysOperLog);</span><br><span class="line">        System.out.println(<span class="string">&quot;成功3&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>利用apipost多测试几次，发现若抛异常则所有插入都将会失效。</li>
<li>@Transactional注解默认是捕捉运行时异常，如果需要抓更大的异常，可以设置参数：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br></pre></td></tr></table></figure>

<h1 id="二十六、数据权限"><a href="#二十六、数据权限" class="headerlink" title="二十六、数据权限"></a>二十六、数据权限</h1><h2 id="1-数据权限简介"><a href="#1-数据权限简介" class="headerlink" title="1.数据权限简介"></a>1.数据权限简介</h2><ul>
<li>所谓数据权限，就是不同的人对数据的权限不同。</li>
<li>举个例子，一个学校的校长能看到学生管理系统的全部学生的信息，进行管理维护；而一个老师只能维护管理系统中自己班的学生，别的人根本看不到。</li>
<li>说得再确切一点，在QQ中，你的分组只能看到自己的好友，看不到别人的QQ有哪些好友。好友表对于腾讯来说无疑是分库且分表存了起来，我们查询的时候根据我的用户QQ号查询到了属于自己的好友。</li>
<li>一般来说，但凡是一个管理类的系统，都有着数据方面的权限。</li>
<li>我们ry系统也是如此，下面我们分为两步讲解数据权限。</li>
</ul>
<blockquote>
<p>1、先界面化认识一波数据权限，用账号为“ry”的用户登录，权限调低，看看情况。</p>
<p>2、ry的数据权限怎么实现的（debug）分析并认识它。</p>
<p>3、我们自己建立的表如何加上数据权限。</p>
</blockquote>
<h2 id="2-ry中数据权限的实现分析"><a href="#2-ry中数据权限的实现分析" class="headerlink" title="2.ry中数据权限的实现分析"></a>2.ry中数据权限的实现分析</h2><ul>
<li>ry中的数据权限是AOP切入，修改SQL实现的，让SQL中拼接一些关于权限的SQL来实现。</li>
<li>我们在framework模块中可以找到相关的类：类名：DataScopeAspect</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fzx.framework.aspectj;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> com.fzx.common.annotation.DataScope;</span><br><span class="line"><span class="keyword">import</span> com.fzx.common.core.domain.BaseEntity;</span><br><span class="line"><span class="keyword">import</span> com.fzx.common.core.domain.entity.SysRole;</span><br><span class="line"><span class="keyword">import</span> com.fzx.common.core.domain.entity.SysUser;</span><br><span class="line"><span class="keyword">import</span> com.fzx.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.fzx.common.core.text.Convert;</span><br><span class="line"><span class="keyword">import</span> com.fzx.common.utils.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> com.fzx.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.fzx.framework.security.context.PermissionContextHolder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据过滤处理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataScopeAspect</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 全部数据权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATA_SCOPE_ALL</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定数据权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATA_SCOPE_CUSTOM</span> <span class="operator">=</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 部门数据权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATA_SCOPE_DEPT</span> <span class="operator">=</span> <span class="string">&quot;3&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 部门及以下数据权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATA_SCOPE_DEPT_AND_CHILD</span> <span class="operator">=</span> <span class="string">&quot;4&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 仅本人数据权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATA_SCOPE_SELF</span> <span class="operator">=</span> <span class="string">&quot;5&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据权限过滤关键字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATA_SCOPE</span> <span class="operator">=</span> <span class="string">&quot;dataScope&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;@annotation(controllerDataScope)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doBefore</span><span class="params">(JoinPoint point, DataScope controllerDataScope)</span> <span class="keyword">throws</span> Throwable</span><br><span class="line">    &#123;</span><br><span class="line">        clearDataScope(point);</span><br><span class="line">        handleDataScope(point, controllerDataScope);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleDataScope</span><span class="params">(<span class="keyword">final</span> JoinPoint joinPoint, DataScope controllerDataScope)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取当前的用户</span></span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> SecurityUtils.getLoginUser();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(loginUser))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">SysUser</span> <span class="variable">currentUser</span> <span class="operator">=</span> loginUser.getUser();</span><br><span class="line">            <span class="comment">// 如果是超级管理员，则不过滤数据</span></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotNull(currentUser) &amp;&amp; !currentUser.isAdmin())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">permission</span> <span class="operator">=</span> StringUtils.defaultIfEmpty(controllerDataScope.permission(), PermissionContextHolder.getContext());</span><br><span class="line">                dataScopeFilter(joinPoint, currentUser, controllerDataScope.deptAlias(),</span><br><span class="line">                        controllerDataScope.userAlias(), permission);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据范围过滤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint 切点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> deptAlias 部门别名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userAlias 用户别名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> permission 权限字符</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dataScopeFilter</span><span class="params">(JoinPoint joinPoint, SysUser user, String deptAlias, String userAlias, String permission)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sqlString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        List&lt;String&gt; conditions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (SysRole role : user.getRoles())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">dataScope</span> <span class="operator">=</span> role.getDataScope();</span><br><span class="line">            <span class="keyword">if</span> (!DATA_SCOPE_CUSTOM.equals(dataScope) &amp;&amp; conditions.contains(dataScope))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotEmpty(permission) &amp;&amp; StringUtils.isNotEmpty(role.getPermissions())</span><br><span class="line">                    &amp;&amp; !StringUtils.containsAny(role.getPermissions(), Convert.toStrArray(permission)))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DATA_SCOPE_ALL.equals(dataScope))</span><br><span class="line">            &#123;</span><br><span class="line">                sqlString = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                conditions.add(dataScope);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (DATA_SCOPE_CUSTOM.equals(dataScope))</span><br><span class="line">            &#123;</span><br><span class="line">                sqlString.append(StringUtils.format(</span><br><span class="line">                        <span class="string">&quot; OR &#123;&#125;.dept_id IN ( SELECT dept_id FROM sys_role_dept WHERE role_id = &#123;&#125; ) &quot;</span>, deptAlias,</span><br><span class="line">                        role.getRoleId()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (DATA_SCOPE_DEPT.equals(dataScope))</span><br><span class="line">            &#123;</span><br><span class="line">                sqlString.append(StringUtils.format(<span class="string">&quot; OR &#123;&#125;.dept_id = &#123;&#125; &quot;</span>, deptAlias, user.getDeptId()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (DATA_SCOPE_DEPT_AND_CHILD.equals(dataScope))</span><br><span class="line">            &#123;</span><br><span class="line">                sqlString.append(StringUtils.format(</span><br><span class="line">                        <span class="string">&quot; OR &#123;&#125;.dept_id IN ( SELECT dept_id FROM sys_dept WHERE dept_id = &#123;&#125; or find_in_set( &#123;&#125; , ancestors ) )&quot;</span>,</span><br><span class="line">                        deptAlias, user.getDeptId(), user.getDeptId()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (DATA_SCOPE_SELF.equals(dataScope))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(userAlias))</span><br><span class="line">                &#123;</span><br><span class="line">                    sqlString.append(StringUtils.format(<span class="string">&quot; OR &#123;&#125;.user_id = &#123;&#125; &quot;</span>, userAlias, user.getUserId()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 数据权限为仅本人且没有userAlias别名不查询任何数据</span></span><br><span class="line">                    sqlString.append(StringUtils.format(<span class="string">&quot; OR &#123;&#125;.dept_id = 0 &quot;</span>, deptAlias));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            conditions.add(dataScope);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 多角色情况下，所有角色都不包含传递过来的权限字符，这个时候sqlString也会为空，所以要限制一下,不查询任何数据</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(conditions))</span><br><span class="line">        &#123;</span><br><span class="line">            sqlString.append(StringUtils.format(<span class="string">&quot; OR &#123;&#125;.dept_id = 0 &quot;</span>, deptAlias));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(sqlString.toString()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">params</span> <span class="operator">=</span> joinPoint.getArgs()[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotNull(params) &amp;&amp; params <span class="keyword">instanceof</span> BaseEntity)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">BaseEntity</span> <span class="variable">baseEntity</span> <span class="operator">=</span> (BaseEntity) params;</span><br><span class="line">                baseEntity.getParams().put(DATA_SCOPE, <span class="string">&quot; AND (&quot;</span> + sqlString.substring(<span class="number">4</span>) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼接权限sql前先清空params.dataScope参数防止注入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">clearDataScope</span><span class="params">(<span class="keyword">final</span> JoinPoint joinPoint)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">params</span> <span class="operator">=</span> joinPoint.getArgs()[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(params) &amp;&amp; params <span class="keyword">instanceof</span> BaseEntity)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">BaseEntity</span> <span class="variable">baseEntity</span> <span class="operator">=</span> (BaseEntity) params;</span><br><span class="line">            baseEntity.getParams().put(DATA_SCOPE, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>@Before代表前置切。在方法执行之前切入。简称切前排。</li>
<li>MySQL的find_in_set。这个小函数在MySQL中耐人寻味，通过下面的测试我们具体看看即可。</li>
</ul>
<p>部门数据库：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261648665.png"
                      alt="图片"
                ></p>
<p>若干查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  dept_id ,ancestors</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  sys_dept </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">  dept_id <span class="operator">=</span> <span class="number">101</span> </span><br><span class="line">  <span class="keyword">OR</span> find_in_set(<span class="number">101</span>,ancestors );    <span class="comment">/*  查询101以及101的孩子们，ancestors字段为当前节点的祖先节点。  */</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">select</span>  find_in_set(<span class="number">101</span>,<span class="string">&#x27;0,100&#x27;</span> );   <span class="comment">/*  返回0  因为101不是 0，100俩节点 的孩子 的祖先   */</span></span><br><span class="line">  <span class="keyword">select</span>  find_in_set(<span class="number">101</span>,<span class="string">&#x27;0,100,101&#x27;</span> ); <span class="comment">/* 返回3 101 是 0，100，101 的孩子 的祖先  */</span></span><br><span class="line"> </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">select</span>  find_in_set(<span class="number">101</span>,<span class="string">&#x27;0,100,102&#x27;</span> );<span class="comment">/*  返回0  因为101不是 0，100俩节点的孩子 的祖先    */</span></span><br></pre></td></tr></table></figure>

<ul>
<li>用户可以具有多个角色，但是<strong>如果任意一个角色的数据权限是全部数据权限的时候</strong>，直接new 一个StringBuilder，也就是直接把已经拼成的sql直接清空并且break。</li>
<li>如果<strong>用户的每一个角色的权限都不是全部数据权限时候</strong>，那么是多个sql进行用OR连接，说明是多个数据查询结果取并集，类似OR….OR…..OR，并且在最后的时候会把第一个OR替换成 AND 并且把后面整个结果用括号括起来。</li>
<li><strong>当数据权限为仅仅自己的时候</strong>，有一个特殊的注意点，就是当用户表别名没有指定的时候，sql会拼接OR user_id &#x3D; 0，要知道，数据表可没有0号用户，所以不会查询任何的数据。但是是OR，所以如果用户不只一个角色，那么其他角色的数据还是可以照常查询出来的。相关源码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (DATA_SCOPE_SELF.equals(dataScope))</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">if</span> (StringUtils.isNotBlank(userAlias))</span><br><span class="line">           &#123;</span><br><span class="line">               sqlString.append(StringUtils.format(<span class="string">&quot; OR &#123;&#125;.user_id = &#123;&#125; &quot;</span>, userAlias, user.getUserId()));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="comment">// 数据权限为仅本人且没有userAlias别名不查询任何数据</span></span><br><span class="line">               sqlString.append(StringUtils.format(<span class="string">&quot; OR &#123;&#125;.dept_id = 0 &quot;</span>, deptAlias));</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-自己所建立的表实现数据权限控制"><a href="#3-自己所建立的表实现数据权限控制" class="headerlink" title="3.自己所建立的表实现数据权限控制"></a>3.自己所建立的表实现数据权限控制</h2><ul>
<li>首先随便建立一个表，注意，表字段必须有user_id，不然怎么和用户关联，不和用户表关联谈什么数据权限？</li>
<li>比如说，有这样一个需求，作为一个高校的研究生，有可能要每周收青年大学习的截图。那么我现在需要学生自己去我的网站上面上传截图，并且用户自己只能看到自己上传的截图，但是管理员可以看到所有的截图。这样一个需求，我们马上安排。</li>
<li>建立表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ruoyi<span class="operator">-</span>vue`.`picture`  (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `URI` <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;若干图片URI&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;关联用户user_id&#x27;</span>,</span><br><span class="line">  `create_by` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_by` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `remark` <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;备注&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>建表完毕之后进行生成代码：生成完毕之后，把代码放进对应的地方</li>
<li>这个时候，利用利用不同的两个用户，例如用户名为“ry”的和用户名为“qq4206359”的用户进行上传自己的图片：</li>
<li>发现这俩人竟然可以看到别人的图片。不过呢，此时普通角色还是部门以及部门以下的数据可以看到，我们现在需要改成仅自己：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261711835.png"
                      alt="图片"
                ></p>
<ul>
<li>发现这俩小子还是可以看到对方的图片，是因为我们还没有开始写数据权限的相关代码。</li>
<li><strong>开始手动编码：</strong>首先要填充user_id，不然谈什么数据权限？填充之前表里面这么显示的</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261712234.png"
                      alt="图片"
                ></p>
<ul>
<li>编码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增测试数据权限</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> picture 测试数据权限</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insertPicture</span><span class="params">(Picture picture)</span></span><br><span class="line">&#123;</span><br><span class="line">        picture.setCreateTime(DateUtils.getNowDate());</span><br><span class="line">        picture.setCreateBy(SecurityUtils.getUsername());</span><br><span class="line">        picture.setUserId(SecurityUtils.getUserId());</span><br><span class="line">        <span class="keyword">return</span> pictureMapper.insertPicture(picture);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如此，现在就有user_id了，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261714071.png"
                      alt="图片"
                ></p>
<ul>
<li>现在，终于可以开始改SQL了，该查询SQL：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectPictureList&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Picture&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;PictureResult&quot;</span>&gt;</span></span><br><span class="line">       select</span><br><span class="line">           id, URI, user_id, create_by, create_time, update_by, update_time, remark</span><br><span class="line">       from</span><br><span class="line">           picture p</span><br><span class="line">       left join sys_user u on p.user_id=u.user_id</span><br><span class="line">       left join sys_dept d on d.dept_id=u.dept_id</span><br><span class="line">       <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;uri != null  and uri != &#x27;&#x27;&quot;</span>&gt;</span> and URI = #&#123;uri&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null &quot;</span>&gt;</span> and user_id = #&#123;userId&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           $&#123;params.dataScope&#125;</span><br><span class="line">       <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后加上注解：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查询测试数据权限列表</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> picture 测试数据权限</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 测试数据权限</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@DataScope(deptAlias = &quot;d&quot;, userAlias = &quot;u&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> List&lt;Picture&gt; <span class="title function_">selectPictureList</span><span class="params">(Picture picture)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> pictureMapper.selectPictureList(picture);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后报错</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306261725100.png"
                      alt="图片"
                ></p>
<ul>
<li>这个错误的意思是user_id是模棱两可的，他不知道是哪一个user_id，我们手动指定一波，是p的user_id：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectPictureList&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Picture&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;PictureResult&quot;</span>&gt;</span></span><br><span class="line">      select</span><br><span class="line">          p.id, p.URI, p.user_id, p.create_by, p.create_time, p.update_by, p.update_time, p.remark</span><br><span class="line">      from</span><br><span class="line">          picture p</span><br><span class="line">      left join sys_user u on p.user_id=u.user_id</span><br><span class="line">      left join sys_dept d on d.dept_id=u.dept_id</span><br><span class="line">      <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;uri != null  and uri != &#x27;&#x27;&quot;</span>&gt;</span> and URI = #&#123;uri&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null &quot;</span>&gt;</span> and p.user_id = #&#123;userId&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">          $&#123;params.dataScope&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>此外，发现新增用户的时候竟然让我们输入userId，这应该是后端自己读当前用户，应该在前端把相关文本框给删掉。</li>
</ul>
<blockquote>
<p><strong>总结：数据权限无非就是在自己的表里面添加user_id字段，然后左连接用户表，再左连接部门表即可。如此，数据权限的AOP相关切面就可以把SQL加上dept_id&#x3D;xxxx，user_id&#x3D;xxxx，就成功让数据根据情况显示了。</strong></p>
<p><strong>最后别忘了在要实现数据权限的方法加上@DataScope注解哦！</strong></p>
</blockquote>
<h1 id="二十七、代码生成使用"><a href="#二十七、代码生成使用" class="headerlink" title="二十七、代码生成使用"></a>二十七、代码生成使用</h1><h2 id="1-代码生成（单表）"><a href="#1-代码生成（单表）" class="headerlink" title="1.代码生成（单表）"></a>1.代码生成（单表）</h2><ul>
<li>我们常常写一些表的CURD，然而这些代码往往都基本是一样的，总是去重复写，浪费生命。于是有了生成代码，帮助我们生成朴素的增删改查代码以及基本的UI页面。</li>
<li>生成代码可以快速帮助我们生成如下内容：</li>
</ul>
<blockquote>
<p>1、关于表的Controller、Service（接口和实现类）、Mapper接口、Mapper.xml。</p>
<p>2、SQL，该SQL用于在数据库增加菜单（页面权限），以及相关的按钮权限。</p>
<p>3、.vue文件，也就是前端的基础UI。</p>
<p>4、前端的api接口文件，用于访问后端的controller中所有的接口。</p>
</blockquote>
<ul>
<li>以上所有的内容组合起来实现了下面的方法：</li>
</ul>
<blockquote>
<p>1、分页查询所有数据。</p>
<p>2、导出数据的Excel表。</p>
<p>3、根据ID获得单条数据。</p>
<p>4、根据ID修改单条数据。</p>
<p>5、根据ID删除单条数据或批量删除。</p>
</blockquote>
<h3 id="第一步，建立数据表："><a href="#第一步，建立数据表：" class="headerlink" title="第一步，建立数据表："></a>第一步，建立数据表：</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ruoyi<span class="operator">-</span>vue`.`testSingle`  (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;编号&#x27;</span>,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `pwd` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">  `sex` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">  `telephone` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;电话&#x27;</span>,</span><br><span class="line">  `email` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">  `brithday` <span class="type">date</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;生日&#x27;</span>,</span><br><span class="line">  `avatar` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;头像&#x27;</span>,</span><br><span class="line">  `description` longblob <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;描述&#x27;</span>,</span><br><span class="line">  `from_province` <span class="type">char</span>(<span class="number">2</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;来自省份&#x27;</span>,</span><br><span class="line">  `del_flag` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;逻辑删除标志&#x27;</span>,</span><br><span class="line">  `status` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;状态&#x27;</span>,</span><br><span class="line">  `create_by` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建者&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_by` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新者&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `remark` <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;备注&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="第二步，新建省份字典（自有妙用）："><a href="#第二步，新建省份字典（自有妙用）：" class="headerlink" title="第二步，新建省份字典（自有妙用）："></a>第二步，新建省份字典（自有妙用）：</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306270913918.png"
                      alt="图片"
                ></p>
<p>给字典添加一系列值：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306270913095.png"
                      alt="图片"
                ></p>
<h3 id="第三步，填写生成信息："><a href="#第三步，填写生成信息：" class="headerlink" title="第三步，填写生成信息："></a>第三步，填写生成信息：</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306270918483.png"
                      alt="图片"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306270918415.png"
                      alt="图片"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306270918031.png"
                      alt="图片"
                ></p>
<h3 id="第四步，把成功生成的代码放到对应的位置。"><a href="#第四步，把成功生成的代码放到对应的位置。" class="headerlink" title="第四步，把成功生成的代码放到对应的位置。"></a>第四步，把成功生成的代码放到对应的位置。</h3><blockquote>
<p>补充单表内容：</p>
<p>1、数据库中，字典是存储的value，存储的1，2，3这些。</p>
<p>2、create_by和update_by没有自动生成相关代码，也要我们手动补充上。</p>
</blockquote>
<h2 id="2-树表生成"><a href="#2-树表生成" class="headerlink" title="2.树表生成"></a>2.树表生成</h2><blockquote>
<p>树表，即有一个字段为parent_id（不一定叫这个名字）的表，假设名字为test1表，parent_id值为test1表中某个数据的主键ID。</p>
</blockquote>
<h3 id="第一步，建立数据库："><a href="#第一步，建立数据库：" class="headerlink" title="第一步，建立数据库："></a>第一步，建立数据库：</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `testTree`  (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;编号&#x27;</span>,</span><br><span class="line">  `parent_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;父编号&#x27;</span>,</span><br><span class="line">  `node_name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;节点名称&#x27;</span>,</span><br><span class="line">  `content` longblob <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;内容&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>node_name为节点名字，树的节点名，后续一些地方会用到，一定得有。</li>
</ul>
<p>第二步，生成代码相关配置</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271009276.png"
                      alt="图片"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271010183.png"
                      alt="图片"
                ></p>
<h3 id="第三步，生成并放入合适位置："><a href="#第三步，生成并放入合适位置：" class="headerlink" title="第三步，生成并放入合适位置："></a>第三步，生成并放入合适位置：</h3><ul>
<li>生成后的页面样子：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271011418.png"
                      alt="图片"
                ></p>
<h2 id="3-代码生成使用（主子表）"><a href="#3-代码生成使用（主子表）" class="headerlink" title="3.代码生成使用（主子表）"></a>3.代码生成使用（主子表）</h2><ul>
<li>什么叫主子表？</li>
</ul>
<blockquote>
<p>例如有订单表order，字段有id，order_price。表订单明细表order_item，字段有id，good，price，num，order_id。</p>
<p>表order_item里面的order_id存的数据对应的是表order中的某一行的主键，在表order_item表中order_id叫外键。</p>
<p>如果有此种关系，则称为主子表。</p>
</blockquote>
<p>第一步，建立数据表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ruoyi<span class="operator">-</span>vue`.`table_main`  (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;订单编号&#x27;</span>,</span><br><span class="line">  `order_price` <span class="type">decimal</span>(<span class="number">20</span>, <span class="number">2</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单金额&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">)</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 我们就不去刻意加上外键约束了。</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 请同学们一个<span class="keyword">SQL</span> 一个<span class="keyword">SQL</span>的运行，不然可能报错。</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ruoyi<span class="operator">-</span>vue`.`table_slave`  (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;订单项编号&#x27;</span>,</span><br><span class="line">  `good` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品&#x27;</span>,</span><br><span class="line">  `price` <span class="type">decimal</span>(<span class="number">20</span>, <span class="number">2</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;单价&#x27;</span>,</span><br><span class="line">  `num` <span class="type">int</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;数量&#x27;</span>,</span><br><span class="line">  `order_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单编号&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>第二步，配置页面</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271016427.png"
                      alt="图片"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271016145.png"
                      alt="图片"
                ></p>
<p>第三步，下载代码放入相应位置，测试。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271019349.png"
                      alt="图片"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271020948.png"
                      alt="图片"
                ></p>
<h1 id="二十六、服务监控"><a href="#二十六、服务监控" class="headerlink" title="二十六、服务监控"></a>二十六、服务监控</h1><h2 id="1-服务监控后端"><a href="#1-服务监控后端" class="headerlink" title="1.服务监控后端"></a>1.服务监控后端</h2><ul>
<li>从服务监控的前端展示看到，有CPU信息、内存信息、服务器信息、Java虚拟机信息和磁盘信息。</li>
<li>所以我们现在来简单debug看看这些信息怎么获取的，不用去记，这些东西都是要获取得时候随时去查怎么获得。获取的API后封装成了Server对象，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271033269.png"
                      alt="图片"
                ></p>
<h2 id="2-Vue生命周期"><a href="#2-Vue生命周期" class="headerlink" title="2.Vue生命周期"></a>2.Vue生命周期</h2><ul>
<li>下面是尚硅谷的老师总结的一张图，是生命周期的解释。诸如created、mounted两个钩子需要着重注意一下。</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271034898.png"
                      alt="图片"
                ></p>
<blockquote>
<p>生命周期：<br>1.又名：生命周期回调函数、生命周期函数、生命周期钩子。<br>2.是什么：Vue在关键时刻帮我们调用的一些特殊名称的函数。<br>3.生命周期函数的名字不可更改，但函数的具体内容是程序员根据需求编写的。<br>4.生命周期函数中的this指向是vm 或 组件实例对象。</p>
</blockquote>
<ul>
<li>如果不太熟悉Vue的生命周期，最起码要知道组件的created钩子和mounted钩子会自动执行，并且created在先，mounted在后。</li>
</ul>
<h2 id="3-服务监控前端"><a href="#3-服务监控前端" class="headerlink" title="3.服务监控前端"></a>3.服务监控前端</h2><h3 id="1-loading"><a href="#1-loading" class="headerlink" title="1.loading"></a>1.loading</h3><ul>
<li>前端当我们一进入页面会有一个loading。大家是否还记得loading怎么实现的？</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">$modal</span>.<span class="title function_">loading</span>(<span class="string">&quot;正在加载服务监控数据，请稍候！&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>可能有小伙伴问，为啥先getList，后loading的，为啥loading还能走到？<strong>因为getList里面有Promise的异步请求操作</strong>。异步不会阻塞。此外，getList方法的接口还睡了一秒钟，所以正常来说getList后执行完毕。</li>
</ul>
<h3 id="2-栅格（重点）"><a href="#2-栅格（重点）" class="headerlink" title="2.栅格（重点）"></a>2.栅格（重点）</h3><ul>
<li>我们来看ry的服务监控页面，发现我们改变宽度，CPU信息一直占1&#x2F;2，内存一直占1&#x2F;2，为什么呢？这就要引入我们即将学习的栅格。</li>
<li>什么是栅格？栅格是一种布局方式。<a class="link"   target="_blank" rel="noopener" href="https://element.eleme.cn/#/zh-CN/component/layout" >https://element.eleme.cn/#/zh-CN/component/layout<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<h1 id="二十七、常见文件的在线预览"><a href="#二十七、常见文件的在线预览" class="headerlink" title="二十七、常见文件的在线预览"></a>二十七、常见文件的在线预览</h1><h2 id="1-简介-1"><a href="#1-简介-1" class="headerlink" title="1.简介"></a>1.简介</h2><ul>
<li><p>我们现在将要说的是，常见文件的在线预览。具体是什么文件呢？Word，Excel，PDF。</p>
<p>也就是后缀为docx，xlsx，pptx的文件。</p>
</li>
</ul>
<h2 id="2-在线预览docx文件（Word）"><a href="#2-在线预览docx文件（Word）" class="headerlink" title="2.在线预览docx文件（Word）"></a>2.在线预览docx文件（Word）</h2><h3 id="1-在线预览docx文件（Word）"><a href="#1-在线预览docx文件（Word）" class="headerlink" title="1.在线预览docx文件（Word）"></a>1.在线预览docx文件（Word）</h3><ul>
<li>第一步：引依赖，如下。</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i docx-preview</span><br></pre></td></tr></table></figure>

<ul>
<li>第二步：写API，用于请求docx文件。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;@/utils/request&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询测试图片上传列表</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getWord</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: url,</span><br><span class="line">    <span class="attr">responseType</span>: <span class="string">&#x27;blob&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第三步：写.vue文件，如下。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;docWrapAndRoll&quot;&gt;</span><br><span class="line">    &lt;div ref=&quot;file&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;getWord&#125; from &quot;@/api/gzh/online&quot;;</span><br><span class="line"></span><br><span class="line">const docx = require(&#x27;docx-preview&#x27;);</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;testWord&quot;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    getWord(&#x27;http://wangqingjiang.top/prod-api/profile/upload/2022/09/26/2017015222-%E6%96%B9%E6%81%92_20220926195700A002.docx&#x27;)</span><br><span class="line">      .then((data) =&gt; &#123;</span><br><span class="line">        docx.renderAsync(data, this.$refs.file)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.docWrapAndRoll &#123;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>第四步：写路由。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">path</span>: <span class="string">&#x27;/testWord&#x27;</span>,</span><br><span class="line">   <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/testWord&#x27;</span>),</span><br><span class="line">   <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>第五步：前端放行。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> whiteList = [<span class="string">&#x27;/login&#x27;</span>, <span class="string">&quot;/callback&quot;</span>, <span class="string">&#x27;/auth-redirect&#x27;</span>, <span class="string">&#x27;/bind&#x27;</span>, <span class="string">&#x27;/register&#x27;</span>, <span class="string">&#x27;/testWord&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>注意：能展示docx，不能读doc。大家不要把doc和docx混淆。doc是老版本，docx是新版本。</li>
</ul>
<h3 id="2-高端预览（URL写活）"><a href="#2-高端预览（URL写活）" class="headerlink" title="2.高端预览（URL写活）"></a>2.高端预览（URL写活）</h3><ul>
<li>我们只需要在进入页面的时候，传入URL放在query中即可。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;docWrapAndRoll&quot;&gt;</span><br><span class="line">    &lt;div ref=&quot;file&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;getWord&#125; from &quot;@/api/gzh/online&quot;;</span><br><span class="line"></span><br><span class="line">const docx = require(&#x27;docx-preview&#x27;);</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;testWord&quot;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    console.log();</span><br><span class="line">    if (this.$route.query.url == null || this.$route.query.url === &#x27;&#x27;) &#123;</span><br><span class="line">      this.$message.error(&quot;请传入URL！！&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    getWord(this.$route.query.url)</span><br><span class="line">      .then((data) =&gt; &#123;</span><br><span class="line">        docx.renderAsync(data, this.$refs.file)</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(e =&gt; &#123;</span><br><span class="line">        this.$message.error(&quot;URL存在问题，请检查！&quot;)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.docWrapAndRoll &#123;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3-在线预览xlsx文件（Excel）"><a href="#3-在线预览xlsx文件（Excel）" class="headerlink" title="3.在线预览xlsx文件（Excel）"></a>3.在线预览xlsx文件（Excel）</h2><h3 id="1-有点丑的实现方式"><a href="#1-有点丑的实现方式" class="headerlink" title="1.有点丑的实现方式"></a>1.有点丑的实现方式</h3><ul>
<li>第一步：引入依赖，如下：</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i xlsx</span><br></pre></td></tr></table></figure>

<ul>
<li>第二步：写得到xlsx的API：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getExcel</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: url,</span><br><span class="line">    <span class="attr">responseType</span>: <span class="string">&#x27;arraybuffer&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第三步：写.vue文件：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;home&quot;&gt;</span><br><span class="line">    &lt;div v-html=&quot;myTable&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;getExcel&#125; from &quot;@/api/gzh/online&quot;;</span><br><span class="line">import * as xlsx from &quot;xlsx&quot;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;testExcel&quot;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      myTable: undefined</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    getExcel(&#x27;http://wangqingjiang.top/prod-api/profile/upload/2022/09/26/%E5%A7%8B%E5%85%B4%E4%B8%9A%E5%8A%A18%E6%9C%88%E6%8E%A5%E5%8D%95_20220926204400A003.xlsx&#x27;)</span><br><span class="line">      .then((data) =&gt; &#123;</span><br><span class="line">        const workbook = xlsx.read(new Uint8Array(data), &#123;type: &quot;array&quot;&#125;); </span><br><span class="line">        const worksheet = workbook.Sheets[workbook.SheetNames[0]]; </span><br><span class="line">        this.myTable = xlsx.utils.sheet_to_html(worksheet); </span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.home &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>第四步：路由</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">path</span>: <span class="string">&#x27;/testExcel&#x27;</span>,</span><br><span class="line">   <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/testExcel&#x27;</span>),</span><br><span class="line">   <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>第五步：前端白名单放行：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> whiteList = [<span class="string">&#x27;/login&#x27;</span>, <span class="string">&quot;/callback&quot;</span>, <span class="string">&#x27;/auth-redirect&#x27;</span>, <span class="string">&#x27;/bind&#x27;</span>, <span class="string">&#x27;/register&#x27;</span>, <span class="string">&#x27;/testWord&#x27;</span>,<span class="string">&#x27;/testExcel&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="2-好看一点的实现方式"><a href="#2-好看一点的实现方式" class="headerlink" title="2.好看一点的实现方式"></a>2.好看一点的实现方式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;home&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;wait&quot;</span><br><span class="line">         v-if=&quot;excelData.length===0&quot;&gt;</span><br><span class="line">      渲染中，请等待！</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;el-table v-else :data=&quot;excelData&quot; style=&quot;width:100%&quot;&gt;</span><br><span class="line">      &lt;el-table-column</span><br><span class="line">        v-for=&quot;(value, key, index) in excelData[2]&quot;</span><br><span class="line">        :key=&quot;index&quot;</span><br><span class="line">        :prop=&quot;key&quot;</span><br><span class="line">        :label=&quot;key&quot;</span><br><span class="line">      &gt;</span><br><span class="line">      &lt;/el-table-column&gt;</span><br><span class="line">    &lt;/el-table&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;getExcel&#125; from &quot;@/api/gzh/online&quot;;</span><br><span class="line">import * as xlsx from &quot;xlsx&quot;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;testExcel&quot;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      excelData: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    getExcel(&#x27;http://wangqingjiang.top/prod-api/profile/upload/2022/09/26/%E5%A7%8B%E5%85%B4%E4%B8%9A%E5%8A%A18%E6%9C%88%E6%8E%A5%E5%8D%95_20220926204400A003.xlsx&#x27;)</span><br><span class="line">      .then((data) =&gt; &#123;</span><br><span class="line">        const workbook = xlsx.read(new Uint8Array(data), &#123;type: &quot;array&quot;&#125;);</span><br><span class="line">        const worksheet = workbook.Sheets[workbook.SheetNames[0]];</span><br><span class="line">        this.excelData = xlsx.utils.sheet_to_json(worksheet);</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.home &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.wait &#123;</span><br><span class="line">  width: 100%;</span><br><span class="line">  font-size: 120px;</span><br><span class="line">  color: red;</span><br><span class="line">  height: 100%;</span><br><span class="line">  text-align: center;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-在线预览PDF文件"><a href="#4-在线预览PDF文件" class="headerlink" title="4.在线预览PDF文件"></a>4.在线预览PDF文件</h2><ul>
<li>第一步：安装依赖：</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install vue-pdf</span><br></pre></td></tr></table></figure>

<ul>
<li>第二步：写.vue文件：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;div class=&quot;tools&quot;&gt;</span><br><span class="line">      &lt;el-button :theme=&quot;&#x27;default&#x27;&quot; type=&quot;submit&quot; :title=&quot;&#x27;上一页&#x27;&quot; @click.stop=&quot;prePage&quot; class=&quot;mr10&quot;&gt; 上一页&lt;/el-button&gt;</span><br><span class="line">      &lt;el-button :theme=&quot;&#x27;default&#x27;&quot; type=&quot;submit&quot; :title=&quot;&#x27;下一页&#x27;&quot; @click.stop=&quot;nextPage&quot; class=&quot;mr10&quot;&gt; 下一页&lt;/el-button&gt;</span><br><span class="line">      &lt;div class=&quot;page&quot;&gt;&#123;&#123; pageNum &#125;&#125;/&#123;&#123; pageTotalNum &#125;&#125;&lt;/div&gt;</span><br><span class="line">      &lt;el-button :theme=&quot;&#x27;default&#x27;&quot; type=&quot;submit&quot; :title=&quot;&#x27;顺时针旋转&#x27;&quot; @click.stop=&quot;clock&quot; class=&quot;mr10&quot;&gt; 顺时针旋转&lt;/el-button&gt;</span><br><span class="line">      &lt;el-button :theme=&quot;&#x27;default&#x27;&quot; type=&quot;submit&quot; :title=&quot;&#x27;逆时针旋转&#x27;&quot; @click.stop=&quot;counterClock&quot; class=&quot;mr10&quot;&gt; 逆时针旋转</span><br><span class="line">      &lt;/el-button&gt;</span><br><span class="line">      &lt;el-button :theme=&quot;&#x27;default&#x27;&quot; type=&quot;submit&quot; :title=&quot;&#x27;打印&#x27;&quot; @click.stop =&quot;pdfPrintAll&quot; class=&quot;mr10&quot;&gt; 打印&lt;/el-button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;PDF ref=&quot;pdf&quot; :src=&quot;url&quot; :page=&quot;pageNum&quot; :rotate=&quot;pageRotate&quot; @progress=&quot;loadedRatio = $event&quot;</span><br><span class="line">         @page-loaded=&quot;pageLoaded($event)&quot;</span><br><span class="line">         @num-pages=&quot;pageTotalNum=$event&quot; @error=&quot;pdfError($event)&quot; @link-clicked=&quot;page = $event&quot;&gt;</span><br><span class="line">    &lt;/PDF&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import PDF from &#x27;vue-pdf&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;testPPT&quot;,</span><br><span class="line">  components: &#123;</span><br><span class="line">    PDF</span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      page: null,</span><br><span class="line">      previewDialog: false,</span><br><span class="line">      url: &quot;http://wangqingjiang.top/prod-api/profile/upload/2022/09/26/%E5%B0%9A%E7%A1%85%E8%B0%B7_%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF_Vue%E5%85%A8%E5%AE%B6%E6%A1%B6_20220926214043A004.pdf&quot;,</span><br><span class="line">      pageNum: 1,</span><br><span class="line">      pageTotalNum: 1,</span><br><span class="line">      pageRotate: 0,</span><br><span class="line">      // 加载进度</span><br><span class="line">      loadedRatio: 0,</span><br><span class="line">      curPageNum: 0,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 预览PDF</span><br><span class="line">     */</span><br><span class="line">    previewPDF(row, index) &#123;</span><br><span class="line">      this.previewDialog = true;</span><br><span class="line">      console.log(&quot;&quot;, row, index);</span><br><span class="line">    &#125;,</span><br><span class="line">    // 上一页函数，</span><br><span class="line">    prePage() &#123;</span><br><span class="line">      console.log(this.page)</span><br><span class="line">      var page = this.pageNum</span><br><span class="line">      page = page &gt; 1 ? page - 1 : this.pageTotalNum</span><br><span class="line">      this.pageNum = page</span><br><span class="line">    &#125;,</span><br><span class="line">    // 下一页函数</span><br><span class="line">    nextPage() &#123;</span><br><span class="line">      var page = this.pageNum</span><br><span class="line">      page = page &lt; this.pageTotalNum ? page + 1 : 1</span><br><span class="line">      this.pageNum = page</span><br><span class="line">    &#125;,</span><br><span class="line">    // 页面顺时针翻转90度。</span><br><span class="line">    clock() &#123;</span><br><span class="line">      this.pageRotate += 90</span><br><span class="line">    &#125;,</span><br><span class="line">    // 页面逆时针翻转90度。</span><br><span class="line">    counterClock() &#123;</span><br><span class="line">      this.pageRotate -= 90</span><br><span class="line">    &#125;,</span><br><span class="line">    // 页面加载回调函数，其中e为当前页数</span><br><span class="line">    pageLoaded(e) &#123;</span><br><span class="line">      this.curPageNum = e</span><br><span class="line">    &#125;,</span><br><span class="line">    // 错误时回调函数。</span><br><span class="line">    pdfError(error) &#123;</span><br><span class="line">      console.error(error)</span><br><span class="line">    &#125;,</span><br><span class="line">    // 打印全部</span><br><span class="line">    pdfPrintAll() &#123;</span><br><span class="line">      /**</span><br><span class="line">       * 打印界面字符乱码是因为你pdf中使用了自定义字体导致的,谷歌浏览器打印的时候预览界面真的变成了真·方块字 ,解决方案如下：</span><br><span class="line">       * 用文章最后的pdfjsWrapper.js在替换掉node_modules/vue-pdf/src/pdfjsWrapper.js</span><br><span class="line">       */</span><br><span class="line">      console.log(&quot;打印&quot;);</span><br><span class="line">      this.$refs.pdf.print()</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>第三步：写路由：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/testPPT&#x27;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/testPPT&#x27;</span>),</span><br><span class="line">  <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>第四步：白名单放行：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> whiteList = [<span class="string">&#x27;/login&#x27;</span>, <span class="string">&quot;/callback&quot;</span>, <span class="string">&#x27;/auth-redirect&#x27;</span>, <span class="string">&#x27;/bind&#x27;</span>, <span class="string">&#x27;/register&#x27;</span>, <span class="string">&#x27;/testWord&#x27;</span>, <span class="string">&#x27;/testExcel&#x27;</span>, <span class="string">&#x27;/testPPT&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="5-扩展阅读"><a href="#5-扩展阅读" class="headerlink" title="5.扩展阅读"></a>5.扩展阅读</h2><blockquote>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.jb51.net/article/249098.htm" >https://www.jb51.net/article/249098.htm<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<h1 id="二十八、系统接口Swagger"><a href="#二十八、系统接口Swagger" class="headerlink" title="二十八、系统接口Swagger"></a>二十八、系统接口Swagger</h1><ul>
<li>发现其实它相当于是一个内嵌的postman，让我们前端开发人员更方便了。</li>
</ul>
<blockquote>
<p>在现在的开发过程中还有很大一部分公司都是以口口相传的方式来进行前后端的联调，而接口文档很大一部分都只停留在了说说而已的地步，或者写了代码再写文档。还有一点就是文档的修改，定义好的接口并不是一成不变的，可能在开发过程中文档修改不止一次的变化，这个时候就会很难受了。只要不是强制性要求，没人会愿意写这东西，而且在写的过程中，一个字母的错误就会导致联调时候的很大麻烦，但是通过Swagger，我们可以省略了这一步，而且文档出错率近乎于零，只要你在写代码的时候，稍加几个注解，文档自动生成。</p>
</blockquote>
<ul>
<li>那么，如果说我的项目要使用Swagger，需要做什么呢？</li>
</ul>
<h2 id="1-Swagger"><a href="#1-Swagger" class="headerlink" title="1.Swagger"></a>1.Swagger</h2><h3 id="第一步需要引入依赖："><a href="#第一步需要引入依赖：" class="headerlink" title="第一步需要引入依赖："></a>第一步需要引入依赖：</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- swagger3--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- 防止进入swagger页面报类型转换错误，排除3.0.0中的引用，手动增加1.6.2版本 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-models<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="第二步需要填写配置："><a href="#第二步需要填写配置：" class="headerlink" title="第二步需要填写配置："></a>第二步需要填写配置：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Swagger2的接口配置</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/** 系统基础配置 */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RuoYiConfig ruoyiConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 是否开启swagger */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;swagger.enabled&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 设置请求的统一前缀 */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;swagger.pathMapping&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String pathMapping;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建API</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">createRestApi</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.OAS_30)</span><br><span class="line">                <span class="comment">// 是否启用Swagger</span></span><br><span class="line">                .enable(enabled)</span><br><span class="line">                <span class="comment">// 用来创建该API的基本信息，展示在文档的页面中（自定义展示的信息）</span></span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                <span class="comment">// 设置哪些接口暴露给Swagger展示</span></span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">// 扫描所有有注解的api，用这种方式更灵活</span></span><br><span class="line">                .apis(RequestHandlerSelectors.withMethodAnnotation(ApiOperation.class))</span><br><span class="line">                <span class="comment">// 扫描指定包中的swagger注解</span></span><br><span class="line">                <span class="comment">// .apis(RequestHandlerSelectors.basePackage(&quot;com.ruoyi.project.tool.swagger&quot;))</span></span><br><span class="line">                <span class="comment">// 扫描所有 .apis(RequestHandlerSelectors.any())</span></span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build()</span><br><span class="line">                <span class="comment">/* 设置安全模式，swagger可以设置访问token */</span></span><br><span class="line">                .securitySchemes(securitySchemes())</span><br><span class="line">                .securityContexts(securityContexts())</span><br><span class="line">                .pathMapping(pathMapping);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 安全模式，这里指定token通过Authorization头请求头传递</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SecurityScheme&gt; <span class="title function_">securitySchemes</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        List&lt;SecurityScheme&gt; apiKeyList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SecurityScheme&gt;();</span><br><span class="line">        apiKeyList.add(<span class="keyword">new</span> <span class="title class_">ApiKey</span>(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Authorization&quot;</span>, In.HEADER.toValue()));</span><br><span class="line">        <span class="keyword">return</span> apiKeyList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 安全上下文</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SecurityContext&gt; <span class="title function_">securityContexts</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        List&lt;SecurityContext&gt; securityContexts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        securityContexts.add(</span><br><span class="line">                SecurityContext.builder()</span><br><span class="line">                        .securityReferences(defaultAuth())</span><br><span class="line">                        .operationSelector(o -&gt; o.requestMappingPattern().matches(<span class="string">&quot;/.*&quot;</span>))</span><br><span class="line">                        .build());</span><br><span class="line">        <span class="keyword">return</span> securityContexts;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认的安全上引用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SecurityReference&gt; <span class="title function_">defaultAuth</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">AuthorizationScope</span> <span class="variable">authorizationScope</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationScope</span>(<span class="string">&quot;global&quot;</span>, <span class="string">&quot;accessEverything&quot;</span>);</span><br><span class="line">        AuthorizationScope[] authorizationScopes = <span class="keyword">new</span> <span class="title class_">AuthorizationScope</span>[<span class="number">1</span>];</span><br><span class="line">        authorizationScopes[<span class="number">0</span>] = authorizationScope;</span><br><span class="line">        List&lt;SecurityReference&gt; securityReferences = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        securityReferences.add(<span class="keyword">new</span> <span class="title class_">SecurityReference</span>(<span class="string">&quot;Authorization&quot;</span>, authorizationScopes));</span><br><span class="line">        <span class="keyword">return</span> securityReferences;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加摘要信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">apiInfo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// 用ApiInfoBuilder进行定制</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                <span class="comment">// 设置标题</span></span><br><span class="line">                .title(<span class="string">&quot;标题：若依管理系统_接口文档&quot;</span>)</span><br><span class="line">                <span class="comment">// 描述</span></span><br><span class="line">                .description(<span class="string">&quot;描述：用于管理集团旗下公司的人员信息,具体包括XXX,XXX模块...&quot;</span>)</span><br><span class="line">                <span class="comment">// 作者信息</span></span><br><span class="line">                .contact(<span class="keyword">new</span> <span class="title class_">Contact</span>(ruoyiConfig.getName(), <span class="literal">null</span>, <span class="literal">null</span>))</span><br><span class="line">                <span class="comment">// 版本</span></span><br><span class="line">                .version(<span class="string">&quot;版本号:&quot;</span> + ruoyiConfig.getVersion())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>趁此机会，我们说一下RuoYiConfig这个类。这是ry系统自己定义的一个类，用于读YML中的配置：</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 项目相关配置</span></span><br><span class="line"><span class="attr">ruoyi:</span></span><br><span class="line">  <span class="comment"># 名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">RuoYi</span></span><br><span class="line">  <span class="comment"># 版本</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">3.8</span><span class="number">.3</span></span><br><span class="line">  <span class="comment"># 版权年份</span></span><br><span class="line">  <span class="attr">copyrightYear:</span> <span class="number">2023</span></span><br><span class="line">  <span class="comment"># 实例演示开关</span></span><br><span class="line">  <span class="attr">demoEnabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 文件路径 示例（ Windows配置D:/ruoyi/uploadPath，Linux配置 /home/ruoyi/uploadPath）</span></span><br><span class="line">  <span class="attr">profile:</span> <span class="string">D:/ruoyi/uploadPath</span></span><br><span class="line">  <span class="comment"># 获取ip地址开关</span></span><br><span class="line">  <span class="attr">addressEnabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 验证码类型 math 数组计算 char 字符验证</span></span><br><span class="line">  <span class="attr">captchaType:</span> <span class="string">math</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>以上配置或多或少会出现在项目的各个地方用户展示。有一个叫captchaType的配置可以切换验证码的样式是数学计算还是4个随机字母，大家可以切换试试。</p>
</li>
<li><p>关于swagger在yml中的配置如下：</p>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Swagger配置</span></span><br><span class="line"><span class="attr">swagger:</span></span><br><span class="line">  <span class="comment"># 是否开启swagger</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 请求前缀</span></span><br><span class="line">  <span class="attr">pathMapping:</span> <span class="string">/dev-api</span></span><br></pre></td></tr></table></figure>

<ul>
<li>特别需要关注的是pathMapping配置成&#x2F;dev-api，意思是说请求项目的&#x2F;abc接口实际上需要请求&#x2F;dev-api&#x2F;abc，这一点需要特别注意！</li>
</ul>
<h3 id="第三步是后端放行："><a href="#第三步是后端放行：" class="headerlink" title="第三步是后端放行："></a>第三步是后端放行：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(<span class="string">&quot;/swagger-ui.html&quot;</span>, <span class="string">&quot;/swagger-resources/**&quot;</span>, <span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;/*/api-docs&quot;</span>, <span class="string">&quot;/druid/**&quot;</span>).permitAll()</span><br></pre></td></tr></table></figure>

<ul>
<li>因为RY系统的后端有安全框架的加持保护所有的接口，所以需要放行。</li>
</ul>
<h3 id="第四步是在需要被访问的添加上相应的注解："><a href="#第四步是在需要被访问的添加上相应的注解：" class="headerlink" title="第四步是在需要被访问的添加上相应的注解："></a>第四步是在需要被访问的添加上相应的注解：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * swagger 用户测试方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//@Api(&quot;用户信息管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> <span class="keyword">extends</span> <span class="title class_">BaseController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;Integer, UserEntity&gt; users = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;Integer, UserEntity&gt;();</span><br><span class="line">    &#123;</span><br><span class="line">        users.put(<span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">UserEntity</span>(<span class="number">1</span>, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;admin123&quot;</span>, <span class="string">&quot;15888888888&quot;</span>));</span><br><span class="line">        users.put(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">UserEntity</span>(<span class="number">2</span>, <span class="string">&quot;ry&quot;</span>, <span class="string">&quot;admin123&quot;</span>, <span class="string">&quot;15666666666&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;获取用户列表&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R&lt;List&lt;UserEntity&gt;&gt; <span class="title function_">userList</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;UserEntity&gt; userList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;UserEntity&gt;(users.values());</span><br><span class="line">        <span class="keyword">return</span> R.ok(userList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;获取用户详细&quot;)</span></span><br><span class="line">    <span class="meta">@ApiImplicitParam(name = &quot;userId&quot;, value = &quot;用户ID&quot;, required = true, dataType = &quot;int&quot;, paramType = &quot;path&quot;, dataTypeClass = Integer.class)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;userId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R&lt;UserEntity&gt; <span class="title function_">getUser</span><span class="params">(<span class="meta">@PathVariable</span> Integer userId)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (!users.isEmpty() &amp;&amp; users.containsKey(userId))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> R.ok(users.get(userId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> R.fail(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;新增用户&quot;)</span></span><br><span class="line">    <span class="meta">@ApiImplicitParams(&#123;</span></span><br><span class="line"><span class="meta">        @ApiImplicitParam(name = &quot;userId&quot;, value = &quot;用户id&quot;, dataType = &quot;Integer&quot;, dataTypeClass = Integer.class),</span></span><br><span class="line"><span class="meta">        @ApiImplicitParam(name = &quot;username&quot;, value = &quot;用户名称&quot;, dataType = &quot;String&quot;, dataTypeClass = String.class),</span></span><br><span class="line"><span class="meta">        @ApiImplicitParam(name = &quot;password&quot;, value = &quot;用户密码&quot;, dataType = &quot;String&quot;, dataTypeClass = String.class),</span></span><br><span class="line"><span class="meta">        @ApiImplicitParam(name = &quot;mobile&quot;, value = &quot;用户手机&quot;, dataType = &quot;String&quot;, dataTypeClass = String.class)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R&lt;String&gt; <span class="title function_">save</span><span class="params">(UserEntity user)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNull(user) || StringUtils.isNull(user.getUserId()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> R.fail(<span class="string">&quot;用户ID不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        users.put(user.getUserId(), user);</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;更新用户&quot;)</span></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R&lt;String&gt; <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> UserEntity user)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNull(user) || StringUtils.isNull(user.getUserId()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> R.fail(<span class="string">&quot;用户ID不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (users.isEmpty() || !users.containsKey(user.getUserId()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> R.fail(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        users.remove(user.getUserId());</span><br><span class="line">        users.put(user.getUserId(), user);</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;删除用户信息&quot;)</span></span><br><span class="line">    <span class="meta">@ApiImplicitParam(name = &quot;userId&quot;, value = &quot;用户ID&quot;, required = true, dataType = &quot;int&quot;, paramType = &quot;path&quot;, dataTypeClass = Integer.class)</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/&#123;userId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R&lt;String&gt; <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable</span> Integer userId)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (!users.isEmpty() &amp;&amp; users.containsKey(userId))</span><br><span class="line">        &#123;</span><br><span class="line">            users.remove(userId);</span><br><span class="line">            <span class="keyword">return</span> R.ok();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> R.fail(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModel(value = &quot;UserEntity&quot;, description = &quot;用户实体&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户ID&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户名称&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户密码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户手机&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserEntity</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserEntity</span><span class="params">(Integer userId, String username, String password, String mobile)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">        <span class="built_in">this</span>.mobile = mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getUserId</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserId</span><span class="params">(Integer userId)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMobile</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMobile</span><span class="params">(String mobile)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">this</span>.mobile = mobile;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">以上是ry自带的。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">我们自己写好的接口也要试试（参数配置为例子）：</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取参数配置列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;system:config:list&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;获取参数配置列表&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> TableDataInfo <span class="title function_">list</span><span class="params">(SysConfig config)</span></span><br><span class="line">&#123;</span><br><span class="line">        startPage();</span><br><span class="line">        List&lt;SysConfig&gt; list = configService.selectConfigList(config);</span><br><span class="line">        <span class="keyword">return</span> getDataTable(list);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>发现一个@ApiOperation注解非常好用，直接就出来了：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271249078.png"
                      alt="图片"
                ></p>
<h2 id="2-换肤"><a href="#2-换肤" class="headerlink" title="2.换肤"></a>2.换肤</h2><ul>
<li>原生swagger不但很丑，而且参数配置的请求list还有必填项很难绕过！所以我们来换个皮肤：</li>
</ul>
<h3 id="第一步引入依赖："><a href="#第一步引入依赖：" class="headerlink" title="第一步引入依赖："></a>第一步引入依赖：</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="第二步编写前端-vue文件："><a href="#第二步编写前端-vue文件：" class="headerlink" title="第二步编写前端.vue文件："></a>第二步编写前端.vue文件：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;i-frame :src=&quot;url&quot; /&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import iFrame from &quot;@/components/iFrame/index&quot;;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;SwaggerKnife&quot;,</span><br><span class="line">  components: &#123; iFrame &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      url: process.env.VUE_APP_BASE_API + &quot;/doc.html&quot;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到，和之前不同的是进入的&#x2F;doc.html。原生swagger进入的页面是&#x2F;swagger-ui&#x2F;index.html。</li>
</ul>
<h3 id="第三步添加菜单："><a href="#第三步添加菜单：" class="headerlink" title="第三步添加菜单："></a>第三步添加菜单：</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271256543.png"
                      alt="图片"
                ></p>
<h1 id="二十九、XSS脚本过滤"><a href="#二十九、XSS脚本过滤" class="headerlink" title="二十九、XSS脚本过滤"></a>二十九、XSS脚本过滤</h1><h2 id="1-XSS脚本过滤"><a href="#1-XSS脚本过滤" class="headerlink" title="1.XSS脚本过滤"></a>1.XSS脚本过滤</h2><blockquote>
<p>什么是XSS？现场学习一下：</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BB/8186208?fromtitle=xss&amp;fromid=917356&amp;fr=aladdin" >https://baike.baidu.com/item/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BB/8186208?fromtitle=xss&amp;fromid=917356&amp;fr=aladdin<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/XSS%E6%94%BB%E5%87%BB/954065?fr=aladdin" >https://baike.baidu.com/item/XSS%E6%94%BB%E5%87%BB/954065?fr=aladdin<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="http://www.zzbaike.com/wiki/XSS" >http://www.zzbaike.com/wiki/XSS<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<ul>
<li>以ry系统为例子，我们新建用户，企图在备注中植入JavaScript，然后将会被ry的XSS脚本攻击拦截：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271300604.png"
                      alt="图片"
                ></p>
<ul>
<li>然后提交，发现&lt; script &gt;这些标签被ry系统给过滤了，因为ry写了相关防止XSS脚本攻击的代码。</li>
<li>为什么要做过滤呢？<ul>
<li>因为浏览器很蠢，它看到脚本啥都不想，就想执行。</li>
</ul>
</li>
</ul>
<h2 id="2-RY如何抵抗XSS攻击"><a href="#2-RY如何抵抗XSS攻击" class="headerlink" title="2.RY如何抵抗XSS攻击"></a>2.RY如何抵抗XSS攻击</h2><ul>
<li>ry通过过滤器实现的，相关代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Value(&quot;$&#123;xss.excludes&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String excludes;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xss.urlPatterns&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String urlPatterns;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(value = &quot;xss.enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean <span class="title function_">xssFilterRegistration</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">FilterRegistrationBean</span> <span class="variable">registration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>();</span><br><span class="line">        registration.setDispatcherTypes(DispatcherType.REQUEST);</span><br><span class="line">        registration.setFilter(<span class="keyword">new</span> <span class="title class_">XssFilter</span>());</span><br><span class="line">        registration.addUrlPatterns(StringUtils.split(urlPatterns, <span class="string">&quot;,&quot;</span>));</span><br><span class="line">        registration.setName(<span class="string">&quot;xssFilter&quot;</span>);</span><br><span class="line">        registration.setOrder(FilterRegistrationBean.HIGHEST_PRECEDENCE);</span><br><span class="line">        Map&lt;String, String&gt; initParameters = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">        initParameters.put(<span class="string">&quot;excludes&quot;</span>, excludes);</span><br><span class="line">        registration.setInitParameters(initParameters);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上是把过滤器加入到内嵌tomcat的过滤器链条中的代码，之前我们曾经讲过springSecurity过滤器链条，仅仅是内嵌tomcat的一个过滤器而已：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271304405.png"
                      alt="图片"
                ></p>
<ul>
<li><p>springSecurity过滤器链条中的多个过滤器被springSecurityChain所管理，springSecurityChain管理着一长串过滤器。</p>
</li>
<li><p><strong>解析以上代码：</strong></p>
</li>
</ul>
<blockquote>
<p>1、过滤器可以根据DispatcherType的类型选择是否执行。</p>
<p>2、FilterRegistrationBean，这个类用于把我们的过滤器注册到servlet容器中。</p>
<p>3、registration.addUrlPatterns用于设置拦截的URL。</p>
<p>4、registration.setOrder用于设置优先级，数字越小优先级越高。</p>
<p>5、registration.setInitParameters用于设置初始化参数，例如可以设置excludes（排除的URL，然而逻辑需要自己实现，默认不支持），接受参数类型为Map&lt;String, String&gt;。</p>
</blockquote>
<ul>
<li>继续，我们来看XSS过滤器到底干了什么，如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 防止XSS攻击的过滤器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XssFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排除链接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; excludes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException</span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tempExcludes</span> <span class="operator">=</span> filterConfig.getInitParameter(<span class="string">&quot;excludes&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(tempExcludes))</span><br><span class="line">        &#123;</span><br><span class="line">            String[] url = tempExcludes.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; url != <span class="literal">null</span> &amp;&amp; i &lt; url.length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                excludes.add(url[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException</span><br><span class="line">&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;XssFilter.doFilter&quot;</span>);</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">resp</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">        <span class="keyword">if</span> (handleExcludeURL(req, resp))</span><br><span class="line">        &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">XssHttpServletRequestWrapper</span> <span class="variable">xssRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XssHttpServletRequestWrapper</span>((HttpServletRequest) request);</span><br><span class="line">        chain.doFilter(xssRequest, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">handleExcludeURL</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getServletPath();</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line">        <span class="comment">// GET DELETE 不过滤</span></span><br><span class="line">        <span class="keyword">if</span> (method == <span class="literal">null</span> || HttpMethod.GET.matches(method) || HttpMethod.DELETE.matches(method))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.matches(url, excludes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>总结：</strong></li>
</ul>
<blockquote>
<p>1、我们发现，init方法主要是为了处理排除的URL。</p>
<p>2、handleExcludeURL方法用于看看URL是不是排除的URL，如果是GET和DELETE则直接不过滤；另外，如果所请求的URL在排除URL也直接不过滤。</p>
<p>3、XSS过滤原理是重新包装了Request，重写了getParameterValues方法和getInputStream方法。</p>
<p>4、getParameterValues方法用于获取参数值的数组，如果存在值，那么就进行HTML过滤，并且排除前后空格。</p>
<p>5、getInputStream方法用于处理JSON类型，如果发现是JSON，那么会先HTML过滤，然后重新包装成流进行返回。</p>
</blockquote>
<h1 id="三十、防止重复提交过滤"><a href="#三十、防止重复提交过滤" class="headerlink" title="三十、防止重复提交过滤"></a>三十、防止重复提交过滤</h1><h2 id="1-回忆前端重复请求拦截"><a href="#1-回忆前端重复请求拦截" class="headerlink" title="1.回忆前端重复请求拦截"></a>1.回忆前端重复请求拦截</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isRepeatSubmit &amp;&amp; (config.<span class="property">method</span> === <span class="string">&#x27;post&#x27;</span> || config.<span class="property">method</span> === <span class="string">&#x27;put&#x27;</span>)) &#123;</span><br><span class="line">   <span class="keyword">const</span> requestObj = &#123;</span><br><span class="line">     <span class="attr">url</span>: config.<span class="property">url</span>,</span><br><span class="line">     <span class="attr">data</span>: <span class="keyword">typeof</span> config.<span class="property">data</span> === <span class="string">&#x27;object&#x27;</span> ? <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(config.<span class="property">data</span>) : config.<span class="property">data</span>,</span><br><span class="line">     <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>()</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">const</span> sessionObj = cache.<span class="property">session</span>.<span class="title function_">getJSON</span>(<span class="string">&#x27;sessionObj&#x27;</span>)</span><br><span class="line">   <span class="keyword">if</span> (sessionObj === <span class="literal">undefined</span> || sessionObj === <span class="literal">null</span> || sessionObj === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">     cache.<span class="property">session</span>.<span class="title function_">setJSON</span>(<span class="string">&#x27;sessionObj&#x27;</span>, requestObj)</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> s_url = sessionObj.<span class="property">url</span>;                  <span class="comment">// 请求地址</span></span><br><span class="line">     <span class="keyword">const</span> s_data = sessionObj.<span class="property">data</span>;                <span class="comment">// 请求数据</span></span><br><span class="line">     <span class="keyword">const</span> s_time = sessionObj.<span class="property">time</span>;                <span class="comment">// 请求时间</span></span><br><span class="line">     <span class="keyword">const</span> interval = <span class="number">1000</span>;                         <span class="comment">// 间隔时间(ms)，小于此时间视为重复提交</span></span><br><span class="line">     <span class="keyword">if</span> (s_data === requestObj.<span class="property">data</span> &amp;&amp; requestObj.<span class="property">time</span> - s_time &lt; interval &amp;&amp; s_url === requestObj.<span class="property">url</span>) &#123;</span><br><span class="line">       <span class="keyword">const</span> message = <span class="string">&#x27;数据正在处理，请勿重复提交&#x27;</span>;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[<span class="subst">$&#123;s_url&#125;</span>]: `</span> + message)</span><br><span class="line">       <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(message))</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       cache.<span class="property">session</span>.<span class="title function_">setJSON</span>(<span class="string">&#x27;sessionObj&#x27;</span>, requestObj)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上的实现，无非就是对请求进行一个检查。</li>
<li>如果请求数据和请求URL和<strong>最近一次</strong>请求一致，并且请求间隔小于1000ms，就进行请求拦截，直接拒绝当前请求。</li>
<li>从我上面的描述，发现了一个bug，总有手快的人，喜欢点A按钮，然后立刻点B按钮，然后又立刻点A按钮。那么对于A按钮是重复提交了，但是又不满足前端判断重复请求的条件，于是重复请求进入了后端，这时候就需要后端再次校验，是不是重复请求。</li>
</ul>
<h2 id="2-后端过滤重复请求"><a href="#2-后端过滤重复请求" class="headerlink" title="2.后端过滤重复请求"></a>2.后端过滤重复请求</h2><ul>
<li>后端过滤重复请求也是通过过滤器，并且和XSS过滤惊人的相似。</li>
<li>首先是后端的拦截器注册：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;, &quot;unchecked&quot;&#125;)</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> FilterRegistrationBean <span class="title function_">someFilterRegistration</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">FilterRegistrationBean</span> <span class="variable">registration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>();</span><br><span class="line">      registration.setFilter(<span class="keyword">new</span> <span class="title class_">RepeatableFilter</span>());</span><br><span class="line">      registration.addUrlPatterns(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">      registration.setOrder(FilterRegistrationBean.LOWEST_PRECEDENCE);</span><br><span class="line">      <span class="keyword">return</span> registration;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从上方代码可以发现，拦截所有URL，并且过滤器顺序最后执行。然后是看具体过滤器代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Repeatable 过滤器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RepeatableFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException</span><br><span class="line">&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;RepeatableFilter.doFilter&quot;</span>);</span><br><span class="line">        <span class="type">ServletRequest</span> <span class="variable">requestWrapper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> HttpServletRequest</span><br><span class="line">                &amp;&amp; StringUtils.startsWithIgnoreCase(request.getContentType(), MediaType.APPLICATION_JSON_VALUE))</span><br><span class="line">        &#123;</span><br><span class="line">            requestWrapper = <span class="keyword">new</span> <span class="title class_">RepeatedlyRequestWrapper</span>((HttpServletRequest) request, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == requestWrapper)</span><br><span class="line">        &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            chain.doFilter(requestWrapper, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们看到，仅仅是重新包装请求，让流（Mime类型是application&#x2F;json的情况下的流，也就是说，一般是新增xxx，修改xxx 的时候才会触发重新包装）可以重复读取。这仅仅是为了防止重复提交做准备。当我们需要某些接口禁止短时间重复提交的时候，我们需要加上一个注解！</li>
<li>RepeatSubmit注解用于防止重复提交。注解源码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义注解防止表单重复提交</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RepeatSubmit</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 间隔时间(ms)，小于此时间视为重复提交</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">interval</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提示消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">message</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;不允许重复提交，请稍候再试&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>源码中可以看到，<strong>默认5秒内视为重复提交，并且提示消息为“不允许重复提交，请稍候再试”</strong>。</li>
<li>我们现在把他添加到用户管理的用户修改上，并且默认让它20（设置长一些是为了等待前端的一秒钟）秒钟再次修改视为重复提交。如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 修改用户</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;system:user:edit&#x27;)&quot;)</span></span><br><span class="line">  <span class="meta">@Log(title = &quot;用户管理&quot;, businessType = BusinessType.UPDATE)</span></span><br><span class="line">  <span class="meta">@PutMapping</span></span><br><span class="line">  <span class="meta">@RepeatSubmit(interval = 20000)</span></span><br><span class="line">  <span class="keyword">public</span> AjaxResult <span class="title function_">edit</span><span class="params">(<span class="meta">@Validated</span> <span class="meta">@RequestBody</span> SysUser user)</span> &#123;</span><br><span class="line">      userService.checkUserAllowed(user);</span><br><span class="line">      userService.checkUserDataScope(user.getUserId());</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.isNotEmpty(user.getPhonenumber())</span><br><span class="line">              &amp;&amp; UserConstants.NOT_UNIQUE.equals(userService.checkPhoneUnique(user))) &#123;</span><br><span class="line">          <span class="keyword">return</span> AjaxResult.error(<span class="string">&quot;修改用户&#x27;&quot;</span> + user.getUserName() + <span class="string">&quot;&#x27;失败，手机号码已存在&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotEmpty(user.getEmail())</span><br><span class="line">              &amp;&amp; UserConstants.NOT_UNIQUE.equals(userService.checkEmailUnique(user))) &#123;</span><br><span class="line">          <span class="keyword">return</span> AjaxResult.error(<span class="string">&quot;修改用户&#x27;&quot;</span> + user.getUserName() + <span class="string">&quot;&#x27;失败，邮箱账号已存在&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      user.setUpdateBy(getUsername());</span><br><span class="line">      <span class="keyword">return</span> toAjax(userService.updateUser(user));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-源码"><a href="#3-源码" class="headerlink" title="3.源码"></a>3.源码</h2><ul>
<li>完成重复提交拦截的拦截器就一个，但是呢，有两个类。一个是抽象类RepeatSubmitInterceptor，一个是SameUrlDataInterceptor，继承的抽象类RepeatSubmitInterceptor。</li>
<li><strong>先看抽象类RepeatSubmitInterceptor：</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 防止重复提交拦截器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">RepeatSubmitInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> HandlerMethod)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> (HandlerMethod) handler;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> handlerMethod.getMethod();</span><br><span class="line">            <span class="type">RepeatSubmit</span> <span class="variable">annotation</span> <span class="operator">=</span> method.getAnnotation(RepeatSubmit.class);</span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.isRepeatSubmit(request, annotation))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">AjaxResult</span> <span class="variable">ajaxResult</span> <span class="operator">=</span> AjaxResult.error(annotation.message());</span><br><span class="line">                    ServletUtils.renderString(response, JSON.toJSONString(ajaxResult));</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证是否重复提交由子类实现具体的防重复提交的规则</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">isRepeatSubmit</span><span class="params">(HttpServletRequest request, RepeatSubmit annotation)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>再看类SameUrlDataInterceptor：</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断请求url和数据是否和上一次相同，</span></span><br><span class="line"><span class="comment"> * 如果和上次相同，则是重复提交表单。 有效时间为10秒内。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SameUrlDataInterceptor</span> <span class="keyword">extends</span> <span class="title class_">RepeatSubmitInterceptor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REPEAT_PARAMS</span> <span class="operator">=</span> <span class="string">&quot;repeatParams&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REPEAT_TIME</span> <span class="operator">=</span> <span class="string">&quot;repeatTime&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 令牌自定义标识</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;token.header&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String header;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisCache redisCache;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRepeatSubmit</span><span class="params">(HttpServletRequest request, RepeatSubmit annotation)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">nowParams</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> RepeatedlyRequestWrapper)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">RepeatedlyRequestWrapper</span> <span class="variable">repeatedlyRequest</span> <span class="operator">=</span> (RepeatedlyRequestWrapper) request;</span><br><span class="line">            nowParams = HttpHelper.getBodyString(repeatedlyRequest);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// body参数为空，获取Parameter的数据</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(nowParams))</span><br><span class="line">        &#123;</span><br><span class="line">            nowParams = JSON.toJSONString(request.getParameterMap());</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; nowDataMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        nowDataMap.put(REPEAT_PARAMS, nowParams);</span><br><span class="line">        nowDataMap.put(REPEAT_TIME, System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 请求地址（作为存放cache的key值）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 唯一值（没有消息头则使用请求地址）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">submitKey</span> <span class="operator">=</span> StringUtils.trimToEmpty(request.getHeader(header));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 唯一标识（指定key + url + 消息头）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheRepeatKey</span> <span class="operator">=</span> CacheConstants.REPEAT_SUBMIT_KEY + url + submitKey;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">sessionObj</span> <span class="operator">=</span> redisCache.getCacheObject(cacheRepeatKey);</span><br><span class="line">        <span class="keyword">if</span> (sessionObj != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Map&lt;String, Object&gt; sessionMap = (Map&lt;String, Object&gt;) sessionObj;</span><br><span class="line">            <span class="keyword">if</span> (sessionMap.containsKey(url))</span><br><span class="line">            &#123;</span><br><span class="line">                Map&lt;String, Object&gt; preDataMap = (Map&lt;String, Object&gt;) sessionMap.get(url);</span><br><span class="line">                <span class="keyword">if</span> (compareParams(nowDataMap, preDataMap) &amp;&amp; compareTime(nowDataMap, preDataMap, annotation.interval()))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; cacheMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        cacheMap.put(url, nowDataMap);</span><br><span class="line">        redisCache.setCacheObject(cacheRepeatKey, cacheMap, annotation.interval(), TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断参数是否相同</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">compareParams</span><span class="params">(Map&lt;String, Object&gt; nowMap, Map&lt;String, Object&gt; preMap)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">nowParams</span> <span class="operator">=</span> (String) nowMap.get(REPEAT_PARAMS);</span><br><span class="line">        <span class="type">String</span> <span class="variable">preParams</span> <span class="operator">=</span> (String) preMap.get(REPEAT_PARAMS);</span><br><span class="line">        <span class="keyword">return</span> nowParams.equals(preParams);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断两次间隔时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">compareTime</span><span class="params">(Map&lt;String, Object&gt; nowMap, Map&lt;String, Object&gt; preMap, <span class="type">int</span> interval)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">time1</span> <span class="operator">=</span> (Long) nowMap.get(REPEAT_TIME);</span><br><span class="line">        <span class="type">long</span> <span class="variable">time2</span> <span class="operator">=</span> (Long) preMap.get(REPEAT_TIME);</span><br><span class="line">        <span class="keyword">if</span> ((time1 - time2) &lt; interval)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>然后是注册拦截器：</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通用配置</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourcesConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RepeatSubmitInterceptor repeatSubmitInterceptor;</span><br><span class="line">...省略其他代码</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义拦截规则</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span></span><br><span class="line">&#123;</span><br><span class="line">        registry.addInterceptor(repeatSubmitInterceptor).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">...省略其他代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4.总结"></a>4.总结</h2><blockquote>
<p>1、RepeatedlyRequestWrapper仅仅是把原装Request进行重新封装，当然，原装流MimeType是JSON的时候才需要重新包装，包装之后的请求变强了！怎么个强法呢？RepeatedlyRequestWrapper包装的请求的流可以重复读取！getInputStream方法可以拿到存储在属性中的body字节数组进行流的重读。这只是为拦截重复请求做一个准备。</p>
<p>2、经过debug发现后端判断重复逻辑和前端其实差不多。难点在于如何确定同一个人的同一个请求，ry使用的url+token的方式，<code>确定同一个人同一个请求。</code></p>
<p>3、拦截器拦截所有的请求，并且当请求controller有注解RepeatSubmit的时候，就会去判断是否是重复提交，如果是重复提交就直接打回。</p>
</blockquote>
<ul>
<li>Tips：handler是HandlerMethod是什么情况下？当要访问Controller控制器的时候！</li>
</ul>
<h1 id="三十一、框架验证"><a href="#三十一、框架验证" class="headerlink" title="三十一、框架验证"></a>三十一、框架验证</h1><ul>
<li>直接看官网讲述：<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi/document/htsc.html#%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81" >http://doc.ruoyi.vip/ruoyi/document/htsc.html#%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81<i class="fas fa-external-link-alt"></i></a></li>
<li>@Xss自定义注解。分析正则：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271327399.png"
                      alt="图片"
                ></p>
<p>例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&#x27;abc&#x27;</span>&gt;</span><span class="language-javascript"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;我很强大！&#x27;</span>)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>1、&lt;匹配&lt;。</p>
<p>2、\S匹配一切非空字符，加上量词*（非贪婪），即匹配script。</p>
<p>3、[ ^&gt; ]匹配非&gt;的一切字符，并且加上量词*，即匹配（_type&#x3D;’abc’）。括号里面的下划线代表空格。</p>
<p>4、&gt;匹配&gt;。</p>
<p>5、.*？则是非贪婪模式匹配除换行符 \n 之外的任何单字符任意次，这里匹配为空。</p>
</blockquote>
<h1 id="三十二、前端手册速过"><a href="#三十二、前端手册速过" class="headerlink" title="三十二、前端手册速过"></a>三十二、前端手册速过</h1><ul>
<li>ry开发规范<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83<i class="fas fa-external-link-alt"></i></a></li>
<li>ry请求流程<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B<i class="fas fa-external-link-alt"></i></a></li>
<li>ry引入依赖<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96<i class="fas fa-external-link-alt"></i></a></li>
<li>ry路由使用<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E8%B7%AF%E7%94%B1%E4%BD%BF%E7%94%A8" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E8%B7%AF%E7%94%B1%E4%BD%BF%E7%94%A8<i class="fas fa-external-link-alt"></i></a></li>
<li>ry前端使用组件<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E7%BB%84%E4%BB%B6%E4%BD%BF%E7%94%A8" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E7%BB%84%E4%BB%B6%E4%BD%BF%E7%94%A8<i class="fas fa-external-link-alt"></i></a></li>
<li>权限使用<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E6%9D%83%E9%99%90%E4%BD%BF%E7%94%A8" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E6%9D%83%E9%99%90%E4%BD%BF%E7%94%A8<i class="fas fa-external-link-alt"></i></a></li>
<li>多级目录<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%A4%9A%E7%BA%A7%E7%9B%AE%E5%BD%95" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%A4%9A%E7%BA%A7%E7%9B%AE%E5%BD%95<i class="fas fa-external-link-alt"></i></a></li>
<li>页签缓存<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E9%A1%B5%E7%AD%BE%E7%BC%93%E5%AD%98" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E9%A1%B5%E7%AD%BE%E7%BC%93%E5%AD%98<i class="fas fa-external-link-alt"></i></a></li>
<li>使用图标<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E4%BD%BF%E7%94%A8%E5%9B%BE%E6%A0%87" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E4%BD%BF%E7%94%A8%E5%9B%BE%E6%A0%87<i class="fas fa-external-link-alt"></i></a></li>
<li>使用字典<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E4%BD%BF%E7%94%A8%E5%AD%97%E5%85%B8" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E4%BD%BF%E7%94%A8%E5%AD%97%E5%85%B8<i class="fas fa-external-link-alt"></i></a></li>
<li>使用参数<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E4%BD%BF%E7%94%A8%E5%8F%82%E6%95%B0" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E4%BD%BF%E7%94%A8%E5%8F%82%E6%95%B0<i class="fas fa-external-link-alt"></i></a></li>
<li>异常处理<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86<i class="fas fa-external-link-alt"></i></a></li>
<li>应用路径<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%BA%94%E7%94%A8%E8%B7%AF%E5%BE%84" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%BA%94%E7%94%A8%E8%B7%AF%E5%BE%84<i class="fas fa-external-link-alt"></i></a></li>
<li>内容复制<a class="link"   target="_blank" rel="noopener" href="http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%86%85%E5%AE%B9%E5%A4%8D%E5%88%B6" >http://doc.ruoyi.vip/ruoyi-vue/document/qdsc.html#%E5%86%85%E5%AE%B9%E5%A4%8D%E5%88%B6<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<h1 id="三十三、禁止多终端同时登录实现"><a href="#三十三、禁止多终端同时登录实现" class="headerlink" title="三十三、禁止多终端同时登录实现"></a>三十三、禁止多终端同时登录实现</h1><h2 id="1-禁止多终端同时登录实现实现的两种方式"><a href="#1-禁止多终端同时登录实现实现的两种方式" class="headerlink" title="1.禁止多终端同时登录实现实现的两种方式"></a>1.禁止多终端同时登录实现实现的两种方式</h2><ul>
<li>我们如果想让一个账号不允许两个人登录，那么涉及到一个问题。</li>
<li>第二个人要登录，怎么办？<ul>
<li>不许登录，提示已经登录了。</li>
<li>询问是否强制直接T出先登录的那个人。</li>
</ul>
</li>
</ul>
<h2 id="2-方式一：提示已经登录"><a href="#2-方式一：提示已经登录" class="headerlink" title="2.方式一：提示已经登录"></a>2.方式一：提示已经登录</h2><ul>
<li>这种方式比较简单，弹出一个提示即可。</li>
<li>这种情况下，在用户每次登录认证成功的时候，去Redis查询一下有没有登录就行了。</li>
<li>在登录的时候，判断用户是否已经登录，若已经登录则弹出提示已经登录了：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 刷新令牌有效期</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> loginUser 登录信息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshToken</span><span class="params">(LoginUser loginUser)</span> &#123;</span><br><span class="line">       loginUser.setLoginTime(System.currentTimeMillis());</span><br><span class="line">       loginUser.setExpireTime(loginUser.getLoginTime() + expireTime * MILLIS_MINUTE);</span><br><span class="line">       <span class="comment">// 根据uuid将loginUser缓存</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> getTokenKey(loginUser.getToken());</span><br><span class="line">       <span class="comment">//判断当前用户是否已经登录</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">onlineUser</span> <span class="operator">=</span> redisCache.getCacheObject(CacheConstants.LOGIN_TOKEN_KEY + loginUser.getUsername());</span><br><span class="line">       <span class="keyword">if</span> (onlineUser != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;用户已经登录，不允许再次登录！&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       redisCache.setCacheObject(userKey, loginUser, expireTime, TimeUnit.MINUTES);</span><br><span class="line">       <span class="comment">//存入Redis当前用户的登录信息的时候，再次存入哪个用户登录了！</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">nowLoginUser</span> <span class="operator">=</span> CacheConstants.LOGIN_TOKEN_KEY + loginUser.getUsername();</span><br><span class="line">       redisCache.setCacheObject(nowLoginUser, nowLoginUser, expireTime, TimeUnit.MINUTES);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>登出的时候记得剔除redis中的信息：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">LogoutSuccessHandlerImpl中：</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUser(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(loginUser)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> loginUser.getUsername();</span><br><span class="line">            <span class="comment">// 删除用户缓存记录</span></span><br><span class="line">            tokenService.delLoginUser(loginUser.getToken(), userName);</span><br><span class="line">            <span class="comment">// 记录用户退出日志</span></span><br><span class="line">            AsyncManager.me().execute(AsyncFactory.recordLogininfor(userName, Constants.LOGOUT, <span class="string">&quot;退出成功&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ServletUtils.renderString(response, JSON.toJSONString(AjaxResult.error(HttpStatus.SUCCESS, <span class="string">&quot;退出成功&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    TokenService中：</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除用户身份信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delLoginUser</span><span class="params">(String token,String userName)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(token)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> getTokenKey(token);</span><br><span class="line">            redisCache.deleteObject(userKey);</span><br><span class="line">            redisCache.deleteObject(CacheConstants.LOGIN_TOKEN_KEY + userName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>此方式的不好之处：后面登录的人只能等待前面的人30min不操作，或者前面那个人主动登出，不然后面登录的人别想登录上去。</li>
</ul>
<h2 id="3-方式二：询问是否T出"><a href="#3-方式二：询问是否T出" class="headerlink" title="3.方式二：询问是否T出"></a>3.方式二：询问是否T出</h2><ul>
<li>思路提示：前端点击强制登录，若用户已经登录，则后端移除先前登录的token，重新写入现在登录的token即可。先前token被移除后先前登录的那个人自动下线。</li>
</ul>
<h1 id="三十四、加密方式传输密码"><a href="#三十四、加密方式传输密码" class="headerlink" title="三十四、加密方式传输密码"></a>三十四、加密方式传输密码</h1><h2 id="1-加密方式传输密码"><a href="#1-加密方式传输密码" class="headerlink" title="1.加密方式传输密码"></a>1.加密方式传输密码</h2><ul>
<li>在utils下的jsencrypt.js中，ruoyi已经为我们准备好了加密和解密的方法。</li>
<li>为了安全起见，我们重新生成密钥对，然后在前端只保留公钥，私钥存放到后端中。</li>
<li>前端公钥加密代码:</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> pub = <span class="string">&quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDZFDCUdpCgAfrfsi7qQQ81LTCI\n&quot;</span> +</span><br><span class="line">  <span class="string">&quot;5PMxQw1cNpsDQygdo1QPloq3OiMfXCtxoUH+IN2IHVKXF3btdGaSYUGQVnOgYO1T\n&quot;</span> +</span><br><span class="line">  <span class="string">&quot;PaJ9BdZ6A9KBkJpAcNz4A4rCjj+YcvbAIuiV1a9U8VFN5po7xqYNoXi1+lvuyQGl\n&quot;</span> +</span><br><span class="line">  <span class="string">&quot;BqchW/4KadZoxtQ3qwIDAQAB&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加密</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">encryptAndTransmit</span>(<span class="params">txt</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> encryptor = <span class="keyword">new</span> <span class="title class_">JSEncrypt</span>()</span><br><span class="line">  encryptor.<span class="title function_">setPublicKey</span>(pub) <span class="comment">// 设置公钥</span></span><br><span class="line">  <span class="keyword">return</span> encryptor.<span class="title function_">encrypt</span>(txt) <span class="comment">// 对数据进行加密</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>让密码加密传输：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录</span></span><br><span class="line">   <span class="title class_">Login</span>(&#123;commit&#125;, userInfo) &#123;</span><br><span class="line">     <span class="keyword">const</span> username = userInfo.<span class="property">username</span>.<span class="title function_">trim</span>()</span><br><span class="line">     <span class="keyword">const</span> password = <span class="title function_">encryptAndTransmit</span>(userInfo.<span class="property">password</span>)</span><br><span class="line">     <span class="keyword">const</span> code = userInfo.<span class="property">code</span></span><br><span class="line">     <span class="keyword">const</span> uuid = userInfo.<span class="property">uuid</span></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="title function_">login</span>(username, password, code, uuid).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">         <span class="title function_">setToken</span>(res.<span class="property">token</span>)</span><br><span class="line">         <span class="title function_">commit</span>(<span class="string">&#x27;SET_TOKEN&#x27;</span>, res.<span class="property">token</span>)</span><br><span class="line">         <span class="title function_">resolve</span>()</span><br><span class="line">       &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">         <span class="title function_">reject</span>(error)</span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;)</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>后端私钥解密代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.ruoyi.common.utils.sign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.PKCS8EncodedKeySpec;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RSA加密解密</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RsaUtils</span> &#123;</span><br><span class="line">    <span class="comment">// Rsa 私钥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">privateKey</span> <span class="operator">=</span> <span class="string">&quot;MIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBANkUMJR2kKAB+t+y\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;LupBDzUtMIjk8zFDDVw2mwNDKB2jVA+Wirc6Ix9cK3GhQf4g3YgdUpcXdu10ZpJh\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;QZBWc6Bg7VM9on0F1noD0oGQmkBw3PgDisKOP5hy9sAi6JXVr1TxUU3mmjvGpg2h\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;eLX6W+7JAaUGpyFb/gpp1mjG1DerAgMBAAECgYEAnamjSwD+M6icfEIe/va3w+iJ\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;WrPmyb2og3QJjAoHpdcNY7D0GPX5snov93ymwJtAKu8ZIDHjp70mDmTiyKFxohCc\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;rFCk4Ek55cGv/qpews5JpBLFRaRERPGlt3bvUDz+A36nmSLRJHfUkGYRtFffHmLT\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;eXsZLdDV/3VLA3036VECQQDxV5MN1B8uYMC0qIL8IGP/qvII4ZvSX+nIeXxSrQlp\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;taNNqZWuiV0KLZhar68wHWoB0ZVICUvigsyKu8KMQ3WjAkEA5kNd6zSQkaIDkxUE\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;b1j6OgtV5z+tCtlCbynbsSyg12ZDJmZ3XDu01vVUVMuKlM8FPlwtgTx6HSdcVno+\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;Z8+GWQJABQqYRsysjhJ1VBDFE7E1hYyzm53i3GUmhAqNn0iADtY9gAzP1KKH8AN9\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;0D8lQLMMmNcg8C1JiYTD8w3zBW0PUwJAUHHYrgN/PmHLvebp1bzQLtcm+9NTMScV\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;/qAxEIT27Endy9ygdqilVTQAcl9p2vM4ccDiZPQr9WN67vtmMf5egQJBAKxFKrFh\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;s1189LqS4aS45QwxBMS4B5FQCA3378DqdRZMXLlGdlO5h5KSWucF3AUJLz3fSsOh\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;6rjjS1Ena+QjYpg=&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私钥解密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> privateKeyString 私钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text             待解密的文本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解密后的文本</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">decryptByPrivateKey</span><span class="params">(String text)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> decryptByPrivateKey(privateKey, text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私钥解密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> privateKeyString 私钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text             待解密的文本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解密后的文本</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">decryptByPrivateKey</span><span class="params">(String privateKeyString, String text)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">PKCS8EncodedKeySpec</span> <span class="variable">pkcs8EncodedKeySpec5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PKCS8EncodedKeySpec</span>(Base64.decodeBase64(privateKeyString));</span><br><span class="line">        <span class="type">KeyFactory</span> <span class="variable">keyFactory</span> <span class="operator">=</span> KeyFactory.getInstance(<span class="string">&quot;RSA&quot;</span>);</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyFactory.generatePrivate(pkcs8EncodedKeySpec5);</span><br><span class="line">        <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;RSA&quot;</span>);</span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, privateKey);</span><br><span class="line">        <span class="type">byte</span>[] result = cipher.doFinal(Base64.decodeBase64(text));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>后端解密：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 登录方法</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> loginBody 登录信息</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> AjaxResult <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> LoginBody loginBody)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="type">AjaxResult</span> <span class="variable">ajax</span> <span class="operator">=</span> AjaxResult.success();</span><br><span class="line">      <span class="comment">// 生成令牌</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> loginService.login(</span><br><span class="line">              loginBody.getUsername(),</span><br><span class="line">              RsaUtils.decryptByPrivateKey(loginBody.getPassword()),</span><br><span class="line">              loginBody.getCode(),</span><br><span class="line">              loginBody.getUuid());</span><br><span class="line">      ajax.put(Constants.TOKEN, token);</span><br><span class="line">      <span class="keyword">return</span> ajax;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>此刻再看，密码已经是加密传输了：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271346694.png"
                      alt="图片"
                ></p>
<h1 id="三十五、限流控制"><a href="#三十五、限流控制" class="headerlink" title="三十五、限流控制"></a>三十五、限流控制</h1><ul>
<li>我们需要预防某些用户疯狂点击占用服务器资源，需要限流。</li>
<li>ruoyi在新版中，加入了限流控制，类体如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.aspectj;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.RedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.annotation.RateLimiter;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.enums.LimitType;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.exception.ServiceException;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ip.IpUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 限流处理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimiterAspect</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(RateLimiterAspect.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;Object, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisScript&lt;Long&gt; limitScript;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRedisTemplate1</span><span class="params">(RedisTemplate&lt;Object, Object&gt; redisTemplate)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLimitScript</span><span class="params">(RedisScript&lt;Long&gt; limitScript)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">this</span>.limitScript = limitScript;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;@annotation(rateLimiter)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doBefore</span><span class="params">(JoinPoint point, RateLimiter rateLimiter)</span> <span class="keyword">throws</span> Throwable</span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> rateLimiter.key();</span><br><span class="line">        <span class="type">int</span> <span class="variable">time</span> <span class="operator">=</span> rateLimiter.time();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> rateLimiter.count();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">combineKey</span> <span class="operator">=</span> getCombineKey(rateLimiter, point);</span><br><span class="line">        List&lt;Object&gt; keys = Collections.singletonList(combineKey);</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">number</span> <span class="operator">=</span> redisTemplate.execute(limitScript, keys, count, time);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNull(number) || number.intValue() &gt; count)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;访问过于频繁，请稍候再试&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">&quot;限制请求&#x27;&#123;&#125;&#x27;,当前请求&#x27;&#123;&#125;&#x27;,缓存key&#x27;&#123;&#125;&#x27;&quot;</span>, count, number.intValue(), key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ServiceException e)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;服务器限流异常，请稍候再试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCombineKey</span><span class="params">(RateLimiter rateLimiter, JoinPoint point)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(rateLimiter.key());</span><br><span class="line">        <span class="keyword">if</span> (rateLimiter.limitType() == LimitType.IP)</span><br><span class="line">        &#123;</span><br><span class="line">            stringBuffer.append(IpUtils.getIpAddr(ServletUtils.getRequest())).append(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) point.getSignature();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> signature.getMethod();</span><br><span class="line">        Class&lt;?&gt; targetClass = method.getDeclaringClass();</span><br><span class="line">        stringBuffer.append(targetClass.getName()).append(<span class="string">&quot;-&quot;</span>).append(method.getName());</span><br><span class="line">        <span class="keyword">return</span> stringBuffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>总结：</p>
<p>1、lua脚本需要看懂：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="string">&quot;local key = KEYS[1]\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local count = tonumber(ARGV[1])\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local time = tonumber(ARGV[2])\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local current = redis.call(&#x27;get&#x27;, key);\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;if current and tonumber(current) &gt; count then\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    return tonumber(current);\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;end\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;current = redis.call(&#x27;incr&#x27;, key)\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;if tonumber(current) == 1 then\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;    redis.call(&#x27;expire&#x27;, key, time)\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;end\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;return tonumber(current);&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、默认是全局限流策略，也就是一个接口对所有用户同时限流。若改成IP限流，原理是拼接字符串的时候多拼上IP即可。</p>
<h1 id="三十六、Jetty代替Tomcat"><a href="#三十六、Jetty代替Tomcat" class="headerlink" title="三十六、Jetty代替Tomcat"></a>三十六、Jetty代替Tomcat</h1><ul>
<li>有的应用比较轻量级，不妨使用Jetty作为Web服务器。关于Jetty和Tomcat的比较，下面文章可以做参考：<ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45564548/article/details/109198409" >https://blog.csdn.net/weixin_45564548/article/details/109198409<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="http://t.zoukankan.com/kelelipeng-p-12059399.html" >http://t.zoukankan.com/kelelipeng-p-12059399.html<i class="fas fa-external-link-alt"></i></a></li>
</ul>
</li>
</ul>
<p>一：排除Tomcat，加入Jetty：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>二：yml中设置Jetty的常用属性：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jetty:</span></span><br><span class="line">   <span class="attr">threads:</span></span><br><span class="line">     <span class="attr">max:</span> <span class="number">800</span></span><br><span class="line">     <span class="attr">min:</span> <span class="number">50</span></span><br><span class="line">     <span class="attr">maxQueueCapacity:</span> <span class="number">1000</span></span><br></pre></td></tr></table></figure>

<h1 id="三十七、国际化"><a href="#三十七、国际化" class="headerlink" title="三十七、国际化"></a>三十七、国际化</h1><h2 id="1-为什么要国际化"><a href="#1-为什么要国际化" class="headerlink" title="1.为什么要国际化"></a>1.为什么要国际化</h2><ul>
<li>这只是部分网站的需求，想让自己的网站支持多种语言，方便外国友人一起浏览。实现中文英文随时切换。</li>
</ul>
<h2 id="2-后端国际化"><a href="#2-后端国际化" class="headerlink" title="2.后端国际化"></a>2.后端国际化</h2><h3 id="一、后端的resources下面的i18n添加："><a href="#一、后端的resources下面的i18n添加：" class="headerlink" title="一、后端的resources下面的i18n添加："></a>一、后端的resources下面的i18n添加：</h3><p>1、messages_en_US.properties，英文：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#错误消息</span></span><br><span class="line"><span class="attr">not.null</span>=<span class="string">* bi xu tian xie</span></span><br><span class="line"><span class="attr">user.jcaptcha.error</span>=<span class="string">captcha error</span></span><br><span class="line"><span class="attr">user.jcaptcha.expire</span>=<span class="string">captcha expire</span></span><br><span class="line"><span class="attr">user.not.exists</span>=<span class="string">user is no exist/password is error</span></span><br><span class="line"><span class="attr">user.password.not.match</span>=<span class="string">user is no exist/password is error</span></span><br><span class="line"><span class="attr">user.password.retry.limit.count</span>=<span class="string">user password retry &#123;0&#125; time(s)</span></span><br><span class="line"><span class="attr">user.password.retry.limit.exceed</span>=<span class="string">user password retry &#123;0&#125; time(s), your account is locked 10 minutes!</span></span><br><span class="line"><span class="attr">user.password.delete</span>=<span class="string">sorry, your account has been deleted!</span></span><br><span class="line"><span class="attr">user.blocked</span>=<span class="string">blocked</span></span><br><span class="line"><span class="attr">role.blocked</span>=<span class="string">blocked</span></span><br><span class="line"><span class="attr">user.logout.success</span>=<span class="string">logout success</span></span><br><span class="line"></span><br><span class="line"><span class="attr">length.not.valid</span>=<span class="string">length is from &#123;min&#125; to &#123;max&#125;!</span></span><br><span class="line"></span><br><span class="line"><span class="attr">user.username.not.valid</span>=<span class="string">* from 2 to 20, It is composed of Chinese characters, letters, numbers or underscores and must start with a non number</span></span><br><span class="line"><span class="attr">user.password.not.valid</span>=<span class="string">*  5-50 characters</span></span><br><span class="line"></span><br><span class="line"><span class="attr">user.email.not.valid</span>=<span class="string">email format error</span></span><br><span class="line"><span class="attr">user.mobile.phone.number.not.valid</span>=<span class="string">Mobile number format error</span></span><br><span class="line"><span class="attr">user.login.success</span>=<span class="string">login success</span></span><br><span class="line"><span class="attr">user.register.success</span>=<span class="string">login was successful</span></span><br><span class="line"><span class="attr">user.notfound</span>=<span class="string">Please login again</span></span><br><span class="line"><span class="attr">user.forcelogout</span>=<span class="string">The administrator forcibly logs out, please log in again</span></span><br><span class="line"><span class="attr">user.unknown.error</span>=<span class="string">Unknown error, please login again</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">##文件上传消息</span></span><br><span class="line"><span class="attr">upload.exceed.maxSize</span>=<span class="string">The size of the uploaded file exceeds the limit&lt; Br/&gt;The maximum file size allowed is:&#123;0&#125;MB！</span></span><br><span class="line"><span class="attr">upload.filename.exceed.length</span>=<span class="string">The maximum length of the uploaded file name is &#123;0&#125; characters</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">##权限</span></span><br><span class="line"><span class="attr">no.permission</span>=<span class="string">You do not have data permission, please contact the administrator to add permission [&#123;0&#125;]</span></span><br><span class="line"><span class="attr">no.create.permission</span>=<span class="string">You do not have permission to create data. Please contact the administrator to add permission [&#123;0&#125;]</span></span><br><span class="line"><span class="attr">no.update.permission</span>=<span class="string">You do not have permission to modify data. Please contact the administrator to add permission [&#123;0&#125;]</span></span><br><span class="line"><span class="attr">no.delete.permission</span>=<span class="string">You do not have permission to delete data. Please contact the administrator to add permission [&#123;0&#125;]</span></span><br><span class="line"><span class="attr">no.export.permission</span>=<span class="string">You do not have permission to export data. Please contact the administrator to add permission [&#123;0&#125;]</span></span><br><span class="line"><span class="attr">no.view.permission</span>=<span class="string">You do not have permission to view data. Please contact the administrator to add permission [&#123;0&#125;]</span></span><br></pre></td></tr></table></figure>

<p>2、messages_zh_CN.properties，中文：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#错误消息</span></span><br><span class="line"><span class="attr">not.null</span>=<span class="string">* 必须填写</span></span><br><span class="line"><span class="attr">user.jcaptcha.error</span>=<span class="string">验证码错误</span></span><br><span class="line"><span class="attr">user.jcaptcha.expire</span>=<span class="string">验证码已失效</span></span><br><span class="line"><span class="attr">user.not.exists</span>=<span class="string">用户不存在/密码错误</span></span><br><span class="line"><span class="attr">user.password.not.match</span>=<span class="string">用户不存在/密码错误</span></span><br><span class="line"><span class="attr">user.password.retry.limit.count</span>=<span class="string">密码输入错误&#123;0&#125;次</span></span><br><span class="line"><span class="attr">user.password.retry.limit.exceed</span>=<span class="string">密码输入错误&#123;0&#125;次，帐户锁定10分钟</span></span><br><span class="line"><span class="attr">user.password.delete</span>=<span class="string">对不起，您的账号已被删除</span></span><br><span class="line"><span class="attr">user.blocked</span>=<span class="string">用户已封禁，请联系管理员</span></span><br><span class="line"><span class="attr">role.blocked</span>=<span class="string">角色已封禁，请联系管理员</span></span><br><span class="line"><span class="attr">user.logout.success</span>=<span class="string">退出成功</span></span><br><span class="line"></span><br><span class="line"><span class="attr">length.not.valid</span>=<span class="string">长度必须在&#123;min&#125;到&#123;max&#125;个字符之间</span></span><br><span class="line"></span><br><span class="line"><span class="attr">user.username.not.valid</span>=<span class="string">* 2到20个汉字、字母、数字或下划线组成，且必须以非数字开头</span></span><br><span class="line"><span class="attr">user.password.not.valid</span>=<span class="string">* 5-50个字符</span></span><br><span class="line"></span><br><span class="line"><span class="attr">user.email.not.valid</span>=<span class="string">邮箱格式错误</span></span><br><span class="line"><span class="attr">user.mobile.phone.number.not.valid</span>=<span class="string">手机号格式错误</span></span><br><span class="line"><span class="attr">user.login.success</span>=<span class="string">登录成功</span></span><br><span class="line"><span class="attr">user.register.success</span>=<span class="string">注册成功</span></span><br><span class="line"><span class="attr">user.notfound</span>=<span class="string">请重新登录</span></span><br><span class="line"><span class="attr">user.forcelogout</span>=<span class="string">管理员强制退出，请重新登录</span></span><br><span class="line"><span class="attr">user.unknown.error</span>=<span class="string">未知错误，请重新登录</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">##文件上传消息</span></span><br><span class="line"><span class="attr">upload.exceed.maxSize</span>=<span class="string">上传的文件大小超出限制的文件大小！&lt;br/&gt;允许的文件最大大小是：&#123;0&#125;MB！</span></span><br><span class="line"><span class="attr">upload.filename.exceed.length</span>=<span class="string">上传的文件名最长&#123;0&#125;个字符</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">##权限</span></span><br><span class="line"><span class="attr">no.permission</span>=<span class="string">您没有数据的权限，请联系管理员添加权限 [&#123;0&#125;]</span></span><br><span class="line"><span class="attr">no.create.permission</span>=<span class="string">您没有创建数据的权限，请联系管理员添加权限 [&#123;0&#125;]</span></span><br><span class="line"><span class="attr">no.update.permission</span>=<span class="string">您没有修改数据的权限，请联系管理员添加权限 [&#123;0&#125;]</span></span><br><span class="line"><span class="attr">no.delete.permission</span>=<span class="string">您没有删除数据的权限，请联系管理员添加权限 [&#123;0&#125;]</span></span><br><span class="line"><span class="attr">no.export.permission</span>=<span class="string">您没有导出数据的权限，请联系管理员添加权限 [&#123;0&#125;]</span></span><br><span class="line"><span class="attr">no.view.permission</span>=<span class="string">您没有查看数据的权限，请联系管理员添加权限 [&#123;0&#125;]</span></span><br></pre></td></tr></table></figure>

<p>3、默认文件messages.properties保持不变。</p>
<h3 id="二：增加相关配置："><a href="#二：增加相关配置：" class="headerlink" title="二：增加相关配置："></a>二：增加相关配置：</h3><ul>
<li><strong>添加到ResourcesConfig类中</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义拦截规则</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(repeatSubmitInterceptor).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">        registry.addInterceptor(localeChangeInterceptor());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 国际化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LocaleChangeInterceptor <span class="title function_">localeChangeInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LocaleChangeInterceptor</span> <span class="variable">lci</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocaleChangeInterceptor</span>();</span><br><span class="line">        lci.setParamName(<span class="string">&quot;lang&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> lci;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LocaleResolver <span class="title function_">localeResolver</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">CookieLocaleResolver</span> <span class="variable">cookieLocaleResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CookieLocaleResolver</span>();</span><br><span class="line">        <span class="comment">// 默认语言</span></span><br><span class="line">        cookieLocaleResolver.setDefaultLocale(Locale.SIMPLIFIED_CHINESE);</span><br><span class="line">        <span class="keyword">return</span> cookieLocaleResolver;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>解释：</p>
<blockquote>
<p><strong>CookieLocaleResolver是为了从cookie中拿到当前的地区，以便获得当前的语言，默认是简体中文。如果没有设置默认值，那么会从请求头的Accept-Language中获得语言偏好。</strong></p>
<p><strong>LocaleChangeInterceptor是为了获得请求参数中的lang参数来确定地区，方便前端人员通过按钮来切换语言。</strong></p>
</blockquote>
</li>
</ul>
<h3 id="三：下面我们在request-js中的请求拦截器来携带lang参数："><a href="#三：下面我们在request-js中的请求拦截器来携带lang参数：" class="headerlink" title="三：下面我们在request.js中的请求拦截器来携带lang参数："></a>三：下面我们在request.js中的请求拦截器来携带lang参数：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> lang = <span class="title class_">Cookies</span>.<span class="title function_">get</span>(<span class="string">&quot;lang&quot;</span>);</span><br><span class="line"> <span class="keyword">if</span> (lang == <span class="literal">null</span> || lang === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">   lang = <span class="string">&quot;en_US&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (config.<span class="property">params</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">   config.<span class="property">params</span> = &#123;&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> config.<span class="property">params</span>.<span class="property">lang</span> = lang</span><br></pre></td></tr></table></figure>

<h3 id="四：request-js用到了cookie，我们在login-vue页面上来添加一个按钮来设置名为lang的cookie："><a href="#四：request-js用到了cookie，我们在login-vue页面上来添加一个按钮来设置名为lang的cookie：" class="headerlink" title="四：request.js用到了cookie，我们在login.vue页面上来添加一个按钮来设置名为lang的cookie："></a>四：request.js用到了cookie，我们在login.vue页面上来添加一个按钮来设置名为lang的cookie：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">class为login的div中的第一个元素：</span><br><span class="line"></span><br><span class="line">    &lt;div style=&quot;right: 0;top: 0;position: absolute;&quot;&gt;</span><br><span class="line">      &lt;el-switch</span><br><span class="line">        v-model=&quot;lang&quot;</span><br><span class="line">        active-color=&quot;#13ce66&quot;</span><br><span class="line">        inactive-color=&quot;#ff4949&quot;&gt;</span><br><span class="line">      &lt;/el-switch&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">data：</span><br><span class="line">      lang: true,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">watch：</span><br><span class="line"></span><br><span class="line">    lang: &#123;</span><br><span class="line">      handler: function (newValue, oldValue) &#123;</span><br><span class="line">        console.log(newValue, oldValue)</span><br><span class="line">        if (newValue === true) &#123;</span><br><span class="line">          Cookies.set(&quot;lang&quot;, &quot;zh_CN&quot;)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          Cookies.set(&quot;lang&quot;, &quot;en_US&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">created：</span><br><span class="line"></span><br><span class="line">    this.getLang();</span><br><span class="line"></span><br><span class="line">methods：</span><br><span class="line"></span><br><span class="line">    getLang() &#123;</span><br><span class="line">      let lang = Cookies.get(&quot;lang&quot;)</span><br><span class="line">      if (lang == null || lang === &#x27;&#x27;) &#123;</span><br><span class="line">        Cookies.set(&quot;lang&quot;, &quot;zh_CN&quot;)</span><br><span class="line">        this.lang = true  //中文</span><br><span class="line">      &#125;</span><br><span class="line">      if (lang === &#x27;zh_CN&#x27;) &#123;</span><br><span class="line">        this.lang = true;</span><br><span class="line">      &#125; else if (lang === &#x27;en_US&#x27;) &#123;</span><br><span class="line">        this.lang = false;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3-前端国际化"><a href="#3-前端国际化" class="headerlink" title="3.前端国际化"></a>3.前端国际化</h2><h3 id="一：安装依赖："><a href="#一：安装依赖：" class="headerlink" title="一：安装依赖："></a>一：安装依赖：</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install vue-i18n@<span class="number">8</span>   //因为用的Vue2，所以不能用<span class="number">9</span>版本</span><br></pre></td></tr></table></figure>

<p>二：src目录下创建lang目录，存放国际化文件。此处包含三个文件，分别是 index.js zh.js en.js。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">VueI18</span>n <span class="keyword">from</span> <span class="string">&#x27;vue-i18n&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Cookies</span> <span class="keyword">from</span> <span class="string">&#x27;js-cookie&#x27;</span></span><br><span class="line"><span class="keyword">import</span> elementEnLocale <span class="keyword">from</span> <span class="string">&#x27;element-ui/lib/locale/lang/en&#x27;</span> <span class="comment">// element-ui lang</span></span><br><span class="line"><span class="keyword">import</span> elementZhLocale <span class="keyword">from</span> <span class="string">&#x27;element-ui/lib/locale/lang/zh-CN&#x27;</span><span class="comment">// element-ui lang</span></span><br><span class="line"><span class="keyword">import</span> enLocale <span class="keyword">from</span> <span class="string">&#x27;./en&#x27;</span></span><br><span class="line"><span class="keyword">import</span> zhLocale <span class="keyword">from</span> <span class="string">&#x27;./zh&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">VueI18</span>n)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> messages = &#123;</span><br><span class="line">  <span class="attr">en_US</span>: &#123;</span><br><span class="line">    ...enLocale,</span><br><span class="line">    ...elementEnLocale</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">zh_CN</span>: &#123;</span><br><span class="line">    ...zhLocale,</span><br><span class="line">    ...elementZhLocale</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> i18n = <span class="keyword">new</span> <span class="title class_">VueI18</span>n(&#123;</span><br><span class="line">  <span class="comment">// 设置语言 选项 en | zh</span></span><br><span class="line">  <span class="attr">locale</span>: <span class="title class_">Cookies</span>.<span class="title function_">get</span>(<span class="string">&#x27;lang&#x27;</span>) || <span class="string">&#x27;zh_CN&#x27;</span>,</span><br><span class="line">  <span class="comment">// 设置文本内容</span></span><br><span class="line">  messages</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> i18n</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// zh.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">login</span>: &#123;</span><br><span class="line">    <span class="attr">rememberMe</span>:<span class="string">&quot;记住密码&quot;</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;若依后台管理系统&#x27;</span>,</span><br><span class="line">    <span class="attr">logIn</span>: <span class="string">&#x27;登录&#x27;</span>,</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;账号&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;密码&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">tagsView</span>: &#123;</span><br><span class="line">    <span class="attr">refresh</span>: <span class="string">&#x27;刷新&#x27;</span>,</span><br><span class="line">    <span class="attr">close</span>: <span class="string">&#x27;关闭&#x27;</span>,</span><br><span class="line">    <span class="attr">closeOthers</span>: <span class="string">&#x27;关闭其它&#x27;</span>,</span><br><span class="line">    <span class="attr">closeAll</span>: <span class="string">&#x27;关闭所有&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">settings</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;系统布局配置&#x27;</span>,</span><br><span class="line">    <span class="attr">theme</span>: <span class="string">&#x27;主题色&#x27;</span>,</span><br><span class="line">    <span class="attr">tagsView</span>: <span class="string">&#x27;开启 Tags-View&#x27;</span>,</span><br><span class="line">    <span class="attr">fixedHeader</span>: <span class="string">&#x27;固定 Header&#x27;</span>,</span><br><span class="line">    <span class="attr">sidebarLogo</span>: <span class="string">&#x27;侧边栏 Logo&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// en.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">login</span>: &#123;</span><br><span class="line">    <span class="attr">rememberMe</span>:<span class="string">&quot;Remember Me&quot;</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;RuoYi Login Form&#x27;</span>,</span><br><span class="line">    <span class="attr">logIn</span>: <span class="string">&#x27;Log in&#x27;</span>,</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;Username&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;Password&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">tagsView</span>: &#123;</span><br><span class="line">    <span class="attr">refresh</span>: <span class="string">&#x27;Refresh&#x27;</span>,</span><br><span class="line">    <span class="attr">close</span>: <span class="string">&#x27;Close&#x27;</span>,</span><br><span class="line">    <span class="attr">closeOthers</span>: <span class="string">&#x27;Close Others&#x27;</span>,</span><br><span class="line">    <span class="attr">closeAll</span>: <span class="string">&#x27;Close All&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">settings</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;Page style setting&#x27;</span>,</span><br><span class="line">    <span class="attr">theme</span>: <span class="string">&#x27;Theme Color&#x27;</span>,</span><br><span class="line">    <span class="attr">tagsView</span>: <span class="string">&#x27;Open Tags-View&#x27;</span>,</span><br><span class="line">    <span class="attr">fixedHeader</span>: <span class="string">&#x27;Fixed Header&#x27;</span>,</span><br><span class="line">    <span class="attr">sidebarLogo</span>: <span class="string">&#x27;Sidebar Logo&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="三：修改main-js"><a href="#三：修改main-js" class="headerlink" title="三：修改main.js:"></a>三：修改main.js:</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> i18n <span class="keyword">from</span> <span class="string">&#x27;./lang&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// use添加i18n</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Element</span>, &#123;</span><br><span class="line">  <span class="attr">size</span>: <span class="title class_">Cookies</span>.<span class="title function_">get</span>(<span class="string">&#x27;size&#x27;</span>) || <span class="string">&#x27;medium&#x27;</span>, <span class="comment">// set element-ui default size</span></span><br><span class="line">  <span class="attr">i18n</span>: <span class="function">(<span class="params">key, value</span>) =&gt;</span> i18n.<span class="title function_">t</span>(key, value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  router,</span><br><span class="line">  store,</span><br><span class="line">  i18n,</span><br><span class="line">  <span class="attr">render</span>: <span class="function"><span class="params">h</span> =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="四：在src-x2F-store-x2F-getters-js中添加language："><a href="#四：在src-x2F-store-x2F-getters-js中添加language：" class="headerlink" title="四：在src&#x2F;store&#x2F;getters.js中添加language："></a>四：在src&#x2F;store&#x2F;getters.js中添加language：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">language</span>: <span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">app</span>.<span class="property">language</span>,</span><br></pre></td></tr></table></figure>

<h3 id="五：在src-x2F-store-x2F-modules-x2F-app-js中增量添加i18n："><a href="#五：在src-x2F-store-x2F-modules-x2F-app-js中增量添加i18n：" class="headerlink" title="五：在src&#x2F;store&#x2F;modules&#x2F;app.js中增量添加i18n："></a>五：在src&#x2F;store&#x2F;modules&#x2F;app.js中增量添加i18n：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="attr">sidebar</span>: &#123;</span><br><span class="line">    <span class="attr">opened</span>: <span class="title class_">Cookies</span>.<span class="title function_">get</span>(<span class="string">&#x27;sidebarStatus&#x27;</span>) ? !!+<span class="title class_">Cookies</span>.<span class="title function_">get</span>(<span class="string">&#x27;sidebarStatus&#x27;</span>) : <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">withoutAnimation</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">hide</span>: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">device</span>: <span class="string">&#x27;desktop&#x27;</span>,</span><br><span class="line">  <span class="attr">size</span>: <span class="title class_">Cookies</span>.<span class="title function_">get</span>(<span class="string">&#x27;size&#x27;</span>) || <span class="string">&#x27;medium&#x27;</span>,</span><br><span class="line">  <span class="attr">language</span>: <span class="title class_">Cookies</span>.<span class="title function_">get</span>(<span class="string">&#x27;lang&#x27;</span>) || <span class="string">&#x27;zh_CN&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mutations：</span><br><span class="line">  <span class="attr">SET_LANGUAGE</span>: <span class="function">(<span class="params">state, language</span>) =&gt;</span> &#123;</span><br><span class="line">    state.<span class="property">language</span> = language</span><br><span class="line">    <span class="title class_">Cookies</span>.<span class="title function_">set</span>(<span class="string">&#x27;lang&#x27;</span>, language)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">actions：</span><br><span class="line">  <span class="title function_">setLanguage</span>(<span class="params">&#123; commit &#125;, language</span>) &#123;</span><br><span class="line">    <span class="title function_">commit</span>(<span class="string">&#x27;SET_LANGUAGE&#x27;</span>, language)</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="六：在src-x2F-components-x2F-LangSelect-x2F-index-vue中创建国际化组件："><a href="#六：在src-x2F-components-x2F-LangSelect-x2F-index-vue中创建国际化组件：" class="headerlink" title="六：在src&#x2F;components&#x2F;LangSelect&#x2F; index.vue中创建国际化组件："></a>六：在src&#x2F;components&#x2F;LangSelect&#x2F; index.vue中创建国际化组件：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-dropdown trigger=&quot;click&quot; class=&quot;international&quot; @command=&quot;handleSetLanguage&quot;&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;svg-icon class-name=&quot;international-icon&quot; icon-class=&quot;language&quot; /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;el-dropdown-menu slot=&quot;dropdown&quot;&gt;</span><br><span class="line">      &lt;el-dropdown-item :disabled=&quot;language===&#x27;zh_CN&#x27;&quot; command=&quot;zh_CN&quot;&gt;</span><br><span class="line">        中文</span><br><span class="line">      &lt;/el-dropdown-item&gt;</span><br><span class="line">      &lt;el-dropdown-item :disabled=&quot;language===&#x27;en_US&#x27;&quot; command=&quot;en_US&quot;&gt;</span><br><span class="line">        English</span><br><span class="line">      &lt;/el-dropdown-item&gt;</span><br><span class="line">    &lt;/el-dropdown-menu&gt;</span><br><span class="line">  &lt;/el-dropdown&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  computed: &#123;</span><br><span class="line">    language() &#123;</span><br><span class="line">      return this.$store.getters.language</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handleSetLanguage(lang) &#123;</span><br><span class="line">      this.$i18n.locale = lang</span><br><span class="line">      this.$store.dispatch(&#x27;app/setLanguage&#x27;, lang)</span><br><span class="line">      this.$message(&#123;</span><br><span class="line">        message: &#x27;设置语言成功&#x27;,</span><br><span class="line">        type: &#x27;success&#x27;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="七：登录界面的国际化："><a href="#七：登录界面的国际化：" class="headerlink" title="七：登录界面的国际化："></a>七：登录界面的国际化：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;login&quot;&gt;</span><br><span class="line">    &lt;div style=&quot;right: 0;top: 0;position: absolute;&quot;&gt;</span><br><span class="line">      &lt;lang-select /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;el-form ref=&quot;loginForm&quot; :model=&quot;loginForm&quot; :rules=&quot;loginRules&quot; class=&quot;login-form&quot;&gt;</span><br><span class="line">      &lt;h3 class=&quot;title&quot;&gt;&#123;&#123; $t(&#x27;login.title&#x27;) &#125;&#125;&lt;/h3&gt;</span><br><span class="line">      &lt;el-form-item prop=&quot;username&quot;&gt;</span><br><span class="line">        &lt;el-input</span><br><span class="line">          v-model=&quot;loginForm.username&quot;</span><br><span class="line">          type=&quot;text&quot;</span><br><span class="line">          auto-complete=&quot;off&quot;</span><br><span class="line">          :placeholder=&quot;$t(&#x27;login.username&#x27;)&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;svg-icon slot=&quot;prefix&quot; icon-class=&quot;user&quot; class=&quot;el-input__icon input-icon&quot;/&gt;</span><br><span class="line">        &lt;/el-input&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item prop=&quot;password&quot;&gt;</span><br><span class="line">        &lt;el-input</span><br><span class="line">          v-model=&quot;loginForm.password&quot;</span><br><span class="line">          type=&quot;password&quot;</span><br><span class="line">          auto-complete=&quot;off&quot;</span><br><span class="line">          :placeholder=&quot;$t(&#x27;login.password&#x27;)&quot;</span><br><span class="line">          @keyup.enter.native=&quot;handleLogin&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;svg-icon slot=&quot;prefix&quot; icon-class=&quot;password&quot; class=&quot;el-input__icon input-icon&quot;/&gt;</span><br><span class="line">        &lt;/el-input&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item prop=&quot;code&quot; v-if=&quot;captchaOnOff&quot;&gt;</span><br><span class="line">        &lt;el-input</span><br><span class="line">          v-model=&quot;loginForm.code&quot;</span><br><span class="line">          auto-complete=&quot;off&quot;</span><br><span class="line">          placeholder=&quot;验证码&quot;</span><br><span class="line">          style=&quot;width: 63%&quot;</span><br><span class="line">          @keyup.enter.native=&quot;handleLogin&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;svg-icon slot=&quot;prefix&quot; icon-class=&quot;validCode&quot; class=&quot;el-input__icon input-icon&quot;/&gt;</span><br><span class="line">        &lt;/el-input&gt;</span><br><span class="line">        &lt;div class=&quot;login-code&quot;&gt;</span><br><span class="line">          &lt;img :src=&quot;codeUrl&quot; @click=&quot;getCode&quot; class=&quot;login-code-img&quot;/&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-checkbox v-model=&quot;loginForm.rememberMe&quot; style=&quot;margin:0px 0px 25px 0px;&quot;&gt;&#123;&#123;</span><br><span class="line">          $t(&#x27;login.rememberMe&#x27;)</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      &lt;/el-checkbox&gt;</span><br><span class="line">      &lt;el-form-item style=&quot;width:100%;&quot;&gt;</span><br><span class="line">        &lt;el-button</span><br><span class="line">          :loading=&quot;loading&quot;</span><br><span class="line">          size=&quot;medium&quot;</span><br><span class="line">          type=&quot;primary&quot;</span><br><span class="line">          style=&quot;width:100%;&quot;</span><br><span class="line">          @click.native.prevent=&quot;handleLogin&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;span v-if=&quot;!loading&quot;&gt;&#123;&#123; $t(&#x27;login.logIn&#x27;) &#125;&#125;&lt;/span&gt;</span><br><span class="line">          &lt;span v-else&gt;登 录 中...&lt;/span&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/el-button&gt;</span><br><span class="line">        &lt;div style=&quot;float: right;&quot; v-if=&quot;register&quot;&gt;</span><br><span class="line">          &lt;router-link class=&quot;link-type&quot; :to=&quot;&#x27;/register&#x27;&quot;&gt;立即注册&lt;/router-link&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div style=&quot;margin-top: 30px;&quot;&gt;</span><br><span class="line">          &lt;el-divider&gt;</span><br><span class="line">            其他方式登录</span><br><span class="line">          &lt;/el-divider&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div style=&quot;height: 32px;width: 100%;position: relative;&quot;&gt;</span><br><span class="line">          &lt;div style=&quot;width: 32px;height: 32px;cursor: pointer;position: absolute;left: 40%;&quot; title=&quot;利用Gitee登录&quot;</span><br><span class="line">               @click=&quot;giteeLogin&quot;&gt;</span><br><span class="line">            &lt;img style=&quot;height: 100%;width: 100%;&quot; src=&quot;../assets/logo/gitee.png&quot;&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div style=&quot;width: 32px;height: 32px;cursor: pointer;position: absolute;left: 50%;&quot;</span><br><span class="line">               title=&quot;利用QQ登录&quot; @click=&quot;qqLogin&quot;&gt;</span><br><span class="line">            &lt;img style=&quot;height: 100%;width: 100%;&quot; src=&quot;../assets/logo/qq.png&quot;&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">    &lt;/el-form&gt;</span><br><span class="line">    &lt;!--  底部  --&gt;</span><br><span class="line">    &lt;div class=&quot;el-login-footer&quot;&gt;</span><br><span class="line">      &lt;span&gt;Copyright © 2021-2022 wangqingjiang All Rights Reserved.&lt;/span&gt;</span><br><span class="line">      &lt;br&gt;</span><br><span class="line">      &lt;a href=&quot;https://beian.miit.gov.cn/&quot;&gt;</span><br><span class="line">        &lt;span&gt;蜀ICP备2021028494号&lt;/span&gt;</span><br><span class="line">      &lt;/a&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;getCodeImg, PreLoginByGitee&#125; from &quot;@/api/login&quot;;</span><br><span class="line">import Cookies from &quot;js-cookie&quot;;</span><br><span class="line">import &#123;decrypt, encrypt&#125; from &#x27;@/utils/jsencrypt&#x27;</span><br><span class="line">import LangSelect from &quot;@/components/LangSelect&quot;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;Login&quot;,</span><br><span class="line">  components: &#123;LangSelect&#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      codeUrl: &quot;&quot;,</span><br><span class="line">      loginForm: &#123;</span><br><span class="line">        username: &quot;&quot;,</span><br><span class="line">        password: &quot;&quot;,</span><br><span class="line">        rememberMe: false,</span><br><span class="line">        code: &quot;&quot;,</span><br><span class="line">        uuid: &quot;&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      loginRules: &#123;</span><br><span class="line">        username: [</span><br><span class="line">          &#123;required: true, trigger: &quot;blur&quot;, message: &quot;请输入您的账号&quot;&#125;</span><br><span class="line">        ],</span><br><span class="line">        password: [</span><br><span class="line">          &#123;required: true, trigger: &quot;blur&quot;, message: &quot;请输入您的密码&quot;&#125;</span><br><span class="line">        ],</span><br><span class="line">        code: [&#123;required: true, trigger: &quot;change&quot;, message: &quot;请输入验证码&quot;&#125;]</span><br><span class="line">      &#125;,</span><br><span class="line">      loading: false,</span><br><span class="line">      // 验证码开关</span><br><span class="line">      captchaOnOff: true,</span><br><span class="line">      // 注册开关</span><br><span class="line">      register: true,</span><br><span class="line">      redirect: undefined</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  watch: &#123;</span><br><span class="line">    $route: &#123;</span><br><span class="line">      handler: function (route) &#123;</span><br><span class="line">        this.redirect = route.query &amp;&amp; route.query.redirect;</span><br><span class="line">      &#125;,</span><br><span class="line">      immediate: true</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    this.getCode();</span><br><span class="line">    this.getCookie();</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    giteeLogin() &#123;</span><br><span class="line">      PreLoginByGitee().then(res =&gt; &#123;</span><br><span class="line">        Cookies.set(&quot;user-uuid&quot;, res.uuid)</span><br><span class="line">        window.location = res.authorizeUrl</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    qqLogin() &#123;</span><br><span class="line">      this.$message.info(&quot;暂不支持QQ登录&quot;)</span><br><span class="line">    &#125;,</span><br><span class="line">    getCode() &#123;</span><br><span class="line">      getCodeImg().then(res =&gt; &#123;</span><br><span class="line">        this.captchaOnOff = res.captchaOnOff === undefined ? true : res.captchaOnOff;</span><br><span class="line">        if (this.captchaOnOff) &#123;</span><br><span class="line">          this.codeUrl = &quot;data:image/gif;base64,&quot; + res.img;</span><br><span class="line">          this.loginForm.uuid = res.uuid;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    getCookie() &#123;</span><br><span class="line">      const username = Cookies.get(&quot;username&quot;);</span><br><span class="line">      const password = Cookies.get(&quot;password&quot;);</span><br><span class="line">      const rememberMe = Cookies.get(&#x27;rememberMe&#x27;)</span><br><span class="line">      this.loginForm = &#123;</span><br><span class="line">        username: username === undefined ? this.loginForm.username : username,</span><br><span class="line">        password: password === undefined ? this.loginForm.password : decrypt(password),</span><br><span class="line">        rememberMe: rememberMe === undefined ? false : Boolean(rememberMe)</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    handleLogin() &#123;</span><br><span class="line">      this.$refs.loginForm.validate(valid =&gt; &#123;</span><br><span class="line">        if (valid) &#123;</span><br><span class="line">          this.loading = true;</span><br><span class="line">          if (this.loginForm.rememberMe) &#123;</span><br><span class="line">            Cookies.set(&quot;username&quot;, this.loginForm.username, &#123;expires: 30&#125;);</span><br><span class="line">            Cookies.set(&quot;password&quot;, encrypt(this.loginForm.password), &#123;expires: 30&#125;);</span><br><span class="line">            Cookies.set(&#x27;rememberMe&#x27;, this.loginForm.rememberMe, &#123;expires: 30&#125;);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            Cookies.remove(&quot;username&quot;);</span><br><span class="line">            Cookies.remove(&quot;password&quot;);</span><br><span class="line">            Cookies.remove(&#x27;rememberMe&#x27;);</span><br><span class="line">          &#125;</span><br><span class="line">          this.$store.dispatch(&quot;Login&quot;, this.loginForm).then(() =&gt; &#123;</span><br><span class="line">            this.$router.push(&#123;path: this.redirect || &quot;/&quot;&#125;).catch(() =&gt; &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;).catch(() =&gt; &#123;</span><br><span class="line">            this.loading = false;</span><br><span class="line">            if (this.captchaOnOff) &#123;</span><br><span class="line">              this.getCode();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style rel=&quot;stylesheet/scss&quot; lang=&quot;scss&quot;&gt;</span><br><span class="line">.login &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: center;</span><br><span class="line">  align-items: center;</span><br><span class="line">  height: 100%;</span><br><span class="line">  background-image: url(&quot;../assets/images/login-background.jpg&quot;);</span><br><span class="line">  background-size: cover;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.title &#123;</span><br><span class="line">  margin: 0px auto 30px auto;</span><br><span class="line">  text-align: center;</span><br><span class="line">  color: #707070;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login-form &#123;</span><br><span class="line">  border-radius: 6px;</span><br><span class="line">  background: #ffffff;</span><br><span class="line">  width: 400px;</span><br><span class="line">  padding: 25px 25px 5px 25px;</span><br><span class="line"></span><br><span class="line">  .el-input &#123;</span><br><span class="line">    height: 38px;</span><br><span class="line"></span><br><span class="line">    input &#123;</span><br><span class="line">      height: 38px;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .input-icon &#123;</span><br><span class="line">    height: 39px;</span><br><span class="line">    width: 14px;</span><br><span class="line">    margin-left: 2px;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login-tip &#123;</span><br><span class="line">  font-size: 13px;</span><br><span class="line">  text-align: center;</span><br><span class="line">  color: #bfbfbf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login-code &#123;</span><br><span class="line">  width: 33%;</span><br><span class="line">  height: 38px;</span><br><span class="line">  float: right;</span><br><span class="line"></span><br><span class="line">  img &#123;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    vertical-align: middle;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.el-login-footer &#123;</span><br><span class="line">  height: 50px;</span><br><span class="line">  line-height: 20px;</span><br><span class="line">  position: fixed;</span><br><span class="line">  bottom: 0;</span><br><span class="line">  width: 100%;</span><br><span class="line">  text-align: center;</span><br><span class="line">  color: #fff;</span><br><span class="line">  font-family: Arial;</span><br><span class="line">  font-size: 12px;</span><br><span class="line">  letter-spacing: 1px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.login-code-img &#123;</span><br><span class="line">  height: 38px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>删除在后端国际化的时候在login.vue写的国际化切换。换成前端ry写的国际化组件。如此，就可以随意调节中英文切换了，就像下面这个图一样：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306271402578.png"
                      alt="图片"
                ></p>
<ul>
<li>此时，一个调节会同时触发前后端同时国际化。前端国际化写法：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">普通文本使用方式： &#123;&#123; $t(<span class="string">&#x27;login.title&#x27;</span>) &#125;&#125;</span><br><span class="line">标签内使用方式：   :placeholder=<span class="string">&quot;$t(&#x27;login.password&#x27;)&quot;</span></span><br><span class="line">js内使用方式       <span class="variable language_">this</span>.$t(<span class="string">&#x27;login.user.password.not.match&#x27;</span>)</span><br></pre></td></tr></table></figure>


        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post title：Java实习之RuoYi-Vue</li>
        <li>Post author：Fang</li>
        <li>Create time：2023-06-13 09:54:33</li>
        <li>
            Post link：https://ainianxu.github.io/2023/06/13/Java实习之RuoYi-Vue/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E5%AE%9E%E4%B9%A0/">#实习</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2023/06/27/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95%E4%B9%8B%E5%85%AB%E8%82%A1%E6%96%87/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">前端面试之八股文</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2023/06/12/Java%E5%9F%BA%E7%A1%80%E4%B9%8BString%E3%80%81ArrayList/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Java基础之String、ArrayList</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;Comments</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'loa9BVbgmyFLwBMHhg1Cycx1-gzGzoHsz',
                    appKey: '47pIz6ewIXRi5251WyfUpQOB',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情吐槽吧~',
                    lang: 'en'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Fang';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>
              -
            
            2023&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Fang</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.4</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%90%8E%E7%AB%AF%E5%9C%A8%E6%9C%AC%E5%9C%B0%E8%BF%90%E8%A1%8C"><span class="nav-number">1.</span> <span class="nav-text">一、后端在本地运行</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%B3%BB%E7%BB%9F%E9%9C%80%E6%B1%82"><span class="nav-number">1.1.</span> <span class="nav-text">1.系统需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%B0%86%E9%A1%B9%E7%9B%AE%E5%AF%BC%E5%85%A5IDEA"><span class="nav-number">1.2.</span> <span class="nav-text">2.将项目导入IDEA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.3.</span> <span class="nav-text">3.项目结构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF"><span class="nav-number">2.</span> <span class="nav-text">二、部署前端</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%B0%86%E9%A1%B9%E7%9B%AE%E5%AF%BC%E5%85%A5IDEA"><span class="nav-number">2.1.</span> <span class="nav-text">1.将项目导入IDEA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">2.2.</span> <span class="nav-text">2.项目结构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%89%8D%E7%AB%AFrequest-js%E5%AF%B9axios%E7%9A%84%E5%B0%81%E8%A3%85%E7%90%86%E8%A7%A3%E5%92%8C%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">三、前端request.js对axios的封装理解和基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Get"><span class="nav-number">3.1.</span> <span class="nav-text">1.Get</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Post"><span class="nav-number">3.2.</span> <span class="nav-text">2.Post</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%A2%84%E9%98%B2%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4%E5%BC%80%E5%85%B3"><span class="nav-number">3.3.</span> <span class="nav-text">3.预防重复提交开关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%93%8D%E5%BA%94%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">3.4.</span> <span class="nav-text">4.响应拦截器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E9%80%9A%E7%94%A8%E4%B8%8B%E8%BD%BD%E6%96%B9%E6%B3%95%E5%89%8D%E6%AE%B5%E4%BB%A3%E7%A0%81"><span class="nav-number">3.5.</span> <span class="nav-text">5.通用下载方法前段代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B-%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E5%B1%95%E7%A4%BA-%E4%BB%85%E4%BB%85%E4%BB%8ERedis%E5%8F%96%E4%B8%80%E4%B8%8B%E6%95%B0%E6%8D%AE%E5%81%9A%E5%B1%95%E7%A4%BA"><span class="nav-number">4.</span> <span class="nav-text">四.在线用户展示-仅仅从Redis取一下数据做展示</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E7%99%BB%E5%BD%95%E7%9A%84%E6%97%B6%E5%80%99%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%AD%98%E5%85%A5redis%E4%BB%A3%E7%A0%81%E5%9C%A8%E5%93%AA"><span class="nav-number">5.</span> <span class="nav-text">五、登录的时候用户信息存入redis代码在哪</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%BC%BA%E9%80%80%E7%94%A8%E6%88%B7"><span class="nav-number">6.</span> <span class="nav-text">六、强退用户</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E4%B8%8B%E8%BD%BD%E5%AD%97%E5%85%B8%E7%B1%BB%E5%9E%8B%E5%90%8E%E7%AB%AF%E4%B8%89%E5%8F%A5%E8%AF%9D%E5%9C%A8%E5%81%9A%E5%95%A5"><span class="nav-number">7.</span> <span class="nav-text">七、下载字典类型后端三句话在做啥</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E5%89%8D%E7%AB%AF%E5%90%91%E5%90%8E%E7%AB%AF%E4%BC%A0%E5%8F%82%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">8.</span> <span class="nav-text">八、前端向后端传参的方式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-RESTful"><span class="nav-number">8.1.</span> <span class="nav-text">1.RESTful</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%99%AE%E9%80%9A%E6%96%B9%E5%BC%8F"><span class="nav-number">8.2.</span> <span class="nav-text">2.普通方式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E5%BC%80%E5%85%B3%E5%8E%9F%E7%90%86%EF%BC%88%E9%AA%8C%E8%AF%81%E7%A0%81%E5%BC%80%E5%85%B3%E3%80%81IP%E5%BC%80%E5%85%B3%EF%BC%89"><span class="nav-number">9.</span> <span class="nav-text">九、开关原理（验证码开关、IP开关）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BC%80%E5%85%B3%E5%8E%9F%E7%90%86%EF%BC%88%E9%AA%8C%E8%AF%81%E7%A0%81%E5%BC%80%E5%85%B3%EF%BC%89"><span class="nav-number">9.1.</span> <span class="nav-text">1.开关原理（验证码开关）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%BC%80%E5%85%B3%E5%8E%9F%E7%90%86%EF%BC%88IP%E5%BC%80%E5%85%B3%EF%BC%89"><span class="nav-number">9.2.</span> <span class="nav-text">2.开关原理（IP开关）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E3%80%81%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%B8%83%E5%B1%80%E8%AF%A6%E8%A7%A3"><span class="nav-number">10.</span> <span class="nav-text">十、前端页面的布局详解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Vue-Devtools%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85"><span class="nav-number">10.1.</span> <span class="nav-text">1.Vue-Devtools工具安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%B8%83%E5%B1%80"><span class="nav-number">10.2.</span> <span class="nav-text">2.前端页面的布局</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5%E4%B8%80%EF%BC%9A%E4%B8%8D%E4%BE%9D%E8%B5%96Layout%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">10.2.1.</span> <span class="nav-text">情况一：不依赖Layout的情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5%E4%BA%8C%EF%BC%9A%E4%BE%9D%E8%B5%96Layout%E7%BB%84%E4%BB%B6"><span class="nav-number">10.2.2.</span> <span class="nav-text">情况二：依赖Layout组件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E5%A4%A9%E6%B0%94%E5%B0%8F%E6%A1%88%E4%BE%8B"><span class="nav-number">11.</span> <span class="nav-text">十一、天气小案例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%96%B0%E5%A2%9E%E5%B8%A6Layout%E7%BB%84%E4%BB%B6%E7%9A%84%E9%A1%B5%E9%9D%A2"><span class="nav-number">11.1.</span> <span class="nav-text">1.新增带Layout组件的页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%93%E6%B3%A8weather%E4%B8%9A%E5%8A%A1"><span class="nav-number">11.2.</span> <span class="nav-text">2.专注weather业务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81JWT"><span class="nav-number">12.</span> <span class="nav-text">十二、JWT</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%B7%A8%E5%9F%9F%E8%AE%A4%E8%AF%81%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">12.1.</span> <span class="nav-text">1.跨域认证的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-JWT-%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">12.2.</span> <span class="nav-text">2.JWT 的原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-JWT-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">12.3.</span> <span class="nav-text">3.JWT 的数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Header"><span class="nav-number">12.3.1.</span> <span class="nav-text">3.1 Header</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Payload"><span class="nav-number">12.3.2.</span> <span class="nav-text">3.2 Payload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-Signature"><span class="nav-number">12.3.3.</span> <span class="nav-text">3.3 Signature</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-Base64URL"><span class="nav-number">12.3.4.</span> <span class="nav-text">3.4 Base64URL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-JWT-%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">12.4.</span> <span class="nav-text">4.JWT 的使用方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-JWT-%E7%9A%84%E5%87%A0%E4%B8%AA%E7%89%B9%E7%82%B9"><span class="nav-number">12.5.</span> <span class="nav-text">5.JWT 的几个特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-ry%E6%98%AF%E6%80%8E%E4%B9%88%E8%B7%B5%E8%A1%8CJWT%E7%9A%84%E5%91%A2%EF%BC%9F"><span class="nav-number">12.6.</span> <span class="nav-text">6.ry是怎么践行JWT的呢？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%89%E3%80%81ry%E5%A6%82%E4%BD%95%E8%B7%B5%E8%A1%8CSpringSecurity%E7%94%A8%E4%BA%8E%E8%AE%A4%E8%AF%81"><span class="nav-number">13.</span> <span class="nav-text">十三、ry如何践行SpringSecurity用于认证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-SpringSecurity%E5%9F%BA%E7%A1%80"><span class="nav-number">13.1.</span> <span class="nav-text">1.SpringSecurity基础</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Ry%E6%98%AF%E5%A6%82%E4%BD%95%E8%B7%B5%E8%A1%8C%E8%BF%99%E5%A5%97%E8%A7%84%E5%88%99%EF%BC%9F"><span class="nav-number">13.2.</span> <span class="nav-text">2.Ry是如何践行这套规则？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-ry%E8%AE%A4%E8%AF%81%E5%87%BA%E7%8E%B0%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E7%9A%84%EF%BC%9F"><span class="nav-number">13.3.</span> <span class="nav-text">3.ry认证出现问题如何处理的？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%96%B0%E9%97%AE%E9%A2%98%EF%BC%9Apostman%E5%A6%82%E4%BD%95%E8%B0%83%E6%8E%A5%E5%8F%A3%EF%BC%9F"><span class="nav-number">13.4.</span> <span class="nav-text">4.新问题：postman如何调接口？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Swagger%E5%A5%BD%E5%83%8F%E4%B9%9F%E8%B0%83%E4%B8%8D%E9%80%9A"><span class="nav-number">13.5.</span> <span class="nav-text">5.Swagger好像也调不通</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81%E6%B7%B1%E5%85%A5%E8%AE%A4%E8%AF%81%E6%BA%90%E7%A0%81%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE"><span class="nav-number">14.</span> <span class="nav-text">十四、深入认证源码过滤器链</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%89%8B%E5%8A%A8%E4%BF%AE%E6%94%B9%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%92%8C%E8%AE%A4%E8%AF%86addFilterAfter%E6%96%B9%E6%B3%95"><span class="nav-number">14.1.</span> <span class="nav-text">1.手动修改过滤器链和认识addFilterAfter方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%89%8B%E5%8A%A8%E4%BF%AE%E6%94%B9%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%92%8C%E8%AE%A4%E8%AF%86addFilterAfter%E6%96%B9%E6%B3%95-1"><span class="nav-number">14.1.1.</span> <span class="nav-text">1.手动修改过滤器链和认识addFilterAfter方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%96%B0%E6%96%B9%E6%B3%95%EF%BC%9AaddFilterAfter"><span class="nav-number">14.1.2.</span> <span class="nav-text">2.新方法：addFilterAfter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%AE%89%E5%85%A8%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E6%9D%A1%E7%9A%84%E6%AF%8F%E4%B8%AA%E8%BF%87%E6%BB%A4%E5%99%A8%E4%BD%9C%E7%94%A8"><span class="nav-number">14.2.</span> <span class="nav-text">2.安全过滤器链条的每个过滤器作用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%BA%94%E3%80%81RBAC"><span class="nav-number">15.</span> <span class="nav-text">十五、RBAC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="nav-number">15.1.</span> <span class="nav-text">1.简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%BB%80%E4%B9%88%E6%98%AF%E9%A1%B5%E9%9D%A2%E6%9D%83%E9%99%90%E3%80%81%E6%8C%89%E9%92%AE%E6%9D%83%E9%99%90"><span class="nav-number">15.2.</span> <span class="nav-text">2.什么是页面权限、按钮权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%9D%83%E9%99%90%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F"><span class="nav-number">15.3.</span> <span class="nav-text">3.权限表现形式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-ry%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">15.4.</span> <span class="nav-text">4.ry如何进行权限控制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E5%85%AD%E3%80%81%E6%B7%B1%E5%85%A5%E6%BA%90%E7%A0%81%E7%90%86%E8%A7%A3%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">16.</span> <span class="nav-text">十六、深入源码理解权限控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BD%95%E6%97%B6%E8%8E%B7%E5%BE%97%E6%9D%83%E9%99%90"><span class="nav-number">16.1.</span> <span class="nav-text">1.何时获得权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%94%A8%E6%88%B7%E8%8F%9C%E5%8D%95%EF%BC%88%E9%A1%B5%E9%9D%A2%E6%9D%83%E9%99%90%EF%BC%89%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="nav-number">16.2.</span> <span class="nav-text">2.用户菜单（页面权限）的获取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%A1%B5%E9%9D%A2%E6%9D%83%E9%99%90%E8%A1%A5%E5%85%85"><span class="nav-number">16.3.</span> <span class="nav-text">3.页面权限补充</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-PreAuthorize-%E5%90%AF%E5%8A%A8%E5%A5%A5%E4%B9%89"><span class="nav-number">16.4.</span> <span class="nav-text">4.@PreAuthorize 启动奥义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-PreAuthorize-%E7%9A%84value%E6%96%B9%E6%B3%95%E5%A5%A5%E4%B9%89"><span class="nav-number">16.5.</span> <span class="nav-text">5.@PreAuthorize 的value方法奥义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E6%8C%89%E9%92%AE%E6%9D%83%E9%99%90%E5%9C%A8%E5%89%8D%E7%AB%AF%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F"><span class="nav-number">16.6.</span> <span class="nav-text">6.按钮权限在前端的表现形式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-v-hasPermi%E6%8C%87%E4%BB%A4%E5%A5%A5%E4%B9%89"><span class="nav-number">16.7.</span> <span class="nav-text">7.v-hasPermi指令奥义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E5%89%8D%E7%AB%AFdebug%EF%BC%8C%E7%A7%98%E5%A5%A5%E4%B9%89%C2%B7%E9%9C%87%E9%9B%B7%E5%89%8A"><span class="nav-number">16.8.</span> <span class="nav-text">8.前端debug，秘奥义·震雷削</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%83%E3%80%81%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E9%99%86"><span class="nav-number">17.</span> <span class="nav-text">十七、第三方登陆</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95"><span class="nav-number">17.1.</span> <span class="nav-text">1.第三方登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-JustAuth-%E5%A5%A5%E4%B9%89%C2%B7%E7%A9%BF%E9%A3%8E%E5%88%BA"><span class="nav-number">17.2.</span> <span class="nav-text">2.JustAuth 奥义·穿风刺</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E5%85%AB%E3%80%81%E6%96%B0%E5%BB%BA%E5%90%8E%E7%AB%AF%E6%A8%A1%E5%9D%97%E4%B8%8E%E5%8C%85%E5%90%8D%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="nav-number">18.</span> <span class="nav-text">十八、新建后端模块与包名的修改</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%8C%85%E5%90%8D%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="nav-number">18.1.</span> <span class="nav-text">1.包名的修改</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%90%8E%E7%AB%AF%E6%A8%A1%E5%9D%97%E7%9A%84%E6%96%B0%E5%BB%BA"><span class="nav-number">18.2.</span> <span class="nav-text">2.后端模块的新建</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B9%9D%E3%80%81-Anonymous%EF%BC%9F"><span class="nav-number">19.</span> <span class="nav-text">十九、@Anonymous？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Anonymous%E5%8E%9F%E7%90%86"><span class="nav-number">19.1.</span> <span class="nav-text">1.@Anonymous原理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E3%80%81%E5%89%8D%E7%AB%AF%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-number">20.</span> <span class="nav-text">二十、前端通用方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-tab%E5%AF%B9%E8%B1%A1"><span class="nav-number">20.1.</span> <span class="nav-text">1.$tab对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%89%93%E5%BC%80%E6%96%B0%E9%A1%B5%E9%9D%A2"><span class="nav-number">20.1.1.</span> <span class="nav-text">1.打开新页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BF%AE%E6%94%B9%E9%A1%B5%E7%AD%BE"><span class="nav-number">20.1.2.</span> <span class="nav-text">2.修改页签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%85%B3%E9%97%AD%E9%A1%B5%E7%AD%BE"><span class="nav-number">20.1.3.</span> <span class="nav-text">3.关闭页签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%88%B7%E6%96%B0%E9%A1%B5%E7%AD%BE"><span class="nav-number">20.1.4.</span> <span class="nav-text">4.刷新页签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%85%B3%E9%97%AD%E6%89%80%E6%9C%89%E9%A1%B5%E7%AD%BE"><span class="nav-number">20.1.5.</span> <span class="nav-text">5.关闭所有页签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E5%85%B3%E9%97%AD%E5%B7%A6%E4%BE%A7"><span class="nav-number">20.1.6.</span> <span class="nav-text">6.关闭左侧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E5%85%B3%E9%97%AD%E5%8F%B3%E4%BE%A7"><span class="nav-number">20.1.7.</span> <span class="nav-text">7.关闭右侧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E5%85%B3%E9%97%AD%E5%85%B6%E4%BB%96"><span class="nav-number">20.1.8.</span> <span class="nav-text">8.关闭其他</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-modal%E5%AF%B9%E8%B1%A1"><span class="nav-number">20.2.</span> <span class="nav-text">2.$modal对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%8F%90%E4%BE%9B%E6%88%90%E5%8A%9F%E3%80%81%E8%AD%A6%E5%91%8A%E5%92%8C%E9%94%99%E8%AF%AF%E7%AD%89%E5%8F%8D%E9%A6%88%E4%BF%A1%E6%81%AF"><span class="nav-number">20.2.1.</span> <span class="nav-text">1.提供成功、警告和错误等反馈信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8F%90%E4%BE%9B%E6%88%90%E5%8A%9F%E3%80%81%E8%AD%A6%E5%91%8A%E5%92%8C%E9%94%99%E8%AF%AF%E7%AD%89%E6%8F%90%E7%A4%BA%E4%BF%A1%E6%81%AF"><span class="nav-number">20.2.2.</span> <span class="nav-text">2.提供成功、警告和错误等提示信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8F%90%E4%BE%9B%E6%88%90%E5%8A%9F%E3%80%81%E8%AD%A6%E5%91%8A%E5%92%8C%E9%94%99%E8%AF%AF%E7%AD%89%E9%80%9A%E7%9F%A5%E4%BF%A1%E6%81%AF"><span class="nav-number">20.2.3.</span> <span class="nav-text">3.提供成功、警告和错误等通知信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%8F%90%E4%BE%9B%E7%A1%AE%E8%AE%A4%E7%AA%97%E4%BD%93%E4%BF%A1%E6%81%AF"><span class="nav-number">20.2.4.</span> <span class="nav-text">4.提供确认窗体信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%8F%90%E4%BE%9B%E9%81%AE%E7%BD%A9%E5%B1%82%E4%BF%A1%E6%81%AF"><span class="nav-number">20.2.5.</span> <span class="nav-text">5.提供遮罩层信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-auth%E5%AF%B9%E8%B1%A1"><span class="nav-number">20.3.</span> <span class="nav-text">3.$auth对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%AA%8C%E8%AF%81%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90"><span class="nav-number">20.3.1.</span> <span class="nav-text">1.验证用户权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%AA%8C%E8%AF%81%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2"><span class="nav-number">20.3.2.</span> <span class="nav-text">2.验证用户角色</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-cache%E5%AF%B9%E8%B1%A1"><span class="nav-number">20.4.</span> <span class="nav-text">4.$cache对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-download%E5%AF%B9%E8%B1%A1"><span class="nav-number">20.5.</span> <span class="nav-text">5.$download对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%A0%B9%E6%8D%AE%E5%90%8D%E7%A7%B0%E4%B8%8B%E8%BD%BDdownload%E8%B7%AF%E5%BE%84%E4%B8%8B%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">20.5.1.</span> <span class="nav-text">1.根据名称下载download路径下的文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%A0%B9%E6%8D%AE%E5%90%8D%E7%A7%B0%E4%B8%8B%E8%BD%BDupload%E8%B7%AF%E5%BE%84%E4%B8%8B%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">20.5.2.</span> <span class="nav-text">2.根据名称下载upload路径下的文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%A0%B9%E6%8D%AE%E8%AF%B7%E6%B1%82%E5%9C%B0%E5%9D%80%E4%B8%8B%E8%BD%BDzip%E5%8C%85"><span class="nav-number">20.5.3.</span> <span class="nav-text">3.根据请求地址下载zip包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%9B%B4%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%93%8D%E4%BD%9C"><span class="nav-number">20.5.4.</span> <span class="nav-text">4.更多文件下载操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E4%B8%80%E3%80%81token%E8%A1%A5%E5%85%85"><span class="nav-number">21.</span> <span class="nav-text">二十一、token补充</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-HTTP%EF%BC%9F"><span class="nav-number">21.1.</span> <span class="nav-text">1.HTTP？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%8D%E5%AE%89%E5%85%A8%E6%80%8E%E4%B9%88%E5%8A%9E%E5%91%90%EF%BC%9F"><span class="nav-number">21.2.</span> <span class="nav-text">2.不安全怎么办呐？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E4%BA%8C%E3%80%81%E5%88%86%E9%A1%B5%E5%89%8D%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="nav-number">22.</span> <span class="nav-text">二十二、分页前后端配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%88%86%E9%A1%B5%E7%9A%84%E5%89%8D%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="nav-number">22.1.</span> <span class="nav-text">1.分页的前端配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%90%8E%E7%AB%AF%E5%88%86%E9%A1%B5%E5%AE%9E%E7%8E%B0pagehelper"><span class="nav-number">22.2.</span> <span class="nav-text">2.后端分页实现pagehelper</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%86%E6%9E%90pagehelper%E6%BA%90%E7%A0%81"><span class="nav-number">22.2.1.</span> <span class="nav-text">1.分析pagehelper源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E6%9E%90ry%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8pagehelper"><span class="nav-number">22.2.2.</span> <span class="nav-text">2.分析ry如何使用pagehelper</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E4%B8%89%E3%80%81ry%E4%B8%AD%E7%9A%84Mybatis%E8%AF%A6%E8%A7%A3"><span class="nav-number">23.</span> <span class="nav-text">二十三、ry中的Mybatis详解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-mybatis%E5%92%8CSpringBoot%E7%BB%93%E5%90%88%E6%96%B9%E5%BC%8F"><span class="nav-number">23.1.</span> <span class="nav-text">1.mybatis和SpringBoot结合方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-mybatis-plus%E9%9B%86%E6%88%90"><span class="nav-number">23.2.</span> <span class="nav-text">2.mybatis-plus集成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%A7%A3%E9%87%8A%E7%96%91%E9%97%AE%EF%BC%9A"><span class="nav-number">23.3.</span> <span class="nav-text">3.解释疑问：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%B5%8B%E8%AF%95mybatis-plus"><span class="nav-number">23.4.</span> <span class="nav-text">4.测试mybatis-plus</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%8B%93%E5%B1%95%E5%AD%A6%E4%B9%A0"><span class="nav-number">23.5.</span> <span class="nav-text">5.拓展学习</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E5%9B%9B%E3%80%81%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E5%AE%9E%E7%8E%B0"><span class="nav-number">24.</span> <span class="nav-text">二十四、多数据源原理以及实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E5%AE%9E%E7%8E%B0"><span class="nav-number">24.1.</span> <span class="nav-text">1.多数据源原理以及实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%9C%A8%E4%BB%80%E4%B9%88%E5%9C%B0%E6%96%B9%E5%81%9A%E6%96%87%E7%AB%A0%EF%BC%9F"><span class="nav-number">24.2.</span> <span class="nav-text">2.多数据源在什么地方做文章？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-ry%E4%B8%AD%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%AE%9E%E8%B7%B5"><span class="nav-number">24.3.</span> <span class="nav-text">3.ry中多数据源实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E9%A6%96%E5%85%88%E6%98%AF%E5%87%86%E5%A4%87%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%BA%90%EF%BC%9A"><span class="nav-number">24.3.1.</span> <span class="nav-text">步骤一：首先是准备多个数据源：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A%E6%95%B4%E5%90%88%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%BA%90%EF%BC%9A"><span class="nav-number">24.3.2.</span> <span class="nav-text">步骤二：整合多个数据源：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9A%E5%9C%A8%E8%AF%B7%E6%B1%82%E6%97%B6%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E6%95%B0%E6%8D%AE%E6%BA%90%EF%BC%9A"><span class="nav-number">24.3.3.</span> <span class="nav-text">步骤三：在请求时选择合适的数据源：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E5%9B%9B%EF%BC%9ADynamicDataSourceContextHolder%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8F%98%E5%8C%96%E3%80%82"><span class="nav-number">24.3.4.</span> <span class="nav-text">步骤四：DynamicDataSourceContextHolder中的数据变化。</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E4%B8%89%E4%B8%AAMySQL%E6%95%B0%E6%8D%AE%E6%BA%90%E8%B5%B0%E8%B5%B7"><span class="nav-number">24.4.</span> <span class="nav-text">4.三个MySQL数据源走起</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%9B%9B%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="nav-number">24.5.</span> <span class="nav-text">5.四个数据源</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%BC%95%E5%85%A5SQL-Server%E9%A9%B1%E5%8A%A8%EF%BC%9A"><span class="nav-number">24.5.1.</span> <span class="nav-text">第一步：引入SQL Server驱动：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E4%BF%AE%E6%94%B9YML%EF%BC%9A"><span class="nav-number">24.5.2.</span> <span class="nav-text">第二步：修改YML：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E5%9C%A8DruidConfig%E4%B8%AD%E6%B3%A8%E5%85%A5%E6%95%B0%E6%8D%AE%E6%BA%90Bean%EF%BC%9A"><span class="nav-number">24.5.3.</span> <span class="nav-text">第三步：在DruidConfig中注入数据源Bean：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%9C%A8DruidConfig%E7%AC%AC%E5%9B%9B%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%BA%90%E8%A2%AB%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E8%AF%BB%E5%85%A5%EF%BC%9A"><span class="nav-number">24.5.4.</span> <span class="nav-text">第四步：在DruidConfig第四个数据源被动态数据源读入：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E4%BA%94%E3%80%81%E4%BA%8B%E5%8A%A1"><span class="nav-number">25.</span> <span class="nav-text">二十五、事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BA%8B%E5%8A%A1"><span class="nav-number">25.1.</span> <span class="nav-text">1.事务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%95%85%E6%84%8F%E5%9B%9E%E6%BB%9A%E4%BE%8B%E5%AD%90"><span class="nav-number">25.2.</span> <span class="nav-text">2.故意回滚例子</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E5%85%AD%E3%80%81%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90"><span class="nav-number">26.</span> <span class="nav-text">二十六、数据权限</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E7%AE%80%E4%BB%8B"><span class="nav-number">26.1.</span> <span class="nav-text">1.数据权限简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-ry%E4%B8%AD%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90"><span class="nav-number">26.2.</span> <span class="nav-text">2.ry中数据权限的实现分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%87%AA%E5%B7%B1%E6%89%80%E5%BB%BA%E7%AB%8B%E7%9A%84%E8%A1%A8%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">26.3.</span> <span class="nav-text">3.自己所建立的表实现数据权限控制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E4%B8%83%E3%80%81%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%BD%BF%E7%94%A8"><span class="nav-number">27.</span> <span class="nav-text">二十七、代码生成使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%EF%BC%88%E5%8D%95%E8%A1%A8%EF%BC%89"><span class="nav-number">27.1.</span> <span class="nav-text">1.代码生成（单表）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%8C%E5%BB%BA%E7%AB%8B%E6%95%B0%E6%8D%AE%E8%A1%A8%EF%BC%9A"><span class="nav-number">27.1.1.</span> <span class="nav-text">第一步，建立数据表：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%8C%E6%96%B0%E5%BB%BA%E7%9C%81%E4%BB%BD%E5%AD%97%E5%85%B8%EF%BC%88%E8%87%AA%E6%9C%89%E5%A6%99%E7%94%A8%EF%BC%89%EF%BC%9A"><span class="nav-number">27.1.2.</span> <span class="nav-text">第二步，新建省份字典（自有妙用）：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%8C%E5%A1%AB%E5%86%99%E7%94%9F%E6%88%90%E4%BF%A1%E6%81%AF%EF%BC%9A"><span class="nav-number">27.1.3.</span> <span class="nav-text">第三步，填写生成信息：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%8C%E6%8A%8A%E6%88%90%E5%8A%9F%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81%E6%94%BE%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BD%8D%E7%BD%AE%E3%80%82"><span class="nav-number">27.1.4.</span> <span class="nav-text">第四步，把成功生成的代码放到对应的位置。</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%A0%91%E8%A1%A8%E7%94%9F%E6%88%90"><span class="nav-number">27.2.</span> <span class="nav-text">2.树表生成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%8C%E5%BB%BA%E7%AB%8B%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%9A"><span class="nav-number">27.2.1.</span> <span class="nav-text">第一步，建立数据库：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%8C%E7%94%9F%E6%88%90%E5%B9%B6%E6%94%BE%E5%85%A5%E5%90%88%E9%80%82%E4%BD%8D%E7%BD%AE%EF%BC%9A"><span class="nav-number">27.2.2.</span> <span class="nav-text">第三步，生成并放入合适位置：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%BD%BF%E7%94%A8%EF%BC%88%E4%B8%BB%E5%AD%90%E8%A1%A8%EF%BC%89"><span class="nav-number">27.3.</span> <span class="nav-text">3.代码生成使用（主子表）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E5%85%AD%E3%80%81%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7"><span class="nav-number">28.</span> <span class="nav-text">二十六、服务监控</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E5%90%8E%E7%AB%AF"><span class="nav-number">28.1.</span> <span class="nav-text">1.服务监控后端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Vue%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">28.2.</span> <span class="nav-text">2.Vue生命周期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E5%89%8D%E7%AB%AF"><span class="nav-number">28.3.</span> <span class="nav-text">3.服务监控前端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-loading"><span class="nav-number">28.3.1.</span> <span class="nav-text">1.loading</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%A0%85%E6%A0%BC%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="nav-number">28.3.2.</span> <span class="nav-text">2.栅格（重点）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E4%B8%83%E3%80%81%E5%B8%B8%E8%A7%81%E6%96%87%E4%BB%B6%E7%9A%84%E5%9C%A8%E7%BA%BF%E9%A2%84%E8%A7%88"><span class="nav-number">29.</span> <span class="nav-text">二十七、常见文件的在线预览</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%AE%80%E4%BB%8B-1"><span class="nav-number">29.1.</span> <span class="nav-text">1.简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%9C%A8%E7%BA%BF%E9%A2%84%E8%A7%88docx%E6%96%87%E4%BB%B6%EF%BC%88Word%EF%BC%89"><span class="nav-number">29.2.</span> <span class="nav-text">2.在线预览docx文件（Word）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9C%A8%E7%BA%BF%E9%A2%84%E8%A7%88docx%E6%96%87%E4%BB%B6%EF%BC%88Word%EF%BC%89"><span class="nav-number">29.2.1.</span> <span class="nav-text">1.在线预览docx文件（Word）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%AB%98%E7%AB%AF%E9%A2%84%E8%A7%88%EF%BC%88URL%E5%86%99%E6%B4%BB%EF%BC%89"><span class="nav-number">29.2.2.</span> <span class="nav-text">2.高端预览（URL写活）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%9C%A8%E7%BA%BF%E9%A2%84%E8%A7%88xlsx%E6%96%87%E4%BB%B6%EF%BC%88Excel%EF%BC%89"><span class="nav-number">29.3.</span> <span class="nav-text">3.在线预览xlsx文件（Excel）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%9C%89%E7%82%B9%E4%B8%91%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="nav-number">29.3.1.</span> <span class="nav-text">1.有点丑的实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%A5%BD%E7%9C%8B%E4%B8%80%E7%82%B9%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="nav-number">29.3.2.</span> <span class="nav-text">2.好看一点的实现方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%9C%A8%E7%BA%BF%E9%A2%84%E8%A7%88PDF%E6%96%87%E4%BB%B6"><span class="nav-number">29.4.</span> <span class="nav-text">4.在线预览PDF文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB"><span class="nav-number">29.5.</span> <span class="nav-text">5.扩展阅读</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E5%85%AB%E3%80%81%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3Swagger"><span class="nav-number">30.</span> <span class="nav-text">二十八、系统接口Swagger</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Swagger"><span class="nav-number">30.1.</span> <span class="nav-text">1.Swagger</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E9%9C%80%E8%A6%81%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96%EF%BC%9A"><span class="nav-number">30.1.1.</span> <span class="nav-text">第一步需要引入依赖：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E9%9C%80%E8%A6%81%E5%A1%AB%E5%86%99%E9%85%8D%E7%BD%AE%EF%BC%9A"><span class="nav-number">30.1.2.</span> <span class="nav-text">第二步需要填写配置：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%E6%98%AF%E5%90%8E%E7%AB%AF%E6%94%BE%E8%A1%8C%EF%BC%9A"><span class="nav-number">30.1.3.</span> <span class="nav-text">第三步是后端放行：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%E6%98%AF%E5%9C%A8%E9%9C%80%E8%A6%81%E8%A2%AB%E8%AE%BF%E9%97%AE%E7%9A%84%E6%B7%BB%E5%8A%A0%E4%B8%8A%E7%9B%B8%E5%BA%94%E7%9A%84%E6%B3%A8%E8%A7%A3%EF%BC%9A"><span class="nav-number">30.1.4.</span> <span class="nav-text">第四步是在需要被访问的添加上相应的注解：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%8D%A2%E8%82%A4"><span class="nav-number">30.2.</span> <span class="nav-text">2.换肤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96%EF%BC%9A"><span class="nav-number">30.2.1.</span> <span class="nav-text">第一步引入依赖：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E7%BC%96%E5%86%99%E5%89%8D%E7%AB%AF-vue%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="nav-number">30.2.2.</span> <span class="nav-text">第二步编写前端.vue文件：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%E6%B7%BB%E5%8A%A0%E8%8F%9C%E5%8D%95%EF%BC%9A"><span class="nav-number">30.2.3.</span> <span class="nav-text">第三步添加菜单：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E4%B9%9D%E3%80%81XSS%E8%84%9A%E6%9C%AC%E8%BF%87%E6%BB%A4"><span class="nav-number">31.</span> <span class="nav-text">二十九、XSS脚本过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-XSS%E8%84%9A%E6%9C%AC%E8%BF%87%E6%BB%A4"><span class="nav-number">31.1.</span> <span class="nav-text">1.XSS脚本过滤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-RY%E5%A6%82%E4%BD%95%E6%8A%B5%E6%8A%97XSS%E6%94%BB%E5%87%BB"><span class="nav-number">31.2.</span> <span class="nav-text">2.RY如何抵抗XSS攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E5%8D%81%E3%80%81%E9%98%B2%E6%AD%A2%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4%E8%BF%87%E6%BB%A4"><span class="nav-number">32.</span> <span class="nav-text">三十、防止重复提交过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%9B%9E%E5%BF%86%E5%89%8D%E7%AB%AF%E9%87%8D%E5%A4%8D%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA"><span class="nav-number">32.1.</span> <span class="nav-text">1.回忆前端重复请求拦截</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%90%8E%E7%AB%AF%E8%BF%87%E6%BB%A4%E9%87%8D%E5%A4%8D%E8%AF%B7%E6%B1%82"><span class="nav-number">32.2.</span> <span class="nav-text">2.后端过滤重复请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%BA%90%E7%A0%81"><span class="nav-number">32.3.</span> <span class="nav-text">3.源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%80%BB%E7%BB%93"><span class="nav-number">32.4.</span> <span class="nav-text">4.总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E5%8D%81%E4%B8%80%E3%80%81%E6%A1%86%E6%9E%B6%E9%AA%8C%E8%AF%81"><span class="nav-number">33.</span> <span class="nav-text">三十一、框架验证</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E5%8D%81%E4%BA%8C%E3%80%81%E5%89%8D%E7%AB%AF%E6%89%8B%E5%86%8C%E9%80%9F%E8%BF%87"><span class="nav-number">34.</span> <span class="nav-text">三十二、前端手册速过</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E5%8D%81%E4%B8%89%E3%80%81%E7%A6%81%E6%AD%A2%E5%A4%9A%E7%BB%88%E7%AB%AF%E5%90%8C%E6%97%B6%E7%99%BB%E5%BD%95%E5%AE%9E%E7%8E%B0"><span class="nav-number">35.</span> <span class="nav-text">三十三、禁止多终端同时登录实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%A6%81%E6%AD%A2%E5%A4%9A%E7%BB%88%E7%AB%AF%E5%90%8C%E6%97%B6%E7%99%BB%E5%BD%95%E5%AE%9E%E7%8E%B0%E5%AE%9E%E7%8E%B0%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">35.1.</span> <span class="nav-text">1.禁止多终端同时登录实现实现的两种方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9A%E6%8F%90%E7%A4%BA%E5%B7%B2%E7%BB%8F%E7%99%BB%E5%BD%95"><span class="nav-number">35.2.</span> <span class="nav-text">2.方式一：提示已经登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9A%E8%AF%A2%E9%97%AE%E6%98%AF%E5%90%A6T%E5%87%BA"><span class="nav-number">35.3.</span> <span class="nav-text">3.方式二：询问是否T出</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E5%8D%81%E5%9B%9B%E3%80%81%E5%8A%A0%E5%AF%86%E6%96%B9%E5%BC%8F%E4%BC%A0%E8%BE%93%E5%AF%86%E7%A0%81"><span class="nav-number">36.</span> <span class="nav-text">三十四、加密方式传输密码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%8A%A0%E5%AF%86%E6%96%B9%E5%BC%8F%E4%BC%A0%E8%BE%93%E5%AF%86%E7%A0%81"><span class="nav-number">36.1.</span> <span class="nav-text">1.加密方式传输密码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E5%8D%81%E4%BA%94%E3%80%81%E9%99%90%E6%B5%81%E6%8E%A7%E5%88%B6"><span class="nav-number">37.</span> <span class="nav-text">三十五、限流控制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E5%8D%81%E5%85%AD%E3%80%81Jetty%E4%BB%A3%E6%9B%BFTomcat"><span class="nav-number">38.</span> <span class="nav-text">三十六、Jetty代替Tomcat</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E5%8D%81%E4%B8%83%E3%80%81%E5%9B%BD%E9%99%85%E5%8C%96"><span class="nav-number">39.</span> <span class="nav-text">三十七、国际化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%9B%BD%E9%99%85%E5%8C%96"><span class="nav-number">39.1.</span> <span class="nav-text">1.为什么要国际化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%90%8E%E7%AB%AF%E5%9B%BD%E9%99%85%E5%8C%96"><span class="nav-number">39.2.</span> <span class="nav-text">2.后端国际化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%90%8E%E7%AB%AF%E7%9A%84resources%E4%B8%8B%E9%9D%A2%E7%9A%84i18n%E6%B7%BB%E5%8A%A0%EF%BC%9A"><span class="nav-number">39.2.1.</span> <span class="nav-text">一、后端的resources下面的i18n添加：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%EF%BC%9A%E5%A2%9E%E5%8A%A0%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%EF%BC%9A"><span class="nav-number">39.2.2.</span> <span class="nav-text">二：增加相关配置：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%EF%BC%9A%E4%B8%8B%E9%9D%A2%E6%88%91%E4%BB%AC%E5%9C%A8request-js%E4%B8%AD%E7%9A%84%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA%E5%99%A8%E6%9D%A5%E6%90%BA%E5%B8%A6lang%E5%8F%82%E6%95%B0%EF%BC%9A"><span class="nav-number">39.2.3.</span> <span class="nav-text">三：下面我们在request.js中的请求拦截器来携带lang参数：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%EF%BC%9Arequest-js%E7%94%A8%E5%88%B0%E4%BA%86cookie%EF%BC%8C%E6%88%91%E4%BB%AC%E5%9C%A8login-vue%E9%A1%B5%E9%9D%A2%E4%B8%8A%E6%9D%A5%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E6%8C%89%E9%92%AE%E6%9D%A5%E8%AE%BE%E7%BD%AE%E5%90%8D%E4%B8%BAlang%E7%9A%84cookie%EF%BC%9A"><span class="nav-number">39.2.4.</span> <span class="nav-text">四：request.js用到了cookie，我们在login.vue页面上来添加一个按钮来设置名为lang的cookie：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%89%8D%E7%AB%AF%E5%9B%BD%E9%99%85%E5%8C%96"><span class="nav-number">39.3.</span> <span class="nav-text">3.前端国际化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%EF%BC%9A%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%EF%BC%9A"><span class="nav-number">39.3.1.</span> <span class="nav-text">一：安装依赖：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%EF%BC%9A%E4%BF%AE%E6%94%B9main-js"><span class="nav-number">39.3.2.</span> <span class="nav-text">三：修改main.js:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%EF%BC%9A%E5%9C%A8src-x2F-store-x2F-getters-js%E4%B8%AD%E6%B7%BB%E5%8A%A0language%EF%BC%9A"><span class="nav-number">39.3.3.</span> <span class="nav-text">四：在src&#x2F;store&#x2F;getters.js中添加language：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94%EF%BC%9A%E5%9C%A8src-x2F-store-x2F-modules-x2F-app-js%E4%B8%AD%E5%A2%9E%E9%87%8F%E6%B7%BB%E5%8A%A0i18n%EF%BC%9A"><span class="nav-number">39.3.4.</span> <span class="nav-text">五：在src&#x2F;store&#x2F;modules&#x2F;app.js中增量添加i18n：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AD%EF%BC%9A%E5%9C%A8src-x2F-components-x2F-LangSelect-x2F-index-vue%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%9B%BD%E9%99%85%E5%8C%96%E7%BB%84%E4%BB%B6%EF%BC%9A"><span class="nav-number">39.3.5.</span> <span class="nav-text">六：在src&#x2F;components&#x2F;LangSelect&#x2F; index.vue中创建国际化组件：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%83%EF%BC%9A%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2%E7%9A%84%E5%9B%BD%E9%99%85%E5%8C%96%EF%BC%9A"><span class="nav-number">39.3.6.</span> <span class="nav-text">七：登录界面的国际化：</span></a></li></ol></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/code-copy.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/lazyload.js"></script>


<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/toc.js"></script>
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
