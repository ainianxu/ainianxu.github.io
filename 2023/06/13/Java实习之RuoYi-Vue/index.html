<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Fang">
    
    <title>
        
            Java实习之RuoYi-Vue |
        
        念~旭
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/favicon.ico","favicon":"/images/favicon.ico","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_img":"source/images/bg.svg","description":"进来就别走了！"},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.4"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                念~旭
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                LINKS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">LINKS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Java实习之RuoYi-Vue</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/favicon.ico">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Fang</span>
                        
                            <span class="author-label">Lv7</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2023-06-13 09:54:33</span>
        <span class="mobile">2023-06-13 09:54</span>
    </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E5%AE%9E%E4%B9%A0/">实习</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>16.5k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>73 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="一、后端在本地运行"><a href="#一、后端在本地运行" class="headerlink" title="一、后端在本地运行"></a>一、后端在本地运行</h1><h2 id="1-系统需求"><a href="#1-系统需求" class="headerlink" title="1.系统需求"></a>1.系统需求</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">JDK &gt;= 1.8 (推荐1.8版本)</span><br><span class="line">Mysql &gt;= 5.7.0 (推荐5.7版本)</span><br><span class="line">Redis &gt;= 3.0</span><br><span class="line">Maven &gt;= 3.0</span><br><span class="line">Node &gt;= 12</span><br></pre></td></tr></table></figure>

<h2 id="2-将项目导入IDEA"><a href="#2-将项目导入IDEA" class="headerlink" title="2.将项目导入IDEA"></a>2.将项目导入IDEA</h2><ol>
<li>新建数据库、新建查询，将RuoYi项目的sql中的quartz.sql和ry_20230223.sql导入新建的数据库中</li>
<li>修改ruoyi-admin\src\main\resources\application-druid.yml的数据库</li>
<li>再启动一个redis就能启动成功了（记得把Vue部分给分离出来哈）</li>
</ol>
<h2 id="3-项目结构"><a href="#3-项目结构" class="headerlink" title="3.项目结构"></a>3.项目结构</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">com.ruoyi     </span><br><span class="line">├── common            // 工具类</span><br><span class="line">│       └── annotation                    // 自定义注解</span><br><span class="line">│       └── config                        // 全局配置</span><br><span class="line">│       └── constant                      // 通用常量</span><br><span class="line">│       └── core                          // 核心控制</span><br><span class="line">│       └── enums                         // 通用枚举</span><br><span class="line">│       └── exception                     // 通用异常</span><br><span class="line">│       └── filter                        // 过滤器处理</span><br><span class="line">│       └── utils                         // 通用类处理</span><br><span class="line">├── framework         // 框架核心</span><br><span class="line">│       └── aspectj                       // 注解实现</span><br><span class="line">│       └── config                        // 系统配置</span><br><span class="line">│       └── datasource                    // 数据权限</span><br><span class="line">│       └── interceptor                   // 拦截器</span><br><span class="line">│       └── manager                       // 异步处理</span><br><span class="line">│       └── security                      // 权限控制</span><br><span class="line">│       └── web                           // 前端控制</span><br><span class="line">├── ruoyi-generator   // 代码生成（可移除）</span><br><span class="line">├── ruoyi-quartz      // 定时任务（可移除）</span><br><span class="line">├── ruoyi-system      // 系统代码</span><br><span class="line">├── ruoyi-admin       // 后台服务</span><br><span class="line">├── ruoyi-xxxxxx      // 其他模块</span><br></pre></td></tr></table></figure>

<h1 id="二、部署前端"><a href="#二、部署前端" class="headerlink" title="二、部署前端"></a>二、部署前端</h1><h2 id="1-将项目导入IDEA"><a href="#1-将项目导入IDEA" class="headerlink" title="1.将项目导入IDEA"></a>1.将项目导入IDEA</h2><ol>
<li>先在IDEA安装一个插件Vue.js</li>
<li>在安装一个依赖</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --registry=https://registry.npmmirror.com</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>接下来就可以启动package.json里面的dev了</li>
</ol>
<h2 id="2-项目结构"><a href="#2-项目结构" class="headerlink" title="2.项目结构"></a>2.项目结构</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">├── build                      // 构建相关  </span><br><span class="line">├── bin                        // 执行脚本</span><br><span class="line">├── public                     // 公共文件</span><br><span class="line">│   ├── favicon.ico            // favicon图标</span><br><span class="line">│   └── index.html             // html模板</span><br><span class="line">│   └── robots.txt             // 反爬虫</span><br><span class="line">├── src                        // 源代码</span><br><span class="line">│   ├── api                    // 所有请求</span><br><span class="line">│   ├── assets                 // 主题 字体等静态资源</span><br><span class="line">│   ├── components             // 全局公用组件</span><br><span class="line">│   ├── directive              // 全局指令</span><br><span class="line">│   ├── layout                 // 布局</span><br><span class="line">│   ├── plugins                // 通用方法</span><br><span class="line">│   ├── router                 // 路由</span><br><span class="line">│   ├── store                  // 全局 store管理</span><br><span class="line">│   ├── utils                  // 全局公用方法</span><br><span class="line">│   ├── views                  // view</span><br><span class="line">│   ├── App.vue                // 入口页面</span><br><span class="line">│   ├── main.js                // 入口 加载组件 初始化等</span><br><span class="line">│   ├── permission.js          // 权限管理</span><br><span class="line">│   └── settings.js            // 系统配置</span><br><span class="line">├── .editorconfig              // 编码格式</span><br><span class="line">├── .env.development           // 开发环境配置</span><br><span class="line">├── .env.production            // 生产环境配置</span><br><span class="line">├── .env.staging               // 测试环境配置</span><br><span class="line">├── .eslintignore              // 忽略语法检查</span><br><span class="line">├── .eslintrc.js               // eslint 配置项</span><br><span class="line">├── .gitignore                 // git 忽略项</span><br><span class="line">├── babel.config.js            // babel.config.js</span><br><span class="line">├── package.json               // package.json</span><br><span class="line">└── vue.config.js              // vue.config.js</span><br></pre></td></tr></table></figure>

<h1 id="三、前端request-js对axios的封装理解和基本使用"><a href="#三、前端request-js对axios的封装理解和基本使用" class="headerlink" title="三、前端request.js对axios的封装理解和基本使用"></a>三、前端request.js对axios的封装理解和基本使用</h1><p>ruoyi的前端对axios进行了封装，让我们发get请求或者是post请求更加方便了。</p>
<p>ruoyi对axios的封装在下面文件中：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306131337178.png"
                      alt="image-20230613133722299"
                ></p>
<p>打开文件，可以看到它有三个显眼的方法，分别是request拦截器、response拦截器和通用下载方法。</p>
<h2 id="1-Get"><a href="#1-Get" class="headerlink" title="1.Get"></a>1.Get</h2><ul>
<li>request拦截器对我们发送的请求进行了封装，当我们发送Get请求，那么我们携带参数的时候应该用param。，对应下面的源码。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get请求映射params参数</span></span><br><span class="line"><span class="keyword">if</span> (config.<span class="property">method</span> === <span class="string">&#x27;get&#x27;</span> &amp;&amp; config.<span class="property">params</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> url = config.<span class="property">url</span> + <span class="string">&#x27;?&#x27;</span> + <span class="title function_">tansParams</span>(config.<span class="property">params</span>);</span><br><span class="line">  url = url.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">  config.<span class="property">params</span> = &#123;&#125;;</span><br><span class="line">  config.<span class="property">url</span> = url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>通过此这简单的代码，可以让get请求自动变为我们熟悉的形式[<a href="http://xxxxx:port/aaa?key1=value1&amp;key2=value2]。">http://xxxxx:port/aaa?key1=value1&amp;key2=value2]。</a></p>
</li>
<li><p>看一个get请求的案例：</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取验证码 不带参数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getCodeImg</span>(<span class="params"></span>) &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">   <span class="attr">url</span>: <span class="string">&#x27;/captchaImage&#x27;</span>,</span><br><span class="line">   <span class="attr">headers</span>: &#123;</span><br><span class="line">     <span class="attr">isToken</span>: <span class="literal">false</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">   <span class="attr">timeout</span>: <span class="number">20000</span></span><br><span class="line"> &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询在线用户列表 带参数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">list</span>(<span class="params">query</span>) &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">   <span class="attr">url</span>: <span class="string">&#x27;/monitor/online/list&#x27;</span>,</span><br><span class="line">   <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">   <span class="attr">params</span>: query</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Post"><a href="#2-Post" class="headerlink" title="2.Post"></a>2.Post</h2><ol>
<li>Post请求带参数使用data。并且以下代码规避了重复提交</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isRepeatSubmit &amp;&amp; (config.<span class="property">method</span> === <span class="string">&#x27;post&#x27;</span> || config.<span class="property">method</span> === <span class="string">&#x27;put&#x27;</span>)) &#123;</span><br><span class="line">  <span class="keyword">const</span> requestObj = &#123;</span><br><span class="line">    <span class="attr">url</span>: config.<span class="property">url</span>,</span><br><span class="line">    <span class="attr">data</span>: <span class="keyword">typeof</span> config.<span class="property">data</span> === <span class="string">&#x27;object&#x27;</span> ? <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(config.<span class="property">data</span>) : config.<span class="property">data</span>,</span><br><span class="line">    <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> sessionObj = cache.<span class="property">session</span>.<span class="title function_">getJSON</span>(<span class="string">&#x27;sessionObj&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (sessionObj === <span class="literal">undefined</span> || sessionObj === <span class="literal">null</span> || sessionObj === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    cache.<span class="property">session</span>.<span class="title function_">setJSON</span>(<span class="string">&#x27;sessionObj&#x27;</span>, requestObj)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s_url = sessionObj.<span class="property">url</span>;                  <span class="comment">// 请求地址</span></span><br><span class="line">    <span class="keyword">const</span> s_data = sessionObj.<span class="property">data</span>;                <span class="comment">// 请求数据</span></span><br><span class="line">    <span class="keyword">const</span> s_time = sessionObj.<span class="property">time</span>;                <span class="comment">// 请求时间</span></span><br><span class="line">    <span class="keyword">const</span> interval = <span class="number">1000</span>;                         <span class="comment">// 间隔时间(ms)，小于此时间视为重复提交</span></span><br><span class="line">    <span class="keyword">if</span> (s_data === requestObj.<span class="property">data</span> &amp;&amp; requestObj.<span class="property">time</span> - s_time &lt; interval &amp;&amp; s_url === requestObj.<span class="property">url</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> message = <span class="string">&#x27;数据正在处理，请勿重复提交&#x27;</span>;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[<span class="subst">$&#123;s_url&#125;</span>]: `</span> + message)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(message))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cache.<span class="property">session</span>.<span class="title function_">setJSON</span>(<span class="string">&#x27;sessionObj&#x27;</span>, requestObj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-预防重复提交开关"><a href="#3-预防重复提交开关" class="headerlink" title="3.预防重复提交开关"></a>3.预防重复提交开关</h2><ul>
<li>就是在请求头处设置repeatSubmit为false还是不加repeatSubmit</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否需要防止数据重复提交</span></span><br><span class="line"><span class="keyword">const</span> isRepeatSubmit = (config.<span class="property">headers</span> || &#123;&#125;).<span class="property">repeatSubmit</span> === <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">getToken</span>() &amp;&amp; !isToken) &#123;</span><br><span class="line">  config.<span class="property">headers</span>[<span class="string">&#x27;Authorization&#x27;</span>] = <span class="string">&#x27;Bearer &#x27;</span> + <span class="title function_">getToken</span>() <span class="comment">// 让每个请求携带自定义token 请根据实际情况自行修改</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-响应拦截器"><a href="#4-响应拦截器" class="headerlink" title="4.响应拦截器"></a>4.响应拦截器</h2><ul>
<li>用于每一个响应的拦截过滤处理。对不同状态码进行判断给出处理逻辑，并不是特别重要。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 未设置状态码则默认成功状态</span></span><br><span class="line">    <span class="keyword">const</span> code = res.<span class="property">data</span>.<span class="property">code</span> || <span class="number">200</span>;</span><br><span class="line">    <span class="comment">// 获取错误信息</span></span><br><span class="line">    <span class="keyword">const</span> msg = errorCode[code] || res.<span class="property">data</span>.<span class="property">msg</span> || errorCode[<span class="string">&#x27;default&#x27;</span>]</span><br><span class="line">    <span class="comment">// 二进制数据则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">request</span>.<span class="property">responseType</span> ===  <span class="string">&#x27;blob&#x27;</span> || res.<span class="property">request</span>.<span class="property">responseType</span> ===  <span class="string">&#x27;arraybuffer&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="property">data</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (code === <span class="number">401</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!isRelogin.<span class="property">show</span>) &#123;</span><br><span class="line">        isRelogin.<span class="property">show</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="title class_">MessageBox</span>.<span class="title function_">confirm</span>(<span class="string">&#x27;登录状态已过期，您可以继续留在该页面，或者重新登录&#x27;</span>, <span class="string">&#x27;系统提示&#x27;</span>, &#123; <span class="attr">confirmButtonText</span>: <span class="string">&#x27;重新登录&#x27;</span>, <span class="attr">cancelButtonText</span>: <span class="string">&#x27;取消&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;warning&#x27;</span> &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          isRelogin.<span class="property">show</span> = <span class="literal">false</span>;</span><br><span class="line">          store.<span class="title function_">dispatch</span>(<span class="string">&#x27;LogOut&#x27;</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            location.<span class="property">href</span> = <span class="string">&#x27;/index&#x27;</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        isRelogin.<span class="property">show</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;无效的会话，或者会话已过期，请重新登录。&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code === <span class="number">500</span>) &#123;</span><br><span class="line">      <span class="title class_">Message</span>(&#123; <span class="attr">message</span>: msg, <span class="attr">type</span>: <span class="string">&#x27;error&#x27;</span> &#125;)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(msg))</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code === <span class="number">601</span>) &#123;</span><br><span class="line">      <span class="title class_">Message</span>(&#123; <span class="attr">message</span>: msg, <span class="attr">type</span>: <span class="string">&#x27;warning&#x27;</span> &#125;)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code !== <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="title class_">Notification</span>.<span class="title function_">error</span>(&#123; <span class="attr">title</span>: msg &#125;)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="property">data</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;err&#x27;</span> + error)</span><br><span class="line">    <span class="keyword">let</span> &#123; message &#125; = error;</span><br><span class="line">    <span class="keyword">if</span> (message == <span class="string">&quot;Network Error&quot;</span>) &#123;</span><br><span class="line">      message = <span class="string">&quot;后端接口连接异常&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.<span class="title function_">includes</span>(<span class="string">&quot;timeout&quot;</span>)) &#123;</span><br><span class="line">      message = <span class="string">&quot;系统接口请求超时&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.<span class="title function_">includes</span>(<span class="string">&quot;Request failed with status code&quot;</span>)) &#123;</span><br><span class="line">      message = <span class="string">&quot;系统接口&quot;</span> + message.<span class="title function_">substr</span>(message.<span class="property">length</span> - <span class="number">3</span>) + <span class="string">&quot;异常&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Message</span>(&#123; <span class="attr">message</span>: message, <span class="attr">type</span>: <span class="string">&#x27;error&#x27;</span>, <span class="attr">duration</span>: <span class="number">5</span> * <span class="number">1000</span> &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="5-通用下载方法前段代码"><a href="#5-通用下载方法前段代码" class="headerlink" title="5.通用下载方法前段代码"></a>5.通用下载方法前段代码</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通用下载方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">download</span>(<span class="params">url, params, filename, config</span>) &#123;</span><br><span class="line">  downloadLoadingInstance = <span class="title class_">Loading</span>.<span class="title function_">service</span>(&#123; <span class="attr">text</span>: <span class="string">&quot;正在下载数据，请稍候&quot;</span>, <span class="attr">spinner</span>: <span class="string">&quot;el-icon-loading&quot;</span>, <span class="attr">background</span>: <span class="string">&quot;rgba(0, 0, 0, 0.7)&quot;</span>, &#125;)</span><br><span class="line">  <span class="keyword">return</span> service.<span class="title function_">post</span>(url, params, &#123;</span><br><span class="line">    <span class="attr">transformRequest</span>: [<span class="function">(<span class="params">params</span>) =&gt;</span> &#123; <span class="keyword">return</span> <span class="title function_">tansParams</span>(params) &#125;],</span><br><span class="line">    <span class="attr">headers</span>: &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">responseType</span>: <span class="string">&#x27;blob&#x27;</span>,</span><br><span class="line">    ...config</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="keyword">async</span> (data) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> isBlob = <span class="title function_">blobValidate</span>(data);</span><br><span class="line">    <span class="keyword">if</span> (isBlob) &#123;</span><br><span class="line">      <span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([data])</span><br><span class="line">      <span class="title function_">saveAs</span>(blob, filename)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> resText = <span class="keyword">await</span> data.<span class="title function_">text</span>();</span><br><span class="line">      <span class="keyword">const</span> rspObj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(resText);</span><br><span class="line">      <span class="keyword">const</span> errMsg = errorCode[rspObj.<span class="property">code</span>] || rspObj.<span class="property">msg</span> || errorCode[<span class="string">&#x27;default&#x27;</span>]</span><br><span class="line">      <span class="title class_">Message</span>.<span class="title function_">error</span>(errMsg);</span><br><span class="line">    &#125;</span><br><span class="line">    downloadLoadingInstance.<span class="title function_">close</span>();</span><br><span class="line">  &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(r)</span><br><span class="line">    <span class="title class_">Message</span>.<span class="title function_">error</span>(<span class="string">&#x27;下载文件出现错误，请联系管理员！&#x27;</span>)</span><br><span class="line">    downloadLoadingInstance.<span class="title function_">close</span>();</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将该方法在main.js全局方法中挂载</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">download</span> = download</span><br></pre></td></tr></table></figure>

<ul>
<li>就可以使用了，比如说字典查询处</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 导出按钮操作 */</span></span><br><span class="line"><span class="title function_">handleExport</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">download</span>(<span class="string">&#x27;system/dict/type/export&#x27;</span>, &#123;</span><br><span class="line">    ...<span class="variable language_">this</span>.<span class="property">queryParams</span></span><br><span class="line">  &#125;, <span class="string">`type_<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()&#125;</span>.xlsx`</span>)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h1 id="四-在线用户展示-仅仅从Redis取一下数据做展示"><a href="#四-在线用户展示-仅仅从Redis取一下数据做展示" class="headerlink" title="四.在线用户展示-仅仅从Redis取一下数据做展示"></a>四.在线用户展示-仅仅从Redis取一下数据做展示</h1><ul>
<li>这个在线用户的功能怎么实现的呢？<ul>
<li>ruoyi的在线用户存在redis中的，每次一个人登录，就会把他的登录信息存在redis中，当我们去查询在线用户，无非就是去redis中取一下有哪一些用户罢了！</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;monitor:online:list&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> TableDataInfo <span class="title function_">list</span><span class="params">(String ipaddr, String userName)</span></span><br><span class="line">&#123;</span><br><span class="line">    Collection&lt;String&gt; keys = redisCache.keys(CacheConstants.LOGIN_TOKEN_KEY + <span class="string">&quot;*&quot;</span>);</span><br><span class="line">    List&lt;SysUserOnline&gt; userOnlineList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SysUserOnline&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String key : keys)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">user</span> <span class="operator">=</span> redisCache.getCacheObject(key);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(ipaddr) &amp;&amp; StringUtils.isNotEmpty(userName))</span><br><span class="line">        &#123;</span><br><span class="line">            userOnlineList.add(userOnlineService.selectOnlineByInfo(ipaddr, userName, user));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotEmpty(ipaddr))</span><br><span class="line">        &#123;</span><br><span class="line">            userOnlineList.add(userOnlineService.selectOnlineByIpaddr(ipaddr, user));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotEmpty(userName) &amp;&amp; StringUtils.isNotNull(user.getUser()))</span><br><span class="line">        &#123;</span><br><span class="line">            userOnlineList.add(userOnlineService.selectOnlineByUserName(userName, user));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            userOnlineList.add(userOnlineService.loginUserToUserOnline(user));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Collections.reverse(userOnlineList);</span><br><span class="line">    userOnlineList.removeAll(Collections.singleton(<span class="literal">null</span>));</span><br><span class="line">    <span class="keyword">return</span> getDataTable(userOnlineList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="五、登录的时候用户信息存入redis代码在哪"><a href="#五、登录的时候用户信息存入redis代码在哪" class="headerlink" title="五、登录的时候用户信息存入redis代码在哪"></a>五、登录的时候用户信息存入redis代码在哪</h1><ul>
<li>那么他又是怎么将登陆信息存到redis里面呢，首先在SysLoginService里面的login，返回处调用TokenService生成token方法，createToken里面包含一个refreshToken方法，该方法里面调用RedisCache生成缓存对象方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成token</span></span><br><span class="line"><span class="keyword">return</span> tokenService.createToken(loginUser);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">refreshToken(loginUser);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 刷新令牌有效期</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loginUser 登录信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshToken</span><span class="params">(LoginUser loginUser)</span></span><br><span class="line">&#123;</span><br><span class="line">    loginUser.setLoginTime(System.currentTimeMillis());</span><br><span class="line">    loginUser.setExpireTime(loginUser.getLoginTime() + expireTime * MILLIS_MINUTE);</span><br><span class="line">    <span class="comment">// 根据uuid将loginUser缓存</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> getTokenKey(loginUser.getToken());</span><br><span class="line">    redisCache.setCacheObject(userKey, loginUser, expireTime, TimeUnit.MINUTES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 缓存基本的对象，Integer、String、实体类等</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 缓存的键值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value 缓存的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeout 时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeUnit 时间颗粒度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">setCacheObject</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> T value, <span class="keyword">final</span> Integer timeout, <span class="keyword">final</span> TimeUnit timeUnit)</span></span><br><span class="line">&#123;</span><br><span class="line">    redisTemplate.opsForValue().set(key, value, timeout, timeUnit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="六、强退用户"><a href="#六、强退用户" class="headerlink" title="六、强退用户"></a>六、强退用户</h1><ol>
<li>就是用了SysUserOnlineController中的forceLogout方法，调用了reids中的删除用户方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 强退用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;monitor:online:forceLogout&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@Log(title = &quot;在线用户&quot;, businessType = BusinessType.FORCE)</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/&#123;tokenId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">forceLogout</span><span class="params">(<span class="meta">@PathVariable</span> String tokenId)</span></span><br><span class="line">&#123;</span><br><span class="line">    redisCache.deleteObject(CacheConstants.LOGIN_TOKEN_KEY + tokenId);</span><br><span class="line">    <span class="keyword">return</span> success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除单个对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteObject</span><span class="params">(<span class="keyword">final</span> String key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="七、下载字典类型后端三句话在做啥"><a href="#七、下载字典类型后端三句话在做啥" class="headerlink" title="七、下载字典类型后端三句话在做啥"></a>七、下载字典类型后端三句话在做啥</h1><ol>
<li>在SysDictTypeController中</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Log(title = &quot;字典类型&quot;, businessType = BusinessType.EXPORT)</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;system:dict:export&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/export&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">export</span><span class="params">(HttpServletResponse response, SysDictType dictType)</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;SysDictType&gt; list = dictTypeService.selectDictTypeList(dictType);</span><br><span class="line">    ExcelUtil&lt;SysDictType&gt; util = <span class="keyword">new</span> <span class="title class_">ExcelUtil</span>&lt;SysDictType&gt;(SysDictType.class);</span><br><span class="line">    util.exportExcel(response, list, <span class="string">&quot;字典类型&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>response：是用來返回給前端的，可以让前端接收数据</li>
<li>list：用来存搜索出来的对象</li>
<li>util的exportExcel方法就可以导出excel</li>
</ul>
<h1 id="八、前端向后端传参的方式"><a href="#八、前端向后端传参的方式" class="headerlink" title="八、前端向后端传参的方式"></a>八、前端向后端传参的方式</h1><p>本节课主要讲述ruoyi中存在的restful风格在路径中传参和直接通过get或post携带的param、data传参。</p>
<h2 id="1-RESTful"><a href="#1-RESTful" class="headerlink" title="1.RESTful"></a>1.RESTful</h2><ul>
<li>以参数管理为例子，用过configId查询它用到了restful风格的传参方式：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询字典数据详细</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;system:dict:query&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/&#123;dictCode&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long dictCode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> success(dictDataService.selectDictDataById(dictCode));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上的&#x2F;{configId}就是一种在路径中传参数的例子。</li>
</ul>
<h2 id="2-普通方式"><a href="#2-普通方式" class="headerlink" title="2.普通方式"></a>2.普通方式</h2><blockquote>
<p>第二种直接在get的param中写，或者在post的data中写即可。</p>
</blockquote>
<h1 id="九、开关原理（验证码开关、IP开关）"><a href="#九、开关原理（验证码开关、IP开关）" class="headerlink" title="九、开关原理（验证码开关、IP开关）"></a>九、开关原理（验证码开关、IP开关）</h1><h2 id="1-开关原理（验证码开关）"><a href="#1-开关原理（验证码开关）" class="headerlink" title="1.开关原理（验证码开关）"></a>1.开关原理（验证码开关）</h2><p>我们打开页面“参数管理”，所谓参数管理，就是在系统运行起来的时候，可以动态修改一些值，这些值会被系统实时修改，下次如果需要读值，则会是最新的值。</p>
<p>对于验证码而言，可以将下面的参数值修改为false即可：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141011541.png"
                      alt="image-20230614101121134"
                ></p>
<ul>
<li>前端login.vue关键代码：主要就是这个v-if</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form-item prop=&quot;code&quot; v-if=&quot;captchaEnabled&quot;&gt;</span><br><span class="line">  &lt;el-input</span><br><span class="line">    v-model=&quot;loginForm.code&quot;</span><br><span class="line">    auto-complete=&quot;off&quot;</span><br><span class="line">    placeholder=&quot;验证码&quot;</span><br><span class="line">    style=&quot;width: 63%&quot;</span><br><span class="line">    @keyup.enter.native=&quot;handleLogin&quot;</span><br><span class="line">  &gt;</span><br><span class="line">    &lt;svg-icon slot=&quot;prefix&quot; icon-class=&quot;validCode&quot; class=&quot;el-input__icon input-icon&quot; /&gt;</span><br><span class="line">  &lt;/el-input&gt;</span><br><span class="line">  &lt;div class=&quot;login-code&quot;&gt;</span><br><span class="line">    &lt;img :src=&quot;codeUrl&quot; @click=&quot;getCode&quot; class=&quot;login-code-img&quot;/&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/el-form-item&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getCode</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">getCodeImg</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">captchaEnabled</span> = res.<span class="property">captchaEnabled</span> === <span class="literal">undefined</span> ? <span class="literal">true</span> : res.<span class="property">captchaEnabled</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">captchaEnabled</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">codeUrl</span> = <span class="string">&quot;data:image/gif;base64,&quot;</span> + res.<span class="property">img</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">loginForm</span>.<span class="property">uuid</span> = res.<span class="property">uuid</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>CaptchaController后端关键代码：获取数据先从Redis（程序开始就存到了Redis中）中获取，如果Reids获取不到就在数据库中获取</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/captchaImage&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getCode</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">AjaxResult</span> <span class="variable">ajax</span> <span class="operator">=</span> AjaxResult.success();</span><br><span class="line">    <span class="comment">//主要就靠这句话获取是false还是true</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">captchaEnabled</span> <span class="operator">=</span> configService.selectCaptchaEnabled();</span><br><span class="line">    ajax.put(<span class="string">&quot;captchaEnabled&quot;</span>, captchaEnabled);</span><br><span class="line">    <span class="keyword">if</span> (!captchaEnabled)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ajax;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存验证码信息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> IdUtils.simpleUUID();</span><br><span class="line">    <span class="type">String</span> <span class="variable">verifyKey</span> <span class="operator">=</span> CacheConstants.CAPTCHA_CODE_KEY + uuid;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">capStr</span> <span class="operator">=</span> <span class="literal">null</span>, code = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">captchaType</span> <span class="operator">=</span> RuoYiConfig.getCaptchaType();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;math&quot;</span>.equals(captchaType))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">capText</span> <span class="operator">=</span> captchaProducerMath.createText();</span><br><span class="line">        capStr = capText.substring(<span class="number">0</span>, capText.lastIndexOf(<span class="string">&quot;@&quot;</span>));</span><br><span class="line">        code = capText.substring(capText.lastIndexOf(<span class="string">&quot;@&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        image = captchaProducerMath.createImage(capStr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;char&quot;</span>.equals(captchaType))</span><br><span class="line">    &#123;</span><br><span class="line">        capStr = code = captchaProducer.createText();</span><br><span class="line">        image = captchaProducer.createImage(capStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    redisCache.setCacheObject(verifyKey, code, Constants.CAPTCHA_EXPIRATION, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">// 转换流信息写出</span></span><br><span class="line">    <span class="type">FastByteArrayOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastByteArrayOutputStream</span>();</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        ImageIO.write(image, <span class="string">&quot;jpg&quot;</span>, os);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> AjaxResult.error(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ajax.put(<span class="string">&quot;uuid&quot;</span>, uuid);</span><br><span class="line">    ajax.put(<span class="string">&quot;img&quot;</span>, Base64.encode(os.toByteArray()));</span><br><span class="line">    <span class="keyword">return</span> ajax;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>怎么程序一启动就自动存到了Redis中呢？是通过一个注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 项目启动时，初始化参数到缓存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    loadingConfigCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>参数配置还能改用户初始密码和是否允许注册</li>
</ul>
<h2 id="2-开关原理（IP开关）"><a href="#2-开关原理（IP开关）" class="headerlink" title="2.开关原理（IP开关）"></a>2.开关原理（IP开关）</h2><ul>
<li>上一种验证码开关是在参数设置里面设置的，随着程序运行之后，也能随时改。主要通过redis实现。</li>
<li>那么，IP开关呢？IP开关在YML，主要是用来看日志的时候能不能看到公网IP。</li>
<li><strong>IP开关通过YML文件中写死实现，也就是说，一旦程序启动，就改不了了。</strong></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目相关配置</span></span><br><span class="line"><span class="attr">ruoyi:</span></span><br><span class="line">  <span class="comment"># 获取ip地址开关</span></span><br><span class="line">  <span class="attr">addressEnabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>通过AddressUtils这个来根据IP地址查询所在地</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.common.utils.ip;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.config.RuoYiConfig;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.http.HttpUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取地址类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddressUtils</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(AddressUtils.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// IP地址查询</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">IP_URL</span> <span class="operator">=</span> <span class="string">&quot;http://whois.pconline.com.cn/ipJson.jsp&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 未知地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UNKNOWN</span> <span class="operator">=</span> <span class="string">&quot;XX XX&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getRealAddressByIP</span><span class="params">(String ip)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 内网不查询</span></span><br><span class="line">        <span class="keyword">if</span> (IpUtils.internalIp(ip))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;内网IP&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (RuoYiConfig.isAddressEnabled())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">rspStr</span> <span class="operator">=</span> HttpUtils.sendGet(IP_URL, <span class="string">&quot;ip=&quot;</span> + ip + <span class="string">&quot;&amp;json=true&quot;</span>, Constants.GBK);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isEmpty(rspStr))</span><br><span class="line">                &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;获取地理位置异常 &#123;&#125;&quot;</span>, ip);</span><br><span class="line">                    <span class="keyword">return</span> UNKNOWN;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">JSONObject</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(rspStr);</span><br><span class="line">                <span class="type">String</span> <span class="variable">region</span> <span class="operator">=</span> obj.getString(<span class="string">&quot;pro&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> obj.getString(<span class="string">&quot;city&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">&quot;%s %s&quot;</span>, region, city);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                log.error(<span class="string">&quot;获取地理位置异常 &#123;&#125;&quot;</span>, ip);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在线用户的地址IP转location也是登录的时候创建令牌中setUserAgent方法干的，并且30分钟掉线是在yml中设置的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建令牌</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loginUser 用户信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 令牌</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">createToken</span><span class="params">(LoginUser loginUser)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> IdUtils.fastUUID();</span><br><span class="line">    loginUser.setToken(token);</span><br><span class="line">    setUserAgent(loginUser);</span><br><span class="line">    refreshToken(loginUser);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    claims.put(Constants.LOGIN_USER_KEY, token);</span><br><span class="line">    <span class="keyword">return</span> createToken(claims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># token配置</span></span><br><span class="line"><span class="attr">token:</span></span><br><span class="line">    <span class="comment"># 令牌自定义标识</span></span><br><span class="line">    <span class="attr">header:</span> <span class="string">Authorization</span></span><br><span class="line">    <span class="comment"># 令牌密钥</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">abcdefghijklmnopqrstuvwxyz</span></span><br><span class="line">    <span class="comment"># 令牌有效期（默认30分钟）</span></span><br><span class="line">    <span class="attr">expireTime:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<h1 id="十、前端页面的布局详解"><a href="#十、前端页面的布局详解" class="headerlink" title="十、前端页面的布局详解"></a>十、前端页面的布局详解</h1><h2 id="1-Vue-Devtools工具安装"><a href="#1-Vue-Devtools工具安装" class="headerlink" title="1.Vue-Devtools工具安装"></a>1.Vue-Devtools工具安装</h2><ul>
<li>在谷歌商店中添加插件</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141440219.png"
                      alt="image-20230614144016984"
                ></p>
<h2 id="2-前端页面的布局"><a href="#2-前端页面的布局" class="headerlink" title="2.前端页面的布局"></a>2.前端页面的布局</h2><h3 id="情况一：不依赖Layout的情况"><a href="#情况一：不依赖Layout的情况" class="headerlink" title="情况一：不依赖Layout的情况"></a>情况一：不依赖Layout的情况</h3><ul>
<li>ruoyi的前端页面目前存在两种情况，一种是依赖layout组件，一种是不依赖layout组件。</li>
<li>比如说登录页面，注册页面，404页面就不依赖于layout组件，layout组件实际上就是一个vue的组件。</li>
<li>这种组件比较简单，就是跟写HTML基本也没啥两样。</li>
<li>关于login.vue页面的对应组件树如下：用的就是<a class="link"   target="_blank" rel="noopener" href="https://element.eleme.cn/#/zh-CN/component/installation%E8%BF%99%E9%87%8C%E9%9D%A2%E7%9A%84%E7%BB%84%E4%BB%B6" >https://element.eleme.cn/#/zh-CN/component/installation这里面的组件<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141507353.png"
                      alt="图片"
                ></p>
<h3 id="情况二：依赖Layout组件"><a href="#情况二：依赖Layout组件" class="headerlink" title="情况二：依赖Layout组件"></a>情况二：依赖Layout组件</h3><ul>
<li>当我们成功登录，接下来基本上每一个页面都是出于Layout组件之下，也就是说，它是layout组件的子组件！</li>
<li>当我们登录之后，会自动到首页</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141529090.png"
                      alt="图片"
                ></p>
<ul>
<li>Sidebar：对应左边菜单区。</li>
<li>Navbar：导航区。</li>
<li>TagsView：页签区。</li>
<li>RightPanel：右面板区，平常不可见。</li>
<li>AppMain：内容页面区，我们一般业务页面会出现在此区域。</li>
</ul>
<h1 id="十一、天气小案例"><a href="#十一、天气小案例" class="headerlink" title="十一、天气小案例"></a>十一、天气小案例</h1><h2 id="1-新增带Layout组件的页面"><a href="#1-新增带Layout组件的页面" class="headerlink" title="1.新增带Layout组件的页面"></a>1.新增带Layout组件的页面</h2><ul>
<li><p>直接在views文件夹下面新增weather.vue。然后随便写一个123，现在先让我们页面能跳过去先。</p>
</li>
<li><p>让页面能跳过去，有好几种方法：</p>
<ul>
<li>在菜单管理自己添加一个菜单，然后把菜单分配给某个角色，再把该角色分给某个人。【然而超级管理员什么时候都能看到此菜单，因为超级管理员能无视一切权限问题】</li>
<li>在路由文件（router&#x2F;index.js直接写相关路由），然后可以手动切换浏览器网址进入该路由。</li>
</ul>
</li>
<li><p>本次例子利用使用自己添加菜单的方法，这样比较简单。简单如下图：</p>
</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141711219.png"
                      alt="image-20230614171107830"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141715722.png"
                      alt="image-20230614171559529"
                ></p>
<ul>
<li>组件路径一定要写对，写不对直接进不去相应的组件。路由地址可以乱写，但是起码也要有点“path”的样子</li>
</ul>
<h2 id="2-专注weather业务"><a href="#2-专注weather业务" class="headerlink" title="2.专注weather业务"></a>2.专注weather业务</h2><ol>
<li>首先weather.vue文件的代码如下：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div v-loading=&quot;loading&quot;&gt;</span><br><span class="line">    &lt;el-row style=&quot;margin-top: 30px;&quot; :gutter=&quot;20&quot;&gt;</span><br><span class="line">      &lt;el-col :offset=&quot;10&quot; :span=&quot;4&quot;&gt;</span><br><span class="line">        &lt;el-button type=&quot;success&quot; @click=&quot;handleWeather&quot;&gt;当前城市天气&lt;/el-button&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">    &lt;el-row :gutter=&quot;20&quot; v-if=&quot;city.length&gt;0&quot;&gt;</span><br><span class="line">      &lt;el-col :offset=&quot;2&quot; :span=&quot;20&quot;&gt;</span><br><span class="line">        &lt;el-descriptions title=&quot;当前实时天气&quot;&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;当前城市&quot;&gt;&#123;&#123; city &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;温度&quot;&gt;&#123;&#123; weather.realtime.temperature &#125;&#125;℃&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;风向&quot;&gt;&#123;&#123; weather.realtime.direct &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;风力&quot;&gt;&#123;&#123; weather.realtime.power &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;湿度&quot;&gt;&#123;&#123; weather.realtime.humidity &#125;&#125;%&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;天气状况&quot;&gt;&#123;&#123; weather.realtime.info &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">        &lt;/el-descriptions&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">    &lt;el-row v-for=&quot;item in weather.future&quot; :key=&quot;item.date&quot; style=&quot;margin-top: 30px;&quot; :gutter=&quot;20&quot;&gt;</span><br><span class="line">      &lt;el-col :offset=&quot;2&quot; :span=&quot;20&quot;&gt;</span><br><span class="line">        &lt;el-descriptions :title=&quot;item.date&quot; :column=&quot;4&quot;&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;风向&quot;&gt;&#123;&#123; item.direct &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;温度&quot;&gt;&#123;&#123; item.temperature &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">          &lt;el-descriptions-item label=&quot;天气情况&quot;&gt;&#123;&#123; item.weather &#125;&#125;&lt;/el-descriptions-item&gt;</span><br><span class="line">        &lt;/el-descriptions&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;getWeather&#125; from &#x27;@/api/gzh/weather&#x27;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;weather&quot;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      loading : false,</span><br><span class="line">      city: &quot;&quot;,</span><br><span class="line">      weather: &#123;</span><br><span class="line">        realtime: &#123;&#125;,</span><br><span class="line">        future: []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handleWeather() &#123;</span><br><span class="line">      this.loading = true</span><br><span class="line">      getWeather().then(res =&gt; &#123;</span><br><span class="line">        const weatherInfo = JSON.parse(res.msg);</span><br><span class="line">        this.city = weatherInfo.result.city</span><br><span class="line">        this.weather.realtime = weatherInfo.result.realtime</span><br><span class="line">        this.weather.future = weatherInfo.result.future</span><br><span class="line">        this.loading = false</span><br><span class="line">        console.log(weatherInfo)</span><br><span class="line">      &#125;).catch(err =&gt; &#123;</span><br><span class="line">        console.error(err)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>然后是前端api调用代码&#x2F;api&#x2F;gzh&#x2F;weather.js：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&quot;@/utils/request&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询参数列表</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getWeather</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/getWeatherByLocalIP&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>接下来是后端的工具类代码：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.web.controller.weather;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.http.HttpUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getWeatherByLocalIP&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">getWeather</span><span class="params">()</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">        <span class="type">AjaxResult</span> <span class="variable">result</span> <span class="operator">=</span> AjaxResult.success();</span><br><span class="line">        <span class="type">String</span> <span class="variable">localCityName</span> <span class="operator">=</span> GetLocationAndIP.getLocalCityName();</span><br><span class="line">        <span class="comment">//调用天气API</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">encodeCity</span> <span class="operator">=</span> URLEncoder.encode(localCityName, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        System.out.println(encodeCity);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://apis.juhe.cn/simpleWeather/query?city=&quot;</span> + encodeCity + <span class="string">&quot;&amp;key=81fe33a6077267b2e4ae2967af47eeb7&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">weatherInfo</span> <span class="operator">=</span> HttpUtils.sendGet(url);</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, weatherInfo);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>然后是后端接口的代码：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.web.controller.weather;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONException;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetLocationAndIP</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">readAll</span><span class="params">(BufferedReader rd)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">int</span> cp;</span><br><span class="line">        <span class="keyword">while</span> ((cp = rd.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            sb.append((<span class="type">char</span>) cp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title function_">readJsonFromUrl</span><span class="params">(String url)</span> <span class="keyword">throws</span> IOException, JSONException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url).openStream()) &#123;</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">rd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is, StandardCharsets.UTF_8));</span><br><span class="line">            <span class="type">String</span> <span class="variable">jsonText</span> <span class="operator">=</span> readAll(rd);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(jsonText);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getAddress</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// 这个网址似乎不能了用了</span></span><br><span class="line">        <span class="comment">// String chinaz = &quot;http://ip.chinaz.com&quot;;</span></span><br><span class="line">        <span class="comment">// 改用了太平洋的一个网址</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chinaz</span> <span class="operator">=</span> <span class="string">&quot;http://whois.pconline.com.cn/&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">inputLine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">read</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">HttpURLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            url = <span class="keyword">new</span> <span class="title class_">URL</span>(chinaz);</span><br><span class="line">            urlConnection = (HttpURLConnection) url.openConnection();</span><br><span class="line">            <span class="comment">// 如有乱码的，请修改相应的编码集，这里是 gbk</span></span><br><span class="line">            in = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(urlConnection.getInputStream(), <span class="string">&quot;gbk&quot;</span>));</span><br><span class="line">            <span class="keyword">while</span> ((read = in.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                inputLine.append(read).append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这个是之前的正则表达式,</span></span><br><span class="line">        <span class="comment">// Pattern p = Pattern.compile(&quot;\\&lt;dd class\\=\&quot;fz24\&quot;&gt;(.*?)\\&lt;\\/dd&gt;&quot;);</span></span><br><span class="line">        <span class="comment">// 通过正则表达式匹配我们想要的内容，根据拉取的网页内容不同，正则表达式作相应的改变</span></span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">p</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;显示IP地址为(.*?)的位置信息&quot;</span>);</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">m</span> <span class="operator">=</span> p.matcher(inputLine.toString());</span><br><span class="line">        <span class="keyword">if</span> (m.find()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">ipstr</span> <span class="operator">=</span> m.group(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 这里根据具体情况，来截取想要的内容</span></span><br><span class="line">            ip = ipstr.substring(ipstr.indexOf(<span class="string">&quot;为&quot;</span>) + <span class="number">2</span>, ipstr.indexOf(<span class="string">&quot;的&quot;</span>) - <span class="number">1</span>);</span><br><span class="line">            map.put(<span class="string">&quot;ip&quot;</span>, ip);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">json</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 这里调用百度的ip定位api服务 详见 http://api.map.baidu.com/lbsapi/cloud/ip-location-api.htm</span></span><br><span class="line">            json = readJsonFromUrl(<span class="string">&quot;http://api.map.baidu.com/location/ip?ak=laOQElaF53xGGBjscGtrd10nN4j1zGki&amp;ip=&quot;</span> + ip);</span><br><span class="line">            <span class="comment">//city = (((JSONObject) ((JSONObject) json.get(&quot;content&quot;)).get(&quot;address_detail&quot;)).get(&quot;city&quot;)).toString();</span></span><br><span class="line">            map.put(<span class="string">&quot;city&quot;</span>, ((JSONObject) ((JSONObject) json.get(<span class="string">&quot;content&quot;</span>)).get(<span class="string">&quot;address_detail&quot;</span>)).get(<span class="string">&quot;city&quot;</span>).toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLocalCityName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GetLocationAndIP</span> <span class="variable">getLocationANDIp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetLocationAndIP</span>();</span><br><span class="line">        Map&lt;String, Object&gt; map = getLocationANDIp.getAddress();</span><br><span class="line">        <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> map.get(<span class="string">&quot;city&quot;</span>).toString();</span><br><span class="line">        <span class="keyword">return</span> city.substring(<span class="number">0</span>, city.length() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GetLocationAndIP</span> <span class="variable">getLocationANDIp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetLocationAndIP</span>();</span><br><span class="line">        Map&lt;String, Object&gt; map = getLocationANDIp.getAddress();</span><br><span class="line">        <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> map.get(<span class="string">&quot;city&quot;</span>).toString();</span><br><span class="line">        <span class="type">String</span> <span class="variable">city_1</span> <span class="operator">=</span> city.substring(<span class="number">0</span>, city.length() - <span class="number">1</span>);</span><br><span class="line">        System.out.println(city_1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.json<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>20090211<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>由此，天气小demo就跑起来了，效果图如下：</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306141758797.png"
                      alt="image-20230614175845403"
                ></p>
<h1 id="十二、JWT"><a href="#十二、JWT" class="headerlink" title="十二、JWT"></a>十二、JWT</h1><h2 id="1-跨域认证的问题"><a href="#1-跨域认证的问题" class="headerlink" title="1.跨域认证的问题"></a>1.跨域认证的问题</h2><ul>
<li>互联网服务离不开用户认证。一般流程是下面这样。</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1、用户向服务器发送用户名和密码。</span><br><span class="line"></span><br><span class="line">2、服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间等等。</span><br><span class="line"></span><br><span class="line">3、服务器向用户返回一个 session_id，写入用户的 Cookie。</span><br><span class="line"></span><br><span class="line">4、用户随后的每一次请求，都会通过 Cookie，将 session_id 传回服务器。</span><br><span class="line"></span><br><span class="line">5、服务器收到 session_id，找到前期保存的数据，由此得知用户的身份。</span><br></pre></td></tr></table></figure>

<ul>
<li>这种模式的问题在于，扩展性（scaling）不好。单机当然没有问题，如果是服务器集群，或者是<strong>跨域的服务导向架构，就要求 session 数据共享，每台服务器都能够读取 session。</strong></li>
<li>举例来说，A 网站和 B 网站是同一家公司的关联服务。现在要求，用户只要在其中一个网站登录，再访问另一个网站就会自动登录，请问怎么实现？</li>
<li>一种解决方案是 <strong>session 数据持久化</strong>，写入数据库或别的持久层。各种服务收到请求后，都向持久层请求数据。这种方案的优点是架构清晰，缺点是工程量比较大。另外，持久层万一挂了，就会单点失败。</li>
<li>另一种方案是服务器索性不保存 session 数据了，<strong>所有数据都保存在客户端</strong>，每次请求都发回服务器。JWT 就是这种方案的一个代表。</li>
</ul>
<h2 id="2-JWT-的原理"><a href="#2-JWT-的原理" class="headerlink" title="2.JWT 的原理"></a>2.JWT 的原理</h2><p>JWT 的原理是，服务器认证以后，生成一个 JSON 对象，发回给用户，就像下面这样。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;姓名&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="string">&quot;角色&quot;</span>: <span class="string">&quot;管理员&quot;</span>,</span><br><span class="line">  <span class="string">&quot;到期时间&quot;</span>: <span class="string">&quot;2018年7月1日0点0分&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li>以后，用户与服务端通信的时候，都要发回这个 JSON 对象。服务器完全只靠这个对象认定用户身份。为了防止用户篡改数据，服务器在生成这个对象的时候，会加上签名（详见后文）。</li>
<li>服务器就不保存任何 session 数据了，也就是说，服务器变成无状态了，从而比较容易实现扩展。</li>
</ul>
<h2 id="3-JWT-的数据结构"><a href="#3-JWT-的数据结构" class="headerlink" title="3.JWT 的数据结构"></a>3.JWT 的数据结构</h2><p>实际的 JWT 大概就像下面这样。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://www.wangbase.com/blogimg/asset/201807/bg2018072304.jpg"
                      alt="img"
                ></p>
<p>它是一个很长的字符串，中间用点（<code>.</code>）分隔成三个部分。注意，JWT 内部是没有换行的，这里只是为了便于展示，将它写成了几行。</p>
<p>JWT 的三个部分依次如下。</p>
<blockquote>
<ul>
<li>Header（头部）</li>
<li>Payload（负载）</li>
<li>Signature（签名）</li>
</ul>
</blockquote>
<p>写成一行，就是下面的样子。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Header</span>.<span class="property">Payload</span>.<span class="property">Signature</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://www.wangbase.com/blogimg/asset/201807/bg2018072303.jpg"
                      alt="img"
                ></p>
<p>下面依次介绍这三个部分。</p>
<h3 id="3-1-Header"><a href="#3-1-Header" class="headerlink" title="3.1 Header"></a>3.1 Header</h3><p>Header 部分是一个 JSON 对象，描述 JWT 的元数据，通常是下面的样子。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">  <span class="string">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面代码中，<code>alg</code>属性表示签名的算法（algorithm），默认是 HMAC SHA256（写成 HS256）；<code>typ</code>属性表示这个令牌（token）的类型（type），JWT 令牌统一写为<code>JWT</code>。</p>
<p>最后，将上面的 JSON 对象使用 Base64URL 算法（详见后文）转成字符串。</p>
<h3 id="3-2-Payload"><a href="#3-2-Payload" class="headerlink" title="3.2 Payload"></a>3.2 Payload</h3><p>Payload 部分也是一个 JSON 对象，用来存放实际需要传递的数据。JWT 规定了7个官方字段，供选用。</p>
<blockquote>
<ul>
<li>iss (issuer)：签发人</li>
<li>exp (expiration time)：过期时间</li>
<li>sub (subject)：主题</li>
<li>aud (audience)：受众</li>
<li>nbf (Not Before)：生效时间</li>
<li>iat (Issued At)：签发时间</li>
<li>jti (JWT ID)：编号</li>
</ul>
</blockquote>
<p>除了官方字段，你还可以在这个部分定义私有字段，下面就是一个例子。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;sub&quot;</span>: <span class="string">&quot;1234567890&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">  <span class="string">&quot;admin&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>注意，JWT 默认是不加密的，任何人都可以读到，所以不要把秘密信息放在这个部分。</p>
<p>这个 JSON 对象也要使用 Base64URL 算法转成字符串。</p>
<h3 id="3-3-Signature"><a href="#3-3-Signature" class="headerlink" title="3.3 Signature"></a>3.3 Signature</h3><p>Signature 部分是对前两部分的签名，防止数据篡改。</p>
<p>首先，需要指定一个密钥（secret）。这个密钥只有服务器才知道，不能泄露给用户。然后，使用 Header 里面指定的签名算法（默认是 HMAC SHA256），按照下面的公式产生签名。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">HMACSHA256</span>(</span><br><span class="line">  <span class="title function_">base64UrlEncode</span>(header) + <span class="string">&quot;.&quot;</span> +</span><br><span class="line">  <span class="title function_">base64UrlEncode</span>(payload),</span><br><span class="line">  secret)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用”点”（<code>.</code>）分隔，就可以返回给用户。</p>
<h3 id="3-4-Base64URL"><a href="#3-4-Base64URL" class="headerlink" title="3.4 Base64URL"></a>3.4 Base64URL</h3><p>前面提到，Header 和 Payload 串型化的算法是 Base64URL。这个算法跟 Base64 算法基本类似，但有一些小的不同。</p>
<p>JWT 作为一个令牌（token），有些场合可能会放到 URL（比如 api.example.com&#x2F;?token&#x3D;xxx）。Base64 有三个字符<code>+</code>、<code>/</code>和<code>=</code>，在 URL 里面有特殊含义，所以要被替换掉：<code>=</code>被省略、<code>+</code>替换成<code>-</code>，<code>/</code>替换成<code>_</code> 。这就是 Base64URL 算法。</p>
<h2 id="4-JWT-的使用方式"><a href="#4-JWT-的使用方式" class="headerlink" title="4.JWT 的使用方式"></a>4.JWT 的使用方式</h2><p>客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage。</p>
<p>此后，客户端每次与服务器通信，都要带上这个 JWT。你可以把它放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求的头信息<code>Authorization</code>字段里面。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Authorization</span>: <span class="title class_">Bearer</span> &lt;token&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>另一种做法是，跨域的时候，JWT 就放在 POST 请求的数据体里面。</p>
<h2 id="5-JWT-的几个特点"><a href="#5-JWT-的几个特点" class="headerlink" title="5.JWT 的几个特点"></a>5.JWT 的几个特点</h2><p>（1）JWT 默认是不加密，但也是可以加密的。<strong>生成原始 Token 以后，可以用密钥再加密一次。</strong></p>
<p>（2）JWT 不加密的情况下，不能将秘密数据写入 JWT。</p>
<p>（3）<strong>JWT 不仅可以用于认证，也可以用于交换信息</strong>。有效使用 JWT，可以降低服务器查询数据库的次数。</p>
<p>（4）JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，<strong>一旦 JWT 签发了，在到期之前就会始终有效</strong>，除非服务器部署额外的逻辑。</p>
<p>（5）JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。<strong>对于一些比较重要的权限，使用时应该再次对用户进行认证</strong>。</p>
<p>（6）<strong>为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输。</strong></p>
<h2 id="6-ry是怎么践行JWT的呢？"><a href="#6-ry是怎么践行JWT的呢？" class="headerlink" title="6.ry是怎么践行JWT的呢？"></a>6.ry是怎么践行JWT的呢？</h2><ol>
<li>问题一：不登录的时候有token吗？<ul>
<li>答：没有，所以只能在login页面，凡是想跳转其他界面，都被重定向到登录，硬生生让你登录。前端阻拦的代码在permission.js如下：</li>
</ul>
</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306151411324.png"
                      alt="image-20230615141138093"
                ></p>
<ol start="2">
<li>问题二：token什么时候生成的？<ul>
<li>答：登录的时候生成的，具体代码讲述：</li>
</ul>
</li>
</ol>
<ul>
<li>在login控制器的SysLoginService层代码中，有login方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String username, String password, String code, String uuid)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">captchaOnOff</span> <span class="operator">=</span> configService.selectCaptchaOnOff();</span><br><span class="line">        <span class="comment">// 验证码开关</span></span><br><span class="line">        <span class="keyword">if</span> (captchaOnOff)</span><br><span class="line">        &#123;</span><br><span class="line">            validateCaptcha(username, code, uuid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 用户验证</span></span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 该方法会去调用UserDetailsServiceImpl.loadUserByUsername</span></span><br><span class="line">            authentication = authenticationManager</span><br><span class="line">                    .authenticate(<span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BadCredentialsException)</span><br><span class="line">            &#123;</span><br><span class="line">                AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, MessageUtils.message(<span class="string">&quot;user.password.not.match&quot;</span>)));</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UserPasswordNotMatchException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, e.getMessage()));</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_SUCCESS, MessageUtils.message(<span class="string">&quot;user.login.success&quot;</span>)));</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> (LoginUser) authentication.getPrincipal();</span><br><span class="line">        recordLoginInfo(loginUser.getUserId());</span><br><span class="line">        <span class="comment">// 生成token</span></span><br><span class="line">        <span class="keyword">return</span> tokenService.createToken(loginUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>最后一句话，他说生成token，于是他执行TokenService：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> String <span class="title function_">createToken</span><span class="params">(LoginUser loginUser)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> IdUtils.fastUUID();</span><br><span class="line">        loginUser.setToken(token);</span><br><span class="line">        setUserAgent(loginUser);</span><br><span class="line">        refreshToken(loginUser);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        claims.put(Constants.LOGIN_USER_KEY, token);</span><br><span class="line">        <span class="keyword">return</span> createToken(claims);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后它又是最后一个话在生成token，TokenService点进去我们才看到真的生成方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">createToken</span><span class="params">(Map&lt;String, Object&gt; claims)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setClaims(claims)</span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, secret).compact();</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>现在token生成好了，大家要注意，refreshToken方法已经把当前成功登录的人的信息存到了redis中，前缀是login_tokens: + 当前的tokenId，tokenId是一个uuid。</li>
<li>所以再看login方法，不仅仅生成了token，还把登录人的信息存到了Redis中。方便下次用户带着token来的时候，后端可以拿到tokenId来redis中找用户的tokenId是否存在。</li>
</ul>
<ol start="3">
<li>问题三，用户登录后，发请求是怎么自动带上token的？</li>
</ol>
<ul>
<li>登录成功的时候，前端存了一份token在cookie中，登录代码user.js如下：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录</span></span><br><span class="line"><span class="title class_">Login</span>(&#123; commit &#125;, userInfo) &#123;</span><br><span class="line">  <span class="keyword">const</span> username = userInfo.<span class="property">username</span>.<span class="title function_">trim</span>()</span><br><span class="line">  <span class="keyword">const</span> password = userInfo.<span class="property">password</span></span><br><span class="line">  <span class="keyword">const</span> code = userInfo.<span class="property">code</span></span><br><span class="line">  <span class="keyword">const</span> uuid = userInfo.<span class="property">uuid</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">login</span>(username, password, code, uuid).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setToken</span>(res.<span class="property">token</span>)</span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;SET_TOKEN&#x27;</span>, res.<span class="property">token</span>)</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">reject</span>(error)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>引入眼帘有一个setToken，里面就将token放cookie，代码auth.js如下：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setToken</span>(<span class="params">token</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Cookies</span>.<span class="title function_">set</span>(<span class="title class_">TokenKey</span>, token)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来如果要发请求，request.js会自动带上，如下代码：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306151437006.png"
                      alt="image-20230615143747780"
                ></p>
<ul>
<li>可以看到，它会去config.headers看看到底要不要，如果我们在请求头指定了不要，那么发请求就不会带上token，否则就会被带上token。</li>
</ul>
<ol start="4">
<li>问题四：我再次请求的时候带上了token，后端在哪问我带没带token呢？</li>
</ol>
<ul>
<li>其实后端有一个拦截器，总是在悄悄检查。如下代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.security.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.web.service.TokenService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * token过滤器 验证token有效性</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUser(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(loginUser) &amp;&amp; StringUtils.isNull(SecurityUtils.getAuthentication()))</span><br><span class="line">        &#123;</span><br><span class="line">            tokenService.verifyToken(loginUser);</span><br><span class="line">            <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, loginUser.getAuthorities());</span><br><span class="line">            authenticationToken.setDetails(<span class="keyword">new</span> <span class="title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>getLoginUser方法总是在试图拿到token。然后验证token是否正确，token有没有过期，然后把用户该有的权限重新设置在上下文中。</li>
<li>该拦截器是在SecurityConfig设置的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * anyRequest          |   匹配所有请求路径</span></span><br><span class="line"><span class="comment"> * access              |   SpringEl表达式结果为true时可以访问</span></span><br><span class="line"><span class="comment"> * anonymous           |   匿名可以访问</span></span><br><span class="line"><span class="comment"> * denyAll             |   用户不能访问</span></span><br><span class="line"><span class="comment"> * fullyAuthenticated  |   用户完全认证可以访问（非remember-me下自动登录）</span></span><br><span class="line"><span class="comment"> * hasAnyAuthority     |   如果有参数，参数表示权限，则其中任何一个权限可以访问</span></span><br><span class="line"><span class="comment"> * hasAnyRole          |   如果有参数，参数表示角色，则其中任何一个角色可以访问</span></span><br><span class="line"><span class="comment"> * hasAuthority        |   如果有参数，参数表示权限，则其权限可以访问</span></span><br><span class="line"><span class="comment"> * hasIpAddress        |   如果有参数，参数表示IP地址，如果用户IP和参数匹配，则可以访问</span></span><br><span class="line"><span class="comment"> * hasRole             |   如果有参数，参数表示角色，则其角色可以访问</span></span><br><span class="line"><span class="comment"> * permitAll           |   用户可以任意访问</span></span><br><span class="line"><span class="comment"> * rememberMe          |   允许通过remember-me登录的用户访问</span></span><br><span class="line"><span class="comment"> * authenticated       |   用户登录后可访问</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注解标记允许匿名访问的url</span></span><br><span class="line">    ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.<span class="type">ExpressionInterceptUrlRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> httpSecurity.authorizeRequests();</span><br><span class="line">    permitAllUrl.getUrls().forEach(url -&gt; registry.antMatchers(url).permitAll());</span><br><span class="line"></span><br><span class="line">    httpSecurity</span><br><span class="line">            <span class="comment">// CSRF禁用，因为不使用session</span></span><br><span class="line">            .csrf().disable()</span><br><span class="line">            <span class="comment">// 禁用HTTP响应标头</span></span><br><span class="line">            .headers().cacheControl().disable().and()</span><br><span class="line">            <span class="comment">// 认证失败处理类</span></span><br><span class="line">            .exceptionHandling().authenticationEntryPoint(unauthorizedHandler).and()</span><br><span class="line">            <span class="comment">// 基于token，所以不需要session</span></span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()</span><br><span class="line">            <span class="comment">// 过滤请求</span></span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            <span class="comment">// 对于登录login 注册register 验证码captchaImage 允许匿名访问</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/captchaImage&quot;</span>).permitAll()</span><br><span class="line">            <span class="comment">// 静态资源，可匿名访问</span></span><br><span class="line">            .antMatchers(HttpMethod.GET, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;/*.html&quot;</span>, <span class="string">&quot;/**/*.html&quot;</span>, <span class="string">&quot;/**/*.css&quot;</span>, <span class="string">&quot;/**/*.js&quot;</span>, <span class="string">&quot;/profile/**&quot;</span>).permitAll()</span><br><span class="line">            .antMatchers(<span class="string">&quot;/swagger-ui.html&quot;</span>, <span class="string">&quot;/swagger-resources/**&quot;</span>, <span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;/*/api-docs&quot;</span>, <span class="string">&quot;/druid/**&quot;</span>).permitAll()</span><br><span class="line">            <span class="comment">// 除上面外的所有请求全部需要鉴权认证</span></span><br><span class="line">            .anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .headers().frameOptions().disable();</span><br><span class="line">    <span class="comment">// 添加Logout filter</span></span><br><span class="line">    httpSecurity.logout().logoutUrl(<span class="string">&quot;/logout&quot;</span>).logoutSuccessHandler(logoutSuccessHandler);</span><br><span class="line">    <span class="comment">// 添加JWT filter</span></span><br><span class="line">    httpSecurity.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    <span class="comment">// 添加CORS filter</span></span><br><span class="line">    httpSecurity.addFilterBefore(corsFilter, JwtAuthenticationTokenFilter.class);</span><br><span class="line">    httpSecurity.addFilterBefore(corsFilter, LogoutFilter.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十三、ry如何践行SpringSecurity用于认证"><a href="#十三、ry如何践行SpringSecurity用于认证" class="headerlink" title="十三、ry如何践行SpringSecurity用于认证"></a>十三、ry如何践行SpringSecurity用于认证</h1><h2 id="1-SpringSecurity基础"><a href="#1-SpringSecurity基础" class="headerlink" title="1.SpringSecurity基础"></a>1.SpringSecurity基础</h2><ol>
<li>先看一个篇文章<a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/342755411?utm_medium=social&amp;utm_oi=1343915562263547904" >https://zhuanlan.zhihu.com/p/342755411?utm_medium=social&amp;utm_oi=1343915562263547904<i class="fas fa-external-link-alt"></i></a></li>
<li>简而言之，如果要自定义认证逻辑，需要我们去写一个类，实现UserDetailsService接口。UserDetailsService中重写loadUserByUsername方法，该方法是通过username找到用户，往往是通过数据库查询。loadUserByUsername方法的返回值是一个实现UserDetails接口的类，该类是为了存储从数据库查询用户的详细信息的点点滴滴【见名知意，UserDetails意为用户细节】。</li>
</ol>
<h2 id="2-Ry是如何践行这套规则？"><a href="#2-Ry是如何践行这套规则？" class="headerlink" title="2.Ry是如何践行这套规则？"></a>2.Ry是如何践行这套规则？</h2><ol>
<li>在SysLoginService的login方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户验证</span></span><br><span class="line"><span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">    AuthenticationContextHolder.setContext(authenticationToken);</span><br><span class="line">    <span class="comment">// 该方法会去调用UserDetailsServiceImpl.loadUserByUsername</span></span><br><span class="line">    authentication = authenticationManager.authenticate(authenticationToken);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BadCredentialsException)</span><br><span class="line">    &#123;</span><br><span class="line">        AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, MessageUtils.message(<span class="string">&quot;user.password.not.match&quot;</span>)));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UserPasswordNotMatchException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, e.getMessage()));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在ry中，SpringSecurity接管了整个后端的认证和授权，我们现在来看认证相关的问题。登录的时候，执行了一句代码：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authentication = authenticationManager.authenticate(authenticationToken);</span><br></pre></td></tr></table></figure>

<ul>
<li>根据ry作者的提示，会去自动执行loadUserByUsername方法，那么为何会去执行loadUserByUsername方法呢？</li>
<li>事实上，我们使用SpringSecurity用来认证的时候，<strong>只需要调用AuthenticationManager接口上的authenticate方法即可</strong>。若需要获得AuthenticationManager的实例，则需要写个类，该类继承WebSecurityConfigurerAdapter类，然后通过重写下面的代码可以获得认证管理器：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解决 无法直接注入 AuthenticationManager</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在ry中的SecurityConfig类正好就是写了该代码，如此操作之后，认证管理器被注入到了Spring容器中，可以在Spring环境中随时获得认证管理器的Bean。</li>
<li>在我们的登录SysLoginService类中，通过下面的代码把认证管理器拿来了：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br></pre></td></tr></table></figure>

<ul>
<li>此时，在此我们只需要调用authenticationManager实例的authenticate方法即可完成认证。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">   ...省略其他代码</span><br><span class="line"> <span class="comment">// 传递过来的用户名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">    <span class="comment">// 调用UserDetailService的方法，通过用户名查询出用户对象UserDetail（查询不出来UserDetailService则会抛出异常）</span></span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> <span class="built_in">this</span>.getUserDetailsService().loadUserByUsername(username);</span><br><span class="line">    <span class="type">String</span> <span class="variable">presentedPassword</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 传递过来的密码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line">    <span class="comment">// 使用密码解析器PasswordEncoder传递过来的密码是否和真实的用户密码匹配</span></span><br><span class="line">    <span class="keyword">if</span> (!passwordEncoder.matches(password, userDetails.getPassword())) &#123;</span><br><span class="line">        <span class="comment">// 密码错误则抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="string">&quot;错误信息...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 注意哦，这里返回的已认证Authentication，是将整个UserDetails放进去充当Principal</span></span><br><span class="line">    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(userDetails,</span><br><span class="line">                authentication.getCredentials(), userDetails.getAuthorities());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    ...省略其他代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>UserDetialsService UserDetails PasswordEncoder，这三个组件Spring Security都有默认实现，这一般是满足不了我们的实际需求的，所以这里我们自己来实现这些组件！</li>
<li>ry写了UserDetailsServiceImpl类实现了UserDetialsService 接口，并重写了loadUserByUsername方法，该方法返回UserDetails接口实例对象，ry并不满足于SpringSecurity提供的User类，于是自己写了LoginUser类，LoginUser类实现了UserDetails接口，并重写了接口内要求的方法getPassword和getUsername，其他方法并不重要，ry仅仅简单返回一个true。值得注意的是，getAuthorities方法ry仅仅是简单返回一个null！！！原因是因为ry有着自己的一套权限检查方法。</li>
<li>对于PasswordEncoder，ry使用的BCryptPasswordEncoder，只需要注入到Spring容器即可被SpringSecurity找到，当然在Spring容器中也方便我们在注册的时候也拿到该单例对象对密码做加密处理：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>    </span><br><span class="line"><span class="keyword">public</span> BCryptPasswordEncoder <span class="title function_">bCryptPasswordEncoder</span><span class="params">()</span></span><br><span class="line">&#123;        </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ry的UserDetailsServiceImpl类中的loadUserByUsername方法主要是去数据库查询，通过username找到需要检索的用户，然后对用户做简单校验：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (StringUtils.isNull(user))</span><br><span class="line">&#123;</span><br><span class="line">    log.info(<span class="string">&quot;登录用户：&#123;&#125; 不存在.&quot;</span>, username);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;登录用户：&quot;</span> + username + <span class="string">&quot; 不存在&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (UserStatus.DELETED.getCode().equals(user.getDelFlag()))</span><br><span class="line">&#123;</span><br><span class="line">    log.info(<span class="string">&quot;登录用户：&#123;&#125; 已被删除.&quot;</span>, username);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;对不起，您的账号：&quot;</span> + username + <span class="string">&quot; 已被删除&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (UserStatus.DISABLE.getCode().equals(user.getStatus()))</span><br><span class="line">&#123;</span><br><span class="line">    log.info(<span class="string">&quot;登录用户：&#123;&#125; 已被停用.&quot;</span>, username);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;对不起，您的账号：&quot;</span> + username + <span class="string">&quot; 已停用&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>之后，ry就想new LoginUser，LoginUser类是loadUserByUsername方法返回值所需要的，如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user.getUserId(), user.getDeptId(), user, permissionService.getMenuPermission(user));</span><br></pre></td></tr></table></figure>

<ul>
<li>这里把用户id，部门，用户详情“user”都封装进入了LoginUser的实例。需要注意最后一个参数，这里去数据库查询了权限！！！也就是查询登录人的权限【包括页面权限和按钮权限】。关于权限，后面再说。</li>
<li>接下来，SpringSecurity会自动去检查密码对不对</li>
<li>认证完成之后，login方法拿着经过认证的authentication实例生成了token，并把token和LoginUser存到了Redis，再把token返回给了前端。</li>
<li>前端拿到token就立刻存到了cookie中，并且下次给后端发请求的时候带上了token表明自己的身份。</li>
<li>每一次后端被请求时，都会执行JwtAuthenticationTokenFilter过滤器，该过滤器是在从请求request的请求头（key为Authorization的条目）中获得token，然后验证token，验证成功则直接封装一个已经成功认证的信息authenticationToken，并存在上下文中。相关代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.security.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.web.service.TokenService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * token过滤器 验证token有效性</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUser(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(loginUser) &amp;&amp; StringUtils.isNull(SecurityUtils.getAuthentication()))</span><br><span class="line">        &#123;</span><br><span class="line">            tokenService.verifyToken(loginUser);</span><br><span class="line">            <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, loginUser.getAuthorities());</span><br><span class="line">            authenticationToken.setDetails(<span class="keyword">new</span> <span class="title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-ry认证出现问题如何处理的？"><a href="#3-ry认证出现问题如何处理的？" class="headerlink" title="3.ry认证出现问题如何处理的？"></a>3.ry认证出现问题如何处理的？</h2><ol>
<li>认证配置类中最重要的HttpSecurity配置如下：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * anyRequest          |   匹配所有请求路径</span></span><br><span class="line"><span class="comment"> * access              |   SpringEl表达式结果为true时可以访问</span></span><br><span class="line"><span class="comment"> * anonymous           |   匿名可以访问</span></span><br><span class="line"><span class="comment"> * denyAll             |   用户不能访问</span></span><br><span class="line"><span class="comment"> * fullyAuthenticated  |   用户完全认证可以访问（非remember-me下自动登录）</span></span><br><span class="line"><span class="comment"> * hasAnyAuthority     |   如果有参数，参数表示权限，则其中任何一个权限可以访问</span></span><br><span class="line"><span class="comment"> * hasAnyRole          |   如果有参数，参数表示角色，则其中任何一个角色可以访问</span></span><br><span class="line"><span class="comment"> * hasAuthority        |   如果有参数，参数表示权限，则其权限可以访问</span></span><br><span class="line"><span class="comment"> * hasIpAddress        |   如果有参数，参数表示IP地址，如果用户IP和参数匹配，则可以访问</span></span><br><span class="line"><span class="comment"> * hasRole             |   如果有参数，参数表示角色，则其角色可以访问</span></span><br><span class="line"><span class="comment"> * permitAll           |   用户可以任意访问</span></span><br><span class="line"><span class="comment"> * rememberMe          |   允许通过remember-me登录的用户访问</span></span><br><span class="line"><span class="comment"> * authenticated       |   用户登录后可访问</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注解标记允许匿名访问的url</span></span><br><span class="line">    ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.<span class="type">ExpressionInterceptUrlRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> httpSecurity.authorizeRequests();</span><br><span class="line">    permitAllUrl.getUrls().forEach(url -&gt; registry.antMatchers(url).permitAll());</span><br><span class="line"></span><br><span class="line">    httpSecurity</span><br><span class="line">            <span class="comment">// CSRF禁用，因为不使用session</span></span><br><span class="line">            .csrf().disable()</span><br><span class="line">            <span class="comment">// 禁用HTTP响应标头</span></span><br><span class="line">            .headers().cacheControl().disable().and()</span><br><span class="line">            <span class="comment">// 认证失败处理类</span></span><br><span class="line">            .exceptionHandling().authenticationEntryPoint(unauthorizedHandler).and()</span><br><span class="line">            <span class="comment">// 基于token，所以不需要session</span></span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()</span><br><span class="line">            <span class="comment">// 过滤请求</span></span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            <span class="comment">// 对于登录login 注册register 验证码captchaImage 允许匿名访问</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/captchaImage&quot;</span>).permitAll()</span><br><span class="line">            <span class="comment">// 静态资源，可匿名访问</span></span><br><span class="line">            .antMatchers(HttpMethod.GET, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;/*.html&quot;</span>, <span class="string">&quot;/**/*.html&quot;</span>, <span class="string">&quot;/**/*.css&quot;</span>, <span class="string">&quot;/**/*.js&quot;</span>, <span class="string">&quot;/profile/**&quot;</span>).permitAll()</span><br><span class="line">            .antMatchers(<span class="string">&quot;/swagger-ui.html&quot;</span>, <span class="string">&quot;/swagger-resources/**&quot;</span>, <span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;/*/api-docs&quot;</span>, <span class="string">&quot;/druid/**&quot;</span>).permitAll()</span><br><span class="line">            <span class="comment">// 除上面外的所有请求全部需要鉴权认证</span></span><br><span class="line">            .anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .headers().frameOptions().disable();</span><br><span class="line">    <span class="comment">// 添加Logout filter</span></span><br><span class="line">    httpSecurity.logout().logoutUrl(<span class="string">&quot;/logout&quot;</span>).logoutSuccessHandler(logoutSuccessHandler);</span><br><span class="line">    <span class="comment">// 添加JWT filter</span></span><br><span class="line">    httpSecurity.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    <span class="comment">// 添加CORS filter</span></span><br><span class="line">    httpSecurity.addFilterBefore(corsFilter, JwtAuthenticationTokenFilter.class);</span><br><span class="line">    httpSecurity.addFilterBefore(corsFilter, LogoutFilter.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在SecurityConfig类中明确指定了认证失败后handle：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.exceptionHandling().authenticationEntryPoint(unauthorizedHandler).and()</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>也就是如下的方式来处理：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.security.handle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSON;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证失败处理类 返回未授权</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationEntryPointImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span>, Serializable</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8970718410437077606L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> HttpStatus.UNAUTHORIZED;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> StringUtils.format(<span class="string">&quot;请求访问：&#123;&#125;，认证失败，无法访问系统资源&quot;</span>, request.getRequestURI());</span><br><span class="line">        ServletUtils.renderString(response, JSON.toJSONString(AjaxResult.error(code, msg)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到如果认证失败就简单返回一句话【请求访问：{}，认证失败，无法访问系统资源】。</li>
<li>通过postman或apifox等发请求的软件，随便给后端发一个请求，很容易就能得到一个这样的返回：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306151701160.png"
                      alt="图片"
                ></p>
<h2 id="4-新问题：postman如何调接口？"><a href="#4-新问题：postman如何调接口？" class="headerlink" title="4.新问题：postman如何调接口？"></a>4.新问题：postman如何调接口？</h2><ul>
<li>现在有一个这样的问题，遇到认证失败，但是自己想用postman、apifox、apipost等软件就想要调通API，怎么办？现在介绍一种方法，因为超级管理员是无视一切权限的，只要用上超级管理员的token，一切权限都能轻轻松松越过去。</li>
<li>然而，如果用上了超级管理员token，一切查询方面的结果都是和超级管理员有关的，有时候可能并不是自己想要的，这就需要给授权，后面再说。</li>
</ul>
<h2 id="5-Swagger好像也调不通"><a href="#5-Swagger好像也调不通" class="headerlink" title="5.Swagger好像也调不通"></a>5.Swagger好像也调不通</h2><ol>
<li>swagger也不通，如下：</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306151704484.png"
                      alt="image-20230615170430330"
                ></p>
<ol start="2">
<li>也是因为没有权限，如下方式加上token就能调通：</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306151705365.png"
                      alt="image-20230615170506089"
                ></p>
<h1 id="十四、深入认证源码过滤器链"><a href="#十四、深入认证源码过滤器链" class="headerlink" title="十四、深入认证源码过滤器链"></a>十四、深入认证源码过滤器链</h1><h2 id="1-手动修改过滤器链和认识addFilterAfter方法"><a href="#1-手动修改过滤器链和认识addFilterAfter方法" class="headerlink" title="1.手动修改过滤器链和认识addFilterAfter方法"></a>1.手动修改过滤器链和认识addFilterAfter方法</h2><h3 id="1-手动修改过滤器链和认识addFilterAfter方法-1"><a href="#1-手动修改过滤器链和认识addFilterAfter方法-1" class="headerlink" title="1.手动修改过滤器链和认识addFilterAfter方法"></a>1.手动修改过滤器链和认识addFilterAfter方法</h3><p>我们知道，SpringSecurity的机制无非就是过滤器链，一个一个执行过滤器，当前ry的过滤器链如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161040165.png"
                      alt="图片"
                ></p>
<ul>
<li>这里我先看cors（处理跨域）的过滤器有两个，但是处理跨域的过滤器只会执行一次（因为继承了<strong>OncePerRequestFilter</strong>），所以没有加入两个解决跨域过滤器的必要。所以我删除了一个，我怎么删除的呢？我直接在ry添加两个过滤器的地方注释了一个：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161043455.png"
                      alt="image-20230616104344315"
                ></p>
<ul>
<li>从上面的红色框可以看出，我就是删除了在JwtAuthenticationTokenFilter过滤器前面的一个cors过滤器。</li>
<li><strong>addFilterBefore（参数一，参数二）方法的功能是添加一个过滤器，并且添加到参数二过滤器之前。</strong></li>
<li>当我删除了一个跨域过滤器之后，新的过滤器链如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161045869.png"
                      alt="图片"
                ></p>
<h3 id="2-新方法：addFilterAfter"><a href="#2-新方法：addFilterAfter" class="headerlink" title="2.新方法：addFilterAfter"></a>2.新方法：addFilterAfter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        httpSecurity.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);           </span></span><br><span class="line">       httpSecurity.addFilterAfter(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br></pre></td></tr></table></figure>

<ul>
<li>刚刚说到addFilterBefore是在添加到指定过滤器之前，而addFilterAfter相反，添加到指定过滤器之后。</li>
<li>通过addFilterAfter和addFilterBefore，我们可以控制additionalFilters过滤器链每一个过滤器的顺序。</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161055326.png"
                      alt="图片"
                ></p>
<ul>
<li>其实上面几行，已经用过了addFilterAfter方法，然而，这里虽然把addFilterBefore改成了addFilterAfter，但是其实结果还是一样的。</li>
<li>因为没有启用表单认证所以UsernamePasswordAuthenticationFilter被移除了。UsernamePasswordAuthenticationFilter自然也不起作用了，相当于我们刚刚的addFilterAfter其实就是取代了UsernamePasswordAuthenticationFilter的位置，由authenticationTokenFilter（JwtAuthenticationTokenFilter）实例来完成认证。</li>
</ul>
<h2 id="2-安全过滤器链条的每个过滤器作用"><a href="#2-安全过滤器链条的每个过滤器作用" class="headerlink" title="2.安全过滤器链条的每个过滤器作用"></a>2.安全过滤器链条的每个过滤器作用</h2><p>Tips：SpringSecurity成功认证的标志是上下文存储着经过认证的用户信息，像下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, loginUser.getAuthorities());</span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br></pre></td></tr></table></figure>

<ul>
<li>当前过滤器链共12个过滤器：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161111223.png"
                      alt="图片"
                ></p>
<ul>
<li><strong>WebAsyncManagerIntegrationFilter</strong>，用于将SecurityContext传递到异步线程中(异步线程就可以获取安全上下文)。</li>
<li><strong>SecurityContextPersistenceFilter</strong>，它主要是使用SecurityContextRepository在session中保存或更新一个SecurityContext，并将SecurityContext给以后的过滤器使用，来为后续filter建立所需的上下文。</li>
<li><strong>HeaderWriterFilter</strong>，它用于向请求的Header中添加相应的信息。</li>
<li><strong>CorsFilter</strong>，它用于处理跨域，ry有自定义此过滤器，如下：文件ResourcesConfig.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跨域配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CorsFilter <span class="title function_">corsFilter</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">    config.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 设置访问源地址</span></span><br><span class="line">    config.addAllowedOriginPattern(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置访问源请求头</span></span><br><span class="line">    config.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置访问源请求方法</span></span><br><span class="line">    config.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="comment">// 有效期 1800秒</span></span><br><span class="line">    config.setMaxAge(<span class="number">1800L</span>);</span><br><span class="line">    <span class="comment">// 添加映射路径，拦截一切请求</span></span><br><span class="line">    <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">    source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, config);</span><br><span class="line">    <span class="comment">// 返回新的CorsFilter</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CorsFilter</span>(source);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的配置可以让前端请求基本上是随便跨域了。ry把此过滤器设置了两次，一次在LogoutFilter.class之前，一次在JwtAuthenticationTokenFilter.class之前，但是被我删除了JwtAuthenticationTokenFilter.class前面的，但是执行的效果还是一样的。</li>
<li><strong>LogoutFilter，用于处理注销主体。</strong></li>
<li>LogoutFilter会去执行两个handler，分别是SecurityContextLogoutHandler和LogoutSuccessEventPublishingLogoutHandler。SecurityContextLogoutHandler用于清除上下文认证信息。做的一些关键代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.clearAuthentication) &#123;</span><br><span class="line">    <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.getContext();</span><br><span class="line">    context.setAuthentication((Authentication)<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SecurityContextHolder.clearContext();</span><br></pre></td></tr></table></figure>

<ul>
<li>LogoutSuccessEventPublishingLogoutHandler啥都没干，如果authentication已经是Null的情况下，正好上一个handler已经将authentication清理了，所以可以理解LogoutSuccessEventPublishingLogoutHandler啥都没做。<strong>如果前一个handler执行出现问题，本handler也可以理解为一种补偿机制，发布一个事件说authentication已经登出了</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.eventPublisher != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (authentication != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.eventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">LogoutSuccessEvent</span>(authentication));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ry对成功注销做了自定义实现：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.security.handle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.token.TokenService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.logout.LogoutSuccessHandler;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSON;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.manager.AsyncManager;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.manager.factory.AsyncFactory;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.web.service.TokenService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义退出处理类 返回成功</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogoutSuccessHandlerImpl</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退出处理</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUser(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(loginUser))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> loginUser.getUsername();</span><br><span class="line">            <span class="comment">// 删除用户缓存记录</span></span><br><span class="line">            tokenService.delLoginUser(loginUser.getToken());</span><br><span class="line">            <span class="comment">// 记录用户退出日志</span></span><br><span class="line">            AsyncManager.me().execute(AsyncFactory.recordLogininfor(userName, Constants.LOGOUT, <span class="string">&quot;退出成功&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ServletUtils.renderString(response, JSON.toJSONString(AjaxResult.success(<span class="string">&quot;退出成功&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>无非就是在退出的时候做一下收尾工作，清缓存，写登出日志，最后再返回一个退出成功的信息。</li>
<li><strong>JwtAuthenticationTokenFilter，用于认证用户</strong></li>
<li>当用户登陆成功之后，发请求会带上token，<strong>JwtAuthenticationTokenFilter</strong>是专门用于<strong>解析token并把认证成功的用户信息设置到上下文中</strong>，用于后续的鉴权（认证成功的LoginUser里面有字段里面带着用户的权限的）。相关代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.security.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.framework.web.service.TokenService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * token过滤器 验证token有效性</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> tokenService.getLoginUser(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(loginUser) &amp;&amp; StringUtils.isNull(SecurityUtils.getAuthentication()))</span><br><span class="line">        &#123;</span><br><span class="line">            tokenService.verifyToken(loginUser);</span><br><span class="line">            <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, loginUser.getAuthorities());</span><br><span class="line">            authenticationToken.setDetails(<span class="keyword">new</span> <span class="title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>RequestCacheAwareFilter</strong>，通过HttpSessionRequestCache内部维护了一个RequestCache，用于缓存HttpServletRequest。</li>
<li><strong>SecurityContextHolderAwareRequestFilter，针对ServletRequest进行了一次包装，使得request具有更加丰富的API。</strong>通过SecurityContextHolderAwareRequestWrapper把ServletRequest包装起来，多了一些方法如getUserPrincipal，getAuthentication方便后续的确认是否目前已经认证。因为在过滤器链条上面request和response一直在链条上传输，这也是包装request的原因。</li>
<li><strong>AnonymousAuthenticationFilter</strong>，当SecurityContextHolder中认证信息为空,则会创建一个匿名用户存入到SecurityContextHolder中。<strong>SpringSecurity为了兼容未登录的访问，也走了一套认证流程，只不过是一个匿名的身份</strong>。</li>
<li><strong>SessionManagementFilter</strong>，SecurityContextRepository限制同一用户开启多个会话的数量，但是<strong>前后端分离往往会禁用session，改用Redis存储用户会话状态。</strong></li>
<li><strong>ExceptionTranslationFilter，用于处理异常</strong>，它的过滤器方法直接放行，但是catch了许多异常例如认证过程的异常</li>
<li><strong>FilterSecurityInterceptor</strong>，获取所配置资源访问的授权信息，根据SecurityContextHolder中存储的用户信息来决定其是否有权限，然而ry自创了一套鉴权方式，所以原生FilterSecurityInterceptor这里不做展开。</li>
<li><strong>这些过滤器由一个代理管理</strong>，从上依次往下执行。下面我来来看一下代理（FilterChainProxy.VirtualFilterChain）的关键性代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.currentPosition == <span class="built_in">this</span>.size) &#123;</span><br><span class="line">     ...省略非关键代码 </span><br><span class="line">        <span class="comment">// Deactivate path stripping as we exit the security filter chain</span></span><br><span class="line">        <span class="built_in">this</span>.firewalledRequest.reset();</span><br><span class="line">        <span class="built_in">this</span>.originalChain.doFilter(request, response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ++<span class="built_in">this</span>.currentPosition;</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">nextFilter</span> <span class="operator">=</span> (Filter)<span class="built_in">this</span>.additionalFilters.get(<span class="built_in">this</span>.currentPosition - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (FilterChainProxy.logger.isTraceEnabled()) &#123;</span><br><span class="line">            FilterChainProxy.logger.trace(LogMessage.format(<span class="string">&quot;Invoking %s (%d/%d)&quot;</span>, nextFilter.getClass().getSimpleName(), <span class="built_in">this</span>.currentPosition, <span class="built_in">this</span>.size));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nextFilter.doFilter(request, response, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从上面的代码可以看得出，有一个名为additionalFilters的ArrayList存储了12个过滤器，一个一个依次执行，执行完毕之后继续执行originalChain里面的过滤器。</li>
</ul>
<h1 id="十五、RBAC"><a href="#十五、RBAC" class="headerlink" title="十五、RBAC"></a>十五、RBAC</h1><h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h2><ul>
<li><strong>RBAC是一种基于角色权限控制，进而控制用户的权限</strong>。具体而言，对系统操作的各种权限不是直接授予具体的用户，而是在<strong>用户集合与权限集合之间建立一个角色集合</strong>。每一种角色对应一组相应的权限。一旦用户被分配了适当的角色后，该用户就拥有此角色的所有操作权限。这样做的好处是，不必在每次创建用户时都进行分配权限的操作，只要分配用户相应的角色即可，而且角色的权限变更比用户的权限变更要少得多，这样将简化用户的权限管理，减少系统的开销。</li>
</ul>
<h2 id="2-什么是页面权限、按钮权限"><a href="#2-什么是页面权限、按钮权限" class="headerlink" title="2.什么是页面权限、按钮权限"></a>2.什么是页面权限、按钮权限</h2><ul>
<li>所谓页面权限，就是进入某个页面所需要的权限。</li>
<li>按钮权限则是能点击某个按钮所需要的权限。</li>
</ul>
<h2 id="3-权限表现形式"><a href="#3-权限表现形式" class="headerlink" title="3.权限表现形式"></a>3.权限表现形式</h2><ul>
<li><strong>对于权限，在程序中往往表现为一个字符串</strong>，比如说“system:user:add”表示对用户具有增加权限，当然也可以说“dsadsaddsadsadsa”表示对用户有增加权限，字符串是随意定的，但是为了符合人类的想法，要做到尽量的见名知意。</li>
<li>对于ry而言，在系统管理→菜单管理对每一个菜单对应了某种权限，如下图所示：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161358029.png"
                      alt="图片"
                ></p>
<ul>
<li>下面我们以岗位管理为例子，说明岗位管理的每个字符串的作用，岗位管理的权限字符串如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161358774.png"
                      alt="图片"
                ></p>
<ul>
<li>上图的岗位管理对应的字符串为“system:post:list”，该字符串的意思是，有了这个字符串才能查看岗位管理的菜单。</li>
<li>“system:post:query”字符串表示对单个岗位详情的查询权限。“system:post:add”表示增权限，“system:post:edit”表示修改权限，“system:post:remove”表示删岗位权限，“system:post:export”表示导出岗位数据Excel文件的权限。</li>
<li>岗位管理的“system:post:list”是<strong>页面权限</strong>，如果没有该权限，连菜单都看不到，自然页面也看不到。</li>
<li>其他的“system:post:add”、“system:post:edit”、“system:post:remove”、“system:post:export”都是<strong>按钮权限</strong>。</li>
<li>按钮权限在前端页面的表现就是能不能看到按钮，在后端的表现就是能不能执行按钮对应的controller的增删改查方法。</li>
</ul>
<h2 id="4-ry如何进行权限控制"><a href="#4-ry如何进行权限控制" class="headerlink" title="4.ry如何进行权限控制"></a>4.ry如何进行权限控制</h2><ul>
<li>在ry中，页面菜单、目录菜单和按钮菜单基本上都是存在数据库中（首页、404等特殊页面除外），在系统管理→菜单管理可以填写每一个菜单对应的权限字符串，不过目前目录菜单不能添加权限字符串。</li>
<li>当我们在菜单管理写好权限字符串之后，在角色管理我们可以添加角色，并把相关的权限赋予给角色。</li>
<li>角色和权限是多对多关系，<strong>一个权限可以给多个角色，一个角色可以有多个权限</strong>。</li>
<li>当我们让给角色赋权完毕之后，我们可以在角色管理页面直接给角色分配用户，比如把角色1和角色2分给用户1，那么用户1就会拥有角色1和角色2的全部权限。角色1和角色2的权限可以重复，但是没有双倍权限这种快乐。角色和用户的关系也是多对多，<strong>一个用户可以有多个角色，一个角色也可以给多个用户</strong>。</li>
<li>以上就是ry控制权限的基本思想。</li>
</ul>
<h1 id="十六、深入源码理解权限控制"><a href="#十六、深入源码理解权限控制" class="headerlink" title="十六、深入源码理解权限控制"></a>十六、深入源码理解权限控制</h1><h2 id="1-何时获得权限"><a href="#1-何时获得权限" class="headerlink" title="1.何时获得权限"></a>1.何时获得权限</h2><ol>
<li>对于ry系统的ry用户（userId&#x3D;2的用户），它是在登录的时候就在数据库得到了属于自己的权限。回顾登录过程，在执行loadUserByUsername方法的时候，权限就已经被拿到了：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.web.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.entity.SysUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.model.LoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.enums.UserStatus;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.exception.ServiceException;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.system.service.ISysUserService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户验证处理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(UserDetailsServiceImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ISysUserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysPasswordService passwordService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysPermissionService permissionService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">SysUser</span> <span class="variable">user</span> <span class="operator">=</span> userService.selectUserByUserName(username);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNull(user))</span><br><span class="line">        &#123;</span><br><span class="line">            log.info(<span class="string">&quot;登录用户：&#123;&#125; 不存在.&quot;</span>, username);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;登录用户：&quot;</span> + username + <span class="string">&quot; 不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (UserStatus.DELETED.getCode().equals(user.getDelFlag()))</span><br><span class="line">        &#123;</span><br><span class="line">            log.info(<span class="string">&quot;登录用户：&#123;&#125; 已被删除.&quot;</span>, username);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;对不起，您的账号：&quot;</span> + username + <span class="string">&quot; 已被删除&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (UserStatus.DISABLE.getCode().equals(user.getStatus()))</span><br><span class="line">        &#123;</span><br><span class="line">            log.info(<span class="string">&quot;登录用户：&#123;&#125; 已被停用.&quot;</span>, username);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;对不起，您的账号：&quot;</span> + username + <span class="string">&quot; 已停用&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        passwordService.validate(user);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> createLoginUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">createLoginUser</span><span class="params">(SysUser user)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user.getUserId(), user.getDeptId(), user, permissionService.getMenuPermission(user));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>permissionService.getMenuPermission(user)则是根据当前登录的用户查询该用户的权限。转到方法进去看看：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取菜单数据权限</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> user 用户信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 菜单权限信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getMenuPermission</span><span class="params">(SysUser user)</span></span><br><span class="line">&#123;</span><br><span class="line">    Set&lt;String&gt; perms = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line">    <span class="comment">// 管理员拥有所有权限</span></span><br><span class="line">    <span class="keyword">if</span> (user.isAdmin())</span><br><span class="line">    &#123;</span><br><span class="line">        perms.add(<span class="string">&quot;*:*:*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;SysRole&gt; roles = user.getRoles();</span><br><span class="line">        <span class="keyword">if</span> (!roles.isEmpty() &amp;&amp; roles.size() &gt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 多角色设置permissions属性，以便数据权限匹配权限</span></span><br><span class="line">            <span class="keyword">for</span> (SysRole role : roles)</span><br><span class="line">            &#123;</span><br><span class="line">                Set&lt;String&gt; rolePerms = menuService.selectMenuPermsByRoleId(role.getRoleId());</span><br><span class="line">                role.setPermissions(rolePerms);</span><br><span class="line">                perms.addAll(rolePerms);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            perms.addAll(menuService.selectMenuPermsByUserId(user.getUserId()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> perms;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从上面的代码可以看到，如果是超级管理员就给权限字符串为“*:*:*”，那么什么样的人是超级管理员呢？我们直接看源码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAdmin</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> isAdmin(<span class="built_in">this</span>.userId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isAdmin</span><span class="params">(Long userId)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> userId != <span class="literal">null</span> &amp;&amp; <span class="number">1L</span> == userId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>原来userId&#x3D;1的用户就是超级管理员，也就是说超级管理员是代码写死的，牛逼和气质是与生俱来的，在前端判断字符串也要先看看权限字符串是不是“*:*:*”，如果是就知道是大爷来了都让道，直接获得所有权限。</li>
<li>那么如果不是超级管理员呢？代码中是执行了perms.addAll(menuService.selectMenuPermsByUserId(user.getUserId()))，也就是获得当前用户的userId，拿着userId去数据库查询权限。继续进入Service层代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户ID查询权限</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 权限列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">selectMenuPermsByUserId</span><span class="params">(Long userId)</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;String&gt; perms = menuMapper.selectMenuPermsByUserId(userId);</span><br><span class="line">    Set&lt;String&gt; permsSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String perm : perms)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(perm))</span><br><span class="line">        &#123;</span><br><span class="line">            permsSet.addAll(Arrays.asList(perm.trim().split(<span class="string">&quot;,&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> permsSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看出，此时去数据库查询权限，然后迭代查询的每个权限并且split分割了一下，通过“，”做的分割，所以<strong>我们写权限的时候可以这样写“system:user:add,system:user:edit”</strong>，可以在一个菜单的权限标识写好几个权限字符串，用逗号分割。</li>
<li>话说回来，去数据库怎么查询的权限呢？我们看到传入的只有userId，我们继续上源码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;selectMenuPermsByUserId&quot;</span> parameterType=<span class="string">&quot;Long&quot;</span> resultType=<span class="string">&quot;String&quot;</span>&gt;</span><br><span class="line">   select distinct m.perms</span><br><span class="line">   from sys_menu m</span><br><span class="line">       left join sys_role_menu rm on m.menu_id = rm.menu_id</span><br><span class="line">       left join sys_user_role ur on rm.role_id = ur.role_id</span><br><span class="line">       left join sys_role r on r.role_id = ur.role_id</span><br><span class="line">   where m.status = <span class="string">&#x27;0&#x27;</span> and r.status = <span class="string">&#x27;0&#x27;</span> and ur.user_id = #&#123;userId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到，到目前为止就已经是到了执行SQL了。我手动在navicat查询一下userId&#x3D;2用户的权限是什么，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161457067.png"
                      alt="图片"
                ></p>
<ul>
<li>可以看到SQL实际上就是不断在左连接，所谓左连接通俗而言就是左边表展示全部数据，右边表若匹配成功就连接，没有匹配成功就右边表空着。</li>
<li>学习左连接：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46628605/article/details/119728797" >https://blog.csdn.net/m0_46628605/article/details/119728797<i class="fas fa-external-link-alt"></i></a></li>
<li>从ry获取userId &#x3D; 2用户权限的SQL来看，实际就是所有权限左连接了角色，然后左连接用户，从而得到该用户的所有权限</li>
<li>值得注意的是，我们发现where后面有俩校验，校验status是不是＝0，其实在ry系统中status&#x3D;0表示正常的意思，status&#x3D;1表示停用的意思。</li>
<li>至此，我们说完了认证的时候获得权限的代码，ry把获得的权限放到了LoginUser类的实例中的字段permissions中存储起来，并把LoginUser的实例对象存储到了Redis中。</li>
<li>也就是说，登录过的用户Redis中存储着该用户的权限【那么这里就涉及到一个问题：当我用超级管理员修改了角色的权限，对于已经登录的和该角色相关联的用户，是不是立刻生效呢？<strong>其实对于页面权限是立刻生效的，但是对于按钮权限并不是立刻生效的，而是要重新登录重新从数据库获取权限，然后再存入Redis</strong>】。</li>
</ul>
<h2 id="2-用户菜单（页面权限）的获取"><a href="#2-用户菜单（页面权限）的获取" class="headerlink" title="2.用户菜单（页面权限）的获取"></a>2.用户菜单（页面权限）的获取</h2><ul>
<li>当用户登录完毕之后，左侧菜单栏展示出来了大量的菜单，对于不同权限的用户，展示的菜单不尽相同。那么，左侧菜单是怎么来的呢？这就需要打开“Layout”组件，然后找到侧边栏组件，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161526218.png"
                      alt="图片"
                ></p>
<ul>
<li>通过以上代码，发现每一个菜单为一个“SidebarItem”组件，我们也可以用开发者工具确定，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161526488.png"
                      alt="图片"
                ></p>
<ul>
<li><p>发现Layout组件的菜单栏组件是Sidebar，里面有一个ElMenu组件（对应整个菜单整体），这里面的SidebarItem全部都是一级菜单，一级菜单里面有ElSubmenu组件，对应我们的二级菜单整体，里面的SidebarItem组件为具体的每一个二级菜单。</p>
<p>我们可以发现，ElMenu中的菜单项的迭代数据来自变量sidebarRouters，所以我们到这里就知道，<strong>sidebarRouters变量的数据一定是后端查询来的菜单数据</strong>。我们继续深入，它是vuex的getters：</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...<span class="title function_">mapGetters</span>([<span class="string">&quot;sidebarRouters&quot;</span>, <span class="string">&quot;sidebar&quot;</span>]),</span><br></pre></td></tr></table></figure>

<p>继续追代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sidebarRouters</span>:<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">permission</span>.<span class="property">sidebarRouters</span>,</span><br></pre></td></tr></table></figure>

<p>追：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">state</span>: &#123;</span><br><span class="line">  <span class="attr">routes</span>: [],</span><br><span class="line">  <span class="attr">addRoutes</span>: [],</span><br><span class="line">  <span class="attr">defaultRoutes</span>: [],</span><br><span class="line">  <span class="attr">topbarRouters</span>: [],</span><br><span class="line">  <span class="attr">sidebarRouters</span>: []</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>到这里就追到底了，那么sidebarRouters是在哪里赋值的呢？我们继续看：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161532870.png"
                      alt="图片"
                ></p>
<ul>
<li>从上面发现，<strong>sidebarRouters</strong>的数据是来自<strong>两部分</strong>，一部分来自getRouters方法向后端发请求，返回的res的data经过filterAsyncRouter（<strong>ry解释了该方法的作用：遍历后台传来的路由字符串，转换为组件对象</strong>）方法过滤后的路由；另一部分来自constantRoutes，constantRoutes是写死的，<strong>来自router文件夹下的index.js文件</strong>：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 公共路由</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> constantRoutes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/redirect&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/redirect/:path(.*)&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/redirect&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/login&#x27;</span>),</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/register&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/register&#x27;</span>),</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/404&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/error/404&#x27;</span>),</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/401&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/error/401&#x27;</span>),</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&#x27;index&#x27;</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;index&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/index&#x27;</span>),</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Index&#x27;</span>,</span><br><span class="line">        <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;首页&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;dashboard&#x27;</span>, <span class="attr">affix</span>: <span class="literal">true</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/user&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">hidden</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&#x27;noredirect&#x27;</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;profile&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/system/user/profile/index&#x27;</span>),</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Profile&#x27;</span>,</span><br><span class="line">        <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;个人中心&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;user&#x27;</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>现在的问题就是getRouters方法从后端拿菜单，我们需要深入，追：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;@/utils/request&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取路由</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getRouters</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/getRouters&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>现在可以进入后端SysLoginController的getRouters方法了：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取路由信息</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 路由信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;getRouters&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getRouters</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> SecurityUtils.getUserId();</span><br><span class="line">    List&lt;SysMenu&gt; menus = menuService.selectMenuTreeByUserId(userId);</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.success(menuService.buildMenus(menus));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第一句话拿到了userId，然后通过userId获得了菜单树：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户ID查询菜单</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId 用户名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 菜单列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SysMenu&gt; <span class="title function_">selectMenuTreeByUserId</span><span class="params">(Long userId)</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;SysMenu&gt; menus = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (SecurityUtils.isAdmin(userId))</span><br><span class="line">    &#123;</span><br><span class="line">        menus = menuMapper.selectMenuTreeAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        menus = menuMapper.selectMenuTreeByUserId(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getChildPerms(menus, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从以上代码可以发现，如果是超级管理员直接获得全部菜单（ry在系统中对userId&#x3D;1的用户采取了硬编码方案，手动制造了一个超级牛逼管理员），普通用户则需要根据权限获得菜单：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectMenuTreeByUserId&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;SysMenuResult&quot;</span>&gt;</span></span><br><span class="line">   select distinct m.menu_id, m.parent_id, m.menu_name, m.path, m.component, m.`query`, m.visible, m.status, ifnull(m.perms,&#x27;&#x27;) as perms, m.is_frame, m.is_cache, m.menu_type, m.icon, m.order_num, m.create_time</span><br><span class="line">   from sys_menu m</span><br><span class="line">       left join sys_role_menu rm on m.menu_id = rm.menu_id</span><br><span class="line">       left join sys_user_role ur on rm.role_id = ur.role_id</span><br><span class="line">       left join sys_role ro on ur.role_id = ro.role_id</span><br><span class="line">       left join sys_user u on ur.user_id = u.user_id</span><br><span class="line">   where u.user_id = #&#123;userId&#125; and m.menu_type in (&#x27;M&#x27;, &#x27;C&#x27;) and m.status = 0  AND ro.status = 0</span><br><span class="line">   order by m.parent_id, m.order_num</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>上面SQL再明显不过了，查询menu_type类型为M和C的菜单，M表示目录，C表示菜单，从ry的数据库建表语句也可以得到证实：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161542657.png"
                      alt="图片"
                ></p>
<ul>
<li>查询到目录和菜单之后，通过构造树结构，然后再把树结构返回给了前端，关于树结构的构造逻辑不再赘述</li>
<li>目前还有一个问题，GenerateRoutes方法是什么时候执行的？如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161543778.png"
                      alt="图片"
                ></p>
<ul>
<li>可以发现，是在已经登录，并且不是去“&#x2F;login”的情况下，会执行生成路由方法。</li>
<li>以上我只是说明了左侧菜单栏能展示那么多菜单，但是要实现跳转，路由器的路由表也必须到位，实际上路由表就在下面一句话就成功添加到了路由器：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161544387.png"
                      alt="图片"
                ></p>
<ul>
<li>另外，左侧的菜单能进行跳转，利用了Applink组件（Sidebar文件夹下的Link.vue组件），如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161545102.png"
                      alt="图片"
                ></p>
<ul>
<li>Applink被渲染为了a标签，to&#x3D;xxxx被渲染为了href&#x3D;xxxx。关于组件的具体代码，不做展开。</li>
</ul>
<h2 id="3-页面权限补充"><a href="#3-页面权限补充" class="headerlink" title="3.页面权限补充"></a>3.页面权限补充</h2><ul>
<li>上一讲，我们只是说了页面权限的前端，前端为什么能展示出来那么多菜单，因为前端请求后端接口“getRouters”，后端根据前端人员的角色，查询出来了该用户的菜单权限，然后返回给前端，前端所以才显示那么多菜单。</li>
<li>一个新注册的用户，默认是没有任何角色的，那么登录就只有一个菜单，那就是首页，就像下面这样：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161756266.png"
                      alt="图片"
                ></p>
<ul>
<li>页面权限往往不仅仅和前端菜单展示有关，前端点击岗位管理的时候，调用了岗位管理的“system&#x2F;post&#x2F;list”接口，难道调用该接口不需要权限吗？？？</li>
<li>其实，调用该接口是需要权限的，并且权限为“system:post:list”，每一个接口的调用需要什么权限，我们都可以在上面的注解可以看到：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161756481.png"
                      alt="图片"
                ></p>
<ul>
<li>@<strong>PreAuthorize</strong>注解是SpringSecurity框架的注解，注解的value值所需要填写一个表达式，如果表达式计算的结果是true，那么就允许访问对应的接口，如果表达式计算的结果是false，则表示没有权限。</li>
<li>如果没有权限，那么会怎么样呢？我现在手动把岗位管理的接口权限改成“system:post:list1”，如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/ainianxu/image/master/202306161757413.png"
                      alt="图片"
                ></p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post title：Java实习之RuoYi-Vue</li>
        <li>Post author：Fang</li>
        <li>Create time：2023-06-13 09:54:33</li>
        <li>
            Post link：https://ainianxu.github.io/2023/06/13/Java实习之RuoYi-Vue/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E5%AE%9E%E4%B9%A0/">#实习</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2023/06/12/Java%E5%9F%BA%E7%A1%80%E4%B9%8BString%E3%80%81ArrayList/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Java基础之String、ArrayList</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;Comments</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'loa9BVbgmyFLwBMHhg1Cycx1-gzGzoHsz',
                    appKey: '47pIz6ewIXRi5251WyfUpQOB',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情吐槽吧~',
                    lang: 'en'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Fang';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>
              -
            
            2023&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Fang</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.4</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%90%8E%E7%AB%AF%E5%9C%A8%E6%9C%AC%E5%9C%B0%E8%BF%90%E8%A1%8C"><span class="nav-number">1.</span> <span class="nav-text">一、后端在本地运行</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%B3%BB%E7%BB%9F%E9%9C%80%E6%B1%82"><span class="nav-number">1.1.</span> <span class="nav-text">1.系统需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%B0%86%E9%A1%B9%E7%9B%AE%E5%AF%BC%E5%85%A5IDEA"><span class="nav-number">1.2.</span> <span class="nav-text">2.将项目导入IDEA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.3.</span> <span class="nav-text">3.项目结构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF"><span class="nav-number">2.</span> <span class="nav-text">二、部署前端</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%B0%86%E9%A1%B9%E7%9B%AE%E5%AF%BC%E5%85%A5IDEA"><span class="nav-number">2.1.</span> <span class="nav-text">1.将项目导入IDEA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">2.2.</span> <span class="nav-text">2.项目结构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%89%8D%E7%AB%AFrequest-js%E5%AF%B9axios%E7%9A%84%E5%B0%81%E8%A3%85%E7%90%86%E8%A7%A3%E5%92%8C%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">三、前端request.js对axios的封装理解和基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Get"><span class="nav-number">3.1.</span> <span class="nav-text">1.Get</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Post"><span class="nav-number">3.2.</span> <span class="nav-text">2.Post</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%A2%84%E9%98%B2%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4%E5%BC%80%E5%85%B3"><span class="nav-number">3.3.</span> <span class="nav-text">3.预防重复提交开关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%93%8D%E5%BA%94%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">3.4.</span> <span class="nav-text">4.响应拦截器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E9%80%9A%E7%94%A8%E4%B8%8B%E8%BD%BD%E6%96%B9%E6%B3%95%E5%89%8D%E6%AE%B5%E4%BB%A3%E7%A0%81"><span class="nav-number">3.5.</span> <span class="nav-text">5.通用下载方法前段代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B-%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E5%B1%95%E7%A4%BA-%E4%BB%85%E4%BB%85%E4%BB%8ERedis%E5%8F%96%E4%B8%80%E4%B8%8B%E6%95%B0%E6%8D%AE%E5%81%9A%E5%B1%95%E7%A4%BA"><span class="nav-number">4.</span> <span class="nav-text">四.在线用户展示-仅仅从Redis取一下数据做展示</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E7%99%BB%E5%BD%95%E7%9A%84%E6%97%B6%E5%80%99%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%AD%98%E5%85%A5redis%E4%BB%A3%E7%A0%81%E5%9C%A8%E5%93%AA"><span class="nav-number">5.</span> <span class="nav-text">五、登录的时候用户信息存入redis代码在哪</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%BC%BA%E9%80%80%E7%94%A8%E6%88%B7"><span class="nav-number">6.</span> <span class="nav-text">六、强退用户</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E4%B8%8B%E8%BD%BD%E5%AD%97%E5%85%B8%E7%B1%BB%E5%9E%8B%E5%90%8E%E7%AB%AF%E4%B8%89%E5%8F%A5%E8%AF%9D%E5%9C%A8%E5%81%9A%E5%95%A5"><span class="nav-number">7.</span> <span class="nav-text">七、下载字典类型后端三句话在做啥</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E5%89%8D%E7%AB%AF%E5%90%91%E5%90%8E%E7%AB%AF%E4%BC%A0%E5%8F%82%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">8.</span> <span class="nav-text">八、前端向后端传参的方式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-RESTful"><span class="nav-number">8.1.</span> <span class="nav-text">1.RESTful</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%99%AE%E9%80%9A%E6%96%B9%E5%BC%8F"><span class="nav-number">8.2.</span> <span class="nav-text">2.普通方式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E5%BC%80%E5%85%B3%E5%8E%9F%E7%90%86%EF%BC%88%E9%AA%8C%E8%AF%81%E7%A0%81%E5%BC%80%E5%85%B3%E3%80%81IP%E5%BC%80%E5%85%B3%EF%BC%89"><span class="nav-number">9.</span> <span class="nav-text">九、开关原理（验证码开关、IP开关）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BC%80%E5%85%B3%E5%8E%9F%E7%90%86%EF%BC%88%E9%AA%8C%E8%AF%81%E7%A0%81%E5%BC%80%E5%85%B3%EF%BC%89"><span class="nav-number">9.1.</span> <span class="nav-text">1.开关原理（验证码开关）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%BC%80%E5%85%B3%E5%8E%9F%E7%90%86%EF%BC%88IP%E5%BC%80%E5%85%B3%EF%BC%89"><span class="nav-number">9.2.</span> <span class="nav-text">2.开关原理（IP开关）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E3%80%81%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%B8%83%E5%B1%80%E8%AF%A6%E8%A7%A3"><span class="nav-number">10.</span> <span class="nav-text">十、前端页面的布局详解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Vue-Devtools%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85"><span class="nav-number">10.1.</span> <span class="nav-text">1.Vue-Devtools工具安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%B8%83%E5%B1%80"><span class="nav-number">10.2.</span> <span class="nav-text">2.前端页面的布局</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5%E4%B8%80%EF%BC%9A%E4%B8%8D%E4%BE%9D%E8%B5%96Layout%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">10.2.1.</span> <span class="nav-text">情况一：不依赖Layout的情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5%E4%BA%8C%EF%BC%9A%E4%BE%9D%E8%B5%96Layout%E7%BB%84%E4%BB%B6"><span class="nav-number">10.2.2.</span> <span class="nav-text">情况二：依赖Layout组件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E5%A4%A9%E6%B0%94%E5%B0%8F%E6%A1%88%E4%BE%8B"><span class="nav-number">11.</span> <span class="nav-text">十一、天气小案例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%96%B0%E5%A2%9E%E5%B8%A6Layout%E7%BB%84%E4%BB%B6%E7%9A%84%E9%A1%B5%E9%9D%A2"><span class="nav-number">11.1.</span> <span class="nav-text">1.新增带Layout组件的页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%93%E6%B3%A8weather%E4%B8%9A%E5%8A%A1"><span class="nav-number">11.2.</span> <span class="nav-text">2.专注weather业务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81JWT"><span class="nav-number">12.</span> <span class="nav-text">十二、JWT</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%B7%A8%E5%9F%9F%E8%AE%A4%E8%AF%81%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">12.1.</span> <span class="nav-text">1.跨域认证的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-JWT-%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">12.2.</span> <span class="nav-text">2.JWT 的原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-JWT-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">12.3.</span> <span class="nav-text">3.JWT 的数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Header"><span class="nav-number">12.3.1.</span> <span class="nav-text">3.1 Header</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Payload"><span class="nav-number">12.3.2.</span> <span class="nav-text">3.2 Payload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-Signature"><span class="nav-number">12.3.3.</span> <span class="nav-text">3.3 Signature</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-Base64URL"><span class="nav-number">12.3.4.</span> <span class="nav-text">3.4 Base64URL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-JWT-%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">12.4.</span> <span class="nav-text">4.JWT 的使用方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-JWT-%E7%9A%84%E5%87%A0%E4%B8%AA%E7%89%B9%E7%82%B9"><span class="nav-number">12.5.</span> <span class="nav-text">5.JWT 的几个特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-ry%E6%98%AF%E6%80%8E%E4%B9%88%E8%B7%B5%E8%A1%8CJWT%E7%9A%84%E5%91%A2%EF%BC%9F"><span class="nav-number">12.6.</span> <span class="nav-text">6.ry是怎么践行JWT的呢？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%89%E3%80%81ry%E5%A6%82%E4%BD%95%E8%B7%B5%E8%A1%8CSpringSecurity%E7%94%A8%E4%BA%8E%E8%AE%A4%E8%AF%81"><span class="nav-number">13.</span> <span class="nav-text">十三、ry如何践行SpringSecurity用于认证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-SpringSecurity%E5%9F%BA%E7%A1%80"><span class="nav-number">13.1.</span> <span class="nav-text">1.SpringSecurity基础</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Ry%E6%98%AF%E5%A6%82%E4%BD%95%E8%B7%B5%E8%A1%8C%E8%BF%99%E5%A5%97%E8%A7%84%E5%88%99%EF%BC%9F"><span class="nav-number">13.2.</span> <span class="nav-text">2.Ry是如何践行这套规则？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-ry%E8%AE%A4%E8%AF%81%E5%87%BA%E7%8E%B0%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E7%9A%84%EF%BC%9F"><span class="nav-number">13.3.</span> <span class="nav-text">3.ry认证出现问题如何处理的？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%96%B0%E9%97%AE%E9%A2%98%EF%BC%9Apostman%E5%A6%82%E4%BD%95%E8%B0%83%E6%8E%A5%E5%8F%A3%EF%BC%9F"><span class="nav-number">13.4.</span> <span class="nav-text">4.新问题：postman如何调接口？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Swagger%E5%A5%BD%E5%83%8F%E4%B9%9F%E8%B0%83%E4%B8%8D%E9%80%9A"><span class="nav-number">13.5.</span> <span class="nav-text">5.Swagger好像也调不通</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81%E6%B7%B1%E5%85%A5%E8%AE%A4%E8%AF%81%E6%BA%90%E7%A0%81%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE"><span class="nav-number">14.</span> <span class="nav-text">十四、深入认证源码过滤器链</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%89%8B%E5%8A%A8%E4%BF%AE%E6%94%B9%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%92%8C%E8%AE%A4%E8%AF%86addFilterAfter%E6%96%B9%E6%B3%95"><span class="nav-number">14.1.</span> <span class="nav-text">1.手动修改过滤器链和认识addFilterAfter方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%89%8B%E5%8A%A8%E4%BF%AE%E6%94%B9%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E5%92%8C%E8%AE%A4%E8%AF%86addFilterAfter%E6%96%B9%E6%B3%95-1"><span class="nav-number">14.1.1.</span> <span class="nav-text">1.手动修改过滤器链和认识addFilterAfter方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%96%B0%E6%96%B9%E6%B3%95%EF%BC%9AaddFilterAfter"><span class="nav-number">14.1.2.</span> <span class="nav-text">2.新方法：addFilterAfter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%AE%89%E5%85%A8%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E6%9D%A1%E7%9A%84%E6%AF%8F%E4%B8%AA%E8%BF%87%E6%BB%A4%E5%99%A8%E4%BD%9C%E7%94%A8"><span class="nav-number">14.2.</span> <span class="nav-text">2.安全过滤器链条的每个过滤器作用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%BA%94%E3%80%81RBAC"><span class="nav-number">15.</span> <span class="nav-text">十五、RBAC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="nav-number">15.1.</span> <span class="nav-text">1.简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%BB%80%E4%B9%88%E6%98%AF%E9%A1%B5%E9%9D%A2%E6%9D%83%E9%99%90%E3%80%81%E6%8C%89%E9%92%AE%E6%9D%83%E9%99%90"><span class="nav-number">15.2.</span> <span class="nav-text">2.什么是页面权限、按钮权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%9D%83%E9%99%90%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F"><span class="nav-number">15.3.</span> <span class="nav-text">3.权限表现形式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-ry%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">15.4.</span> <span class="nav-text">4.ry如何进行权限控制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E5%85%AD%E3%80%81%E6%B7%B1%E5%85%A5%E6%BA%90%E7%A0%81%E7%90%86%E8%A7%A3%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">16.</span> <span class="nav-text">十六、深入源码理解权限控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BD%95%E6%97%B6%E8%8E%B7%E5%BE%97%E6%9D%83%E9%99%90"><span class="nav-number">16.1.</span> <span class="nav-text">1.何时获得权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%94%A8%E6%88%B7%E8%8F%9C%E5%8D%95%EF%BC%88%E9%A1%B5%E9%9D%A2%E6%9D%83%E9%99%90%EF%BC%89%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="nav-number">16.2.</span> <span class="nav-text">2.用户菜单（页面权限）的获取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%A1%B5%E9%9D%A2%E6%9D%83%E9%99%90%E8%A1%A5%E5%85%85"><span class="nav-number">16.3.</span> <span class="nav-text">3.页面权限补充</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/code-copy.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/lazyload.js"></script>


<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/toc.js"></script>
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.4/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
